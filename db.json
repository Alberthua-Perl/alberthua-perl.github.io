{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"source/img/avatar.jpg","path":"img/avatar.jpg","modified":1,"renderable":0},{"_id":"source/img/favicon.ico","path":"img/favicon.ico","modified":1,"renderable":0},{"_id":"source/img/icon_wechat.png","path":"img/icon_wechat.png","modified":1,"renderable":0},{"_id":"source/img/tag-bg.jpg","path":"img/tag-bg.jpg","modified":1,"renderable":0},{"_id":"source/img/tag-bg.svg","path":"img/tag-bg.svg","modified":1,"renderable":0},{"_id":"source/img/404-bg.jpg","path":"img/404-bg.jpg","modified":1,"renderable":0},{"_id":"themes/huxblog/source/css/highlight.styl","path":"css/highlight.styl","modified":1,"renderable":1},{"_id":"themes/huxblog/source/css/hux-blog.css","path":"css/hux-blog.css","modified":1,"renderable":1},{"_id":"themes/huxblog/source/css/hux-blog.min.css","path":"css/hux-blog.min.css","modified":1,"renderable":1},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.eot","path":"fonts/glyphicons-halflings-regular.eot","modified":1,"renderable":1},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.ttf","path":"fonts/glyphicons-halflings-regular.ttf","modified":1,"renderable":1},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.woff2","path":"fonts/glyphicons-halflings-regular.woff2","modified":1,"renderable":1},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.woff","path":"fonts/glyphicons-halflings-regular.woff","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/bootstrap.min.js","path":"js/bootstrap.min.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/hux-blog.js","path":"js/hux-blog.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/hux-blog.min.js","path":"js/hux-blog.min.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/jquery.nav.js","path":"js/jquery.nav.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/jquery.tagcloud.js","path":"js/jquery.tagcloud.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.svg","path":"fonts/glyphicons-halflings-regular.svg","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/bootstrap.js","path":"js/bootstrap.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/js/jquery.min.js","path":"js/jquery.min.js","modified":1,"renderable":1},{"_id":"themes/huxblog/source/css/bootstrap.min.css","path":"css/bootstrap.min.css","modified":1,"renderable":1},{"_id":"themes/huxblog/source/css/bootstrap.css","path":"css/bootstrap.css","modified":1,"renderable":1},{"_id":"source/img/contact-bg.jpg","path":"img/contact-bg.jpg","modified":1,"renderable":0},{"_id":"themes/huxblog/source/js/jquery.js","path":"js/jquery.js","modified":1,"renderable":1},{"_id":"source/img/about-bg.svg","path":"img/about-bg.svg","modified":1,"renderable":0},{"_id":"source/img/about-bg.jpg","path":"img/about-bg.jpg","modified":1,"renderable":0},{"_id":"source/img/home-bg.jpg","path":"img/home-bg.jpg","modified":1,"renderable":0},{"_id":"source/img/home-bg.svg","path":"img/home-bg.svg","modified":1,"renderable":0}],"Cache":[{"_id":"themes/huxblog/README.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1669631581114},{"_id":"source/404.md","hash":"83c2c6d587beaa967a976e5969d60fa97fcdbe55","modified":1669631580973},{"_id":"themes/huxblog/_config.yml","hash":"5d235aa7716657282795ee86d9c9db2374197a66","modified":1669631581114},{"_id":"themes/huxblog/LICENSE","hash":"2b209f06bebeb2a8c2b7e187e436f3e1e1fbc8a7","modified":1669631581114},{"_id":"source/_posts/fcos-rhcos-basic-usage.md","hash":"f1174c8ab75d2847d92c1d67e30e05b97ecd9ade","modified":1669650365854},{"_id":"source/_posts/golang-code-server.md","hash":"31eff2c3a6d11606a03763a6826e58b69c4c5b94","modified":1670293121438},{"_id":"source/_posts/golang-environment-deploy.md","hash":"c83469cfb2d3786a34dfec54b7b1b3366dd73640","modified":1669631580973},{"_id":"source/_posts/kubeadm-update-k8s-certs.md","hash":"d62c1df7cea61260d1051c932a994d2cbb5adaf1","modified":1672286910460},{"_id":"source/_posts/k8s-cluster-resource-basic.md","hash":"67aec40f46f22f8099904d7ed61a90fecfdb7465","modified":1669643244090},{"_id":"source/_posts/linux-process-uid.md","hash":"a3179bf21b9fb47f0781fedd88e2df652739fe28","modified":1674893996875},{"_id":"source/_posts/https-handshake-authentication.md","hash":"52665a5108b8c228e15a4240f46a7b8de5e164d2","modified":1674194552409},{"_id":"source/_posts/kani-deploy-k8s.md","hash":"ce83148ac1f71ff6e46922755cd006169a282418","modified":1670295048521},{"_id":"source/_posts/loganalyzer-rsyslog-mysql.md","hash":"73ff6b3659d120756f748093957b10c07f9212bf","modified":1670230769210},{"_id":"source/_posts/podman-arch-usage.md","hash":"209eab2506e3d4ced73c25702edfdccdb59a2537","modified":1670224298946},{"_id":"source/_posts/redhat-quay-v3-registry.md","hash":"0dcd4796edce9b455f90e7ef01e947b5eb3486ad","modified":1670232703745},{"_id":"source/_posts/rocketchat-mongodb-on-k8s.md","hash":"67f9efb98f4f2d08ffc9bc02ad6b3eca7ac35d9b","modified":1671783016791},{"_id":"source/about/index.md","hash":"cfe017eb3ac922ddfe7b4088215717aa61afc44a","modified":1671971996003},{"_id":"source/archives/index.md","hash":"26f32f263feefefdf7b04af63d326113e4166e8f","modified":1671762674566},{"_id":"source/_posts/skopeo-basic-usage.md","hash":"fbbce0f085f2a69b089da0512c7c68292e77c026","modified":1670304797881},{"_id":"source/_posts/podman-usage-practice.md","hash":"78879b8fe8ceded9aa5a26308e81c5dfb35579f1","modified":1670295361829},{"_id":"source/img/avatar.jpg","hash":"341c4110b9f5e20a8e8a312ce842fc5c4a456b21","modified":1669631581024},{"_id":"source/img/favicon.ico","hash":"9987b24caac594aa54615ca089f4dc7f8de47b46","modified":1672836864010},{"_id":"source/img/icon_wechat.png","hash":"7fdb00c9017236e05c1b3e6da38a2cc382fd69fa","modified":1669631581106},{"_id":"source/tags/index.md","hash":"21c5eee4c1fe877025234e5b1a1a62c4fb7896d6","modified":1671763205742},{"_id":"themes/huxblog/languages_to_be_added/de.yml","hash":"424a9c1e6ab69334d7873f6574da02ca960aa572","modified":1669631581114},{"_id":"themes/huxblog/languages_to_be_added/default.yml","hash":"97326c9e6518d9f379778178b3b8f9a58434725d","modified":1669631581114},{"_id":"themes/huxblog/languages_to_be_added/en.yml","hash":"97326c9e6518d9f379778178b3b8f9a58434725d","modified":1669631581114},{"_id":"themes/huxblog/languages_to_be_added/es.yml","hash":"cb4eeca0ed3768a77e0cd216300f2b2549628b1b","modified":1669631581114},{"_id":"themes/huxblog/languages_to_be_added/zh-CN.yml","hash":"7bfcb0b8e97d7e5edcfca8ab26d55d9da2573c1c","modified":1669631581115},{"_id":"themes/huxblog/languages_to_be_added/ru.yml","hash":"42df7afeb7a35dc46d272b7f4fb880a9d9ebcaa5","modified":1669631581115},{"_id":"themes/huxblog/languages_to_be_added/pl.yml","hash":"de7eb5850ae65ba7638e907c805fea90617a988c","modified":1669631581115},{"_id":"themes/huxblog/languages_to_be_added/no.yml","hash":"8ca475a3b4f8efe6603030f0013aae39668230e1","modified":1669631581114},{"_id":"themes/huxblog/languages_to_be_added/zh-TW.yml","hash":"9acac6cc4f8002c3fa53ff69fb8cf66c915bd016","modified":1669631581115},{"_id":"themes/huxblog/layout/404.ejs","hash":"a4d73541a53e56b7dd46249c6d27cb59f4d97422","modified":1669631581115},{"_id":"themes/huxblog/layout/index.ejs","hash":"70ac58c46625300a70791e210daf446afa6d1cd4","modified":1669631581117},{"_id":"themes/huxblog/layout/layout.ejs","hash":"03e278a3b8bc4503183276b6130ac04a8d5b9865","modified":1669631581118},{"_id":"themes/huxblog/layout/page.ejs","hash":"3fde0787e883274563f9de5aaeb8130b667e132a","modified":1669631581118},{"_id":"themes/huxblog/layout/keynote.ejs","hash":"f5689862281e34dbe8402b0e72f632902e53e88b","modified":1669631581117},{"_id":"themes/huxblog/layout/post.ejs","hash":"fd68124c3de2bbe7d870cecadcf684df7cf82519","modified":1669631581119},{"_id":"themes/huxblog/layout/archives.ejs","hash":"f0046e58cc1dd876133be2bf927aed2b1821cb3e","modified":1669631581117},{"_id":"themes/huxblog/layout/archive.ejs","hash":"6c3ed5d914379319efe835a4aa505abbc616c328","modified":1669631581117},{"_id":"themes/huxblog/layout/about.ejs","hash":"7f56c71383ef6c156b56d79b3984e07cc466606a","modified":1669631581117},{"_id":"themes/huxblog/layout/tags.ejs","hash":"a51bf2828af20939d702de1fdae067439a1153c0","modified":1669631581119},{"_id":"source/img/tag-bg.jpg","hash":"8538e566a5ed1a2d26afce936b67dd5e345bc3c7","modified":1669631581106},{"_id":"source/img/tag-bg.svg","hash":"8ee7e619fc2795472cc28e347b537f27a2aed93a","modified":1669631581112},{"_id":"source/_posts/fcos-rhcos-basic-usage/login-fedora-coreos-live.png","hash":"ee4269d4c6b48fb7fa449b80b12002376ee4980e","modified":1666622177000},{"_id":"source/_posts/fcos-rhcos-basic-usage/coreos-installer-customized-install.png","hash":"1f358024c5e1e6fce42cfbcd5cbded16ef75fc0e","modified":1666574017000},{"_id":"source/_posts/fcos-rhcos-basic-usage/use-fedora-coreos-live-to-install.png","hash":"ae18558cd189e927cc5b7ffc00010ee1e90becfc","modified":1666573832000},{"_id":"source/_posts/golang-code-server/code-server-bg.png","hash":"30b21602c05f178fd07051a7295b5e91f3181c10","modified":1669557877000},{"_id":"source/_posts/golang-environment-deploy/golang-develop-bg.png","hash":"30b21602c05f178fd07051a7295b5e91f3181c10","modified":1669631580973},{"_id":"source/_posts/golang-environment-deploy/golang-develop-bg.svg","hash":"c8bf17e5157e364cd4c51b7591d3be08a63b237b","modified":1669631580973},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-3.png","hash":"9d18a6368181e7e37b4e3eeda2ff0f44c5e57248","modified":1669631580975},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-2.png","hash":"7e6dc5f6ff602c40490a175a9955957b31f993d5","modified":1669631580975},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-1.png","hash":"0aa7f92c7b20b5dea18c4ba26f1c7ad896bac1c7","modified":1669631580975},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-5.png","hash":"d0c1361f2d46c8eb777d3e4c7ef8e25f417e5a4e","modified":1669631580975},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-4.png","hash":"1fcb1d245a7ff2bbcb680017a92df4b6cd687d37","modified":1669631580975},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-8.png","hash":"e976c3789e5446c4c6252586bf00d2ae30e99809","modified":1669631580977},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-7.png","hash":"cbc6bf92b7efe68095731c319695d5b1b09343ef","modified":1669631580977},{"_id":"source/_posts/golang-environment-deploy/vim-error.jpg","hash":"a4ec5edff095e15d89a78d624fff231a397be50b","modified":1669631580977},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-6.png","hash":"138889becb1f55475bbb8d10c89c9e70679ee816","modified":1669631580977},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-2.png","hash":"bc5a512c597acd0c6d1a3aa6a57e5bb2370830fa","modified":1674049594000},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-5.png","hash":"4aeaf2a7d43142ee9e43eba28aa98c9ec1836851","modified":1674037574000},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-4.png","hash":"a883421f80b62c0decaa5b59574aa058516ba130","modified":1674049707000},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-3.png","hash":"8c695e350f469eaea95daab3be4f5ef255e9b991","modified":1674049679000},{"_id":"source/_posts/https-handshake-authentication/https-mutual-no-client-cert-error-1.png","hash":"6a7dc2b7d8bc178c5b9c96bcfd14b2cf5eedf689","modified":1674037456000},{"_id":"source/_posts/https-handshake-authentication/https-single-auth-chrome-error-1.png","hash":"78d1f9fa2c889c9ae3c369fd30bfc1e40ebe8c9b","modified":1674049812000},{"_id":"source/_posts/https-handshake-authentication/server-hello-done.jpg","hash":"98cd326b6c5b21c847e84491086c0cc7f3cdfcff","modified":1672416044000},{"_id":"source/_posts/https-handshake-authentication/server-response-to-client-4-phase.png","hash":"9e0b681fd8328a0b22611285d473aa421240b49a","modified":1672798801000},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-authentication.png","hash":"698f575770bc44b399829acd04bb9fe33909eac6","modified":1672389160000},{"_id":"source/_posts/https-handshake-authentication/server-key-exchange.png","hash":"cac522267a729317cbd32cc9374ad8d0435bd00f","modified":1672415367000},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-handshake-end.png","hash":"73d2904ecd2120a1814e936f32261baaf325e801","modified":1672811743000},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-in-network-stack.png","hash":"7b0fe89054b4cce3a2ae17e97df22bb3dffc1fc1","modified":1672385533000},{"_id":"source/_posts/k8s-cluster-resource-basic/k8s-resource-basic.png","hash":"2b188ce6115bb6c59227dc4b09eb7d9bff083e7d","modified":1669631580979},{"_id":"source/_posts/k8s-cluster-resource-basic/k8s-resource-basic.svg","hash":"ddb7e0af613e904e9936bf091ae4a442bf00ca2b","modified":1669631580979},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-mysql-rsyslogserver.jpg","hash":"a4f34333ca86d9599f487596194f50272ea00091","modified":1620026986000},{"_id":"source/_posts/kubeadm-update-k8s-certs/kubeadm-certs-bg.jpg","hash":"a102d05e95270ebbf1701d310e75e38b39b71215","modified":1672285039000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/quay-push-error-2.jpg","hash":"c5b1d5135d9d64b9703d1decf207255671161f48","modified":1620047374000},{"_id":"source/_posts/podman-arch-usage/podman-bg.webp","hash":"e8ccc3aae0be1dd0f0410fcc46783fd6561471eb","modified":1670224105000},{"_id":"source/_posts/podman-arch-usage/podman-version-compare.png","hash":"08a461e9cadddd2f72297e631ee0dcf8aaab9403","modified":1670220986000},{"_id":"source/_posts/podman-usage-practice/podman-bg.webp","hash":"e8ccc3aae0be1dd0f0410fcc46783fd6561471eb","modified":1670224105000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-1.png","hash":"7f050839b16bd27f3ec73ee942d42a7928e37196","modified":1620892250000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-4.png","hash":"7c27372682ce2e84b290ae1f3e82538375504fa7","modified":1620892330000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-2.png","hash":"f80fc9e45653655e5972ef3e49d4d10ca13aa215","modified":1620892299000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-3.png","hash":"5ecaa17ec3d5c227276e58a6955909914097a04e","modified":1620892315000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-6.png","hash":"f12a386341c3f7b5c962ef34e15eaf1de6654815","modified":1620892357000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-5.png","hash":"3edac8fed196a3cfe705f8d17221b2c1d3485978","modified":1620892344000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-8.png","hash":"f9183cb80918e44bb65bccc0b045c98aba1798d6","modified":1620892384000},{"_id":"source/_posts/redhat-quay-v3-registry/first-login-config-quay.png","hash":"6023ac2e3c02c61f50b8a79d1b35803fef5db6b9","modified":1620892168000},{"_id":"source/_posts/redhat-quay-v3-registry/normal-login-quay.png","hash":"f041e5307900a4fe083c939473e71a51d69021f9","modified":1620892695000},{"_id":"source/_posts/redhat-quay-v3-registry/podman-push-quay-permission-denied-1001-1.jpg","hash":"d2fe6cb532048f4c48e938a5b55a8df41ce44ef3","modified":1639990888000},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-login.png","hash":"eced4ff9473ea0eb5fab367e49ee07fc5067775d","modified":1670297524000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-bg.jpg","hash":"6face4bc90a8f5bfc53d329961238b9367cfc3da","modified":1670304575000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-dir-2.jpg","hash":"7f0af9bde8e375efbae82be8f9e68dcd4b90db29","modified":1644413689000},{"_id":"source/img/404-bg.jpg","hash":"68f7d525269a94287e0ad18713ae232fb59dcf71","modified":1669631581016},{"_id":"themes/huxblog/layout/_partial/head.ejs","hash":"87c544a64ea49b835330135a616deb2e9fd39bbb","modified":1669631581116},{"_id":"themes/huxblog/layout/_partial/footer.ejs","hash":"e325a9953abc1a3751aa1a927bc3ecbdd627803a","modified":1669631581116},{"_id":"themes/huxblog/layout/_partial/nav.ejs","hash":"4c905166c960852e9b9a3c9d5c680091e37b481f","modified":1669631581116},{"_id":"themes/huxblog/source/css/highlight.styl","hash":"e842080e6d580f0f70a7df71fbde3c4e49463c19","modified":1669631581122},{"_id":"themes/huxblog/source/css/hux-blog.css","hash":"c1b0a32ad8075ac09d99fb4d64a9fbc84163abf8","modified":1669631581122},{"_id":"themes/huxblog/source/css/hux-blog.min.css","hash":"1baef04de262aeb7023d835429b49a805ac4ab40","modified":1669631581122},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.eot","hash":"86b6f62b7853e67d3e635f6512a5a5efc58ea3c3","modified":1669631581122},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.ttf","hash":"44bc1850f570972267b169ae18f1cb06b611ffa2","modified":1669631581124},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.woff2","hash":"ca35b697d99cae4d1b60f2d60fcd37771987eb07","modified":1669631581125},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.woff","hash":"278e49a86e634da6f2a02f3b47dd9d2a8f26210f","modified":1669631581125},{"_id":"themes/huxblog/source/js/bootstrap.min.js","hash":"b3f2ef9f985e7906c9360756b73cd64bf7733647","modified":1669631581127},{"_id":"themes/huxblog/source/js/hux-blog.js","hash":"4b4d3c557405d04c3087d36c13e2834fe05c0f73","modified":1669631581127},{"_id":"themes/huxblog/source/js/hux-blog.min.js","hash":"1563e7f70550ac6b30803d6f449719b853200e35","modified":1669631581128},{"_id":"themes/huxblog/source/js/jquery.nav.js","hash":"ef2160a456176a4d09cc0b95d52b27dfbbadf2d8","modified":1669631581133},{"_id":"themes/huxblog/source/js/jquery.tagcloud.js","hash":"4e5fd0b07f3bd935f2e603710447e039e3677211","modified":1669631581133},{"_id":"source/_posts/fcos-rhcos-basic-usage/fedora-coreos-release-version.png","hash":"5231f0d165037ec52e197c4cb28184aad14907ad","modified":1665064528000},{"_id":"source/_posts/https-handshake-authentication/client-hello-body-2.png","hash":"0e53e97db1050924044428350184451e35a84db7","modified":1672413706000},{"_id":"source/_posts/https-handshake-authentication/client-response-to-server-ssl.jpg","hash":"e5536e0c40e9ed1ef2e640be37140f2a26805722","modified":1672416311000},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-1.png","hash":"58eb8f8e26448302d2a3f81617189234a3108217","modified":1674049549000},{"_id":"source/_posts/https-handshake-authentication/ca-signed-certification-verify.jpg","hash":"b1cdec87f1ea61a96e0b3e9a9314c3dcbf561061","modified":1672384725000},{"_id":"source/_posts/https-handshake-authentication/server-response-to-client-ssl.png","hash":"a7b0c63faa202a50a0947ae04e24e4d8f8b0a8e2","modified":1672414139000},{"_id":"source/_posts/k8s-cluster-resource-basic/kubectl-get-raw-json.jpg","hash":"2a37464350ad172cc4889f3bd7a55d0c0d6856a3","modified":1669631580981},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-interface-2.jpg","hash":"dd94eb544f19060264be58a95dfd6659dad0cfe9","modified":1669631580995},{"_id":"source/_posts/k8s-cluster-resource-basic/pod-name.jpg","hash":"efad7d57d1b7fd090260a9faa7a415c50ee2466b","modified":1669631580999},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-1.jpg","hash":"219813cbdf5326472e5d4175a0dce10d39e1a994","modified":1620056513000},{"_id":"themes/huxblog/layout/_partial/pagination.ejs","hash":"557d6bb069a1d48af49ae912994653f44b32a570","modified":1669631581116},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-2.jpg","hash":"09bf12b8bb0de7750f7f06429941e2dcd9900da6","modified":1620056539000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-9.jpg","hash":"bda92ea5e61b37ae8a67081f806a287d2146971e","modified":1617608135000},{"_id":"source/_posts/podman-arch-usage/container-access-external-iptables.jpg","hash":"0a5b385ecba903eab3223979a77cb51aa1d95474","modified":1637377863000},{"_id":"source/_posts/podman-arch-usage/gogs-git-repository.jpg","hash":"77b39edaa1f5d430e067d4d71b7e228b2e0c8fa8","modified":1636819922000},{"_id":"source/_posts/podman-arch-usage/minio-server-cloud-native-object-storage-demo-1.jpg","hash":"42f2be9c7c2bb6b6c2597b1a1c369090c1cc386f","modified":1630469787000},{"_id":"source/_posts/podman-arch-usage/minio-server-cloud-native-object-storage-demo-3.jpg","hash":"c3a64c0141e40b595925f26175050fd0484f6d48","modified":1630470097000},{"_id":"source/_posts/podman-arch-usage/podman-busybox-capability.jpg","hash":"8990f8c6a51ace7796ceed5712fa4146a769488b","modified":1637651221000},{"_id":"source/_posts/podman-arch-usage/podman-commit-warning.jpg","hash":"1f00e86ac6489590310efa3dee45503655b0df28","modified":1637645750000},{"_id":"source/_posts/podman-arch-usage/podman-login-token.jpg","hash":"a2288cdcae2f4b9bf988e64c1f4688bca2333f08","modified":1644250290000},{"_id":"source/_posts/podman-arch-usage/podman-push-quay.jpg","hash":"9b1ab1dc61c042038bd7806f9f719f52bf7b374e","modified":1636551815000},{"_id":"source/_posts/podman-arch-usage/podman-run-pod-create.jpg","hash":"5a50b2f67dad8fd06a5146b63934fd21a7532df5","modified":1637648163000},{"_id":"source/_posts/podman-arch-usage/podman-rmi-error-no-container-use.jpg","hash":"4a17ca0766d17379cf1fd15a2522887dded056b0","modified":1636550872000},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-2.jpg","hash":"a0def5fdf57cc9c4d7a803300015639d836ba47f","modified":1637771691000},{"_id":"source/_posts/podman-usage-practice/container-access-external-iptables.jpg","hash":"0a5b385ecba903eab3223979a77cb51aa1d95474","modified":1637377863000},{"_id":"source/_posts/podman-usage-practice/minio-server-cloud-native-object-storage-demo-1.jpg","hash":"42f2be9c7c2bb6b6c2597b1a1c369090c1cc386f","modified":1630469787000},{"_id":"source/_posts/podman-usage-practice/gogs-git-repository.jpg","hash":"77b39edaa1f5d430e067d4d71b7e228b2e0c8fa8","modified":1636819922000},{"_id":"source/_posts/podman-usage-practice/podman-busybox-capability.jpg","hash":"8990f8c6a51ace7796ceed5712fa4146a769488b","modified":1637651221000},{"_id":"source/_posts/podman-usage-practice/minio-server-cloud-native-object-storage-demo-3.jpg","hash":"c3a64c0141e40b595925f26175050fd0484f6d48","modified":1630470097000},{"_id":"source/_posts/podman-usage-practice/podman-login-token.jpg","hash":"a2288cdcae2f4b9bf988e64c1f4688bca2333f08","modified":1644250290000},{"_id":"source/_posts/podman-usage-practice/podman-push-quay.jpg","hash":"9b1ab1dc61c042038bd7806f9f719f52bf7b374e","modified":1636551815000},{"_id":"source/_posts/podman-usage-practice/podman-commit-warning.jpg","hash":"1f00e86ac6489590310efa3dee45503655b0df28","modified":1637645750000},{"_id":"source/_posts/podman-usage-practice/podman-rmi-error-no-container-use.jpg","hash":"4a17ca0766d17379cf1fd15a2522887dded056b0","modified":1636550872000},{"_id":"source/_posts/podman-usage-practice/podman-run-pod-create.jpg","hash":"5a50b2f67dad8fd06a5146b63934fd21a7532df5","modified":1637648163000},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-2.jpg","hash":"a0def5fdf57cc9c4d7a803300015639d836ba47f","modified":1637771691000},{"_id":"source/_posts/redhat-quay-v3-registry/catalog-health-index.jpg","hash":"d4201bd4a61a4d969173aca2351156c96b161e9d","modified":1643292823000},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-7.png","hash":"7cc6cb2439650e33401891f76b12a931490c7264","modified":1620892370000},{"_id":"source/_posts/redhat-quay-v3-registry/go-toolset-catalog.jpg","hash":"e8f08e57a7bd0dadd47b5d3d6e7378c9b86e7ed2","modified":1643278660000},{"_id":"source/_posts/redhat-quay-v3-registry/docker-client-login-quay-registry.jpg","hash":"55d78f296219e61490b1dcbffb7680a8ff3b84f8","modified":1639991740000},{"_id":"source/_posts/skopeo-basic-usage/podman-load-dir-from-skopeo-copy.jpg","hash":"3ea789e8147a5823dc5a81b9e311a8dadc7eb90b","modified":1646380908000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-dest-creds.jpg","hash":"45476fa26b5e9abcb78f4e9a46fba63c6dac48ac","modified":1644308465000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-docker-image-format-digest-2.jpg","hash":"58124f703d6f38a4b11181068602fe35461628f6","modified":1649520415000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-delete-2.jpg","hash":"7ad8615297b0ca28d13c1486709e6cadb2a2cd4e","modified":1646708694000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-sync-demo.jpg","hash":"09adc47d47a909749b1d870e52235756fe840fd0","modified":1646570433000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-sync-help.jpg","hash":"a82aad52c6bc77f317e382afe98d5f5a1c686869","modified":1646570666000},{"_id":"themes/huxblog/source/fonts/glyphicons-halflings-regular.svg","hash":"de51a8494180a6db074af2dee2383f0a363c5b08","modified":1669631581124},{"_id":"themes/huxblog/source/js/bootstrap.js","hash":"f8752e9ae24daec0a0baffd7819122f8c6fd9103","modified":1669631581126},{"_id":"themes/huxblog/source/js/jquery.min.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1669631581133},{"_id":"source/_posts/fcos-rhcos-basic-usage/quay-coreos-butane-release.png","hash":"b5c02e6ac9bd196524e15c8114d3ff98a11c2fc9","modified":1665231865000},{"_id":"source/_posts/https-handshake-authentication/server-ca-signed-certification.png","hash":"f914d929019c0b6c27d0da40108f2088def8ab35","modified":1672414477000},{"_id":"source/_posts/kani-deploy-k8s/crictl-ssl-ca-request-quay-error.jpg","hash":"b01f928b407f3c61d3c897624058a726e8480aab","modified":1669631581001},{"_id":"source/_posts/kani-deploy-k8s/kubernetes-cluster-status.jpg","hash":"335781aa908ac09c559c7489bc640b68d65a28a6","modified":1669631581013},{"_id":"source/_posts/kani-deploy-k8s/register-var-used-between-two-plays-error.jpg","hash":"bbcc1fed4bf997f62d05945e2188e7141a2b5886","modified":1669631581014},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-6.jpg","hash":"6350f8f4c5b83d1d09f41c9459d0ec011836692a","modified":1617608003000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-7.jpg","hash":"bc29762a1a76b672c7e411e1021e4c11d5ccbd79","modified":1620057031000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-5.jpg","hash":"6227cdaa9c93e14aeef391ddfa78ae9d47aaafc1","modified":1620056956000},{"_id":"source/_posts/podman-arch-usage/cockpit-podman-1.jpg","hash":"2ed48ec04ce40bc94daab5199f2a421db451e566","modified":1636526169000},{"_id":"source/_posts/podman-arch-usage/cockpit-podman-2.jpg","hash":"2d5593e61dc10a933a935fcf9812b376f4dffee2","modified":1636527806000},{"_id":"source/_posts/podman-arch-usage/gogs-settings.jpg","hash":"3e05ffb0a5afc46ec844255b0e49b4f23cb28ff6","modified":1636737518000},{"_id":"source/_posts/podman-arch-usage/podman-network-mode.jpg","hash":"dbe1ed815c0607b8a38443bca037c484c801b393","modified":1637721102000},{"_id":"source/_posts/podman-arch-usage/podman-image-list.jps.JPG","hash":"d5ffbd3a6f971c6de9fb62cca4b5d7bea07703db","modified":1636734394000},{"_id":"source/_posts/podman-arch-usage/rootless-slirp4netns-networking.jpg","hash":"0022457652df2d9194f589ad0dd6993046e3bdd7","modified":1637722632000},{"_id":"source/_posts/podman-usage-practice/cockpit-podman-1.jpg","hash":"2ed48ec04ce40bc94daab5199f2a421db451e566","modified":1636526169000},{"_id":"source/_posts/podman-usage-practice/hualf-rootless-container.jpg","hash":"683e74d3b16de4db7c8f172607409f3b88d57058","modified":1637725964000},{"_id":"source/_posts/podman-usage-practice/gogs-settings.jpg","hash":"3e05ffb0a5afc46ec844255b0e49b4f23cb28ff6","modified":1636737518000},{"_id":"source/_posts/podman-usage-practice/podman-image-list.jps.JPG","hash":"d5ffbd3a6f971c6de9fb62cca4b5d7bea07703db","modified":1636734394000},{"_id":"source/_posts/podman-usage-practice/podman-network-mode.jpg","hash":"dbe1ed815c0607b8a38443bca037c484c801b393","modified":1637721102000},{"_id":"source/_posts/podman-usage-practice/rootless-slirp4netns-networking.jpg","hash":"0022457652df2d9194f589ad0dd6993046e3bdd7","modified":1637722632000},{"_id":"source/_posts/redhat-quay-v3-registry/podman-push-quay-permission-denied-1001-2.jpg","hash":"647fcb3baaa75966e4084a952b563dc467a320ca","modified":1639990986000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-transform-image-format.jpg","hash":"235ba0cb6144c34ed1769dc37e42ed6bd47cfa70","modified":1646394039000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-delete-1.jpg","hash":"0288235f6eca18418b38c7412604003a453ff790","modified":1646708636000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-docker-image-format-digest-1.jpg","hash":"855bd8351c8d10b0181ac7f324f218c86e696a08","modified":1649519242000},{"_id":"themes/huxblog/source/css/bootstrap.min.css","hash":"973e37a8502921d56bc02bb55321f45b072b6f71","modified":1669631581122},{"_id":"source/_posts/skopeo-basic-usage/skopeo-sync-between-registry.jpg","hash":"8372bbb26c0b94488dc7af066f757118bd85778b","modified":1646661277000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-inspect-creds.jpg","hash":"8fb1b2cca6fd766abab0fa3f71ca55c987b6a837","modified":1644298484000},{"_id":"source/_posts/https-handshake-authentication/client-hello-body-1.png","hash":"01839c1fa38511bff6c7296c454fcce40ef83a8e","modified":1672413692000},{"_id":"source/_posts/https-handshake-authentication/https-bg.png","hash":"2c68ccda2f4e2c1c8e7c3002706bc9c14386740f","modified":1674191677000},{"_id":"source/_posts/https-handshake-authentication/https-mutual-no-client-cert-error-2.png","hash":"c07b7347c864211a5c0e63690764f20a6c2d2e1a","modified":1674051092000},{"_id":"source/_posts/https-handshake-authentication/https-single-auth-chrome-error-2.png","hash":"761bb96d3cf2f85f180e0d244f94f92974ec4520","modified":1674050248000},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-interface-1.jpg","hash":"0bd4c09b7df615c1034086ae556f8d5cda1099ac","modified":1669631580995},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-single-authentication-progress.png","hash":"4d5f7d197cd0291479ee5848399b2350842a034a","modified":1672393109000},{"_id":"source/_posts/kani-deploy-k8s/kani-ansible-k8s.jpg","hash":"7a35501aa669849c73b2002ebf8bc2e87146ce6c","modified":1669631581004},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-4.jpg","hash":"a8f11a1c9ba264f2d02895d92c85376f1f10e33b","modified":1617607953000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/quay-push-error-1.jpg","hash":"a2d974e7fdf3b238302b45ca2ccf35b30624bc7c","modified":1620047282000},{"_id":"source/_posts/podman-arch-usage/external-access-container-web-service-iptables.jpg","hash":"fbf816946c2270517a74a40af1cf6c2dc473054e","modified":1637734423000},{"_id":"source/_posts/podman-arch-usage/minio-server-cloud-native-object-storage-demo-2.jpg","hash":"88b0c6576515378cd6399902a61a4da8db750d66","modified":1630469942000},{"_id":"source/_posts/podman-arch-usage/hualf-rootless-container.jpg","hash":"683e74d3b16de4db7c8f172607409f3b88d57058","modified":1637725964000},{"_id":"source/_posts/podman-usage-practice/cockpit-podman-2.jpg","hash":"2d5593e61dc10a933a935fcf9812b376f4dffee2","modified":1636527806000},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-1.jpg","hash":"7e1664afc7d84c7765f690d5d543ea4d43c086c2","modified":1637747578000},{"_id":"source/_posts/podman-usage-practice/external-access-container-web-service-iptables.jpg","hash":"fbf816946c2270517a74a40af1cf6c2dc473054e","modified":1637734423000},{"_id":"source/_posts/podman-usage-practice/minio-server-cloud-native-object-storage-demo-2.jpg","hash":"88b0c6576515378cd6399902a61a4da8db750d66","modified":1630469942000},{"_id":"source/_posts/kani-deploy-k8s/kani-ansible-k8s.svg","hash":"058b1ad3bc58da9e24c28949f6d5691b4f8961e9","modified":1669631581007},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-docker-format-image-dir.jpg","hash":"d9c7289d1620f56f7e0095dd63902bbac029097c","modified":1646380701000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-oci-2.jpg","hash":"0b711364bf595e28f0169a12d33a8a181e177a41","modified":1644424523000},{"_id":"themes/huxblog/source/css/bootstrap.css","hash":"41c54bf695145ae0b4d9020a1da308ceb05dcaf3","modified":1669631581120},{"_id":"source/_posts/https-handshake-authentication/ssl-four-handshakes-https-single-and-mutual-authentication.png","hash":"aaa2573ec0d4ff333f2cd2a2ddd0c4d0bd80c20b","modified":1674134003000},{"_id":"source/_posts/https-handshake-authentication/wireshark-https-mutual-progress.png","hash":"ab72112700f6869f63aa3cb35c99024f24afcc58","modified":1674050688000},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-apiserver-manifest.jpg","hash":"61f244e6262b8e1d7f9c0ad49153ac8738fc1036","modified":1669631580983},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-single-master-arch.jpg","hash":"5c20ea9faea6a10912cd1375b09f03dd65e60fdb","modified":1669631580999},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-8.jpg","hash":"6fe8ff80799ce06f136d117db5f6c47b4e8af019","modified":1617608111000},{"_id":"source/_posts/podman-arch-usage/centos79-kernel-not-support-podman-rootless.jpg","hash":"a74d92a8d16cf92299d7c3b4023c95f2058291b4","modified":1630941669000},{"_id":"source/_posts/podman-usage-practice/rootless-container-to-container-bandwidth.jpg","hash":"6f87ae38c8686584e46d01915c52ed42be2fa3a8","modified":1637824939000},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-1.jpg","hash":"7e1664afc7d84c7765f690d5d543ea4d43c086c2","modified":1637747578000},{"_id":"source/_posts/kani-deploy-k8s/kubeadm-init-master-error-2.jpg","hash":"bc4e56c5a1da40ab32ab98b9b74ecc32e195b671","modified":1669631581012},{"_id":"source/_posts/kani-deploy-k8s/kubeadm-init-master-error-1.jpg","hash":"f8677913ae780a3957b04e4e3803cd70b19fe629","modified":1669631581009},{"_id":"source/_posts/redhat-quay-v3-registry/ssl-key-permission-run-quay-error.jpg","hash":"6a3046920f57a2632901bff5cd23bc6578d700e6","modified":1639989903000},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/mongodb-bg-2.png","hash":"66734d327c32386d45e2cee65f1ecfc6bafec7c4","modified":1670296309000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-docker-daemon.jpg","hash":"3e3e9293fd025cdab6d970dcecc594b0d1e61dc5","modified":1646390437000},{"_id":"source/img/contact-bg.jpg","hash":"6af63305c923899017e727b5ca968a2703bc08cf","modified":1669631581026},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-oci-1.jpg","hash":"397d21637a0129e688837cead4b53dd67f42ae05","modified":1644421805000},{"_id":"source/_posts/skopeo-basic-usage/skopeo-oci-image-format-digest.jpg","hash":"67af2b24116e26452669bd1feebc50f1b70c1e41","modified":1649521149000},{"_id":"themes/huxblog/source/js/jquery.js","hash":"1852661bd11a09ca9b9cb63d1aa6ff390fffaf4e","modified":1669631581131},{"_id":"source/_posts/fcos-rhcos-basic-usage/fedora-coreos-bg.jpg","hash":"80069c0b6e00f672f6d48da592db0d643c184f92","modified":1669650002000},{"_id":"source/_posts/https-handshake-authentication/client-server-tcp-ssl-socket.png","hash":"78d432604d1626e763eddf9ec4aa2d8b38ba205d","modified":1672386149000},{"_id":"source/_posts/podman-arch-usage/rootless-container-to-container-bandwidth.jpg","hash":"6f87ae38c8686584e46d01915c52ed42be2fa3a8","modified":1637824939000},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-2-edited.png","hash":"cdf0baf52a744c3f20a9f3765b29a24eca95b620","modified":1637771734000},{"_id":"source/_posts/podman-usage-practice/centos79-kernel-not-support-podman-rootless.jpg","hash":"a74d92a8d16cf92299d7c3b4023c95f2058291b4","modified":1630941669000},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-2-edited.png","hash":"cdf0baf52a744c3f20a9f3765b29a24eca95b620","modified":1637771734000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-3.jpg","hash":"7f7ac414f86f0d48a40afb52c0da736b6e3aa560","modified":1620056662000},{"_id":"source/img/about-bg.svg","hash":"55173e85b5a107bb539e2d2e3858716ebee9644e","modified":1669631581024},{"_id":"source/img/about-bg.jpg","hash":"f197658cf766d9dea12627a43f68ed04cf7a41f5","modified":1669631581020},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/selinux-php-mysql-connection.jpg","hash":"7813de2ca12bb4cd150629c838fa3bf254836584","modified":1617608433000},{"_id":"source/_posts/podman-arch-usage/godev-rootless-container.jpg","hash":"eadca754687ed7a1cff4f4b965c7ef888429f48f","modified":1637726199000},{"_id":"source/_posts/podman-arch-usage/rootfull-container-to-container-bandwidth.jpg","hash":"79a810aa2badd7a0bc5f4d50e823c10a20afbcc5","modified":1637824617000},{"_id":"source/_posts/podman-arch-usage/rootless-user-namespace-mapping.jpg","hash":"406c3a53724907a84e61e43c6afa8c4dc6bfa76e","modified":1637777101000},{"_id":"source/_posts/podman-usage-practice/rootfull-container-to-container-bandwidth.jpg","hash":"79a810aa2badd7a0bc5f4d50e823c10a20afbcc5","modified":1637824617000},{"_id":"source/_posts/podman-usage-practice/rootless-user-namespace-mapping.jpg","hash":"406c3a53724907a84e61e43c6afa8c4dc6bfa76e","modified":1637777101000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-10.jpg","hash":"d5ad86a3b0d9e0d886f00ae40c17b2972a010189","modified":1617608157000},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-mongo-connect-successfully.png","hash":"b0cf92a065914233e158d824ce35b52bfc4f0692","modified":1670298225000},{"_id":"source/_posts/https-handshake-authentication/wireshark-https-single-progress.png","hash":"87649ce143e604823ae07539339d3212ba9e271c","modified":1672392516000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/mysql-container-run-error.jpg","hash":"770854edbe9fb577ebc5f74b31d8dad7946d3de0","modified":1620057910000},{"_id":"source/_posts/podman-usage-practice/podman-pull-image.jpg","hash":"d98ad0e5eebbfc7c9961778f5aa76059df4fe837","modified":1636552103000},{"_id":"source/_posts/podman-arch-usage/podman-bg.png","hash":"0f87a77cf55aeadc57a0f2b7c5b768f41ee864be","modified":1670224199000},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/hello-world-dark-bg.jpg","hash":"68c66b89413ad5b8424ee897cffa3bb85801778b","modified":1548430882000},{"_id":"source/_posts/podman-arch-usage/podman-pull-image.jpg","hash":"d98ad0e5eebbfc7c9961778f5aa76059df4fe837","modified":1636552103000},{"_id":"source/_posts/podman-usage-practice/godev-rootless-container.jpg","hash":"eadca754687ed7a1cff4f4b965c7ef888429f48f","modified":1637726199000},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-with-mismatch-version-mongo-error.png","hash":"75e6a227ea1f19a894c824b1c3791954120539c8","modified":1670298231000},{"_id":"source/_posts/redhat-quay-v3-registry/redhat-quay-bg.jpg","hash":"ff153a91c833cdf3c1e669a4cb0645316919e08d","modified":1543677817000},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-1-edited.png","hash":"d01298d9f6ec39da27ba3ea2a0d199079d95a0d3","modified":1637763240000},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-1-edited.png","hash":"d01298d9f6ec39da27ba3ea2a0d199079d95a0d3","modified":1637763240000},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-ha-arch-demo.jpg","hash":"26ff45e914e1dc29b90babc5713cbdbd61073cca","modified":1669631580993},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-mongo-app-resources.png","hash":"7b4fa383943178baae48b26cecc73b378b8e353c","modified":1670298240000},{"_id":"source/_posts/podman-usage-practice/podman-macvlan-network.png","hash":"b73fcbd388f81b35f5a4a6a3a055652ccdc84eb7","modified":1637838258000},{"_id":"source/img/home-bg.jpg","hash":"51e6764382b85848bf9f1532e875b398fea31dad","modified":1669631581045},{"_id":"source/_posts/podman-arch-usage/podman-macvlan-network.png","hash":"b73fcbd388f81b35f5a4a6a3a055652ccdc84eb7","modified":1637838258000},{"_id":"source/img/home-bg.svg","hash":"495f662ffd91fb4e6f8014e43ed9f11f9c47414a","modified":1669631581106}],"Category":[],"Data":[],"Page":[{"layout":"404","description":"ä½ æ¥åˆ°äº†æ²¡æœ‰çŸ¥è¯†çš„è’åŸ :(","header-img":"img/404-bg.jpg","_content":"","source":"404.md","raw":"---\nlayout: 404\ndescription: \"ä½ æ¥åˆ°äº†æ²¡æœ‰çŸ¥è¯†çš„è’åŸ :(\"\nheader-img: \"img/404-bg.jpg\"\n---\n","date":"2022-11-28T10:33:00.973Z","updated":"2022-11-28T10:33:00.973Z","path":"404.html","title":"","comments":1,"_id":"cldfonoaf000016vd37lr8z01","content":"","site":{"data":{}},"excerpt":"","more":""},{"layout":"about","title":"å…³äºæˆ‘","date":"2022-11-27T17:16:05.000Z","description":"Alberthua | æˆ‘å’Œåšå®¢çš„æ•…äº‹","header-img":"img/about-bg.svg","comments":1,"_content":"\n## æˆ‘å’Œåšå®¢çš„æ•…äº‹\n\nğŸ‘‹ æˆ‘æ˜¯åé¾™é£ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼\n\nğŸ‘¨â€ğŸ“ æˆ‘æ¯•ä¸šäºå›½å†…æŸé«˜ç­‰é™¢æ ¡ç”Ÿç‰©æŠ€æœ¯ä¸“ä¸šï¼Œæ¯•ä¸šåä»äº‹ç”Ÿç‰©ä¿¡æ¯æ•°æ®åˆ†æé¢†åŸŸå·¥ä½œ 3 å¹´å·¦å³ï¼Œä¸»è¦å®æ–½äººç±»åŸºå› ç»„ ğŸ§¬ ä¸ RNA æ·±åº¦æµ‹åºæ•°æ®ä¸ä½ç‚¹çš„åˆ†æè§£è¯» ğŸ‘¨â€ğŸ’»ã€‚è½¬æˆ˜ `Linux` ğŸ§ ä¸äº‘è®¡ç®—é¢†åŸŸè‡³ä»Šï¼Œç›®å‰å°±èŒäºæŸå›½é™…å¼€æºç³»ç»Ÿå…¬å¸æ‹…ä»» `Instructor`ã€‚\n\nğŸ¦„ ç›®å‰ï¼Œå·²ä½¿ç”¨çš„æŠ€æœ¯æ ˆåŒ…æ‹¬ä½†ä¸é™äºï¼š\n- `Linux`\n- `KVM` & `Qemu`\n- `Open vSwitch`\n- `OpenStack`\n- `Ceph`\n- `Ansible` & `Ansible Tower`\n- `Podman` & `Skopeo`\n- `Kubernetes`\n- `OpenShift`\n- `Tekton` & `ArgoCD`ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- `Prometheus`ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- åŸºäº `Golang` çš„ `Cloud Native` å¾®æœåŠ¡å¼€å‘ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- `Shell`\n- `Perl`\n- `Gloang`ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- ...\n\nâœ¨ æˆ‘çš„åšå®¢ä¸­å°†è®°å½•æŠ€æœ¯ä¸ç¼–ç¨‹è¯­è¨€çš„å­¦ä¹ æ€»ç»“ã€æ—¥å¸¸å·¥ä½œä¸­çš„é¿å‘æç¤ºã€å·¥ä½œç”Ÿæ´»ä¸­çš„ç¢ç¢å¿µç­‰ï¼Œè°¨ä»¥æ­¤ä¸€äº©ä¸‰åˆ†åœ°ç”¨ä»¥è®°å½•å§ã€‚åšå®¢ä¸­çš„æ–‡ç« å¯èƒ½æœªåŠæ—¶ä¸æˆ‘çš„ [GitHub æŠ€æœ¯æ–‡æ¡£](https://github.com/Alberthua-Perl/tech-docs) åŒæ­¥ï¼Œæ‚¨å¯ç›´æ¥è®¿é—®æˆ‘çš„ [GitHub](https://github.com/Alberthua-Perl/) ä»¥è·å–æœ€æ–°çš„åŠ¨æ€ï¼\n\nğŸš€ å¦‚æœæ‚¨å¯¹æˆ‘çš„æ–‡ç« æ„Ÿå…´è¶£ã€æœ‰ç–‘é—®ã€æå»ºè®®ï¼Œæ¬¢è¿äºˆæˆ‘é‚®ä»¶ hualongfeiyyy@163.com è”ç³»ï¼Œæˆ‘å°†æ„Ÿåˆ°ååˆ†è£å¹¸ï¼","source":"about/index.md","raw":"---\nlayout: \"about\"\ntitle: \"å…³äºæˆ‘\"\ndate: 2022-11-28 01:16:05\ndescription: \"Alberthua | æˆ‘å’Œåšå®¢çš„æ•…äº‹\"\nheader-img: \"img/about-bg.svg\"\ncomments: true\n---\n\n## æˆ‘å’Œåšå®¢çš„æ•…äº‹\n\nğŸ‘‹ æˆ‘æ˜¯åé¾™é£ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼\n\nğŸ‘¨â€ğŸ“ æˆ‘æ¯•ä¸šäºå›½å†…æŸé«˜ç­‰é™¢æ ¡ç”Ÿç‰©æŠ€æœ¯ä¸“ä¸šï¼Œæ¯•ä¸šåä»äº‹ç”Ÿç‰©ä¿¡æ¯æ•°æ®åˆ†æé¢†åŸŸå·¥ä½œ 3 å¹´å·¦å³ï¼Œä¸»è¦å®æ–½äººç±»åŸºå› ç»„ ğŸ§¬ ä¸ RNA æ·±åº¦æµ‹åºæ•°æ®ä¸ä½ç‚¹çš„åˆ†æè§£è¯» ğŸ‘¨â€ğŸ’»ã€‚è½¬æˆ˜ `Linux` ğŸ§ ä¸äº‘è®¡ç®—é¢†åŸŸè‡³ä»Šï¼Œç›®å‰å°±èŒäºæŸå›½é™…å¼€æºç³»ç»Ÿå…¬å¸æ‹…ä»» `Instructor`ã€‚\n\nğŸ¦„ ç›®å‰ï¼Œå·²ä½¿ç”¨çš„æŠ€æœ¯æ ˆåŒ…æ‹¬ä½†ä¸é™äºï¼š\n- `Linux`\n- `KVM` & `Qemu`\n- `Open vSwitch`\n- `OpenStack`\n- `Ceph`\n- `Ansible` & `Ansible Tower`\n- `Podman` & `Skopeo`\n- `Kubernetes`\n- `OpenShift`\n- `Tekton` & `ArgoCD`ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- `Prometheus`ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- åŸºäº `Golang` çš„ `Cloud Native` å¾®æœåŠ¡å¼€å‘ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- `Shell`\n- `Perl`\n- `Gloang`ï¼ˆå­¦ä¹ ä¸­ âœï¼‰\n- ...\n\nâœ¨ æˆ‘çš„åšå®¢ä¸­å°†è®°å½•æŠ€æœ¯ä¸ç¼–ç¨‹è¯­è¨€çš„å­¦ä¹ æ€»ç»“ã€æ—¥å¸¸å·¥ä½œä¸­çš„é¿å‘æç¤ºã€å·¥ä½œç”Ÿæ´»ä¸­çš„ç¢ç¢å¿µç­‰ï¼Œè°¨ä»¥æ­¤ä¸€äº©ä¸‰åˆ†åœ°ç”¨ä»¥è®°å½•å§ã€‚åšå®¢ä¸­çš„æ–‡ç« å¯èƒ½æœªåŠæ—¶ä¸æˆ‘çš„ [GitHub æŠ€æœ¯æ–‡æ¡£](https://github.com/Alberthua-Perl/tech-docs) åŒæ­¥ï¼Œæ‚¨å¯ç›´æ¥è®¿é—®æˆ‘çš„ [GitHub](https://github.com/Alberthua-Perl/) ä»¥è·å–æœ€æ–°çš„åŠ¨æ€ï¼\n\nğŸš€ å¦‚æœæ‚¨å¯¹æˆ‘çš„æ–‡ç« æ„Ÿå…´è¶£ã€æœ‰ç–‘é—®ã€æå»ºè®®ï¼Œæ¬¢è¿äºˆæˆ‘é‚®ä»¶ hualongfeiyyy@163.com è”ç³»ï¼Œæˆ‘å°†æ„Ÿåˆ°ååˆ†è£å¹¸ï¼","updated":"2022-12-25T12:39:56.003Z","path":"about/index.html","_id":"cldfonoj1000216vdjbl1diwn","content":"<h2 id=\"æˆ‘å’Œåšå®¢çš„æ•…äº‹\"><a href=\"#æˆ‘å’Œåšå®¢çš„æ•…äº‹\" class=\"headerlink\" title=\"æˆ‘å’Œåšå®¢çš„æ•…äº‹\"></a>æˆ‘å’Œåšå®¢çš„æ•…äº‹</h2><p>ğŸ‘‹ æˆ‘æ˜¯åé¾™é£ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼</p>\n<p>ğŸ‘¨â€ğŸ“ æˆ‘æ¯•ä¸šäºå›½å†…æŸé«˜ç­‰é™¢æ ¡ç”Ÿç‰©æŠ€æœ¯ä¸“ä¸šï¼Œæ¯•ä¸šåä»äº‹ç”Ÿç‰©ä¿¡æ¯æ•°æ®åˆ†æé¢†åŸŸå·¥ä½œ 3 å¹´å·¦å³ï¼Œä¸»è¦å®æ–½äººç±»åŸºå› ç»„ ğŸ§¬ ä¸ RNA æ·±åº¦æµ‹åºæ•°æ®ä¸ä½ç‚¹çš„åˆ†æè§£è¯» ğŸ‘¨â€ğŸ’»ã€‚è½¬æˆ˜ <code>Linux</code> ğŸ§ ä¸äº‘è®¡ç®—é¢†åŸŸè‡³ä»Šï¼Œç›®å‰å°±èŒäºæŸå›½é™…å¼€æºç³»ç»Ÿå…¬å¸æ‹…ä»» <code>Instructor</code>ã€‚</p>\n<p>ğŸ¦„ ç›®å‰ï¼Œå·²ä½¿ç”¨çš„æŠ€æœ¯æ ˆåŒ…æ‹¬ä½†ä¸é™äºï¼š</p>\n<ul>\n<li><code>Linux</code></li>\n<li><code>KVM</code> &amp; <code>Qemu</code></li>\n<li><code>Open vSwitch</code></li>\n<li><code>OpenStack</code></li>\n<li><code>Ceph</code></li>\n<li><code>Ansible</code> &amp; <code>Ansible Tower</code></li>\n<li><code>Podman</code> &amp; <code>Skopeo</code></li>\n<li><code>Kubernetes</code></li>\n<li><code>OpenShift</code></li>\n<li><code>Tekton</code> &amp; <code>ArgoCD</code>ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li><code>Prometheus</code>ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li>åŸºäº <code>Golang</code> çš„ <code>Cloud Native</code> å¾®æœåŠ¡å¼€å‘ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li><code>Shell</code></li>\n<li><code>Perl</code></li>\n<li><code>Gloang</code>ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li>â€¦</li>\n</ul>\n<p>âœ¨ æˆ‘çš„åšå®¢ä¸­å°†è®°å½•æŠ€æœ¯ä¸ç¼–ç¨‹è¯­è¨€çš„å­¦ä¹ æ€»ç»“ã€æ—¥å¸¸å·¥ä½œä¸­çš„é¿å‘æç¤ºã€å·¥ä½œç”Ÿæ´»ä¸­çš„ç¢ç¢å¿µç­‰ï¼Œè°¨ä»¥æ­¤ä¸€äº©ä¸‰åˆ†åœ°ç”¨ä»¥è®°å½•å§ã€‚åšå®¢ä¸­çš„æ–‡ç« å¯èƒ½æœªåŠæ—¶ä¸æˆ‘çš„ <a href=\"https://github.com/Alberthua-Perl/tech-docs\" target=\"_blank\" rel=\"noopener\">GitHub æŠ€æœ¯æ–‡æ¡£</a> åŒæ­¥ï¼Œæ‚¨å¯ç›´æ¥è®¿é—®æˆ‘çš„ <a href=\"https://github.com/Alberthua-Perl/\" target=\"_blank\" rel=\"noopener\">GitHub</a> ä»¥è·å–æœ€æ–°çš„åŠ¨æ€ï¼</p>\n<p>ğŸš€ å¦‚æœæ‚¨å¯¹æˆ‘çš„æ–‡ç« æ„Ÿå…´è¶£ã€æœ‰ç–‘é—®ã€æå»ºè®®ï¼Œæ¬¢è¿äºˆæˆ‘é‚®ä»¶ <a href=\"mailto:hualongfeiyyy@163.com\" target=\"_blank\" rel=\"noopener\">hualongfeiyyy@163.com</a> è”ç³»ï¼Œæˆ‘å°†æ„Ÿåˆ°ååˆ†è£å¹¸ï¼</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"æˆ‘å’Œåšå®¢çš„æ•…äº‹\"><a href=\"#æˆ‘å’Œåšå®¢çš„æ•…äº‹\" class=\"headerlink\" title=\"æˆ‘å’Œåšå®¢çš„æ•…äº‹\"></a>æˆ‘å’Œåšå®¢çš„æ•…äº‹</h2><p>ğŸ‘‹ æˆ‘æ˜¯åé¾™é£ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼</p>\n<p>ğŸ‘¨â€ğŸ“ æˆ‘æ¯•ä¸šäºå›½å†…æŸé«˜ç­‰é™¢æ ¡ç”Ÿç‰©æŠ€æœ¯ä¸“ä¸šï¼Œæ¯•ä¸šåä»äº‹ç”Ÿç‰©ä¿¡æ¯æ•°æ®åˆ†æé¢†åŸŸå·¥ä½œ 3 å¹´å·¦å³ï¼Œä¸»è¦å®æ–½äººç±»åŸºå› ç»„ ğŸ§¬ ä¸ RNA æ·±åº¦æµ‹åºæ•°æ®ä¸ä½ç‚¹çš„åˆ†æè§£è¯» ğŸ‘¨â€ğŸ’»ã€‚è½¬æˆ˜ <code>Linux</code> ğŸ§ ä¸äº‘è®¡ç®—é¢†åŸŸè‡³ä»Šï¼Œç›®å‰å°±èŒäºæŸå›½é™…å¼€æºç³»ç»Ÿå…¬å¸æ‹…ä»» <code>Instructor</code>ã€‚</p>\n<p>ğŸ¦„ ç›®å‰ï¼Œå·²ä½¿ç”¨çš„æŠ€æœ¯æ ˆåŒ…æ‹¬ä½†ä¸é™äºï¼š</p>\n<ul>\n<li><code>Linux</code></li>\n<li><code>KVM</code> &amp; <code>Qemu</code></li>\n<li><code>Open vSwitch</code></li>\n<li><code>OpenStack</code></li>\n<li><code>Ceph</code></li>\n<li><code>Ansible</code> &amp; <code>Ansible Tower</code></li>\n<li><code>Podman</code> &amp; <code>Skopeo</code></li>\n<li><code>Kubernetes</code></li>\n<li><code>OpenShift</code></li>\n<li><code>Tekton</code> &amp; <code>ArgoCD</code>ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li><code>Prometheus</code>ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li>åŸºäº <code>Golang</code> çš„ <code>Cloud Native</code> å¾®æœåŠ¡å¼€å‘ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li><code>Shell</code></li>\n<li><code>Perl</code></li>\n<li><code>Gloang</code>ï¼ˆå­¦ä¹ ä¸­ âœï¼‰</li>\n<li>â€¦</li>\n</ul>\n<p>âœ¨ æˆ‘çš„åšå®¢ä¸­å°†è®°å½•æŠ€æœ¯ä¸ç¼–ç¨‹è¯­è¨€çš„å­¦ä¹ æ€»ç»“ã€æ—¥å¸¸å·¥ä½œä¸­çš„é¿å‘æç¤ºã€å·¥ä½œç”Ÿæ´»ä¸­çš„ç¢ç¢å¿µç­‰ï¼Œè°¨ä»¥æ­¤ä¸€äº©ä¸‰åˆ†åœ°ç”¨ä»¥è®°å½•å§ã€‚åšå®¢ä¸­çš„æ–‡ç« å¯èƒ½æœªåŠæ—¶ä¸æˆ‘çš„ <a href=\"https://github.com/Alberthua-Perl/tech-docs\" target=\"_blank\" rel=\"noopener\">GitHub æŠ€æœ¯æ–‡æ¡£</a> åŒæ­¥ï¼Œæ‚¨å¯ç›´æ¥è®¿é—®æˆ‘çš„ <a href=\"https://github.com/Alberthua-Perl/\" target=\"_blank\" rel=\"noopener\">GitHub</a> ä»¥è·å–æœ€æ–°çš„åŠ¨æ€ï¼</p>\n<p>ğŸš€ å¦‚æœæ‚¨å¯¹æˆ‘çš„æ–‡ç« æ„Ÿå…´è¶£ã€æœ‰ç–‘é—®ã€æå»ºè®®ï¼Œæ¬¢è¿äºˆæˆ‘é‚®ä»¶ <a href=\"mailto:hualongfeiyyy@163.com\" target=\"_blank\" rel=\"noopener\">hualongfeiyyy@163.com</a> è”ç³»ï¼Œæˆ‘å°†æ„Ÿåˆ°ååˆ†è£å¹¸ï¼</p>\n"},{"layout":"archives","title":"å½’æ¡£","description":"Alberthua | åˆ†ç±»ä¸å½’æ¡£","header-img":"img/tag-bg.svg","_content":"","source":"archives/index.md","raw":"---\nlayout: \"archives\"\ntitle: \"å½’æ¡£\"\ndescription: \"Alberthua | åˆ†ç±»ä¸å½’æ¡£\"\nheader-img: \"img/tag-bg.svg\"\n---\n","date":"2022-12-23T02:31:14.566Z","updated":"2022-12-23T02:31:14.566Z","path":"archives/index.html","comments":1,"_id":"cldfonok5000416vd48du8qr4","content":"","site":{"data":{}},"excerpt":"","more":""},{"layout":"tags","title":"åˆ†ç±»","description":"Alberthua | This is Tags","header-img":"img/tag-bg.svg","_content":"","source":"tags/index.md","raw":"---\nlayout: \"tags\"\ntitle: \"åˆ†ç±»\"\ndescription: \"Alberthua | This is Tags\"\nheader-img: \"img/tag-bg.svg\"\n---\n","date":"2022-12-23T02:40:05.742Z","updated":"2022-12-23T02:40:05.742Z","path":"tags/index.html","comments":1,"_id":"cldfonosu001q16vdzfxayyr5","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"ğŸ“¦ Fedora CoreOS åŠ RHCOS æ¦‚è¿°ä¸åº”ç”¨","subtitle":"Fedora CoreOS & RHCOS Basic and Usage","header-img":"fedora-coreos-bg.jpg","date":"2022-11-28T13:32:27.000Z","_content":"\n### æ–‡æ¡£ç›®å½•ï¼š\n- å…³é”®æŠ€æœ¯ç‚¹\n- Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§\n- Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹\n- Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåº\n- Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜\n- Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯\n- å‚è€ƒé“¾æ¥\n\n### å…³é”®æŠ€æœ¯ç‚¹ï¼š\n- ä»¥ä¸‹æŠ€æœ¯ç‚¹åœ¨æ–‡ä¸­å°†æ ¹æ® Fedora CoreOS åŠ RHCOS ä¸­å±•å¼€è¯´æ˜ï¼š  \n  - ignition, butane, ignition-validate  \n  - ostree, rpm-tree,zincati, bootupd\n\n### Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§ï¼š\n- åœ¨ OpenShift 4 å®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨å®‰è£… CoreOS çš„å•†ä¸šç‰ˆ Red Hat Enterprise Linux CoreOSï¼ˆç®€ç§° `RHCOS`ï¼‰ã€‚æ ¹æ® OpenShift 4 çš„æ–‡æ¡£è¯´æ˜ï¼ŒRHCOS æ— æ³•ç‹¬ç«‹è¿è¡Œå®‰è£…ï¼Œå®ƒå¿…é¡»å’Œ OpenShift 4 ä¸€èµ·è¿è¡Œï¼ˆå› æ­¤ RHCOS æ²¡æœ‰å•ç‹¬çš„è®¢é˜…ï¼‰ã€‚\n- ğŸ˜ƒ ä¸è¿‡å¥½åœ¨ CoreOS è¿˜æä¾›äº†å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ç¤¾åŒºç‰ˆ `Fedora CoreOS`ï¼ˆç®€ç§° `FCOS`ï¼‰å¯ä»¥å®Œå…¨å…è´¹ä½¿ç”¨ã€‚ç”±äº FCOS å¯ä»¥æ— éœ€ OpenShift 4 ä¹Ÿå¯ä»¥ç‹¬ç«‹å®‰è£…è¿è¡Œï¼Œå› æ­¤ä½¿ç”¨ FCOS ä½œä¸ºç ”ç©¶ç¯å¢ƒï¼Œè€Œç›¸å…³æ“ä½œåŸºæœ¬éƒ½å¯é€‚ç”¨ RHCOS ç¯å¢ƒã€‚\n- FCOS/RHCOS æ˜¯ Red Hat åœ¨æ”¶è´­ CoreOS å…¬å¸åç»“åˆ `CoreOS Container Linux` å’Œ `Fedora Atomic Host` çš„ä¼˜ç‚¹æ¨å‡ºçš„æ–°ä¸€ä»£å®¹å™¨æ“ä½œç³»ç»Ÿï¼Œå…¶ç›®æ ‡æ˜¯æä¾›æœ€ä½³çš„å®¹å™¨ä¸»æœºï¼Œä»è€Œèƒ½å®‰å…¨ã€å¤§è§„æ¨¡åœ°è¿è¡Œå®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½ã€‚\n- FCOS/RHCOS å°† [Ignition](https://github.com/coreos/ignition)ï¼ˆç‚¹ç«ï¼‰ ä¸ rpm-ostree ç­‰æŠ€æœ¯ç›¸é›†æˆï¼Œæ˜¯ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°çš„ã€æœ€å°çš„ã€æ•´ä½“çš„ã€å¯¹è¿è¡Œå®¹å™¨å’Œ Kubernetes è¿›è¡Œäº†ä¼˜åŒ–çš„æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºå®ƒä»¬æ›´ç¬¦åˆ \"ä¸å¯å˜æ¶æ„\"ï¼ˆ`Immutable Infrastructure`ï¼‰ç†å¿µï¼Œå› æ­¤æˆä¸º Red Hat æ¨èçš„ OpenShift 4 åº•å±‚æ“ä½œç³»ç»Ÿã€‚\n- FCOS/RHCOS çš„å®‰è£…åŠé…ç½®è¿‡ç¨‹å’Œä¸€èˆ¬çš„ RHEL ç¨æœ‰å·®åˆ«ï¼Œéœ€è¦é€šè¿‡ Ignition é…ç½®æ–‡ä»¶åœ¨å®‰è£…çš„æ—¶å€™åˆå§‹åŒ–ç½‘ç»œã€å­˜å‚¨ã€å†…æ ¸ã€ç”¨æˆ·ç­‰æ–¹é¢çš„é…ç½®ã€‚\n- FCOS çš„è®¾è®¡ç†å¿µï¼š  \n  - ğŸ³ ç”±äºå®¹å™¨å…è®¸å°†å·¥ä½œè´Ÿè½½é‡å¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¹¶è‡ªåŠ¨æ‰©å±•ä»¥æ»¡è¶³éœ€æ±‚ã€‚å®¹å™¨æä¾›çš„éš”ç¦»æ„å‘³ç€ä¸»æœºæ“ä½œç³»ç»Ÿå¯ä»¥å¾ˆå°ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ª `Linux kernel`ã€`systemd`ã€`container runtime` å’Œä¸€äº›é™„åŠ æœåŠ¡ï¼ˆå¦‚ SSH æœåŠ¡å™¨ï¼‰ã€‚  \n  - FCOS æ˜¯ä¸“é—¨ä¸ºå®¹å™¨å·¥ä½œè´Ÿè½½è€Œè®¾è®¡çš„ï¼Œæ— éœ€å®šæœŸç»´æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨æœ€æ–°çš„æ“ä½œç³»ç»Ÿæ”¹è¿›ã€bug ä¿®å¤å’Œå®‰å…¨è‡ªåŠ¨æ›´æ–°ï¼Œå…¶ä½¿ç”¨ Ignition ä¸ºè‡ªèº«æä¾›æœåŠ¡ï¼Œä½¿ç”¨ `Podman` å’Œ `Moby` è¿è¡Œå®¹å™¨ï¼Œå¹¶ä½¿ç”¨ `rpm-ostree` è‡ªåŠ¨è¿›è¡ŒåŸå­æ›´æ–°ã€‚\n  > â— æ³¨æ„ï¼š\n  > \n  > 1. FCOS æ”¯æŒ `CRI-O` ä½œä¸ºå®¹å™¨å¼•æ“ï¼Œå¸¸ç”¨äº OpenShift 4 çš„åº•å±‚å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ CRI-O è¿è¡Œå®¹å™¨ï¼ŒOpenShift 4 å¯é€šè¿‡ `CRI` æ¥å£åˆ›å»ºä¸ç®¡ç† Podã€‚\n  > \n  > 2. å¯é€šè¿‡ `crictl` å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸ç®¡ç†å®¹å™¨åŠ Podï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹ç”¨äºå®¹å™¨æˆ– pod çš„è°ƒè¯•è€Œéå®¹å™¨æˆ– pod çš„åˆ›å»ºã€‚\n- FCOS è°ƒé…ä¸å¯å˜æ¶æ„ï¼š  \n  - åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼ï¼ˆ`first boot`ï¼‰é˜¶æ®µï¼ŒFCOS ä½¿ç”¨ Ignition è°ƒé…ç³»ç»Ÿã€‚  \n  - Ignition è¯»å–ç”¨æˆ·æä¾›çš„æ•°æ®æˆ–è¿œç¨‹ URL åœ°å€æä¾›çš„ Ignition é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨å®ƒåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  \n  - è°ƒé…ä¸»æœºçš„æ–¹å¼ï¼š    \n    - ç¼–è¾‘åŸºäº YAML æ ¼å¼çš„ `Fedora CoreOS Config`ï¼ˆFCCï¼‰æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šä¸»æœºçš„æœŸæœ›é…ç½®ï¼ŒFCC æ”¯æŒæ‰€æœ‰çš„ Ignition åŠŸèƒ½ï¼Œä¹Ÿæä¾›é¢å¤–çš„è¯­æ³•ã€‚    \n    - ä½¿ç”¨ `Fedora CoreOS Config Transpiler (Butane)` å·¥å…·å°† FCC æ–‡ä»¶ï¼ˆ`.fcc`ï¼‰è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆ`.ign`ï¼‰ã€‚    \n    - å¯åŠ¨ FCOS ä¸»æœºå¹¶å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä¸»æœºä¸­è°ƒé…ç³»ç»Ÿçš„å®‰è£…ã€‚    \n    > ğŸ’â€â™‚ï¸ è°ƒé…ä¸»æœºçš„æ–¹æ³•ï¼š\n    > \n    > 1. ä½¿ç”¨ PXE å¼•å¯¼å¹¶ä¸æŒ‡å®š Ignition é…ç½®æ–‡ä»¶è°ƒé…å®‰è£…ä¸»æœºã€‚\n    > \n    > 2. å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä½¿ç”¨ FCOS live ISO å¼•å¯¼å¯åŠ¨çš„ä¸»æœºä¸­ï¼Œå†ä½¿ç”¨ `coreos-installer` å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼ˆæœ¬æ–‡ä½¿ç”¨æ­¤æ–¹æ³•ï¼‰ã€‚  \n  - FCOS è¢«è®¾è®¡ä¸ºä¸å¯å˜æ¶æ„ã€‚åœ¨ä¸»æœºè¢«è°ƒé…ä¹‹åï¼Œä¸åº”è¯¥æ›´æ”¹ /etc ç›®å½•æˆ–é‡æ–°é…ç½®ä¸»æœºï¼Œç›¸åï¼Œæ›´æ”¹ FCC æ–‡ä»¶å¹¶ä¸”ä½¿ç”¨è¯¥æ–‡ä»¶è°ƒé…æ›¿æ¢çš„ä¸»æœºã€‚  \n  - ğŸ³ è¿™ç§æ–¹å¼ä¸å®¹å™¨ç®¡ç†ç›¸ä¼¼ï¼šå®¹å™¨é•œåƒä¸å¯è¢«åŸåœ°æ›´æ–°ï¼Œè€Œæ˜¯é‡å¤´æ„å»ºä¸é‡æ–°éƒ¨ç½²ã€‚è¯¥æ–¹å¼åœ¨è´Ÿè½½å¢åŠ æ—¶å®¹æ˜“æ¨ªå‘æ‰©å®¹ã€‚åªéœ€ç®€å•åœ°ä½¿ç”¨ç›¸åŒçš„ Ignition é…ç½®æ–‡ä»¶æ¥å¯åŠ¨å…¶ä»–ä¸»æœºã€‚\n- [FCOS å‘å¸ƒç‰ˆæœ¬](https://getfedora.org/en/coreos/download?tab=metal_virtualized&stream=stable&arch=x86_64)ï¼š![fedora-coreos-release-version.png](fedora-coreos-release-version.png)  \n  - `testing stream`ï¼š    \n    å½“å‰ Fedora å‘è¡Œç‰ˆçš„å¸¸è§„å¿«ç…§ï¼ŒåŠ ä¸Šæ›´æ–°ã€‚  \n  - â¤ `stable stream`ï¼š    \n    åœ¨æµ‹è¯•ç‰ˆæœ¬å¯ç”¨ä¸¤å‘¨åï¼Œå®ƒè¢«å‘é€åˆ°ç¨³å®šæµï¼Œåœ¨æµ‹è¯•ä¸­å‘ç°çš„ `bug` å°†åœ¨å‘å¸ƒç¨³å®šæµä¹‹å‰è¢«ä¿®å¤ã€‚  \n  - `next stream`ï¼š    \n    å³å°†å‘å¸ƒçš„ Fedora ç‰ˆæœ¬çš„å¸¸è§„å¿«ç…§ï¼Œå…è®¸æœ‰é¢å¤–çš„æ—¶é—´æµ‹è¯•è¾ƒå¤§çš„æ›´æ”¹ã€‚  \n  ğŸ‘‰ æ¯ä¸ª stream æ¯ 2 å‘¨å‘å¸ƒä¸€æ¬¡ï¼Œæ›´æ–°å†…å®¹ä¼šä»ä¸€ä¸ª stream æ¨å¹¿åˆ°å¦ä¸€ä¸ª streamï¼ˆ`next -> testing -> stable`ï¼‰ã€‚è¿™æ ·è½åœ°åœ¨ stable stream ä¸­çš„æ›´æ–°å°±æœ‰æœºä¼šç»è¿‡é•¿æ—¶é—´çš„æµ‹è¯•ã€‚  \n  ğŸ‘‰ æ‰€æœ‰ä¸‰ä¸ª stream éƒ½æ”¶åˆ°äº†å®‰å…¨æ›´æ–°å’Œå…³é”®çš„é”™è¯¯ä¿®å¤ï¼Œå¹¶æ—¨åœ¨å®‰å…¨åœ°ç”¨äºç”Ÿäº§ä½¿ç”¨ã€‚å¤§å¤šæ•°æœºå™¨åº”è¯¥è¿è¡Œ `stable stream`ï¼Œå› ä¸ºå®ƒæ¥å—æœ€å¤šçš„æµ‹è¯•ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·åº”è¯¥åœ¨ next stream ä¸Šè¿è¡Œä»–ä»¬çš„éƒ¨åˆ†èŠ‚ç‚¹ï¼Œå¹¶å‘é—®é¢˜è·Ÿè¸ªå™¨æŠ¥å‘Šé—®é¢˜ã€‚è¿™æœ‰åŠ©äºç¡®ä¿åªå½±å“ç‰¹å®šå·¥ä½œè´Ÿè½½æˆ–ç‰¹å®šç¡¬ä»¶çš„ bug åœ¨ç¨³å®šä¹‹å‰å¾—åˆ°ä¿®å¤ã€‚\n- RHCOS çš„å…³é”®ç‰¹æ€§ï¼š  \n  - ç³»ç»ŸåŸºäº RHEL å¼€å‘  \n  - å¯æ§åˆ¶çš„ä¸å¯å˜æ¶æ„ï¼ˆ`controlled immutability`ï¼‰  \n  - é»˜è®¤ä½¿ç”¨ `CRI-O` å®¹å™¨è¿è¡Œæ—¶  \n  - å¯ä½¿ç”¨å®¹å™¨å·¥å…·é›†ç®¡ç†å®¹å™¨æˆ– Podï¼ˆåŒ…æ‹¬ `podman`ã€`skopeo` ä¸ `crictl` ç­‰ï¼‰  \n  - ğŸ”¥ ä½¿ç”¨ `rpm-ostree` å®ç°äº‹åŠ¡æ€§æ›´æ–°å‡çº§ \n  > â— æ³¨æ„ï¼š\n  > \n  > 1. `OSTree` æ˜¯ä¸€ä¸ªç”¨äºå¯¹åŸºäº Linux çš„æ“ä½œç³»ç»Ÿè¿›è¡Œç‰ˆæœ¬æ›´æ–°çš„ç³»ç»Ÿï¼Œå®ƒå¯ä»¥è¢«è§†ä¸º \"é¢å‘æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶çš„ git\"ï¼Œå®ƒè¢« endless OSã€Flatpakã€Fedoraã€CentOSã€Atomic Host å’Œ GNOME ç­‰é¡¹ç›®ç”¨æ¥æŒç»­äº¤ä»˜ï¼Œæœ‰å…³ OSTree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ [libostree å®˜æ–¹æ–‡æ¡£](https://ostreedev.github.io/ostree/)ã€‚\n  > \n  > 2. rpm-ostree æ˜¯ä¸€ä¸ªæ··åˆé•œåƒ/åŒ…ç³»ç»Ÿï¼Œä»¥å‘½ä»¤è¡Œä¸å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯å°†è½¯ä»¶åŒ…ä»¥åˆ†å±‚çš„å½¢å¼æ„å»ºåœ¨ OSTree ä¹‹ä¸Šï¼Œå°†è½¯ä»¶åŒ…ä½œä¸ºç³»ç»Ÿçš„æ‰©å±•ï¼Œå…³äº rpm-ostree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ [rpm-ostree å®˜æ–¹æ–‡æ¡£](https://coreos.github.io/rpm-ostree)ã€‚\n  > \n  > 3. FCOS ä¸­çš„ `zincati` æœåŠ¡ï¼ˆ`zincati.service`ï¼‰å¯æ£€æµ‹ç³»ç»Ÿçš„çŠ¶æ€ï¼Œé€šè¿‡ `rpm-ostreed` å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œæ›´æ–°ï¼Œè‹¥å…¶å‘ç°å…·æœ‰æ–°çš„ç³»ç»Ÿæ›´æ–°å°†è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼Œå¯å°†è¯¥æœåŠ¡å…³é—­ä»¥ç¦ç”¨æ­¤åŠŸèƒ½ã€‚  \n  - ğŸ”¥ é’ˆå¯¹ `fireware` ä¸ `bootloader` çš„ `bootupd` æ›´æ–°å™¨ï¼Œbootupd å¯ä»¥å®ˆæŠ¤è¿›ç¨‹ `bootupd.service` çš„æ–¹å¼è¿è¡Œã€‚\n  - OpenShift 4 é›†ç¾¤é€šè¿‡ `Machine Config Operator (MCO)` æ›´æ–° RHCOS\n\n### Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\n- Ignition æ˜¯ç”± FCOS/RHCOS ä½¿ç”¨çš„åœ¨ç³»ç»Ÿåˆå§‹åŒ–é…ç½®è¿‡ç¨‹ï¼ˆ`initramfs`ï¼‰ä¸­æ“çºµç£ç›˜çš„å·¥å…·ï¼Œå…¶å¯å®Œæˆå¸¸è§çš„ç£ç›˜ä»»åŠ¡ï¼ŒåŒ…æ‹¬ç£ç›˜åˆ†åŒºã€æ ¼å¼åŒ–åˆ†åŒºã€å†™æ–‡ä»¶ä¸é…ç½®ç”¨æˆ·ç­‰ã€‚\n- åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶ï¼ˆfirst bootï¼‰ï¼ŒIgnition è¯»å–å®‰è£…ä»‹è´¨æˆ–æ‰€æŒ‡å®šçš„ Ignition é…ç½®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ã€‚\n- âœ¨ Ignition çš„è°ƒé…æ–¹å¼ï¼š  \n  Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition config fileï¼‰æˆ–ç§°ç‚¹ç«é…ç½®æ–‡ä»¶\n- Ignition é…ç½®ä¸ `cloud-init` æˆ– `Linux Anaconda kickstart` é…ç½®ç³»ç»Ÿæå…¶ç›¸ä¼¼ï¼Œä½†å…¶å…·æœ‰è‡ªèº«çš„ç‰¹ç‚¹ï¼š  \n  - ç”±äº Ignition èƒ½è¿›è¡Œç£ç›˜åˆ†åŒºã€è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸æ‰§è¡Œä¸»æœºæ°¸ä¹…æ–‡ä»¶ç³»ç»Ÿçš„å…¶ä»–æ”¹å˜ï¼Œå› æ­¤ï¼Œåœ¨å®‰è£… FCOS/RHCOS è¿‡ç¨‹ä¸­ Ignition è¿è¡Œäºä¸ç³»ç»Ÿç›¸éš”ç¦»çš„ `initial RAM disk` ä¸­ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œcloud-init ä½œä¸ºåˆå§‹åŒ–ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ä¸èƒ½å®¹æ˜“åœ°å®ç°ç£ç›˜çš„åˆ†åŒºã€‚  \n  - âœ¨ Ignition ä¸ cloud-init å¯¹æ¯”ï¼š\n    - Ignitionï¼š\n      - å·¥ä½œé˜¶æ®µï¼šé¦–æ¬¡å¼•å¯¼å®‰è£…æœŸé—´\n      - å·¥ä½œæ¬¡æ•°ï¼šä¸€æ¬¡\n      - åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿç£ç›˜æ“ä½œç­‰\n      - å¸¸ç”¨åœºæ™¯ï¼šå®‰è£…éƒ¨ç½²\n    - cloud-initï¼š\n      - å·¥ä½œé˜¶æ®µï¼šä»»æ„ç³»ç»Ÿå¼•å¯¼æœŸé—´\n      - å·¥ä½œæ¬¡æ•°ï¼šå¤šæ¬¡\n      - åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿé…ç½®ç­‰\n      - å¸¸ç”¨åœºæ™¯ï¼šç³»ç»Ÿé…ç½®\n  - Ignition ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿè€Œä¸æ˜¯æ›´æ”¹å·²å­˜åœ¨çš„ç³»ç»Ÿï¼ŒOpenShift 4 ä½¿ç”¨ `Machine Config Operator` å®Œæˆæ‰€æœ‰ä¸»æœºçš„é…ç½®ã€‚  \n  - Ignition ä»¥å£°æ˜å¼æ–¹å¼ï¼ˆdeclarative configurationï¼‰æ£€æŸ¥é…ç½®ä¸­çš„æ‰€æœ‰é…ç½®é¡¹ç›®ä»¥æ»¡è¶³æŒ‡å®šçš„è¦æ±‚ã€‚  \n  - âœ¨ åœ¨ Ignition å®Œæˆä¸»æœºé…ç½®åï¼Œkernel ä¿æŒè¿è¡Œä½†ä¸¢å¼ƒ initial RAM diskï¼Œå¹¶ä¸”è½¬å‘ï¼ˆpivot toï¼‰ç£ç›˜ä¸Šå·²å®‰è£…çš„ç³»ç»Ÿä¸­ã€‚æ— éœ€ç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ä¸å…¶ä»–ç‰¹æ€§å³å¯å¯åŠ¨ã€‚  \n  - ç”±äº Ignition é€šè¿‡å£°æ˜å¼é…ç½®å°†ä¸»æœºè°ƒæ•´ä¸ºæŒ‡å®šçš„çŠ¶æ€ï¼Œå› æ­¤ä¸èƒ½å­˜åœ¨å…·æœ‰éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè‹¥åœ¨éƒ¨ç½² OpenShift 4 é›†ç¾¤æ—¶å­˜åœ¨éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè¯¥ä¸»æœºå°†æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œéœ€æ›´æ¢æ–°çš„ä¸»æœºå†æ¬¡è°ƒé…åŠ å…¥é›†ç¾¤ã€‚  \n  - è‹¥å­˜åœ¨é—®é¢˜çš„ Ignition é…ç½®å¼•èµ·ä¸»æœºé…ç½®çš„å¤±è´¥ï¼ŒIgnition å°†ä¸å†å°è¯•ä½¿ç”¨ç›¸åŒçš„é…ç½®æ¥è°ƒé…å¦ä¸€å°ä¸»æœºã€‚  \n  - ç”±äº Ignition å¯ä½¿ç”¨å®Œæ•´çš„ç©ºç£ç›˜ï¼Œå®ƒèƒ½å®ç° cloud-init æ— æ³•å®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚ä½¿ç”¨ PXE å¼•å¯¼ä»ç©ºç£ç›˜è°ƒé…è£¸æœºç³»ç»Ÿã€‚\n\n### Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\n- åœ¨ OpenShift 4 é›†ç¾¤ä¸­çš„ RHCOS ä¸»æœºä¸Š Ignition çš„å¤„ç†æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š  \n  - 1ï¸âƒ£ æ§åˆ¶å¹³é¢ä¸»æœºï¼ˆ`control plane machines`ï¼‰ä»å¼•å¯¼ä¸»æœºï¼ˆ`bootstrap machine`ï¼‰è·å– Ignition é…ç½®æ–‡ä»¶ï¼Œè€Œå·¥ä½œä¸»æœºï¼ˆ`worker machines`ï¼‰ä»æ§åˆ¶å¹³é¢ä¸»æœºè·å– Ignition é…ç½®æ–‡ä»¶ã€‚  \n  - 2ï¸âƒ£ Ignition åœ¨ä¸»æœºä¸Šåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç›®å½•ä¸é“¾æ¥ï¼Œå®ƒæ”¯æŒ RAID é˜µåˆ—ä½†ä¸æ”¯æŒ LVM é€»è¾‘å·ã€‚  \n  - 3ï¸âƒ£ Igition åœ¨ initramfs ä¸­æŒ‚è½½ root æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿäº `/sysroot` ç›®å½•å¹¶åœ¨ `/sysroot` ç›®å½•ä¸­å·¥ä½œã€‚  \n  - 4ï¸âƒ£ Ignition é…ç½®æ‰€æœ‰å®šä¹‰çš„æ–‡ä»¶ç³»ç»Ÿå¹¶æ°å½“åœ°æŒ‚è½½å®ƒä»¬ã€‚  \n  - 5ï¸âƒ£ Ignition è¿è¡Œ `systemd` ä¸´æ—¶æ–‡ä»¶ä»¥å¡«å……åœ¨ `/var` ç›®å½•ä¸­çš„æ‰€éœ€æ–‡ä»¶ã€‚  \n  - 6ï¸âƒ£ Ignition è¿è¡Œå…¶é…ç½®æ–‡ä»¶æ¥é…ç½®ç”¨æˆ·ã€systemd å•å…ƒæ–‡ä»¶ä¸å…¶ä»–é…ç½®æ–‡ä»¶ã€‚  \n  - 7ï¸âƒ£ Ignition å¸è½½åœ¨ initramfs ä¸­æŒ‚è½½çš„æŒä¹…åŒ–ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç»„ä»¶ã€‚  \n  - 8ï¸âƒ£ Ignition å¯åŠ¨æ–°ä¸»æœºçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯åŠ¨ç³»ç»Ÿå¼•å¯¼é˜¶æ®µçš„æ‰€æœ‰å…¶ä»–çš„æœåŠ¡ã€‚\n- å¤„ç†ç»“æŸåï¼Œä¸»æœºå·²åšå¥½åŠ å…¥é›†ç¾¤çš„å‡†å¤‡å¹¶ä¸”æ— éœ€é‡å¯ï¼Œä¸å‰æ–‡æ‰€è¿°ç›¸åŒã€‚\n\n### Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\n- FCOS æ”¯æŒåœ¨å¤šç§ IaaS ç¯å¢ƒä¸‹è¿è¡Œã€‚\n- Fedora CoreOS live ISO ç‰ˆæœ¬ï¼šfedora-coreos-36.20220906.3.2-live.x86_64.iso\n- Butane å·¥å…·ï¼š  \n  - linux ç‰ˆæœ¬ï¼š[0.15.0](https://github.com/coreos/butane/releases/download/v0.15.0/butane-x86_64-unknown-linux-gnu)  \n  - è¯¥å·¥å…·æ¥æºäº [coreos/butane](https://github.com/coreos/butane) é¡¹ç›®  \n  - `Butane` ä»¥å‰ç§°ä¸º Fedora CoreOS é…ç½®è½¬æ¢å™¨ï¼ˆFedora CoreOS Config Transpilerï¼Œ`FCCT`ï¼‰ï¼Œå®ƒå¯å°† Butane é…ç½®æ–‡ä»¶ï¼ˆButane Configï¼‰æˆ–ç§° FCC æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition Configï¼‰ï¼Œè¯¥æ–‡ä»¶ä¸º `JSON` æ ¼å¼å°†è¢« FCOS ä¸»æœºåœ¨é¦–æ¬¡å¼•å¯¼è°ƒé…æ—¶ä½¿ç”¨ï¼Œå¯ç”¨äºåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  \n  - âœ¨ å…¶ä¸­ Butane é…ç½®æ–‡ä»¶ä¸º `YAML` æ ¼å¼ï¼Œå…³äºè¯¥æ–‡ä»¶ä¸åŒç‰ˆæœ¬çš„é…ç½®è§„èŒƒï¼ˆconfiguration specificationsï¼‰è¯·å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/coreos/butane/blob/main/docs/specs.md)ã€‚  \n  - âœ¨ Butane é…ç½®æ–‡ä»¶ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒè¯¥ [Examples](https://github.com/coreos/butane/blob/main/docs/examples.md)ã€‚  \n  - å¯åœ¨è‡ªå·±æŒ‡å®šçš„èŠ‚ç‚¹ï¼ˆé FCOS ä¸»æœºï¼‰ä¸Šå®‰è£… butaneï¼Œå®‰è£…æ–¹å¼åŒ…æ‹¬ butane å®¹å™¨é•œåƒï¼ˆ`quay.io/coreos/butane:release`ï¼‰ã€rpm è½¯ä»¶åŒ…æˆ–ç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆstandalone binaryï¼‰ï¼Œæ­¤å¤„ä½¿ç”¨ä»¥ä¸Šé“¾æ¥çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚![quay-coreos-butane-release.png](quay-coreos-butane-release.png)  \n  - butane çš„ä½¿ç”¨æ–¹æ³•å¯å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/coreos/butane/blob/main/docs/getting-started.md)ã€‚\n- ignition-validate å·¥å…·ï¼š  \n  - linux ç‰ˆæœ¬ï¼š[2.14.0](https://github.com/coreos/ignition/releases/download/v2.14.0/ignition-validate-x86_64-linux)  \n  - è¯¥å·¥å…·æ¥æºäº [coreos/ignition](https://github.com/coreos/ignition) é¡¹ç›®  \n  - è¯¥å·¥å…·ç”¨äºå¯¹ Ignition é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸åˆæ³•æ€§å­—æ®µçš„éªŒè¯ï¼Œè‹¥è¯­æ³•ä¸åˆè§„å°†æ— æ³•åœ¨ FCOS ä¸­ä½¿ç”¨ `coreos-installer` äºç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶å®‰è£…ã€‚\n\n### Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\n- å‡†å¤‡ HTTP æœåŠ¡å™¨ã€Ignition é…ç½®æ–‡ä»¶ä¸ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆé FCOS èŠ‚ç‚¹ï¼‰ï¼š  \n  > â— æ³¨æ„ï¼š\n  > \n  > 1. æœ¬æ–‡å®‰è£…é‡‡ç”¨åŸºäº KVM è™šæ‹Ÿæœºæ¨¡æ‹Ÿè£¸é‡‘å±å®‰è£…ç¯å¢ƒã€‚\n  > \n  > 2. å…³äº `butane` å·¥å…·ä¸ `ignition-validate` å·¥å…·çš„å®‰è£…å¦‚å‰æ–‡æ‰€è¿°ã€‚\n  > \n  > 3. ğŸ’â€â™‚ï¸ æœ¬æ–‡ä½¿ç”¨ FCOS live ISO çš„æ–¹å¼å¼•å¯¼å¹¶ä½¿ç”¨å…¶ä¸­çš„ coreos-installer å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼Œè‹¥ä½¿ç”¨ PXE æ–¹å¼å¼•å¯¼å®‰è£…è¯·å‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚\n    \n  ```bash\n  $ sudo yum install httpd\n  $ sudo systemctl enable --now httpd.service\n  # å®‰è£…ä¸å¯åŠ¨ httpd æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯\n  $ ssh-keygen -N '' -t rsa -f ~/.ssh/core_fcos_login\n  # åˆ›å»ºç”¨äº SSH å…å¯†ç™»å½• FCOS çš„å…¬ç§é’¥ï¼Œæ­¤å¤„å°†è¯¥ SSH å…¬é’¥æ‹·è´è‡³ Butane é…ç½®æ–‡ä»¶\n  # çš„ ssh_authorized_keys å­—æ®µä¸­ã€‚\n  $ mkdir ~/fcos && cd ~/fcos\n  $ vim fcos-customized-config.yml\n  # åˆ›å»º Butane é…ç½®æ–‡ä»¶\n  ```\n  è¯¥é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n  ```yaml\n  # è¯¥é…ç½®æ–‡ä»¶å¯å‚çœ‹å‰æ–‡ GitHub Butane çš„ Examples æˆ– Fedora CoreOS å®˜æ–¹æ–‡æ¡£\n  # çš„ Storage éƒ¨åˆ†è¿›è¡Œç¼–è¾‘ã€‚\n  variant: fcos\n  version: 1.1.0\n  # åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·ã€å¯†ç ã€home å®¶ç›®å½•ä¸é…ç½® SSH å…å¯†ç™»å½•çš„å…¬é’¥\n  passwd:\n    users:\n      - name: core\n        ssh_authorized_keys:\n          - ssh-rsa AAAAB3Nz...jnXfG+Uj godev@cloud-ctl.domain12.example.com\n        # ç”±äº FCOS/RHCOS åœ¨å®‰è£…å®Œæˆåæ— æ³•ä½¿ç”¨å¯†ç ç›´æ¥ç™»å½•ï¼Œè¯¥å…¬é’¥ç”¨äº core ç”¨æˆ·çš„\n        # SSH å…å¯†ç™»å½•ã€‚\n      - name: cloud-admin\n        password_hash: $y$j9T$j0ODWvNUDSXcEcwpDH141.$dvAEVxBHUWbW/NnPd90qkg0Haq6vgkcKF151jvLDgYA\n        # æ˜æ–‡å¯†ç  redhat é€šè¿‡ hash åŠ å¯†çš„å¯†æ–‡\n        # è™½ç„¶è¯¥ç”¨æˆ·å·²é…ç½®å¯†ç ï¼Œä½†æ— æ³•é€šè¿‡ SSH è¿œç¨‹ç™»å½•ï¼Œè¯¥å¯†ç åªå…è®¸æœ¬åœ°æ§åˆ¶å°ç™»å½•ã€‚\n        home_dir: /opt/cloud-admin\n        no_create_home: false\n        groups:\n          - wheel\n        shell: /bin/bash\n        # æ³¨æ„ï¼šå½“ä»»ä½•ç”¨æˆ· SSH è¿œç¨‹ç™»å½•å¤±æ•ˆæ—¶ï¼Œå¯ç”¨è¯¥ç”¨æˆ·æœ¬åœ°ç™»å½•å¹¶ææƒï¼\n  storage:\n    # å°†æœ¬åœ°æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å†…å®¹æ³¨å…¥ FCOS çš„å¯¹åº”æ–‡ä»¶ä¸­ï¼Œéœ€ä½¿ç”¨ butane å·¥å…·çš„\n    # --files-dir é€‰é¡¹ã€‚\n    files:\n      - path: \"/etc/NetworkManager/system-connections/Wired connection 1.nmconnection\"\n        contents:\n          local: ./Wired_connection_1.nmconnection      \n        mode: 0600\n        # FCOS çš„ç½‘ç»œæ¥å£é…ç½®\n      - path: /etc/hostname\n        contents:\n          local: ./hostname\n        mode: 0644\n        # FCOS çš„ä¸»æœºåé…ç½®\n    # å°† FCOS çš„ /dev/vdb è¿›è¡Œåˆ†åŒºå¹¶æŒ‚è½½è‡³ /var ç›®å½•ï¼Œä¸»è¦ç”¨äºå®¹å™¨ä¸é•œåƒçš„å­˜å‚¨ã€‚\n    # æ³¨æ„ï¼šIgnition ä¸æ”¯æŒå¯¹ FCOS/RHCOS çš„ LVM é€»è¾‘å·åŠŸèƒ½ï¼\n    disks:\n      - device: /dev/vdb\n        wipe_table: true\n        partitions:\n          - number: 1\n            label: var\n    filesystems:\n      - path: /var\n        device: /dev/disk/by-partlabel/var\n        format: xfs\n        wipe_filesystem: true \n        label: var\n        with_mount_unit: true\n  ```\n  ä»¥ä¸Š YAML æ–‡ä»¶å¯ç‚¹å‡» [æ­¤å¤„](https://github.com/Alberthua-Perl/scripts-confs/tree/master/fedora-coreos-36) è·å¾—ã€‚ \n  ```bash\n  $ cat ./hostname\n    fcos36-cloud.lab.example.com\n  $ cat ./Wired_connection_1.nmconnection \n    [connection]\n    id=Wired connection 1\n    type=ethernet\n    autoconnect-priority=-999\n    interface-name=ens3\n  \n    [ethernet]\n  \n    [ipv4]\n    address1=192.168.110.13/24,192.168.110.1\n    dns=192.168.110.1;\n    method=manual\n  \n  $ butane --files-dir . \\\n    --pretty --strict \\\n    --output fcos-customized-config.ign fcos-customized-config.yml\n  # åœ¨å½“å‰ç›®å½•ä¸­æ ¹æ® Butane é…ç½®æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶\n  $ ignition-validate fcos-customized-config.ign\n  # éªŒè¯ Ignition é…ç½®æ–‡ä»¶è¯­æ³•çš„åˆæ³•æ€§ï¼Œè‹¥æ— è¿”å›åˆ™éªŒè¯é€šè¿‡ï¼Œè¯¥æ–‡ä»¶å¯ç”¨äº FCOS çš„å®‰è£…ã€‚\n  $ sudo cp fcos-customized-config.ign /var/www/html/\n  # æ‹·è´è¯¥æ–‡ä»¶è‡³ HTTP æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸­ç”¨äº FCOS ä¸­ coreos-installer å·¥å…·çš„ä¸‹è½½\n  # è¯»å–ä¸ç³»ç»Ÿå®‰è£…ã€‚\n  ```\n- åˆ›å»º FCOS è™šæ‹Ÿæœºå¹¶ä½¿ç”¨ FCOS live ISO å¼•å¯¼å®‰è£…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![use-fedora-coreos-live-to-install.png](use-fedora-coreos-live-to-install.png)![login-fedora-coreos-live.png](login-fedora-coreos-live.png)\n  ğŸ‘‰ `core` ç”¨æˆ·å¯ `sudo` å…å¯†ææƒä¸º root ç”¨æˆ·ã€‚  \n  ğŸ‘‰ ä½¿ç”¨ `core` ç”¨æˆ·æ­£å¸¸ç™»å½•åï¼Œå†ä½¿ç”¨ `ip -br a s` å‘½ä»¤æŸ¥çœ‹ä¸»æœºçš„ IP åœ°å€ï¼ˆä¸€èˆ¬å¯é€šè¿‡ `DHCP` è‡ªåŠ¨è·å–ï¼‰ï¼Œè‹¥æ— ä¸ HTTP æœåŠ¡å™¨é€šä¿¡çš„ IP åœ°å€ï¼Œå°†æ— æ³•ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶è€Œå®‰è£…å¤±è´¥ï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤ä¸´æ—¶é…ç½®åŠ ä»¥ç”Ÿæ•ˆï¼š  \n  ```bash\n  $ sudo ip address add 192.168.110.13/24 dev ens3\n  # éœ€æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´ IP åœ°å€ä¸å¯¹åº”çš„ç½‘ç»œæ¥å£\n  ```\n  ğŸ‘‰ ä½¿ç”¨ FCOS live ISO è‡ªå¸¦çš„ `coreos-installer` å·¥å…·æ ¹æ® Ignition é…ç½®æ–‡ä»¶å®‰è£…éƒ¨ç½²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š \n  ![coreos-installer-customized-install.png](coreos-installer-customized-install.png)  \n  ```bash\n  $ sudo coreos-installer install \\\n    --insecure-ignition \\\n    --ignition-url http://192.168.110.130/fcos-customized-config.ign \\\n    /dev/vda\n  # ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶å¹¶å°†æ ¹ç³»ç»Ÿå®‰è£…äº /dev/vda ä¸­\n  # æ­¤å®‰è£…è¿‡ç¨‹æ ¹æ®æ‰€é…ç½®çš„å†…å®¹ä¸åŒè€—æ—¶ä¹Ÿå°†ä¸åŒï¼ˆç¬”è€…ç¯å¢ƒä¸­å®‰è£…è¾ƒå¿«ï¼‰\n  $ sudo reboot\n  # é‡å¯ç³»ç»Ÿ\n  ```\n- ç™»å½• FCOS éªŒè¯å®‰è£…çŠ¶æ€ï¼š  \n  ```bash\n  $ ssh -i ~/.ssh/core_fcos_login core@fcos36-cloud\n    Fedora CoreOS 36.20221001.3.0\n    Tracker: https://github.com/coreos/fedora-coreos-tracker\n    Discuss: https://discussion.fedoraproject.org/tag/coreos\n  \n    Last login: Mon Oct 24 14:07:00 2022 from 192.168.110.130\n    [core@fcos36-cloud ~]$ sudo -i\n    [root@fcos36-cloud ~]# id cloud-admin\n    uid=1001(cloud-admin) gid=1001(cloud-admin) groups=1001(cloud-admin),10(wheel)\n    [root@fcos36-cloud ~]# su - cloud-admin\n    [cloud-admin@fcos36-cloud ~]$ sudo -i\n    [sudo] password for cloud-admin: \n    [root@fcos36-cloud ~]# lsblk --paths\n    NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\n    /dev/sr0     11:0    1 1024M  0 rom  \n    /dev/vda    252:0    0   10G  0 disk \n    |-/dev/vda1 252:1    0    1M  0 part \n    |-/dev/vda2 252:2    0  127M  0 part \n    |-/dev/vda3 252:3    0  384M  0 part /boot\n    `-/dev/vda4 252:4    0  9.5G  0 part /sysroot/ostree/deploy/fedora-coreos/var\n                                         /usr\n                                         /etc\n                                         /\n                                         /sysroot\n    /dev/vdb    252:16   0   10G  0 disk \n    `-/dev/vdb1 252:17   0   10G  0 part /var \n  # Ignition é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®åœ¨ FCOS ä¸­å·²ç”Ÿæ•ˆ\n  ```\n- ç”±äº FCOS ä¸­ä½¿ç”¨ `rpm-ostree` è¿›è¡Œè½¯ä»¶åŒ…çš„ç®¡ç†ï¼Œè‹¥éœ€å®‰è£…é¢å¤–çš„è½¯ä»¶åŒ…ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š  \n  ```bash\n  $ sudo rpm-ostree install \\\n    podman skopeo buildah cri-o cri-tools vim-enhanced\n  # å®‰è£…å®¹å™¨ä¸é•œåƒç®¡ç†å·¥å…·\n  $ sudo systemctl status crio.service\n  # æŸ¥çœ‹ CRI-O å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ï¼Œå¯é€šè¿‡ crictl å‘½ä»¤æµ‹è¯•ç®¡ç†å®¹å™¨ã€‚\n  ```\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Introducing Fedora CoreOS](https://fedoramagazine.org/introducing-fedora-coreos/)\n- [Getting started with Fedora CoreOS](https://fedoramagazine.org/getting-started-with-fedora-coreos/)\n- [Fedora CoreOS å…¥é—¨ | Linux ä¸­å›½](https://mp.weixin.qq.com/s/Vf6TvGSi5sNnMjT5QldUQg)\n- â¤ [Fedora CoreOS Documentation](https://docs.fedoraproject.org/en-US/fedora-coreos/)\n- [Red Hat Enterprise Linux CoreOS (RHCOS)](https://docs.openshift.com/container-platform/4.11/architecture/architecture-rhcos.html)\n- â¤ [How to customize Fedora CoreOS for dedicated workloads with OSTree](https://developers.redhat.com/blog/2020/03/12/how-to-customize-fedora-coreos-for-dedicated-workloads-with-ostree#)","source":"_posts/fcos-rhcos-basic-usage.md","raw":"---\ntitle: ğŸ“¦ Fedora CoreOS åŠ RHCOS æ¦‚è¿°ä¸åº”ç”¨\nsubtitle: Fedora CoreOS & RHCOS Basic and Usage\nheader-img: fedora-coreos-bg.jpg\ndate: 2022-11-28 21:32:27\ntags:\n  - Linux\n  - coreos\n  - OpenShift\n---\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- å…³é”®æŠ€æœ¯ç‚¹\n- Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§\n- Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹\n- Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåº\n- Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜\n- Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯\n- å‚è€ƒé“¾æ¥\n\n### å…³é”®æŠ€æœ¯ç‚¹ï¼š\n- ä»¥ä¸‹æŠ€æœ¯ç‚¹åœ¨æ–‡ä¸­å°†æ ¹æ® Fedora CoreOS åŠ RHCOS ä¸­å±•å¼€è¯´æ˜ï¼š  \n  - ignition, butane, ignition-validate  \n  - ostree, rpm-tree,zincati, bootupd\n\n### Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§ï¼š\n- åœ¨ OpenShift 4 å®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨å®‰è£… CoreOS çš„å•†ä¸šç‰ˆ Red Hat Enterprise Linux CoreOSï¼ˆç®€ç§° `RHCOS`ï¼‰ã€‚æ ¹æ® OpenShift 4 çš„æ–‡æ¡£è¯´æ˜ï¼ŒRHCOS æ— æ³•ç‹¬ç«‹è¿è¡Œå®‰è£…ï¼Œå®ƒå¿…é¡»å’Œ OpenShift 4 ä¸€èµ·è¿è¡Œï¼ˆå› æ­¤ RHCOS æ²¡æœ‰å•ç‹¬çš„è®¢é˜…ï¼‰ã€‚\n- ğŸ˜ƒ ä¸è¿‡å¥½åœ¨ CoreOS è¿˜æä¾›äº†å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ç¤¾åŒºç‰ˆ `Fedora CoreOS`ï¼ˆç®€ç§° `FCOS`ï¼‰å¯ä»¥å®Œå…¨å…è´¹ä½¿ç”¨ã€‚ç”±äº FCOS å¯ä»¥æ— éœ€ OpenShift 4 ä¹Ÿå¯ä»¥ç‹¬ç«‹å®‰è£…è¿è¡Œï¼Œå› æ­¤ä½¿ç”¨ FCOS ä½œä¸ºç ”ç©¶ç¯å¢ƒï¼Œè€Œç›¸å…³æ“ä½œåŸºæœ¬éƒ½å¯é€‚ç”¨ RHCOS ç¯å¢ƒã€‚\n- FCOS/RHCOS æ˜¯ Red Hat åœ¨æ”¶è´­ CoreOS å…¬å¸åç»“åˆ `CoreOS Container Linux` å’Œ `Fedora Atomic Host` çš„ä¼˜ç‚¹æ¨å‡ºçš„æ–°ä¸€ä»£å®¹å™¨æ“ä½œç³»ç»Ÿï¼Œå…¶ç›®æ ‡æ˜¯æä¾›æœ€ä½³çš„å®¹å™¨ä¸»æœºï¼Œä»è€Œèƒ½å®‰å…¨ã€å¤§è§„æ¨¡åœ°è¿è¡Œå®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½ã€‚\n- FCOS/RHCOS å°† [Ignition](https://github.com/coreos/ignition)ï¼ˆç‚¹ç«ï¼‰ ä¸ rpm-ostree ç­‰æŠ€æœ¯ç›¸é›†æˆï¼Œæ˜¯ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°çš„ã€æœ€å°çš„ã€æ•´ä½“çš„ã€å¯¹è¿è¡Œå®¹å™¨å’Œ Kubernetes è¿›è¡Œäº†ä¼˜åŒ–çš„æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºå®ƒä»¬æ›´ç¬¦åˆ \"ä¸å¯å˜æ¶æ„\"ï¼ˆ`Immutable Infrastructure`ï¼‰ç†å¿µï¼Œå› æ­¤æˆä¸º Red Hat æ¨èçš„ OpenShift 4 åº•å±‚æ“ä½œç³»ç»Ÿã€‚\n- FCOS/RHCOS çš„å®‰è£…åŠé…ç½®è¿‡ç¨‹å’Œä¸€èˆ¬çš„ RHEL ç¨æœ‰å·®åˆ«ï¼Œéœ€è¦é€šè¿‡ Ignition é…ç½®æ–‡ä»¶åœ¨å®‰è£…çš„æ—¶å€™åˆå§‹åŒ–ç½‘ç»œã€å­˜å‚¨ã€å†…æ ¸ã€ç”¨æˆ·ç­‰æ–¹é¢çš„é…ç½®ã€‚\n- FCOS çš„è®¾è®¡ç†å¿µï¼š  \n  - ğŸ³ ç”±äºå®¹å™¨å…è®¸å°†å·¥ä½œè´Ÿè½½é‡å¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¹¶è‡ªåŠ¨æ‰©å±•ä»¥æ»¡è¶³éœ€æ±‚ã€‚å®¹å™¨æä¾›çš„éš”ç¦»æ„å‘³ç€ä¸»æœºæ“ä½œç³»ç»Ÿå¯ä»¥å¾ˆå°ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ª `Linux kernel`ã€`systemd`ã€`container runtime` å’Œä¸€äº›é™„åŠ æœåŠ¡ï¼ˆå¦‚ SSH æœåŠ¡å™¨ï¼‰ã€‚  \n  - FCOS æ˜¯ä¸“é—¨ä¸ºå®¹å™¨å·¥ä½œè´Ÿè½½è€Œè®¾è®¡çš„ï¼Œæ— éœ€å®šæœŸç»´æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨æœ€æ–°çš„æ“ä½œç³»ç»Ÿæ”¹è¿›ã€bug ä¿®å¤å’Œå®‰å…¨è‡ªåŠ¨æ›´æ–°ï¼Œå…¶ä½¿ç”¨ Ignition ä¸ºè‡ªèº«æä¾›æœåŠ¡ï¼Œä½¿ç”¨ `Podman` å’Œ `Moby` è¿è¡Œå®¹å™¨ï¼Œå¹¶ä½¿ç”¨ `rpm-ostree` è‡ªåŠ¨è¿›è¡ŒåŸå­æ›´æ–°ã€‚\n  > â— æ³¨æ„ï¼š\n  > \n  > 1. FCOS æ”¯æŒ `CRI-O` ä½œä¸ºå®¹å™¨å¼•æ“ï¼Œå¸¸ç”¨äº OpenShift 4 çš„åº•å±‚å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ CRI-O è¿è¡Œå®¹å™¨ï¼ŒOpenShift 4 å¯é€šè¿‡ `CRI` æ¥å£åˆ›å»ºä¸ç®¡ç† Podã€‚\n  > \n  > 2. å¯é€šè¿‡ `crictl` å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸ç®¡ç†å®¹å™¨åŠ Podï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹ç”¨äºå®¹å™¨æˆ– pod çš„è°ƒè¯•è€Œéå®¹å™¨æˆ– pod çš„åˆ›å»ºã€‚\n- FCOS è°ƒé…ä¸å¯å˜æ¶æ„ï¼š  \n  - åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼ï¼ˆ`first boot`ï¼‰é˜¶æ®µï¼ŒFCOS ä½¿ç”¨ Ignition è°ƒé…ç³»ç»Ÿã€‚  \n  - Ignition è¯»å–ç”¨æˆ·æä¾›çš„æ•°æ®æˆ–è¿œç¨‹ URL åœ°å€æä¾›çš„ Ignition é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨å®ƒåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  \n  - è°ƒé…ä¸»æœºçš„æ–¹å¼ï¼š    \n    - ç¼–è¾‘åŸºäº YAML æ ¼å¼çš„ `Fedora CoreOS Config`ï¼ˆFCCï¼‰æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šä¸»æœºçš„æœŸæœ›é…ç½®ï¼ŒFCC æ”¯æŒæ‰€æœ‰çš„ Ignition åŠŸèƒ½ï¼Œä¹Ÿæä¾›é¢å¤–çš„è¯­æ³•ã€‚    \n    - ä½¿ç”¨ `Fedora CoreOS Config Transpiler (Butane)` å·¥å…·å°† FCC æ–‡ä»¶ï¼ˆ`.fcc`ï¼‰è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆ`.ign`ï¼‰ã€‚    \n    - å¯åŠ¨ FCOS ä¸»æœºå¹¶å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä¸»æœºä¸­è°ƒé…ç³»ç»Ÿçš„å®‰è£…ã€‚    \n    > ğŸ’â€â™‚ï¸ è°ƒé…ä¸»æœºçš„æ–¹æ³•ï¼š\n    > \n    > 1. ä½¿ç”¨ PXE å¼•å¯¼å¹¶ä¸æŒ‡å®š Ignition é…ç½®æ–‡ä»¶è°ƒé…å®‰è£…ä¸»æœºã€‚\n    > \n    > 2. å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä½¿ç”¨ FCOS live ISO å¼•å¯¼å¯åŠ¨çš„ä¸»æœºä¸­ï¼Œå†ä½¿ç”¨ `coreos-installer` å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼ˆæœ¬æ–‡ä½¿ç”¨æ­¤æ–¹æ³•ï¼‰ã€‚  \n  - FCOS è¢«è®¾è®¡ä¸ºä¸å¯å˜æ¶æ„ã€‚åœ¨ä¸»æœºè¢«è°ƒé…ä¹‹åï¼Œä¸åº”è¯¥æ›´æ”¹ /etc ç›®å½•æˆ–é‡æ–°é…ç½®ä¸»æœºï¼Œç›¸åï¼Œæ›´æ”¹ FCC æ–‡ä»¶å¹¶ä¸”ä½¿ç”¨è¯¥æ–‡ä»¶è°ƒé…æ›¿æ¢çš„ä¸»æœºã€‚  \n  - ğŸ³ è¿™ç§æ–¹å¼ä¸å®¹å™¨ç®¡ç†ç›¸ä¼¼ï¼šå®¹å™¨é•œåƒä¸å¯è¢«åŸåœ°æ›´æ–°ï¼Œè€Œæ˜¯é‡å¤´æ„å»ºä¸é‡æ–°éƒ¨ç½²ã€‚è¯¥æ–¹å¼åœ¨è´Ÿè½½å¢åŠ æ—¶å®¹æ˜“æ¨ªå‘æ‰©å®¹ã€‚åªéœ€ç®€å•åœ°ä½¿ç”¨ç›¸åŒçš„ Ignition é…ç½®æ–‡ä»¶æ¥å¯åŠ¨å…¶ä»–ä¸»æœºã€‚\n- [FCOS å‘å¸ƒç‰ˆæœ¬](https://getfedora.org/en/coreos/download?tab=metal_virtualized&stream=stable&arch=x86_64)ï¼š![fedora-coreos-release-version.png](fedora-coreos-release-version.png)  \n  - `testing stream`ï¼š    \n    å½“å‰ Fedora å‘è¡Œç‰ˆçš„å¸¸è§„å¿«ç…§ï¼ŒåŠ ä¸Šæ›´æ–°ã€‚  \n  - â¤ `stable stream`ï¼š    \n    åœ¨æµ‹è¯•ç‰ˆæœ¬å¯ç”¨ä¸¤å‘¨åï¼Œå®ƒè¢«å‘é€åˆ°ç¨³å®šæµï¼Œåœ¨æµ‹è¯•ä¸­å‘ç°çš„ `bug` å°†åœ¨å‘å¸ƒç¨³å®šæµä¹‹å‰è¢«ä¿®å¤ã€‚  \n  - `next stream`ï¼š    \n    å³å°†å‘å¸ƒçš„ Fedora ç‰ˆæœ¬çš„å¸¸è§„å¿«ç…§ï¼Œå…è®¸æœ‰é¢å¤–çš„æ—¶é—´æµ‹è¯•è¾ƒå¤§çš„æ›´æ”¹ã€‚  \n  ğŸ‘‰ æ¯ä¸ª stream æ¯ 2 å‘¨å‘å¸ƒä¸€æ¬¡ï¼Œæ›´æ–°å†…å®¹ä¼šä»ä¸€ä¸ª stream æ¨å¹¿åˆ°å¦ä¸€ä¸ª streamï¼ˆ`next -> testing -> stable`ï¼‰ã€‚è¿™æ ·è½åœ°åœ¨ stable stream ä¸­çš„æ›´æ–°å°±æœ‰æœºä¼šç»è¿‡é•¿æ—¶é—´çš„æµ‹è¯•ã€‚  \n  ğŸ‘‰ æ‰€æœ‰ä¸‰ä¸ª stream éƒ½æ”¶åˆ°äº†å®‰å…¨æ›´æ–°å’Œå…³é”®çš„é”™è¯¯ä¿®å¤ï¼Œå¹¶æ—¨åœ¨å®‰å…¨åœ°ç”¨äºç”Ÿäº§ä½¿ç”¨ã€‚å¤§å¤šæ•°æœºå™¨åº”è¯¥è¿è¡Œ `stable stream`ï¼Œå› ä¸ºå®ƒæ¥å—æœ€å¤šçš„æµ‹è¯•ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·åº”è¯¥åœ¨ next stream ä¸Šè¿è¡Œä»–ä»¬çš„éƒ¨åˆ†èŠ‚ç‚¹ï¼Œå¹¶å‘é—®é¢˜è·Ÿè¸ªå™¨æŠ¥å‘Šé—®é¢˜ã€‚è¿™æœ‰åŠ©äºç¡®ä¿åªå½±å“ç‰¹å®šå·¥ä½œè´Ÿè½½æˆ–ç‰¹å®šç¡¬ä»¶çš„ bug åœ¨ç¨³å®šä¹‹å‰å¾—åˆ°ä¿®å¤ã€‚\n- RHCOS çš„å…³é”®ç‰¹æ€§ï¼š  \n  - ç³»ç»ŸåŸºäº RHEL å¼€å‘  \n  - å¯æ§åˆ¶çš„ä¸å¯å˜æ¶æ„ï¼ˆ`controlled immutability`ï¼‰  \n  - é»˜è®¤ä½¿ç”¨ `CRI-O` å®¹å™¨è¿è¡Œæ—¶  \n  - å¯ä½¿ç”¨å®¹å™¨å·¥å…·é›†ç®¡ç†å®¹å™¨æˆ– Podï¼ˆåŒ…æ‹¬ `podman`ã€`skopeo` ä¸ `crictl` ç­‰ï¼‰  \n  - ğŸ”¥ ä½¿ç”¨ `rpm-ostree` å®ç°äº‹åŠ¡æ€§æ›´æ–°å‡çº§ \n  > â— æ³¨æ„ï¼š\n  > \n  > 1. `OSTree` æ˜¯ä¸€ä¸ªç”¨äºå¯¹åŸºäº Linux çš„æ“ä½œç³»ç»Ÿè¿›è¡Œç‰ˆæœ¬æ›´æ–°çš„ç³»ç»Ÿï¼Œå®ƒå¯ä»¥è¢«è§†ä¸º \"é¢å‘æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶çš„ git\"ï¼Œå®ƒè¢« endless OSã€Flatpakã€Fedoraã€CentOSã€Atomic Host å’Œ GNOME ç­‰é¡¹ç›®ç”¨æ¥æŒç»­äº¤ä»˜ï¼Œæœ‰å…³ OSTree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ [libostree å®˜æ–¹æ–‡æ¡£](https://ostreedev.github.io/ostree/)ã€‚\n  > \n  > 2. rpm-ostree æ˜¯ä¸€ä¸ªæ··åˆé•œåƒ/åŒ…ç³»ç»Ÿï¼Œä»¥å‘½ä»¤è¡Œä¸å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯å°†è½¯ä»¶åŒ…ä»¥åˆ†å±‚çš„å½¢å¼æ„å»ºåœ¨ OSTree ä¹‹ä¸Šï¼Œå°†è½¯ä»¶åŒ…ä½œä¸ºç³»ç»Ÿçš„æ‰©å±•ï¼Œå…³äº rpm-ostree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ [rpm-ostree å®˜æ–¹æ–‡æ¡£](https://coreos.github.io/rpm-ostree)ã€‚\n  > \n  > 3. FCOS ä¸­çš„ `zincati` æœåŠ¡ï¼ˆ`zincati.service`ï¼‰å¯æ£€æµ‹ç³»ç»Ÿçš„çŠ¶æ€ï¼Œé€šè¿‡ `rpm-ostreed` å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œæ›´æ–°ï¼Œè‹¥å…¶å‘ç°å…·æœ‰æ–°çš„ç³»ç»Ÿæ›´æ–°å°†è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼Œå¯å°†è¯¥æœåŠ¡å…³é—­ä»¥ç¦ç”¨æ­¤åŠŸèƒ½ã€‚  \n  - ğŸ”¥ é’ˆå¯¹ `fireware` ä¸ `bootloader` çš„ `bootupd` æ›´æ–°å™¨ï¼Œbootupd å¯ä»¥å®ˆæŠ¤è¿›ç¨‹ `bootupd.service` çš„æ–¹å¼è¿è¡Œã€‚\n  - OpenShift 4 é›†ç¾¤é€šè¿‡ `Machine Config Operator (MCO)` æ›´æ–° RHCOS\n\n### Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\n- Ignition æ˜¯ç”± FCOS/RHCOS ä½¿ç”¨çš„åœ¨ç³»ç»Ÿåˆå§‹åŒ–é…ç½®è¿‡ç¨‹ï¼ˆ`initramfs`ï¼‰ä¸­æ“çºµç£ç›˜çš„å·¥å…·ï¼Œå…¶å¯å®Œæˆå¸¸è§çš„ç£ç›˜ä»»åŠ¡ï¼ŒåŒ…æ‹¬ç£ç›˜åˆ†åŒºã€æ ¼å¼åŒ–åˆ†åŒºã€å†™æ–‡ä»¶ä¸é…ç½®ç”¨æˆ·ç­‰ã€‚\n- åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶ï¼ˆfirst bootï¼‰ï¼ŒIgnition è¯»å–å®‰è£…ä»‹è´¨æˆ–æ‰€æŒ‡å®šçš„ Ignition é…ç½®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ã€‚\n- âœ¨ Ignition çš„è°ƒé…æ–¹å¼ï¼š  \n  Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition config fileï¼‰æˆ–ç§°ç‚¹ç«é…ç½®æ–‡ä»¶\n- Ignition é…ç½®ä¸ `cloud-init` æˆ– `Linux Anaconda kickstart` é…ç½®ç³»ç»Ÿæå…¶ç›¸ä¼¼ï¼Œä½†å…¶å…·æœ‰è‡ªèº«çš„ç‰¹ç‚¹ï¼š  \n  - ç”±äº Ignition èƒ½è¿›è¡Œç£ç›˜åˆ†åŒºã€è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸æ‰§è¡Œä¸»æœºæ°¸ä¹…æ–‡ä»¶ç³»ç»Ÿçš„å…¶ä»–æ”¹å˜ï¼Œå› æ­¤ï¼Œåœ¨å®‰è£… FCOS/RHCOS è¿‡ç¨‹ä¸­ Ignition è¿è¡Œäºä¸ç³»ç»Ÿç›¸éš”ç¦»çš„ `initial RAM disk` ä¸­ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œcloud-init ä½œä¸ºåˆå§‹åŒ–ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ä¸èƒ½å®¹æ˜“åœ°å®ç°ç£ç›˜çš„åˆ†åŒºã€‚  \n  - âœ¨ Ignition ä¸ cloud-init å¯¹æ¯”ï¼š\n    - Ignitionï¼š\n      - å·¥ä½œé˜¶æ®µï¼šé¦–æ¬¡å¼•å¯¼å®‰è£…æœŸé—´\n      - å·¥ä½œæ¬¡æ•°ï¼šä¸€æ¬¡\n      - åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿç£ç›˜æ“ä½œç­‰\n      - å¸¸ç”¨åœºæ™¯ï¼šå®‰è£…éƒ¨ç½²\n    - cloud-initï¼š\n      - å·¥ä½œé˜¶æ®µï¼šä»»æ„ç³»ç»Ÿå¼•å¯¼æœŸé—´\n      - å·¥ä½œæ¬¡æ•°ï¼šå¤šæ¬¡\n      - åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿé…ç½®ç­‰\n      - å¸¸ç”¨åœºæ™¯ï¼šç³»ç»Ÿé…ç½®\n  - Ignition ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿè€Œä¸æ˜¯æ›´æ”¹å·²å­˜åœ¨çš„ç³»ç»Ÿï¼ŒOpenShift 4 ä½¿ç”¨ `Machine Config Operator` å®Œæˆæ‰€æœ‰ä¸»æœºçš„é…ç½®ã€‚  \n  - Ignition ä»¥å£°æ˜å¼æ–¹å¼ï¼ˆdeclarative configurationï¼‰æ£€æŸ¥é…ç½®ä¸­çš„æ‰€æœ‰é…ç½®é¡¹ç›®ä»¥æ»¡è¶³æŒ‡å®šçš„è¦æ±‚ã€‚  \n  - âœ¨ åœ¨ Ignition å®Œæˆä¸»æœºé…ç½®åï¼Œkernel ä¿æŒè¿è¡Œä½†ä¸¢å¼ƒ initial RAM diskï¼Œå¹¶ä¸”è½¬å‘ï¼ˆpivot toï¼‰ç£ç›˜ä¸Šå·²å®‰è£…çš„ç³»ç»Ÿä¸­ã€‚æ— éœ€ç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ä¸å…¶ä»–ç‰¹æ€§å³å¯å¯åŠ¨ã€‚  \n  - ç”±äº Ignition é€šè¿‡å£°æ˜å¼é…ç½®å°†ä¸»æœºè°ƒæ•´ä¸ºæŒ‡å®šçš„çŠ¶æ€ï¼Œå› æ­¤ä¸èƒ½å­˜åœ¨å…·æœ‰éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè‹¥åœ¨éƒ¨ç½² OpenShift 4 é›†ç¾¤æ—¶å­˜åœ¨éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè¯¥ä¸»æœºå°†æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œéœ€æ›´æ¢æ–°çš„ä¸»æœºå†æ¬¡è°ƒé…åŠ å…¥é›†ç¾¤ã€‚  \n  - è‹¥å­˜åœ¨é—®é¢˜çš„ Ignition é…ç½®å¼•èµ·ä¸»æœºé…ç½®çš„å¤±è´¥ï¼ŒIgnition å°†ä¸å†å°è¯•ä½¿ç”¨ç›¸åŒçš„é…ç½®æ¥è°ƒé…å¦ä¸€å°ä¸»æœºã€‚  \n  - ç”±äº Ignition å¯ä½¿ç”¨å®Œæ•´çš„ç©ºç£ç›˜ï¼Œå®ƒèƒ½å®ç° cloud-init æ— æ³•å®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚ä½¿ç”¨ PXE å¼•å¯¼ä»ç©ºç£ç›˜è°ƒé…è£¸æœºç³»ç»Ÿã€‚\n\n### Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\n- åœ¨ OpenShift 4 é›†ç¾¤ä¸­çš„ RHCOS ä¸»æœºä¸Š Ignition çš„å¤„ç†æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š  \n  - 1ï¸âƒ£ æ§åˆ¶å¹³é¢ä¸»æœºï¼ˆ`control plane machines`ï¼‰ä»å¼•å¯¼ä¸»æœºï¼ˆ`bootstrap machine`ï¼‰è·å– Ignition é…ç½®æ–‡ä»¶ï¼Œè€Œå·¥ä½œä¸»æœºï¼ˆ`worker machines`ï¼‰ä»æ§åˆ¶å¹³é¢ä¸»æœºè·å– Ignition é…ç½®æ–‡ä»¶ã€‚  \n  - 2ï¸âƒ£ Ignition åœ¨ä¸»æœºä¸Šåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç›®å½•ä¸é“¾æ¥ï¼Œå®ƒæ”¯æŒ RAID é˜µåˆ—ä½†ä¸æ”¯æŒ LVM é€»è¾‘å·ã€‚  \n  - 3ï¸âƒ£ Igition åœ¨ initramfs ä¸­æŒ‚è½½ root æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿäº `/sysroot` ç›®å½•å¹¶åœ¨ `/sysroot` ç›®å½•ä¸­å·¥ä½œã€‚  \n  - 4ï¸âƒ£ Ignition é…ç½®æ‰€æœ‰å®šä¹‰çš„æ–‡ä»¶ç³»ç»Ÿå¹¶æ°å½“åœ°æŒ‚è½½å®ƒä»¬ã€‚  \n  - 5ï¸âƒ£ Ignition è¿è¡Œ `systemd` ä¸´æ—¶æ–‡ä»¶ä»¥å¡«å……åœ¨ `/var` ç›®å½•ä¸­çš„æ‰€éœ€æ–‡ä»¶ã€‚  \n  - 6ï¸âƒ£ Ignition è¿è¡Œå…¶é…ç½®æ–‡ä»¶æ¥é…ç½®ç”¨æˆ·ã€systemd å•å…ƒæ–‡ä»¶ä¸å…¶ä»–é…ç½®æ–‡ä»¶ã€‚  \n  - 7ï¸âƒ£ Ignition å¸è½½åœ¨ initramfs ä¸­æŒ‚è½½çš„æŒä¹…åŒ–ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç»„ä»¶ã€‚  \n  - 8ï¸âƒ£ Ignition å¯åŠ¨æ–°ä¸»æœºçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯åŠ¨ç³»ç»Ÿå¼•å¯¼é˜¶æ®µçš„æ‰€æœ‰å…¶ä»–çš„æœåŠ¡ã€‚\n- å¤„ç†ç»“æŸåï¼Œä¸»æœºå·²åšå¥½åŠ å…¥é›†ç¾¤çš„å‡†å¤‡å¹¶ä¸”æ— éœ€é‡å¯ï¼Œä¸å‰æ–‡æ‰€è¿°ç›¸åŒã€‚\n\n### Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\n- FCOS æ”¯æŒåœ¨å¤šç§ IaaS ç¯å¢ƒä¸‹è¿è¡Œã€‚\n- Fedora CoreOS live ISO ç‰ˆæœ¬ï¼šfedora-coreos-36.20220906.3.2-live.x86_64.iso\n- Butane å·¥å…·ï¼š  \n  - linux ç‰ˆæœ¬ï¼š[0.15.0](https://github.com/coreos/butane/releases/download/v0.15.0/butane-x86_64-unknown-linux-gnu)  \n  - è¯¥å·¥å…·æ¥æºäº [coreos/butane](https://github.com/coreos/butane) é¡¹ç›®  \n  - `Butane` ä»¥å‰ç§°ä¸º Fedora CoreOS é…ç½®è½¬æ¢å™¨ï¼ˆFedora CoreOS Config Transpilerï¼Œ`FCCT`ï¼‰ï¼Œå®ƒå¯å°† Butane é…ç½®æ–‡ä»¶ï¼ˆButane Configï¼‰æˆ–ç§° FCC æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition Configï¼‰ï¼Œè¯¥æ–‡ä»¶ä¸º `JSON` æ ¼å¼å°†è¢« FCOS ä¸»æœºåœ¨é¦–æ¬¡å¼•å¯¼è°ƒé…æ—¶ä½¿ç”¨ï¼Œå¯ç”¨äºåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  \n  - âœ¨ å…¶ä¸­ Butane é…ç½®æ–‡ä»¶ä¸º `YAML` æ ¼å¼ï¼Œå…³äºè¯¥æ–‡ä»¶ä¸åŒç‰ˆæœ¬çš„é…ç½®è§„èŒƒï¼ˆconfiguration specificationsï¼‰è¯·å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/coreos/butane/blob/main/docs/specs.md)ã€‚  \n  - âœ¨ Butane é…ç½®æ–‡ä»¶ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒè¯¥ [Examples](https://github.com/coreos/butane/blob/main/docs/examples.md)ã€‚  \n  - å¯åœ¨è‡ªå·±æŒ‡å®šçš„èŠ‚ç‚¹ï¼ˆé FCOS ä¸»æœºï¼‰ä¸Šå®‰è£… butaneï¼Œå®‰è£…æ–¹å¼åŒ…æ‹¬ butane å®¹å™¨é•œåƒï¼ˆ`quay.io/coreos/butane:release`ï¼‰ã€rpm è½¯ä»¶åŒ…æˆ–ç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆstandalone binaryï¼‰ï¼Œæ­¤å¤„ä½¿ç”¨ä»¥ä¸Šé“¾æ¥çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚![quay-coreos-butane-release.png](quay-coreos-butane-release.png)  \n  - butane çš„ä½¿ç”¨æ–¹æ³•å¯å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/coreos/butane/blob/main/docs/getting-started.md)ã€‚\n- ignition-validate å·¥å…·ï¼š  \n  - linux ç‰ˆæœ¬ï¼š[2.14.0](https://github.com/coreos/ignition/releases/download/v2.14.0/ignition-validate-x86_64-linux)  \n  - è¯¥å·¥å…·æ¥æºäº [coreos/ignition](https://github.com/coreos/ignition) é¡¹ç›®  \n  - è¯¥å·¥å…·ç”¨äºå¯¹ Ignition é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸åˆæ³•æ€§å­—æ®µçš„éªŒè¯ï¼Œè‹¥è¯­æ³•ä¸åˆè§„å°†æ— æ³•åœ¨ FCOS ä¸­ä½¿ç”¨ `coreos-installer` äºç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶å®‰è£…ã€‚\n\n### Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\n- å‡†å¤‡ HTTP æœåŠ¡å™¨ã€Ignition é…ç½®æ–‡ä»¶ä¸ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆé FCOS èŠ‚ç‚¹ï¼‰ï¼š  \n  > â— æ³¨æ„ï¼š\n  > \n  > 1. æœ¬æ–‡å®‰è£…é‡‡ç”¨åŸºäº KVM è™šæ‹Ÿæœºæ¨¡æ‹Ÿè£¸é‡‘å±å®‰è£…ç¯å¢ƒã€‚\n  > \n  > 2. å…³äº `butane` å·¥å…·ä¸ `ignition-validate` å·¥å…·çš„å®‰è£…å¦‚å‰æ–‡æ‰€è¿°ã€‚\n  > \n  > 3. ğŸ’â€â™‚ï¸ æœ¬æ–‡ä½¿ç”¨ FCOS live ISO çš„æ–¹å¼å¼•å¯¼å¹¶ä½¿ç”¨å…¶ä¸­çš„ coreos-installer å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼Œè‹¥ä½¿ç”¨ PXE æ–¹å¼å¼•å¯¼å®‰è£…è¯·å‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚\n    \n  ```bash\n  $ sudo yum install httpd\n  $ sudo systemctl enable --now httpd.service\n  # å®‰è£…ä¸å¯åŠ¨ httpd æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯\n  $ ssh-keygen -N '' -t rsa -f ~/.ssh/core_fcos_login\n  # åˆ›å»ºç”¨äº SSH å…å¯†ç™»å½• FCOS çš„å…¬ç§é’¥ï¼Œæ­¤å¤„å°†è¯¥ SSH å…¬é’¥æ‹·è´è‡³ Butane é…ç½®æ–‡ä»¶\n  # çš„ ssh_authorized_keys å­—æ®µä¸­ã€‚\n  $ mkdir ~/fcos && cd ~/fcos\n  $ vim fcos-customized-config.yml\n  # åˆ›å»º Butane é…ç½®æ–‡ä»¶\n  ```\n  è¯¥é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š\n  ```yaml\n  # è¯¥é…ç½®æ–‡ä»¶å¯å‚çœ‹å‰æ–‡ GitHub Butane çš„ Examples æˆ– Fedora CoreOS å®˜æ–¹æ–‡æ¡£\n  # çš„ Storage éƒ¨åˆ†è¿›è¡Œç¼–è¾‘ã€‚\n  variant: fcos\n  version: 1.1.0\n  # åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·ã€å¯†ç ã€home å®¶ç›®å½•ä¸é…ç½® SSH å…å¯†ç™»å½•çš„å…¬é’¥\n  passwd:\n    users:\n      - name: core\n        ssh_authorized_keys:\n          - ssh-rsa AAAAB3Nz...jnXfG+Uj godev@cloud-ctl.domain12.example.com\n        # ç”±äº FCOS/RHCOS åœ¨å®‰è£…å®Œæˆåæ— æ³•ä½¿ç”¨å¯†ç ç›´æ¥ç™»å½•ï¼Œè¯¥å…¬é’¥ç”¨äº core ç”¨æˆ·çš„\n        # SSH å…å¯†ç™»å½•ã€‚\n      - name: cloud-admin\n        password_hash: $y$j9T$j0ODWvNUDSXcEcwpDH141.$dvAEVxBHUWbW/NnPd90qkg0Haq6vgkcKF151jvLDgYA\n        # æ˜æ–‡å¯†ç  redhat é€šè¿‡ hash åŠ å¯†çš„å¯†æ–‡\n        # è™½ç„¶è¯¥ç”¨æˆ·å·²é…ç½®å¯†ç ï¼Œä½†æ— æ³•é€šè¿‡ SSH è¿œç¨‹ç™»å½•ï¼Œè¯¥å¯†ç åªå…è®¸æœ¬åœ°æ§åˆ¶å°ç™»å½•ã€‚\n        home_dir: /opt/cloud-admin\n        no_create_home: false\n        groups:\n          - wheel\n        shell: /bin/bash\n        # æ³¨æ„ï¼šå½“ä»»ä½•ç”¨æˆ· SSH è¿œç¨‹ç™»å½•å¤±æ•ˆæ—¶ï¼Œå¯ç”¨è¯¥ç”¨æˆ·æœ¬åœ°ç™»å½•å¹¶ææƒï¼\n  storage:\n    # å°†æœ¬åœ°æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å†…å®¹æ³¨å…¥ FCOS çš„å¯¹åº”æ–‡ä»¶ä¸­ï¼Œéœ€ä½¿ç”¨ butane å·¥å…·çš„\n    # --files-dir é€‰é¡¹ã€‚\n    files:\n      - path: \"/etc/NetworkManager/system-connections/Wired connection 1.nmconnection\"\n        contents:\n          local: ./Wired_connection_1.nmconnection      \n        mode: 0600\n        # FCOS çš„ç½‘ç»œæ¥å£é…ç½®\n      - path: /etc/hostname\n        contents:\n          local: ./hostname\n        mode: 0644\n        # FCOS çš„ä¸»æœºåé…ç½®\n    # å°† FCOS çš„ /dev/vdb è¿›è¡Œåˆ†åŒºå¹¶æŒ‚è½½è‡³ /var ç›®å½•ï¼Œä¸»è¦ç”¨äºå®¹å™¨ä¸é•œåƒçš„å­˜å‚¨ã€‚\n    # æ³¨æ„ï¼šIgnition ä¸æ”¯æŒå¯¹ FCOS/RHCOS çš„ LVM é€»è¾‘å·åŠŸèƒ½ï¼\n    disks:\n      - device: /dev/vdb\n        wipe_table: true\n        partitions:\n          - number: 1\n            label: var\n    filesystems:\n      - path: /var\n        device: /dev/disk/by-partlabel/var\n        format: xfs\n        wipe_filesystem: true \n        label: var\n        with_mount_unit: true\n  ```\n  ä»¥ä¸Š YAML æ–‡ä»¶å¯ç‚¹å‡» [æ­¤å¤„](https://github.com/Alberthua-Perl/scripts-confs/tree/master/fedora-coreos-36) è·å¾—ã€‚ \n  ```bash\n  $ cat ./hostname\n    fcos36-cloud.lab.example.com\n  $ cat ./Wired_connection_1.nmconnection \n    [connection]\n    id=Wired connection 1\n    type=ethernet\n    autoconnect-priority=-999\n    interface-name=ens3\n  \n    [ethernet]\n  \n    [ipv4]\n    address1=192.168.110.13/24,192.168.110.1\n    dns=192.168.110.1;\n    method=manual\n  \n  $ butane --files-dir . \\\n    --pretty --strict \\\n    --output fcos-customized-config.ign fcos-customized-config.yml\n  # åœ¨å½“å‰ç›®å½•ä¸­æ ¹æ® Butane é…ç½®æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶\n  $ ignition-validate fcos-customized-config.ign\n  # éªŒè¯ Ignition é…ç½®æ–‡ä»¶è¯­æ³•çš„åˆæ³•æ€§ï¼Œè‹¥æ— è¿”å›åˆ™éªŒè¯é€šè¿‡ï¼Œè¯¥æ–‡ä»¶å¯ç”¨äº FCOS çš„å®‰è£…ã€‚\n  $ sudo cp fcos-customized-config.ign /var/www/html/\n  # æ‹·è´è¯¥æ–‡ä»¶è‡³ HTTP æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸­ç”¨äº FCOS ä¸­ coreos-installer å·¥å…·çš„ä¸‹è½½\n  # è¯»å–ä¸ç³»ç»Ÿå®‰è£…ã€‚\n  ```\n- åˆ›å»º FCOS è™šæ‹Ÿæœºå¹¶ä½¿ç”¨ FCOS live ISO å¼•å¯¼å®‰è£…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![use-fedora-coreos-live-to-install.png](use-fedora-coreos-live-to-install.png)![login-fedora-coreos-live.png](login-fedora-coreos-live.png)\n  ğŸ‘‰ `core` ç”¨æˆ·å¯ `sudo` å…å¯†ææƒä¸º root ç”¨æˆ·ã€‚  \n  ğŸ‘‰ ä½¿ç”¨ `core` ç”¨æˆ·æ­£å¸¸ç™»å½•åï¼Œå†ä½¿ç”¨ `ip -br a s` å‘½ä»¤æŸ¥çœ‹ä¸»æœºçš„ IP åœ°å€ï¼ˆä¸€èˆ¬å¯é€šè¿‡ `DHCP` è‡ªåŠ¨è·å–ï¼‰ï¼Œè‹¥æ— ä¸ HTTP æœåŠ¡å™¨é€šä¿¡çš„ IP åœ°å€ï¼Œå°†æ— æ³•ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶è€Œå®‰è£…å¤±è´¥ï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤ä¸´æ—¶é…ç½®åŠ ä»¥ç”Ÿæ•ˆï¼š  \n  ```bash\n  $ sudo ip address add 192.168.110.13/24 dev ens3\n  # éœ€æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´ IP åœ°å€ä¸å¯¹åº”çš„ç½‘ç»œæ¥å£\n  ```\n  ğŸ‘‰ ä½¿ç”¨ FCOS live ISO è‡ªå¸¦çš„ `coreos-installer` å·¥å…·æ ¹æ® Ignition é…ç½®æ–‡ä»¶å®‰è£…éƒ¨ç½²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š \n  ![coreos-installer-customized-install.png](coreos-installer-customized-install.png)  \n  ```bash\n  $ sudo coreos-installer install \\\n    --insecure-ignition \\\n    --ignition-url http://192.168.110.130/fcos-customized-config.ign \\\n    /dev/vda\n  # ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶å¹¶å°†æ ¹ç³»ç»Ÿå®‰è£…äº /dev/vda ä¸­\n  # æ­¤å®‰è£…è¿‡ç¨‹æ ¹æ®æ‰€é…ç½®çš„å†…å®¹ä¸åŒè€—æ—¶ä¹Ÿå°†ä¸åŒï¼ˆç¬”è€…ç¯å¢ƒä¸­å®‰è£…è¾ƒå¿«ï¼‰\n  $ sudo reboot\n  # é‡å¯ç³»ç»Ÿ\n  ```\n- ç™»å½• FCOS éªŒè¯å®‰è£…çŠ¶æ€ï¼š  \n  ```bash\n  $ ssh -i ~/.ssh/core_fcos_login core@fcos36-cloud\n    Fedora CoreOS 36.20221001.3.0\n    Tracker: https://github.com/coreos/fedora-coreos-tracker\n    Discuss: https://discussion.fedoraproject.org/tag/coreos\n  \n    Last login: Mon Oct 24 14:07:00 2022 from 192.168.110.130\n    [core@fcos36-cloud ~]$ sudo -i\n    [root@fcos36-cloud ~]# id cloud-admin\n    uid=1001(cloud-admin) gid=1001(cloud-admin) groups=1001(cloud-admin),10(wheel)\n    [root@fcos36-cloud ~]# su - cloud-admin\n    [cloud-admin@fcos36-cloud ~]$ sudo -i\n    [sudo] password for cloud-admin: \n    [root@fcos36-cloud ~]# lsblk --paths\n    NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\n    /dev/sr0     11:0    1 1024M  0 rom  \n    /dev/vda    252:0    0   10G  0 disk \n    |-/dev/vda1 252:1    0    1M  0 part \n    |-/dev/vda2 252:2    0  127M  0 part \n    |-/dev/vda3 252:3    0  384M  0 part /boot\n    `-/dev/vda4 252:4    0  9.5G  0 part /sysroot/ostree/deploy/fedora-coreos/var\n                                         /usr\n                                         /etc\n                                         /\n                                         /sysroot\n    /dev/vdb    252:16   0   10G  0 disk \n    `-/dev/vdb1 252:17   0   10G  0 part /var \n  # Ignition é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®åœ¨ FCOS ä¸­å·²ç”Ÿæ•ˆ\n  ```\n- ç”±äº FCOS ä¸­ä½¿ç”¨ `rpm-ostree` è¿›è¡Œè½¯ä»¶åŒ…çš„ç®¡ç†ï¼Œè‹¥éœ€å®‰è£…é¢å¤–çš„è½¯ä»¶åŒ…ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š  \n  ```bash\n  $ sudo rpm-ostree install \\\n    podman skopeo buildah cri-o cri-tools vim-enhanced\n  # å®‰è£…å®¹å™¨ä¸é•œåƒç®¡ç†å·¥å…·\n  $ sudo systemctl status crio.service\n  # æŸ¥çœ‹ CRI-O å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ï¼Œå¯é€šè¿‡ crictl å‘½ä»¤æµ‹è¯•ç®¡ç†å®¹å™¨ã€‚\n  ```\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Introducing Fedora CoreOS](https://fedoramagazine.org/introducing-fedora-coreos/)\n- [Getting started with Fedora CoreOS](https://fedoramagazine.org/getting-started-with-fedora-coreos/)\n- [Fedora CoreOS å…¥é—¨ | Linux ä¸­å›½](https://mp.weixin.qq.com/s/Vf6TvGSi5sNnMjT5QldUQg)\n- â¤ [Fedora CoreOS Documentation](https://docs.fedoraproject.org/en-US/fedora-coreos/)\n- [Red Hat Enterprise Linux CoreOS (RHCOS)](https://docs.openshift.com/container-platform/4.11/architecture/architecture-rhcos.html)\n- â¤ [How to customize Fedora CoreOS for dedicated workloads with OSTree](https://developers.redhat.com/blog/2020/03/12/how-to-customize-fedora-coreos-for-dedicated-workloads-with-ostree#)","slug":"fcos-rhcos-basic-usage","published":1,"updated":"2022-11-28T15:46:05.854Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonoia000116vdetjs0rfb","content":"<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>å…³é”®æŠ€æœ¯ç‚¹</li>\n<li>Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§</li>\n<li>Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹</li>\n<li>Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåº</li>\n<li>Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜</li>\n<li>Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"å…³é”®æŠ€æœ¯ç‚¹ï¼š\"><a href=\"#å…³é”®æŠ€æœ¯ç‚¹ï¼š\" class=\"headerlink\" title=\"å…³é”®æŠ€æœ¯ç‚¹ï¼š\"></a>å…³é”®æŠ€æœ¯ç‚¹ï¼š</h3><ul>\n<li>ä»¥ä¸‹æŠ€æœ¯ç‚¹åœ¨æ–‡ä¸­å°†æ ¹æ® Fedora CoreOS åŠ RHCOS ä¸­å±•å¼€è¯´æ˜ï¼š  <ul>\n<li>ignition, butane, ignition-validate  </li>\n<li>ostree, rpm-tree,zincati, bootupd</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Fedora-CoreOS-åŠ-RHCOS-ä»‹ç»ä¸ç‰¹æ€§ï¼š\"><a href=\"#Fedora-CoreOS-åŠ-RHCOS-ä»‹ç»ä¸ç‰¹æ€§ï¼š\" class=\"headerlink\" title=\"Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§ï¼š\"></a>Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§ï¼š</h3><ul>\n<li>åœ¨ OpenShift 4 å®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨å®‰è£… CoreOS çš„å•†ä¸šç‰ˆ Red Hat Enterprise Linux CoreOSï¼ˆç®€ç§° <code>RHCOS</code>ï¼‰ã€‚æ ¹æ® OpenShift 4 çš„æ–‡æ¡£è¯´æ˜ï¼ŒRHCOS æ— æ³•ç‹¬ç«‹è¿è¡Œå®‰è£…ï¼Œå®ƒå¿…é¡»å’Œ OpenShift 4 ä¸€èµ·è¿è¡Œï¼ˆå› æ­¤ RHCOS æ²¡æœ‰å•ç‹¬çš„è®¢é˜…ï¼‰ã€‚</li>\n<li>ğŸ˜ƒ ä¸è¿‡å¥½åœ¨ CoreOS è¿˜æä¾›äº†å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ç¤¾åŒºç‰ˆ <code>Fedora CoreOS</code>ï¼ˆç®€ç§° <code>FCOS</code>ï¼‰å¯ä»¥å®Œå…¨å…è´¹ä½¿ç”¨ã€‚ç”±äº FCOS å¯ä»¥æ— éœ€ OpenShift 4 ä¹Ÿå¯ä»¥ç‹¬ç«‹å®‰è£…è¿è¡Œï¼Œå› æ­¤ä½¿ç”¨ FCOS ä½œä¸ºç ”ç©¶ç¯å¢ƒï¼Œè€Œç›¸å…³æ“ä½œåŸºæœ¬éƒ½å¯é€‚ç”¨ RHCOS ç¯å¢ƒã€‚</li>\n<li>FCOS/RHCOS æ˜¯ Red Hat åœ¨æ”¶è´­ CoreOS å…¬å¸åç»“åˆ <code>CoreOS Container Linux</code> å’Œ <code>Fedora Atomic Host</code> çš„ä¼˜ç‚¹æ¨å‡ºçš„æ–°ä¸€ä»£å®¹å™¨æ“ä½œç³»ç»Ÿï¼Œå…¶ç›®æ ‡æ˜¯æä¾›æœ€ä½³çš„å®¹å™¨ä¸»æœºï¼Œä»è€Œèƒ½å®‰å…¨ã€å¤§è§„æ¨¡åœ°è¿è¡Œå®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½ã€‚</li>\n<li>FCOS/RHCOS å°† <a href=\"https://github.com/coreos/ignition\" target=\"_blank\" rel=\"noopener\">Ignition</a>ï¼ˆç‚¹ç«ï¼‰ ä¸ rpm-ostree ç­‰æŠ€æœ¯ç›¸é›†æˆï¼Œæ˜¯ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°çš„ã€æœ€å°çš„ã€æ•´ä½“çš„ã€å¯¹è¿è¡Œå®¹å™¨å’Œ Kubernetes è¿›è¡Œäº†ä¼˜åŒ–çš„æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºå®ƒä»¬æ›´ç¬¦åˆ â€œä¸å¯å˜æ¶æ„â€ï¼ˆ<code>Immutable Infrastructure</code>ï¼‰ç†å¿µï¼Œå› æ­¤æˆä¸º Red Hat æ¨èçš„ OpenShift 4 åº•å±‚æ“ä½œç³»ç»Ÿã€‚</li>\n<li>FCOS/RHCOS çš„å®‰è£…åŠé…ç½®è¿‡ç¨‹å’Œä¸€èˆ¬çš„ RHEL ç¨æœ‰å·®åˆ«ï¼Œéœ€è¦é€šè¿‡ Ignition é…ç½®æ–‡ä»¶åœ¨å®‰è£…çš„æ—¶å€™åˆå§‹åŒ–ç½‘ç»œã€å­˜å‚¨ã€å†…æ ¸ã€ç”¨æˆ·ç­‰æ–¹é¢çš„é…ç½®ã€‚</li>\n<li>FCOS çš„è®¾è®¡ç†å¿µï¼š  <ul>\n<li>ğŸ³ ç”±äºå®¹å™¨å…è®¸å°†å·¥ä½œè´Ÿè½½é‡å¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¹¶è‡ªåŠ¨æ‰©å±•ä»¥æ»¡è¶³éœ€æ±‚ã€‚å®¹å™¨æä¾›çš„éš”ç¦»æ„å‘³ç€ä¸»æœºæ“ä½œç³»ç»Ÿå¯ä»¥å¾ˆå°ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ª <code>Linux kernel</code>ã€<code>systemd</code>ã€<code>container runtime</code> å’Œä¸€äº›é™„åŠ æœåŠ¡ï¼ˆå¦‚ SSH æœåŠ¡å™¨ï¼‰ã€‚  </li>\n<li>FCOS æ˜¯ä¸“é—¨ä¸ºå®¹å™¨å·¥ä½œè´Ÿè½½è€Œè®¾è®¡çš„ï¼Œæ— éœ€å®šæœŸç»´æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨æœ€æ–°çš„æ“ä½œç³»ç»Ÿæ”¹è¿›ã€bug ä¿®å¤å’Œå®‰å…¨è‡ªåŠ¨æ›´æ–°ï¼Œå…¶ä½¿ç”¨ Ignition ä¸ºè‡ªèº«æä¾›æœåŠ¡ï¼Œä½¿ç”¨ <code>Podman</code> å’Œ <code>Moby</code> è¿è¡Œå®¹å™¨ï¼Œå¹¶ä½¿ç”¨ <code>rpm-ostree</code> è‡ªåŠ¨è¿›è¡ŒåŸå­æ›´æ–°ã€‚<blockquote>\n<p>â— æ³¨æ„ï¼š</p>\n<ol>\n<li><p>FCOS æ”¯æŒ <code>CRI-O</code> ä½œä¸ºå®¹å™¨å¼•æ“ï¼Œå¸¸ç”¨äº OpenShift 4 çš„åº•å±‚å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ CRI-O è¿è¡Œå®¹å™¨ï¼ŒOpenShift 4 å¯é€šè¿‡ <code>CRI</code> æ¥å£åˆ›å»ºä¸ç®¡ç† Podã€‚</p>\n</li>\n<li><p>å¯é€šè¿‡ <code>crictl</code> å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸ç®¡ç†å®¹å™¨åŠ Podï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹ç”¨äºå®¹å™¨æˆ– pod çš„è°ƒè¯•è€Œéå®¹å™¨æˆ– pod çš„åˆ›å»ºã€‚</p>\n</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>FCOS è°ƒé…ä¸å¯å˜æ¶æ„ï¼š  <ul>\n<li>åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼ï¼ˆ<code>first boot</code>ï¼‰é˜¶æ®µï¼ŒFCOS ä½¿ç”¨ Ignition è°ƒé…ç³»ç»Ÿã€‚  </li>\n<li>Ignition è¯»å–ç”¨æˆ·æä¾›çš„æ•°æ®æˆ–è¿œç¨‹ URL åœ°å€æä¾›çš„ Ignition é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨å®ƒåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  </li>\n<li>è°ƒé…ä¸»æœºçš„æ–¹å¼ï¼š    <ul>\n<li>ç¼–è¾‘åŸºäº YAML æ ¼å¼çš„ <code>Fedora CoreOS Config</code>ï¼ˆFCCï¼‰æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šä¸»æœºçš„æœŸæœ›é…ç½®ï¼ŒFCC æ”¯æŒæ‰€æœ‰çš„ Ignition åŠŸèƒ½ï¼Œä¹Ÿæä¾›é¢å¤–çš„è¯­æ³•ã€‚    </li>\n<li>ä½¿ç”¨ <code>Fedora CoreOS Config Transpiler (Butane)</code> å·¥å…·å°† FCC æ–‡ä»¶ï¼ˆ<code>.fcc</code>ï¼‰è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆ<code>.ign</code>ï¼‰ã€‚    </li>\n<li>å¯åŠ¨ FCOS ä¸»æœºå¹¶å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä¸»æœºä¸­è°ƒé…ç³»ç»Ÿçš„å®‰è£…ã€‚    <blockquote>\n<p>ğŸ’â€â™‚ï¸ è°ƒé…ä¸»æœºçš„æ–¹æ³•ï¼š</p>\n<ol>\n<li><p>ä½¿ç”¨ PXE å¼•å¯¼å¹¶ä¸æŒ‡å®š Ignition é…ç½®æ–‡ä»¶è°ƒé…å®‰è£…ä¸»æœºã€‚</p>\n</li>\n<li><p>å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä½¿ç”¨ FCOS live ISO å¼•å¯¼å¯åŠ¨çš„ä¸»æœºä¸­ï¼Œå†ä½¿ç”¨ <code>coreos-installer</code> å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼ˆæœ¬æ–‡ä½¿ç”¨æ­¤æ–¹æ³•ï¼‰ã€‚  </p>\n</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>FCOS è¢«è®¾è®¡ä¸ºä¸å¯å˜æ¶æ„ã€‚åœ¨ä¸»æœºè¢«è°ƒé…ä¹‹åï¼Œä¸åº”è¯¥æ›´æ”¹ /etc ç›®å½•æˆ–é‡æ–°é…ç½®ä¸»æœºï¼Œç›¸åï¼Œæ›´æ”¹ FCC æ–‡ä»¶å¹¶ä¸”ä½¿ç”¨è¯¥æ–‡ä»¶è°ƒé…æ›¿æ¢çš„ä¸»æœºã€‚  </li>\n<li>ğŸ³ è¿™ç§æ–¹å¼ä¸å®¹å™¨ç®¡ç†ç›¸ä¼¼ï¼šå®¹å™¨é•œåƒä¸å¯è¢«åŸåœ°æ›´æ–°ï¼Œè€Œæ˜¯é‡å¤´æ„å»ºä¸é‡æ–°éƒ¨ç½²ã€‚è¯¥æ–¹å¼åœ¨è´Ÿè½½å¢åŠ æ—¶å®¹æ˜“æ¨ªå‘æ‰©å®¹ã€‚åªéœ€ç®€å•åœ°ä½¿ç”¨ç›¸åŒçš„ Ignition é…ç½®æ–‡ä»¶æ¥å¯åŠ¨å…¶ä»–ä¸»æœºã€‚</li>\n</ul>\n</li>\n<li><a href=\"https://getfedora.org/en/coreos/download?tab=metal_virtualized&amp;stream=stable&amp;arch=x86_64\" target=\"_blank\" rel=\"noopener\">FCOS å‘å¸ƒç‰ˆæœ¬</a>ï¼š<img src=\"fedora-coreos-release-version.png\" alt=\"fedora-coreos-release-version.png\">  <ul>\n<li><code>testing stream</code>ï¼š<br>å½“å‰ Fedora å‘è¡Œç‰ˆçš„å¸¸è§„å¿«ç…§ï¼ŒåŠ ä¸Šæ›´æ–°ã€‚  </li>\n<li>â¤ <code>stable stream</code>ï¼š<br>åœ¨æµ‹è¯•ç‰ˆæœ¬å¯ç”¨ä¸¤å‘¨åï¼Œå®ƒè¢«å‘é€åˆ°ç¨³å®šæµï¼Œåœ¨æµ‹è¯•ä¸­å‘ç°çš„ <code>bug</code> å°†åœ¨å‘å¸ƒç¨³å®šæµä¹‹å‰è¢«ä¿®å¤ã€‚  </li>\n<li><code>next stream</code>ï¼š<br>å³å°†å‘å¸ƒçš„ Fedora ç‰ˆæœ¬çš„å¸¸è§„å¿«ç…§ï¼Œå…è®¸æœ‰é¢å¤–çš„æ—¶é—´æµ‹è¯•è¾ƒå¤§çš„æ›´æ”¹ã€‚<br>ğŸ‘‰ æ¯ä¸ª stream æ¯ 2 å‘¨å‘å¸ƒä¸€æ¬¡ï¼Œæ›´æ–°å†…å®¹ä¼šä»ä¸€ä¸ª stream æ¨å¹¿åˆ°å¦ä¸€ä¸ª streamï¼ˆ<code>next -&gt; testing -&gt; stable</code>ï¼‰ã€‚è¿™æ ·è½åœ°åœ¨ stable stream ä¸­çš„æ›´æ–°å°±æœ‰æœºä¼šç»è¿‡é•¿æ—¶é—´çš„æµ‹è¯•ã€‚<br>ğŸ‘‰ æ‰€æœ‰ä¸‰ä¸ª stream éƒ½æ”¶åˆ°äº†å®‰å…¨æ›´æ–°å’Œå…³é”®çš„é”™è¯¯ä¿®å¤ï¼Œå¹¶æ—¨åœ¨å®‰å…¨åœ°ç”¨äºç”Ÿäº§ä½¿ç”¨ã€‚å¤§å¤šæ•°æœºå™¨åº”è¯¥è¿è¡Œ <code>stable stream</code>ï¼Œå› ä¸ºå®ƒæ¥å—æœ€å¤šçš„æµ‹è¯•ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·åº”è¯¥åœ¨ next stream ä¸Šè¿è¡Œä»–ä»¬çš„éƒ¨åˆ†èŠ‚ç‚¹ï¼Œå¹¶å‘é—®é¢˜è·Ÿè¸ªå™¨æŠ¥å‘Šé—®é¢˜ã€‚è¿™æœ‰åŠ©äºç¡®ä¿åªå½±å“ç‰¹å®šå·¥ä½œè´Ÿè½½æˆ–ç‰¹å®šç¡¬ä»¶çš„ bug åœ¨ç¨³å®šä¹‹å‰å¾—åˆ°ä¿®å¤ã€‚</li>\n</ul>\n</li>\n<li>RHCOS çš„å…³é”®ç‰¹æ€§ï¼š  <ul>\n<li>ç³»ç»ŸåŸºäº RHEL å¼€å‘  </li>\n<li>å¯æ§åˆ¶çš„ä¸å¯å˜æ¶æ„ï¼ˆ<code>controlled immutability</code>ï¼‰  </li>\n<li>é»˜è®¤ä½¿ç”¨ <code>CRI-O</code> å®¹å™¨è¿è¡Œæ—¶  </li>\n<li>å¯ä½¿ç”¨å®¹å™¨å·¥å…·é›†ç®¡ç†å®¹å™¨æˆ– Podï¼ˆåŒ…æ‹¬ <code>podman</code>ã€<code>skopeo</code> ä¸ <code>crictl</code> ç­‰ï¼‰  </li>\n<li>ğŸ”¥ ä½¿ç”¨ <code>rpm-ostree</code> å®ç°äº‹åŠ¡æ€§æ›´æ–°å‡çº§ <blockquote>\n<p>â— æ³¨æ„ï¼š</p>\n<ol>\n<li><p><code>OSTree</code> æ˜¯ä¸€ä¸ªç”¨äºå¯¹åŸºäº Linux çš„æ“ä½œç³»ç»Ÿè¿›è¡Œç‰ˆæœ¬æ›´æ–°çš„ç³»ç»Ÿï¼Œå®ƒå¯ä»¥è¢«è§†ä¸º â€œé¢å‘æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶çš„ gitâ€ï¼Œå®ƒè¢« endless OSã€Flatpakã€Fedoraã€CentOSã€Atomic Host å’Œ GNOME ç­‰é¡¹ç›®ç”¨æ¥æŒç»­äº¤ä»˜ï¼Œæœ‰å…³ OSTree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://ostreedev.github.io/ostree/\" target=\"_blank\" rel=\"noopener\">libostree å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>\n</li>\n<li><p>rpm-ostree æ˜¯ä¸€ä¸ªæ··åˆé•œåƒ/åŒ…ç³»ç»Ÿï¼Œä»¥å‘½ä»¤è¡Œä¸å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯å°†è½¯ä»¶åŒ…ä»¥åˆ†å±‚çš„å½¢å¼æ„å»ºåœ¨ OSTree ä¹‹ä¸Šï¼Œå°†è½¯ä»¶åŒ…ä½œä¸ºç³»ç»Ÿçš„æ‰©å±•ï¼Œå…³äº rpm-ostree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://coreos.github.io/rpm-ostree\" target=\"_blank\" rel=\"noopener\">rpm-ostree å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>\n</li>\n<li><p>FCOS ä¸­çš„ <code>zincati</code> æœåŠ¡ï¼ˆ<code>zincati.service</code>ï¼‰å¯æ£€æµ‹ç³»ç»Ÿçš„çŠ¶æ€ï¼Œé€šè¿‡ <code>rpm-ostreed</code> å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œæ›´æ–°ï¼Œè‹¥å…¶å‘ç°å…·æœ‰æ–°çš„ç³»ç»Ÿæ›´æ–°å°†è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼Œå¯å°†è¯¥æœåŠ¡å…³é—­ä»¥ç¦ç”¨æ­¤åŠŸèƒ½ã€‚  </p>\n</li>\n</ol>\n</blockquote>\n</li>\n<li>ğŸ”¥ é’ˆå¯¹ <code>fireware</code> ä¸ <code>bootloader</code> çš„ <code>bootupd</code> æ›´æ–°å™¨ï¼Œbootupd å¯ä»¥å®ˆæŠ¤è¿›ç¨‹ <code>bootupd.service</code> çš„æ–¹å¼è¿è¡Œã€‚</li>\n<li>OpenShift 4 é›†ç¾¤é€šè¿‡ <code>Machine Config Operator (MCO)</code> æ›´æ–° RHCOS</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Ignition-åœ¨-FCOS-æˆ–-RHCOS-ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\"><a href=\"#Ignition-åœ¨-FCOS-æˆ–-RHCOS-ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\" class=\"headerlink\" title=\"Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\"></a>Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š</h3><ul>\n<li>Ignition æ˜¯ç”± FCOS/RHCOS ä½¿ç”¨çš„åœ¨ç³»ç»Ÿåˆå§‹åŒ–é…ç½®è¿‡ç¨‹ï¼ˆ<code>initramfs</code>ï¼‰ä¸­æ“çºµç£ç›˜çš„å·¥å…·ï¼Œå…¶å¯å®Œæˆå¸¸è§çš„ç£ç›˜ä»»åŠ¡ï¼ŒåŒ…æ‹¬ç£ç›˜åˆ†åŒºã€æ ¼å¼åŒ–åˆ†åŒºã€å†™æ–‡ä»¶ä¸é…ç½®ç”¨æˆ·ç­‰ã€‚</li>\n<li>åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶ï¼ˆfirst bootï¼‰ï¼ŒIgnition è¯»å–å®‰è£…ä»‹è´¨æˆ–æ‰€æŒ‡å®šçš„ Ignition é…ç½®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ã€‚</li>\n<li>âœ¨ Ignition çš„è°ƒé…æ–¹å¼ï¼š<br>Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition config fileï¼‰æˆ–ç§°ç‚¹ç«é…ç½®æ–‡ä»¶</li>\n<li>Ignition é…ç½®ä¸ <code>cloud-init</code> æˆ– <code>Linux Anaconda kickstart</code> é…ç½®ç³»ç»Ÿæå…¶ç›¸ä¼¼ï¼Œä½†å…¶å…·æœ‰è‡ªèº«çš„ç‰¹ç‚¹ï¼š  <ul>\n<li>ç”±äº Ignition èƒ½è¿›è¡Œç£ç›˜åˆ†åŒºã€è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸æ‰§è¡Œä¸»æœºæ°¸ä¹…æ–‡ä»¶ç³»ç»Ÿçš„å…¶ä»–æ”¹å˜ï¼Œå› æ­¤ï¼Œåœ¨å®‰è£… FCOS/RHCOS è¿‡ç¨‹ä¸­ Ignition è¿è¡Œäºä¸ç³»ç»Ÿç›¸éš”ç¦»çš„ <code>initial RAM disk</code> ä¸­ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œcloud-init ä½œä¸ºåˆå§‹åŒ–ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ä¸èƒ½å®¹æ˜“åœ°å®ç°ç£ç›˜çš„åˆ†åŒºã€‚  </li>\n<li>âœ¨ Ignition ä¸ cloud-init å¯¹æ¯”ï¼š<ul>\n<li>Ignitionï¼š<ul>\n<li>å·¥ä½œé˜¶æ®µï¼šé¦–æ¬¡å¼•å¯¼å®‰è£…æœŸé—´</li>\n<li>å·¥ä½œæ¬¡æ•°ï¼šä¸€æ¬¡</li>\n<li>åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿç£ç›˜æ“ä½œç­‰</li>\n<li>å¸¸ç”¨åœºæ™¯ï¼šå®‰è£…éƒ¨ç½²</li>\n</ul>\n</li>\n<li>cloud-initï¼š<ul>\n<li>å·¥ä½œé˜¶æ®µï¼šä»»æ„ç³»ç»Ÿå¼•å¯¼æœŸé—´</li>\n<li>å·¥ä½œæ¬¡æ•°ï¼šå¤šæ¬¡</li>\n<li>åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿé…ç½®ç­‰</li>\n<li>å¸¸ç”¨åœºæ™¯ï¼šç³»ç»Ÿé…ç½®</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Ignition ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿè€Œä¸æ˜¯æ›´æ”¹å·²å­˜åœ¨çš„ç³»ç»Ÿï¼ŒOpenShift 4 ä½¿ç”¨ <code>Machine Config Operator</code> å®Œæˆæ‰€æœ‰ä¸»æœºçš„é…ç½®ã€‚  </li>\n<li>Ignition ä»¥å£°æ˜å¼æ–¹å¼ï¼ˆdeclarative configurationï¼‰æ£€æŸ¥é…ç½®ä¸­çš„æ‰€æœ‰é…ç½®é¡¹ç›®ä»¥æ»¡è¶³æŒ‡å®šçš„è¦æ±‚ã€‚  </li>\n<li>âœ¨ åœ¨ Ignition å®Œæˆä¸»æœºé…ç½®åï¼Œkernel ä¿æŒè¿è¡Œä½†ä¸¢å¼ƒ initial RAM diskï¼Œå¹¶ä¸”è½¬å‘ï¼ˆpivot toï¼‰ç£ç›˜ä¸Šå·²å®‰è£…çš„ç³»ç»Ÿä¸­ã€‚æ— éœ€ç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ä¸å…¶ä»–ç‰¹æ€§å³å¯å¯åŠ¨ã€‚  </li>\n<li>ç”±äº Ignition é€šè¿‡å£°æ˜å¼é…ç½®å°†ä¸»æœºè°ƒæ•´ä¸ºæŒ‡å®šçš„çŠ¶æ€ï¼Œå› æ­¤ä¸èƒ½å­˜åœ¨å…·æœ‰éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè‹¥åœ¨éƒ¨ç½² OpenShift 4 é›†ç¾¤æ—¶å­˜åœ¨éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè¯¥ä¸»æœºå°†æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œéœ€æ›´æ¢æ–°çš„ä¸»æœºå†æ¬¡è°ƒé…åŠ å…¥é›†ç¾¤ã€‚  </li>\n<li>è‹¥å­˜åœ¨é—®é¢˜çš„ Ignition é…ç½®å¼•èµ·ä¸»æœºé…ç½®çš„å¤±è´¥ï¼ŒIgnition å°†ä¸å†å°è¯•ä½¿ç”¨ç›¸åŒçš„é…ç½®æ¥è°ƒé…å¦ä¸€å°ä¸»æœºã€‚  </li>\n<li>ç”±äº Ignition å¯ä½¿ç”¨å®Œæ•´çš„ç©ºç£ç›˜ï¼Œå®ƒèƒ½å®ç° cloud-init æ— æ³•å®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚ä½¿ç”¨ PXE å¼•å¯¼ä»ç©ºç£ç›˜è°ƒé…è£¸æœºç³»ç»Ÿã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Ignition-å¯¹-OpenShift-4-é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\"><a href=\"#Ignition-å¯¹-OpenShift-4-é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\" class=\"headerlink\" title=\"Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\"></a>Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š</h3><ul>\n<li>åœ¨ OpenShift 4 é›†ç¾¤ä¸­çš„ RHCOS ä¸»æœºä¸Š Ignition çš„å¤„ç†æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š  <ul>\n<li>1ï¸âƒ£ æ§åˆ¶å¹³é¢ä¸»æœºï¼ˆ<code>control plane machines</code>ï¼‰ä»å¼•å¯¼ä¸»æœºï¼ˆ<code>bootstrap machine</code>ï¼‰è·å– Ignition é…ç½®æ–‡ä»¶ï¼Œè€Œå·¥ä½œä¸»æœºï¼ˆ<code>worker machines</code>ï¼‰ä»æ§åˆ¶å¹³é¢ä¸»æœºè·å– Ignition é…ç½®æ–‡ä»¶ã€‚  </li>\n<li>2ï¸âƒ£ Ignition åœ¨ä¸»æœºä¸Šåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç›®å½•ä¸é“¾æ¥ï¼Œå®ƒæ”¯æŒ RAID é˜µåˆ—ä½†ä¸æ”¯æŒ LVM é€»è¾‘å·ã€‚  </li>\n<li>3ï¸âƒ£ Igition åœ¨ initramfs ä¸­æŒ‚è½½ root æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿäº <code>/sysroot</code> ç›®å½•å¹¶åœ¨ <code>/sysroot</code> ç›®å½•ä¸­å·¥ä½œã€‚  </li>\n<li>4ï¸âƒ£ Ignition é…ç½®æ‰€æœ‰å®šä¹‰çš„æ–‡ä»¶ç³»ç»Ÿå¹¶æ°å½“åœ°æŒ‚è½½å®ƒä»¬ã€‚  </li>\n<li>5ï¸âƒ£ Ignition è¿è¡Œ <code>systemd</code> ä¸´æ—¶æ–‡ä»¶ä»¥å¡«å……åœ¨ <code>/var</code> ç›®å½•ä¸­çš„æ‰€éœ€æ–‡ä»¶ã€‚  </li>\n<li>6ï¸âƒ£ Ignition è¿è¡Œå…¶é…ç½®æ–‡ä»¶æ¥é…ç½®ç”¨æˆ·ã€systemd å•å…ƒæ–‡ä»¶ä¸å…¶ä»–é…ç½®æ–‡ä»¶ã€‚  </li>\n<li>7ï¸âƒ£ Ignition å¸è½½åœ¨ initramfs ä¸­æŒ‚è½½çš„æŒä¹…åŒ–ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç»„ä»¶ã€‚  </li>\n<li>8ï¸âƒ£ Ignition å¯åŠ¨æ–°ä¸»æœºçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯åŠ¨ç³»ç»Ÿå¼•å¯¼é˜¶æ®µçš„æ‰€æœ‰å…¶ä»–çš„æœåŠ¡ã€‚</li>\n</ul>\n</li>\n<li>å¤„ç†ç»“æŸåï¼Œä¸»æœºå·²åšå¥½åŠ å…¥é›†ç¾¤çš„å‡†å¤‡å¹¶ä¸”æ— éœ€é‡å¯ï¼Œä¸å‰æ–‡æ‰€è¿°ç›¸åŒã€‚</li>\n</ul>\n<h3 id=\"Fedora-CoreOS-çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\"><a href=\"#Fedora-CoreOS-çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\" class=\"headerlink\" title=\"Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\"></a>Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š</h3><ul>\n<li>FCOS æ”¯æŒåœ¨å¤šç§ IaaS ç¯å¢ƒä¸‹è¿è¡Œã€‚</li>\n<li>Fedora CoreOS live ISO ç‰ˆæœ¬ï¼šfedora-coreos-36.20220906.3.2-live.x86_64.iso</li>\n<li>Butane å·¥å…·ï¼š  <ul>\n<li>linux ç‰ˆæœ¬ï¼š<a href=\"https://github.com/coreos/butane/releases/download/v0.15.0/butane-x86_64-unknown-linux-gnu\" target=\"_blank\" rel=\"noopener\">0.15.0</a>  </li>\n<li>è¯¥å·¥å…·æ¥æºäº <a href=\"https://github.com/coreos/butane\" target=\"_blank\" rel=\"noopener\">coreos/butane</a> é¡¹ç›®  </li>\n<li><code>Butane</code> ä»¥å‰ç§°ä¸º Fedora CoreOS é…ç½®è½¬æ¢å™¨ï¼ˆFedora CoreOS Config Transpilerï¼Œ<code>FCCT</code>ï¼‰ï¼Œå®ƒå¯å°† Butane é…ç½®æ–‡ä»¶ï¼ˆButane Configï¼‰æˆ–ç§° FCC æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition Configï¼‰ï¼Œè¯¥æ–‡ä»¶ä¸º <code>JSON</code> æ ¼å¼å°†è¢« FCOS ä¸»æœºåœ¨é¦–æ¬¡å¼•å¯¼è°ƒé…æ—¶ä½¿ç”¨ï¼Œå¯ç”¨äºåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  </li>\n<li>âœ¨ å…¶ä¸­ Butane é…ç½®æ–‡ä»¶ä¸º <code>YAML</code> æ ¼å¼ï¼Œå…³äºè¯¥æ–‡ä»¶ä¸åŒç‰ˆæœ¬çš„é…ç½®è§„èŒƒï¼ˆconfiguration specificationsï¼‰è¯·å‚è€ƒè¯¥ <a href=\"https://github.com/coreos/butane/blob/main/docs/specs.md\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ã€‚  </li>\n<li>âœ¨ Butane é…ç½®æ–‡ä»¶ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒè¯¥ <a href=\"https://github.com/coreos/butane/blob/main/docs/examples.md\" target=\"_blank\" rel=\"noopener\">Examples</a>ã€‚  </li>\n<li>å¯åœ¨è‡ªå·±æŒ‡å®šçš„èŠ‚ç‚¹ï¼ˆé FCOS ä¸»æœºï¼‰ä¸Šå®‰è£… butaneï¼Œå®‰è£…æ–¹å¼åŒ…æ‹¬ butane å®¹å™¨é•œåƒï¼ˆ<code>quay.io/coreos/butane:release</code>ï¼‰ã€rpm è½¯ä»¶åŒ…æˆ–ç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆstandalone binaryï¼‰ï¼Œæ­¤å¤„ä½¿ç”¨ä»¥ä¸Šé“¾æ¥çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚<img src=\"quay-coreos-butane-release.png\" alt=\"quay-coreos-butane-release.png\">  </li>\n<li>butane çš„ä½¿ç”¨æ–¹æ³•å¯å‚è€ƒè¯¥ <a href=\"https://github.com/coreos/butane/blob/main/docs/getting-started.md\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ã€‚</li>\n</ul>\n</li>\n<li>ignition-validate å·¥å…·ï¼š  <ul>\n<li>linux ç‰ˆæœ¬ï¼š<a href=\"https://github.com/coreos/ignition/releases/download/v2.14.0/ignition-validate-x86_64-linux\" target=\"_blank\" rel=\"noopener\">2.14.0</a>  </li>\n<li>è¯¥å·¥å…·æ¥æºäº <a href=\"https://github.com/coreos/ignition\" target=\"_blank\" rel=\"noopener\">coreos/ignition</a> é¡¹ç›®  </li>\n<li>è¯¥å·¥å…·ç”¨äºå¯¹ Ignition é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸åˆæ³•æ€§å­—æ®µçš„éªŒè¯ï¼Œè‹¥è¯­æ³•ä¸åˆè§„å°†æ— æ³•åœ¨ FCOS ä¸­ä½¿ç”¨ <code>coreos-installer</code> äºç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶å®‰è£…ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Fedora-CoreOS-çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\"><a href=\"#Fedora-CoreOS-çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\" class=\"headerlink\" title=\"Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\"></a>Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š</h3><ul>\n<li><p>å‡†å¤‡ HTTP æœåŠ¡å™¨ã€Ignition é…ç½®æ–‡ä»¶ä¸ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆé FCOS èŠ‚ç‚¹ï¼‰ï¼š  </p>\n<blockquote>\n<p>â— æ³¨æ„ï¼š</p>\n<ol>\n<li><p>æœ¬æ–‡å®‰è£…é‡‡ç”¨åŸºäº KVM è™šæ‹Ÿæœºæ¨¡æ‹Ÿè£¸é‡‘å±å®‰è£…ç¯å¢ƒã€‚</p>\n</li>\n<li><p>å…³äº <code>butane</code> å·¥å…·ä¸ <code>ignition-validate</code> å·¥å…·çš„å®‰è£…å¦‚å‰æ–‡æ‰€è¿°ã€‚</p>\n</li>\n<li><p>ğŸ’â€â™‚ï¸ æœ¬æ–‡ä½¿ç”¨ FCOS live ISO çš„æ–¹å¼å¼•å¯¼å¹¶ä½¿ç”¨å…¶ä¸­çš„ coreos-installer å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼Œè‹¥ä½¿ç”¨ PXE æ–¹å¼å¼•å¯¼å®‰è£…è¯·å‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚</p>\n</li>\n</ol>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install httpd</span><br><span class=\"line\">$ sudo systemctl <span class=\"built_in\">enable</span> --now httpd.service</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…ä¸å¯åŠ¨ httpd æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯</span></span><br><span class=\"line\">$ ssh-keygen -N <span class=\"string\">''</span> -t rsa -f ~/.ssh/core_fcos_login</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç”¨äº SSH å…å¯†ç™»å½• FCOS çš„å…¬ç§é’¥ï¼Œæ­¤å¤„å°†è¯¥ SSH å…¬é’¥æ‹·è´è‡³ Butane é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\"># çš„ ssh_authorized_keys å­—æ®µä¸­ã€‚</span></span><br><span class=\"line\">$ mkdir ~/fcos &amp;&amp; <span class=\"built_in\">cd</span> ~/fcos</span><br><span class=\"line\">$ vim fcos-customized-config.yml</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Butane é…ç½®æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>\n<p>è¯¥é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¯¥é…ç½®æ–‡ä»¶å¯å‚çœ‹å‰æ–‡ GitHub Butane çš„ Examples æˆ– Fedora CoreOS å®˜æ–¹æ–‡æ¡£</span></span><br><span class=\"line\"><span class=\"comment\"># çš„ Storage éƒ¨åˆ†è¿›è¡Œç¼–è¾‘ã€‚</span></span><br><span class=\"line\"><span class=\"attr\">variant:</span> <span class=\"string\">fcos</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">1.1</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·ã€å¯†ç ã€home å®¶ç›®å½•ä¸é…ç½® SSH å…å¯†ç™»å½•çš„å…¬é’¥</span></span><br><span class=\"line\"><span class=\"attr\">passwd:</span></span><br><span class=\"line\">  <span class=\"attr\">users:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">core</span></span><br><span class=\"line\">      <span class=\"attr\">ssh_authorized_keys:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">ssh-rsa</span> <span class=\"string\">AAAAB3Nz...jnXfG+Uj</span> <span class=\"string\">godev@cloud-ctl.domain12.example.com</span></span><br><span class=\"line\">      <span class=\"comment\"># ç”±äº FCOS/RHCOS åœ¨å®‰è£…å®Œæˆåæ— æ³•ä½¿ç”¨å¯†ç ç›´æ¥ç™»å½•ï¼Œè¯¥å…¬é’¥ç”¨äº core ç”¨æˆ·çš„</span></span><br><span class=\"line\">      <span class=\"comment\"># SSH å…å¯†ç™»å½•ã€‚</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cloud-admin</span></span><br><span class=\"line\">      <span class=\"attr\">password_hash:</span> <span class=\"string\">$y$j9T$j0ODWvNUDSXcEcwpDH141.$dvAEVxBHUWbW/NnPd90qkg0Haq6vgkcKF151jvLDgYA</span></span><br><span class=\"line\">      <span class=\"comment\"># æ˜æ–‡å¯†ç  redhat é€šè¿‡ hash åŠ å¯†çš„å¯†æ–‡</span></span><br><span class=\"line\">      <span class=\"comment\"># è™½ç„¶è¯¥ç”¨æˆ·å·²é…ç½®å¯†ç ï¼Œä½†æ— æ³•é€šè¿‡ SSH è¿œç¨‹ç™»å½•ï¼Œè¯¥å¯†ç åªå…è®¸æœ¬åœ°æ§åˆ¶å°ç™»å½•ã€‚</span></span><br><span class=\"line\">      <span class=\"attr\">home_dir:</span> <span class=\"string\">/opt/cloud-admin</span></span><br><span class=\"line\">      <span class=\"attr\">no_create_home:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">groups:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">wheel</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">/bin/bash</span></span><br><span class=\"line\">      <span class=\"comment\"># æ³¨æ„ï¼šå½“ä»»ä½•ç”¨æˆ· SSH è¿œç¨‹ç™»å½•å¤±æ•ˆæ—¶ï¼Œå¯ç”¨è¯¥ç”¨æˆ·æœ¬åœ°ç™»å½•å¹¶ææƒï¼</span></span><br><span class=\"line\"><span class=\"attr\">storage:</span></span><br><span class=\"line\">  <span class=\"comment\"># å°†æœ¬åœ°æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å†…å®¹æ³¨å…¥ FCOS çš„å¯¹åº”æ–‡ä»¶ä¸­ï¼Œéœ€ä½¿ç”¨ butane å·¥å…·çš„</span></span><br><span class=\"line\">  <span class=\"comment\"># --files-dir é€‰é¡¹ã€‚</span></span><br><span class=\"line\">  <span class=\"attr\">files:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">\"/etc/NetworkManager/system-connections/Wired connection 1.nmconnection\"</span></span><br><span class=\"line\">      <span class=\"attr\">contents:</span></span><br><span class=\"line\">        <span class=\"attr\">local:</span> <span class=\"string\">./Wired_connection_1.nmconnection</span>      </span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"number\">0600</span></span><br><span class=\"line\">      <span class=\"comment\"># FCOS çš„ç½‘ç»œæ¥å£é…ç½®</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">contents:</span></span><br><span class=\"line\">        <span class=\"attr\">local:</span> <span class=\"string\">./hostname</span></span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"number\">0644</span></span><br><span class=\"line\">      <span class=\"comment\"># FCOS çš„ä¸»æœºåé…ç½®</span></span><br><span class=\"line\">  <span class=\"comment\"># å°† FCOS çš„ /dev/vdb è¿›è¡Œåˆ†åŒºå¹¶æŒ‚è½½è‡³ /var ç›®å½•ï¼Œä¸»è¦ç”¨äºå®¹å™¨ä¸é•œåƒçš„å­˜å‚¨ã€‚</span></span><br><span class=\"line\">  <span class=\"comment\"># æ³¨æ„ï¼šIgnition ä¸æ”¯æŒå¯¹ FCOS/RHCOS çš„ LVM é€»è¾‘å·åŠŸèƒ½ï¼</span></span><br><span class=\"line\">  <span class=\"attr\">disks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">device:</span> <span class=\"string\">/dev/vdb</span></span><br><span class=\"line\">      <span class=\"attr\">wipe_table:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">partitions:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">number:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">label:</span> <span class=\"string\">var</span></span><br><span class=\"line\">  <span class=\"attr\">filesystems:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/var</span></span><br><span class=\"line\">      <span class=\"attr\">device:</span> <span class=\"string\">/dev/disk/by-partlabel/var</span></span><br><span class=\"line\">      <span class=\"attr\">format:</span> <span class=\"string\">xfs</span></span><br><span class=\"line\">      <span class=\"attr\">wipe_filesystem:</span> <span class=\"literal\">true</span> </span><br><span class=\"line\">      <span class=\"attr\">label:</span> <span class=\"string\">var</span></span><br><span class=\"line\">      <span class=\"attr\">with_mount_unit:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Š YAML æ–‡ä»¶å¯ç‚¹å‡» <a href=\"https://github.com/Alberthua-Perl/scripts-confs/tree/master/fedora-coreos-36\" target=\"_blank\" rel=\"noopener\">æ­¤å¤„</a> è·å¾—ã€‚ </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat ./hostname</span><br><span class=\"line\">  fcos36-cloud.lab.example.com</span><br><span class=\"line\">$ cat ./Wired_connection_1.nmconnection </span><br><span class=\"line\">  [connection]</span><br><span class=\"line\">  id=Wired connection 1</span><br><span class=\"line\">  <span class=\"built_in\">type</span>=ethernet</span><br><span class=\"line\">  autoconnect-priority=-999</span><br><span class=\"line\">  interface-name=ens3</span><br><span class=\"line\"></span><br><span class=\"line\">  [ethernet]</span><br><span class=\"line\"></span><br><span class=\"line\">  [ipv4]</span><br><span class=\"line\">  address1=192.168.110.13/24,192.168.110.1</span><br><span class=\"line\">  dns=192.168.110.1;</span><br><span class=\"line\">  method=manual</span><br><span class=\"line\"></span><br><span class=\"line\">$ butane --files-dir . \\</span><br><span class=\"line\">  --pretty --strict \\</span><br><span class=\"line\">  --output fcos-customized-config.ign fcos-customized-config.yml</span><br><span class=\"line\"><span class=\"comment\"># åœ¨å½“å‰ç›®å½•ä¸­æ ¹æ® Butane é…ç½®æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\">$ ignition-validate fcos-customized-config.ign</span><br><span class=\"line\"><span class=\"comment\"># éªŒè¯ Ignition é…ç½®æ–‡ä»¶è¯­æ³•çš„åˆæ³•æ€§ï¼Œè‹¥æ— è¿”å›åˆ™éªŒè¯é€šè¿‡ï¼Œè¯¥æ–‡ä»¶å¯ç”¨äº FCOS çš„å®‰è£…ã€‚</span></span><br><span class=\"line\">$ sudo cp fcos-customized-config.ign /var/www/html/</span><br><span class=\"line\"><span class=\"comment\"># æ‹·è´è¯¥æ–‡ä»¶è‡³ HTTP æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸­ç”¨äº FCOS ä¸­ coreos-installer å·¥å…·çš„ä¸‹è½½</span></span><br><span class=\"line\"><span class=\"comment\"># è¯»å–ä¸ç³»ç»Ÿå®‰è£…ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»º FCOS è™šæ‹Ÿæœºå¹¶ä½¿ç”¨ FCOS live ISO å¼•å¯¼å®‰è£…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"use-fedora-coreos-live-to-install.png\" alt=\"use-fedora-coreos-live-to-install.png\"><img src=\"login-fedora-coreos-live.png\" alt=\"login-fedora-coreos-live.png\"><br>ğŸ‘‰ <code>core</code> ç”¨æˆ·å¯ <code>sudo</code> å…å¯†ææƒä¸º root ç”¨æˆ·ã€‚<br>ğŸ‘‰ ä½¿ç”¨ <code>core</code> ç”¨æˆ·æ­£å¸¸ç™»å½•åï¼Œå†ä½¿ç”¨ <code>ip -br a s</code> å‘½ä»¤æŸ¥çœ‹ä¸»æœºçš„ IP åœ°å€ï¼ˆä¸€èˆ¬å¯é€šè¿‡ <code>DHCP</code> è‡ªåŠ¨è·å–ï¼‰ï¼Œè‹¥æ— ä¸ HTTP æœåŠ¡å™¨é€šä¿¡çš„ IP åœ°å€ï¼Œå°†æ— æ³•ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶è€Œå®‰è£…å¤±è´¥ï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤ä¸´æ—¶é…ç½®åŠ ä»¥ç”Ÿæ•ˆï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ip address add 192.168.110.13/24 dev ens3</span><br><span class=\"line\"><span class=\"comment\"># éœ€æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´ IP åœ°å€ä¸å¯¹åº”çš„ç½‘ç»œæ¥å£</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ‘‰ ä½¿ç”¨ FCOS live ISO è‡ªå¸¦çš„ <code>coreos-installer</code> å·¥å…·æ ¹æ® Ignition é…ç½®æ–‡ä»¶å®‰è£…éƒ¨ç½²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"coreos-installer-customized-install.png\" alt=\"coreos-installer-customized-install.png\">  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo coreos-installer install \\</span><br><span class=\"line\">  --insecure-ignition \\</span><br><span class=\"line\">  --ignition-url http://192.168.110.130/fcos-customized-config.ign \\</span><br><span class=\"line\">  /dev/vda</span><br><span class=\"line\"><span class=\"comment\"># ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶å¹¶å°†æ ¹ç³»ç»Ÿå®‰è£…äº /dev/vda ä¸­</span></span><br><span class=\"line\"><span class=\"comment\"># æ­¤å®‰è£…è¿‡ç¨‹æ ¹æ®æ‰€é…ç½®çš„å†…å®¹ä¸åŒè€—æ—¶ä¹Ÿå°†ä¸åŒï¼ˆç¬”è€…ç¯å¢ƒä¸­å®‰è£…è¾ƒå¿«ï¼‰</span></span><br><span class=\"line\">$ sudo reboot</span><br><span class=\"line\"><span class=\"comment\"># é‡å¯ç³»ç»Ÿ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç™»å½• FCOS éªŒè¯å®‰è£…çŠ¶æ€ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh -i ~/.ssh/core_fcos_login core@fcos36-cloud</span><br><span class=\"line\">  Fedora CoreOS 36.20221001.3.0</span><br><span class=\"line\">  Tracker: https://github.com/coreos/fedora-coreos-tracker</span><br><span class=\"line\">  Discuss: https://discussion.fedoraproject.org/tag/coreos</span><br><span class=\"line\"></span><br><span class=\"line\">  Last login: Mon Oct 24 14:07:00 2022 from 192.168.110.130</span><br><span class=\"line\">  [core@fcos36-cloud ~]$ sudo -i</span><br><span class=\"line\">  [root@fcos36-cloud ~]<span class=\"comment\"># id cloud-admin</span></span><br><span class=\"line\">  uid=1001(cloud-admin) gid=1001(cloud-admin) groups=1001(cloud-admin),10(wheel)</span><br><span class=\"line\">  [root@fcos36-cloud ~]<span class=\"comment\"># su - cloud-admin</span></span><br><span class=\"line\">  [cloud-admin@fcos36-cloud ~]$ sudo -i</span><br><span class=\"line\">  [sudo] password <span class=\"keyword\">for</span> cloud-admin: </span><br><span class=\"line\">  [root@fcos36-cloud ~]<span class=\"comment\"># lsblk --paths</span></span><br><span class=\"line\">  NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class=\"line\">  /dev/sr0     11:0    1 1024M  0 rom  </span><br><span class=\"line\">  /dev/vda    252:0    0   10G  0 disk </span><br><span class=\"line\">  |-/dev/vda1 252:1    0    1M  0 part </span><br><span class=\"line\">  |-/dev/vda2 252:2    0  127M  0 part </span><br><span class=\"line\">  |-/dev/vda3 252:3    0  384M  0 part /boot</span><br><span class=\"line\">  `-/dev/vda4 252:4    0  9.5G  0 part /sysroot/ostree/deploy/fedora-coreos/var</span><br><span class=\"line\">                                       /usr</span><br><span class=\"line\">                                       /etc</span><br><span class=\"line\">                                       /</span><br><span class=\"line\">                                       /sysroot</span><br><span class=\"line\">  /dev/vdb    252:16   0   10G  0 disk </span><br><span class=\"line\">  `-/dev/vdb1 252:17   0   10G  0 part /var </span><br><span class=\"line\"><span class=\"comment\"># Ignition é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®åœ¨ FCOS ä¸­å·²ç”Ÿæ•ˆ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç”±äº FCOS ä¸­ä½¿ç”¨ <code>rpm-ostree</code> è¿›è¡Œè½¯ä»¶åŒ…çš„ç®¡ç†ï¼Œè‹¥éœ€å®‰è£…é¢å¤–çš„è½¯ä»¶åŒ…ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo rpm-ostree install \\</span><br><span class=\"line\">  podman skopeo buildah cri-o cri-tools vim-enhanced</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…å®¹å™¨ä¸é•œåƒç®¡ç†å·¥å…·</span></span><br><span class=\"line\">$ sudo systemctl status crio.service</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ CRI-O å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ï¼Œå¯é€šè¿‡ crictl å‘½ä»¤æµ‹è¯•ç®¡ç†å®¹å™¨ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://fedoramagazine.org/introducing-fedora-coreos/\" target=\"_blank\" rel=\"noopener\">Introducing Fedora CoreOS</a></li>\n<li><a href=\"https://fedoramagazine.org/getting-started-with-fedora-coreos/\" target=\"_blank\" rel=\"noopener\">Getting started with Fedora CoreOS</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Vf6TvGSi5sNnMjT5QldUQg\" target=\"_blank\" rel=\"noopener\">Fedora CoreOS å…¥é—¨ | Linux ä¸­å›½</a></li>\n<li>â¤ <a href=\"https://docs.fedoraproject.org/en-US/fedora-coreos/\" target=\"_blank\" rel=\"noopener\">Fedora CoreOS Documentation</a></li>\n<li><a href=\"https://docs.openshift.com/container-platform/4.11/architecture/architecture-rhcos.html\" target=\"_blank\" rel=\"noopener\">Red Hat Enterprise Linux CoreOS (RHCOS)</a></li>\n<li>â¤ <a href=\"https://developers.redhat.com/blog/2020/03/12/how-to-customize-fedora-coreos-for-dedicated-workloads-with-ostree#\" target=\"_blank\" rel=\"noopener\">How to customize Fedora CoreOS for dedicated workloads with OSTree</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>å…³é”®æŠ€æœ¯ç‚¹</li>\n<li>Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§</li>\n<li>Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹</li>\n<li>Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåº</li>\n<li>Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜</li>\n<li>Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"å…³é”®æŠ€æœ¯ç‚¹ï¼š\"><a href=\"#å…³é”®æŠ€æœ¯ç‚¹ï¼š\" class=\"headerlink\" title=\"å…³é”®æŠ€æœ¯ç‚¹ï¼š\"></a>å…³é”®æŠ€æœ¯ç‚¹ï¼š</h3><ul>\n<li>ä»¥ä¸‹æŠ€æœ¯ç‚¹åœ¨æ–‡ä¸­å°†æ ¹æ® Fedora CoreOS åŠ RHCOS ä¸­å±•å¼€è¯´æ˜ï¼š  <ul>\n<li>ignition, butane, ignition-validate  </li>\n<li>ostree, rpm-tree,zincati, bootupd</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Fedora-CoreOS-åŠ-RHCOS-ä»‹ç»ä¸ç‰¹æ€§ï¼š\"><a href=\"#Fedora-CoreOS-åŠ-RHCOS-ä»‹ç»ä¸ç‰¹æ€§ï¼š\" class=\"headerlink\" title=\"Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§ï¼š\"></a>Fedora CoreOS åŠ RHCOS ä»‹ç»ä¸ç‰¹æ€§ï¼š</h3><ul>\n<li>åœ¨ OpenShift 4 å®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨å®‰è£… CoreOS çš„å•†ä¸šç‰ˆ Red Hat Enterprise Linux CoreOSï¼ˆç®€ç§° <code>RHCOS</code>ï¼‰ã€‚æ ¹æ® OpenShift 4 çš„æ–‡æ¡£è¯´æ˜ï¼ŒRHCOS æ— æ³•ç‹¬ç«‹è¿è¡Œå®‰è£…ï¼Œå®ƒå¿…é¡»å’Œ OpenShift 4 ä¸€èµ·è¿è¡Œï¼ˆå› æ­¤ RHCOS æ²¡æœ‰å•ç‹¬çš„è®¢é˜…ï¼‰ã€‚</li>\n<li>ğŸ˜ƒ ä¸è¿‡å¥½åœ¨ CoreOS è¿˜æä¾›äº†å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ç¤¾åŒºç‰ˆ <code>Fedora CoreOS</code>ï¼ˆç®€ç§° <code>FCOS</code>ï¼‰å¯ä»¥å®Œå…¨å…è´¹ä½¿ç”¨ã€‚ç”±äº FCOS å¯ä»¥æ— éœ€ OpenShift 4 ä¹Ÿå¯ä»¥ç‹¬ç«‹å®‰è£…è¿è¡Œï¼Œå› æ­¤ä½¿ç”¨ FCOS ä½œä¸ºç ”ç©¶ç¯å¢ƒï¼Œè€Œç›¸å…³æ“ä½œåŸºæœ¬éƒ½å¯é€‚ç”¨ RHCOS ç¯å¢ƒã€‚</li>\n<li>FCOS/RHCOS æ˜¯ Red Hat åœ¨æ”¶è´­ CoreOS å…¬å¸åç»“åˆ <code>CoreOS Container Linux</code> å’Œ <code>Fedora Atomic Host</code> çš„ä¼˜ç‚¹æ¨å‡ºçš„æ–°ä¸€ä»£å®¹å™¨æ“ä½œç³»ç»Ÿï¼Œå…¶ç›®æ ‡æ˜¯æä¾›æœ€ä½³çš„å®¹å™¨ä¸»æœºï¼Œä»è€Œèƒ½å®‰å…¨ã€å¤§è§„æ¨¡åœ°è¿è¡Œå®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½ã€‚</li>\n<li>FCOS/RHCOS å°† <a href=\"https://github.com/coreos/ignition\" target=\"_blank\" rel=\"noopener\">Ignition</a>ï¼ˆç‚¹ç«ï¼‰ ä¸ rpm-ostree ç­‰æŠ€æœ¯ç›¸é›†æˆï¼Œæ˜¯ä¸€ä¸ªè‡ªåŠ¨æ›´æ–°çš„ã€æœ€å°çš„ã€æ•´ä½“çš„ã€å¯¹è¿è¡Œå®¹å™¨å’Œ Kubernetes è¿›è¡Œäº†ä¼˜åŒ–çš„æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºå®ƒä»¬æ›´ç¬¦åˆ â€œä¸å¯å˜æ¶æ„â€ï¼ˆ<code>Immutable Infrastructure</code>ï¼‰ç†å¿µï¼Œå› æ­¤æˆä¸º Red Hat æ¨èçš„ OpenShift 4 åº•å±‚æ“ä½œç³»ç»Ÿã€‚</li>\n<li>FCOS/RHCOS çš„å®‰è£…åŠé…ç½®è¿‡ç¨‹å’Œä¸€èˆ¬çš„ RHEL ç¨æœ‰å·®åˆ«ï¼Œéœ€è¦é€šè¿‡ Ignition é…ç½®æ–‡ä»¶åœ¨å®‰è£…çš„æ—¶å€™åˆå§‹åŒ–ç½‘ç»œã€å­˜å‚¨ã€å†…æ ¸ã€ç”¨æˆ·ç­‰æ–¹é¢çš„é…ç½®ã€‚</li>\n<li>FCOS çš„è®¾è®¡ç†å¿µï¼š  <ul>\n<li>ğŸ³ ç”±äºå®¹å™¨å…è®¸å°†å·¥ä½œè´Ÿè½½é‡å¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¹¶è‡ªåŠ¨æ‰©å±•ä»¥æ»¡è¶³éœ€æ±‚ã€‚å®¹å™¨æä¾›çš„éš”ç¦»æ„å‘³ç€ä¸»æœºæ“ä½œç³»ç»Ÿå¯ä»¥å¾ˆå°ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ª <code>Linux kernel</code>ã€<code>systemd</code>ã€<code>container runtime</code> å’Œä¸€äº›é™„åŠ æœåŠ¡ï¼ˆå¦‚ SSH æœåŠ¡å™¨ï¼‰ã€‚  </li>\n<li>FCOS æ˜¯ä¸“é—¨ä¸ºå®¹å™¨å·¥ä½œè´Ÿè½½è€Œè®¾è®¡çš„ï¼Œæ— éœ€å®šæœŸç»´æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨æœ€æ–°çš„æ“ä½œç³»ç»Ÿæ”¹è¿›ã€bug ä¿®å¤å’Œå®‰å…¨è‡ªåŠ¨æ›´æ–°ï¼Œå…¶ä½¿ç”¨ Ignition ä¸ºè‡ªèº«æä¾›æœåŠ¡ï¼Œä½¿ç”¨ <code>Podman</code> å’Œ <code>Moby</code> è¿è¡Œå®¹å™¨ï¼Œå¹¶ä½¿ç”¨ <code>rpm-ostree</code> è‡ªåŠ¨è¿›è¡ŒåŸå­æ›´æ–°ã€‚<blockquote>\n<p>â— æ³¨æ„ï¼š</p>\n<ol>\n<li><p>FCOS æ”¯æŒ <code>CRI-O</code> ä½œä¸ºå®¹å™¨å¼•æ“ï¼Œå¸¸ç”¨äº OpenShift 4 çš„åº•å±‚å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ CRI-O è¿è¡Œå®¹å™¨ï¼ŒOpenShift 4 å¯é€šè¿‡ <code>CRI</code> æ¥å£åˆ›å»ºä¸ç®¡ç† Podã€‚</p>\n</li>\n<li><p>å¯é€šè¿‡ <code>crictl</code> å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸ç®¡ç†å®¹å™¨åŠ Podï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹ç”¨äºå®¹å™¨æˆ– pod çš„è°ƒè¯•è€Œéå®¹å™¨æˆ– pod çš„åˆ›å»ºã€‚</p>\n</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>FCOS è°ƒé…ä¸å¯å˜æ¶æ„ï¼š  <ul>\n<li>åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼ï¼ˆ<code>first boot</code>ï¼‰é˜¶æ®µï¼ŒFCOS ä½¿ç”¨ Ignition è°ƒé…ç³»ç»Ÿã€‚  </li>\n<li>Ignition è¯»å–ç”¨æˆ·æä¾›çš„æ•°æ®æˆ–è¿œç¨‹ URL åœ°å€æä¾›çš„ Ignition é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨å®ƒåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  </li>\n<li>è°ƒé…ä¸»æœºçš„æ–¹å¼ï¼š    <ul>\n<li>ç¼–è¾‘åŸºäº YAML æ ¼å¼çš„ <code>Fedora CoreOS Config</code>ï¼ˆFCCï¼‰æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡å®šä¸»æœºçš„æœŸæœ›é…ç½®ï¼ŒFCC æ”¯æŒæ‰€æœ‰çš„ Ignition åŠŸèƒ½ï¼Œä¹Ÿæä¾›é¢å¤–çš„è¯­æ³•ã€‚    </li>\n<li>ä½¿ç”¨ <code>Fedora CoreOS Config Transpiler (Butane)</code> å·¥å…·å°† FCC æ–‡ä»¶ï¼ˆ<code>.fcc</code>ï¼‰è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆ<code>.ign</code>ï¼‰ã€‚    </li>\n<li>å¯åŠ¨ FCOS ä¸»æœºå¹¶å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä¸»æœºä¸­è°ƒé…ç³»ç»Ÿçš„å®‰è£…ã€‚    <blockquote>\n<p>ğŸ’â€â™‚ï¸ è°ƒé…ä¸»æœºçš„æ–¹æ³•ï¼š</p>\n<ol>\n<li><p>ä½¿ç”¨ PXE å¼•å¯¼å¹¶ä¸æŒ‡å®š Ignition é…ç½®æ–‡ä»¶è°ƒé…å®‰è£…ä¸»æœºã€‚</p>\n</li>\n<li><p>å°† Ignition é…ç½®æ–‡ä»¶åŒæ­¥è‡³ä½¿ç”¨ FCOS live ISO å¼•å¯¼å¯åŠ¨çš„ä¸»æœºä¸­ï¼Œå†ä½¿ç”¨ <code>coreos-installer</code> å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼ˆæœ¬æ–‡ä½¿ç”¨æ­¤æ–¹æ³•ï¼‰ã€‚  </p>\n</li>\n</ol>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>FCOS è¢«è®¾è®¡ä¸ºä¸å¯å˜æ¶æ„ã€‚åœ¨ä¸»æœºè¢«è°ƒé…ä¹‹åï¼Œä¸åº”è¯¥æ›´æ”¹ /etc ç›®å½•æˆ–é‡æ–°é…ç½®ä¸»æœºï¼Œç›¸åï¼Œæ›´æ”¹ FCC æ–‡ä»¶å¹¶ä¸”ä½¿ç”¨è¯¥æ–‡ä»¶è°ƒé…æ›¿æ¢çš„ä¸»æœºã€‚  </li>\n<li>ğŸ³ è¿™ç§æ–¹å¼ä¸å®¹å™¨ç®¡ç†ç›¸ä¼¼ï¼šå®¹å™¨é•œåƒä¸å¯è¢«åŸåœ°æ›´æ–°ï¼Œè€Œæ˜¯é‡å¤´æ„å»ºä¸é‡æ–°éƒ¨ç½²ã€‚è¯¥æ–¹å¼åœ¨è´Ÿè½½å¢åŠ æ—¶å®¹æ˜“æ¨ªå‘æ‰©å®¹ã€‚åªéœ€ç®€å•åœ°ä½¿ç”¨ç›¸åŒçš„ Ignition é…ç½®æ–‡ä»¶æ¥å¯åŠ¨å…¶ä»–ä¸»æœºã€‚</li>\n</ul>\n</li>\n<li><a href=\"https://getfedora.org/en/coreos/download?tab=metal_virtualized&amp;stream=stable&amp;arch=x86_64\" target=\"_blank\" rel=\"noopener\">FCOS å‘å¸ƒç‰ˆæœ¬</a>ï¼š<img src=\"fedora-coreos-release-version.png\" alt=\"fedora-coreos-release-version.png\">  <ul>\n<li><code>testing stream</code>ï¼š<br>å½“å‰ Fedora å‘è¡Œç‰ˆçš„å¸¸è§„å¿«ç…§ï¼ŒåŠ ä¸Šæ›´æ–°ã€‚  </li>\n<li>â¤ <code>stable stream</code>ï¼š<br>åœ¨æµ‹è¯•ç‰ˆæœ¬å¯ç”¨ä¸¤å‘¨åï¼Œå®ƒè¢«å‘é€åˆ°ç¨³å®šæµï¼Œåœ¨æµ‹è¯•ä¸­å‘ç°çš„ <code>bug</code> å°†åœ¨å‘å¸ƒç¨³å®šæµä¹‹å‰è¢«ä¿®å¤ã€‚  </li>\n<li><code>next stream</code>ï¼š<br>å³å°†å‘å¸ƒçš„ Fedora ç‰ˆæœ¬çš„å¸¸è§„å¿«ç…§ï¼Œå…è®¸æœ‰é¢å¤–çš„æ—¶é—´æµ‹è¯•è¾ƒå¤§çš„æ›´æ”¹ã€‚<br>ğŸ‘‰ æ¯ä¸ª stream æ¯ 2 å‘¨å‘å¸ƒä¸€æ¬¡ï¼Œæ›´æ–°å†…å®¹ä¼šä»ä¸€ä¸ª stream æ¨å¹¿åˆ°å¦ä¸€ä¸ª streamï¼ˆ<code>next -&gt; testing -&gt; stable</code>ï¼‰ã€‚è¿™æ ·è½åœ°åœ¨ stable stream ä¸­çš„æ›´æ–°å°±æœ‰æœºä¼šç»è¿‡é•¿æ—¶é—´çš„æµ‹è¯•ã€‚<br>ğŸ‘‰ æ‰€æœ‰ä¸‰ä¸ª stream éƒ½æ”¶åˆ°äº†å®‰å…¨æ›´æ–°å’Œå…³é”®çš„é”™è¯¯ä¿®å¤ï¼Œå¹¶æ—¨åœ¨å®‰å…¨åœ°ç”¨äºç”Ÿäº§ä½¿ç”¨ã€‚å¤§å¤šæ•°æœºå™¨åº”è¯¥è¿è¡Œ <code>stable stream</code>ï¼Œå› ä¸ºå®ƒæ¥å—æœ€å¤šçš„æµ‹è¯•ã€‚ä½†æ˜¯ï¼Œç”¨æˆ·åº”è¯¥åœ¨ next stream ä¸Šè¿è¡Œä»–ä»¬çš„éƒ¨åˆ†èŠ‚ç‚¹ï¼Œå¹¶å‘é—®é¢˜è·Ÿè¸ªå™¨æŠ¥å‘Šé—®é¢˜ã€‚è¿™æœ‰åŠ©äºç¡®ä¿åªå½±å“ç‰¹å®šå·¥ä½œè´Ÿè½½æˆ–ç‰¹å®šç¡¬ä»¶çš„ bug åœ¨ç¨³å®šä¹‹å‰å¾—åˆ°ä¿®å¤ã€‚</li>\n</ul>\n</li>\n<li>RHCOS çš„å…³é”®ç‰¹æ€§ï¼š  <ul>\n<li>ç³»ç»ŸåŸºäº RHEL å¼€å‘  </li>\n<li>å¯æ§åˆ¶çš„ä¸å¯å˜æ¶æ„ï¼ˆ<code>controlled immutability</code>ï¼‰  </li>\n<li>é»˜è®¤ä½¿ç”¨ <code>CRI-O</code> å®¹å™¨è¿è¡Œæ—¶  </li>\n<li>å¯ä½¿ç”¨å®¹å™¨å·¥å…·é›†ç®¡ç†å®¹å™¨æˆ– Podï¼ˆåŒ…æ‹¬ <code>podman</code>ã€<code>skopeo</code> ä¸ <code>crictl</code> ç­‰ï¼‰  </li>\n<li>ğŸ”¥ ä½¿ç”¨ <code>rpm-ostree</code> å®ç°äº‹åŠ¡æ€§æ›´æ–°å‡çº§ <blockquote>\n<p>â— æ³¨æ„ï¼š</p>\n<ol>\n<li><p><code>OSTree</code> æ˜¯ä¸€ä¸ªç”¨äºå¯¹åŸºäº Linux çš„æ“ä½œç³»ç»Ÿè¿›è¡Œç‰ˆæœ¬æ›´æ–°çš„ç³»ç»Ÿï¼Œå®ƒå¯ä»¥è¢«è§†ä¸º â€œé¢å‘æ“ä½œç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶çš„ gitâ€ï¼Œå®ƒè¢« endless OSã€Flatpakã€Fedoraã€CentOSã€Atomic Host å’Œ GNOME ç­‰é¡¹ç›®ç”¨æ¥æŒç»­äº¤ä»˜ï¼Œæœ‰å…³ OSTree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://ostreedev.github.io/ostree/\" target=\"_blank\" rel=\"noopener\">libostree å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>\n</li>\n<li><p>rpm-ostree æ˜¯ä¸€ä¸ªæ··åˆé•œåƒ/åŒ…ç³»ç»Ÿï¼Œä»¥å‘½ä»¤è¡Œä¸å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå¯å°†è½¯ä»¶åŒ…ä»¥åˆ†å±‚çš„å½¢å¼æ„å»ºåœ¨ OSTree ä¹‹ä¸Šï¼Œå°†è½¯ä»¶åŒ…ä½œä¸ºç³»ç»Ÿçš„æ‰©å±•ï¼Œå…³äº rpm-ostree æ›´å¤šè¯¦ç»†çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://coreos.github.io/rpm-ostree\" target=\"_blank\" rel=\"noopener\">rpm-ostree å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>\n</li>\n<li><p>FCOS ä¸­çš„ <code>zincati</code> æœåŠ¡ï¼ˆ<code>zincati.service</code>ï¼‰å¯æ£€æµ‹ç³»ç»Ÿçš„çŠ¶æ€ï¼Œé€šè¿‡ <code>rpm-ostreed</code> å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œæ›´æ–°ï¼Œè‹¥å…¶å‘ç°å…·æœ‰æ–°çš„ç³»ç»Ÿæ›´æ–°å°†è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿï¼Œå¯å°†è¯¥æœåŠ¡å…³é—­ä»¥ç¦ç”¨æ­¤åŠŸèƒ½ã€‚  </p>\n</li>\n</ol>\n</blockquote>\n</li>\n<li>ğŸ”¥ é’ˆå¯¹ <code>fireware</code> ä¸ <code>bootloader</code> çš„ <code>bootupd</code> æ›´æ–°å™¨ï¼Œbootupd å¯ä»¥å®ˆæŠ¤è¿›ç¨‹ <code>bootupd.service</code> çš„æ–¹å¼è¿è¡Œã€‚</li>\n<li>OpenShift 4 é›†ç¾¤é€šè¿‡ <code>Machine Config Operator (MCO)</code> æ›´æ–° RHCOS</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Ignition-åœ¨-FCOS-æˆ–-RHCOS-ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\"><a href=\"#Ignition-åœ¨-FCOS-æˆ–-RHCOS-ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\" class=\"headerlink\" title=\"Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š\"></a>Ignition åœ¨ FCOS æˆ– RHCOS ä¸­çš„å·¥ä½œç‰¹ç‚¹ï¼š</h3><ul>\n<li>Ignition æ˜¯ç”± FCOS/RHCOS ä½¿ç”¨çš„åœ¨ç³»ç»Ÿåˆå§‹åŒ–é…ç½®è¿‡ç¨‹ï¼ˆ<code>initramfs</code>ï¼‰ä¸­æ“çºµç£ç›˜çš„å·¥å…·ï¼Œå…¶å¯å®Œæˆå¸¸è§çš„ç£ç›˜ä»»åŠ¡ï¼ŒåŒ…æ‹¬ç£ç›˜åˆ†åŒºã€æ ¼å¼åŒ–åˆ†åŒºã€å†™æ–‡ä»¶ä¸é…ç½®ç”¨æˆ·ç­‰ã€‚</li>\n<li>åœ¨ç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶ï¼ˆfirst bootï¼‰ï¼ŒIgnition è¯»å–å®‰è£…ä»‹è´¨æˆ–æ‰€æŒ‡å®šçš„ Ignition é…ç½®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ã€‚</li>\n<li>âœ¨ Ignition çš„è°ƒé…æ–¹å¼ï¼š<br>Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition config fileï¼‰æˆ–ç§°ç‚¹ç«é…ç½®æ–‡ä»¶</li>\n<li>Ignition é…ç½®ä¸ <code>cloud-init</code> æˆ– <code>Linux Anaconda kickstart</code> é…ç½®ç³»ç»Ÿæå…¶ç›¸ä¼¼ï¼Œä½†å…¶å…·æœ‰è‡ªèº«çš„ç‰¹ç‚¹ï¼š  <ul>\n<li>ç”±äº Ignition èƒ½è¿›è¡Œç£ç›˜åˆ†åŒºã€è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸æ‰§è¡Œä¸»æœºæ°¸ä¹…æ–‡ä»¶ç³»ç»Ÿçš„å…¶ä»–æ”¹å˜ï¼Œå› æ­¤ï¼Œåœ¨å®‰è£… FCOS/RHCOS è¿‡ç¨‹ä¸­ Ignition è¿è¡Œäºä¸ç³»ç»Ÿç›¸éš”ç¦»çš„ <code>initial RAM disk</code> ä¸­ã€‚ä¸ä¹‹ç›¸å¯¹çš„ï¼Œcloud-init ä½œä¸ºåˆå§‹åŒ–ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ä¸èƒ½å®¹æ˜“åœ°å®ç°ç£ç›˜çš„åˆ†åŒºã€‚  </li>\n<li>âœ¨ Ignition ä¸ cloud-init å¯¹æ¯”ï¼š<ul>\n<li>Ignitionï¼š<ul>\n<li>å·¥ä½œé˜¶æ®µï¼šé¦–æ¬¡å¼•å¯¼å®‰è£…æœŸé—´</li>\n<li>å·¥ä½œæ¬¡æ•°ï¼šä¸€æ¬¡</li>\n<li>åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿç£ç›˜æ“ä½œç­‰</li>\n<li>å¸¸ç”¨åœºæ™¯ï¼šå®‰è£…éƒ¨ç½²</li>\n</ul>\n</li>\n<li>cloud-initï¼š<ul>\n<li>å·¥ä½œé˜¶æ®µï¼šä»»æ„ç³»ç»Ÿå¼•å¯¼æœŸé—´</li>\n<li>å·¥ä½œæ¬¡æ•°ï¼šå¤šæ¬¡</li>\n<li>åŠŸèƒ½å®ç°ï¼šç³»ç»Ÿé…ç½®ç­‰</li>\n<li>å¸¸ç”¨åœºæ™¯ï¼šç³»ç»Ÿé…ç½®</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Ignition ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿè€Œä¸æ˜¯æ›´æ”¹å·²å­˜åœ¨çš„ç³»ç»Ÿï¼ŒOpenShift 4 ä½¿ç”¨ <code>Machine Config Operator</code> å®Œæˆæ‰€æœ‰ä¸»æœºçš„é…ç½®ã€‚  </li>\n<li>Ignition ä»¥å£°æ˜å¼æ–¹å¼ï¼ˆdeclarative configurationï¼‰æ£€æŸ¥é…ç½®ä¸­çš„æ‰€æœ‰é…ç½®é¡¹ç›®ä»¥æ»¡è¶³æŒ‡å®šçš„è¦æ±‚ã€‚  </li>\n<li>âœ¨ åœ¨ Ignition å®Œæˆä¸»æœºé…ç½®åï¼Œkernel ä¿æŒè¿è¡Œä½†ä¸¢å¼ƒ initial RAM diskï¼Œå¹¶ä¸”è½¬å‘ï¼ˆpivot toï¼‰ç£ç›˜ä¸Šå·²å®‰è£…çš„ç³»ç»Ÿä¸­ã€‚æ— éœ€ç³»ç»Ÿé‡å¯ï¼Œæ‰€æœ‰çš„ç³»ç»ŸæœåŠ¡ä¸å…¶ä»–ç‰¹æ€§å³å¯å¯åŠ¨ã€‚  </li>\n<li>ç”±äº Ignition é€šè¿‡å£°æ˜å¼é…ç½®å°†ä¸»æœºè°ƒæ•´ä¸ºæŒ‡å®šçš„çŠ¶æ€ï¼Œå› æ­¤ä¸èƒ½å­˜åœ¨å…·æœ‰éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè‹¥åœ¨éƒ¨ç½² OpenShift 4 é›†ç¾¤æ—¶å­˜åœ¨éƒ¨åˆ†é…ç½®çš„ä¸»æœºï¼Œè¯¥ä¸»æœºå°†æ— æ³•åŠ å…¥é›†ç¾¤ï¼Œéœ€æ›´æ¢æ–°çš„ä¸»æœºå†æ¬¡è°ƒé…åŠ å…¥é›†ç¾¤ã€‚  </li>\n<li>è‹¥å­˜åœ¨é—®é¢˜çš„ Ignition é…ç½®å¼•èµ·ä¸»æœºé…ç½®çš„å¤±è´¥ï¼ŒIgnition å°†ä¸å†å°è¯•ä½¿ç”¨ç›¸åŒçš„é…ç½®æ¥è°ƒé…å¦ä¸€å°ä¸»æœºã€‚  </li>\n<li>ç”±äº Ignition å¯ä½¿ç”¨å®Œæ•´çš„ç©ºç£ç›˜ï¼Œå®ƒèƒ½å®ç° cloud-init æ— æ³•å®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚ä½¿ç”¨ PXE å¼•å¯¼ä»ç©ºç£ç›˜è°ƒé…è£¸æœºç³»ç»Ÿã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Ignition-å¯¹-OpenShift-4-é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\"><a href=\"#Ignition-å¯¹-OpenShift-4-é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\" class=\"headerlink\" title=\"Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š\"></a>Ignition å¯¹ OpenShift 4 é›†ç¾¤ä¸»æœºçš„å¤„ç†é¡ºåºï¼š</h3><ul>\n<li>åœ¨ OpenShift 4 é›†ç¾¤ä¸­çš„ RHCOS ä¸»æœºä¸Š Ignition çš„å¤„ç†æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š  <ul>\n<li>1ï¸âƒ£ æ§åˆ¶å¹³é¢ä¸»æœºï¼ˆ<code>control plane machines</code>ï¼‰ä»å¼•å¯¼ä¸»æœºï¼ˆ<code>bootstrap machine</code>ï¼‰è·å– Ignition é…ç½®æ–‡ä»¶ï¼Œè€Œå·¥ä½œä¸»æœºï¼ˆ<code>worker machines</code>ï¼‰ä»æ§åˆ¶å¹³é¢ä¸»æœºè·å– Ignition é…ç½®æ–‡ä»¶ã€‚  </li>\n<li>2ï¸âƒ£ Ignition åœ¨ä¸»æœºä¸Šåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç›®å½•ä¸é“¾æ¥ï¼Œå®ƒæ”¯æŒ RAID é˜µåˆ—ä½†ä¸æ”¯æŒ LVM é€»è¾‘å·ã€‚  </li>\n<li>3ï¸âƒ£ Igition åœ¨ initramfs ä¸­æŒ‚è½½ root æŒä¹…åŒ–æ–‡ä»¶ç³»ç»Ÿäº <code>/sysroot</code> ç›®å½•å¹¶åœ¨ <code>/sysroot</code> ç›®å½•ä¸­å·¥ä½œã€‚  </li>\n<li>4ï¸âƒ£ Ignition é…ç½®æ‰€æœ‰å®šä¹‰çš„æ–‡ä»¶ç³»ç»Ÿå¹¶æ°å½“åœ°æŒ‚è½½å®ƒä»¬ã€‚  </li>\n<li>5ï¸âƒ£ Ignition è¿è¡Œ <code>systemd</code> ä¸´æ—¶æ–‡ä»¶ä»¥å¡«å……åœ¨ <code>/var</code> ç›®å½•ä¸­çš„æ‰€éœ€æ–‡ä»¶ã€‚  </li>\n<li>6ï¸âƒ£ Ignition è¿è¡Œå…¶é…ç½®æ–‡ä»¶æ¥é…ç½®ç”¨æˆ·ã€systemd å•å…ƒæ–‡ä»¶ä¸å…¶ä»–é…ç½®æ–‡ä»¶ã€‚  </li>\n<li>7ï¸âƒ£ Ignition å¸è½½åœ¨ initramfs ä¸­æŒ‚è½½çš„æŒä¹…åŒ–ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç»„ä»¶ã€‚  </li>\n<li>8ï¸âƒ£ Ignition å¯åŠ¨æ–°ä¸»æœºçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¯åŠ¨ç³»ç»Ÿå¼•å¯¼é˜¶æ®µçš„æ‰€æœ‰å…¶ä»–çš„æœåŠ¡ã€‚</li>\n</ul>\n</li>\n<li>å¤„ç†ç»“æŸåï¼Œä¸»æœºå·²åšå¥½åŠ å…¥é›†ç¾¤çš„å‡†å¤‡å¹¶ä¸”æ— éœ€é‡å¯ï¼Œä¸å‰æ–‡æ‰€è¿°ç›¸åŒã€‚</li>\n</ul>\n<h3 id=\"Fedora-CoreOS-çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\"><a href=\"#Fedora-CoreOS-çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\" class=\"headerlink\" title=\"Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š\"></a>Fedora CoreOS çš„å®‰è£…ç¯å¢ƒä¸å·¥å…·è¯´æ˜ï¼š</h3><ul>\n<li>FCOS æ”¯æŒåœ¨å¤šç§ IaaS ç¯å¢ƒä¸‹è¿è¡Œã€‚</li>\n<li>Fedora CoreOS live ISO ç‰ˆæœ¬ï¼šfedora-coreos-36.20220906.3.2-live.x86_64.iso</li>\n<li>Butane å·¥å…·ï¼š  <ul>\n<li>linux ç‰ˆæœ¬ï¼š<a href=\"https://github.com/coreos/butane/releases/download/v0.15.0/butane-x86_64-unknown-linux-gnu\" target=\"_blank\" rel=\"noopener\">0.15.0</a>  </li>\n<li>è¯¥å·¥å…·æ¥æºäº <a href=\"https://github.com/coreos/butane\" target=\"_blank\" rel=\"noopener\">coreos/butane</a> é¡¹ç›®  </li>\n<li><code>Butane</code> ä»¥å‰ç§°ä¸º Fedora CoreOS é…ç½®è½¬æ¢å™¨ï¼ˆFedora CoreOS Config Transpilerï¼Œ<code>FCCT</code>ï¼‰ï¼Œå®ƒå¯å°† Butane é…ç½®æ–‡ä»¶ï¼ˆButane Configï¼‰æˆ–ç§° FCC æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶ï¼ˆIgnition Configï¼‰ï¼Œè¯¥æ–‡ä»¶ä¸º <code>JSON</code> æ ¼å¼å°†è¢« FCOS ä¸»æœºåœ¨é¦–æ¬¡å¼•å¯¼è°ƒé…æ—¶ä½¿ç”¨ï¼Œå¯ç”¨äºåˆ›å»ºç£ç›˜åˆ†åŒºã€æ–‡ä»¶ç³»ç»Ÿã€ç”¨æˆ·ã€å—ä¿¡ä»»çš„ç”¨æˆ· SSH å…¬é’¥ã€æ–‡ä»¶ä¸ç³»ç»Ÿå•å…ƒæ–‡ä»¶ï¼ˆsystemd unitsï¼‰ç­‰ã€‚  </li>\n<li>âœ¨ å…¶ä¸­ Butane é…ç½®æ–‡ä»¶ä¸º <code>YAML</code> æ ¼å¼ï¼Œå…³äºè¯¥æ–‡ä»¶ä¸åŒç‰ˆæœ¬çš„é…ç½®è§„èŒƒï¼ˆconfiguration specificationsï¼‰è¯·å‚è€ƒè¯¥ <a href=\"https://github.com/coreos/butane/blob/main/docs/specs.md\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ã€‚  </li>\n<li>âœ¨ Butane é…ç½®æ–‡ä»¶ä½¿ç”¨ç¤ºä¾‹è¯·å‚è€ƒè¯¥ <a href=\"https://github.com/coreos/butane/blob/main/docs/examples.md\" target=\"_blank\" rel=\"noopener\">Examples</a>ã€‚  </li>\n<li>å¯åœ¨è‡ªå·±æŒ‡å®šçš„èŠ‚ç‚¹ï¼ˆé FCOS ä¸»æœºï¼‰ä¸Šå®‰è£… butaneï¼Œå®‰è£…æ–¹å¼åŒ…æ‹¬ butane å®¹å™¨é•œåƒï¼ˆ<code>quay.io/coreos/butane:release</code>ï¼‰ã€rpm è½¯ä»¶åŒ…æˆ–ç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆstandalone binaryï¼‰ï¼Œæ­¤å¤„ä½¿ç”¨ä»¥ä¸Šé“¾æ¥çš„ç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚<img src=\"quay-coreos-butane-release.png\" alt=\"quay-coreos-butane-release.png\">  </li>\n<li>butane çš„ä½¿ç”¨æ–¹æ³•å¯å‚è€ƒè¯¥ <a href=\"https://github.com/coreos/butane/blob/main/docs/getting-started.md\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ã€‚</li>\n</ul>\n</li>\n<li>ignition-validate å·¥å…·ï¼š  <ul>\n<li>linux ç‰ˆæœ¬ï¼š<a href=\"https://github.com/coreos/ignition/releases/download/v2.14.0/ignition-validate-x86_64-linux\" target=\"_blank\" rel=\"noopener\">2.14.0</a>  </li>\n<li>è¯¥å·¥å…·æ¥æºäº <a href=\"https://github.com/coreos/ignition\" target=\"_blank\" rel=\"noopener\">coreos/ignition</a> é¡¹ç›®  </li>\n<li>è¯¥å·¥å…·ç”¨äºå¯¹ Ignition é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸åˆæ³•æ€§å­—æ®µçš„éªŒè¯ï¼Œè‹¥è¯­æ³•ä¸åˆè§„å°†æ— æ³•åœ¨ FCOS ä¸­ä½¿ç”¨ <code>coreos-installer</code> äºç³»ç»Ÿé¦–æ¬¡å¼•å¯¼æ—¶å®‰è£…ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Fedora-CoreOS-çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\"><a href=\"#Fedora-CoreOS-çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\" class=\"headerlink\" title=\"Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š\"></a>Fedora CoreOS çš„å®šåˆ¶åŒ–å®‰è£…ä¸éªŒè¯ï¼š</h3><ul>\n<li><p>å‡†å¤‡ HTTP æœåŠ¡å™¨ã€Ignition é…ç½®æ–‡ä»¶ä¸ç›¸å…³é…ç½®æ–‡ä»¶ï¼ˆé FCOS èŠ‚ç‚¹ï¼‰ï¼š  </p>\n<blockquote>\n<p>â— æ³¨æ„ï¼š</p>\n<ol>\n<li><p>æœ¬æ–‡å®‰è£…é‡‡ç”¨åŸºäº KVM è™šæ‹Ÿæœºæ¨¡æ‹Ÿè£¸é‡‘å±å®‰è£…ç¯å¢ƒã€‚</p>\n</li>\n<li><p>å…³äº <code>butane</code> å·¥å…·ä¸ <code>ignition-validate</code> å·¥å…·çš„å®‰è£…å¦‚å‰æ–‡æ‰€è¿°ã€‚</p>\n</li>\n<li><p>ğŸ’â€â™‚ï¸ æœ¬æ–‡ä½¿ç”¨ FCOS live ISO çš„æ–¹å¼å¼•å¯¼å¹¶ä½¿ç”¨å…¶ä¸­çš„ coreos-installer å·¥å…·è°ƒé…å®‰è£…ä¸»æœºï¼Œè‹¥ä½¿ç”¨ PXE æ–¹å¼å¼•å¯¼å®‰è£…è¯·å‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚</p>\n</li>\n</ol>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install httpd</span><br><span class=\"line\">$ sudo systemctl <span class=\"built_in\">enable</span> --now httpd.service</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…ä¸å¯åŠ¨ httpd æœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºè‡ªå¯</span></span><br><span class=\"line\">$ ssh-keygen -N <span class=\"string\">''</span> -t rsa -f ~/.ssh/core_fcos_login</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç”¨äº SSH å…å¯†ç™»å½• FCOS çš„å…¬ç§é’¥ï¼Œæ­¤å¤„å°†è¯¥ SSH å…¬é’¥æ‹·è´è‡³ Butane é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"><span class=\"comment\"># çš„ ssh_authorized_keys å­—æ®µä¸­ã€‚</span></span><br><span class=\"line\">$ mkdir ~/fcos &amp;&amp; <span class=\"built_in\">cd</span> ~/fcos</span><br><span class=\"line\">$ vim fcos-customized-config.yml</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Butane é…ç½®æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>\n<p>è¯¥é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># è¯¥é…ç½®æ–‡ä»¶å¯å‚çœ‹å‰æ–‡ GitHub Butane çš„ Examples æˆ– Fedora CoreOS å®˜æ–¹æ–‡æ¡£</span></span><br><span class=\"line\"><span class=\"comment\"># çš„ Storage éƒ¨åˆ†è¿›è¡Œç¼–è¾‘ã€‚</span></span><br><span class=\"line\"><span class=\"attr\">variant:</span> <span class=\"string\">fcos</span></span><br><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"number\">1.1</span><span class=\"number\">.0</span></span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·ã€å¯†ç ã€home å®¶ç›®å½•ä¸é…ç½® SSH å…å¯†ç™»å½•çš„å…¬é’¥</span></span><br><span class=\"line\"><span class=\"attr\">passwd:</span></span><br><span class=\"line\">  <span class=\"attr\">users:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">core</span></span><br><span class=\"line\">      <span class=\"attr\">ssh_authorized_keys:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">ssh-rsa</span> <span class=\"string\">AAAAB3Nz...jnXfG+Uj</span> <span class=\"string\">godev@cloud-ctl.domain12.example.com</span></span><br><span class=\"line\">      <span class=\"comment\"># ç”±äº FCOS/RHCOS åœ¨å®‰è£…å®Œæˆåæ— æ³•ä½¿ç”¨å¯†ç ç›´æ¥ç™»å½•ï¼Œè¯¥å…¬é’¥ç”¨äº core ç”¨æˆ·çš„</span></span><br><span class=\"line\">      <span class=\"comment\"># SSH å…å¯†ç™»å½•ã€‚</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cloud-admin</span></span><br><span class=\"line\">      <span class=\"attr\">password_hash:</span> <span class=\"string\">$y$j9T$j0ODWvNUDSXcEcwpDH141.$dvAEVxBHUWbW/NnPd90qkg0Haq6vgkcKF151jvLDgYA</span></span><br><span class=\"line\">      <span class=\"comment\"># æ˜æ–‡å¯†ç  redhat é€šè¿‡ hash åŠ å¯†çš„å¯†æ–‡</span></span><br><span class=\"line\">      <span class=\"comment\"># è™½ç„¶è¯¥ç”¨æˆ·å·²é…ç½®å¯†ç ï¼Œä½†æ— æ³•é€šè¿‡ SSH è¿œç¨‹ç™»å½•ï¼Œè¯¥å¯†ç åªå…è®¸æœ¬åœ°æ§åˆ¶å°ç™»å½•ã€‚</span></span><br><span class=\"line\">      <span class=\"attr\">home_dir:</span> <span class=\"string\">/opt/cloud-admin</span></span><br><span class=\"line\">      <span class=\"attr\">no_create_home:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">groups:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">wheel</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">/bin/bash</span></span><br><span class=\"line\">      <span class=\"comment\"># æ³¨æ„ï¼šå½“ä»»ä½•ç”¨æˆ· SSH è¿œç¨‹ç™»å½•å¤±æ•ˆæ—¶ï¼Œå¯ç”¨è¯¥ç”¨æˆ·æœ¬åœ°ç™»å½•å¹¶ææƒï¼</span></span><br><span class=\"line\"><span class=\"attr\">storage:</span></span><br><span class=\"line\">  <span class=\"comment\"># å°†æœ¬åœ°æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶å†…å®¹æ³¨å…¥ FCOS çš„å¯¹åº”æ–‡ä»¶ä¸­ï¼Œéœ€ä½¿ç”¨ butane å·¥å…·çš„</span></span><br><span class=\"line\">  <span class=\"comment\"># --files-dir é€‰é¡¹ã€‚</span></span><br><span class=\"line\">  <span class=\"attr\">files:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">\"/etc/NetworkManager/system-connections/Wired connection 1.nmconnection\"</span></span><br><span class=\"line\">      <span class=\"attr\">contents:</span></span><br><span class=\"line\">        <span class=\"attr\">local:</span> <span class=\"string\">./Wired_connection_1.nmconnection</span>      </span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"number\">0600</span></span><br><span class=\"line\">      <span class=\"comment\"># FCOS çš„ç½‘ç»œæ¥å£é…ç½®</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">contents:</span></span><br><span class=\"line\">        <span class=\"attr\">local:</span> <span class=\"string\">./hostname</span></span><br><span class=\"line\">      <span class=\"attr\">mode:</span> <span class=\"number\">0644</span></span><br><span class=\"line\">      <span class=\"comment\"># FCOS çš„ä¸»æœºåé…ç½®</span></span><br><span class=\"line\">  <span class=\"comment\"># å°† FCOS çš„ /dev/vdb è¿›è¡Œåˆ†åŒºå¹¶æŒ‚è½½è‡³ /var ç›®å½•ï¼Œä¸»è¦ç”¨äºå®¹å™¨ä¸é•œåƒçš„å­˜å‚¨ã€‚</span></span><br><span class=\"line\">  <span class=\"comment\"># æ³¨æ„ï¼šIgnition ä¸æ”¯æŒå¯¹ FCOS/RHCOS çš„ LVM é€»è¾‘å·åŠŸèƒ½ï¼</span></span><br><span class=\"line\">  <span class=\"attr\">disks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">device:</span> <span class=\"string\">/dev/vdb</span></span><br><span class=\"line\">      <span class=\"attr\">wipe_table:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">partitions:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">number:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">label:</span> <span class=\"string\">var</span></span><br><span class=\"line\">  <span class=\"attr\">filesystems:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/var</span></span><br><span class=\"line\">      <span class=\"attr\">device:</span> <span class=\"string\">/dev/disk/by-partlabel/var</span></span><br><span class=\"line\">      <span class=\"attr\">format:</span> <span class=\"string\">xfs</span></span><br><span class=\"line\">      <span class=\"attr\">wipe_filesystem:</span> <span class=\"literal\">true</span> </span><br><span class=\"line\">      <span class=\"attr\">label:</span> <span class=\"string\">var</span></span><br><span class=\"line\">      <span class=\"attr\">with_mount_unit:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Š YAML æ–‡ä»¶å¯ç‚¹å‡» <a href=\"https://github.com/Alberthua-Perl/scripts-confs/tree/master/fedora-coreos-36\" target=\"_blank\" rel=\"noopener\">æ­¤å¤„</a> è·å¾—ã€‚ </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat ./hostname</span><br><span class=\"line\">  fcos36-cloud.lab.example.com</span><br><span class=\"line\">$ cat ./Wired_connection_1.nmconnection </span><br><span class=\"line\">  [connection]</span><br><span class=\"line\">  id=Wired connection 1</span><br><span class=\"line\">  <span class=\"built_in\">type</span>=ethernet</span><br><span class=\"line\">  autoconnect-priority=-999</span><br><span class=\"line\">  interface-name=ens3</span><br><span class=\"line\"></span><br><span class=\"line\">  [ethernet]</span><br><span class=\"line\"></span><br><span class=\"line\">  [ipv4]</span><br><span class=\"line\">  address1=192.168.110.13/24,192.168.110.1</span><br><span class=\"line\">  dns=192.168.110.1;</span><br><span class=\"line\">  method=manual</span><br><span class=\"line\"></span><br><span class=\"line\">$ butane --files-dir . \\</span><br><span class=\"line\">  --pretty --strict \\</span><br><span class=\"line\">  --output fcos-customized-config.ign fcos-customized-config.yml</span><br><span class=\"line\"><span class=\"comment\"># åœ¨å½“å‰ç›®å½•ä¸­æ ¹æ® Butane é…ç½®æ–‡ä»¶è½¬æ¢ä¸º Ignition é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\">$ ignition-validate fcos-customized-config.ign</span><br><span class=\"line\"><span class=\"comment\"># éªŒè¯ Ignition é…ç½®æ–‡ä»¶è¯­æ³•çš„åˆæ³•æ€§ï¼Œè‹¥æ— è¿”å›åˆ™éªŒè¯é€šè¿‡ï¼Œè¯¥æ–‡ä»¶å¯ç”¨äº FCOS çš„å®‰è£…ã€‚</span></span><br><span class=\"line\">$ sudo cp fcos-customized-config.ign /var/www/html/</span><br><span class=\"line\"><span class=\"comment\"># æ‹·è´è¯¥æ–‡ä»¶è‡³ HTTP æœåŠ¡å™¨çš„æ ¹ç›®å½•ä¸­ç”¨äº FCOS ä¸­ coreos-installer å·¥å…·çš„ä¸‹è½½</span></span><br><span class=\"line\"><span class=\"comment\"># è¯»å–ä¸ç³»ç»Ÿå®‰è£…ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»º FCOS è™šæ‹Ÿæœºå¹¶ä½¿ç”¨ FCOS live ISO å¼•å¯¼å®‰è£…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"use-fedora-coreos-live-to-install.png\" alt=\"use-fedora-coreos-live-to-install.png\"><img src=\"login-fedora-coreos-live.png\" alt=\"login-fedora-coreos-live.png\"><br>ğŸ‘‰ <code>core</code> ç”¨æˆ·å¯ <code>sudo</code> å…å¯†ææƒä¸º root ç”¨æˆ·ã€‚<br>ğŸ‘‰ ä½¿ç”¨ <code>core</code> ç”¨æˆ·æ­£å¸¸ç™»å½•åï¼Œå†ä½¿ç”¨ <code>ip -br a s</code> å‘½ä»¤æŸ¥çœ‹ä¸»æœºçš„ IP åœ°å€ï¼ˆä¸€èˆ¬å¯é€šè¿‡ <code>DHCP</code> è‡ªåŠ¨è·å–ï¼‰ï¼Œè‹¥æ— ä¸ HTTP æœåŠ¡å™¨é€šä¿¡çš„ IP åœ°å€ï¼Œå°†æ— æ³•ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶è€Œå®‰è£…å¤±è´¥ï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤ä¸´æ—¶é…ç½®åŠ ä»¥ç”Ÿæ•ˆï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ip address add 192.168.110.13/24 dev ens3</span><br><span class=\"line\"><span class=\"comment\"># éœ€æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´ IP åœ°å€ä¸å¯¹åº”çš„ç½‘ç»œæ¥å£</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ‘‰ ä½¿ç”¨ FCOS live ISO è‡ªå¸¦çš„ <code>coreos-installer</code> å·¥å…·æ ¹æ® Ignition é…ç½®æ–‡ä»¶å®‰è£…éƒ¨ç½²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"coreos-installer-customized-install.png\" alt=\"coreos-installer-customized-install.png\">  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo coreos-installer install \\</span><br><span class=\"line\">  --insecure-ignition \\</span><br><span class=\"line\">  --ignition-url http://192.168.110.130/fcos-customized-config.ign \\</span><br><span class=\"line\">  /dev/vda</span><br><span class=\"line\"><span class=\"comment\"># ä¸‹è½½ Ignition é…ç½®æ–‡ä»¶å¹¶å°†æ ¹ç³»ç»Ÿå®‰è£…äº /dev/vda ä¸­</span></span><br><span class=\"line\"><span class=\"comment\"># æ­¤å®‰è£…è¿‡ç¨‹æ ¹æ®æ‰€é…ç½®çš„å†…å®¹ä¸åŒè€—æ—¶ä¹Ÿå°†ä¸åŒï¼ˆç¬”è€…ç¯å¢ƒä¸­å®‰è£…è¾ƒå¿«ï¼‰</span></span><br><span class=\"line\">$ sudo reboot</span><br><span class=\"line\"><span class=\"comment\"># é‡å¯ç³»ç»Ÿ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç™»å½• FCOS éªŒè¯å®‰è£…çŠ¶æ€ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ssh -i ~/.ssh/core_fcos_login core@fcos36-cloud</span><br><span class=\"line\">  Fedora CoreOS 36.20221001.3.0</span><br><span class=\"line\">  Tracker: https://github.com/coreos/fedora-coreos-tracker</span><br><span class=\"line\">  Discuss: https://discussion.fedoraproject.org/tag/coreos</span><br><span class=\"line\"></span><br><span class=\"line\">  Last login: Mon Oct 24 14:07:00 2022 from 192.168.110.130</span><br><span class=\"line\">  [core@fcos36-cloud ~]$ sudo -i</span><br><span class=\"line\">  [root@fcos36-cloud ~]<span class=\"comment\"># id cloud-admin</span></span><br><span class=\"line\">  uid=1001(cloud-admin) gid=1001(cloud-admin) groups=1001(cloud-admin),10(wheel)</span><br><span class=\"line\">  [root@fcos36-cloud ~]<span class=\"comment\"># su - cloud-admin</span></span><br><span class=\"line\">  [cloud-admin@fcos36-cloud ~]$ sudo -i</span><br><span class=\"line\">  [sudo] password <span class=\"keyword\">for</span> cloud-admin: </span><br><span class=\"line\">  [root@fcos36-cloud ~]<span class=\"comment\"># lsblk --paths</span></span><br><span class=\"line\">  NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class=\"line\">  /dev/sr0     11:0    1 1024M  0 rom  </span><br><span class=\"line\">  /dev/vda    252:0    0   10G  0 disk </span><br><span class=\"line\">  |-/dev/vda1 252:1    0    1M  0 part </span><br><span class=\"line\">  |-/dev/vda2 252:2    0  127M  0 part </span><br><span class=\"line\">  |-/dev/vda3 252:3    0  384M  0 part /boot</span><br><span class=\"line\">  `-/dev/vda4 252:4    0  9.5G  0 part /sysroot/ostree/deploy/fedora-coreos/var</span><br><span class=\"line\">                                       /usr</span><br><span class=\"line\">                                       /etc</span><br><span class=\"line\">                                       /</span><br><span class=\"line\">                                       /sysroot</span><br><span class=\"line\">  /dev/vdb    252:16   0   10G  0 disk </span><br><span class=\"line\">  `-/dev/vdb1 252:17   0   10G  0 part /var </span><br><span class=\"line\"><span class=\"comment\"># Ignition é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®åœ¨ FCOS ä¸­å·²ç”Ÿæ•ˆ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç”±äº FCOS ä¸­ä½¿ç”¨ <code>rpm-ostree</code> è¿›è¡Œè½¯ä»¶åŒ…çš„ç®¡ç†ï¼Œè‹¥éœ€å®‰è£…é¢å¤–çš„è½¯ä»¶åŒ…ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo rpm-ostree install \\</span><br><span class=\"line\">  podman skopeo buildah cri-o cri-tools vim-enhanced</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£…å®¹å™¨ä¸é•œåƒç®¡ç†å·¥å…·</span></span><br><span class=\"line\">$ sudo systemctl status crio.service</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ CRI-O å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€ï¼Œå¯é€šè¿‡ crictl å‘½ä»¤æµ‹è¯•ç®¡ç†å®¹å™¨ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://fedoramagazine.org/introducing-fedora-coreos/\" target=\"_blank\" rel=\"noopener\">Introducing Fedora CoreOS</a></li>\n<li><a href=\"https://fedoramagazine.org/getting-started-with-fedora-coreos/\" target=\"_blank\" rel=\"noopener\">Getting started with Fedora CoreOS</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/Vf6TvGSi5sNnMjT5QldUQg\" target=\"_blank\" rel=\"noopener\">Fedora CoreOS å…¥é—¨ | Linux ä¸­å›½</a></li>\n<li>â¤ <a href=\"https://docs.fedoraproject.org/en-US/fedora-coreos/\" target=\"_blank\" rel=\"noopener\">Fedora CoreOS Documentation</a></li>\n<li><a href=\"https://docs.openshift.com/container-platform/4.11/architecture/architecture-rhcos.html\" target=\"_blank\" rel=\"noopener\">Red Hat Enterprise Linux CoreOS (RHCOS)</a></li>\n<li>â¤ <a href=\"https://developers.redhat.com/blog/2020/03/12/how-to-customize-fedora-coreos-for-dedicated-workloads-with-ostree#\" target=\"_blank\" rel=\"noopener\">How to customize Fedora CoreOS for dedicated workloads with OSTree</a></li>\n</ul>\n"},{"title":"Code Server v4.8.3 å®¹å™¨é•œåƒæ„å»º","subtitle":"Build Code Server for Golang","header-img":"code-server-bg.png","date":"2022-12-05T15:45:01.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- ğŸ”— å¯å‚è€ƒ [è¯¥é“¾æ¥](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/code-server-4.8.3)ï¼Œä»¥è·å¾—é¡¹ç›®çš„ GitHub ä»“åº“ã€‚\n- `Red Hat OpenShift` ä¸­ä½¿ç”¨ `Red Hat Code Ready Workspace` ä½œä¸º PaaS å¹³å°ä¸­çš„å®æ—¶ IDE å¼€å‘å¹³å°ï¼Œå¯å…¼å®¹ä¼—å¤šå¼€å‘è¯­è¨€ã€‚\n- è¯¥ç¤ºä¾‹çš„ç›®çš„åœ¨äºæ„å»ºç±»ä¼¼äº Red Hat Code Ready Workspace çš„å®¹å™¨åŒ– Golang IDE å¼€å‘å¹³å°ã€‚\n- å¯ä½¿ç”¨æ­¤ Golang IDE å¼€å‘å¹³å°æä¾›ä¸æœ¬åœ° `Microsoft VS Code` å¹³å°ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å¯å®ç°å®æ—¶ç™»å½•å¼€å‘ç¯å¢ƒä¸è¿œç¨‹ä»£ç ä»“åº“çš„ä¸€è‡´æ€§ã€‚\n- å®¹å™¨é•œåƒæ„å»ºä¸ä½¿ç”¨ï¼š\n  - è¯¥å®¹å™¨é•œåƒå¯æä¾›çš„åŠŸèƒ½ï¼š\n    - ğŸ‘‰ åŸºäº `VS Code` çš„ `Web UI` å¼€å‘ç•Œé¢\n    - ğŸ‘‰ é›†æˆ `Golang v1.19.3` è¯­è¨€å¼€å‘ç¯å¢ƒ\n  - ä½¿ç”¨è¯¥ç›®å½•ä¸­çš„ `Dockerfile` æ„å»º `Code Server v4.8.3` å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n    ```bash\n    $ tree -h .\n      .\n      â”œâ”€â”€ [103M]  code-server_4.8.3_amd64.deb\n      â”œâ”€â”€ [1.9K]  Dockerfile\n      â”œâ”€â”€ [ 17K]  oh-my-zsh-install.sh\n      â”œâ”€â”€ [1.3K]  README.md\n      â””â”€â”€ [ 614]  sources.list\n  \n    $ sudo docker build -t golang-code-server:v1.1 .\n    # åœ¨å½“å‰ç›®å½•ä¸Šä¸‹æ–‡ä¸­æ„å»º\n    $ sudo docker run -d --name=golang-code-server -p 8080:8080 golang-code-server:v1.1\n    # ä½¿ç”¨æ„å»ºçš„å®¹å™¨é•œåƒè¿è¡Œå®¹å™¨ï¼Œå¹¶ç™»å½•è®¿é—® Web ç•Œé¢ã€‚\n    ```\n\n  > ğŸ’¥ æ³¨æ„ï¼šç”±äº `code-server_4.8.3_amd64.deb` è½¯ä»¶åŒ…çš„å®¹é‡å¤§å°é™åˆ¶æ— æ³•ä¸Šä¼ è‡³ GitHub ä¸­ï¼Œå¯ä»  [ç™¾åº¦ç½‘ç›˜](https://pan.baidu.com/s/1ul4ZYZa1Cpmp_5fXxyGJtg) ä¸‹è½½ï¼Œæå–ç ä¸º `no8o`ã€‚\n\n  - è¯¥å®¹å™¨é•œåƒå¯åœ¨ `Kubernetes` æˆ– `OpenShift` é›†ç¾¤å¤–ä½¿ç”¨ `Docker` æˆ– `Podman` å…ˆè¡Œæµ‹è¯•ï¼Œå†å¯¼å…¥å®¹å™¨é•œåƒä»“åº“ `registry`ï¼Œç”¨äºåç»­çš„éƒ¨ç½²ä½¿ç”¨ã€‚\n- å¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ [èµ„æºå®šä¹‰æ–‡ä»¶](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/golang-codeready-workspace-deployment.yml)ï¼Œå°†è¯¥åº”ç”¨éƒ¨ç½²äº `Kubernetes` æˆ– `OpenShift` é›†ç¾¤ä¸­ï¼š\n  ```yaml\n  apiVersion: v1\n  kind: Service\n  metadata: \n    labels: \n      name: golang-codeready-workspace\n    name: golang-codeready-workspace\n    namespace: codeready-workspace\n  spec: \n    ports:\n      # the port that this service should serve on\n      - port: 8080\n        protocol: TCP\n        targetPort: 8080\n        nodePort: 30001\n    # label keys and values that must match in order to receive traffic for this service\n    selector: \n      app: golang-codeready-workspace\n    type: NodePort\n  ---  \n  apiVersion: apps/v1\n  kind: Deployment\n  metadata:\n    labels:\n      app: golang-codeready-workspace\n    name: golang-codeready-workspace\n    namespace: codeready-workspace\n  spec:\n    replicas: 1\n    selector:\n      matchLabels:\n        app: golang-codeready-workspace\n    template:\n      metadata:\n        creationTimestamp: null\n        labels:\n          app: golang-codeready-workspace\n      spec:\n        containers:\n        - image: quay-registry.lab.example.com/godev/golang-code-server:v1.1\n          # image also pulled from quay.io/alberthua/golang-code-server:v1.1\n          imagePullPolicy: IfNotPresent\n          name: golang-codeready-workspace\n          ports:\n          - containerPort: 8080\n            protocol: TCP\n        restartPolicy: Always\n        schedulerName: default-scheduler\n        securityContext: {}\n        terminationGracePeriodSeconds: 30\n  ```\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [GitHub - coder/code-server](https://github.com/coder/code-server)\n- [code-server v4.8.0 docs](https://coder.com/docs/code-server/latest)\n- [dockerhub - golang](https://hub.docker.com/_/golang)\n- [äº‘ vscode æ­å»ºä¹‹ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²çš„æ–¹æ³•](https://www.jb51.net/article/261704.htm)\n- [docker build æ—¶å‡ºç°é”™è¯¯ \"debconf: unable to initialize frontend: Dialog\" å¦‚ä½•å¤„ç†ï¼Ÿ](https://blog.51cto.com/u_15061952/3607022)","source":"_posts/golang-code-server.md","raw":"---\ntitle: Code Server v4.8.3 å®¹å™¨é•œåƒæ„å»º\nsubtitle: Build Code Server for Golang\nheader-img: code-server-bg.png \ndate: 2022-12-05 23:45:01\ntags:\n  - Golang\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- ğŸ”— å¯å‚è€ƒ [è¯¥é“¾æ¥](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/code-server-4.8.3)ï¼Œä»¥è·å¾—é¡¹ç›®çš„ GitHub ä»“åº“ã€‚\n- `Red Hat OpenShift` ä¸­ä½¿ç”¨ `Red Hat Code Ready Workspace` ä½œä¸º PaaS å¹³å°ä¸­çš„å®æ—¶ IDE å¼€å‘å¹³å°ï¼Œå¯å…¼å®¹ä¼—å¤šå¼€å‘è¯­è¨€ã€‚\n- è¯¥ç¤ºä¾‹çš„ç›®çš„åœ¨äºæ„å»ºç±»ä¼¼äº Red Hat Code Ready Workspace çš„å®¹å™¨åŒ– Golang IDE å¼€å‘å¹³å°ã€‚\n- å¯ä½¿ç”¨æ­¤ Golang IDE å¼€å‘å¹³å°æä¾›ä¸æœ¬åœ° `Microsoft VS Code` å¹³å°ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å¯å®ç°å®æ—¶ç™»å½•å¼€å‘ç¯å¢ƒä¸è¿œç¨‹ä»£ç ä»“åº“çš„ä¸€è‡´æ€§ã€‚\n- å®¹å™¨é•œåƒæ„å»ºä¸ä½¿ç”¨ï¼š\n  - è¯¥å®¹å™¨é•œåƒå¯æä¾›çš„åŠŸèƒ½ï¼š\n    - ğŸ‘‰ åŸºäº `VS Code` çš„ `Web UI` å¼€å‘ç•Œé¢\n    - ğŸ‘‰ é›†æˆ `Golang v1.19.3` è¯­è¨€å¼€å‘ç¯å¢ƒ\n  - ä½¿ç”¨è¯¥ç›®å½•ä¸­çš„ `Dockerfile` æ„å»º `Code Server v4.8.3` å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n    ```bash\n    $ tree -h .\n      .\n      â”œâ”€â”€ [103M]  code-server_4.8.3_amd64.deb\n      â”œâ”€â”€ [1.9K]  Dockerfile\n      â”œâ”€â”€ [ 17K]  oh-my-zsh-install.sh\n      â”œâ”€â”€ [1.3K]  README.md\n      â””â”€â”€ [ 614]  sources.list\n  \n    $ sudo docker build -t golang-code-server:v1.1 .\n    # åœ¨å½“å‰ç›®å½•ä¸Šä¸‹æ–‡ä¸­æ„å»º\n    $ sudo docker run -d --name=golang-code-server -p 8080:8080 golang-code-server:v1.1\n    # ä½¿ç”¨æ„å»ºçš„å®¹å™¨é•œåƒè¿è¡Œå®¹å™¨ï¼Œå¹¶ç™»å½•è®¿é—® Web ç•Œé¢ã€‚\n    ```\n\n  > ğŸ’¥ æ³¨æ„ï¼šç”±äº `code-server_4.8.3_amd64.deb` è½¯ä»¶åŒ…çš„å®¹é‡å¤§å°é™åˆ¶æ— æ³•ä¸Šä¼ è‡³ GitHub ä¸­ï¼Œå¯ä»  [ç™¾åº¦ç½‘ç›˜](https://pan.baidu.com/s/1ul4ZYZa1Cpmp_5fXxyGJtg) ä¸‹è½½ï¼Œæå–ç ä¸º `no8o`ã€‚\n\n  - è¯¥å®¹å™¨é•œåƒå¯åœ¨ `Kubernetes` æˆ– `OpenShift` é›†ç¾¤å¤–ä½¿ç”¨ `Docker` æˆ– `Podman` å…ˆè¡Œæµ‹è¯•ï¼Œå†å¯¼å…¥å®¹å™¨é•œåƒä»“åº“ `registry`ï¼Œç”¨äºåç»­çš„éƒ¨ç½²ä½¿ç”¨ã€‚\n- å¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ [èµ„æºå®šä¹‰æ–‡ä»¶](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/golang-codeready-workspace-deployment.yml)ï¼Œå°†è¯¥åº”ç”¨éƒ¨ç½²äº `Kubernetes` æˆ– `OpenShift` é›†ç¾¤ä¸­ï¼š\n  ```yaml\n  apiVersion: v1\n  kind: Service\n  metadata: \n    labels: \n      name: golang-codeready-workspace\n    name: golang-codeready-workspace\n    namespace: codeready-workspace\n  spec: \n    ports:\n      # the port that this service should serve on\n      - port: 8080\n        protocol: TCP\n        targetPort: 8080\n        nodePort: 30001\n    # label keys and values that must match in order to receive traffic for this service\n    selector: \n      app: golang-codeready-workspace\n    type: NodePort\n  ---  \n  apiVersion: apps/v1\n  kind: Deployment\n  metadata:\n    labels:\n      app: golang-codeready-workspace\n    name: golang-codeready-workspace\n    namespace: codeready-workspace\n  spec:\n    replicas: 1\n    selector:\n      matchLabels:\n        app: golang-codeready-workspace\n    template:\n      metadata:\n        creationTimestamp: null\n        labels:\n          app: golang-codeready-workspace\n      spec:\n        containers:\n        - image: quay-registry.lab.example.com/godev/golang-code-server:v1.1\n          # image also pulled from quay.io/alberthua/golang-code-server:v1.1\n          imagePullPolicy: IfNotPresent\n          name: golang-codeready-workspace\n          ports:\n          - containerPort: 8080\n            protocol: TCP\n        restartPolicy: Always\n        schedulerName: default-scheduler\n        securityContext: {}\n        terminationGracePeriodSeconds: 30\n  ```\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [GitHub - coder/code-server](https://github.com/coder/code-server)\n- [code-server v4.8.0 docs](https://coder.com/docs/code-server/latest)\n- [dockerhub - golang](https://hub.docker.com/_/golang)\n- [äº‘ vscode æ­å»ºä¹‹ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²çš„æ–¹æ³•](https://www.jb51.net/article/261704.htm)\n- [docker build æ—¶å‡ºç°é”™è¯¯ \"debconf: unable to initialize frontend: Dialog\" å¦‚ä½•å¤„ç†ï¼Ÿ](https://blog.51cto.com/u_15061952/3607022)","slug":"golang-code-server","published":1,"updated":"2022-12-06T02:18:41.438Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonojo000316vdbsql1wkd","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>ğŸ”— å¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/code-server-4.8.3\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>ï¼Œä»¥è·å¾—é¡¹ç›®çš„ GitHub ä»“åº“ã€‚</li>\n<li><code>Red Hat OpenShift</code> ä¸­ä½¿ç”¨ <code>Red Hat Code Ready Workspace</code> ä½œä¸º PaaS å¹³å°ä¸­çš„å®æ—¶ IDE å¼€å‘å¹³å°ï¼Œå¯å…¼å®¹ä¼—å¤šå¼€å‘è¯­è¨€ã€‚</li>\n<li>è¯¥ç¤ºä¾‹çš„ç›®çš„åœ¨äºæ„å»ºç±»ä¼¼äº Red Hat Code Ready Workspace çš„å®¹å™¨åŒ– Golang IDE å¼€å‘å¹³å°ã€‚</li>\n<li>å¯ä½¿ç”¨æ­¤ Golang IDE å¼€å‘å¹³å°æä¾›ä¸æœ¬åœ° <code>Microsoft VS Code</code> å¹³å°ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å¯å®ç°å®æ—¶ç™»å½•å¼€å‘ç¯å¢ƒä¸è¿œç¨‹ä»£ç ä»“åº“çš„ä¸€è‡´æ€§ã€‚</li>\n<li><p>å®¹å™¨é•œåƒæ„å»ºä¸ä½¿ç”¨ï¼š</p>\n<ul>\n<li>è¯¥å®¹å™¨é•œåƒå¯æä¾›çš„åŠŸèƒ½ï¼š<ul>\n<li>ğŸ‘‰ åŸºäº <code>VS Code</code> çš„ <code>Web UI</code> å¼€å‘ç•Œé¢</li>\n<li>ğŸ‘‰ é›†æˆ <code>Golang v1.19.3</code> è¯­è¨€å¼€å‘ç¯å¢ƒ</li>\n</ul>\n</li>\n<li>ä½¿ç”¨è¯¥ç›®å½•ä¸­çš„ <code>Dockerfile</code> æ„å»º <code>Code Server v4.8.3</code> å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree -h .</span><br><span class=\"line\">  .</span><br><span class=\"line\">  â”œâ”€â”€ [103M]  code-server_4.8.3_amd64.deb</span><br><span class=\"line\">  â”œâ”€â”€ [1.9K]  Dockerfile</span><br><span class=\"line\">  â”œâ”€â”€ [ 17K]  oh-my-zsh-install.sh</span><br><span class=\"line\">  â”œâ”€â”€ [1.3K]  README.md</span><br><span class=\"line\">  â””â”€â”€ [ 614]  sources.list</span><br><span class=\"line\">  </span><br><span class=\"line\">$ sudo docker build -t golang-code-server:v1.1 .</span><br><span class=\"line\"><span class=\"comment\"># åœ¨å½“å‰ç›®å½•ä¸Šä¸‹æ–‡ä¸­æ„å»º</span></span><br><span class=\"line\">$ sudo docker run -d --name=golang-code-server -p 8080:8080 golang-code-server:v1.1</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨æ„å»ºçš„å®¹å™¨é•œåƒè¿è¡Œå®¹å™¨ï¼Œå¹¶ç™»å½•è®¿é—® Web ç•Œé¢ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>ğŸ’¥ æ³¨æ„ï¼šç”±äº <code>code-server_4.8.3_amd64.deb</code> è½¯ä»¶åŒ…çš„å®¹é‡å¤§å°é™åˆ¶æ— æ³•ä¸Šä¼ è‡³ GitHub ä¸­ï¼Œå¯ä»  <a href=\"https://pan.baidu.com/s/1ul4ZYZa1Cpmp_5fXxyGJtg\" target=\"_blank\" rel=\"noopener\">ç™¾åº¦ç½‘ç›˜</a> ä¸‹è½½ï¼Œæå–ç ä¸º <code>no8o</code>ã€‚</p>\n</blockquote>\n<ul>\n<li>è¯¥å®¹å™¨é•œåƒå¯åœ¨ <code>Kubernetes</code> æˆ– <code>OpenShift</code> é›†ç¾¤å¤–ä½¿ç”¨ <code>Docker</code> æˆ– <code>Podman</code> å…ˆè¡Œæµ‹è¯•ï¼Œå†å¯¼å…¥å®¹å™¨é•œåƒä»“åº“ <code>registry</code>ï¼Œç”¨äºåç»­çš„éƒ¨ç½²ä½¿ç”¨ã€‚</li>\n</ul>\n</li>\n<li>å¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/golang-codeready-workspace-deployment.yml\" target=\"_blank\" rel=\"noopener\">èµ„æºå®šä¹‰æ–‡ä»¶</a>ï¼Œå°†è¯¥åº”ç”¨éƒ¨ç½²äº <code>Kubernetes</code> æˆ– <code>OpenShift</code> é›†ç¾¤ä¸­ï¼š<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span> </span><br><span class=\"line\">  <span class=\"attr\">labels:</span> </span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">codeready-workspace</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> </span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"comment\"># the port that this service should serve on</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">      <span class=\"attr\">nodePort:</span> <span class=\"number\">30001</span></span><br><span class=\"line\">  <span class=\"comment\"># label keys and values that must match in order to receive traffic for this service</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span> </span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"string\">---</span>  </span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">codeready-workspace</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">quay-registry.lab.example.com/godev/golang-code-server:v1.1</span></span><br><span class=\"line\">        <span class=\"comment\"># image also pulled from quay.io/alberthua/golang-code-server:v1.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">schedulerName:</span> <span class=\"string\">default-scheduler</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://github.com/coder/code-server\" target=\"_blank\" rel=\"noopener\">GitHub - coder/code-server</a></li>\n<li><a href=\"https://coder.com/docs/code-server/latest\" target=\"_blank\" rel=\"noopener\">code-server v4.8.0 docs</a></li>\n<li><a href=\"https://hub.docker.com/_/golang\" target=\"_blank\" rel=\"noopener\">dockerhub - golang</a></li>\n<li><a href=\"https://www.jb51.net/article/261704.htm\" target=\"_blank\" rel=\"noopener\">äº‘ vscode æ­å»ºä¹‹ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²çš„æ–¹æ³•</a></li>\n<li><a href=\"https://blog.51cto.com/u_15061952/3607022\" target=\"_blank\" rel=\"noopener\">docker build æ—¶å‡ºç°é”™è¯¯ â€œdebconf: unable to initialize frontend: Dialogâ€ å¦‚ä½•å¤„ç†ï¼Ÿ</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>ğŸ”— å¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/code-server-4.8.3\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>ï¼Œä»¥è·å¾—é¡¹ç›®çš„ GitHub ä»“åº“ã€‚</li>\n<li><code>Red Hat OpenShift</code> ä¸­ä½¿ç”¨ <code>Red Hat Code Ready Workspace</code> ä½œä¸º PaaS å¹³å°ä¸­çš„å®æ—¶ IDE å¼€å‘å¹³å°ï¼Œå¯å…¼å®¹ä¼—å¤šå¼€å‘è¯­è¨€ã€‚</li>\n<li>è¯¥ç¤ºä¾‹çš„ç›®çš„åœ¨äºæ„å»ºç±»ä¼¼äº Red Hat Code Ready Workspace çš„å®¹å™¨åŒ– Golang IDE å¼€å‘å¹³å°ã€‚</li>\n<li>å¯ä½¿ç”¨æ­¤ Golang IDE å¼€å‘å¹³å°æä¾›ä¸æœ¬åœ° <code>Microsoft VS Code</code> å¹³å°ç›¸åŒçš„åŠŸèƒ½ï¼Œå¹¶å¯å®ç°å®æ—¶ç™»å½•å¼€å‘ç¯å¢ƒä¸è¿œç¨‹ä»£ç ä»“åº“çš„ä¸€è‡´æ€§ã€‚</li>\n<li><p>å®¹å™¨é•œåƒæ„å»ºä¸ä½¿ç”¨ï¼š</p>\n<ul>\n<li>è¯¥å®¹å™¨é•œåƒå¯æä¾›çš„åŠŸèƒ½ï¼š<ul>\n<li>ğŸ‘‰ åŸºäº <code>VS Code</code> çš„ <code>Web UI</code> å¼€å‘ç•Œé¢</li>\n<li>ğŸ‘‰ é›†æˆ <code>Golang v1.19.3</code> è¯­è¨€å¼€å‘ç¯å¢ƒ</li>\n</ul>\n</li>\n<li>ä½¿ç”¨è¯¥ç›®å½•ä¸­çš„ <code>Dockerfile</code> æ„å»º <code>Code Server v4.8.3</code> å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree -h .</span><br><span class=\"line\">  .</span><br><span class=\"line\">  â”œâ”€â”€ [103M]  code-server_4.8.3_amd64.deb</span><br><span class=\"line\">  â”œâ”€â”€ [1.9K]  Dockerfile</span><br><span class=\"line\">  â”œâ”€â”€ [ 17K]  oh-my-zsh-install.sh</span><br><span class=\"line\">  â”œâ”€â”€ [1.3K]  README.md</span><br><span class=\"line\">  â””â”€â”€ [ 614]  sources.list</span><br><span class=\"line\">  </span><br><span class=\"line\">$ sudo docker build -t golang-code-server:v1.1 .</span><br><span class=\"line\"><span class=\"comment\"># åœ¨å½“å‰ç›®å½•ä¸Šä¸‹æ–‡ä¸­æ„å»º</span></span><br><span class=\"line\">$ sudo docker run -d --name=golang-code-server -p 8080:8080 golang-code-server:v1.1</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨æ„å»ºçš„å®¹å™¨é•œåƒè¿è¡Œå®¹å™¨ï¼Œå¹¶ç™»å½•è®¿é—® Web ç•Œé¢ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>ğŸ’¥ æ³¨æ„ï¼šç”±äº <code>code-server_4.8.3_amd64.deb</code> è½¯ä»¶åŒ…çš„å®¹é‡å¤§å°é™åˆ¶æ— æ³•ä¸Šä¼ è‡³ GitHub ä¸­ï¼Œå¯ä»  <a href=\"https://pan.baidu.com/s/1ul4ZYZa1Cpmp_5fXxyGJtg\" target=\"_blank\" rel=\"noopener\">ç™¾åº¦ç½‘ç›˜</a> ä¸‹è½½ï¼Œæå–ç ä¸º <code>no8o</code>ã€‚</p>\n</blockquote>\n<ul>\n<li>è¯¥å®¹å™¨é•œåƒå¯åœ¨ <code>Kubernetes</code> æˆ– <code>OpenShift</code> é›†ç¾¤å¤–ä½¿ç”¨ <code>Docker</code> æˆ– <code>Podman</code> å…ˆè¡Œæµ‹è¯•ï¼Œå†å¯¼å…¥å®¹å™¨é•œåƒä»“åº“ <code>registry</code>ï¼Œç”¨äºåç»­çš„éƒ¨ç½²ä½¿ç”¨ã€‚</li>\n</ul>\n</li>\n<li>å¯ä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/golang-codeready-workspace-deployment.yml\" target=\"_blank\" rel=\"noopener\">èµ„æºå®šä¹‰æ–‡ä»¶</a>ï¼Œå°†è¯¥åº”ç”¨éƒ¨ç½²äº <code>Kubernetes</code> æˆ– <code>OpenShift</code> é›†ç¾¤ä¸­ï¼š<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span> </span><br><span class=\"line\">  <span class=\"attr\">labels:</span> </span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">codeready-workspace</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> </span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"comment\"># the port that this service should serve on</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">      <span class=\"attr\">nodePort:</span> <span class=\"number\">30001</span></span><br><span class=\"line\">  <span class=\"comment\"># label keys and values that must match in order to receive traffic for this service</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span> </span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\"><span class=\"string\">---</span>  </span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">codeready-workspace</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">quay-registry.lab.example.com/godev/golang-code-server:v1.1</span></span><br><span class=\"line\">        <span class=\"comment\"># image also pulled from quay.io/alberthua/golang-code-server:v1.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">golang-codeready-workspace</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">schedulerName:</span> <span class=\"string\">default-scheduler</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://github.com/coder/code-server\" target=\"_blank\" rel=\"noopener\">GitHub - coder/code-server</a></li>\n<li><a href=\"https://coder.com/docs/code-server/latest\" target=\"_blank\" rel=\"noopener\">code-server v4.8.0 docs</a></li>\n<li><a href=\"https://hub.docker.com/_/golang\" target=\"_blank\" rel=\"noopener\">dockerhub - golang</a></li>\n<li><a href=\"https://www.jb51.net/article/261704.htm\" target=\"_blank\" rel=\"noopener\">äº‘ vscode æ­å»ºä¹‹ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²çš„æ–¹æ³•</a></li>\n<li><a href=\"https://blog.51cto.com/u_15061952/3607022\" target=\"_blank\" rel=\"noopener\">docker build æ—¶å‡ºç°é”™è¯¯ â€œdebconf: unable to initialize frontend: Dialogâ€ å¦‚ä½•å¤„ç†ï¼Ÿ</a></li>\n</ul>\n"},{"title":"Go è¯­è¨€å¼€å‘ç¯å¢ƒéƒ¨ç½²","subtitle":"Deploy Golang Developement Environment on Linux and Windows","header-img":"golang-develop-bg.svg","date":"2022-11-26T05:41:05.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼šCentOS Linux release 7.4.1708 (Core)\n- Golang ç‰ˆæœ¬ï¼šgo1.12 linux/amd64\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒ\n- Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Golang å¼€å‘ç¯å¢ƒæ’ä»¶\n- Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒ\n- vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒ\n\n### Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\n- å¯ç›´æ¥ä½¿ç”¨ `.msi` å®‰è£…åŒ…æ ¹æ®æç¤ºå®‰è£…ï¼Œgo ç¯å¢ƒå˜é‡å¯å‚è€ƒ Linux ä¸­ go ç¯å¢ƒå˜é‡è®¾ç½®ã€‚\n\n### Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Go å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\n- å®‰è£…é…è‰²æ–¹æ¡ˆï¼ˆä»¥ **`Panda`** é…è‰²æ–¹æ¡ˆä¸ºä¾‹ï¼‰ï¼š  \n  - å¸¸ç”¨é…è‰²æ–¹æ¡ˆï¼šDraculaã€Pandaã€‚  \n  - æ‰“å¼€ Sublime Text 3ï¼ŒæŒ‰ **`Ctrl+Shift+P`** æ‰“å¼€æ§åˆ¶çª—å£ã€‚  \n  - è¾“å…¥ `install`ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª Install Package ä»¥å®‰è£…ç›¸å…³é…è‰²æ–¹æ¡ˆã€‚    \n    ![sublime-text-golang-1](sublime-text-golang-1.png)  \n  - è¾“å…¥ç›¸å…³é…è‰²æ–¹æ¡ˆåç§°ï¼Œå¹¶é€‰æ‹©å®‰è£…ï¼Œå…¶å®‰è£…è¿‡ç¨‹æ˜¾ç¤ºåœ¨çª—å£æœ€åº•ç«¯ã€‚    \n    ![sublime-text-golang-2](sublime-text-golang-2.png)  \n  - é…è‰²æ–¹æ¡ˆå®‰è£…å®Œæ¯•åï¼Œå¯åœ¨å¦‚ä¸‹è·¯å¾„é€‰æ‹©ä½¿ç”¨ï¼š    \n    Preferences > Color Scheme... > **`panda-syntax`**    \n    ![sublime-text-golang-3](sublime-text-golang-3.png)\n- å®‰è£… Golang å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š  \n  - æŒ‰ **`Ctrl+Shift+P`** æ‰“å¼€æ§åˆ¶çª—å£ã€‚  \n  - è¾“å…¥ golang åå°†åŠ è½½æ˜¾ç¤º **`Golang Build`** å®˜æ–¹æ’ä»¶ï¼Œç‚¹å‡»å®‰è£…è¯¥æ’ä»¶ã€‚  \n  - å®Œæˆå®‰è£…åé…ç½®è¯¥æ’ä»¶ï¼š    \n    Preferences > Package Settings > Golang Config > **`Settings-User`**  \n  - ä¸º Golang Build æ’ä»¶å®šä¹‰ Golang è¯­è¨€ç¯å¢ƒå˜é‡ï¼š    \n    ![sublime-text-golang-4](sublime-text-golang-4.png)  \n  - é…ç½®è‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golangï¼š    \n    - åˆ›å»ºè‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golang çš„é…ç½®æ–‡ä»¶ï¼š    \n    - Tools > Build System > **`New Build System...`**    \n    - å®šä¹‰ç¼–è¯‘è¿è¡Œ Golang çš„å‘½ä»¤ä¸å‚æ•°ï¼Œå¹¶å°†å…¶å‘½åä¸º **`GoBuild.sublime-build`** ä¿å­˜ã€‚    \n    - è¯¥å®šä¹‰æ–‡ä»¶åç§°å¯è‡ªå®šä¹‰ã€‚      \n      ![sublime-text-golang-5](sublime-text-golang-5.png)![sublime-text-golang-6](sublime-text-golang-6.png)  \n  - æ‰“å¼€æµ‹è¯•ç”¨ go æ–‡ä»¶ï¼Œä½¿ç”¨ **`Ctrl+B`** ç¼–è¯‘è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚    \n    ![sublime-text-golang-7.png](sublime-text-golang-7.png)![sublime-text-golang-8.png](sublime-text-golang-8.png)\n\n### Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\n- ä¸‹è½½ Golang è¯­è¨€ç¯å¢ƒå‹ç¼©åŒ…ï¼šgo1.12.linux-amd64.tar.gz\n- Golang è¯­è¨€ç¯å¢ƒå®‰è£…ï¼š  \n  ```bash\n  $ sudo tar -zxvf go1.12.linux-amd64.tar.gz -C /usr/local\n  # è§£å‹å¹¶è§£åŒ… go è¯­è¨€ç¯å¢ƒ\n  $ mkdir -p $HOME/go/{bin,pkg,src}\n  # åˆ›å»º go è¯­è¨€å·¥ä½œç›®å½•æ ‘\n  $ vim $HOME/.bashrc\n    ### Define Go programme environment ###\n    export GOROOT=/usr/local/go  \n    # root directory to install go\n    export GOPATH=$HOME/go       \n    # directory to store go project \n    export GOBIN=$GOPATH/bin     \n    # store go command builded \n    export PATH=$PATH:$GOROOT/bin:$GOBIN\n  \n  $ source $HOME/.bashrc\n  # åŠ è½½ go è¯­è¨€ç¯å¢ƒå˜é‡\n  $ go version\n    go version go1.12 linux/amd64\n  # æŸ¥çœ‹ go è¯­è¨€ç¯å¢ƒç‰ˆæœ¬\n  ```\n\n### vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\n- ç”±äº CentOS 7.4 è‡ªå¸¦çš„ vim ç‰ˆæœ¬ä¸º `vim-enhanced-7.4.160-2.el7.x86_64`ï¼Œè¯¥ç‰ˆæœ¬ä¸æ”¯æŒ golang è¯­è¨€çš„è¯­æ³•é«˜äº®ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦é¢å¤–å®‰è£… **`vim-go`** æ’ä»¶ç”¨ä»¥æ”¯æŒè¯¥ç‰¹æ€§ï¼Œè€Œ CentOS 8.x æˆ– RHEL 8.x ä¸­è‡ªå¸¦ `vim 8` å¯æ”¯æŒã€‚\n- é…ç½®æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\n  - ğŸ‘‰ Vim æ’ä»¶ç®¡ç†å™¨ä½¿ç”¨ï¼š\n  ```bash\n  $ git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim\n  # ä¸‹è½½å®‰è£… vim æ’ä»¶ç®¡ç†å™¨\n  $ cd ~/.vim/bundle/Vundle.vim/ && vim README.md\n    set nocompatible              # be iMproved, required\n    filetype off                  # required\n  \n    # set the runtime path to include Vundle and initialize\n    set rtp+=~/.vim/bundle/Vundle.vim\n    call vundle#begin()\n    # alternatively, pass a path where Vundle should install plugins\n    #call vundle#begin('~/some/path/here')\n  \n    # let Vundle manage Vundle, required\n    Plugin 'VundleVim/Vundle.vim'\n  \n    # The following are examples of different formats supported.\n    # Keep Plugin commands between vundle#begin/end.\n    # plugin on GitHub repo\n    Plugin 'tpope/vim-fugitive'\n    # plugin from http://vim-scripts.org/vim/scripts.html\n    # Plugin 'L9'\n    # Git plugin not hosted on GitHub\n    Plugin 'git://git.wincent.com/command-t.git'\n    # git repos on your local machine (i.e. when working on your own plugin)\n    Plugin 'file:///home/gmarik/path/to/plugin'\n    # The sparkup vim script is in a subdirectory of this repo called vim.\n    # Pass the path to set the runtimepath properly.\n    Plugin 'rstacruz/sparkup', {'rtp': 'vim/'}\n    # Install L9 and avoid a Naming conflict if you've already installed a\n    # different version somewhere else.\n    # Plugin 'ascenator/L9', {'name': 'newL9'}\n  \n    # All of your Plugins must be added before the following line\n    call vundle#end()            \" required\n    filetype plugin indent on    \" required\n    # To ignore plugin indent changes, instead use:\n    #filetype plugin on\n    #\n    # Brief help\n    # :PluginList       - lists configured plugins\n    # :PluginInstall    - installs plugins; append `!` to update or just :PluginUpdate\n    # :PluginSearch foo - searches for foo; append `!` to refresh local cache\n    # :PluginClean      - confirms removal of unused plugins; append `!` to auto-approve removal\n    #\n    # see :h vundle for more details or wiki for FAQ\n    # Put your non-Plugin stuff after this line   \n  # è¿›å…¥ vim æ’ä»¶ç®¡ç†å™¨ç›®å½•ï¼Œå¹¶é€‰æ‹© \"3. Configure Plugins\" ä¸­çš„ç›¸åº”æ’ä»¶å†…å®¹ï¼Œå°†å…¶å¤åˆ¶è‡³ ~/.vimrc æ–‡ä»¶çš„é¡¶éƒ¨ã€‚\n  # å¯æ ¹æ®éœ€è¦æ·»åŠ æˆ–åˆ é™¤æŒ‡å®šçš„æ’ä»¶ã€‚\n  \n  $ git clone https://github.com/fatih/vim-go.git ~/.vim/bundle/vim-go\n  # ä¸‹è½½å®‰è£… vim-go æ’ä»¶ä½¿ vim æ”¯æŒ Go è¯­è¨€å¼€å‘ï¼ŒåŒ…æ‹¬è¯­æ³•é«˜äº®ã€è¯­æ³•é”™è¯¯æ£€æŸ¥ç­‰ã€‚\n  # æ³¨æ„è¯¥æ’ä»¶çš„ä¸‹è½½è·¯å¾„ï¼\n  ```\n  - ğŸ‘‰ å¯ç”¨ `vim-go` æ’ä»¶ï¼š\n  ```bash\n  $ vim ~/.vimrc\n    # Configure Go Programming Language vim Environment\n    # set nocompatible              \" be iMproved, required\n    filetype off                    # required\n  \n    set rtp+=~/.vim/bundle/Vundle.vim\n    call vundle#begin()\n  \n    # Install vim-go\n    Plugin 'fatih/vim-go'\n    # Install Dracula color theme\n    Plugin 'dracula/vim', {'name': 'dracula'}\n  \n    call vundle#end()            \" required\n    filetype plugin indent on    \" required\n  \n    # Extented Command\n    let g:go_version_warning = 0\n    # ç”±äº vim ç‰ˆæœ¬è¿‡ä½åœ¨å¯åŠ¨æ—¶å°†æŠ¥é”™ï¼Œè¯¥æŒ‡ä»¤å¯å»é™¤æŠ¥é”™ã€‚\n    set nu\n    set tabstop=2\n    # set cursorline\n    # set cursorcolumn\n    # colorscheme dracula\n    colorscheme elflord\n  \n    # Auto YAML syntax\n    autocmd FileType yaml setlocal ai ts=2 sw=2 et\n  \n  $ vim +PluginInstall +qall\n  # å®‰è£…æ‰€æœ‰çš„ vim æ’ä»¶\n  $ vim <go_filename>.go\n  # ç¼–è¾‘ go æ–‡ä»¶éªŒè¯ vim-go æ’ä»¶å®‰è£…\n  ```\n\n- è‹¥ä¸æ·»åŠ  **`let g:go_version_warning = 0`**ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼Œå¯ç›´æ¥å›è½¦ç»§ç»­ä½¿ç”¨ vimã€‚\n  ![vim-error](vim-error.jpg)\n","source":"_posts/golang-environment-deploy.md","raw":"---\ntitle: Go è¯­è¨€å¼€å‘ç¯å¢ƒéƒ¨ç½²\nsubtitle: Deploy Golang Developement Environment on Linux and Windows\nheader-img: golang-develop-bg.svg\ndate: 2022-11-26 13:41:05\ntags:\n  - Golang\n  - äº‘åŸç”Ÿ\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼šCentOS Linux release 7.4.1708 (Core)\n- Golang ç‰ˆæœ¬ï¼šgo1.12 linux/amd64\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒ\n- Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Golang å¼€å‘ç¯å¢ƒæ’ä»¶\n- Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒ\n- vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒ\n\n### Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\n- å¯ç›´æ¥ä½¿ç”¨ `.msi` å®‰è£…åŒ…æ ¹æ®æç¤ºå®‰è£…ï¼Œgo ç¯å¢ƒå˜é‡å¯å‚è€ƒ Linux ä¸­ go ç¯å¢ƒå˜é‡è®¾ç½®ã€‚\n\n### Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Go å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\n- å®‰è£…é…è‰²æ–¹æ¡ˆï¼ˆä»¥ **`Panda`** é…è‰²æ–¹æ¡ˆä¸ºä¾‹ï¼‰ï¼š  \n  - å¸¸ç”¨é…è‰²æ–¹æ¡ˆï¼šDraculaã€Pandaã€‚  \n  - æ‰“å¼€ Sublime Text 3ï¼ŒæŒ‰ **`Ctrl+Shift+P`** æ‰“å¼€æ§åˆ¶çª—å£ã€‚  \n  - è¾“å…¥ `install`ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª Install Package ä»¥å®‰è£…ç›¸å…³é…è‰²æ–¹æ¡ˆã€‚    \n    ![sublime-text-golang-1](sublime-text-golang-1.png)  \n  - è¾“å…¥ç›¸å…³é…è‰²æ–¹æ¡ˆåç§°ï¼Œå¹¶é€‰æ‹©å®‰è£…ï¼Œå…¶å®‰è£…è¿‡ç¨‹æ˜¾ç¤ºåœ¨çª—å£æœ€åº•ç«¯ã€‚    \n    ![sublime-text-golang-2](sublime-text-golang-2.png)  \n  - é…è‰²æ–¹æ¡ˆå®‰è£…å®Œæ¯•åï¼Œå¯åœ¨å¦‚ä¸‹è·¯å¾„é€‰æ‹©ä½¿ç”¨ï¼š    \n    Preferences > Color Scheme... > **`panda-syntax`**    \n    ![sublime-text-golang-3](sublime-text-golang-3.png)\n- å®‰è£… Golang å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š  \n  - æŒ‰ **`Ctrl+Shift+P`** æ‰“å¼€æ§åˆ¶çª—å£ã€‚  \n  - è¾“å…¥ golang åå°†åŠ è½½æ˜¾ç¤º **`Golang Build`** å®˜æ–¹æ’ä»¶ï¼Œç‚¹å‡»å®‰è£…è¯¥æ’ä»¶ã€‚  \n  - å®Œæˆå®‰è£…åé…ç½®è¯¥æ’ä»¶ï¼š    \n    Preferences > Package Settings > Golang Config > **`Settings-User`**  \n  - ä¸º Golang Build æ’ä»¶å®šä¹‰ Golang è¯­è¨€ç¯å¢ƒå˜é‡ï¼š    \n    ![sublime-text-golang-4](sublime-text-golang-4.png)  \n  - é…ç½®è‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golangï¼š    \n    - åˆ›å»ºè‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golang çš„é…ç½®æ–‡ä»¶ï¼š    \n    - Tools > Build System > **`New Build System...`**    \n    - å®šä¹‰ç¼–è¯‘è¿è¡Œ Golang çš„å‘½ä»¤ä¸å‚æ•°ï¼Œå¹¶å°†å…¶å‘½åä¸º **`GoBuild.sublime-build`** ä¿å­˜ã€‚    \n    - è¯¥å®šä¹‰æ–‡ä»¶åç§°å¯è‡ªå®šä¹‰ã€‚      \n      ![sublime-text-golang-5](sublime-text-golang-5.png)![sublime-text-golang-6](sublime-text-golang-6.png)  \n  - æ‰“å¼€æµ‹è¯•ç”¨ go æ–‡ä»¶ï¼Œä½¿ç”¨ **`Ctrl+B`** ç¼–è¯‘è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚    \n    ![sublime-text-golang-7.png](sublime-text-golang-7.png)![sublime-text-golang-8.png](sublime-text-golang-8.png)\n\n### Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\n- ä¸‹è½½ Golang è¯­è¨€ç¯å¢ƒå‹ç¼©åŒ…ï¼šgo1.12.linux-amd64.tar.gz\n- Golang è¯­è¨€ç¯å¢ƒå®‰è£…ï¼š  \n  ```bash\n  $ sudo tar -zxvf go1.12.linux-amd64.tar.gz -C /usr/local\n  # è§£å‹å¹¶è§£åŒ… go è¯­è¨€ç¯å¢ƒ\n  $ mkdir -p $HOME/go/{bin,pkg,src}\n  # åˆ›å»º go è¯­è¨€å·¥ä½œç›®å½•æ ‘\n  $ vim $HOME/.bashrc\n    ### Define Go programme environment ###\n    export GOROOT=/usr/local/go  \n    # root directory to install go\n    export GOPATH=$HOME/go       \n    # directory to store go project \n    export GOBIN=$GOPATH/bin     \n    # store go command builded \n    export PATH=$PATH:$GOROOT/bin:$GOBIN\n  \n  $ source $HOME/.bashrc\n  # åŠ è½½ go è¯­è¨€ç¯å¢ƒå˜é‡\n  $ go version\n    go version go1.12 linux/amd64\n  # æŸ¥çœ‹ go è¯­è¨€ç¯å¢ƒç‰ˆæœ¬\n  ```\n\n### vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\n- ç”±äº CentOS 7.4 è‡ªå¸¦çš„ vim ç‰ˆæœ¬ä¸º `vim-enhanced-7.4.160-2.el7.x86_64`ï¼Œè¯¥ç‰ˆæœ¬ä¸æ”¯æŒ golang è¯­è¨€çš„è¯­æ³•é«˜äº®ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦é¢å¤–å®‰è£… **`vim-go`** æ’ä»¶ç”¨ä»¥æ”¯æŒè¯¥ç‰¹æ€§ï¼Œè€Œ CentOS 8.x æˆ– RHEL 8.x ä¸­è‡ªå¸¦ `vim 8` å¯æ”¯æŒã€‚\n- é…ç½®æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š\n  - ğŸ‘‰ Vim æ’ä»¶ç®¡ç†å™¨ä½¿ç”¨ï¼š\n  ```bash\n  $ git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim\n  # ä¸‹è½½å®‰è£… vim æ’ä»¶ç®¡ç†å™¨\n  $ cd ~/.vim/bundle/Vundle.vim/ && vim README.md\n    set nocompatible              # be iMproved, required\n    filetype off                  # required\n  \n    # set the runtime path to include Vundle and initialize\n    set rtp+=~/.vim/bundle/Vundle.vim\n    call vundle#begin()\n    # alternatively, pass a path where Vundle should install plugins\n    #call vundle#begin('~/some/path/here')\n  \n    # let Vundle manage Vundle, required\n    Plugin 'VundleVim/Vundle.vim'\n  \n    # The following are examples of different formats supported.\n    # Keep Plugin commands between vundle#begin/end.\n    # plugin on GitHub repo\n    Plugin 'tpope/vim-fugitive'\n    # plugin from http://vim-scripts.org/vim/scripts.html\n    # Plugin 'L9'\n    # Git plugin not hosted on GitHub\n    Plugin 'git://git.wincent.com/command-t.git'\n    # git repos on your local machine (i.e. when working on your own plugin)\n    Plugin 'file:///home/gmarik/path/to/plugin'\n    # The sparkup vim script is in a subdirectory of this repo called vim.\n    # Pass the path to set the runtimepath properly.\n    Plugin 'rstacruz/sparkup', {'rtp': 'vim/'}\n    # Install L9 and avoid a Naming conflict if you've already installed a\n    # different version somewhere else.\n    # Plugin 'ascenator/L9', {'name': 'newL9'}\n  \n    # All of your Plugins must be added before the following line\n    call vundle#end()            \" required\n    filetype plugin indent on    \" required\n    # To ignore plugin indent changes, instead use:\n    #filetype plugin on\n    #\n    # Brief help\n    # :PluginList       - lists configured plugins\n    # :PluginInstall    - installs plugins; append `!` to update or just :PluginUpdate\n    # :PluginSearch foo - searches for foo; append `!` to refresh local cache\n    # :PluginClean      - confirms removal of unused plugins; append `!` to auto-approve removal\n    #\n    # see :h vundle for more details or wiki for FAQ\n    # Put your non-Plugin stuff after this line   \n  # è¿›å…¥ vim æ’ä»¶ç®¡ç†å™¨ç›®å½•ï¼Œå¹¶é€‰æ‹© \"3. Configure Plugins\" ä¸­çš„ç›¸åº”æ’ä»¶å†…å®¹ï¼Œå°†å…¶å¤åˆ¶è‡³ ~/.vimrc æ–‡ä»¶çš„é¡¶éƒ¨ã€‚\n  # å¯æ ¹æ®éœ€è¦æ·»åŠ æˆ–åˆ é™¤æŒ‡å®šçš„æ’ä»¶ã€‚\n  \n  $ git clone https://github.com/fatih/vim-go.git ~/.vim/bundle/vim-go\n  # ä¸‹è½½å®‰è£… vim-go æ’ä»¶ä½¿ vim æ”¯æŒ Go è¯­è¨€å¼€å‘ï¼ŒåŒ…æ‹¬è¯­æ³•é«˜äº®ã€è¯­æ³•é”™è¯¯æ£€æŸ¥ç­‰ã€‚\n  # æ³¨æ„è¯¥æ’ä»¶çš„ä¸‹è½½è·¯å¾„ï¼\n  ```\n  - ğŸ‘‰ å¯ç”¨ `vim-go` æ’ä»¶ï¼š\n  ```bash\n  $ vim ~/.vimrc\n    # Configure Go Programming Language vim Environment\n    # set nocompatible              \" be iMproved, required\n    filetype off                    # required\n  \n    set rtp+=~/.vim/bundle/Vundle.vim\n    call vundle#begin()\n  \n    # Install vim-go\n    Plugin 'fatih/vim-go'\n    # Install Dracula color theme\n    Plugin 'dracula/vim', {'name': 'dracula'}\n  \n    call vundle#end()            \" required\n    filetype plugin indent on    \" required\n  \n    # Extented Command\n    let g:go_version_warning = 0\n    # ç”±äº vim ç‰ˆæœ¬è¿‡ä½åœ¨å¯åŠ¨æ—¶å°†æŠ¥é”™ï¼Œè¯¥æŒ‡ä»¤å¯å»é™¤æŠ¥é”™ã€‚\n    set nu\n    set tabstop=2\n    # set cursorline\n    # set cursorcolumn\n    # colorscheme dracula\n    colorscheme elflord\n  \n    # Auto YAML syntax\n    autocmd FileType yaml setlocal ai ts=2 sw=2 et\n  \n  $ vim +PluginInstall +qall\n  # å®‰è£…æ‰€æœ‰çš„ vim æ’ä»¶\n  $ vim <go_filename>.go\n  # ç¼–è¾‘ go æ–‡ä»¶éªŒè¯ vim-go æ’ä»¶å®‰è£…\n  ```\n\n- è‹¥ä¸æ·»åŠ  **`let g:go_version_warning = 0`**ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼Œå¯ç›´æ¥å›è½¦ç»§ç»­ä½¿ç”¨ vimã€‚\n  ![vim-error](vim-error.jpg)\n","slug":"golang-environment-deploy","published":1,"updated":"2022-11-28T10:33:00.973Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonokg000616vdxjsn08as","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼šCentOS Linux release 7.4.1708 (Core)</li>\n<li>Golang ç‰ˆæœ¬ï¼šgo1.12 linux/amd64</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒ</li>\n<li>Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Golang å¼€å‘ç¯å¢ƒæ’ä»¶</li>\n<li>Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒ</li>\n<li>vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒ</li>\n</ul>\n<h3 id=\"Windows-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\"><a href=\"#Windows-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\"></a>Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š</h3><ul>\n<li>å¯ç›´æ¥ä½¿ç”¨ <code>.msi</code> å®‰è£…åŒ…æ ¹æ®æç¤ºå®‰è£…ï¼Œgo ç¯å¢ƒå˜é‡å¯å‚è€ƒ Linux ä¸­ go ç¯å¢ƒå˜é‡è®¾ç½®ã€‚</li>\n</ul>\n<h3 id=\"Windows-ä¸‹-Sublime-Text-3-å®‰è£…é…è‰²æ–¹æ¡ˆä¸-Go-å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\"><a href=\"#Windows-ä¸‹-Sublime-Text-3-å®‰è£…é…è‰²æ–¹æ¡ˆä¸-Go-å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\" class=\"headerlink\" title=\"Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Go å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\"></a>Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Go å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š</h3><ul>\n<li>å®‰è£…é…è‰²æ–¹æ¡ˆï¼ˆä»¥ <strong><code>Panda</code></strong> é…è‰²æ–¹æ¡ˆä¸ºä¾‹ï¼‰ï¼š  <ul>\n<li>å¸¸ç”¨é…è‰²æ–¹æ¡ˆï¼šDraculaã€Pandaã€‚  </li>\n<li>æ‰“å¼€ Sublime Text 3ï¼ŒæŒ‰ <strong><code>Ctrl+Shift+P</code></strong> æ‰“å¼€æ§åˆ¶çª—å£ã€‚  </li>\n<li>è¾“å…¥ <code>install</code>ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª Install Package ä»¥å®‰è£…ç›¸å…³é…è‰²æ–¹æ¡ˆã€‚<br><img src=\"sublime-text-golang-1.png\" alt=\"sublime-text-golang-1\">  </li>\n<li>è¾“å…¥ç›¸å…³é…è‰²æ–¹æ¡ˆåç§°ï¼Œå¹¶é€‰æ‹©å®‰è£…ï¼Œå…¶å®‰è£…è¿‡ç¨‹æ˜¾ç¤ºåœ¨çª—å£æœ€åº•ç«¯ã€‚<br><img src=\"sublime-text-golang-2.png\" alt=\"sublime-text-golang-2\">  </li>\n<li>é…è‰²æ–¹æ¡ˆå®‰è£…å®Œæ¯•åï¼Œå¯åœ¨å¦‚ä¸‹è·¯å¾„é€‰æ‹©ä½¿ç”¨ï¼š<br>Preferences &gt; Color Schemeâ€¦ &gt; <strong><code>panda-syntax</code></strong><br><img src=\"sublime-text-golang-3.png\" alt=\"sublime-text-golang-3\"></li>\n</ul>\n</li>\n<li>å®‰è£… Golang å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š  <ul>\n<li>æŒ‰ <strong><code>Ctrl+Shift+P</code></strong> æ‰“å¼€æ§åˆ¶çª—å£ã€‚  </li>\n<li>è¾“å…¥ golang åå°†åŠ è½½æ˜¾ç¤º <strong><code>Golang Build</code></strong> å®˜æ–¹æ’ä»¶ï¼Œç‚¹å‡»å®‰è£…è¯¥æ’ä»¶ã€‚  </li>\n<li>å®Œæˆå®‰è£…åé…ç½®è¯¥æ’ä»¶ï¼š<br>Preferences &gt; Package Settings &gt; Golang Config &gt; <strong><code>Settings-User</code></strong>  </li>\n<li>ä¸º Golang Build æ’ä»¶å®šä¹‰ Golang è¯­è¨€ç¯å¢ƒå˜é‡ï¼š<br><img src=\"sublime-text-golang-4.png\" alt=\"sublime-text-golang-4\">  </li>\n<li>é…ç½®è‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golangï¼š    <ul>\n<li>åˆ›å»ºè‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golang çš„é…ç½®æ–‡ä»¶ï¼š    </li>\n<li>Tools &gt; Build System &gt; <strong><code>New Build System...</code></strong>    </li>\n<li>å®šä¹‰ç¼–è¯‘è¿è¡Œ Golang çš„å‘½ä»¤ä¸å‚æ•°ï¼Œå¹¶å°†å…¶å‘½åä¸º <strong><code>GoBuild.sublime-build</code></strong> ä¿å­˜ã€‚    </li>\n<li>è¯¥å®šä¹‰æ–‡ä»¶åç§°å¯è‡ªå®šä¹‰ã€‚<br><img src=\"sublime-text-golang-5.png\" alt=\"sublime-text-golang-5\"><img src=\"sublime-text-golang-6.png\" alt=\"sublime-text-golang-6\">  </li>\n</ul>\n</li>\n<li>æ‰“å¼€æµ‹è¯•ç”¨ go æ–‡ä»¶ï¼Œä½¿ç”¨ <strong><code>Ctrl+B</code></strong> ç¼–è¯‘è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚<br><img src=\"sublime-text-golang-7.png\" alt=\"sublime-text-golang-7.png\"><img src=\"sublime-text-golang-8.png\" alt=\"sublime-text-golang-8.png\"></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Linux-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\"><a href=\"#Linux-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\"></a>Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š</h3><ul>\n<li>ä¸‹è½½ Golang è¯­è¨€ç¯å¢ƒå‹ç¼©åŒ…ï¼šgo1.12.linux-amd64.tar.gz</li>\n<li>Golang è¯­è¨€ç¯å¢ƒå®‰è£…ï¼š  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo tar -zxvf go1.12.linux-amd64.tar.gz -C /usr/<span class=\"built_in\">local</span></span><br><span class=\"line\"><span class=\"comment\"># è§£å‹å¹¶è§£åŒ… go è¯­è¨€ç¯å¢ƒ</span></span><br><span class=\"line\">$ mkdir -p <span class=\"variable\">$HOME</span>/go/&#123;bin,pkg,src&#125;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º go è¯­è¨€å·¥ä½œç›®å½•æ ‘</span></span><br><span class=\"line\">$ vim <span class=\"variable\">$HOME</span>/.bashrc</span><br><span class=\"line\">  <span class=\"comment\">### Define Go programme environment ###</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOROOT=/usr/<span class=\"built_in\">local</span>/go  </span><br><span class=\"line\">  <span class=\"comment\"># root directory to install go</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOPATH=<span class=\"variable\">$HOME</span>/go       </span><br><span class=\"line\">  <span class=\"comment\"># directory to store go project </span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOBIN=<span class=\"variable\">$GOPATH</span>/bin     </span><br><span class=\"line\">  <span class=\"comment\"># store go command builded </span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$GOROOT</span>/bin:<span class=\"variable\">$GOBIN</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">source</span> <span class=\"variable\">$HOME</span>/.bashrc</span><br><span class=\"line\"><span class=\"comment\"># åŠ è½½ go è¯­è¨€ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">$ go version</span><br><span class=\"line\">  go version go1.12 linux/amd64</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ go è¯­è¨€ç¯å¢ƒç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"vim-go-æ’ä»¶é…ç½®-Go-è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\"><a href=\"#vim-go-æ’ä»¶é…ç½®-Go-è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\"></a>vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒï¼š</h3><ul>\n<li>ç”±äº CentOS 7.4 è‡ªå¸¦çš„ vim ç‰ˆæœ¬ä¸º <code>vim-enhanced-7.4.160-2.el7.x86_64</code>ï¼Œè¯¥ç‰ˆæœ¬ä¸æ”¯æŒ golang è¯­è¨€çš„è¯­æ³•é«˜äº®ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦é¢å¤–å®‰è£… <strong><code>vim-go</code></strong> æ’ä»¶ç”¨ä»¥æ”¯æŒè¯¥ç‰¹æ€§ï¼Œè€Œ CentOS 8.x æˆ– RHEL 8.x ä¸­è‡ªå¸¦ <code>vim 8</code> å¯æ”¯æŒã€‚</li>\n<li><p>é…ç½®æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<ul>\n<li><p>ğŸ‘‰ Vim æ’ä»¶ç®¡ç†å™¨ä½¿ç”¨ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim</span><br><span class=\"line\"><span class=\"comment\"># ä¸‹è½½å®‰è£… vim æ’ä»¶ç®¡ç†å™¨</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> ~/.vim/bundle/Vundle.vim/ &amp;&amp; vim README.md</span><br><span class=\"line\">  <span class=\"built_in\">set</span> nocompatible              <span class=\"comment\"># be iMproved, required</span></span><br><span class=\"line\">  filetype off                  <span class=\"comment\"># required</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># set the runtime path to include Vundle and initialize</span></span><br><span class=\"line\">  <span class=\"built_in\">set</span> rtp+=~/.vim/bundle/Vundle.vim</span><br><span class=\"line\">  call vundle<span class=\"comment\">#begin()</span></span><br><span class=\"line\">  <span class=\"comment\"># alternatively, pass a path where Vundle should install plugins</span></span><br><span class=\"line\">  <span class=\"comment\">#call vundle#begin('~/some/path/here')</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># let Vundle manage Vundle, required</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'VundleVim/Vundle.vim'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># The following are examples of different formats supported.</span></span><br><span class=\"line\">  <span class=\"comment\"># Keep Plugin commands between vundle#begin/end.</span></span><br><span class=\"line\">  <span class=\"comment\"># plugin on GitHub repo</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'tpope/vim-fugitive'</span></span><br><span class=\"line\">  <span class=\"comment\"># plugin from http://vim-scripts.org/vim/scripts.html</span></span><br><span class=\"line\">  <span class=\"comment\"># Plugin 'L9'</span></span><br><span class=\"line\">  <span class=\"comment\"># Git plugin not hosted on GitHub</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'git://git.wincent.com/command-t.git'</span></span><br><span class=\"line\">  <span class=\"comment\"># git repos on your local machine (i.e. when working on your own plugin)</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'file:///home/gmarik/path/to/plugin'</span></span><br><span class=\"line\">  <span class=\"comment\"># The sparkup vim script is in a subdirectory of this repo called vim.</span></span><br><span class=\"line\">  <span class=\"comment\"># Pass the path to set the runtimepath properly.</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'rstacruz/sparkup'</span>, &#123;<span class=\"string\">'rtp'</span>: <span class=\"string\">'vim/'</span>&#125;</span><br><span class=\"line\">  <span class=\"comment\"># Install L9 and avoid a Naming conflict if you've already installed a</span></span><br><span class=\"line\">  <span class=\"comment\"># different version somewhere else.</span></span><br><span class=\"line\">  <span class=\"comment\"># Plugin 'ascenator/L9', &#123;'name': 'newL9'&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># All of your Plugins must be added before the following line</span></span><br><span class=\"line\">  call vundle<span class=\"comment\">#end()            \" required</span></span><br><span class=\"line\">  filetype plugin indent on    <span class=\"string\">\" required</span></span><br><span class=\"line\"><span class=\"string\">  # To ignore plugin indent changes, instead use:</span></span><br><span class=\"line\"><span class=\"string\">  #filetype plugin on</span></span><br><span class=\"line\"><span class=\"string\">  #</span></span><br><span class=\"line\"><span class=\"string\">  # Brief help</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginList       - lists configured plugins</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginInstall    - installs plugins; append `!` to update or just :PluginUpdate</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginSearch foo - searches for foo; append `!` to refresh local cache</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginClean      - confirms removal of unused plugins; append `!` to auto-approve removal</span></span><br><span class=\"line\"><span class=\"string\">  #</span></span><br><span class=\"line\"><span class=\"string\">  # see :h vundle for more details or wiki for FAQ</span></span><br><span class=\"line\"><span class=\"string\">  # Put your non-Plugin stuff after this line   </span></span><br><span class=\"line\"><span class=\"string\"># è¿›å…¥ vim æ’ä»¶ç®¡ç†å™¨ç›®å½•ï¼Œå¹¶é€‰æ‹© \"</span>3. Configure Plugins<span class=\"string\">\" ä¸­çš„ç›¸åº”æ’ä»¶å†…å®¹ï¼Œå°†å…¶å¤åˆ¶è‡³ ~/.vimrc æ–‡ä»¶çš„é¡¶éƒ¨ã€‚</span></span><br><span class=\"line\"><span class=\"string\"># å¯æ ¹æ®éœ€è¦æ·»åŠ æˆ–åˆ é™¤æŒ‡å®šçš„æ’ä»¶ã€‚</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">$ git clone https://github.com/fatih/vim-go.git ~/.vim/bundle/vim-go</span></span><br><span class=\"line\"><span class=\"string\"># ä¸‹è½½å®‰è£… vim-go æ’ä»¶ä½¿ vim æ”¯æŒ Go è¯­è¨€å¼€å‘ï¼ŒåŒ…æ‹¬è¯­æ³•é«˜äº®ã€è¯­æ³•é”™è¯¯æ£€æŸ¥ç­‰ã€‚</span></span><br><span class=\"line\"><span class=\"string\"># æ³¨æ„è¯¥æ’ä»¶çš„ä¸‹è½½è·¯å¾„ï¼</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ‘‰ å¯ç”¨ <code>vim-go</code> æ’ä»¶ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim ~/.vimrc</span><br><span class=\"line\">  <span class=\"comment\"># Configure Go Programming Language vim Environment</span></span><br><span class=\"line\">  <span class=\"comment\"># set nocompatible              \" be iMproved, required</span></span><br><span class=\"line\">  filetype off                    <span class=\"comment\"># required</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">set</span> rtp+=~/.vim/bundle/Vundle.vim</span><br><span class=\"line\">  call vundle<span class=\"comment\">#begin()</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Install vim-go</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'fatih/vim-go'</span></span><br><span class=\"line\">  <span class=\"comment\"># Install Dracula color theme</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'dracula/vim'</span>, &#123;<span class=\"string\">'name'</span>: <span class=\"string\">'dracula'</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  call vundle<span class=\"comment\">#end()            \" required</span></span><br><span class=\"line\">  filetype plugin indent on    <span class=\"string\">\" required</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # Extented Command</span></span><br><span class=\"line\"><span class=\"string\">  let g:go_version_warning = 0</span></span><br><span class=\"line\"><span class=\"string\">  # ç”±äº vim ç‰ˆæœ¬è¿‡ä½åœ¨å¯åŠ¨æ—¶å°†æŠ¥é”™ï¼Œè¯¥æŒ‡ä»¤å¯å»é™¤æŠ¥é”™ã€‚</span></span><br><span class=\"line\"><span class=\"string\">  set nu</span></span><br><span class=\"line\"><span class=\"string\">  set tabstop=2</span></span><br><span class=\"line\"><span class=\"string\">  # set cursorline</span></span><br><span class=\"line\"><span class=\"string\">  # set cursorcolumn</span></span><br><span class=\"line\"><span class=\"string\">  # colorscheme dracula</span></span><br><span class=\"line\"><span class=\"string\">  colorscheme elflord</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # Auto YAML syntax</span></span><br><span class=\"line\"><span class=\"string\">  autocmd FileType yaml setlocal ai ts=2 sw=2 et</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">$ vim +PluginInstall +qall</span></span><br><span class=\"line\"><span class=\"string\"># å®‰è£…æ‰€æœ‰çš„ vim æ’ä»¶</span></span><br><span class=\"line\"><span class=\"string\">$ vim &lt;go_filename&gt;.go</span></span><br><span class=\"line\"><span class=\"string\"># ç¼–è¾‘ go æ–‡ä»¶éªŒè¯ vim-go æ’ä»¶å®‰è£…</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>è‹¥ä¸æ·»åŠ  <strong><code>let g:go_version_warning = 0</code></strong>ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼Œå¯ç›´æ¥å›è½¦ç»§ç»­ä½¿ç”¨ vimã€‚<br><img src=\"vim-error.jpg\" alt=\"vim-error\"></p>\n</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼šCentOS Linux release 7.4.1708 (Core)</li>\n<li>Golang ç‰ˆæœ¬ï¼šgo1.12 linux/amd64</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒ</li>\n<li>Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Golang å¼€å‘ç¯å¢ƒæ’ä»¶</li>\n<li>Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒ</li>\n<li>vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒ</li>\n</ul>\n<h3 id=\"Windows-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\"><a href=\"#Windows-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\"></a>Windows å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š</h3><ul>\n<li>å¯ç›´æ¥ä½¿ç”¨ <code>.msi</code> å®‰è£…åŒ…æ ¹æ®æç¤ºå®‰è£…ï¼Œgo ç¯å¢ƒå˜é‡å¯å‚è€ƒ Linux ä¸­ go ç¯å¢ƒå˜é‡è®¾ç½®ã€‚</li>\n</ul>\n<h3 id=\"Windows-ä¸‹-Sublime-Text-3-å®‰è£…é…è‰²æ–¹æ¡ˆä¸-Go-å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\"><a href=\"#Windows-ä¸‹-Sublime-Text-3-å®‰è£…é…è‰²æ–¹æ¡ˆä¸-Go-å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\" class=\"headerlink\" title=\"Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Go å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š\"></a>Windows ä¸‹ Sublime Text 3 å®‰è£…é…è‰²æ–¹æ¡ˆä¸ Go å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š</h3><ul>\n<li>å®‰è£…é…è‰²æ–¹æ¡ˆï¼ˆä»¥ <strong><code>Panda</code></strong> é…è‰²æ–¹æ¡ˆä¸ºä¾‹ï¼‰ï¼š  <ul>\n<li>å¸¸ç”¨é…è‰²æ–¹æ¡ˆï¼šDraculaã€Pandaã€‚  </li>\n<li>æ‰“å¼€ Sublime Text 3ï¼ŒæŒ‰ <strong><code>Ctrl+Shift+P</code></strong> æ‰“å¼€æ§åˆ¶çª—å£ã€‚  </li>\n<li>è¾“å…¥ <code>install</code>ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª Install Package ä»¥å®‰è£…ç›¸å…³é…è‰²æ–¹æ¡ˆã€‚<br><img src=\"sublime-text-golang-1.png\" alt=\"sublime-text-golang-1\">  </li>\n<li>è¾“å…¥ç›¸å…³é…è‰²æ–¹æ¡ˆåç§°ï¼Œå¹¶é€‰æ‹©å®‰è£…ï¼Œå…¶å®‰è£…è¿‡ç¨‹æ˜¾ç¤ºåœ¨çª—å£æœ€åº•ç«¯ã€‚<br><img src=\"sublime-text-golang-2.png\" alt=\"sublime-text-golang-2\">  </li>\n<li>é…è‰²æ–¹æ¡ˆå®‰è£…å®Œæ¯•åï¼Œå¯åœ¨å¦‚ä¸‹è·¯å¾„é€‰æ‹©ä½¿ç”¨ï¼š<br>Preferences &gt; Color Schemeâ€¦ &gt; <strong><code>panda-syntax</code></strong><br><img src=\"sublime-text-golang-3.png\" alt=\"sublime-text-golang-3\"></li>\n</ul>\n</li>\n<li>å®‰è£… Golang å¼€å‘ç¯å¢ƒæ’ä»¶ï¼š  <ul>\n<li>æŒ‰ <strong><code>Ctrl+Shift+P</code></strong> æ‰“å¼€æ§åˆ¶çª—å£ã€‚  </li>\n<li>è¾“å…¥ golang åå°†åŠ è½½æ˜¾ç¤º <strong><code>Golang Build</code></strong> å®˜æ–¹æ’ä»¶ï¼Œç‚¹å‡»å®‰è£…è¯¥æ’ä»¶ã€‚  </li>\n<li>å®Œæˆå®‰è£…åé…ç½®è¯¥æ’ä»¶ï¼š<br>Preferences &gt; Package Settings &gt; Golang Config &gt; <strong><code>Settings-User</code></strong>  </li>\n<li>ä¸º Golang Build æ’ä»¶å®šä¹‰ Golang è¯­è¨€ç¯å¢ƒå˜é‡ï¼š<br><img src=\"sublime-text-golang-4.png\" alt=\"sublime-text-golang-4\">  </li>\n<li>é…ç½®è‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golangï¼š    <ul>\n<li>åˆ›å»ºè‡ªåŠ¨ç¼–è¯‘è¿è¡Œ Golang çš„é…ç½®æ–‡ä»¶ï¼š    </li>\n<li>Tools &gt; Build System &gt; <strong><code>New Build System...</code></strong>    </li>\n<li>å®šä¹‰ç¼–è¯‘è¿è¡Œ Golang çš„å‘½ä»¤ä¸å‚æ•°ï¼Œå¹¶å°†å…¶å‘½åä¸º <strong><code>GoBuild.sublime-build</code></strong> ä¿å­˜ã€‚    </li>\n<li>è¯¥å®šä¹‰æ–‡ä»¶åç§°å¯è‡ªå®šä¹‰ã€‚<br><img src=\"sublime-text-golang-5.png\" alt=\"sublime-text-golang-5\"><img src=\"sublime-text-golang-6.png\" alt=\"sublime-text-golang-6\">  </li>\n</ul>\n</li>\n<li>æ‰“å¼€æµ‹è¯•ç”¨ go æ–‡ä»¶ï¼Œä½¿ç”¨ <strong><code>Ctrl+B</code></strong> ç¼–è¯‘è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚<br><img src=\"sublime-text-golang-7.png\" alt=\"sublime-text-golang-7.png\"><img src=\"sublime-text-golang-8.png\" alt=\"sublime-text-golang-8.png\"></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Linux-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\"><a href=\"#Linux-å®‰è£…-Go-è¯­è¨€ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š\"></a>Linux å®‰è£… Go è¯­è¨€ç¯å¢ƒï¼š</h3><ul>\n<li>ä¸‹è½½ Golang è¯­è¨€ç¯å¢ƒå‹ç¼©åŒ…ï¼šgo1.12.linux-amd64.tar.gz</li>\n<li>Golang è¯­è¨€ç¯å¢ƒå®‰è£…ï¼š  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo tar -zxvf go1.12.linux-amd64.tar.gz -C /usr/<span class=\"built_in\">local</span></span><br><span class=\"line\"><span class=\"comment\"># è§£å‹å¹¶è§£åŒ… go è¯­è¨€ç¯å¢ƒ</span></span><br><span class=\"line\">$ mkdir -p <span class=\"variable\">$HOME</span>/go/&#123;bin,pkg,src&#125;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º go è¯­è¨€å·¥ä½œç›®å½•æ ‘</span></span><br><span class=\"line\">$ vim <span class=\"variable\">$HOME</span>/.bashrc</span><br><span class=\"line\">  <span class=\"comment\">### Define Go programme environment ###</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOROOT=/usr/<span class=\"built_in\">local</span>/go  </span><br><span class=\"line\">  <span class=\"comment\"># root directory to install go</span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOPATH=<span class=\"variable\">$HOME</span>/go       </span><br><span class=\"line\">  <span class=\"comment\"># directory to store go project </span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> GOBIN=<span class=\"variable\">$GOPATH</span>/bin     </span><br><span class=\"line\">  <span class=\"comment\"># store go command builded </span></span><br><span class=\"line\">  <span class=\"built_in\">export</span> PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$GOROOT</span>/bin:<span class=\"variable\">$GOBIN</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ <span class=\"built_in\">source</span> <span class=\"variable\">$HOME</span>/.bashrc</span><br><span class=\"line\"><span class=\"comment\"># åŠ è½½ go è¯­è¨€ç¯å¢ƒå˜é‡</span></span><br><span class=\"line\">$ go version</span><br><span class=\"line\">  go version go1.12 linux/amd64</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ go è¯­è¨€ç¯å¢ƒç‰ˆæœ¬</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"vim-go-æ’ä»¶é…ç½®-Go-è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\"><a href=\"#vim-go-æ’ä»¶é…ç½®-Go-è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒï¼š\"></a>vim-go æ’ä»¶é…ç½® Go è¯­è¨€å¼€å‘ç¯å¢ƒï¼š</h3><ul>\n<li>ç”±äº CentOS 7.4 è‡ªå¸¦çš„ vim ç‰ˆæœ¬ä¸º <code>vim-enhanced-7.4.160-2.el7.x86_64</code>ï¼Œè¯¥ç‰ˆæœ¬ä¸æ”¯æŒ golang è¯­è¨€çš„è¯­æ³•é«˜äº®ç‰¹æ€§ï¼Œå› æ­¤éœ€è¦é¢å¤–å®‰è£… <strong><code>vim-go</code></strong> æ’ä»¶ç”¨ä»¥æ”¯æŒè¯¥ç‰¹æ€§ï¼Œè€Œ CentOS 8.x æˆ– RHEL 8.x ä¸­è‡ªå¸¦ <code>vim 8</code> å¯æ”¯æŒã€‚</li>\n<li><p>é…ç½®æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<ul>\n<li><p>ğŸ‘‰ Vim æ’ä»¶ç®¡ç†å™¨ä½¿ç”¨ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ git <span class=\"built_in\">clone</span> https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim</span><br><span class=\"line\"><span class=\"comment\"># ä¸‹è½½å®‰è£… vim æ’ä»¶ç®¡ç†å™¨</span></span><br><span class=\"line\">$ <span class=\"built_in\">cd</span> ~/.vim/bundle/Vundle.vim/ &amp;&amp; vim README.md</span><br><span class=\"line\">  <span class=\"built_in\">set</span> nocompatible              <span class=\"comment\"># be iMproved, required</span></span><br><span class=\"line\">  filetype off                  <span class=\"comment\"># required</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># set the runtime path to include Vundle and initialize</span></span><br><span class=\"line\">  <span class=\"built_in\">set</span> rtp+=~/.vim/bundle/Vundle.vim</span><br><span class=\"line\">  call vundle<span class=\"comment\">#begin()</span></span><br><span class=\"line\">  <span class=\"comment\"># alternatively, pass a path where Vundle should install plugins</span></span><br><span class=\"line\">  <span class=\"comment\">#call vundle#begin('~/some/path/here')</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># let Vundle manage Vundle, required</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'VundleVim/Vundle.vim'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># The following are examples of different formats supported.</span></span><br><span class=\"line\">  <span class=\"comment\"># Keep Plugin commands between vundle#begin/end.</span></span><br><span class=\"line\">  <span class=\"comment\"># plugin on GitHub repo</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'tpope/vim-fugitive'</span></span><br><span class=\"line\">  <span class=\"comment\"># plugin from http://vim-scripts.org/vim/scripts.html</span></span><br><span class=\"line\">  <span class=\"comment\"># Plugin 'L9'</span></span><br><span class=\"line\">  <span class=\"comment\"># Git plugin not hosted on GitHub</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'git://git.wincent.com/command-t.git'</span></span><br><span class=\"line\">  <span class=\"comment\"># git repos on your local machine (i.e. when working on your own plugin)</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'file:///home/gmarik/path/to/plugin'</span></span><br><span class=\"line\">  <span class=\"comment\"># The sparkup vim script is in a subdirectory of this repo called vim.</span></span><br><span class=\"line\">  <span class=\"comment\"># Pass the path to set the runtimepath properly.</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'rstacruz/sparkup'</span>, &#123;<span class=\"string\">'rtp'</span>: <span class=\"string\">'vim/'</span>&#125;</span><br><span class=\"line\">  <span class=\"comment\"># Install L9 and avoid a Naming conflict if you've already installed a</span></span><br><span class=\"line\">  <span class=\"comment\"># different version somewhere else.</span></span><br><span class=\"line\">  <span class=\"comment\"># Plugin 'ascenator/L9', &#123;'name': 'newL9'&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># All of your Plugins must be added before the following line</span></span><br><span class=\"line\">  call vundle<span class=\"comment\">#end()            \" required</span></span><br><span class=\"line\">  filetype plugin indent on    <span class=\"string\">\" required</span></span><br><span class=\"line\"><span class=\"string\">  # To ignore plugin indent changes, instead use:</span></span><br><span class=\"line\"><span class=\"string\">  #filetype plugin on</span></span><br><span class=\"line\"><span class=\"string\">  #</span></span><br><span class=\"line\"><span class=\"string\">  # Brief help</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginList       - lists configured plugins</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginInstall    - installs plugins; append `!` to update or just :PluginUpdate</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginSearch foo - searches for foo; append `!` to refresh local cache</span></span><br><span class=\"line\"><span class=\"string\">  # :PluginClean      - confirms removal of unused plugins; append `!` to auto-approve removal</span></span><br><span class=\"line\"><span class=\"string\">  #</span></span><br><span class=\"line\"><span class=\"string\">  # see :h vundle for more details or wiki for FAQ</span></span><br><span class=\"line\"><span class=\"string\">  # Put your non-Plugin stuff after this line   </span></span><br><span class=\"line\"><span class=\"string\"># è¿›å…¥ vim æ’ä»¶ç®¡ç†å™¨ç›®å½•ï¼Œå¹¶é€‰æ‹© \"</span>3. Configure Plugins<span class=\"string\">\" ä¸­çš„ç›¸åº”æ’ä»¶å†…å®¹ï¼Œå°†å…¶å¤åˆ¶è‡³ ~/.vimrc æ–‡ä»¶çš„é¡¶éƒ¨ã€‚</span></span><br><span class=\"line\"><span class=\"string\"># å¯æ ¹æ®éœ€è¦æ·»åŠ æˆ–åˆ é™¤æŒ‡å®šçš„æ’ä»¶ã€‚</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">$ git clone https://github.com/fatih/vim-go.git ~/.vim/bundle/vim-go</span></span><br><span class=\"line\"><span class=\"string\"># ä¸‹è½½å®‰è£… vim-go æ’ä»¶ä½¿ vim æ”¯æŒ Go è¯­è¨€å¼€å‘ï¼ŒåŒ…æ‹¬è¯­æ³•é«˜äº®ã€è¯­æ³•é”™è¯¯æ£€æŸ¥ç­‰ã€‚</span></span><br><span class=\"line\"><span class=\"string\"># æ³¨æ„è¯¥æ’ä»¶çš„ä¸‹è½½è·¯å¾„ï¼</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ‘‰ å¯ç”¨ <code>vim-go</code> æ’ä»¶ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim ~/.vimrc</span><br><span class=\"line\">  <span class=\"comment\"># Configure Go Programming Language vim Environment</span></span><br><span class=\"line\">  <span class=\"comment\"># set nocompatible              \" be iMproved, required</span></span><br><span class=\"line\">  filetype off                    <span class=\"comment\"># required</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">set</span> rtp+=~/.vim/bundle/Vundle.vim</span><br><span class=\"line\">  call vundle<span class=\"comment\">#begin()</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Install vim-go</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'fatih/vim-go'</span></span><br><span class=\"line\">  <span class=\"comment\"># Install Dracula color theme</span></span><br><span class=\"line\">  Plugin <span class=\"string\">'dracula/vim'</span>, &#123;<span class=\"string\">'name'</span>: <span class=\"string\">'dracula'</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  call vundle<span class=\"comment\">#end()            \" required</span></span><br><span class=\"line\">  filetype plugin indent on    <span class=\"string\">\" required</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # Extented Command</span></span><br><span class=\"line\"><span class=\"string\">  let g:go_version_warning = 0</span></span><br><span class=\"line\"><span class=\"string\">  # ç”±äº vim ç‰ˆæœ¬è¿‡ä½åœ¨å¯åŠ¨æ—¶å°†æŠ¥é”™ï¼Œè¯¥æŒ‡ä»¤å¯å»é™¤æŠ¥é”™ã€‚</span></span><br><span class=\"line\"><span class=\"string\">  set nu</span></span><br><span class=\"line\"><span class=\"string\">  set tabstop=2</span></span><br><span class=\"line\"><span class=\"string\">  # set cursorline</span></span><br><span class=\"line\"><span class=\"string\">  # set cursorcolumn</span></span><br><span class=\"line\"><span class=\"string\">  # colorscheme dracula</span></span><br><span class=\"line\"><span class=\"string\">  colorscheme elflord</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  # Auto YAML syntax</span></span><br><span class=\"line\"><span class=\"string\">  autocmd FileType yaml setlocal ai ts=2 sw=2 et</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">$ vim +PluginInstall +qall</span></span><br><span class=\"line\"><span class=\"string\"># å®‰è£…æ‰€æœ‰çš„ vim æ’ä»¶</span></span><br><span class=\"line\"><span class=\"string\">$ vim &lt;go_filename&gt;.go</span></span><br><span class=\"line\"><span class=\"string\"># ç¼–è¾‘ go æ–‡ä»¶éªŒè¯ vim-go æ’ä»¶å®‰è£…</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>è‹¥ä¸æ·»åŠ  <strong><code>let g:go_version_warning = 0</code></strong>ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼Œå¯ç›´æ¥å›è½¦ç»§ç»­ä½¿ç”¨ vimã€‚<br><img src=\"vim-error.jpg\" alt=\"vim-error\"></p>\n</li>\n</ul>\n"},{"title":"kubeadm æ›´æ–° Kubernetes é›†ç¾¤åˆ°æœŸè¯ä¹¦","subtitle":"kubeadm Update Kubernetes Expired Certifications","date":"2022-12-29T03:24:05.000Z","header-img":"kubeadm-certs-bg.jpg","_content":"\n### ç¯å¢ƒè¯´æ˜ï¼š\n- Kubernetes ç‰ˆæœ¬ï¼š`v1.22.1`\n- kubeadm ç‰ˆæœ¬ï¼š`v1.22.1`\n\n### å¤„ç†æ–¹æ³•ï¼š\n- kubeadm æ›´æ–°é›†ç¾¤è¯ä¹¦ä» Kubernetes `v1.15` è¿›å…¥ `stable` çŠ¶æ€ï¼Œå¯åœ¨ GA ç¯å¢ƒä¸­ä½¿ç”¨ã€‚\n- é»˜è®¤æƒ…å†µä¸‹ï¼Œç”± kubeadm ä¸ºé›†ç¾¤ç”Ÿæˆçš„æ‰€æœ‰è¯ä¹¦åœ¨ 1 å¹´ååˆ°æœŸã€‚\n- æ›´æ–°ï¼ˆé‡æ–°ç­¾å‘ï¼‰é›†ç¾¤è¯ä¹¦éœ€æ ¹æ®å…¶éƒ¨ç½²æ–¹å¼è€Œå®šï¼Œé€šè¿‡äºŒè¿›åˆ¶éƒ¨ç½²çš„é›†ç¾¤éœ€æ‰‹åŠ¨æ›´æ–°é›†ç¾¤è¯ä¹¦ï¼Œè€Œé€šè¿‡ kubeadm éƒ¨ç½²çš„é›†ç¾¤å¯ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ï¼Œä¹Ÿå¯é‡æ–°ç¼–è¯‘ kubeadm ç”¨ä»¥ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„è¯ä¹¦ã€‚\n- ğŸ‘‰ ç¬”è€…ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ã€‚\n- é›†ç¾¤è¯ä¹¦æ›´æ–°æ–¹å¼ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š  \n  - æ£€æŸ¥é›†ç¾¤è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆé€šå¸¸äº `master` èŠ‚ç‚¹æ‰§è¡Œï¼‰ï¼š    \n    ```bash\n    $ kubeadm certs check-expiration\n    $ openssl x509 -noout -in /etc/kubernetes/pki/apiserver.crt -dates\n    # ä¹Ÿå¯é€šè¿‡ä»¥ä¸Šå‘½ä»¤å•ç‹¬æŸ¥çœ‹è¯ä¹¦æ˜¯å¦è¿‡æœŸ\n    ```\n  - é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„ `/etc/kubernetes/pki/*` çš„è¯ä¹¦åœ¨æ›´æ–°ä¹‹å‰åº”ç»§ç»­ä¿ç•™åœ¨èŠ‚ç‚¹ä¸Šä¸å¯åˆ é™¤ï¼Œåˆ é™¤åå°†å¯¼è‡´é›†ç¾¤å¼‚å¸¸æ— æ³•æ¢å¤ã€‚  \n  - ğŸ· kubeadm æ›´æ–°é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„è¯ä¹¦ï¼Œè€Œ worker èŠ‚ç‚¹ä¸Š `kubelet` è¯ä¹¦é»˜è®¤è‡ªåŠ¨è½®æ¢æ›´æ–°ï¼Œæ— éœ€å…³å¿ƒè¯ä¹¦åˆ°æœŸé—®é¢˜ã€‚`kube-apiserver` è®¿é—® kubelet æ—¶ï¼Œå¹¶ä¸æ ¡éªŒ kubelet æœåŠ¡ç«¯è¯ä¹¦ï¼Œkubeadm ä¹Ÿå¹¶ä¸æä¾›æ›´æ–° kubelet æœåŠ¡ç«¯è¯ä¹¦çš„åŠæ³•ã€‚  \n  - æ›´æ–°å»¶æœŸé›†ç¾¤è¯ä¹¦ 1 å¹´æœ‰æ•ˆæœŸï¼š    \n    ```bash\n    $ kubeadm certs renew all --config ./kubeadm-conf.yml\n      W1213 21:45:40.125346   15197 strict.go:55] error unmarshaling configuration schema.GroupVersionKind{Group:\"kubelet.config.k8s.io\", Version:\"v1beta1\", Kind:\"KubeletConfiguration\"}: error converting YAML to JSON: yaml: unmarshal errors:\n        line 27: key \"cgroupDriver\" already set in map\n      certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed\n      certificate for serving the Kubernetes API renewed\n      certificate the apiserver uses to access etcd renewed\n      certificate for the API server to connect to kubelet renewed\n      certificate embedded in the kubeconfig file for the controller manager to use renewed\n      certificate for liveness probes to healthcheck etcd renewed\n      certificate for etcd nodes to communicate with each other renewed\n      certificate for serving etcd renewed\n      certificate for the front proxy client renewed\n      certificate embedded in the kubeconfig file for the scheduler manager to use renewed\n    \n      Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.\n    # æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶æ›´æ–°æ‰€æœ‰é›†ç¾¤è¯ä¹¦\n    \n    $ tree -D /etc/kubernetes/pki\n      /etc/kubernetes/pki\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver.crt\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.crt\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.key\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver.key\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.crt\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.key\n      â”œâ”€â”€ [Dec 25  2021]  ca.crt\n      â”œâ”€â”€ [Dec 25  2021]  ca.key\n      â”œâ”€â”€ [Dec 25  2021]  etcd\n      â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.crt\n      â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.key\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.crt\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.key\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.crt\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.key\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  server.crt\n      â”‚   â””â”€â”€ [Dec 13 21:45]  server.key\n      â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.crt\n      â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.key\n      â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.crt\n      â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.key\n      â”œâ”€â”€ [Dec 25  2021]  sa.key\n      â””â”€â”€ [Dec 25  2021]  sa.pub\n    \n      1 directory, 22 files\n    # æŸ¥çœ‹æ›´æ–°åçš„æ‰€æœ‰é›†ç¾¤è¯ä¹¦\n    ```\n    ğŸ”— ä¸Šè¿° kubeadm-conf.yml å¯å‚è€ƒæ­¤ [é“¾æ¥](https://github.com/Alberthua-Perl/kani/blob/main/files/kube-utils/kubeadm-conf.yml)ï¼Œå¯æ ¹æ®è‡ªèº«çš„å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹åè¿è¡Œã€‚  \n  - æ›´æ–°é›†ç¾¤è¯ä¹¦åï¼Œéœ€æ›´æ–°é›†ç¾¤ `kubeconfig` é…ç½®æ–‡ä»¶ï¼š    \n    ```bash\n    $ mkdir ~/kubeconfig-backup\n    $ mv /etc/kubernetes/*.conf ~/kubeconfig-backup/\n    # å¤‡ä»½é›†ç¾¤åŸå§‹ kubeconfig é…ç½®æ–‡ä»¶\n    \n    $ kubeadm init phase kubeconfig all --config ./kubeadm-conf.yml \n      W1213 21:53:42.328419   19385 strict.go:55] error unmarshaling configuration schema.GroupVersionKind{Group:\"kubelet.config.k8s.io\", Version:\"v1beta1\", Kind:\"KubeletConfiguration\"}: error converting YAML to JSON: yaml: unmarshal errors:\n        line 27: key \"cgroupDriver\" already set in map\n      [kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n      [kubeconfig] Writing \"admin.conf\" kubeconfig file\n      [kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n      [kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n      [kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n    # æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶é‡æ–°ç”Ÿæˆé›†ç¾¤ kubeconfig é…ç½®æ–‡ä»¶\n    \n    $ ls -lh /etc/kubernetes/\n      total 36K\n      -rw------- 1 root root 5.6K Dec 13 21:53 admin.conf\n      -rw------- 1 root root 5.6K Dec 13 21:53 controller-manager.conf\n      -rw------- 1 root root 5.7K Dec 13 21:53 kubelet.conf\n      drwxr-xr-x 2 root root  113 Nov 22 00:40 manifests\n      drwxr-xr-x 3 root root 4.0K Dec 25  2021 pki\n      -rw------- 1 root root 5.5K Dec 13 21:53 scheduler.conf\n    ```\n  - æ›´æ–°å®Œæˆåæ£€æŸ¥é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸï¼š    \n    ```bash\n    $ kubeadm certs check-expiration\n     [check-expiration] Reading configuration from the cluster...\n     [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'\n    \n     CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED\n     admin.conf                 Dec 13, 2023 13:53 UTC   364d                                    no      \n     apiserver                  Dec 13, 2023 13:45 UTC   364d            ca                      no      \n     apiserver-etcd-client      Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     apiserver-kubelet-client   Dec 13, 2023 13:45 UTC   364d            ca                      no      \n     controller-manager.conf    Dec 13, 2023 13:53 UTC   364d                                    no      \n     etcd-healthcheck-client    Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     etcd-peer                  Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     etcd-server                Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     front-proxy-client         Dec 13, 2023 13:45 UTC   364d            front-proxy-ca          no      \n     scheduler.conf             Dec 13, 2023 13:53 UTC   364d                                    no      \n    \n     CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\n     ca                      Dec 23, 2031 13:09 UTC   9y              no      \n     etcd-ca                 Dec 23, 2031 13:09 UTC   9y              no      \n     front-proxy-ca          Dec 23, 2031 13:09 UTC   9y              no\n    # é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸå»¶æœŸ 1 å¹´\n    ```\n- ğŸ’¥ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶æ–°ç”Ÿæˆçš„é›†ç¾¤ `/etc/kubernetes/admin.conf` é…ç½®æ–‡ä»¶åµŒå¥—æ–°çš„è¯ä¹¦ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨æˆ–å¯ä½¿ç”¨ kubectl å‘½ä»¤è¿æ¥è‡³é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéœ€ä½¿ç”¨è¯¥æ–‡ä»¶æ›´æ–°èŠ‚ç‚¹ `$HOME/.kube/config` æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•è¿æ¥è‡³é›†ç¾¤ä¸­ï¼Œç›´æ¥æŠ¥é”™ `error: You must be logged in to the server (Unauthorized)`ã€‚\n\n### å‚è€ƒæ–‡æ¡£ï¼š\n- [Kubernetes Doc - ä½¿ç”¨ kubeadm è¿›è¡Œè¯ä¹¦ç®¡ç†](https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/)\n- [Kubernetes Doc - PKI è¯ä¹¦å’Œè¦æ±‚](https://kubernetes.io/zh-cn/docs/setup/best-practices/certificates/)\n- [Kubeadm è¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´](https://www.cnblogs.com/skymyyang/p/11093686.html)\n","source":"_posts/kubeadm-update-k8s-certs.md","raw":"---\ntitle: kubeadm æ›´æ–° Kubernetes é›†ç¾¤åˆ°æœŸè¯ä¹¦\nsubtitle: kubeadm Update Kubernetes Expired Certifications\ndate: 2022-12-29 11:24:05\nheader-img: kubeadm-certs-bg.jpg\ntags:\n  - Kubernetes\n  - äº‘åŸç”Ÿ\n---\n\n### ç¯å¢ƒè¯´æ˜ï¼š\n- Kubernetes ç‰ˆæœ¬ï¼š`v1.22.1`\n- kubeadm ç‰ˆæœ¬ï¼š`v1.22.1`\n\n### å¤„ç†æ–¹æ³•ï¼š\n- kubeadm æ›´æ–°é›†ç¾¤è¯ä¹¦ä» Kubernetes `v1.15` è¿›å…¥ `stable` çŠ¶æ€ï¼Œå¯åœ¨ GA ç¯å¢ƒä¸­ä½¿ç”¨ã€‚\n- é»˜è®¤æƒ…å†µä¸‹ï¼Œç”± kubeadm ä¸ºé›†ç¾¤ç”Ÿæˆçš„æ‰€æœ‰è¯ä¹¦åœ¨ 1 å¹´ååˆ°æœŸã€‚\n- æ›´æ–°ï¼ˆé‡æ–°ç­¾å‘ï¼‰é›†ç¾¤è¯ä¹¦éœ€æ ¹æ®å…¶éƒ¨ç½²æ–¹å¼è€Œå®šï¼Œé€šè¿‡äºŒè¿›åˆ¶éƒ¨ç½²çš„é›†ç¾¤éœ€æ‰‹åŠ¨æ›´æ–°é›†ç¾¤è¯ä¹¦ï¼Œè€Œé€šè¿‡ kubeadm éƒ¨ç½²çš„é›†ç¾¤å¯ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ï¼Œä¹Ÿå¯é‡æ–°ç¼–è¯‘ kubeadm ç”¨ä»¥ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„è¯ä¹¦ã€‚\n- ğŸ‘‰ ç¬”è€…ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ã€‚\n- é›†ç¾¤è¯ä¹¦æ›´æ–°æ–¹å¼ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š  \n  - æ£€æŸ¥é›†ç¾¤è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆé€šå¸¸äº `master` èŠ‚ç‚¹æ‰§è¡Œï¼‰ï¼š    \n    ```bash\n    $ kubeadm certs check-expiration\n    $ openssl x509 -noout -in /etc/kubernetes/pki/apiserver.crt -dates\n    # ä¹Ÿå¯é€šè¿‡ä»¥ä¸Šå‘½ä»¤å•ç‹¬æŸ¥çœ‹è¯ä¹¦æ˜¯å¦è¿‡æœŸ\n    ```\n  - é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„ `/etc/kubernetes/pki/*` çš„è¯ä¹¦åœ¨æ›´æ–°ä¹‹å‰åº”ç»§ç»­ä¿ç•™åœ¨èŠ‚ç‚¹ä¸Šä¸å¯åˆ é™¤ï¼Œåˆ é™¤åå°†å¯¼è‡´é›†ç¾¤å¼‚å¸¸æ— æ³•æ¢å¤ã€‚  \n  - ğŸ· kubeadm æ›´æ–°é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„è¯ä¹¦ï¼Œè€Œ worker èŠ‚ç‚¹ä¸Š `kubelet` è¯ä¹¦é»˜è®¤è‡ªåŠ¨è½®æ¢æ›´æ–°ï¼Œæ— éœ€å…³å¿ƒè¯ä¹¦åˆ°æœŸé—®é¢˜ã€‚`kube-apiserver` è®¿é—® kubelet æ—¶ï¼Œå¹¶ä¸æ ¡éªŒ kubelet æœåŠ¡ç«¯è¯ä¹¦ï¼Œkubeadm ä¹Ÿå¹¶ä¸æä¾›æ›´æ–° kubelet æœåŠ¡ç«¯è¯ä¹¦çš„åŠæ³•ã€‚  \n  - æ›´æ–°å»¶æœŸé›†ç¾¤è¯ä¹¦ 1 å¹´æœ‰æ•ˆæœŸï¼š    \n    ```bash\n    $ kubeadm certs renew all --config ./kubeadm-conf.yml\n      W1213 21:45:40.125346   15197 strict.go:55] error unmarshaling configuration schema.GroupVersionKind{Group:\"kubelet.config.k8s.io\", Version:\"v1beta1\", Kind:\"KubeletConfiguration\"}: error converting YAML to JSON: yaml: unmarshal errors:\n        line 27: key \"cgroupDriver\" already set in map\n      certificate embedded in the kubeconfig file for the admin to use and for kubeadm itself renewed\n      certificate for serving the Kubernetes API renewed\n      certificate the apiserver uses to access etcd renewed\n      certificate for the API server to connect to kubelet renewed\n      certificate embedded in the kubeconfig file for the controller manager to use renewed\n      certificate for liveness probes to healthcheck etcd renewed\n      certificate for etcd nodes to communicate with each other renewed\n      certificate for serving etcd renewed\n      certificate for the front proxy client renewed\n      certificate embedded in the kubeconfig file for the scheduler manager to use renewed\n    \n      Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.\n    # æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶æ›´æ–°æ‰€æœ‰é›†ç¾¤è¯ä¹¦\n    \n    $ tree -D /etc/kubernetes/pki\n      /etc/kubernetes/pki\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver.crt\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.crt\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.key\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver.key\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.crt\n      â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.key\n      â”œâ”€â”€ [Dec 25  2021]  ca.crt\n      â”œâ”€â”€ [Dec 25  2021]  ca.key\n      â”œâ”€â”€ [Dec 25  2021]  etcd\n      â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.crt\n      â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.key\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.crt\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.key\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.crt\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.key\n      â”‚   â”œâ”€â”€ [Dec 13 21:45]  server.crt\n      â”‚   â””â”€â”€ [Dec 13 21:45]  server.key\n      â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.crt\n      â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.key\n      â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.crt\n      â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.key\n      â”œâ”€â”€ [Dec 25  2021]  sa.key\n      â””â”€â”€ [Dec 25  2021]  sa.pub\n    \n      1 directory, 22 files\n    # æŸ¥çœ‹æ›´æ–°åçš„æ‰€æœ‰é›†ç¾¤è¯ä¹¦\n    ```\n    ğŸ”— ä¸Šè¿° kubeadm-conf.yml å¯å‚è€ƒæ­¤ [é“¾æ¥](https://github.com/Alberthua-Perl/kani/blob/main/files/kube-utils/kubeadm-conf.yml)ï¼Œå¯æ ¹æ®è‡ªèº«çš„å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹åè¿è¡Œã€‚  \n  - æ›´æ–°é›†ç¾¤è¯ä¹¦åï¼Œéœ€æ›´æ–°é›†ç¾¤ `kubeconfig` é…ç½®æ–‡ä»¶ï¼š    \n    ```bash\n    $ mkdir ~/kubeconfig-backup\n    $ mv /etc/kubernetes/*.conf ~/kubeconfig-backup/\n    # å¤‡ä»½é›†ç¾¤åŸå§‹ kubeconfig é…ç½®æ–‡ä»¶\n    \n    $ kubeadm init phase kubeconfig all --config ./kubeadm-conf.yml \n      W1213 21:53:42.328419   19385 strict.go:55] error unmarshaling configuration schema.GroupVersionKind{Group:\"kubelet.config.k8s.io\", Version:\"v1beta1\", Kind:\"KubeletConfiguration\"}: error converting YAML to JSON: yaml: unmarshal errors:\n        line 27: key \"cgroupDriver\" already set in map\n      [kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n      [kubeconfig] Writing \"admin.conf\" kubeconfig file\n      [kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n      [kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n      [kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n    # æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶é‡æ–°ç”Ÿæˆé›†ç¾¤ kubeconfig é…ç½®æ–‡ä»¶\n    \n    $ ls -lh /etc/kubernetes/\n      total 36K\n      -rw------- 1 root root 5.6K Dec 13 21:53 admin.conf\n      -rw------- 1 root root 5.6K Dec 13 21:53 controller-manager.conf\n      -rw------- 1 root root 5.7K Dec 13 21:53 kubelet.conf\n      drwxr-xr-x 2 root root  113 Nov 22 00:40 manifests\n      drwxr-xr-x 3 root root 4.0K Dec 25  2021 pki\n      -rw------- 1 root root 5.5K Dec 13 21:53 scheduler.conf\n    ```\n  - æ›´æ–°å®Œæˆåæ£€æŸ¥é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸï¼š    \n    ```bash\n    $ kubeadm certs check-expiration\n     [check-expiration] Reading configuration from the cluster...\n     [check-expiration] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'\n    \n     CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED\n     admin.conf                 Dec 13, 2023 13:53 UTC   364d                                    no      \n     apiserver                  Dec 13, 2023 13:45 UTC   364d            ca                      no      \n     apiserver-etcd-client      Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     apiserver-kubelet-client   Dec 13, 2023 13:45 UTC   364d            ca                      no      \n     controller-manager.conf    Dec 13, 2023 13:53 UTC   364d                                    no      \n     etcd-healthcheck-client    Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     etcd-peer                  Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     etcd-server                Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      \n     front-proxy-client         Dec 13, 2023 13:45 UTC   364d            front-proxy-ca          no      \n     scheduler.conf             Dec 13, 2023 13:53 UTC   364d                                    no      \n    \n     CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED\n     ca                      Dec 23, 2031 13:09 UTC   9y              no      \n     etcd-ca                 Dec 23, 2031 13:09 UTC   9y              no      \n     front-proxy-ca          Dec 23, 2031 13:09 UTC   9y              no\n    # é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸå»¶æœŸ 1 å¹´\n    ```\n- ğŸ’¥ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶æ–°ç”Ÿæˆçš„é›†ç¾¤ `/etc/kubernetes/admin.conf` é…ç½®æ–‡ä»¶åµŒå¥—æ–°çš„è¯ä¹¦ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨æˆ–å¯ä½¿ç”¨ kubectl å‘½ä»¤è¿æ¥è‡³é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéœ€ä½¿ç”¨è¯¥æ–‡ä»¶æ›´æ–°èŠ‚ç‚¹ `$HOME/.kube/config` æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•è¿æ¥è‡³é›†ç¾¤ä¸­ï¼Œç›´æ¥æŠ¥é”™ `error: You must be logged in to the server (Unauthorized)`ã€‚\n\n### å‚è€ƒæ–‡æ¡£ï¼š\n- [Kubernetes Doc - ä½¿ç”¨ kubeadm è¿›è¡Œè¯ä¹¦ç®¡ç†](https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/)\n- [Kubernetes Doc - PKI è¯ä¹¦å’Œè¦æ±‚](https://kubernetes.io/zh-cn/docs/setup/best-practices/certificates/)\n- [Kubeadm è¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´](https://www.cnblogs.com/skymyyang/p/11093686.html)\n","slug":"kubeadm-update-k8s-certs","published":1,"updated":"2022-12-29T04:08:30.460Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonokl000716vde5os9l41","content":"<h3 id=\"ç¯å¢ƒè¯´æ˜ï¼š\"><a href=\"#ç¯å¢ƒè¯´æ˜ï¼š\" class=\"headerlink\" title=\"ç¯å¢ƒè¯´æ˜ï¼š\"></a>ç¯å¢ƒè¯´æ˜ï¼š</h3><ul>\n<li>Kubernetes ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n<li>kubeadm ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n</ul>\n<h3 id=\"å¤„ç†æ–¹æ³•ï¼š\"><a href=\"#å¤„ç†æ–¹æ³•ï¼š\" class=\"headerlink\" title=\"å¤„ç†æ–¹æ³•ï¼š\"></a>å¤„ç†æ–¹æ³•ï¼š</h3><ul>\n<li>kubeadm æ›´æ–°é›†ç¾¤è¯ä¹¦ä» Kubernetes <code>v1.15</code> è¿›å…¥ <code>stable</code> çŠ¶æ€ï¼Œå¯åœ¨ GA ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</li>\n<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œç”± kubeadm ä¸ºé›†ç¾¤ç”Ÿæˆçš„æ‰€æœ‰è¯ä¹¦åœ¨ 1 å¹´ååˆ°æœŸã€‚</li>\n<li>æ›´æ–°ï¼ˆé‡æ–°ç­¾å‘ï¼‰é›†ç¾¤è¯ä¹¦éœ€æ ¹æ®å…¶éƒ¨ç½²æ–¹å¼è€Œå®šï¼Œé€šè¿‡äºŒè¿›åˆ¶éƒ¨ç½²çš„é›†ç¾¤éœ€æ‰‹åŠ¨æ›´æ–°é›†ç¾¤è¯ä¹¦ï¼Œè€Œé€šè¿‡ kubeadm éƒ¨ç½²çš„é›†ç¾¤å¯ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ï¼Œä¹Ÿå¯é‡æ–°ç¼–è¯‘ kubeadm ç”¨ä»¥ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„è¯ä¹¦ã€‚</li>\n<li>ğŸ‘‰ ç¬”è€…ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ã€‚</li>\n<li><p>é›†ç¾¤è¯ä¹¦æ›´æ–°æ–¹å¼ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š  </p>\n<ul>\n<li><p>æ£€æŸ¥é›†ç¾¤è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆé€šå¸¸äº <code>master</code> èŠ‚ç‚¹æ‰§è¡Œï¼‰ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm certs check-expiration</span><br><span class=\"line\">$ openssl x509 -noout -<span class=\"keyword\">in</span> /etc/kubernetes/pki/apiserver.crt -dates</span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯é€šè¿‡ä»¥ä¸Šå‘½ä»¤å•ç‹¬æŸ¥çœ‹è¯ä¹¦æ˜¯å¦è¿‡æœŸ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„ <code>/etc/kubernetes/pki/*</code> çš„è¯ä¹¦åœ¨æ›´æ–°ä¹‹å‰åº”ç»§ç»­ä¿ç•™åœ¨èŠ‚ç‚¹ä¸Šä¸å¯åˆ é™¤ï¼Œåˆ é™¤åå°†å¯¼è‡´é›†ç¾¤å¼‚å¸¸æ— æ³•æ¢å¤ã€‚  </p>\n</li>\n<li>ğŸ· kubeadm æ›´æ–°é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„è¯ä¹¦ï¼Œè€Œ worker èŠ‚ç‚¹ä¸Š <code>kubelet</code> è¯ä¹¦é»˜è®¤è‡ªåŠ¨è½®æ¢æ›´æ–°ï¼Œæ— éœ€å…³å¿ƒè¯ä¹¦åˆ°æœŸé—®é¢˜ã€‚<code>kube-apiserver</code> è®¿é—® kubelet æ—¶ï¼Œå¹¶ä¸æ ¡éªŒ kubelet æœåŠ¡ç«¯è¯ä¹¦ï¼Œkubeadm ä¹Ÿå¹¶ä¸æä¾›æ›´æ–° kubelet æœåŠ¡ç«¯è¯ä¹¦çš„åŠæ³•ã€‚  </li>\n<li><p>æ›´æ–°å»¶æœŸé›†ç¾¤è¯ä¹¦ 1 å¹´æœ‰æ•ˆæœŸï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm certs renew all --config ./kubeadm-conf.yml</span><br><span class=\"line\">  W1213 21:45:40.125346   15197 strict.go:55] error unmarshaling configuration schema.GroupVersionKind&#123;Group:<span class=\"string\">\"kubelet.config.k8s.io\"</span>, Version:<span class=\"string\">\"v1beta1\"</span>, Kind:<span class=\"string\">\"KubeletConfiguration\"</span>&#125;: error converting YAML to JSON: yaml: unmarshal errors:</span><br><span class=\"line\">    line 27: key <span class=\"string\">\"cgroupDriver\"</span> already <span class=\"built_in\">set</span> <span class=\"keyword\">in</span> map</span><br><span class=\"line\">  certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the admin to use and <span class=\"keyword\">for</span> kubeadm itself renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> serving the Kubernetes API renewed</span><br><span class=\"line\">  certificate the apiserver uses to access etcd renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> the API server to connect to kubelet renewed</span><br><span class=\"line\">  certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the controller manager to use renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> liveness probes to healthcheck etcd renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> etcd nodes to communicate with each other renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> serving etcd renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> the front proxy client renewed</span><br><span class=\"line\">  certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the scheduler manager to use renewed</span><br><span class=\"line\"></span><br><span class=\"line\">  Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶æ›´æ–°æ‰€æœ‰é›†ç¾¤è¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ tree -D /etc/kubernetes/pki</span><br><span class=\"line\">  /etc/kubernetes/pki</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  ca.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  ca.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  etcd</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.crt</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.key</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.crt</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.key</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.crt</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.key</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  server.crt</span><br><span class=\"line\">  â”‚   â””â”€â”€ [Dec 13 21:45]  server.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  sa.key</span><br><span class=\"line\">  â””â”€â”€ [Dec 25  2021]  sa.pub</span><br><span class=\"line\"></span><br><span class=\"line\">  1 directory, 22 files</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ›´æ–°åçš„æ‰€æœ‰é›†ç¾¤è¯ä¹¦</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ”— ä¸Šè¿° kubeadm-conf.yml å¯å‚è€ƒæ­¤ <a href=\"https://github.com/Alberthua-Perl/kani/blob/main/files/kube-utils/kubeadm-conf.yml\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ï¼Œå¯æ ¹æ®è‡ªèº«çš„å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹åè¿è¡Œã€‚  </p>\n</li>\n<li><p>æ›´æ–°é›†ç¾¤è¯ä¹¦åï¼Œéœ€æ›´æ–°é›†ç¾¤ <code>kubeconfig</code> é…ç½®æ–‡ä»¶ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir ~/kubeconfig-backup</span><br><span class=\"line\">$ mv /etc/kubernetes/*.conf ~/kubeconfig-backup/</span><br><span class=\"line\"><span class=\"comment\"># å¤‡ä»½é›†ç¾¤åŸå§‹ kubeconfig é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubeadm init phase kubeconfig all --config ./kubeadm-conf.yml </span><br><span class=\"line\">  W1213 21:53:42.328419   19385 strict.go:55] error unmarshaling configuration schema.GroupVersionKind&#123;Group:<span class=\"string\">\"kubelet.config.k8s.io\"</span>, Version:<span class=\"string\">\"v1beta1\"</span>, Kind:<span class=\"string\">\"KubeletConfiguration\"</span>&#125;: error converting YAML to JSON: yaml: unmarshal errors:</span><br><span class=\"line\">    line 27: key <span class=\"string\">\"cgroupDriver\"</span> already <span class=\"built_in\">set</span> <span class=\"keyword\">in</span> map</span><br><span class=\"line\">  [kubeconfig] Using kubeconfig folder <span class=\"string\">\"/etc/kubernetes\"</span></span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"admin.conf\"</span> kubeconfig file</span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"kubelet.conf\"</span> kubeconfig file</span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"controller-manager.conf\"</span> kubeconfig file</span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"scheduler.conf\"</span> kubeconfig file</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶é‡æ–°ç”Ÿæˆé›†ç¾¤ kubeconfig é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ ls -lh /etc/kubernetes/</span><br><span class=\"line\">  total 36K</span><br><span class=\"line\">  -rw------- 1 root root 5.6K Dec 13 21:53 admin.conf</span><br><span class=\"line\">  -rw------- 1 root root 5.6K Dec 13 21:53 controller-manager.conf</span><br><span class=\"line\">  -rw------- 1 root root 5.7K Dec 13 21:53 kubelet.conf</span><br><span class=\"line\">  drwxr-xr-x 2 root root  113 Nov 22 00:40 manifests</span><br><span class=\"line\">  drwxr-xr-x 3 root root 4.0K Dec 25  2021 pki</span><br><span class=\"line\">  -rw------- 1 root root 5.5K Dec 13 21:53 scheduler.conf</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æ›´æ–°å®Œæˆåæ£€æŸ¥é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm certs check-expiration</span><br><span class=\"line\"> [check-expiration] Reading configuration from the cluster...</span><br><span class=\"line\"> [check-expiration] FYI: You can look at this config file with <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span></span><br><span class=\"line\"></span><br><span class=\"line\"> CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class=\"line\"> admin.conf                 Dec 13, 2023 13:53 UTC   364d                                    no      </span><br><span class=\"line\"> apiserver                  Dec 13, 2023 13:45 UTC   364d            ca                      no      </span><br><span class=\"line\"> apiserver-etcd-client      Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> apiserver-kubelet-client   Dec 13, 2023 13:45 UTC   364d            ca                      no      </span><br><span class=\"line\"> controller-manager.conf    Dec 13, 2023 13:53 UTC   364d                                    no      </span><br><span class=\"line\"> etcd-healthcheck-client    Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> etcd-peer                  Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> etcd-server                Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> front-proxy-client         Dec 13, 2023 13:45 UTC   364d            front-proxy-ca          no      </span><br><span class=\"line\"> scheduler.conf             Dec 13, 2023 13:53 UTC   364d                                    no      </span><br><span class=\"line\"></span><br><span class=\"line\"> CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class=\"line\"> ca                      Dec 23, 2031 13:09 UTC   9y              no      </span><br><span class=\"line\"> etcd-ca                 Dec 23, 2031 13:09 UTC   9y              no      </span><br><span class=\"line\"> front-proxy-ca          Dec 23, 2031 13:09 UTC   9y              no</span><br><span class=\"line\"><span class=\"comment\"># é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸå»¶æœŸ 1 å¹´</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>ğŸ’¥ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶æ–°ç”Ÿæˆçš„é›†ç¾¤ <code>/etc/kubernetes/admin.conf</code> é…ç½®æ–‡ä»¶åµŒå¥—æ–°çš„è¯ä¹¦ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨æˆ–å¯ä½¿ç”¨ kubectl å‘½ä»¤è¿æ¥è‡³é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéœ€ä½¿ç”¨è¯¥æ–‡ä»¶æ›´æ–°èŠ‚ç‚¹ <code>$HOME/.kube/config</code> æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•è¿æ¥è‡³é›†ç¾¤ä¸­ï¼Œç›´æ¥æŠ¥é”™ <code>error: You must be logged in to the server (Unauthorized)</code>ã€‚</p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒæ–‡æ¡£ï¼š\"><a href=\"#å‚è€ƒæ–‡æ¡£ï¼š\" class=\"headerlink\" title=\"å‚è€ƒæ–‡æ¡£ï¼š\"></a>å‚è€ƒæ–‡æ¡£ï¼š</h3><ul>\n<li><a href=\"https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/\" target=\"_blank\" rel=\"noopener\">Kubernetes Doc - ä½¿ç”¨ kubeadm è¿›è¡Œè¯ä¹¦ç®¡ç†</a></li>\n<li><a href=\"https://kubernetes.io/zh-cn/docs/setup/best-practices/certificates/\" target=\"_blank\" rel=\"noopener\">Kubernetes Doc - PKI è¯ä¹¦å’Œè¦æ±‚</a></li>\n<li><a href=\"https://www.cnblogs.com/skymyyang/p/11093686.html\" target=\"_blank\" rel=\"noopener\">Kubeadm è¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"ç¯å¢ƒè¯´æ˜ï¼š\"><a href=\"#ç¯å¢ƒè¯´æ˜ï¼š\" class=\"headerlink\" title=\"ç¯å¢ƒè¯´æ˜ï¼š\"></a>ç¯å¢ƒè¯´æ˜ï¼š</h3><ul>\n<li>Kubernetes ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n<li>kubeadm ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n</ul>\n<h3 id=\"å¤„ç†æ–¹æ³•ï¼š\"><a href=\"#å¤„ç†æ–¹æ³•ï¼š\" class=\"headerlink\" title=\"å¤„ç†æ–¹æ³•ï¼š\"></a>å¤„ç†æ–¹æ³•ï¼š</h3><ul>\n<li>kubeadm æ›´æ–°é›†ç¾¤è¯ä¹¦ä» Kubernetes <code>v1.15</code> è¿›å…¥ <code>stable</code> çŠ¶æ€ï¼Œå¯åœ¨ GA ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</li>\n<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œç”± kubeadm ä¸ºé›†ç¾¤ç”Ÿæˆçš„æ‰€æœ‰è¯ä¹¦åœ¨ 1 å¹´ååˆ°æœŸã€‚</li>\n<li>æ›´æ–°ï¼ˆé‡æ–°ç­¾å‘ï¼‰é›†ç¾¤è¯ä¹¦éœ€æ ¹æ®å…¶éƒ¨ç½²æ–¹å¼è€Œå®šï¼Œé€šè¿‡äºŒè¿›åˆ¶éƒ¨ç½²çš„é›†ç¾¤éœ€æ‰‹åŠ¨æ›´æ–°é›†ç¾¤è¯ä¹¦ï¼Œè€Œé€šè¿‡ kubeadm éƒ¨ç½²çš„é›†ç¾¤å¯ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ï¼Œä¹Ÿå¯é‡æ–°ç¼–è¯‘ kubeadm ç”¨ä»¥ç”Ÿæˆè‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„è¯ä¹¦ã€‚</li>\n<li>ğŸ‘‰ ç¬”è€…ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ kubeadm æ›´æ–°è¯ä¹¦ã€‚</li>\n<li><p>é›†ç¾¤è¯ä¹¦æ›´æ–°æ–¹å¼ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š  </p>\n<ul>\n<li><p>æ£€æŸ¥é›†ç¾¤è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆé€šå¸¸äº <code>master</code> èŠ‚ç‚¹æ‰§è¡Œï¼‰ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm certs check-expiration</span><br><span class=\"line\">$ openssl x509 -noout -<span class=\"keyword\">in</span> /etc/kubernetes/pki/apiserver.crt -dates</span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯é€šè¿‡ä»¥ä¸Šå‘½ä»¤å•ç‹¬æŸ¥çœ‹è¯ä¹¦æ˜¯å¦è¿‡æœŸ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„ <code>/etc/kubernetes/pki/*</code> çš„è¯ä¹¦åœ¨æ›´æ–°ä¹‹å‰åº”ç»§ç»­ä¿ç•™åœ¨èŠ‚ç‚¹ä¸Šä¸å¯åˆ é™¤ï¼Œåˆ é™¤åå°†å¯¼è‡´é›†ç¾¤å¼‚å¸¸æ— æ³•æ¢å¤ã€‚  </p>\n</li>\n<li>ğŸ· kubeadm æ›´æ–°é›†ç¾¤ master èŠ‚ç‚¹ä¸Šçš„è¯ä¹¦ï¼Œè€Œ worker èŠ‚ç‚¹ä¸Š <code>kubelet</code> è¯ä¹¦é»˜è®¤è‡ªåŠ¨è½®æ¢æ›´æ–°ï¼Œæ— éœ€å…³å¿ƒè¯ä¹¦åˆ°æœŸé—®é¢˜ã€‚<code>kube-apiserver</code> è®¿é—® kubelet æ—¶ï¼Œå¹¶ä¸æ ¡éªŒ kubelet æœåŠ¡ç«¯è¯ä¹¦ï¼Œkubeadm ä¹Ÿå¹¶ä¸æä¾›æ›´æ–° kubelet æœåŠ¡ç«¯è¯ä¹¦çš„åŠæ³•ã€‚  </li>\n<li><p>æ›´æ–°å»¶æœŸé›†ç¾¤è¯ä¹¦ 1 å¹´æœ‰æ•ˆæœŸï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm certs renew all --config ./kubeadm-conf.yml</span><br><span class=\"line\">  W1213 21:45:40.125346   15197 strict.go:55] error unmarshaling configuration schema.GroupVersionKind&#123;Group:<span class=\"string\">\"kubelet.config.k8s.io\"</span>, Version:<span class=\"string\">\"v1beta1\"</span>, Kind:<span class=\"string\">\"KubeletConfiguration\"</span>&#125;: error converting YAML to JSON: yaml: unmarshal errors:</span><br><span class=\"line\">    line 27: key <span class=\"string\">\"cgroupDriver\"</span> already <span class=\"built_in\">set</span> <span class=\"keyword\">in</span> map</span><br><span class=\"line\">  certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the admin to use and <span class=\"keyword\">for</span> kubeadm itself renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> serving the Kubernetes API renewed</span><br><span class=\"line\">  certificate the apiserver uses to access etcd renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> the API server to connect to kubelet renewed</span><br><span class=\"line\">  certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the controller manager to use renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> liveness probes to healthcheck etcd renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> etcd nodes to communicate with each other renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> serving etcd renewed</span><br><span class=\"line\">  certificate <span class=\"keyword\">for</span> the front proxy client renewed</span><br><span class=\"line\">  certificate embedded <span class=\"keyword\">in</span> the kubeconfig file <span class=\"keyword\">for</span> the scheduler manager to use renewed</span><br><span class=\"line\"></span><br><span class=\"line\">  Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶æ›´æ–°æ‰€æœ‰é›†ç¾¤è¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ tree -D /etc/kubernetes/pki</span><br><span class=\"line\">  /etc/kubernetes/pki</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-etcd-client.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  apiserver-kubelet-client.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  ca.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  ca.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  etcd</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.crt</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 25  2021]  ca.key</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.crt</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  healthcheck-client.key</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.crt</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  peer.key</span><br><span class=\"line\">  â”‚   â”œâ”€â”€ [Dec 13 21:45]  server.crt</span><br><span class=\"line\">  â”‚   â””â”€â”€ [Dec 13 21:45]  server.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  front-proxy-ca.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.crt</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 13 21:45]  front-proxy-client.key</span><br><span class=\"line\">  â”œâ”€â”€ [Dec 25  2021]  sa.key</span><br><span class=\"line\">  â””â”€â”€ [Dec 25  2021]  sa.pub</span><br><span class=\"line\"></span><br><span class=\"line\">  1 directory, 22 files</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ›´æ–°åçš„æ‰€æœ‰é›†ç¾¤è¯ä¹¦</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ”— ä¸Šè¿° kubeadm-conf.yml å¯å‚è€ƒæ­¤ <a href=\"https://github.com/Alberthua-Perl/kani/blob/main/files/kube-utils/kubeadm-conf.yml\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ï¼Œå¯æ ¹æ®è‡ªèº«çš„å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹åè¿è¡Œã€‚  </p>\n</li>\n<li><p>æ›´æ–°é›†ç¾¤è¯ä¹¦åï¼Œéœ€æ›´æ–°é›†ç¾¤ <code>kubeconfig</code> é…ç½®æ–‡ä»¶ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir ~/kubeconfig-backup</span><br><span class=\"line\">$ mv /etc/kubernetes/*.conf ~/kubeconfig-backup/</span><br><span class=\"line\"><span class=\"comment\"># å¤‡ä»½é›†ç¾¤åŸå§‹ kubeconfig é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubeadm init phase kubeconfig all --config ./kubeadm-conf.yml </span><br><span class=\"line\">  W1213 21:53:42.328419   19385 strict.go:55] error unmarshaling configuration schema.GroupVersionKind&#123;Group:<span class=\"string\">\"kubelet.config.k8s.io\"</span>, Version:<span class=\"string\">\"v1beta1\"</span>, Kind:<span class=\"string\">\"KubeletConfiguration\"</span>&#125;: error converting YAML to JSON: yaml: unmarshal errors:</span><br><span class=\"line\">    line 27: key <span class=\"string\">\"cgroupDriver\"</span> already <span class=\"built_in\">set</span> <span class=\"keyword\">in</span> map</span><br><span class=\"line\">  [kubeconfig] Using kubeconfig folder <span class=\"string\">\"/etc/kubernetes\"</span></span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"admin.conf\"</span> kubeconfig file</span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"kubelet.conf\"</span> kubeconfig file</span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"controller-manager.conf\"</span> kubeconfig file</span><br><span class=\"line\">  [kubeconfig] Writing <span class=\"string\">\"scheduler.conf\"</span> kubeconfig file</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ®é›†ç¾¤éƒ¨ç½²æ—¶ä½¿ç”¨çš„ kubeadm-conf.yml é…ç½®æ–‡ä»¶é‡æ–°ç”Ÿæˆé›†ç¾¤ kubeconfig é…ç½®æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ ls -lh /etc/kubernetes/</span><br><span class=\"line\">  total 36K</span><br><span class=\"line\">  -rw------- 1 root root 5.6K Dec 13 21:53 admin.conf</span><br><span class=\"line\">  -rw------- 1 root root 5.6K Dec 13 21:53 controller-manager.conf</span><br><span class=\"line\">  -rw------- 1 root root 5.7K Dec 13 21:53 kubelet.conf</span><br><span class=\"line\">  drwxr-xr-x 2 root root  113 Nov 22 00:40 manifests</span><br><span class=\"line\">  drwxr-xr-x 3 root root 4.0K Dec 25  2021 pki</span><br><span class=\"line\">  -rw------- 1 root root 5.5K Dec 13 21:53 scheduler.conf</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æ›´æ–°å®Œæˆåæ£€æŸ¥é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubeadm certs check-expiration</span><br><span class=\"line\"> [check-expiration] Reading configuration from the cluster...</span><br><span class=\"line\"> [check-expiration] FYI: You can look at this config file with <span class=\"string\">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span></span><br><span class=\"line\"></span><br><span class=\"line\"> CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class=\"line\"> admin.conf                 Dec 13, 2023 13:53 UTC   364d                                    no      </span><br><span class=\"line\"> apiserver                  Dec 13, 2023 13:45 UTC   364d            ca                      no      </span><br><span class=\"line\"> apiserver-etcd-client      Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> apiserver-kubelet-client   Dec 13, 2023 13:45 UTC   364d            ca                      no      </span><br><span class=\"line\"> controller-manager.conf    Dec 13, 2023 13:53 UTC   364d                                    no      </span><br><span class=\"line\"> etcd-healthcheck-client    Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> etcd-peer                  Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> etcd-server                Dec 13, 2023 13:45 UTC   364d            etcd-ca                 no      </span><br><span class=\"line\"> front-proxy-client         Dec 13, 2023 13:45 UTC   364d            front-proxy-ca          no      </span><br><span class=\"line\"> scheduler.conf             Dec 13, 2023 13:53 UTC   364d                                    no      </span><br><span class=\"line\"></span><br><span class=\"line\"> CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class=\"line\"> ca                      Dec 23, 2031 13:09 UTC   9y              no      </span><br><span class=\"line\"> etcd-ca                 Dec 23, 2031 13:09 UTC   9y              no      </span><br><span class=\"line\"> front-proxy-ca          Dec 23, 2031 13:09 UTC   9y              no</span><br><span class=\"line\"><span class=\"comment\"># é›†ç¾¤æ‰€æœ‰è¯ä¹¦æœ‰æ•ˆæœŸå»¶æœŸ 1 å¹´</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>ğŸ’¥ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æ—¶æ–°ç”Ÿæˆçš„é›†ç¾¤ <code>/etc/kubernetes/admin.conf</code> é…ç½®æ–‡ä»¶åµŒå¥—æ–°çš„è¯ä¹¦ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨æˆ–å¯ä½¿ç”¨ kubectl å‘½ä»¤è¿æ¥è‡³é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šéœ€ä½¿ç”¨è¯¥æ–‡ä»¶æ›´æ–°èŠ‚ç‚¹ <code>$HOME/.kube/config</code> æ–‡ä»¶ï¼Œå¦åˆ™æ— æ³•è¿æ¥è‡³é›†ç¾¤ä¸­ï¼Œç›´æ¥æŠ¥é”™ <code>error: You must be logged in to the server (Unauthorized)</code>ã€‚</p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒæ–‡æ¡£ï¼š\"><a href=\"#å‚è€ƒæ–‡æ¡£ï¼š\" class=\"headerlink\" title=\"å‚è€ƒæ–‡æ¡£ï¼š\"></a>å‚è€ƒæ–‡æ¡£ï¼š</h3><ul>\n<li><a href=\"https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/\" target=\"_blank\" rel=\"noopener\">Kubernetes Doc - ä½¿ç”¨ kubeadm è¿›è¡Œè¯ä¹¦ç®¡ç†</a></li>\n<li><a href=\"https://kubernetes.io/zh-cn/docs/setup/best-practices/certificates/\" target=\"_blank\" rel=\"noopener\">Kubernetes Doc - PKI è¯ä¹¦å’Œè¦æ±‚</a></li>\n<li><a href=\"https://www.cnblogs.com/skymyyang/p/11093686.html\" target=\"_blank\" rel=\"noopener\">Kubeadm è¯ä¹¦è¿‡æœŸæ—¶é—´è°ƒæ•´</a></li>\n</ul>\n"},{"title":"â˜¸ï¸ Kubernetes é›†ç¾¤ä¸èµ„æºç®¡ç†åŸºç¡€","subtitle":"Kubernetes Cluster and Resource Basic","header-img":"k8s-resource-basic.svg","date":"2022-11-28T07:40:47.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- è¯¥æ–‡æ¡£ä½¿ç”¨çš„ Kubernetes ç‰ˆæœ¬ä¸º `1.12.x`\n- æ–‡æ¡£æ‰€ç¤ºçš„å‘½ä»¤å¯èƒ½ä¸å½“å‰ Kubernetes ç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œè¯·ä»¥å®é™…ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºåŸºå‡†ï¼\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆ\n- Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†\n- èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤\n\n### Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\n- `API Server` ä½œä¸º Kubernetes é›†ç¾¤çš„ç½‘å…³ï¼ˆgatewayï¼‰\n- `etcd` é”®å€¼å‹æ•°æ®åº“ä½œä¸º Kubernetes é›†ç¾¤çš„æ ¸å¿ƒæ•°æ®åº“\n- Kubernetes é›†ç¾¤å¯éƒ¨ç½²ä¸ºå• master é›†ç¾¤æˆ–å¤š masterï¼ˆå¸¸è§ä¸º 3 ä¸ªï¼‰çš„ HA é›†ç¾¤  \n  - å• master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š    \n    ![kubernetes-single-master-arch.jpg](kubernetes-single-master-arch.jpg)  \n  - å¤š master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š    \n    ![kubernetes-ha-arch-demo.jpg](kubernetes-ha-arch-demo.jpg)  \n  > ğŸ‘‰ è¯¥ç¤ºä¾‹ä¸­å°† etcd é›†ç¾¤åˆ†åˆ«éƒ¨ç½²äº 3 ä¸ª master èŠ‚ç‚¹ä¸Šã€‚\n- Kubernetes ä¸­çš„æ¥å£è§„èŒƒï¼š  \n  - `CRI`ï¼šContainer Runtime Interfaceï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰  \n  - `gRPC`ï¼šGoogle Remote Process Callï¼ˆGoogle å‘å¸ƒçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ¡†æ¶ï¼‰  \n  - `OCI`ï¼šOpen Container Initiativeï¼ˆå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰  \n  - `CNI`ï¼šContainer Network Interfaceï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰  \n  - `CSI`ï¼šContainer Storage Interfaceï¼ˆå®¹å™¨å­˜å‚¨æ¥å£ï¼‰  \n  - ä»¥ä¸Šå„æ¥å£è§„èŒƒåœ¨é›†ç¾¤ä¸­ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨ç¤ºæ„ï¼š    \n    ![kubernetes-interface-1.jpg](kubernetes-interface-1.jpg)![kubernetes-interface-2.jpg](kubernetes-interface-2.jpg)\n- Kubernetes é›†ç¾¤ä¸­çš„ç½‘ç»œæ¦‚è¿°ï¼š  \n  - é›†ç¾¤ä¸­çš„é€šä¿¡ç§ç±»ï¼š    \n    - åŒä¸€ Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é—´çš„é€šä¿¡    \n    - å„ Pod èµ„æºå¯¹è±¡å½¼æ­¤é—´çš„é€šä¿¡    \n    > ğŸ‘‰ Pod é—´åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šé€šä¿¡æˆ–å½¼æ­¤è·¨èŠ‚ç‚¹é—´é€šä¿¡    \n    - Pod èµ„æºå¯¹è±¡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡    \n    - é›†ç¾¤å¤–éƒ¨çš„æµé‡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡  \n  - é›†ç¾¤ç½‘ç»œè§„åˆ’éƒ¨ç½²ï¼š    \n    - Kubernetes é›†ç¾¤ä¸»æœºé—´çš„ç½‘ç»œ    \n    - Service èµ„æºå¯¹è±¡å®šä¹‰çš„ `ClusterIP` ç½‘ç»œ    \n    - ç”±ä¸åŒ `CNI` å®šä¹‰çš„ Pod é—´çš„é€šä¿¡ç½‘ç»œ\n- Kubernetes é›†ç¾¤çš„å®¢æˆ·ç«¯ç±»å‹ï¼š  \n  - Kubernetes çš„ API Server çš„å®¢æˆ·ç«¯ï¼š    \n    é›†ç¾¤åŠé¡¹ç›®ç®¡ç†äººå‘˜ã€å¼€å‘äººå‘˜ã€é›†ç¾¤ä¸­ä¸ API Server äº¤äº’çš„ç»„ä»¶  \n  - Kubernetes çš„è®¿é—® Pod çš„å®¢æˆ·ç«¯ï¼š    \n    é›†ç¾¤å¤–çš„æ™®é€šç”¨æˆ·ã€å‘½åç©ºé—´å†…çš„ Pod åº”ç”¨ï¼ˆPod Clientï¼‰\n\n### Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\n- kubectl å‘½ä»¤ç®¡ç†èµ„æºå¯¹è±¡çš„ 3 ç§æ–¹å¼ï¼š  \n  - é™ˆè¿°å¼å‘½ä»¤ï¼šä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ç®¡ç†  \n  - é™ˆè¿°å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ `kubectl create` å‘½ä»¤åˆ›å»º  \n  - å£°æ˜å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ `kubectl apply` å‘½ä»¤åˆ›å»º\n- Kubernetes ä½¿ç”¨ `Deployment` èµ„æºå¯¹è±¡ï¼ˆPod æ§åˆ¶å™¨ï¼‰éƒ¨ç½²ä¸ç®¡ç†å‰ç«¯æ— çŠ¶æ€ï¼ˆ`Stateless`ï¼‰çš„ Pod èµ„æºå¯¹è±¡ï¼Œè€Œ Deployment èµ„æºå¯¹è±¡å¹¶ä¸ç›´æ¥ä½œç”¨äº Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨ `ReplicaSet` èµ„æºå¯¹è±¡è¿›è¡Œéƒ¨ç½²ä¸ç®¡ç†ã€‚\n- Deployment èµ„æºå¯¹è±¡æ˜¯ ReplicaSet èµ„æºå¯¹è±¡ä¹‹ä¸Šçš„ Pod æ§åˆ¶å™¨ï¼Œä¸¤è€…éƒ½ä¸ºå·¥ä½œè´Ÿè½½å‹ï¼ˆworkloadï¼‰èµ„æºå¯¹è±¡ã€‚\n- ä½¿ç”¨ Deployment èµ„æºå¯¹è±¡éƒ¨ç½²çš„ Pod èµ„æºå¯¹è±¡éƒ½å…·æœ‰ `run=<pod_controller_name>` çš„æ ‡ç­¾ï¼ˆlabelï¼‰ã€‚\n- Pod èµ„æºå¯¹è±¡çš„åç§°ï¼š`<replicaset_name>-<random_char>`  \n  ![pod-name.jpg](pod-name.jpg)\n- Podèµ„æºå¯¹è±¡çš„çŠ¶æ€ï¼š  \n  Pendingã€Runningã€Succeededã€Failedã€Unknown\n- Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯ç®¡ç†ï¼š  \n  - ğŸ³ Kubernetes é›†ç¾¤ä¸­ Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯é»˜è®¤ä»¥æ ‡å‡†é”™è¯¯ï¼ˆ`standard error`ï¼‰è¾“å‡ºè‡³æ§åˆ¶å°ï¼Œå¯ä½¿ç”¨ kubectl logs å‘½ä»¤æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä¿¡æ¯ã€‚  \n  - å¿…é¡»ä½¿ç”¨é›†ä¸­å¼çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿç®¡ç† Pod å®¹å™¨æ—¥å¿—ã€‚  \n  - ä½¿ç”¨ kubectl logs å‘½ä»¤åªèƒ½æŸ¥çœ‹å­˜åœ¨çš„ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ï¼Œä¸èƒ½æŸ¥çœ‹å·²åˆ é™¤çš„Pod èµ„æºå¯¹è±¡æ—¥å¿—ã€‚\n- Kubernetes çš„ `API` èµ„æºæ¦‚è¿°ï¼š  \n  - API Server æä¾›åŸºäº `RESTful` é£æ ¼æ¶æ„çš„ç¼–ç¨‹æ¥å£ï¼Œæ¥æ”¶åŸºäº `HTTP/HTTPS` çš„å®¢æˆ·ç«¯ç»„ä»¶è¯·æ±‚ï¼Œå¹¶å°†å…¶å¤„ç†è¿”å›ã€‚  \n  - Kubernetes çš„å…¶ä»–ç»„ä»¶è¢«æŠ½è±¡ä¸ºæ ‡å‡†çš„ REST èµ„æºï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ `JSON` åºåˆ—åŒ–æ•°æ®å¯¹ å…¶ç®¡ç†ä¸æ§åˆ¶ã€‚  \n  - API èµ„æºç±»å‹åŒ…æ‹¬ï¼š    \n    - å¯¹è±¡ç±»ï¼ˆObjectï¼‰    \n    - åˆ—è¡¨ç±»ï¼ˆListï¼‰    \n    - ç®€å•ç±»ï¼ˆSimpleï¼‰  \n  - Kubernetes ä¸­çš„ API èµ„æºç±»å‹ç»å¤§å¤šæ•°ä»¥å¯¹è±¡çš„æ–¹å¼å­˜åœ¨ï¼Œå¯¹è±¡æ˜¯èµ„æºè¿è¡Œæ—¶ç”Ÿæˆçš„å®ä¾‹ï¼Œä¸”ä¸ºæŒä¹…åŒ–çš„å®ä½“ã€‚  \n  - API å¯¹åº”äºèµ„æºç±»å‹çš„ `URI`ï¼Œå³èµ„æºç±»å‹çš„ `YAML` é…ç½®æ–‡ä»¶ä¸­çš„ `selfLink` å­—æ®µï¼Œå…¶çŠ¶æ€å­˜å‚¨äºåç«¯ etcd æ•°æ®åº“ä¸­ã€‚  \n  > ğŸ’¥ Kubernetes v1.20 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤åˆ é™¤äº† `metadata.selfLink` å­—æ®µï¼Œç„¶è€Œï¼Œéƒ¨åˆ†åº”ç”¨ä»ç„¶ä¾èµ–äºè¯¥å­—æ®µï¼Œå¦‚ `nfs-client-provisioner`ã€‚å¦‚æœä»ç„¶è¦ç»§ç»­ä½¿ç”¨è¿™äº›åº”ç”¨ï¼Œéœ€è¦é‡æ–°å¯ç”¨è¯¥å­—æ®µã€‚  \n  - ğŸš€ è‹¥é›†ç¾¤ä½¿ç”¨ `kubeadm` ç»„ä»¶éƒ¨ç½²ï¼Œå¯ä¿®æ”¹æ§åˆ¶å¹³é¢ï¼ˆcontrol planï¼‰å„èŠ‚ç‚¹çš„ `/etc/kubernetes/manifests/kube-apiserver.yaml` æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æ·»åŠ  `--feature-gates=RemoveSelfLink=false` é€‰é¡¹ä»¥å¯ç”¨è¯¥å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ![kubernetes-apiserver-manifest.jpg](kubernetes-apiserver-manifest.jpg)    \n    - å…³äº selfLink çš„è¯´æ˜å¯å‚è€ƒ [è¯¥é“¾æ¥](https://kuboard.cn/install/faq/selfLink.html)    \n    - å…³äº kube-apiserver å‘½ä»¤çš„é€‰é¡¹å¯å‚è€ƒ [kube-apiserver å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/)  \n  - Kubernetes å°† API è¿›è¡Œé€»è¾‘åˆ†ç»„ï¼Œç§°ä¸º API ç¾¤ç»„ï¼ˆAPI groupï¼‰ã€‚  \n  - ğŸš€ Kubernetes çš„ API Server æ”¯æŒç›¸åŒçš„ API ç¾¤ç»„ä¸­ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼Œå› æ­¤èƒ½åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ï¼Œä»è€Œåœ¨ç¨³å®šç‰ˆæœ¬ä¸æ–°çš„å®éªŒç‰ˆæœ¬ä¸­èƒ½ä»¥ä¸åŒçš„ç‰¹æ€§ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ã€‚  \n  > å…³äº API ç¾¤ç»„çš„åˆ†ç±»ä¸è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ [è¯¥é“¾æ¥](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/)  \n  - Kubernetes çš„ API å±‚çº§ç»“æ„ï¼š    \n    - æ ¸å¿ƒ API ç¾¤ç»„ï¼ˆcore groupï¼‰ï¼š      \n      - REST è·¯å¾„ï¼š`/api/v1`      \n      - èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š`apiVersion: v1`    \n    - å‘½åçš„ API ç¾¤ç»„ï¼ˆnamed groupï¼‰ï¼š      \n      - REST è·¯å¾„ï¼š`/apis/<group_name>/<version>`      \n      - èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š`apiVersion: <group_name>/<version>`    \n    - å‘½åç©ºé—´çº§åˆ«çš„ REST APIï¼š      \n      - REST è·¯å¾„ï¼š        \n        `/apis/<group_name>/<version>/namespaces/<namespace>/<resource_kind>/<object_name>`      \n      - ç¤ºä¾‹ï¼š        \n        `/apis/apps/v1/namespaces/default/deployments/nginx-deploy`    \n    - è®¿é—® Kubernetes RESTful API çš„æ–¹æ³•ï¼š      \n      - kubectl get å‘½ä»¤è¡Œæ–¹å¼ï¼š        \n        ![kubectl-get-raw-json.jpg](kubectl-get-raw-json.jpg)      \n      - kubectl proxy å‘½ä»¤è¡Œæ–¹å¼ï¼š        \n        ```bash\n        $ kubectl proxy --port=<port>\n        # å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³ï¼Œä½¿å…¶èƒ½å¤Ÿè®¿é—® API Server çš„ REST APIï¼Œè¯¥ç«¯å£ä¸å¯è¢«å ç”¨ã€‚\n        ```\n      - kubectl proxy æ–¹å¼ä½¿ç”¨ kubectl æ‰“å¼€æœ¬åœ° `unix socket`ï¼Œä½¿ curl å‘½ä»¤é€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„æ–¹å¼ä¸ä»£ç†ç½‘å…³é€šä¿¡ï¼Œå®ç°ä¸ API Server çš„äº¤äº’ã€‚        \n      - Kubernetes é›†ç¾¤é»˜è®¤ä½¿ç”¨ `HTTPS` çš„æ–¹å¼è®¿é—® API Server çš„ REST APIã€‚        \n      - ä½¿ç”¨ kubectl proxy å‘½ä»¤å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³åï¼Œåœ¨å¦ä¸€ç»ˆç«¯ä¸­å³å¯ä½¿ç”¨ curl å‘½ä»¤ä»¥ HTTP çš„æ–¹å¼è®¿é—®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š          \n        ```bash\n        $ curl -s http://localhost:8080/api/v1/namespaces/default\n        ```\n\n- Kubernetes çš„ API èµ„æºåˆ†ç±»ï¼š  \n  - å·¥ä½œè´Ÿè½½ç±»å‹ï¼ˆworkloadï¼‰ï¼š    \n    - ReplicationControllerï¼ˆrcï¼‰    \n    - ReplicaSet    \n    - Deployment    \n    - `StatefulSet`    \n    - DaemonSet    \n    - Job  \n  - æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼ˆDiscovery & LBï¼‰ï¼š    \n    - Service    \n    - `Ingress`  \n  - é…ç½®ä¸å­˜å‚¨ï¼ˆConfig & Storageï¼‰ï¼š    \n    - Secret    \n    - `ConfigMap`    \n    - PersistentVolumeClaimï¼ˆpvcï¼‰  \n  - é›†ç¾¤ï¼ˆClusterï¼‰ï¼š    \n    - Namespace    \n    - Node    \n    - Roleã€ClusterRoleã€ClusterRoleBindingã€RoleBinding    \n    - PersistentVolumeï¼ˆpvï¼‰  \n  - å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼š    \n    - `HorizontalPodAutoscaler`ï¼ˆHPAï¼‰    \n    - LimitRange\n- Kubernetes èµ„æºé…ç½®æ¸…å•åŸºç¡€ï¼š  \n  - Kubernetes èµ„æºé…ç½®æ¸…å•çš„ä¸»è¦ä¸€çº§å­—æ®µï¼š    \n    apiVersionã€kindã€metadataã€specã€status  \n  - å…¶ä¸­ metadataã€spec ä¸ status ä¸ºåµŒå¥—å­—æ®µï¼š    \n    - `metadata`ï¼šè®°å½•èµ„æºçš„å…ƒæ•°æ®æ•°æ®    \n    - `spec`ï¼šè®°å½•èµ„æºçš„ç”¨æˆ·æœŸæœ›çŠ¶æ€ï¼ˆdesiredï¼‰ä¿¡æ¯ï¼Œç”±ç”¨æˆ·è‡ªå®šä¹‰å¹¶ç»´æŠ¤ã€‚    \n    - `status`ï¼š      \n      - è®°å½•æ´»åŠ¨å¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼ˆå®é™…çŠ¶æ€ï¼‰ï¼Œç”± Kubernetes è‡ªåŠ¨å¡«å……å¹¶ç»´æŠ¤ï¼Œå¯¹ç”¨æˆ·ä¸ºåªè¯»å­—æ®µã€‚      \n      > ğŸ‘‰ æ´»åŠ¨å¯¹è±¡æ˜¯æŒ‡ç”± Kubernetes åˆ›å»ºçš„èµ„æºå¯¹è±¡ã€‚      \n      - è¯¥å­—æ®µè®°å½•çš„æ´»åŠ¨å¯¹è±¡çš„çŠ¶æ€åº”ä¸ spec å­—æ®µçš„çŠ¶æ€ç›¸åŒï¼Œæˆ–è€…ä¸¤è€…æ— é™æ¥è¿‘ã€‚    \n    - ğŸ’¥ Kubernetes çš„ API Server åªèƒ½æ¥æ”¶å¹¶å“åº” `JSON` å¯¹è±¡ï¼ŒYAML æ ¼å¼çš„å¯¹è±¡éœ€ç»è¿‡ API Server è½¬æ¢åæ‰èƒ½è¢«æ¥æ”¶å¤„ç†ã€‚\n- Kubernetes èµ„æºç®¡ç†æ–¹å¼ï¼š  \n  - Kubernetes çš„ API Server æ”¯æŒå£°æ˜å¼ç¼–ç¨‹ï¼ˆ`delarative programming`ï¼‰ä¸é™ˆè¿°å¼ç¼–ç¨‹ï¼ˆ`impreative programming`ï¼‰ã€‚  \n  - æ¨èä¼˜å…ˆä½¿ç”¨ `apply` æˆ– `patch` å‘½ä»¤çš„å£°æ˜å¼å¯¹è±¡é…ç½®ã€‚  \n  - å¯å°†ä¸åŒèµ„æºç±»å‹çš„å¯¹è±¡é…ç½®ä¿¡æ¯å†™åœ¨åŒä¸€ä¸ªèµ„æºé…ç½®æ¸…å•ä¸­ï¼Œå¹¶ä½¿ç”¨ `---` ç¬¦å·å°†æ¯ä¸ªèµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è¿›è¡Œèµ„æºåˆ†å‰²ã€‚  \n  - ä½¿ç”¨ `Git` ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç®¡ç†èµ„æºé…ç½®æ¸…å•æ–‡ä»¶ã€‚\n- å‘½åç©ºé—´çš„èµ„æºç®¡ç†ï¼š  \n  - å‘½åç©ºé—´ï¼ˆnamespaceï¼‰é€šè¿‡å°†ä¸åŒèµ„æºè¿›è¡Œéš”ç¦»ï¼Œä½¿å‘½åç©ºé—´çš„èµ„æºè¢«ä¸åŒçš„ç”¨æˆ·ã€ç§Ÿæˆ·ä¸é¡¹ç›®ä½¿ç”¨ã€‚  \n  - å‘½åç©ºé—´åªéš”ç¦»ä¸åŒçš„èµ„æºï¼Œä¸éš”ç¦»è·¨å‘½åç©ºé—´çš„ Pod é—´çš„é€šä¿¡ï¼Œå› æ­¤å•çº¯ä½¿ç”¨å‘½åç©ºé—´çš„éš”ç¦»æœºåˆ¶ä¸ºè½¯éš”ç¦»ï¼Œè€Œå¯¹ç½‘ç»œæµé‡çš„éš”ç¦»éœ€è¦ç”±ç½‘ç»œç­–ç•¥ï¼ˆ`network policy`ï¼‰æ¥å®ç°ã€‚  \n  > âœ… ä¸åŒçš„ CNI æ’ä»¶å¯æä¾›ä¸åŒçš„ç½‘ç»œç­–ç•¥åŠŸèƒ½ï¼Œå¦‚ Calicoã€OVS plugin ç­‰ã€‚  \n  - åˆ›å»ºè‡ªå®šä¹‰çš„å‘½åç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n    $ kubectl create namespace <namespace_name>\n    ```\n\n### èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\n- API ç‰ˆæœ¬ä¸èµ„æºå¯¹è±¡è§£é‡Šå‘½ä»¤ï¼š  \n  ```bash\n  $ kubectl --help\n  # æŸ¥çœ‹ kubectl å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•\n  \n  $ kubectl api-versions\n  # æŸ¥çœ‹ API Server æ”¯æŒçš„ API ç‰ˆæœ¬ï¼Œå¹¶ä»¥ group/version çš„æ ¼å¼è¿”å›ã€‚\n  \n  $ kubectl api-resources\n  # æŸ¥çœ‹ API Server æ”¯æŒçš„ API èµ„æºç±»å‹\n  \n  $ kubectl explain <resource_type>\n  # æŸ¥çœ‹ API èµ„æºç±»å‹çš„è§£é‡Šä¿¡æ¯\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl explain pods.spec.containers.imagePullPolicy\n  # æŸ¥çœ‹ Pod èµ„æºå¯¹è±¡ç›¸å…³é…ç½®å­—æ®µçš„è¯¦ç»†ä¿¡æ¯\n  ```\n\n- åˆ›å»º `Deployment` èµ„æºå¯¹è±¡å¹¶è¿è¡Œ Podï¼š  \n  ```bash\n  $ kubectl run <deployment_name> \\\n    --image=<image_name>:<tag> --replicas=<number> --port=<port> \\\n    -n <namespace>\n  # é™ˆè¿°å¼å‘½ä»¤åˆ›å»º Deployment èµ„æºå¯¹è±¡\n  # ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ç›´æ¥åˆ›å»º Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ Pod æ§åˆ¶å™¨åˆ›å»ºå¹¶ç®¡ç† Pod å¯¹è±¡ã€‚\n  # kubectl run å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl run --help\n  #   --image=''                   Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é•œåƒçš„åç§°\n  #   --port=''                    Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨çš„ç«¯å£å·\n  #   --replicas=''                Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°\n  #   --record=[false|true]        å°†å½“å‰çš„ kubectl å‘½ä»¤è®°å½•äºèµ„æºå¯¹è±¡çš„\n  #                                annotation æ³¨é‡Šä¸­\n  #   --save-config=[false|true]   å°†å½“å‰çš„èµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è®°å½•äº annotation\n  #                                æ³¨é‡Šä¸­ï¼Œé»˜è®¤ä¸º falseï¼Œåœ¨ä½¿ç”¨ kubectl apply\n  #                                æ—¶æœ‰ç”¨ã€‚          \n  #  --restart=[Always|OnFailure|Never]\n  #                                Pod èµ„æºå¯¹è±¡çš„é‡å¯ç­–ç•¥ï¼Œé»˜è®¤ä¸º Alwaysã€‚            \n  #  --dry-run=[false|true]        æµ‹è¯•è¿è¡Œï¼ˆå¹²è¿è¡Œï¼‰ï¼Œé»˜è®¤ä¸º falseã€‚\n  #  -nï¼Œ--namespace=''            èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl run nginx-deploy \\\n    --image=nginx:v1.12 --replicas=2 --port=80 -n default\n  # åˆ›å»º Deployment èµ„æºå¯¹è±¡ nginx-deploy\n  \n  $ kubectl run client \\\n    --image=busybox:latest --restart=Never --replicas=1 \\\n    -it -n default -- /bin/sh\n  # æŒ‡å®š --restart=Never é€‰é¡¹æ—¶ï¼Œåªåˆ›å»º Pod èµ„æºå¯¹è±¡ client å¹¶è¿›å…¥ Pod äº¤äº’å¼ç•Œé¢ã€‚             \n  # é€€å‡ºäº¤äº’å¼ç•Œé¢åï¼Œç»ˆæ­¢ Pod èµ„æºå¯¹è±¡è¿è¡Œï¼Œå¹¶è¿›å…¥ Completed çŠ¶æ€ã€‚\n  ```\n\n- åˆ›å»º Service èµ„æºå¯¹è±¡ä¸æš´éœ²åº”ç”¨ç«¯å£ï¼š  \n  ```bash\n  $ kubectl expose deployment <deployment_name> \\\n    --name=<service_name> --port=<port> --target-port=<port_num> \\\n    -n <namespace>\n  # åˆ›å»º Service èµ„æºå¯¹è±¡ï¼Œå¯¹å¤–æš´éœ²å¹¶å…³è” Pod èµ„æºå¯¹è±¡çš„ Pod IP ä¸ç«¯å£ã€‚\n  # kubectl expose å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl expose --help\n  #   --name=''                åˆ›å»ºçš„ Service èµ„æºå¯¹è±¡åç§°\n  #   --port=''                Service èµ„æºå¯¹è±¡çš„ç«¯å£å·\n  #   --target-port=''         Service èµ„æºå¯¹è±¡å…³è”çš„åç«¯ Pod èµ„æºå¯¹è±¡çš„ç«¯å£å·\n  #   -nï¼Œ--namespace=''       èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl expose deployment nginx-deploy \\\n    --name=nginx-svc --port=8080 --target-port=80 -n default\n  # åˆ›å»ºåç§°ä¸º nginx-svc çš„ Service èµ„æºå¯¹è±¡\n  ```\n\n- æŸ¥çœ‹ä¸æ“ä½œç›¸å…³èµ„æºå¯¹è±¡ï¼š\n  ```bash\n  $ kubectl get pods,services -n <namespace> -o wide\n  # æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod ä¸ Service èµ„æºå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆé€—å·åˆ†éš”ï¼‰\n  \n  $ kubectl get <resource_type> \\\n    -n <namespace> -o {yaml|json|jsonpath|wide|custom-columns=...}\n  # æŸ¥çœ‹å‘½åç©ºé—´ä¸­çš„èµ„æºå¯¹è±¡ä¿¡æ¯ï¼Œå¹¶ä»¥ YAMLã€JSONã€å®Œæ•´æ ¼å¼æˆ–è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl get pods \\\n    -o custom-columns=NAME:metadata.name,STATUS:status.phase \n    -n kube-system\n  # æŸ¥çœ‹ kube-system å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡çš„åç§°ä¸çŠ¶æ€ä¿¡æ¯ï¼Œä»¥è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚\n  \n  $ kubectl logs <pod_name> [-c <container_name>] -n <namespace>\n  # æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ä¿¡æ¯\n  # Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚\n  \n  $ kubectl exec <pod_name> \\\n    [-c <container_name>] -n <namespace> -- <command> <opts> <args...>\n  # æ‰§è¡Œå‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å‘½ä»¤\n  # Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚\n  \n  $ kubectl delete \\\n    <resource_type> <resource_name> -l <key>=<value> -n <namespace>\n  # åˆ é™¤å‘½åç©ºé—´ä¸­å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èµ„æºå¯¹è±¡\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl delete deployment myapp --cascade=false -n default\n  # åˆ é™¤ default å‘½åç©ºé—´ä¸­åä¸º myapp çš„ Deployment èµ„æºå¯¹è±¡ï¼Œä½†ä¸åˆ é™¤å…¶åˆ›å»ºçš„ Podã€‚    \n  \n  $ kubectl create -f <file>.yaml|<dir>|<url>\n  # ä½¿ç”¨é™ˆè¿°å¼å‘½ä»¤ create åˆ›å»ºä¸åŒçš„ API èµ„æºå¯¹è±¡\n  \n  $ kubectl apply -f <file>.yaml|<dir>|<url> \n  # ä½¿ç”¨å£°æ˜å¼å‘½ä»¤ apply åˆ›å»ºã€æ›´æ–°ä¸æ›¿æ¢ä¸åŒçš„ API èµ„æºå¯¹è±¡\n  # æ³¨æ„ï¼š\n  #   1. å£°æ˜å¼å¯¹è±¡é…ç½®ç®¡ç†å…·æœ‰é«˜çº§çš„è¡¥ä¸æ›´æ–°æœºåˆ¶ï¼Œå°†ç›¸åº”çš„é…ç½®ä¿¡æ¯è®°å½•äº annotation æ³¨é‡Šä¸­ã€‚\n  #   2. Kubernetes å»ºè®®ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½®æ–¹å¼ï¼ \n  \n  $ kubectl delete -f <file>.yaml\n  # åˆ é™¤è¯¥ YAML é…ç½®æ–‡ä»¶åˆ›å»ºçš„ API èµ„æºå¯¹è±¡\n  \n  $ kubectl scale deployment <deployment_name> --replicas=<number> -n <namespace>\n  # æŒ‡å®šå‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl scale deployment myapp --replicas=3 -n default\n  # æŒ‡å®š default å‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®ä¸º 3 ä¸ª\n  # æ³¨æ„ï¼š\n  #   æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡å‰¯æœ¬æ•°ç›®çš„æ–¹æ³•ï¼š\n  #   1. é€šè¿‡è¯¥å‘½ä»¤è¡Œæ–¹å¼è¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹\n  #   2. ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ›´æ”¹ Deployment èµ„æºå¯¹è±¡çš„é…ç½®ä¿¡æ¯ï¼Œæ›´æ”¹åå®æ—¶ç”Ÿæ•ˆï¼š\n  #      $ kubectl edit deployment myapp -n default\n  ```","source":"_posts/k8s-cluster-resource-basic.md","raw":"---\ntitle: â˜¸ï¸ Kubernetes é›†ç¾¤ä¸èµ„æºç®¡ç†åŸºç¡€\nsubtitle: Kubernetes Cluster and Resource Basic\nheader-img: k8s-resource-basic.svg\ndate: 2022-11-28 15:40:47\ntags:\n  - Kubernetes\n  - äº‘åŸç”Ÿ\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- è¯¥æ–‡æ¡£ä½¿ç”¨çš„ Kubernetes ç‰ˆæœ¬ä¸º `1.12.x`\n- æ–‡æ¡£æ‰€ç¤ºçš„å‘½ä»¤å¯èƒ½ä¸å½“å‰ Kubernetes ç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œè¯·ä»¥å®é™…ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºåŸºå‡†ï¼\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆ\n- Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†\n- èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤\n\n### Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\n- `API Server` ä½œä¸º Kubernetes é›†ç¾¤çš„ç½‘å…³ï¼ˆgatewayï¼‰\n- `etcd` é”®å€¼å‹æ•°æ®åº“ä½œä¸º Kubernetes é›†ç¾¤çš„æ ¸å¿ƒæ•°æ®åº“\n- Kubernetes é›†ç¾¤å¯éƒ¨ç½²ä¸ºå• master é›†ç¾¤æˆ–å¤š masterï¼ˆå¸¸è§ä¸º 3 ä¸ªï¼‰çš„ HA é›†ç¾¤  \n  - å• master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š    \n    ![kubernetes-single-master-arch.jpg](kubernetes-single-master-arch.jpg)  \n  - å¤š master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š    \n    ![kubernetes-ha-arch-demo.jpg](kubernetes-ha-arch-demo.jpg)  \n  > ğŸ‘‰ è¯¥ç¤ºä¾‹ä¸­å°† etcd é›†ç¾¤åˆ†åˆ«éƒ¨ç½²äº 3 ä¸ª master èŠ‚ç‚¹ä¸Šã€‚\n- Kubernetes ä¸­çš„æ¥å£è§„èŒƒï¼š  \n  - `CRI`ï¼šContainer Runtime Interfaceï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰  \n  - `gRPC`ï¼šGoogle Remote Process Callï¼ˆGoogle å‘å¸ƒçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ¡†æ¶ï¼‰  \n  - `OCI`ï¼šOpen Container Initiativeï¼ˆå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰  \n  - `CNI`ï¼šContainer Network Interfaceï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰  \n  - `CSI`ï¼šContainer Storage Interfaceï¼ˆå®¹å™¨å­˜å‚¨æ¥å£ï¼‰  \n  - ä»¥ä¸Šå„æ¥å£è§„èŒƒåœ¨é›†ç¾¤ä¸­ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨ç¤ºæ„ï¼š    \n    ![kubernetes-interface-1.jpg](kubernetes-interface-1.jpg)![kubernetes-interface-2.jpg](kubernetes-interface-2.jpg)\n- Kubernetes é›†ç¾¤ä¸­çš„ç½‘ç»œæ¦‚è¿°ï¼š  \n  - é›†ç¾¤ä¸­çš„é€šä¿¡ç§ç±»ï¼š    \n    - åŒä¸€ Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é—´çš„é€šä¿¡    \n    - å„ Pod èµ„æºå¯¹è±¡å½¼æ­¤é—´çš„é€šä¿¡    \n    > ğŸ‘‰ Pod é—´åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šé€šä¿¡æˆ–å½¼æ­¤è·¨èŠ‚ç‚¹é—´é€šä¿¡    \n    - Pod èµ„æºå¯¹è±¡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡    \n    - é›†ç¾¤å¤–éƒ¨çš„æµé‡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡  \n  - é›†ç¾¤ç½‘ç»œè§„åˆ’éƒ¨ç½²ï¼š    \n    - Kubernetes é›†ç¾¤ä¸»æœºé—´çš„ç½‘ç»œ    \n    - Service èµ„æºå¯¹è±¡å®šä¹‰çš„ `ClusterIP` ç½‘ç»œ    \n    - ç”±ä¸åŒ `CNI` å®šä¹‰çš„ Pod é—´çš„é€šä¿¡ç½‘ç»œ\n- Kubernetes é›†ç¾¤çš„å®¢æˆ·ç«¯ç±»å‹ï¼š  \n  - Kubernetes çš„ API Server çš„å®¢æˆ·ç«¯ï¼š    \n    é›†ç¾¤åŠé¡¹ç›®ç®¡ç†äººå‘˜ã€å¼€å‘äººå‘˜ã€é›†ç¾¤ä¸­ä¸ API Server äº¤äº’çš„ç»„ä»¶  \n  - Kubernetes çš„è®¿é—® Pod çš„å®¢æˆ·ç«¯ï¼š    \n    é›†ç¾¤å¤–çš„æ™®é€šç”¨æˆ·ã€å‘½åç©ºé—´å†…çš„ Pod åº”ç”¨ï¼ˆPod Clientï¼‰\n\n### Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\n- kubectl å‘½ä»¤ç®¡ç†èµ„æºå¯¹è±¡çš„ 3 ç§æ–¹å¼ï¼š  \n  - é™ˆè¿°å¼å‘½ä»¤ï¼šä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ç®¡ç†  \n  - é™ˆè¿°å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ `kubectl create` å‘½ä»¤åˆ›å»º  \n  - å£°æ˜å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ `kubectl apply` å‘½ä»¤åˆ›å»º\n- Kubernetes ä½¿ç”¨ `Deployment` èµ„æºå¯¹è±¡ï¼ˆPod æ§åˆ¶å™¨ï¼‰éƒ¨ç½²ä¸ç®¡ç†å‰ç«¯æ— çŠ¶æ€ï¼ˆ`Stateless`ï¼‰çš„ Pod èµ„æºå¯¹è±¡ï¼Œè€Œ Deployment èµ„æºå¯¹è±¡å¹¶ä¸ç›´æ¥ä½œç”¨äº Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨ `ReplicaSet` èµ„æºå¯¹è±¡è¿›è¡Œéƒ¨ç½²ä¸ç®¡ç†ã€‚\n- Deployment èµ„æºå¯¹è±¡æ˜¯ ReplicaSet èµ„æºå¯¹è±¡ä¹‹ä¸Šçš„ Pod æ§åˆ¶å™¨ï¼Œä¸¤è€…éƒ½ä¸ºå·¥ä½œè´Ÿè½½å‹ï¼ˆworkloadï¼‰èµ„æºå¯¹è±¡ã€‚\n- ä½¿ç”¨ Deployment èµ„æºå¯¹è±¡éƒ¨ç½²çš„ Pod èµ„æºå¯¹è±¡éƒ½å…·æœ‰ `run=<pod_controller_name>` çš„æ ‡ç­¾ï¼ˆlabelï¼‰ã€‚\n- Pod èµ„æºå¯¹è±¡çš„åç§°ï¼š`<replicaset_name>-<random_char>`  \n  ![pod-name.jpg](pod-name.jpg)\n- Podèµ„æºå¯¹è±¡çš„çŠ¶æ€ï¼š  \n  Pendingã€Runningã€Succeededã€Failedã€Unknown\n- Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯ç®¡ç†ï¼š  \n  - ğŸ³ Kubernetes é›†ç¾¤ä¸­ Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯é»˜è®¤ä»¥æ ‡å‡†é”™è¯¯ï¼ˆ`standard error`ï¼‰è¾“å‡ºè‡³æ§åˆ¶å°ï¼Œå¯ä½¿ç”¨ kubectl logs å‘½ä»¤æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä¿¡æ¯ã€‚  \n  - å¿…é¡»ä½¿ç”¨é›†ä¸­å¼çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿç®¡ç† Pod å®¹å™¨æ—¥å¿—ã€‚  \n  - ä½¿ç”¨ kubectl logs å‘½ä»¤åªèƒ½æŸ¥çœ‹å­˜åœ¨çš„ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ï¼Œä¸èƒ½æŸ¥çœ‹å·²åˆ é™¤çš„Pod èµ„æºå¯¹è±¡æ—¥å¿—ã€‚\n- Kubernetes çš„ `API` èµ„æºæ¦‚è¿°ï¼š  \n  - API Server æä¾›åŸºäº `RESTful` é£æ ¼æ¶æ„çš„ç¼–ç¨‹æ¥å£ï¼Œæ¥æ”¶åŸºäº `HTTP/HTTPS` çš„å®¢æˆ·ç«¯ç»„ä»¶è¯·æ±‚ï¼Œå¹¶å°†å…¶å¤„ç†è¿”å›ã€‚  \n  - Kubernetes çš„å…¶ä»–ç»„ä»¶è¢«æŠ½è±¡ä¸ºæ ‡å‡†çš„ REST èµ„æºï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ `JSON` åºåˆ—åŒ–æ•°æ®å¯¹ å…¶ç®¡ç†ä¸æ§åˆ¶ã€‚  \n  - API èµ„æºç±»å‹åŒ…æ‹¬ï¼š    \n    - å¯¹è±¡ç±»ï¼ˆObjectï¼‰    \n    - åˆ—è¡¨ç±»ï¼ˆListï¼‰    \n    - ç®€å•ç±»ï¼ˆSimpleï¼‰  \n  - Kubernetes ä¸­çš„ API èµ„æºç±»å‹ç»å¤§å¤šæ•°ä»¥å¯¹è±¡çš„æ–¹å¼å­˜åœ¨ï¼Œå¯¹è±¡æ˜¯èµ„æºè¿è¡Œæ—¶ç”Ÿæˆçš„å®ä¾‹ï¼Œä¸”ä¸ºæŒä¹…åŒ–çš„å®ä½“ã€‚  \n  - API å¯¹åº”äºèµ„æºç±»å‹çš„ `URI`ï¼Œå³èµ„æºç±»å‹çš„ `YAML` é…ç½®æ–‡ä»¶ä¸­çš„ `selfLink` å­—æ®µï¼Œå…¶çŠ¶æ€å­˜å‚¨äºåç«¯ etcd æ•°æ®åº“ä¸­ã€‚  \n  > ğŸ’¥ Kubernetes v1.20 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤åˆ é™¤äº† `metadata.selfLink` å­—æ®µï¼Œç„¶è€Œï¼Œéƒ¨åˆ†åº”ç”¨ä»ç„¶ä¾èµ–äºè¯¥å­—æ®µï¼Œå¦‚ `nfs-client-provisioner`ã€‚å¦‚æœä»ç„¶è¦ç»§ç»­ä½¿ç”¨è¿™äº›åº”ç”¨ï¼Œéœ€è¦é‡æ–°å¯ç”¨è¯¥å­—æ®µã€‚  \n  - ğŸš€ è‹¥é›†ç¾¤ä½¿ç”¨ `kubeadm` ç»„ä»¶éƒ¨ç½²ï¼Œå¯ä¿®æ”¹æ§åˆ¶å¹³é¢ï¼ˆcontrol planï¼‰å„èŠ‚ç‚¹çš„ `/etc/kubernetes/manifests/kube-apiserver.yaml` æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æ·»åŠ  `--feature-gates=RemoveSelfLink=false` é€‰é¡¹ä»¥å¯ç”¨è¯¥å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ![kubernetes-apiserver-manifest.jpg](kubernetes-apiserver-manifest.jpg)    \n    - å…³äº selfLink çš„è¯´æ˜å¯å‚è€ƒ [è¯¥é“¾æ¥](https://kuboard.cn/install/faq/selfLink.html)    \n    - å…³äº kube-apiserver å‘½ä»¤çš„é€‰é¡¹å¯å‚è€ƒ [kube-apiserver å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/)  \n  - Kubernetes å°† API è¿›è¡Œé€»è¾‘åˆ†ç»„ï¼Œç§°ä¸º API ç¾¤ç»„ï¼ˆAPI groupï¼‰ã€‚  \n  - ğŸš€ Kubernetes çš„ API Server æ”¯æŒç›¸åŒçš„ API ç¾¤ç»„ä¸­ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼Œå› æ­¤èƒ½åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ï¼Œä»è€Œåœ¨ç¨³å®šç‰ˆæœ¬ä¸æ–°çš„å®éªŒç‰ˆæœ¬ä¸­èƒ½ä»¥ä¸åŒçš„ç‰¹æ€§ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ã€‚  \n  > å…³äº API ç¾¤ç»„çš„åˆ†ç±»ä¸è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ [è¯¥é“¾æ¥](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/)  \n  - Kubernetes çš„ API å±‚çº§ç»“æ„ï¼š    \n    - æ ¸å¿ƒ API ç¾¤ç»„ï¼ˆcore groupï¼‰ï¼š      \n      - REST è·¯å¾„ï¼š`/api/v1`      \n      - èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š`apiVersion: v1`    \n    - å‘½åçš„ API ç¾¤ç»„ï¼ˆnamed groupï¼‰ï¼š      \n      - REST è·¯å¾„ï¼š`/apis/<group_name>/<version>`      \n      - èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š`apiVersion: <group_name>/<version>`    \n    - å‘½åç©ºé—´çº§åˆ«çš„ REST APIï¼š      \n      - REST è·¯å¾„ï¼š        \n        `/apis/<group_name>/<version>/namespaces/<namespace>/<resource_kind>/<object_name>`      \n      - ç¤ºä¾‹ï¼š        \n        `/apis/apps/v1/namespaces/default/deployments/nginx-deploy`    \n    - è®¿é—® Kubernetes RESTful API çš„æ–¹æ³•ï¼š      \n      - kubectl get å‘½ä»¤è¡Œæ–¹å¼ï¼š        \n        ![kubectl-get-raw-json.jpg](kubectl-get-raw-json.jpg)      \n      - kubectl proxy å‘½ä»¤è¡Œæ–¹å¼ï¼š        \n        ```bash\n        $ kubectl proxy --port=<port>\n        # å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³ï¼Œä½¿å…¶èƒ½å¤Ÿè®¿é—® API Server çš„ REST APIï¼Œè¯¥ç«¯å£ä¸å¯è¢«å ç”¨ã€‚\n        ```\n      - kubectl proxy æ–¹å¼ä½¿ç”¨ kubectl æ‰“å¼€æœ¬åœ° `unix socket`ï¼Œä½¿ curl å‘½ä»¤é€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„æ–¹å¼ä¸ä»£ç†ç½‘å…³é€šä¿¡ï¼Œå®ç°ä¸ API Server çš„äº¤äº’ã€‚        \n      - Kubernetes é›†ç¾¤é»˜è®¤ä½¿ç”¨ `HTTPS` çš„æ–¹å¼è®¿é—® API Server çš„ REST APIã€‚        \n      - ä½¿ç”¨ kubectl proxy å‘½ä»¤å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³åï¼Œåœ¨å¦ä¸€ç»ˆç«¯ä¸­å³å¯ä½¿ç”¨ curl å‘½ä»¤ä»¥ HTTP çš„æ–¹å¼è®¿é—®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š          \n        ```bash\n        $ curl -s http://localhost:8080/api/v1/namespaces/default\n        ```\n\n- Kubernetes çš„ API èµ„æºåˆ†ç±»ï¼š  \n  - å·¥ä½œè´Ÿè½½ç±»å‹ï¼ˆworkloadï¼‰ï¼š    \n    - ReplicationControllerï¼ˆrcï¼‰    \n    - ReplicaSet    \n    - Deployment    \n    - `StatefulSet`    \n    - DaemonSet    \n    - Job  \n  - æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼ˆDiscovery & LBï¼‰ï¼š    \n    - Service    \n    - `Ingress`  \n  - é…ç½®ä¸å­˜å‚¨ï¼ˆConfig & Storageï¼‰ï¼š    \n    - Secret    \n    - `ConfigMap`    \n    - PersistentVolumeClaimï¼ˆpvcï¼‰  \n  - é›†ç¾¤ï¼ˆClusterï¼‰ï¼š    \n    - Namespace    \n    - Node    \n    - Roleã€ClusterRoleã€ClusterRoleBindingã€RoleBinding    \n    - PersistentVolumeï¼ˆpvï¼‰  \n  - å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼š    \n    - `HorizontalPodAutoscaler`ï¼ˆHPAï¼‰    \n    - LimitRange\n- Kubernetes èµ„æºé…ç½®æ¸…å•åŸºç¡€ï¼š  \n  - Kubernetes èµ„æºé…ç½®æ¸…å•çš„ä¸»è¦ä¸€çº§å­—æ®µï¼š    \n    apiVersionã€kindã€metadataã€specã€status  \n  - å…¶ä¸­ metadataã€spec ä¸ status ä¸ºåµŒå¥—å­—æ®µï¼š    \n    - `metadata`ï¼šè®°å½•èµ„æºçš„å…ƒæ•°æ®æ•°æ®    \n    - `spec`ï¼šè®°å½•èµ„æºçš„ç”¨æˆ·æœŸæœ›çŠ¶æ€ï¼ˆdesiredï¼‰ä¿¡æ¯ï¼Œç”±ç”¨æˆ·è‡ªå®šä¹‰å¹¶ç»´æŠ¤ã€‚    \n    - `status`ï¼š      \n      - è®°å½•æ´»åŠ¨å¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼ˆå®é™…çŠ¶æ€ï¼‰ï¼Œç”± Kubernetes è‡ªåŠ¨å¡«å……å¹¶ç»´æŠ¤ï¼Œå¯¹ç”¨æˆ·ä¸ºåªè¯»å­—æ®µã€‚      \n      > ğŸ‘‰ æ´»åŠ¨å¯¹è±¡æ˜¯æŒ‡ç”± Kubernetes åˆ›å»ºçš„èµ„æºå¯¹è±¡ã€‚      \n      - è¯¥å­—æ®µè®°å½•çš„æ´»åŠ¨å¯¹è±¡çš„çŠ¶æ€åº”ä¸ spec å­—æ®µçš„çŠ¶æ€ç›¸åŒï¼Œæˆ–è€…ä¸¤è€…æ— é™æ¥è¿‘ã€‚    \n    - ğŸ’¥ Kubernetes çš„ API Server åªèƒ½æ¥æ”¶å¹¶å“åº” `JSON` å¯¹è±¡ï¼ŒYAML æ ¼å¼çš„å¯¹è±¡éœ€ç»è¿‡ API Server è½¬æ¢åæ‰èƒ½è¢«æ¥æ”¶å¤„ç†ã€‚\n- Kubernetes èµ„æºç®¡ç†æ–¹å¼ï¼š  \n  - Kubernetes çš„ API Server æ”¯æŒå£°æ˜å¼ç¼–ç¨‹ï¼ˆ`delarative programming`ï¼‰ä¸é™ˆè¿°å¼ç¼–ç¨‹ï¼ˆ`impreative programming`ï¼‰ã€‚  \n  - æ¨èä¼˜å…ˆä½¿ç”¨ `apply` æˆ– `patch` å‘½ä»¤çš„å£°æ˜å¼å¯¹è±¡é…ç½®ã€‚  \n  - å¯å°†ä¸åŒèµ„æºç±»å‹çš„å¯¹è±¡é…ç½®ä¿¡æ¯å†™åœ¨åŒä¸€ä¸ªèµ„æºé…ç½®æ¸…å•ä¸­ï¼Œå¹¶ä½¿ç”¨ `---` ç¬¦å·å°†æ¯ä¸ªèµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è¿›è¡Œèµ„æºåˆ†å‰²ã€‚  \n  - ä½¿ç”¨ `Git` ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç®¡ç†èµ„æºé…ç½®æ¸…å•æ–‡ä»¶ã€‚\n- å‘½åç©ºé—´çš„èµ„æºç®¡ç†ï¼š  \n  - å‘½åç©ºé—´ï¼ˆnamespaceï¼‰é€šè¿‡å°†ä¸åŒèµ„æºè¿›è¡Œéš”ç¦»ï¼Œä½¿å‘½åç©ºé—´çš„èµ„æºè¢«ä¸åŒçš„ç”¨æˆ·ã€ç§Ÿæˆ·ä¸é¡¹ç›®ä½¿ç”¨ã€‚  \n  - å‘½åç©ºé—´åªéš”ç¦»ä¸åŒçš„èµ„æºï¼Œä¸éš”ç¦»è·¨å‘½åç©ºé—´çš„ Pod é—´çš„é€šä¿¡ï¼Œå› æ­¤å•çº¯ä½¿ç”¨å‘½åç©ºé—´çš„éš”ç¦»æœºåˆ¶ä¸ºè½¯éš”ç¦»ï¼Œè€Œå¯¹ç½‘ç»œæµé‡çš„éš”ç¦»éœ€è¦ç”±ç½‘ç»œç­–ç•¥ï¼ˆ`network policy`ï¼‰æ¥å®ç°ã€‚  \n  > âœ… ä¸åŒçš„ CNI æ’ä»¶å¯æä¾›ä¸åŒçš„ç½‘ç»œç­–ç•¥åŠŸèƒ½ï¼Œå¦‚ Calicoã€OVS plugin ç­‰ã€‚  \n  - åˆ›å»ºè‡ªå®šä¹‰çš„å‘½åç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n    $ kubectl create namespace <namespace_name>\n    ```\n\n### èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\n- API ç‰ˆæœ¬ä¸èµ„æºå¯¹è±¡è§£é‡Šå‘½ä»¤ï¼š  \n  ```bash\n  $ kubectl --help\n  # æŸ¥çœ‹ kubectl å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•\n  \n  $ kubectl api-versions\n  # æŸ¥çœ‹ API Server æ”¯æŒçš„ API ç‰ˆæœ¬ï¼Œå¹¶ä»¥ group/version çš„æ ¼å¼è¿”å›ã€‚\n  \n  $ kubectl api-resources\n  # æŸ¥çœ‹ API Server æ”¯æŒçš„ API èµ„æºç±»å‹\n  \n  $ kubectl explain <resource_type>\n  # æŸ¥çœ‹ API èµ„æºç±»å‹çš„è§£é‡Šä¿¡æ¯\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl explain pods.spec.containers.imagePullPolicy\n  # æŸ¥çœ‹ Pod èµ„æºå¯¹è±¡ç›¸å…³é…ç½®å­—æ®µçš„è¯¦ç»†ä¿¡æ¯\n  ```\n\n- åˆ›å»º `Deployment` èµ„æºå¯¹è±¡å¹¶è¿è¡Œ Podï¼š  \n  ```bash\n  $ kubectl run <deployment_name> \\\n    --image=<image_name>:<tag> --replicas=<number> --port=<port> \\\n    -n <namespace>\n  # é™ˆè¿°å¼å‘½ä»¤åˆ›å»º Deployment èµ„æºå¯¹è±¡\n  # ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ç›´æ¥åˆ›å»º Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ Pod æ§åˆ¶å™¨åˆ›å»ºå¹¶ç®¡ç† Pod å¯¹è±¡ã€‚\n  # kubectl run å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl run --help\n  #   --image=''                   Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é•œåƒçš„åç§°\n  #   --port=''                    Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨çš„ç«¯å£å·\n  #   --replicas=''                Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°\n  #   --record=[false|true]        å°†å½“å‰çš„ kubectl å‘½ä»¤è®°å½•äºèµ„æºå¯¹è±¡çš„\n  #                                annotation æ³¨é‡Šä¸­\n  #   --save-config=[false|true]   å°†å½“å‰çš„èµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è®°å½•äº annotation\n  #                                æ³¨é‡Šä¸­ï¼Œé»˜è®¤ä¸º falseï¼Œåœ¨ä½¿ç”¨ kubectl apply\n  #                                æ—¶æœ‰ç”¨ã€‚          \n  #  --restart=[Always|OnFailure|Never]\n  #                                Pod èµ„æºå¯¹è±¡çš„é‡å¯ç­–ç•¥ï¼Œé»˜è®¤ä¸º Alwaysã€‚            \n  #  --dry-run=[false|true]        æµ‹è¯•è¿è¡Œï¼ˆå¹²è¿è¡Œï¼‰ï¼Œé»˜è®¤ä¸º falseã€‚\n  #  -nï¼Œ--namespace=''            èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl run nginx-deploy \\\n    --image=nginx:v1.12 --replicas=2 --port=80 -n default\n  # åˆ›å»º Deployment èµ„æºå¯¹è±¡ nginx-deploy\n  \n  $ kubectl run client \\\n    --image=busybox:latest --restart=Never --replicas=1 \\\n    -it -n default -- /bin/sh\n  # æŒ‡å®š --restart=Never é€‰é¡¹æ—¶ï¼Œåªåˆ›å»º Pod èµ„æºå¯¹è±¡ client å¹¶è¿›å…¥ Pod äº¤äº’å¼ç•Œé¢ã€‚             \n  # é€€å‡ºäº¤äº’å¼ç•Œé¢åï¼Œç»ˆæ­¢ Pod èµ„æºå¯¹è±¡è¿è¡Œï¼Œå¹¶è¿›å…¥ Completed çŠ¶æ€ã€‚\n  ```\n\n- åˆ›å»º Service èµ„æºå¯¹è±¡ä¸æš´éœ²åº”ç”¨ç«¯å£ï¼š  \n  ```bash\n  $ kubectl expose deployment <deployment_name> \\\n    --name=<service_name> --port=<port> --target-port=<port_num> \\\n    -n <namespace>\n  # åˆ›å»º Service èµ„æºå¯¹è±¡ï¼Œå¯¹å¤–æš´éœ²å¹¶å…³è” Pod èµ„æºå¯¹è±¡çš„ Pod IP ä¸ç«¯å£ã€‚\n  # kubectl expose å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl expose --help\n  #   --name=''                åˆ›å»ºçš„ Service èµ„æºå¯¹è±¡åç§°\n  #   --port=''                Service èµ„æºå¯¹è±¡çš„ç«¯å£å·\n  #   --target-port=''         Service èµ„æºå¯¹è±¡å…³è”çš„åç«¯ Pod èµ„æºå¯¹è±¡çš„ç«¯å£å·\n  #   -nï¼Œ--namespace=''       èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl expose deployment nginx-deploy \\\n    --name=nginx-svc --port=8080 --target-port=80 -n default\n  # åˆ›å»ºåç§°ä¸º nginx-svc çš„ Service èµ„æºå¯¹è±¡\n  ```\n\n- æŸ¥çœ‹ä¸æ“ä½œç›¸å…³èµ„æºå¯¹è±¡ï¼š\n  ```bash\n  $ kubectl get pods,services -n <namespace> -o wide\n  # æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod ä¸ Service èµ„æºå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆé€—å·åˆ†éš”ï¼‰\n  \n  $ kubectl get <resource_type> \\\n    -n <namespace> -o {yaml|json|jsonpath|wide|custom-columns=...}\n  # æŸ¥çœ‹å‘½åç©ºé—´ä¸­çš„èµ„æºå¯¹è±¡ä¿¡æ¯ï¼Œå¹¶ä»¥ YAMLã€JSONã€å®Œæ•´æ ¼å¼æˆ–è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl get pods \\\n    -o custom-columns=NAME:metadata.name,STATUS:status.phase \n    -n kube-system\n  # æŸ¥çœ‹ kube-system å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡çš„åç§°ä¸çŠ¶æ€ä¿¡æ¯ï¼Œä»¥è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚\n  \n  $ kubectl logs <pod_name> [-c <container_name>] -n <namespace>\n  # æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ä¿¡æ¯\n  # Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚\n  \n  $ kubectl exec <pod_name> \\\n    [-c <container_name>] -n <namespace> -- <command> <opts> <args...>\n  # æ‰§è¡Œå‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å‘½ä»¤\n  # Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚\n  \n  $ kubectl delete \\\n    <resource_type> <resource_name> -l <key>=<value> -n <namespace>\n  # åˆ é™¤å‘½åç©ºé—´ä¸­å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èµ„æºå¯¹è±¡\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl delete deployment myapp --cascade=false -n default\n  # åˆ é™¤ default å‘½åç©ºé—´ä¸­åä¸º myapp çš„ Deployment èµ„æºå¯¹è±¡ï¼Œä½†ä¸åˆ é™¤å…¶åˆ›å»ºçš„ Podã€‚    \n  \n  $ kubectl create -f <file>.yaml|<dir>|<url>\n  # ä½¿ç”¨é™ˆè¿°å¼å‘½ä»¤ create åˆ›å»ºä¸åŒçš„ API èµ„æºå¯¹è±¡\n  \n  $ kubectl apply -f <file>.yaml|<dir>|<url> \n  # ä½¿ç”¨å£°æ˜å¼å‘½ä»¤ apply åˆ›å»ºã€æ›´æ–°ä¸æ›¿æ¢ä¸åŒçš„ API èµ„æºå¯¹è±¡\n  # æ³¨æ„ï¼š\n  #   1. å£°æ˜å¼å¯¹è±¡é…ç½®ç®¡ç†å…·æœ‰é«˜çº§çš„è¡¥ä¸æ›´æ–°æœºåˆ¶ï¼Œå°†ç›¸åº”çš„é…ç½®ä¿¡æ¯è®°å½•äº annotation æ³¨é‡Šä¸­ã€‚\n  #   2. Kubernetes å»ºè®®ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½®æ–¹å¼ï¼ \n  \n  $ kubectl delete -f <file>.yaml\n  # åˆ é™¤è¯¥ YAML é…ç½®æ–‡ä»¶åˆ›å»ºçš„ API èµ„æºå¯¹è±¡\n  \n  $ kubectl scale deployment <deployment_name> --replicas=<number> -n <namespace>\n  # æŒ‡å®šå‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®\n  \n  ### ç¤ºä¾‹ ###\n  $ kubectl scale deployment myapp --replicas=3 -n default\n  # æŒ‡å®š default å‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®ä¸º 3 ä¸ª\n  # æ³¨æ„ï¼š\n  #   æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡å‰¯æœ¬æ•°ç›®çš„æ–¹æ³•ï¼š\n  #   1. é€šè¿‡è¯¥å‘½ä»¤è¡Œæ–¹å¼è¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹\n  #   2. ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ›´æ”¹ Deployment èµ„æºå¯¹è±¡çš„é…ç½®ä¿¡æ¯ï¼Œæ›´æ”¹åå®æ—¶ç”Ÿæ•ˆï¼š\n  #      $ kubectl edit deployment myapp -n default\n  ```","slug":"k8s-cluster-resource-basic","published":1,"updated":"2022-11-28T13:47:24.090Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonoko000816vdmg3j0qwb","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>è¯¥æ–‡æ¡£ä½¿ç”¨çš„ Kubernetes ç‰ˆæœ¬ä¸º <code>1.12.x</code></li>\n<li>æ–‡æ¡£æ‰€ç¤ºçš„å‘½ä»¤å¯èƒ½ä¸å½“å‰ Kubernetes ç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œè¯·ä»¥å®é™…ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºåŸºå‡†ï¼</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆ</li>\n<li>Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†</li>\n<li>èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤</li>\n</ul>\n<h3 id=\"Kubernetes-é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\"><a href=\"#Kubernetes-é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\" class=\"headerlink\" title=\"Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\"></a>Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š</h3><ul>\n<li><code>API Server</code> ä½œä¸º Kubernetes é›†ç¾¤çš„ç½‘å…³ï¼ˆgatewayï¼‰</li>\n<li><code>etcd</code> é”®å€¼å‹æ•°æ®åº“ä½œä¸º Kubernetes é›†ç¾¤çš„æ ¸å¿ƒæ•°æ®åº“</li>\n<li>Kubernetes é›†ç¾¤å¯éƒ¨ç½²ä¸ºå• master é›†ç¾¤æˆ–å¤š masterï¼ˆå¸¸è§ä¸º 3 ä¸ªï¼‰çš„ HA é›†ç¾¤  <ul>\n<li>å• master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š<br><img src=\"kubernetes-single-master-arch.jpg\" alt=\"kubernetes-single-master-arch.jpg\">  </li>\n<li>å¤š master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š<br><img src=\"kubernetes-ha-arch-demo.jpg\" alt=\"kubernetes-ha-arch-demo.jpg\">  <blockquote>\n<p>ğŸ‘‰ è¯¥ç¤ºä¾‹ä¸­å°† etcd é›†ç¾¤åˆ†åˆ«éƒ¨ç½²äº 3 ä¸ª master èŠ‚ç‚¹ä¸Šã€‚</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>Kubernetes ä¸­çš„æ¥å£è§„èŒƒï¼š  <ul>\n<li><code>CRI</code>ï¼šContainer Runtime Interfaceï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰  </li>\n<li><code>gRPC</code>ï¼šGoogle Remote Process Callï¼ˆGoogle å‘å¸ƒçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ¡†æ¶ï¼‰  </li>\n<li><code>OCI</code>ï¼šOpen Container Initiativeï¼ˆå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰  </li>\n<li><code>CNI</code>ï¼šContainer Network Interfaceï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰  </li>\n<li><code>CSI</code>ï¼šContainer Storage Interfaceï¼ˆå®¹å™¨å­˜å‚¨æ¥å£ï¼‰  </li>\n<li>ä»¥ä¸Šå„æ¥å£è§„èŒƒåœ¨é›†ç¾¤ä¸­ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨ç¤ºæ„ï¼š<br><img src=\"kubernetes-interface-1.jpg\" alt=\"kubernetes-interface-1.jpg\"><img src=\"kubernetes-interface-2.jpg\" alt=\"kubernetes-interface-2.jpg\"></li>\n</ul>\n</li>\n<li>Kubernetes é›†ç¾¤ä¸­çš„ç½‘ç»œæ¦‚è¿°ï¼š  <ul>\n<li>é›†ç¾¤ä¸­çš„é€šä¿¡ç§ç±»ï¼š    <ul>\n<li>åŒä¸€ Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é—´çš„é€šä¿¡    </li>\n<li>å„ Pod èµ„æºå¯¹è±¡å½¼æ­¤é—´çš„é€šä¿¡    <blockquote>\n<p>ğŸ‘‰ Pod é—´åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šé€šä¿¡æˆ–å½¼æ­¤è·¨èŠ‚ç‚¹é—´é€šä¿¡    </p>\n</blockquote>\n</li>\n<li>Pod èµ„æºå¯¹è±¡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡    </li>\n<li>é›†ç¾¤å¤–éƒ¨çš„æµé‡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡  </li>\n</ul>\n</li>\n<li>é›†ç¾¤ç½‘ç»œè§„åˆ’éƒ¨ç½²ï¼š    <ul>\n<li>Kubernetes é›†ç¾¤ä¸»æœºé—´çš„ç½‘ç»œ    </li>\n<li>Service èµ„æºå¯¹è±¡å®šä¹‰çš„ <code>ClusterIP</code> ç½‘ç»œ    </li>\n<li>ç”±ä¸åŒ <code>CNI</code> å®šä¹‰çš„ Pod é—´çš„é€šä¿¡ç½‘ç»œ</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Kubernetes é›†ç¾¤çš„å®¢æˆ·ç«¯ç±»å‹ï¼š  <ul>\n<li>Kubernetes çš„ API Server çš„å®¢æˆ·ç«¯ï¼š<br>é›†ç¾¤åŠé¡¹ç›®ç®¡ç†äººå‘˜ã€å¼€å‘äººå‘˜ã€é›†ç¾¤ä¸­ä¸ API Server äº¤äº’çš„ç»„ä»¶  </li>\n<li>Kubernetes çš„è®¿é—® Pod çš„å®¢æˆ·ç«¯ï¼š<br>é›†ç¾¤å¤–çš„æ™®é€šç”¨æˆ·ã€å‘½åç©ºé—´å†…çš„ Pod åº”ç”¨ï¼ˆPod Clientï¼‰</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Kubernetes-é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\"><a href=\"#Kubernetes-é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\" class=\"headerlink\" title=\"Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\"></a>Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š</h3><ul>\n<li>kubectl å‘½ä»¤ç®¡ç†èµ„æºå¯¹è±¡çš„ 3 ç§æ–¹å¼ï¼š  <ul>\n<li>é™ˆè¿°å¼å‘½ä»¤ï¼šä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ç®¡ç†  </li>\n<li>é™ˆè¿°å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ <code>kubectl create</code> å‘½ä»¤åˆ›å»º  </li>\n<li>å£°æ˜å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ <code>kubectl apply</code> å‘½ä»¤åˆ›å»º</li>\n</ul>\n</li>\n<li>Kubernetes ä½¿ç”¨ <code>Deployment</code> èµ„æºå¯¹è±¡ï¼ˆPod æ§åˆ¶å™¨ï¼‰éƒ¨ç½²ä¸ç®¡ç†å‰ç«¯æ— çŠ¶æ€ï¼ˆ<code>Stateless</code>ï¼‰çš„ Pod èµ„æºå¯¹è±¡ï¼Œè€Œ Deployment èµ„æºå¯¹è±¡å¹¶ä¸ç›´æ¥ä½œç”¨äº Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨ <code>ReplicaSet</code> èµ„æºå¯¹è±¡è¿›è¡Œéƒ¨ç½²ä¸ç®¡ç†ã€‚</li>\n<li>Deployment èµ„æºå¯¹è±¡æ˜¯ ReplicaSet èµ„æºå¯¹è±¡ä¹‹ä¸Šçš„ Pod æ§åˆ¶å™¨ï¼Œä¸¤è€…éƒ½ä¸ºå·¥ä½œè´Ÿè½½å‹ï¼ˆworkloadï¼‰èµ„æºå¯¹è±¡ã€‚</li>\n<li>ä½¿ç”¨ Deployment èµ„æºå¯¹è±¡éƒ¨ç½²çš„ Pod èµ„æºå¯¹è±¡éƒ½å…·æœ‰ <code>run=&lt;pod_controller_name&gt;</code> çš„æ ‡ç­¾ï¼ˆlabelï¼‰ã€‚</li>\n<li>Pod èµ„æºå¯¹è±¡çš„åç§°ï¼š<code>&lt;replicaset_name&gt;-&lt;random_char&gt;</code><br><img src=\"pod-name.jpg\" alt=\"pod-name.jpg\"></li>\n<li>Podèµ„æºå¯¹è±¡çš„çŠ¶æ€ï¼š<br>Pendingã€Runningã€Succeededã€Failedã€Unknown</li>\n<li>Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯ç®¡ç†ï¼š  <ul>\n<li>ğŸ³ Kubernetes é›†ç¾¤ä¸­ Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯é»˜è®¤ä»¥æ ‡å‡†é”™è¯¯ï¼ˆ<code>standard error</code>ï¼‰è¾“å‡ºè‡³æ§åˆ¶å°ï¼Œå¯ä½¿ç”¨ kubectl logs å‘½ä»¤æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä¿¡æ¯ã€‚  </li>\n<li>å¿…é¡»ä½¿ç”¨é›†ä¸­å¼çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿç®¡ç† Pod å®¹å™¨æ—¥å¿—ã€‚  </li>\n<li>ä½¿ç”¨ kubectl logs å‘½ä»¤åªèƒ½æŸ¥çœ‹å­˜åœ¨çš„ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ï¼Œä¸èƒ½æŸ¥çœ‹å·²åˆ é™¤çš„Pod èµ„æºå¯¹è±¡æ—¥å¿—ã€‚</li>\n</ul>\n</li>\n<li><p>Kubernetes çš„ <code>API</code> èµ„æºæ¦‚è¿°ï¼š  </p>\n<ul>\n<li>API Server æä¾›åŸºäº <code>RESTful</code> é£æ ¼æ¶æ„çš„ç¼–ç¨‹æ¥å£ï¼Œæ¥æ”¶åŸºäº <code>HTTP/HTTPS</code> çš„å®¢æˆ·ç«¯ç»„ä»¶è¯·æ±‚ï¼Œå¹¶å°†å…¶å¤„ç†è¿”å›ã€‚  </li>\n<li>Kubernetes çš„å…¶ä»–ç»„ä»¶è¢«æŠ½è±¡ä¸ºæ ‡å‡†çš„ REST èµ„æºï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ <code>JSON</code> åºåˆ—åŒ–æ•°æ®å¯¹ å…¶ç®¡ç†ä¸æ§åˆ¶ã€‚  </li>\n<li>API èµ„æºç±»å‹åŒ…æ‹¬ï¼š    <ul>\n<li>å¯¹è±¡ç±»ï¼ˆObjectï¼‰    </li>\n<li>åˆ—è¡¨ç±»ï¼ˆListï¼‰    </li>\n<li>ç®€å•ç±»ï¼ˆSimpleï¼‰  </li>\n</ul>\n</li>\n<li>Kubernetes ä¸­çš„ API èµ„æºç±»å‹ç»å¤§å¤šæ•°ä»¥å¯¹è±¡çš„æ–¹å¼å­˜åœ¨ï¼Œå¯¹è±¡æ˜¯èµ„æºè¿è¡Œæ—¶ç”Ÿæˆçš„å®ä¾‹ï¼Œä¸”ä¸ºæŒä¹…åŒ–çš„å®ä½“ã€‚  </li>\n<li>API å¯¹åº”äºèµ„æºç±»å‹çš„ <code>URI</code>ï¼Œå³èµ„æºç±»å‹çš„ <code>YAML</code> é…ç½®æ–‡ä»¶ä¸­çš„ <code>selfLink</code> å­—æ®µï¼Œå…¶çŠ¶æ€å­˜å‚¨äºåç«¯ etcd æ•°æ®åº“ä¸­ã€‚  <blockquote>\n<p>ğŸ’¥ Kubernetes v1.20 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤åˆ é™¤äº† <code>metadata.selfLink</code> å­—æ®µï¼Œç„¶è€Œï¼Œéƒ¨åˆ†åº”ç”¨ä»ç„¶ä¾èµ–äºè¯¥å­—æ®µï¼Œå¦‚ <code>nfs-client-provisioner</code>ã€‚å¦‚æœä»ç„¶è¦ç»§ç»­ä½¿ç”¨è¿™äº›åº”ç”¨ï¼Œéœ€è¦é‡æ–°å¯ç”¨è¯¥å­—æ®µã€‚  </p>\n</blockquote>\n</li>\n<li>ğŸš€ è‹¥é›†ç¾¤ä½¿ç”¨ <code>kubeadm</code> ç»„ä»¶éƒ¨ç½²ï¼Œå¯ä¿®æ”¹æ§åˆ¶å¹³é¢ï¼ˆcontrol planï¼‰å„èŠ‚ç‚¹çš„ <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æ·»åŠ  <code>--feature-gates=RemoveSelfLink=false</code> é€‰é¡¹ä»¥å¯ç”¨è¯¥å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"kubernetes-apiserver-manifest.jpg\" alt=\"kubernetes-apiserver-manifest.jpg\">    <ul>\n<li>å…³äº selfLink çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://kuboard.cn/install/faq/selfLink.html\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>    </li>\n<li>å…³äº kube-apiserver å‘½ä»¤çš„é€‰é¡¹å¯å‚è€ƒ <a href=\"https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/\" target=\"_blank\" rel=\"noopener\">kube-apiserver å®˜æ–¹æ–‡æ¡£</a>  </li>\n</ul>\n</li>\n<li>Kubernetes å°† API è¿›è¡Œé€»è¾‘åˆ†ç»„ï¼Œç§°ä¸º API ç¾¤ç»„ï¼ˆAPI groupï¼‰ã€‚  </li>\n<li>ğŸš€ Kubernetes çš„ API Server æ”¯æŒç›¸åŒçš„ API ç¾¤ç»„ä¸­ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼Œå› æ­¤èƒ½åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ï¼Œä»è€Œåœ¨ç¨³å®šç‰ˆæœ¬ä¸æ–°çš„å®éªŒç‰ˆæœ¬ä¸­èƒ½ä»¥ä¸åŒçš„ç‰¹æ€§ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ã€‚  <blockquote>\n<p>å…³äº API ç¾¤ç»„çš„åˆ†ç±»ä¸è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ <a href=\"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>  </p>\n</blockquote>\n</li>\n<li><p>Kubernetes çš„ API å±‚çº§ç»“æ„ï¼š    </p>\n<ul>\n<li>æ ¸å¿ƒ API ç¾¤ç»„ï¼ˆcore groupï¼‰ï¼š      <ul>\n<li>REST è·¯å¾„ï¼š<code>/api/v1</code>      </li>\n<li>èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š<code>apiVersion: v1</code>    </li>\n</ul>\n</li>\n<li>å‘½åçš„ API ç¾¤ç»„ï¼ˆnamed groupï¼‰ï¼š      <ul>\n<li>REST è·¯å¾„ï¼š<code>/apis/&lt;group_name&gt;/&lt;version&gt;</code>      </li>\n<li>èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š<code>apiVersion: &lt;group_name&gt;/&lt;version&gt;</code>    </li>\n</ul>\n</li>\n<li>å‘½åç©ºé—´çº§åˆ«çš„ REST APIï¼š      <ul>\n<li>REST è·¯å¾„ï¼š<br><code>/apis/&lt;group_name&gt;/&lt;version&gt;/namespaces/&lt;namespace&gt;/&lt;resource_kind&gt;/&lt;object_name&gt;</code>      </li>\n<li>ç¤ºä¾‹ï¼š<br><code>/apis/apps/v1/namespaces/default/deployments/nginx-deploy</code>    </li>\n</ul>\n</li>\n<li><p>è®¿é—® Kubernetes RESTful API çš„æ–¹æ³•ï¼š      </p>\n<ul>\n<li>kubectl get å‘½ä»¤è¡Œæ–¹å¼ï¼š<br><img src=\"kubectl-get-raw-json.jpg\" alt=\"kubectl-get-raw-json.jpg\">      </li>\n<li><p>kubectl proxy å‘½ä»¤è¡Œæ–¹å¼ï¼š        </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl proxy --port=&lt;port&gt;</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³ï¼Œä½¿å…¶èƒ½å¤Ÿè®¿é—® API Server çš„ REST APIï¼Œè¯¥ç«¯å£ä¸å¯è¢«å ç”¨ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>kubectl proxy æ–¹å¼ä½¿ç”¨ kubectl æ‰“å¼€æœ¬åœ° <code>unix socket</code>ï¼Œä½¿ curl å‘½ä»¤é€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„æ–¹å¼ä¸ä»£ç†ç½‘å…³é€šä¿¡ï¼Œå®ç°ä¸ API Server çš„äº¤äº’ã€‚        </p>\n</li>\n<li>Kubernetes é›†ç¾¤é»˜è®¤ä½¿ç”¨ <code>HTTPS</code> çš„æ–¹å¼è®¿é—® API Server çš„ REST APIã€‚        </li>\n<li>ä½¿ç”¨ kubectl proxy å‘½ä»¤å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³åï¼Œåœ¨å¦ä¸€ç»ˆç«¯ä¸­å³å¯ä½¿ç”¨ curl å‘½ä»¤ä»¥ HTTP çš„æ–¹å¼è®¿é—®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š          <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -s http://localhost:8080/api/v1/namespaces/default</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>Kubernetes çš„ API èµ„æºåˆ†ç±»ï¼š  </p>\n<ul>\n<li>å·¥ä½œè´Ÿè½½ç±»å‹ï¼ˆworkloadï¼‰ï¼š    <ul>\n<li>ReplicationControllerï¼ˆrcï¼‰    </li>\n<li>ReplicaSet    </li>\n<li>Deployment    </li>\n<li><code>StatefulSet</code>    </li>\n<li>DaemonSet    </li>\n<li>Job  </li>\n</ul>\n</li>\n<li>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼ˆDiscovery &amp; LBï¼‰ï¼š    <ul>\n<li>Service    </li>\n<li><code>Ingress</code>  </li>\n</ul>\n</li>\n<li>é…ç½®ä¸å­˜å‚¨ï¼ˆConfig &amp; Storageï¼‰ï¼š    <ul>\n<li>Secret    </li>\n<li><code>ConfigMap</code>    </li>\n<li>PersistentVolumeClaimï¼ˆpvcï¼‰  </li>\n</ul>\n</li>\n<li>é›†ç¾¤ï¼ˆClusterï¼‰ï¼š    <ul>\n<li>Namespace    </li>\n<li>Node    </li>\n<li>Roleã€ClusterRoleã€ClusterRoleBindingã€RoleBinding    </li>\n<li>PersistentVolumeï¼ˆpvï¼‰  </li>\n</ul>\n</li>\n<li>å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼š    <ul>\n<li><code>HorizontalPodAutoscaler</code>ï¼ˆHPAï¼‰    </li>\n<li>LimitRange</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Kubernetes èµ„æºé…ç½®æ¸…å•åŸºç¡€ï¼š  <ul>\n<li>Kubernetes èµ„æºé…ç½®æ¸…å•çš„ä¸»è¦ä¸€çº§å­—æ®µï¼š<br>apiVersionã€kindã€metadataã€specã€status  </li>\n<li>å…¶ä¸­ metadataã€spec ä¸ status ä¸ºåµŒå¥—å­—æ®µï¼š    <ul>\n<li><code>metadata</code>ï¼šè®°å½•èµ„æºçš„å…ƒæ•°æ®æ•°æ®    </li>\n<li><code>spec</code>ï¼šè®°å½•èµ„æºçš„ç”¨æˆ·æœŸæœ›çŠ¶æ€ï¼ˆdesiredï¼‰ä¿¡æ¯ï¼Œç”±ç”¨æˆ·è‡ªå®šä¹‰å¹¶ç»´æŠ¤ã€‚    </li>\n<li><code>status</code>ï¼š      <ul>\n<li>è®°å½•æ´»åŠ¨å¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼ˆå®é™…çŠ¶æ€ï¼‰ï¼Œç”± Kubernetes è‡ªåŠ¨å¡«å……å¹¶ç»´æŠ¤ï¼Œå¯¹ç”¨æˆ·ä¸ºåªè¯»å­—æ®µã€‚      <blockquote>\n<p>ğŸ‘‰ æ´»åŠ¨å¯¹è±¡æ˜¯æŒ‡ç”± Kubernetes åˆ›å»ºçš„èµ„æºå¯¹è±¡ã€‚      </p>\n</blockquote>\n</li>\n<li>è¯¥å­—æ®µè®°å½•çš„æ´»åŠ¨å¯¹è±¡çš„çŠ¶æ€åº”ä¸ spec å­—æ®µçš„çŠ¶æ€ç›¸åŒï¼Œæˆ–è€…ä¸¤è€…æ— é™æ¥è¿‘ã€‚    </li>\n</ul>\n</li>\n<li>ğŸ’¥ Kubernetes çš„ API Server åªèƒ½æ¥æ”¶å¹¶å“åº” <code>JSON</code> å¯¹è±¡ï¼ŒYAML æ ¼å¼çš„å¯¹è±¡éœ€ç»è¿‡ API Server è½¬æ¢åæ‰èƒ½è¢«æ¥æ”¶å¤„ç†ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Kubernetes èµ„æºç®¡ç†æ–¹å¼ï¼š  <ul>\n<li>Kubernetes çš„ API Server æ”¯æŒå£°æ˜å¼ç¼–ç¨‹ï¼ˆ<code>delarative programming</code>ï¼‰ä¸é™ˆè¿°å¼ç¼–ç¨‹ï¼ˆ<code>impreative programming</code>ï¼‰ã€‚  </li>\n<li>æ¨èä¼˜å…ˆä½¿ç”¨ <code>apply</code> æˆ– <code>patch</code> å‘½ä»¤çš„å£°æ˜å¼å¯¹è±¡é…ç½®ã€‚  </li>\n<li>å¯å°†ä¸åŒèµ„æºç±»å‹çš„å¯¹è±¡é…ç½®ä¿¡æ¯å†™åœ¨åŒä¸€ä¸ªèµ„æºé…ç½®æ¸…å•ä¸­ï¼Œå¹¶ä½¿ç”¨ <code>---</code> ç¬¦å·å°†æ¯ä¸ªèµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è¿›è¡Œèµ„æºåˆ†å‰²ã€‚  </li>\n<li>ä½¿ç”¨ <code>Git</code> ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç®¡ç†èµ„æºé…ç½®æ¸…å•æ–‡ä»¶ã€‚</li>\n</ul>\n</li>\n<li>å‘½åç©ºé—´çš„èµ„æºç®¡ç†ï¼š  <ul>\n<li>å‘½åç©ºé—´ï¼ˆnamespaceï¼‰é€šè¿‡å°†ä¸åŒèµ„æºè¿›è¡Œéš”ç¦»ï¼Œä½¿å‘½åç©ºé—´çš„èµ„æºè¢«ä¸åŒçš„ç”¨æˆ·ã€ç§Ÿæˆ·ä¸é¡¹ç›®ä½¿ç”¨ã€‚  </li>\n<li>å‘½åç©ºé—´åªéš”ç¦»ä¸åŒçš„èµ„æºï¼Œä¸éš”ç¦»è·¨å‘½åç©ºé—´çš„ Pod é—´çš„é€šä¿¡ï¼Œå› æ­¤å•çº¯ä½¿ç”¨å‘½åç©ºé—´çš„éš”ç¦»æœºåˆ¶ä¸ºè½¯éš”ç¦»ï¼Œè€Œå¯¹ç½‘ç»œæµé‡çš„éš”ç¦»éœ€è¦ç”±ç½‘ç»œç­–ç•¥ï¼ˆ<code>network policy</code>ï¼‰æ¥å®ç°ã€‚  <blockquote>\n<p>âœ… ä¸åŒçš„ CNI æ’ä»¶å¯æä¾›ä¸åŒçš„ç½‘ç»œç­–ç•¥åŠŸèƒ½ï¼Œå¦‚ Calicoã€OVS plugin ç­‰ã€‚  </p>\n</blockquote>\n</li>\n<li>åˆ›å»ºè‡ªå®šä¹‰çš„å‘½åç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create namespace &lt;namespace_name&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\"><a href=\"#èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\" class=\"headerlink\" title=\"èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\"></a>èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š</h3><ul>\n<li><p>API ç‰ˆæœ¬ä¸èµ„æºå¯¹è±¡è§£é‡Šå‘½ä»¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl --<span class=\"built_in\">help</span></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ kubectl å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl api-versions</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ API Server æ”¯æŒçš„ API ç‰ˆæœ¬ï¼Œå¹¶ä»¥ group/version çš„æ ¼å¼è¿”å›ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl api-resources</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ API Server æ”¯æŒçš„ API èµ„æºç±»å‹</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl explain &lt;resource_type&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ API èµ„æºç±»å‹çš„è§£é‡Šä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl explain pods.spec.containers.imagePullPolicy</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ Pod èµ„æºå¯¹è±¡ç›¸å…³é…ç½®å­—æ®µçš„è¯¦ç»†ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»º <code>Deployment</code> èµ„æºå¯¹è±¡å¹¶è¿è¡Œ Podï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl run &lt;deployment_name&gt; \\</span><br><span class=\"line\">  --image=&lt;image_name&gt;:&lt;tag&gt; --replicas=&lt;number&gt; --port=&lt;port&gt; \\</span><br><span class=\"line\">  -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># é™ˆè¿°å¼å‘½ä»¤åˆ›å»º Deployment èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ç›´æ¥åˆ›å»º Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ Pod æ§åˆ¶å™¨åˆ›å»ºå¹¶ç®¡ç† Pod å¯¹è±¡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl run å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl run --help</span></span><br><span class=\"line\"><span class=\"comment\">#   --image=''                   Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é•œåƒçš„åç§°</span></span><br><span class=\"line\"><span class=\"comment\">#   --port=''                    Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨çš„ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"comment\">#   --replicas=''                Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°</span></span><br><span class=\"line\"><span class=\"comment\">#   --record=[false|true]        å°†å½“å‰çš„ kubectl å‘½ä»¤è®°å½•äºèµ„æºå¯¹è±¡çš„</span></span><br><span class=\"line\"><span class=\"comment\">#                                annotation æ³¨é‡Šä¸­</span></span><br><span class=\"line\"><span class=\"comment\">#   --save-config=[false|true]   å°†å½“å‰çš„èµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è®°å½•äº annotation</span></span><br><span class=\"line\"><span class=\"comment\">#                                æ³¨é‡Šä¸­ï¼Œé»˜è®¤ä¸º falseï¼Œåœ¨ä½¿ç”¨ kubectl apply</span></span><br><span class=\"line\"><span class=\"comment\">#                                æ—¶æœ‰ç”¨ã€‚          </span></span><br><span class=\"line\"><span class=\"comment\">#  --restart=[Always|OnFailure|Never]</span></span><br><span class=\"line\"><span class=\"comment\">#                                Pod èµ„æºå¯¹è±¡çš„é‡å¯ç­–ç•¥ï¼Œé»˜è®¤ä¸º Alwaysã€‚            </span></span><br><span class=\"line\"><span class=\"comment\">#  --dry-run=[false|true]        æµ‹è¯•è¿è¡Œï¼ˆå¹²è¿è¡Œï¼‰ï¼Œé»˜è®¤ä¸º falseã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#  -nï¼Œ--namespace=''            èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl run nginx-deploy \\</span><br><span class=\"line\">  --image=nginx:v1.12 --replicas=2 --port=80 -n default</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Deployment èµ„æºå¯¹è±¡ nginx-deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl run client \\</span><br><span class=\"line\">  --image=busybox:latest --restart=Never --replicas=1 \\</span><br><span class=\"line\">  -it -n default -- /bin/sh</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š --restart=Never é€‰é¡¹æ—¶ï¼Œåªåˆ›å»º Pod èµ„æºå¯¹è±¡ client å¹¶è¿›å…¥ Pod äº¤äº’å¼ç•Œé¢ã€‚             </span></span><br><span class=\"line\"><span class=\"comment\"># é€€å‡ºäº¤äº’å¼ç•Œé¢åï¼Œç»ˆæ­¢ Pod èµ„æºå¯¹è±¡è¿è¡Œï¼Œå¹¶è¿›å…¥ Completed çŠ¶æ€ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»º Service èµ„æºå¯¹è±¡ä¸æš´éœ²åº”ç”¨ç«¯å£ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl expose deployment &lt;deployment_name&gt; \\</span><br><span class=\"line\">  --name=&lt;service_name&gt; --port=&lt;port&gt; --target-port=&lt;port_num&gt; \\</span><br><span class=\"line\">  -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Service èµ„æºå¯¹è±¡ï¼Œå¯¹å¤–æš´éœ²å¹¶å…³è” Pod èµ„æºå¯¹è±¡çš„ Pod IP ä¸ç«¯å£ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl expose å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl expose --help</span></span><br><span class=\"line\"><span class=\"comment\">#   --name=''                åˆ›å»ºçš„ Service èµ„æºå¯¹è±¡åç§°</span></span><br><span class=\"line\"><span class=\"comment\">#   --port=''                Service èµ„æºå¯¹è±¡çš„ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"comment\">#   --target-port=''         Service èµ„æºå¯¹è±¡å…³è”çš„åç«¯ Pod èµ„æºå¯¹è±¡çš„ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"comment\">#   -nï¼Œ--namespace=''       èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl expose deployment nginx-deploy \\</span><br><span class=\"line\">  --name=nginx-svc --port=8080 --target-port=80 -n default</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºåç§°ä¸º nginx-svc çš„ Service èµ„æºå¯¹è±¡</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æŸ¥çœ‹ä¸æ“ä½œç›¸å…³èµ„æºå¯¹è±¡ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pods,services -n &lt;namespace&gt; -o wide</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod ä¸ Service èµ„æºå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆé€—å·åˆ†éš”ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get &lt;resource_type&gt; \\</span><br><span class=\"line\">  -n &lt;namespace&gt; -o &#123;yaml|json|jsonpath|wide|custom-columns=...&#125;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å‘½åç©ºé—´ä¸­çš„èµ„æºå¯¹è±¡ä¿¡æ¯ï¼Œå¹¶ä»¥ YAMLã€JSONã€å®Œæ•´æ ¼å¼æˆ–è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl get pods \\</span><br><span class=\"line\">  -o custom-columns=NAME:metadata.name,STATUS:status.phase </span><br><span class=\"line\">  -n kube-system</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ kube-system å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡çš„åç§°ä¸çŠ¶æ€ä¿¡æ¯ï¼Œä»¥è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl logs &lt;pod_name&gt; [-c &lt;container_name&gt;] -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"comment\"># Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl <span class=\"built_in\">exec</span> &lt;pod_name&gt; \\</span><br><span class=\"line\">  [-c &lt;container_name&gt;] -n &lt;namespace&gt; -- &lt;<span class=\"built_in\">command</span>&gt; &lt;opts&gt; &lt;args...&gt;</span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œå‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å‘½ä»¤</span></span><br><span class=\"line\"><span class=\"comment\"># Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl delete \\</span><br><span class=\"line\">  &lt;resource_type&gt; &lt;resource_name&gt; -l &lt;key&gt;=&lt;value&gt; -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤å‘½åç©ºé—´ä¸­å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl delete deployment myapp --cascade=<span class=\"literal\">false</span> -n default</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤ default å‘½åç©ºé—´ä¸­åä¸º myapp çš„ Deployment èµ„æºå¯¹è±¡ï¼Œä½†ä¸åˆ é™¤å…¶åˆ›å»ºçš„ Podã€‚    </span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl create -f &lt;file&gt;.yaml|&lt;dir&gt;|&lt;url&gt;</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨é™ˆè¿°å¼å‘½ä»¤ create åˆ›å»ºä¸åŒçš„ API èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl apply -f &lt;file&gt;.yaml|&lt;dir&gt;|&lt;url&gt; </span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å£°æ˜å¼å‘½ä»¤ apply åˆ›å»ºã€æ›´æ–°ä¸æ›¿æ¢ä¸åŒçš„ API èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. å£°æ˜å¼å¯¹è±¡é…ç½®ç®¡ç†å…·æœ‰é«˜çº§çš„è¡¥ä¸æ›´æ–°æœºåˆ¶ï¼Œå°†ç›¸åº”çš„é…ç½®ä¿¡æ¯è®°å½•äº annotation æ³¨é‡Šä¸­ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#   2. Kubernetes å»ºè®®ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½®æ–¹å¼ï¼ </span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl delete -f &lt;file&gt;.yaml</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤è¯¥ YAML é…ç½®æ–‡ä»¶åˆ›å»ºçš„ API èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl scale deployment &lt;deployment_name&gt; --replicas=&lt;number&gt; -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šå‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl scale deployment myapp --replicas=3 -n default</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š default å‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®ä¸º 3 ä¸ª</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡å‰¯æœ¬æ•°ç›®çš„æ–¹æ³•ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. é€šè¿‡è¯¥å‘½ä»¤è¡Œæ–¹å¼è¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹</span></span><br><span class=\"line\"><span class=\"comment\">#   2. ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ›´æ”¹ Deployment èµ„æºå¯¹è±¡çš„é…ç½®ä¿¡æ¯ï¼Œæ›´æ”¹åå®æ—¶ç”Ÿæ•ˆï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#      $ kubectl edit deployment myapp -n default</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>è¯¥æ–‡æ¡£ä½¿ç”¨çš„ Kubernetes ç‰ˆæœ¬ä¸º <code>1.12.x</code></li>\n<li>æ–‡æ¡£æ‰€ç¤ºçš„å‘½ä»¤å¯èƒ½ä¸å½“å‰ Kubernetes ç‰ˆæœ¬å­˜åœ¨å·®å¼‚ï¼Œè¯·ä»¥å®é™…ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºåŸºå‡†ï¼</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆ</li>\n<li>Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†</li>\n<li>èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤</li>\n</ul>\n<h3 id=\"Kubernetes-é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\"><a href=\"#Kubernetes-é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\" class=\"headerlink\" title=\"Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š\"></a>Kubernetes é›†ç¾¤æ¶æ„æ¦‚è§ˆï¼š</h3><ul>\n<li><code>API Server</code> ä½œä¸º Kubernetes é›†ç¾¤çš„ç½‘å…³ï¼ˆgatewayï¼‰</li>\n<li><code>etcd</code> é”®å€¼å‹æ•°æ®åº“ä½œä¸º Kubernetes é›†ç¾¤çš„æ ¸å¿ƒæ•°æ®åº“</li>\n<li>Kubernetes é›†ç¾¤å¯éƒ¨ç½²ä¸ºå• master é›†ç¾¤æˆ–å¤š masterï¼ˆå¸¸è§ä¸º 3 ä¸ªï¼‰çš„ HA é›†ç¾¤  <ul>\n<li>å• master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š<br><img src=\"kubernetes-single-master-arch.jpg\" alt=\"kubernetes-single-master-arch.jpg\">  </li>\n<li>å¤š master èŠ‚ç‚¹çš„ Kubernetes é›†ç¾¤æ¶æ„ç¤ºæ„ï¼š<br><img src=\"kubernetes-ha-arch-demo.jpg\" alt=\"kubernetes-ha-arch-demo.jpg\">  <blockquote>\n<p>ğŸ‘‰ è¯¥ç¤ºä¾‹ä¸­å°† etcd é›†ç¾¤åˆ†åˆ«éƒ¨ç½²äº 3 ä¸ª master èŠ‚ç‚¹ä¸Šã€‚</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>Kubernetes ä¸­çš„æ¥å£è§„èŒƒï¼š  <ul>\n<li><code>CRI</code>ï¼šContainer Runtime Interfaceï¼ˆå®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼‰  </li>\n<li><code>gRPC</code>ï¼šGoogle Remote Process Callï¼ˆGoogle å‘å¸ƒçš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨æ¡†æ¶ï¼‰  </li>\n<li><code>OCI</code>ï¼šOpen Container Initiativeï¼ˆå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰  </li>\n<li><code>CNI</code>ï¼šContainer Network Interfaceï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰  </li>\n<li><code>CSI</code>ï¼šContainer Storage Interfaceï¼ˆå®¹å™¨å­˜å‚¨æ¥å£ï¼‰  </li>\n<li>ä»¥ä¸Šå„æ¥å£è§„èŒƒåœ¨é›†ç¾¤ä¸­ç»„ä»¶ä¹‹é—´çš„è°ƒç”¨ç¤ºæ„ï¼š<br><img src=\"kubernetes-interface-1.jpg\" alt=\"kubernetes-interface-1.jpg\"><img src=\"kubernetes-interface-2.jpg\" alt=\"kubernetes-interface-2.jpg\"></li>\n</ul>\n</li>\n<li>Kubernetes é›†ç¾¤ä¸­çš„ç½‘ç»œæ¦‚è¿°ï¼š  <ul>\n<li>é›†ç¾¤ä¸­çš„é€šä¿¡ç§ç±»ï¼š    <ul>\n<li>åŒä¸€ Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é—´çš„é€šä¿¡    </li>\n<li>å„ Pod èµ„æºå¯¹è±¡å½¼æ­¤é—´çš„é€šä¿¡    <blockquote>\n<p>ğŸ‘‰ Pod é—´åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šé€šä¿¡æˆ–å½¼æ­¤è·¨èŠ‚ç‚¹é—´é€šä¿¡    </p>\n</blockquote>\n</li>\n<li>Pod èµ„æºå¯¹è±¡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡    </li>\n<li>é›†ç¾¤å¤–éƒ¨çš„æµé‡ä¸ Service èµ„æºå¯¹è±¡é—´çš„é€šä¿¡  </li>\n</ul>\n</li>\n<li>é›†ç¾¤ç½‘ç»œè§„åˆ’éƒ¨ç½²ï¼š    <ul>\n<li>Kubernetes é›†ç¾¤ä¸»æœºé—´çš„ç½‘ç»œ    </li>\n<li>Service èµ„æºå¯¹è±¡å®šä¹‰çš„ <code>ClusterIP</code> ç½‘ç»œ    </li>\n<li>ç”±ä¸åŒ <code>CNI</code> å®šä¹‰çš„ Pod é—´çš„é€šä¿¡ç½‘ç»œ</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Kubernetes é›†ç¾¤çš„å®¢æˆ·ç«¯ç±»å‹ï¼š  <ul>\n<li>Kubernetes çš„ API Server çš„å®¢æˆ·ç«¯ï¼š<br>é›†ç¾¤åŠé¡¹ç›®ç®¡ç†äººå‘˜ã€å¼€å‘äººå‘˜ã€é›†ç¾¤ä¸­ä¸ API Server äº¤äº’çš„ç»„ä»¶  </li>\n<li>Kubernetes çš„è®¿é—® Pod çš„å®¢æˆ·ç«¯ï¼š<br>é›†ç¾¤å¤–çš„æ™®é€šç”¨æˆ·ã€å‘½åç©ºé—´å†…çš„ Pod åº”ç”¨ï¼ˆPod Clientï¼‰</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Kubernetes-é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\"><a href=\"#Kubernetes-é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\" class=\"headerlink\" title=\"Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š\"></a>Kubernetes é›†ç¾¤çš„èµ„æºå¯¹è±¡ç®¡ç†ï¼š</h3><ul>\n<li>kubectl å‘½ä»¤ç®¡ç†èµ„æºå¯¹è±¡çš„ 3 ç§æ–¹å¼ï¼š  <ul>\n<li>é™ˆè¿°å¼å‘½ä»¤ï¼šä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ç®¡ç†  </li>\n<li>é™ˆè¿°å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ <code>kubectl create</code> å‘½ä»¤åˆ›å»º  </li>\n<li>å£°æ˜å¼èµ„æºé…ç½®æ–‡ä»¶ï¼šä½¿ç”¨ <code>kubectl apply</code> å‘½ä»¤åˆ›å»º</li>\n</ul>\n</li>\n<li>Kubernetes ä½¿ç”¨ <code>Deployment</code> èµ„æºå¯¹è±¡ï¼ˆPod æ§åˆ¶å™¨ï¼‰éƒ¨ç½²ä¸ç®¡ç†å‰ç«¯æ— çŠ¶æ€ï¼ˆ<code>Stateless</code>ï¼‰çš„ Pod èµ„æºå¯¹è±¡ï¼Œè€Œ Deployment èµ„æºå¯¹è±¡å¹¶ä¸ç›´æ¥ä½œç”¨äº Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨ <code>ReplicaSet</code> èµ„æºå¯¹è±¡è¿›è¡Œéƒ¨ç½²ä¸ç®¡ç†ã€‚</li>\n<li>Deployment èµ„æºå¯¹è±¡æ˜¯ ReplicaSet èµ„æºå¯¹è±¡ä¹‹ä¸Šçš„ Pod æ§åˆ¶å™¨ï¼Œä¸¤è€…éƒ½ä¸ºå·¥ä½œè´Ÿè½½å‹ï¼ˆworkloadï¼‰èµ„æºå¯¹è±¡ã€‚</li>\n<li>ä½¿ç”¨ Deployment èµ„æºå¯¹è±¡éƒ¨ç½²çš„ Pod èµ„æºå¯¹è±¡éƒ½å…·æœ‰ <code>run=&lt;pod_controller_name&gt;</code> çš„æ ‡ç­¾ï¼ˆlabelï¼‰ã€‚</li>\n<li>Pod èµ„æºå¯¹è±¡çš„åç§°ï¼š<code>&lt;replicaset_name&gt;-&lt;random_char&gt;</code><br><img src=\"pod-name.jpg\" alt=\"pod-name.jpg\"></li>\n<li>Podèµ„æºå¯¹è±¡çš„çŠ¶æ€ï¼š<br>Pendingã€Runningã€Succeededã€Failedã€Unknown</li>\n<li>Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯ç®¡ç†ï¼š  <ul>\n<li>ğŸ³ Kubernetes é›†ç¾¤ä¸­ Pod å®¹å™¨æ—¥å¿—ä¿¡æ¯é»˜è®¤ä»¥æ ‡å‡†é”™è¯¯ï¼ˆ<code>standard error</code>ï¼‰è¾“å‡ºè‡³æ§åˆ¶å°ï¼Œå¯ä½¿ç”¨ kubectl logs å‘½ä»¤æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä¿¡æ¯ã€‚  </li>\n<li>å¿…é¡»ä½¿ç”¨é›†ä¸­å¼çš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿç®¡ç† Pod å®¹å™¨æ—¥å¿—ã€‚  </li>\n<li>ä½¿ç”¨ kubectl logs å‘½ä»¤åªèƒ½æŸ¥çœ‹å­˜åœ¨çš„ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ï¼Œä¸èƒ½æŸ¥çœ‹å·²åˆ é™¤çš„Pod èµ„æºå¯¹è±¡æ—¥å¿—ã€‚</li>\n</ul>\n</li>\n<li><p>Kubernetes çš„ <code>API</code> èµ„æºæ¦‚è¿°ï¼š  </p>\n<ul>\n<li>API Server æä¾›åŸºäº <code>RESTful</code> é£æ ¼æ¶æ„çš„ç¼–ç¨‹æ¥å£ï¼Œæ¥æ”¶åŸºäº <code>HTTP/HTTPS</code> çš„å®¢æˆ·ç«¯ç»„ä»¶è¯·æ±‚ï¼Œå¹¶å°†å…¶å¤„ç†è¿”å›ã€‚  </li>\n<li>Kubernetes çš„å…¶ä»–ç»„ä»¶è¢«æŠ½è±¡ä¸ºæ ‡å‡†çš„ REST èµ„æºï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ <code>JSON</code> åºåˆ—åŒ–æ•°æ®å¯¹ å…¶ç®¡ç†ä¸æ§åˆ¶ã€‚  </li>\n<li>API èµ„æºç±»å‹åŒ…æ‹¬ï¼š    <ul>\n<li>å¯¹è±¡ç±»ï¼ˆObjectï¼‰    </li>\n<li>åˆ—è¡¨ç±»ï¼ˆListï¼‰    </li>\n<li>ç®€å•ç±»ï¼ˆSimpleï¼‰  </li>\n</ul>\n</li>\n<li>Kubernetes ä¸­çš„ API èµ„æºç±»å‹ç»å¤§å¤šæ•°ä»¥å¯¹è±¡çš„æ–¹å¼å­˜åœ¨ï¼Œå¯¹è±¡æ˜¯èµ„æºè¿è¡Œæ—¶ç”Ÿæˆçš„å®ä¾‹ï¼Œä¸”ä¸ºæŒä¹…åŒ–çš„å®ä½“ã€‚  </li>\n<li>API å¯¹åº”äºèµ„æºç±»å‹çš„ <code>URI</code>ï¼Œå³èµ„æºç±»å‹çš„ <code>YAML</code> é…ç½®æ–‡ä»¶ä¸­çš„ <code>selfLink</code> å­—æ®µï¼Œå…¶çŠ¶æ€å­˜å‚¨äºåç«¯ etcd æ•°æ®åº“ä¸­ã€‚  <blockquote>\n<p>ğŸ’¥ Kubernetes v1.20 ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤åˆ é™¤äº† <code>metadata.selfLink</code> å­—æ®µï¼Œç„¶è€Œï¼Œéƒ¨åˆ†åº”ç”¨ä»ç„¶ä¾èµ–äºè¯¥å­—æ®µï¼Œå¦‚ <code>nfs-client-provisioner</code>ã€‚å¦‚æœä»ç„¶è¦ç»§ç»­ä½¿ç”¨è¿™äº›åº”ç”¨ï¼Œéœ€è¦é‡æ–°å¯ç”¨è¯¥å­—æ®µã€‚  </p>\n</blockquote>\n</li>\n<li>ğŸš€ è‹¥é›†ç¾¤ä½¿ç”¨ <code>kubeadm</code> ç»„ä»¶éƒ¨ç½²ï¼Œå¯ä¿®æ”¹æ§åˆ¶å¹³é¢ï¼ˆcontrol planï¼‰å„èŠ‚ç‚¹çš„ <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­æ·»åŠ  <code>--feature-gates=RemoveSelfLink=false</code> é€‰é¡¹ä»¥å¯ç”¨è¯¥å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"kubernetes-apiserver-manifest.jpg\" alt=\"kubernetes-apiserver-manifest.jpg\">    <ul>\n<li>å…³äº selfLink çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://kuboard.cn/install/faq/selfLink.html\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>    </li>\n<li>å…³äº kube-apiserver å‘½ä»¤çš„é€‰é¡¹å¯å‚è€ƒ <a href=\"https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/\" target=\"_blank\" rel=\"noopener\">kube-apiserver å®˜æ–¹æ–‡æ¡£</a>  </li>\n</ul>\n</li>\n<li>Kubernetes å°† API è¿›è¡Œé€»è¾‘åˆ†ç»„ï¼Œç§°ä¸º API ç¾¤ç»„ï¼ˆAPI groupï¼‰ã€‚  </li>\n<li>ğŸš€ Kubernetes çš„ API Server æ”¯æŒç›¸åŒçš„ API ç¾¤ç»„ä¸­ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬ï¼Œå› æ­¤èƒ½åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ï¼Œä»è€Œåœ¨ç¨³å®šç‰ˆæœ¬ä¸æ–°çš„å®éªŒç‰ˆæœ¬ä¸­èƒ½ä»¥ä¸åŒçš„ç‰¹æ€§ä½¿ç”¨åŒåçš„èµ„æºç±»å‹ã€‚  <blockquote>\n<p>å…³äº API ç¾¤ç»„çš„åˆ†ç±»ä¸è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ <a href=\"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>  </p>\n</blockquote>\n</li>\n<li><p>Kubernetes çš„ API å±‚çº§ç»“æ„ï¼š    </p>\n<ul>\n<li>æ ¸å¿ƒ API ç¾¤ç»„ï¼ˆcore groupï¼‰ï¼š      <ul>\n<li>REST è·¯å¾„ï¼š<code>/api/v1</code>      </li>\n<li>èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š<code>apiVersion: v1</code>    </li>\n</ul>\n</li>\n<li>å‘½åçš„ API ç¾¤ç»„ï¼ˆnamed groupï¼‰ï¼š      <ul>\n<li>REST è·¯å¾„ï¼š<code>/apis/&lt;group_name&gt;/&lt;version&gt;</code>      </li>\n<li>èµ„æºé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼š<code>apiVersion: &lt;group_name&gt;/&lt;version&gt;</code>    </li>\n</ul>\n</li>\n<li>å‘½åç©ºé—´çº§åˆ«çš„ REST APIï¼š      <ul>\n<li>REST è·¯å¾„ï¼š<br><code>/apis/&lt;group_name&gt;/&lt;version&gt;/namespaces/&lt;namespace&gt;/&lt;resource_kind&gt;/&lt;object_name&gt;</code>      </li>\n<li>ç¤ºä¾‹ï¼š<br><code>/apis/apps/v1/namespaces/default/deployments/nginx-deploy</code>    </li>\n</ul>\n</li>\n<li><p>è®¿é—® Kubernetes RESTful API çš„æ–¹æ³•ï¼š      </p>\n<ul>\n<li>kubectl get å‘½ä»¤è¡Œæ–¹å¼ï¼š<br><img src=\"kubectl-get-raw-json.jpg\" alt=\"kubectl-get-raw-json.jpg\">      </li>\n<li><p>kubectl proxy å‘½ä»¤è¡Œæ–¹å¼ï¼š        </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl proxy --port=&lt;port&gt;</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³ï¼Œä½¿å…¶èƒ½å¤Ÿè®¿é—® API Server çš„ REST APIï¼Œè¯¥ç«¯å£ä¸å¯è¢«å ç”¨ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>kubectl proxy æ–¹å¼ä½¿ç”¨ kubectl æ‰“å¼€æœ¬åœ° <code>unix socket</code>ï¼Œä½¿ curl å‘½ä»¤é€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰çš„æ–¹å¼ä¸ä»£ç†ç½‘å…³é€šä¿¡ï¼Œå®ç°ä¸ API Server çš„äº¤äº’ã€‚        </p>\n</li>\n<li>Kubernetes é›†ç¾¤é»˜è®¤ä½¿ç”¨ <code>HTTPS</code> çš„æ–¹å¼è®¿é—® API Server çš„ REST APIã€‚        </li>\n<li>ä½¿ç”¨ kubectl proxy å‘½ä»¤å¯åŠ¨æœ¬åœ°ä¸»æœºä¸ºä»£ç†ç½‘å…³åï¼Œåœ¨å¦ä¸€ç»ˆç«¯ä¸­å³å¯ä½¿ç”¨ curl å‘½ä»¤ä»¥ HTTP çš„æ–¹å¼è®¿é—®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š          <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ curl -s http://localhost:8080/api/v1/namespaces/default</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>Kubernetes çš„ API èµ„æºåˆ†ç±»ï¼š  </p>\n<ul>\n<li>å·¥ä½œè´Ÿè½½ç±»å‹ï¼ˆworkloadï¼‰ï¼š    <ul>\n<li>ReplicationControllerï¼ˆrcï¼‰    </li>\n<li>ReplicaSet    </li>\n<li>Deployment    </li>\n<li><code>StatefulSet</code>    </li>\n<li>DaemonSet    </li>\n<li>Job  </li>\n</ul>\n</li>\n<li>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼ˆDiscovery &amp; LBï¼‰ï¼š    <ul>\n<li>Service    </li>\n<li><code>Ingress</code>  </li>\n</ul>\n</li>\n<li>é…ç½®ä¸å­˜å‚¨ï¼ˆConfig &amp; Storageï¼‰ï¼š    <ul>\n<li>Secret    </li>\n<li><code>ConfigMap</code>    </li>\n<li>PersistentVolumeClaimï¼ˆpvcï¼‰  </li>\n</ul>\n</li>\n<li>é›†ç¾¤ï¼ˆClusterï¼‰ï¼š    <ul>\n<li>Namespace    </li>\n<li>Node    </li>\n<li>Roleã€ClusterRoleã€ClusterRoleBindingã€RoleBinding    </li>\n<li>PersistentVolumeï¼ˆpvï¼‰  </li>\n</ul>\n</li>\n<li>å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼š    <ul>\n<li><code>HorizontalPodAutoscaler</code>ï¼ˆHPAï¼‰    </li>\n<li>LimitRange</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Kubernetes èµ„æºé…ç½®æ¸…å•åŸºç¡€ï¼š  <ul>\n<li>Kubernetes èµ„æºé…ç½®æ¸…å•çš„ä¸»è¦ä¸€çº§å­—æ®µï¼š<br>apiVersionã€kindã€metadataã€specã€status  </li>\n<li>å…¶ä¸­ metadataã€spec ä¸ status ä¸ºåµŒå¥—å­—æ®µï¼š    <ul>\n<li><code>metadata</code>ï¼šè®°å½•èµ„æºçš„å…ƒæ•°æ®æ•°æ®    </li>\n<li><code>spec</code>ï¼šè®°å½•èµ„æºçš„ç”¨æˆ·æœŸæœ›çŠ¶æ€ï¼ˆdesiredï¼‰ä¿¡æ¯ï¼Œç”±ç”¨æˆ·è‡ªå®šä¹‰å¹¶ç»´æŠ¤ã€‚    </li>\n<li><code>status</code>ï¼š      <ul>\n<li>è®°å½•æ´»åŠ¨å¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼ˆå®é™…çŠ¶æ€ï¼‰ï¼Œç”± Kubernetes è‡ªåŠ¨å¡«å……å¹¶ç»´æŠ¤ï¼Œå¯¹ç”¨æˆ·ä¸ºåªè¯»å­—æ®µã€‚      <blockquote>\n<p>ğŸ‘‰ æ´»åŠ¨å¯¹è±¡æ˜¯æŒ‡ç”± Kubernetes åˆ›å»ºçš„èµ„æºå¯¹è±¡ã€‚      </p>\n</blockquote>\n</li>\n<li>è¯¥å­—æ®µè®°å½•çš„æ´»åŠ¨å¯¹è±¡çš„çŠ¶æ€åº”ä¸ spec å­—æ®µçš„çŠ¶æ€ç›¸åŒï¼Œæˆ–è€…ä¸¤è€…æ— é™æ¥è¿‘ã€‚    </li>\n</ul>\n</li>\n<li>ğŸ’¥ Kubernetes çš„ API Server åªèƒ½æ¥æ”¶å¹¶å“åº” <code>JSON</code> å¯¹è±¡ï¼ŒYAML æ ¼å¼çš„å¯¹è±¡éœ€ç»è¿‡ API Server è½¬æ¢åæ‰èƒ½è¢«æ¥æ”¶å¤„ç†ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Kubernetes èµ„æºç®¡ç†æ–¹å¼ï¼š  <ul>\n<li>Kubernetes çš„ API Server æ”¯æŒå£°æ˜å¼ç¼–ç¨‹ï¼ˆ<code>delarative programming</code>ï¼‰ä¸é™ˆè¿°å¼ç¼–ç¨‹ï¼ˆ<code>impreative programming</code>ï¼‰ã€‚  </li>\n<li>æ¨èä¼˜å…ˆä½¿ç”¨ <code>apply</code> æˆ– <code>patch</code> å‘½ä»¤çš„å£°æ˜å¼å¯¹è±¡é…ç½®ã€‚  </li>\n<li>å¯å°†ä¸åŒèµ„æºç±»å‹çš„å¯¹è±¡é…ç½®ä¿¡æ¯å†™åœ¨åŒä¸€ä¸ªèµ„æºé…ç½®æ¸…å•ä¸­ï¼Œå¹¶ä½¿ç”¨ <code>---</code> ç¬¦å·å°†æ¯ä¸ªèµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è¿›è¡Œèµ„æºåˆ†å‰²ã€‚  </li>\n<li>ä½¿ç”¨ <code>Git</code> ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç®¡ç†èµ„æºé…ç½®æ¸…å•æ–‡ä»¶ã€‚</li>\n</ul>\n</li>\n<li>å‘½åç©ºé—´çš„èµ„æºç®¡ç†ï¼š  <ul>\n<li>å‘½åç©ºé—´ï¼ˆnamespaceï¼‰é€šè¿‡å°†ä¸åŒèµ„æºè¿›è¡Œéš”ç¦»ï¼Œä½¿å‘½åç©ºé—´çš„èµ„æºè¢«ä¸åŒçš„ç”¨æˆ·ã€ç§Ÿæˆ·ä¸é¡¹ç›®ä½¿ç”¨ã€‚  </li>\n<li>å‘½åç©ºé—´åªéš”ç¦»ä¸åŒçš„èµ„æºï¼Œä¸éš”ç¦»è·¨å‘½åç©ºé—´çš„ Pod é—´çš„é€šä¿¡ï¼Œå› æ­¤å•çº¯ä½¿ç”¨å‘½åç©ºé—´çš„éš”ç¦»æœºåˆ¶ä¸ºè½¯éš”ç¦»ï¼Œè€Œå¯¹ç½‘ç»œæµé‡çš„éš”ç¦»éœ€è¦ç”±ç½‘ç»œç­–ç•¥ï¼ˆ<code>network policy</code>ï¼‰æ¥å®ç°ã€‚  <blockquote>\n<p>âœ… ä¸åŒçš„ CNI æ’ä»¶å¯æä¾›ä¸åŒçš„ç½‘ç»œç­–ç•¥åŠŸèƒ½ï¼Œå¦‚ Calicoã€OVS plugin ç­‰ã€‚  </p>\n</blockquote>\n</li>\n<li>åˆ›å»ºè‡ªå®šä¹‰çš„å‘½åç©ºé—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create namespace &lt;namespace_name&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\"><a href=\"#èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\" class=\"headerlink\" title=\"èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š\"></a>èµ„æºå¯¹è±¡æ“ä½œç›¸å…³å‘½ä»¤ï¼š</h3><ul>\n<li><p>API ç‰ˆæœ¬ä¸èµ„æºå¯¹è±¡è§£é‡Šå‘½ä»¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl --<span class=\"built_in\">help</span></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ kubectl å‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl api-versions</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ API Server æ”¯æŒçš„ API ç‰ˆæœ¬ï¼Œå¹¶ä»¥ group/version çš„æ ¼å¼è¿”å›ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl api-resources</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ API Server æ”¯æŒçš„ API èµ„æºç±»å‹</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl explain &lt;resource_type&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ API èµ„æºç±»å‹çš„è§£é‡Šä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl explain pods.spec.containers.imagePullPolicy</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ Pod èµ„æºå¯¹è±¡ç›¸å…³é…ç½®å­—æ®µçš„è¯¦ç»†ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»º <code>Deployment</code> èµ„æºå¯¹è±¡å¹¶è¿è¡Œ Podï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl run &lt;deployment_name&gt; \\</span><br><span class=\"line\">  --image=&lt;image_name&gt;:&lt;tag&gt; --replicas=&lt;number&gt; --port=&lt;port&gt; \\</span><br><span class=\"line\">  -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># é™ˆè¿°å¼å‘½ä»¤åˆ›å»º Deployment èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"><span class=\"comment\"># ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ç›´æ¥åˆ›å»º Pod èµ„æºå¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ Pod æ§åˆ¶å™¨åˆ›å»ºå¹¶ç®¡ç† Pod å¯¹è±¡ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl run å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl run --help</span></span><br><span class=\"line\"><span class=\"comment\">#   --image=''                   Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨é•œåƒçš„åç§°</span></span><br><span class=\"line\"><span class=\"comment\">#   --port=''                    Pod èµ„æºå¯¹è±¡ä¸­å®¹å™¨çš„ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"comment\">#   --replicas=''                Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°</span></span><br><span class=\"line\"><span class=\"comment\">#   --record=[false|true]        å°†å½“å‰çš„ kubectl å‘½ä»¤è®°å½•äºèµ„æºå¯¹è±¡çš„</span></span><br><span class=\"line\"><span class=\"comment\">#                                annotation æ³¨é‡Šä¸­</span></span><br><span class=\"line\"><span class=\"comment\">#   --save-config=[false|true]   å°†å½“å‰çš„èµ„æºå¯¹è±¡é…ç½®ä¿¡æ¯è®°å½•äº annotation</span></span><br><span class=\"line\"><span class=\"comment\">#                                æ³¨é‡Šä¸­ï¼Œé»˜è®¤ä¸º falseï¼Œåœ¨ä½¿ç”¨ kubectl apply</span></span><br><span class=\"line\"><span class=\"comment\">#                                æ—¶æœ‰ç”¨ã€‚          </span></span><br><span class=\"line\"><span class=\"comment\">#  --restart=[Always|OnFailure|Never]</span></span><br><span class=\"line\"><span class=\"comment\">#                                Pod èµ„æºå¯¹è±¡çš„é‡å¯ç­–ç•¥ï¼Œé»˜è®¤ä¸º Alwaysã€‚            </span></span><br><span class=\"line\"><span class=\"comment\">#  --dry-run=[false|true]        æµ‹è¯•è¿è¡Œï¼ˆå¹²è¿è¡Œï¼‰ï¼Œé»˜è®¤ä¸º falseã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#  -nï¼Œ--namespace=''            èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl run nginx-deploy \\</span><br><span class=\"line\">  --image=nginx:v1.12 --replicas=2 --port=80 -n default</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Deployment èµ„æºå¯¹è±¡ nginx-deploy</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl run client \\</span><br><span class=\"line\">  --image=busybox:latest --restart=Never --replicas=1 \\</span><br><span class=\"line\">  -it -n default -- /bin/sh</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š --restart=Never é€‰é¡¹æ—¶ï¼Œåªåˆ›å»º Pod èµ„æºå¯¹è±¡ client å¹¶è¿›å…¥ Pod äº¤äº’å¼ç•Œé¢ã€‚             </span></span><br><span class=\"line\"><span class=\"comment\"># é€€å‡ºäº¤äº’å¼ç•Œé¢åï¼Œç»ˆæ­¢ Pod èµ„æºå¯¹è±¡è¿è¡Œï¼Œå¹¶è¿›å…¥ Completed çŠ¶æ€ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»º Service èµ„æºå¯¹è±¡ä¸æš´éœ²åº”ç”¨ç«¯å£ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl expose deployment &lt;deployment_name&gt; \\</span><br><span class=\"line\">  --name=&lt;service_name&gt; --port=&lt;port&gt; --target-port=&lt;port_num&gt; \\</span><br><span class=\"line\">  -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Service èµ„æºå¯¹è±¡ï¼Œå¯¹å¤–æš´éœ²å¹¶å…³è” Pod èµ„æºå¯¹è±¡çš„ Pod IP ä¸ç«¯å£ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl expose å¸¸ç”¨å‘½ä»¤é€‰é¡¹ï¼škubectl expose --help</span></span><br><span class=\"line\"><span class=\"comment\">#   --name=''                åˆ›å»ºçš„ Service èµ„æºå¯¹è±¡åç§°</span></span><br><span class=\"line\"><span class=\"comment\">#   --port=''                Service èµ„æºå¯¹è±¡çš„ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"comment\">#   --target-port=''         Service èµ„æºå¯¹è±¡å…³è”çš„åç«¯ Pod èµ„æºå¯¹è±¡çš„ç«¯å£å·</span></span><br><span class=\"line\"><span class=\"comment\">#   -nï¼Œ--namespace=''       èµ„æºå¯¹è±¡æ‰€åœ¨çš„å‘½åç©ºé—´</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl expose deployment nginx-deploy \\</span><br><span class=\"line\">  --name=nginx-svc --port=8080 --target-port=80 -n default</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºåç§°ä¸º nginx-svc çš„ Service èµ„æºå¯¹è±¡</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æŸ¥çœ‹ä¸æ“ä½œç›¸å…³èµ„æºå¯¹è±¡ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pods,services -n &lt;namespace&gt; -o wide</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod ä¸ Service èµ„æºå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆé€—å·åˆ†éš”ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl get &lt;resource_type&gt; \\</span><br><span class=\"line\">  -n &lt;namespace&gt; -o &#123;yaml|json|jsonpath|wide|custom-columns=...&#125;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å‘½åç©ºé—´ä¸­çš„èµ„æºå¯¹è±¡ä¿¡æ¯ï¼Œå¹¶ä»¥ YAMLã€JSONã€å®Œæ•´æ ¼å¼æˆ–è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl get pods \\</span><br><span class=\"line\">  -o custom-columns=NAME:metadata.name,STATUS:status.phase </span><br><span class=\"line\">  -n kube-system</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ kube-system å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡çš„åç§°ä¸çŠ¶æ€ä¿¡æ¯ï¼Œä»¥è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl logs &lt;pod_name&gt; [-c &lt;container_name&gt;] -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å®¹å™¨æ—¥å¿—ä¿¡æ¯</span></span><br><span class=\"line\"><span class=\"comment\"># Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl <span class=\"built_in\">exec</span> &lt;pod_name&gt; \\</span><br><span class=\"line\">  [-c &lt;container_name&gt;] -n &lt;namespace&gt; -- &lt;<span class=\"built_in\">command</span>&gt; &lt;opts&gt; &lt;args...&gt;</span><br><span class=\"line\"><span class=\"comment\"># æ‰§è¡Œå‘½åç©ºé—´ä¸­ Pod èµ„æºå¯¹è±¡ä¸­çš„å‘½ä»¤</span></span><br><span class=\"line\"><span class=\"comment\"># Pod èµ„æºå¯¹è±¡ä¸­å­˜åœ¨å¤šä¸ªå®¹å™¨æ—¶ï¼Œä½¿ç”¨ -c é€‰é¡¹æŒ‡å®šå®¹å™¨ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl delete \\</span><br><span class=\"line\">  &lt;resource_type&gt; &lt;resource_name&gt; -l &lt;key&gt;=&lt;value&gt; -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤å‘½åç©ºé—´ä¸­å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl delete deployment myapp --cascade=<span class=\"literal\">false</span> -n default</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤ default å‘½åç©ºé—´ä¸­åä¸º myapp çš„ Deployment èµ„æºå¯¹è±¡ï¼Œä½†ä¸åˆ é™¤å…¶åˆ›å»ºçš„ Podã€‚    </span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl create -f &lt;file&gt;.yaml|&lt;dir&gt;|&lt;url&gt;</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨é™ˆè¿°å¼å‘½ä»¤ create åˆ›å»ºä¸åŒçš„ API èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl apply -f &lt;file&gt;.yaml|&lt;dir&gt;|&lt;url&gt; </span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨å£°æ˜å¼å‘½ä»¤ apply åˆ›å»ºã€æ›´æ–°ä¸æ›¿æ¢ä¸åŒçš„ API èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. å£°æ˜å¼å¯¹è±¡é…ç½®ç®¡ç†å…·æœ‰é«˜çº§çš„è¡¥ä¸æ›´æ–°æœºåˆ¶ï¼Œå°†ç›¸åº”çš„é…ç½®ä¿¡æ¯è®°å½•äº annotation æ³¨é‡Šä¸­ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#   2. Kubernetes å»ºè®®ä½¿ç”¨å£°æ˜å¼å¯¹è±¡é…ç½®æ–¹å¼ï¼ </span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl delete -f &lt;file&gt;.yaml</span><br><span class=\"line\"><span class=\"comment\"># åˆ é™¤è¯¥ YAML é…ç½®æ–‡ä»¶åˆ›å»ºçš„ API èµ„æºå¯¹è±¡</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ kubectl scale deployment &lt;deployment_name&gt; --replicas=&lt;number&gt; -n &lt;namespace&gt;</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šå‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ kubectl scale deployment myapp --replicas=3 -n default</span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®š default å‘½åç©ºé—´ä¸­æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡çš„å‰¯æœ¬æ•°ç›®ä¸º 3 ä¸ª</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   æ‰©å®¹æˆ–ç¼©å®¹ Pod èµ„æºå¯¹è±¡å‰¯æœ¬æ•°ç›®çš„æ–¹æ³•ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. é€šè¿‡è¯¥å‘½ä»¤è¡Œæ–¹å¼è¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹</span></span><br><span class=\"line\"><span class=\"comment\">#   2. ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ›´æ”¹ Deployment èµ„æºå¯¹è±¡çš„é…ç½®ä¿¡æ¯ï¼Œæ›´æ”¹åå®æ—¶ç”Ÿæ•ˆï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#      $ kubectl edit deployment myapp -n default</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n"},{"title":"Linux è¿›ç¨‹æƒé™çš„å„ç±» UID æ¢è®¨","subtitle":"Linux Process UID Analyse","date":"2023-01-28T07:30:30.000Z","header-img":"linux-process_bg.jpg","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼š`Ubuntu 20.04.3 LTS`\n- kernel ç‰ˆæœ¬ï¼š`5.15.0-57-generic`\n- Linux ä¸­å„ç±» UID çš„è”ç³»ä¸åŒºåˆ«å¯¹äºç†è§£è¿›ç¨‹æƒé™ä¸ Audit å®¡è®¡ç³»ç»Ÿå‘æŒ¥è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œè¿™äº› UID ä½œä¸ºè¿›ç¨‹å‡­è¯ã€‚\n- âœ å¯å‚è€ƒ `man 7 credentials` æ‰‹å†Œä¸­çš„è¯´æ˜åŠ ä»¥ç†è§£ã€‚\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- å„ç±» UID çš„è§£æ\n- ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»\n- ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹\n- å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜\n- å‚è€ƒé“¾æ¥\n\n### å„ç±» UID çš„è§£æï¼š\n- user IDï¼š  \n  - å¸¸è§„ Linux ç”¨æˆ· IDï¼Œä½œä¸ºç³»ç»Ÿä¸­ç”¨æˆ·çš„å”¯ä¸€è¯†åˆ«ç¬¦ã€‚\n- Real user IDï¼ˆ`ruid`ï¼‰ï¼š  \n  - çœŸå®ç”¨æˆ· ID  \n  - ğŸ¤˜ ruid ä¸ºæ‹¥æœ‰å½“å‰è¿›ç¨‹çš„ç”¨æˆ· IDï¼Œå³è°ƒç”¨è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ç”¨æˆ·ã€‚  \n  - ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åˆç™»å½• Shell çš„ user ID ä¸ ruid ç›¸åŒï¼Œä½†æ˜¯è¯¥ç™»å½•ç”¨æˆ·æœ‰å¯èƒ½é€šè¿‡ su æˆ– sudo ææƒä¸ºå…¶ä»–éç‰¹æƒç”¨æˆ·æˆ–ç‰¹æƒç”¨æˆ·ï¼Œæ­¤æ—¶çš„ ruid ä¸æœ€åˆçš„ç™»å½• user ID ä¸åŒã€‚\n- Effective user IDï¼ˆ`euid`ï¼‰ï¼š  \n  - æœ‰æ•ˆç”¨æˆ· ID  \n  - ğŸ¤˜ euid è¢«å†…æ ¸ä½¿ç”¨ç¡®å®šè¿›ç¨‹å¯è®¿é—®èµ„æºçš„æƒé™  \n  - è¿›ç¨‹çš„æƒé™ç”±ä¿å­˜åœ¨ euid ä¸­çš„ UID æ¥å†³å®š  \n  - é€šå¸¸è€Œè¨€ï¼Œè¿›ç¨‹çš„ ruid ä¸ euid ä¿æŒä¸€è‡´ï¼Œruid ä¸ euid å¯¹è¿›ç¨‹è€Œè¨€ã€‚  \n  - euid ä¸´æ—¶å­˜å‚¨äº†å¦ä¸€ä¸ªç”¨æˆ·çš„ UID  \n  - ğŸš€ euid åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¸æ‰§è¡Œ set-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºæ—¶è¢«ä¿®æ”¹ã€‚  \n  - ä¹Ÿå°±æ˜¯è¯´ï¼Œset-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶å…¶æœ¬èº«ä¹Ÿéœ€è¦è®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰åï¼Œeuid è¢«æ›´æ”¹ä¸ºä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰€æœ‰è€…ï¼ˆownerï¼‰UID ç›¸åŒï¼Œè€Œæœªè®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œeuid ä¾ç„¶ä¸ ruid ä¿æŒä¸€è‡´ï¼Œå¯å‚è§ä¸‹æ–‡ \"ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹\" éƒ¨åˆ†ã€‚  \n  - set-user-ID æƒé™ä½æŒ‡çš„æ˜¯ Linux ä¸­çš„ç‰¹æ®Šæƒé™ suid\n  - privileged åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­éœ€åŠ ä»¥è¾¨åˆ«ï¼Œå¯èƒ½æ˜¯ç‰¹æƒç”¨æˆ· rootï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ™®é€šç”¨æˆ·ã€‚\n\n- Saved set-user-IDï¼š  \n  - ä¿å­˜è®¾ç½®ç”¨æˆ· ID  \n  - ğŸš€ è¯¥ ID ç›¸å½“äºä¸€ä¸ª `buffer`ï¼Œåœ¨è¿›ç¨‹å¯åŠ¨åï¼Œå®ƒä¼šä» euid æ‹·è´ä¿¡æ¯åˆ°è‡ªèº«ã€‚å¯¹äºé root ç”¨æˆ·ï¼Œå¯ä»¥åœ¨æœªæ¥ä½¿ç”¨ `setuid()` ç³»ç»Ÿè°ƒç”¨æ¥å°† euid è®¾ç½®æˆä¸º ruid å’Œ saved set-user-ID ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚ä½†æ˜¯é root ç”¨æˆ·æ˜¯ä¸å…è®¸ç”¨ setuid() å°† euid è®¾ç½®æˆä¸ºä»»ä½•ç¬¬ä¸‰ä¸ª user IDã€‚\n- Audit user IDï¼ˆ`auid`ï¼‰ï¼š  \n  - å®¡è®¡ç”¨æˆ· IDï¼Œç”¨äºè®°å½• Linux Audit å®¡è®¡ç³»ç»Ÿä¸­çš„ç”¨æˆ·æ ‡è¯†ã€‚  \n  - auid ä¸ºæœ€åˆç™»å½• Shell çš„çš„ç”¨æˆ· ID\n\n### ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»ï¼š\n- è¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ä¸‰è€…çš„èµ‹å€¼å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![](linux-process-uid-mapping.png)  \n  - 1ï¸âƒ£2ï¸âƒ£ å‡å®šæœ€åˆç™»å½• Shell çš„ç”¨æˆ·å¯åŠ¨è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨è¿›ç¨‹ã€‚  \n  - 3ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ `ruid/rgid` ä¸ºå½“å‰ç”¨æˆ·çš„ uid/gid  \n  - 4ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ `euid/egid`ï¼Œæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„ `set-user-ID` ä¸ `set-group-ID` æƒé™ä½è¿›è¡Œè®¾ç½®ï¼Œå›¾ä¸­çº¢è‰² 0 è¡¨ç¤ºå…³é—­ï¼Œç´«è‰² 1 è¡¨ç¤ºå¼€å¯ã€‚ä¸º 1 æ—¶ï¼Œå°†è¿›ç¨‹çš„ euid/egid è®¾ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„ uid/gidï¼Œå¦åˆ™ä» ruid/rgid æ‹·è´ã€‚\n- ä»¥ä¸Šè¿‡ç¨‹å¯æ€»ç»“ä¸ºä¸‹è¡¨ï¼š![](linux-process-uid-table.png)\n\n### ğŸš€ ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹ï¼š\n- éœ€è¦æ³¨æ„çš„æ˜¯ Linux ç³»ç»Ÿä¸­ set-user-ID ä¸ set-group-ID æƒé™ä½å¯¹ shell è„šæœ¬æ— æ•ˆï¼Œå¦‚ä¸‹ [process-cred-sample.c](https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample.c) ç¨‹åºæ‰€ç¤ºï¼š  \n  ```c\n  #define _GNU_SOURCE\n  #include <stdio.h>\n  #include <stdlib.h>\n  #include <unistd.h>\n  #include <sys/types.h>\n  \n  int main()\n  {\n      uid_t ruid, euid, suid;\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      system(\"cat file-read-only-by-sysadmin\");  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      setreuid(geteuid(), geteuid());  // use euid to set ruid\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      system(\"cat file-read-only-by-sysadmin\");  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      return 0;\n  }\n  ```\n  ä»¥ä¸Šç¨‹åºä¸­è·å–å½“å‰è¿›ç¨‹çš„ ruidã€euid ä¸ suidï¼Œä½†æ˜¯ `system()` å‡½æ•°è°ƒç”¨äº† shell è„šæœ¬ï¼Œå³ä½¿å°†è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½å¼€å¯ä¹Ÿæ— æ³•ä½¿ç”¨æ­¤æƒé™ä½ï¼š\n  ```bash\n  $ id\n    uid=1000(godev) gid=1000(godev) groups=1000(godev)\n  # ç¬”è€…ç¤ºä¾‹ä½¿ç”¨ godev æ™®é€šç”¨æˆ·éªŒè¯\n  $ id -u sysadmin\n    1001\n  $ ls -lh file-read-only-by-sysadmin \n    -r-------- 1 sysadmin sysadmin 5 Jan 24 17:08 file-read-only-by-sysadmin\n  # å½“å‰ç›®å½•ä¸­å…ˆåˆ›å»ºè¯¥æ–‡ä»¶ï¼Œå…¶ä¸­ Test ä½œä¸ºæ–‡æœ¬å†…å®¹ã€‚\n  $ gcc -o process-cred-sample process-cred-sample.c\n  $ sudo chown sysadmin:godev process-cred-sample\n  # æ›´æ”¹å¯æ‰§è¡Œç¨‹åºçš„æ‰€æœ‰è€…ï¼Œsysadmin ä¸ºç³»ç»Ÿä¸Šçš„å¦ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚\n  $ ./process-cred-sample\n    RUID: 1000, EUID: 1000, SUID: 1000\n    cat: file-read-only-by-sysadmin: Permission denied\n    RUID: 1000, EUID: 1000, SUID: 1000\n    cat: file-read-only-by-sysadmin: Permission denied\n  # ç”±äºå¯æ‰§è¡Œæ–‡ä»¶ä¸å…·æœ‰ set-user-ID æƒé™ä½è€Œæ— æ³•æ›´æ”¹ euid\n  $ sudo chmod u+s process-cred-sample\n  # æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½\n  $ ls -lh process-cred-sample\n  -rwsrwxr-x 1 sysadmin godev 17K Jan 25 23:19 process-cred-sample\n  $ ./process-cred-sample\n    RUID: 1000, EUID: 1001, SUID: 1001\n    cat: file-read-only-by-sysadmin: Permission denied  # ç¬¬ä¸€æ¬¡è¾“å‡º\n    RUID: 1001, EUID: 1001, SUID: 1001\n    Test  # ç¬¬äºŒæ¬¡è¾“å‡º  \n  ```\n\n  ä»¥ä¸Šå‘½ä»¤ç¬¬ä¸€æ¬¡è¾“å‡ºè°ƒç”¨ shell è„šæœ¬è€Œæ— æ³•ä½¿ç”¨ set-user-ID æƒé™ä½è¿”å› `Permission denied`ã€‚ç¬¬äºŒæ¬¡è¾“å‡ºä½¿ç”¨ `setreuid()` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† euid çš„å€¼ä»£æ›¿ ruid çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå› æ­¤ ruid ä¹Ÿè¿”å› 1001ï¼Œæ­¤æ—¶è¯¥è¿›ç¨‹å¯è¯»å–å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œä½†è¯·æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„çš„ ruid æ˜¯ setreuid() ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºï¼Œä» kernel çš„è§’åº¦æ¥çœ‹ ruid ä¾ç„¶æ˜¯å®é™…è¿è¡Œè¿›ç¨‹çš„ UIDï¼Œå³ä¸º godev(1000)ã€‚\n- å› æ­¤ï¼Œè‹¥è¦å®ç° shell è„šæœ¬ç›¸åŒçš„æ•ˆæœï¼Œå¯ä½¿ç”¨ `fopen()` ä¸ `fread()` å‡½æ•°å°†ä»¥ä¸Šæºç æ›´æ”¹ä¸ºåä¸º [process-cred-sample-adv.c](https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample-adv.c) ç¨‹åºï¼š\n  ```c\n  #define _GNU_SOURCE\n  #include <stdio.h>\n  #include <stdlib.h>\n  #include <string.h>\n  #include <unistd.h>\n  #include <sys/types.h>\n  \n  #define BUFF_SIZE 100\n  \n  void read_file() {\n      FILE *fp;\n      char buffer[BUFF_SIZE];\n  \n      /* Open file for both reading and writing */\n      fp = fopen(\"file-read-only-by-sysadmin\", \"r\");\n      /* Read and display data */\n      fread(buffer, BUFF_SIZE - 1, sizeof(char), fp);\n      printf(\"%s\\n\", buffer);\n      fclose(fp);\n  }\n  \n  int main()\n  {\n      uid_t ruid, euid, suid;\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      read_file();  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      setreuid(geteuid(), geteuid());\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      read_file();  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      return 0;\n  }\n  ```\n  åŒæ ·ç¼–è¯‘ç¨‹åºï¼Œæ›´æ”¹å¯æ‰§è¡Œæ–‡ä»¶æ‰€æœ‰è€…å¹¶æ·»åŠ  set-user-ID æƒé™ä½ï¼š\n  ```bash\n  $ gcc -o process-cred-sample-adv process-cred-sample-adv.c\n  $ sudo chown sysadmin:godev process-cred-sample-adv\n  $ sudo chmod u+s process-cred-sample-adv\n  $ ./process-cred-sample-adv\n    RUID: 1000, EUID: 1001, SUID: 1001  # ç¬¬ä¸€æ¬¡è¾“å‡º\n    Test\n  \n    RUID: 1001, EUID: 1001, SUID: 1001  # ç¬¬äºŒæ¬¡è¾“å‡º\n    Test\n  ```\n  ç¬¬ä¸€æ¬¡è¾“å‡ºç”±äºç›´æ¥ä½¿ç”¨ fopen() ä¸ fread() å‡½æ•°ä¸” euid æ›´æ”¹ä¸º 1001ï¼Œå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œç¬¬äºŒæ¬¡è¾“å‡ºé€šè¿‡ setreuid() ç³»ç»Ÿè°ƒç”¨å°† ruid ä¸ euid éƒ½è®¾ç½®ä¸º 1001ï¼Œä¹Ÿå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œå› æ­¤å¯¹äºç³»ç»Ÿèµ„æºçš„è®¿é—®å–å†³äº `euid`ã€‚\n- ä»¥ä¸ŠéªŒè¯æºç ä¸æ–‡ä»¶çš„æƒé™å¦‚ä¸‹æ‰€ç¤ºï¼š![](linux-ruid-euid-test.png)\n\n### å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\n- ä½¿ç”¨ Audit å®¡è®¡ç³»ç»Ÿè¿‡ç¨‹ä¸­å¯¹æ–‡ä»¶ã€ç›®å½•æˆ–ç³»ç»Ÿè°ƒç”¨çš„å®¡è®¡ç»“æœä»¥å®¡è®¡æ—¥å¿—çš„æ–¹å¼å‘ˆç°ï¼Œåœ¨ä¼—å¤šçš„ type=SYSCALL ç±»å‹å®¡è®¡æ—¥å¿—ä¸­åŒ…å«äº†å¤§é‡çš„ auidã€uidã€euidã€suid ç­‰çš„ä¿¡æ¯ã€‚\n- ä»¥ä¸‹å°†å®¡è®¡ä¸Šè¿° process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿›ä¸€æ­¥ç†è§£å„ç±» UID çš„ä½œç”¨ï¼š  \n  ```bash\n  $ sudo apt-get install -y auditd\n  # å®‰è£… auditd è½¯ä»¶åŒ…\n  $ sudo systemctl enable --now auditd.service\n  # å¯åŠ¨ auditd.service å®ˆæŠ¤è¿›ç¨‹\n  $ sudo auditctl -w ~/backup/ruid-euid-suid-test/process-cred-sample-adv \\\n    -p x -k new-uid-adv\n  # æ·»åŠ åä¸º new-uid-adv æœç´¢å…³é”®å­—çš„å®¡è®¡è§„åˆ™ï¼Œç›‘æ§å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæƒé™å±æ€§ï¼Œæ—¥å¿—å°†å†™å…¥\n  # /var/log/audit/audit.log ä¸­\n  $ sudo auditctl -l\n    -w /home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv -p x -k new-uid-adv\n  $ ./process-cred-sample-adv\n  $ sudo ausearch -i -k new-uid-adv\n    type=PROCTITLE msg=audit(01/26/2023 13:47:38.727:1185) : proctitle=./process-cred-sample-adv \n    type=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=1 name=/lib64/ld-linux-x86-64.so.2 \n    inode=403317285 dev=08:02 mode=file,755 ouid=root ogid=root rdev=00:00 nametype=NORMAL cap_fp=none \n    cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 \n    type=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=0 name=./process-cred-sample-adv \n    inode=137438286 dev=08:03 mode=file,suid,775 ouid=sysadmin ogid=godev rdev=00:00 nametype=NORMAL \n    cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 \n    type=CWD msg=audit(01/26/2023 13:47:38.727:1185) : cwd=/home/godev/backup/ruid-euid-suid-test \n    type=EXECVE msg=audit(01/26/2023 13:47:38.727:1185) : argc=1 a0=./process-cred-sample-adv \n    type=SYSCALL msg=audit(01/26/2023 13:47:38.727:1185) : arch=x86_64 syscall=execve success=yes \n    exit=0 a0=0x55e64d0712b0 a1=0x55e64d1fab50 a2=0x55e64d1ed380 a3=0x8 items=2 ppid=22490 pid=41229 \n    auid=godev uid=godev gid=godev euid=sysadmin suid=sysadmin fsuid=sysadmin egid=godev sgid=godev \n    fsgid=godev tty=pts3 ses=4 comm=process-cred-sa exe=/home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv \n    subj=unconfined key=new-uid-adv\n  ```\n  åœ¨æ‰§è¡Œ process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶åï¼Œä½¿ç”¨ `ausearch` æŸ¥æ‰¾å¯¹åº”çš„æ‰§è¡Œæ—¥å¿—ï¼Œå…¶ä¸­ `type=SYSCALL` ä¸­ `uid=godev` ä¸º kernel ç¡®å®šçš„ ruid å€¼ 1000(godev)ï¼Œè™½ç„¶åœ¨ process-cred-sample-adv è¿›ç¨‹è¿”å›ä¸­ ruid ä¸º 1001ï¼Œä½†è¯¥å€¼ä¸º setreuid() ç³»ç»Ÿè°ƒç”¨é‡æ–°è®¾ç½®çš„å€¼ï¼ŒçœŸå®çš„ ruid ä¾ç„¶ä¸º 1000(godev)ã€‚`euid=sysadmin` ä¸ `suid=sysadmin` çš„ç»“æœä¸è¿›ç¨‹è¿”å›çš„ç»“æœå®Œå…¨ä¸€è‡´ã€‚\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [credentials(7) - Linux man page](https://linux.die.net/man/7/credentials)\n- [setreuid(2) - Linux manual page](https://man7.org/linux/man-pages/man2/setregid.2.html)\n- [Difference between Real User ID, Effective User ID and Saved User ID](https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id)\n- [æ·±åˆ»ç†è§£ - real user id, effective user id, saved user id in Linux](https://blog.csdn.net/fmeng23/article/details/23115989?spm=1001.2101.3001.6650.4&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&utm_relevant_index=5)\n- [ã€ŠLinux/Unix ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ï¼ˆä¸Šå†Œï¼‰- ç¬¬9ç«  è¿›ç¨‹å‡­è¯ï¼ˆæå–ç ï¼šwop8ï¼‰](https://pan.baidu.com/s/1DX8AEVBqepVDp3tiR06nBQ)\n- [ruid, euid, suid usage in Linux](https://mudongliang.github.io/2020/09/17/ruid-euid-suid-usage-in-linux.html)\n","source":"_posts/linux-process-uid.md","raw":"---\ntitle: Linux è¿›ç¨‹æƒé™çš„å„ç±» UID æ¢è®¨\nsubtitle: Linux Process UID Analyse\ndate: 2023-01-28 15:30:30\nheader-img: linux-process_bg.jpg\ntags:\n  - Linux\n  - è¿›ç¨‹\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼š`Ubuntu 20.04.3 LTS`\n- kernel ç‰ˆæœ¬ï¼š`5.15.0-57-generic`\n- Linux ä¸­å„ç±» UID çš„è”ç³»ä¸åŒºåˆ«å¯¹äºç†è§£è¿›ç¨‹æƒé™ä¸ Audit å®¡è®¡ç³»ç»Ÿå‘æŒ¥è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œè¿™äº› UID ä½œä¸ºè¿›ç¨‹å‡­è¯ã€‚\n- âœ å¯å‚è€ƒ `man 7 credentials` æ‰‹å†Œä¸­çš„è¯´æ˜åŠ ä»¥ç†è§£ã€‚\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- å„ç±» UID çš„è§£æ\n- ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»\n- ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹\n- å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜\n- å‚è€ƒé“¾æ¥\n\n### å„ç±» UID çš„è§£æï¼š\n- user IDï¼š  \n  - å¸¸è§„ Linux ç”¨æˆ· IDï¼Œä½œä¸ºç³»ç»Ÿä¸­ç”¨æˆ·çš„å”¯ä¸€è¯†åˆ«ç¬¦ã€‚\n- Real user IDï¼ˆ`ruid`ï¼‰ï¼š  \n  - çœŸå®ç”¨æˆ· ID  \n  - ğŸ¤˜ ruid ä¸ºæ‹¥æœ‰å½“å‰è¿›ç¨‹çš„ç”¨æˆ· IDï¼Œå³è°ƒç”¨è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ç”¨æˆ·ã€‚  \n  - ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åˆç™»å½• Shell çš„ user ID ä¸ ruid ç›¸åŒï¼Œä½†æ˜¯è¯¥ç™»å½•ç”¨æˆ·æœ‰å¯èƒ½é€šè¿‡ su æˆ– sudo ææƒä¸ºå…¶ä»–éç‰¹æƒç”¨æˆ·æˆ–ç‰¹æƒç”¨æˆ·ï¼Œæ­¤æ—¶çš„ ruid ä¸æœ€åˆçš„ç™»å½• user ID ä¸åŒã€‚\n- Effective user IDï¼ˆ`euid`ï¼‰ï¼š  \n  - æœ‰æ•ˆç”¨æˆ· ID  \n  - ğŸ¤˜ euid è¢«å†…æ ¸ä½¿ç”¨ç¡®å®šè¿›ç¨‹å¯è®¿é—®èµ„æºçš„æƒé™  \n  - è¿›ç¨‹çš„æƒé™ç”±ä¿å­˜åœ¨ euid ä¸­çš„ UID æ¥å†³å®š  \n  - é€šå¸¸è€Œè¨€ï¼Œè¿›ç¨‹çš„ ruid ä¸ euid ä¿æŒä¸€è‡´ï¼Œruid ä¸ euid å¯¹è¿›ç¨‹è€Œè¨€ã€‚  \n  - euid ä¸´æ—¶å­˜å‚¨äº†å¦ä¸€ä¸ªç”¨æˆ·çš„ UID  \n  - ğŸš€ euid åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¸æ‰§è¡Œ set-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºæ—¶è¢«ä¿®æ”¹ã€‚  \n  - ä¹Ÿå°±æ˜¯è¯´ï¼Œset-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶å…¶æœ¬èº«ä¹Ÿéœ€è¦è®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰åï¼Œeuid è¢«æ›´æ”¹ä¸ºä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰€æœ‰è€…ï¼ˆownerï¼‰UID ç›¸åŒï¼Œè€Œæœªè®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œeuid ä¾ç„¶ä¸ ruid ä¿æŒä¸€è‡´ï¼Œå¯å‚è§ä¸‹æ–‡ \"ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹\" éƒ¨åˆ†ã€‚  \n  - set-user-ID æƒé™ä½æŒ‡çš„æ˜¯ Linux ä¸­çš„ç‰¹æ®Šæƒé™ suid\n  - privileged åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­éœ€åŠ ä»¥è¾¨åˆ«ï¼Œå¯èƒ½æ˜¯ç‰¹æƒç”¨æˆ· rootï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ™®é€šç”¨æˆ·ã€‚\n\n- Saved set-user-IDï¼š  \n  - ä¿å­˜è®¾ç½®ç”¨æˆ· ID  \n  - ğŸš€ è¯¥ ID ç›¸å½“äºä¸€ä¸ª `buffer`ï¼Œåœ¨è¿›ç¨‹å¯åŠ¨åï¼Œå®ƒä¼šä» euid æ‹·è´ä¿¡æ¯åˆ°è‡ªèº«ã€‚å¯¹äºé root ç”¨æˆ·ï¼Œå¯ä»¥åœ¨æœªæ¥ä½¿ç”¨ `setuid()` ç³»ç»Ÿè°ƒç”¨æ¥å°† euid è®¾ç½®æˆä¸º ruid å’Œ saved set-user-ID ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚ä½†æ˜¯é root ç”¨æˆ·æ˜¯ä¸å…è®¸ç”¨ setuid() å°† euid è®¾ç½®æˆä¸ºä»»ä½•ç¬¬ä¸‰ä¸ª user IDã€‚\n- Audit user IDï¼ˆ`auid`ï¼‰ï¼š  \n  - å®¡è®¡ç”¨æˆ· IDï¼Œç”¨äºè®°å½• Linux Audit å®¡è®¡ç³»ç»Ÿä¸­çš„ç”¨æˆ·æ ‡è¯†ã€‚  \n  - auid ä¸ºæœ€åˆç™»å½• Shell çš„çš„ç”¨æˆ· ID\n\n### ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»ï¼š\n- è¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ä¸‰è€…çš„èµ‹å€¼å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![](linux-process-uid-mapping.png)  \n  - 1ï¸âƒ£2ï¸âƒ£ å‡å®šæœ€åˆç™»å½• Shell çš„ç”¨æˆ·å¯åŠ¨è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨è¿›ç¨‹ã€‚  \n  - 3ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ `ruid/rgid` ä¸ºå½“å‰ç”¨æˆ·çš„ uid/gid  \n  - 4ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ `euid/egid`ï¼Œæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„ `set-user-ID` ä¸ `set-group-ID` æƒé™ä½è¿›è¡Œè®¾ç½®ï¼Œå›¾ä¸­çº¢è‰² 0 è¡¨ç¤ºå…³é—­ï¼Œç´«è‰² 1 è¡¨ç¤ºå¼€å¯ã€‚ä¸º 1 æ—¶ï¼Œå°†è¿›ç¨‹çš„ euid/egid è®¾ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„ uid/gidï¼Œå¦åˆ™ä» ruid/rgid æ‹·è´ã€‚\n- ä»¥ä¸Šè¿‡ç¨‹å¯æ€»ç»“ä¸ºä¸‹è¡¨ï¼š![](linux-process-uid-table.png)\n\n### ğŸš€ ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹ï¼š\n- éœ€è¦æ³¨æ„çš„æ˜¯ Linux ç³»ç»Ÿä¸­ set-user-ID ä¸ set-group-ID æƒé™ä½å¯¹ shell è„šæœ¬æ— æ•ˆï¼Œå¦‚ä¸‹ [process-cred-sample.c](https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample.c) ç¨‹åºæ‰€ç¤ºï¼š  \n  ```c\n  #define _GNU_SOURCE\n  #include <stdio.h>\n  #include <stdlib.h>\n  #include <unistd.h>\n  #include <sys/types.h>\n  \n  int main()\n  {\n      uid_t ruid, euid, suid;\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      system(\"cat file-read-only-by-sysadmin\");  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      setreuid(geteuid(), geteuid());  // use euid to set ruid\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      system(\"cat file-read-only-by-sysadmin\");  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      return 0;\n  }\n  ```\n  ä»¥ä¸Šç¨‹åºä¸­è·å–å½“å‰è¿›ç¨‹çš„ ruidã€euid ä¸ suidï¼Œä½†æ˜¯ `system()` å‡½æ•°è°ƒç”¨äº† shell è„šæœ¬ï¼Œå³ä½¿å°†è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½å¼€å¯ä¹Ÿæ— æ³•ä½¿ç”¨æ­¤æƒé™ä½ï¼š\n  ```bash\n  $ id\n    uid=1000(godev) gid=1000(godev) groups=1000(godev)\n  # ç¬”è€…ç¤ºä¾‹ä½¿ç”¨ godev æ™®é€šç”¨æˆ·éªŒè¯\n  $ id -u sysadmin\n    1001\n  $ ls -lh file-read-only-by-sysadmin \n    -r-------- 1 sysadmin sysadmin 5 Jan 24 17:08 file-read-only-by-sysadmin\n  # å½“å‰ç›®å½•ä¸­å…ˆåˆ›å»ºè¯¥æ–‡ä»¶ï¼Œå…¶ä¸­ Test ä½œä¸ºæ–‡æœ¬å†…å®¹ã€‚\n  $ gcc -o process-cred-sample process-cred-sample.c\n  $ sudo chown sysadmin:godev process-cred-sample\n  # æ›´æ”¹å¯æ‰§è¡Œç¨‹åºçš„æ‰€æœ‰è€…ï¼Œsysadmin ä¸ºç³»ç»Ÿä¸Šçš„å¦ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚\n  $ ./process-cred-sample\n    RUID: 1000, EUID: 1000, SUID: 1000\n    cat: file-read-only-by-sysadmin: Permission denied\n    RUID: 1000, EUID: 1000, SUID: 1000\n    cat: file-read-only-by-sysadmin: Permission denied\n  # ç”±äºå¯æ‰§è¡Œæ–‡ä»¶ä¸å…·æœ‰ set-user-ID æƒé™ä½è€Œæ— æ³•æ›´æ”¹ euid\n  $ sudo chmod u+s process-cred-sample\n  # æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½\n  $ ls -lh process-cred-sample\n  -rwsrwxr-x 1 sysadmin godev 17K Jan 25 23:19 process-cred-sample\n  $ ./process-cred-sample\n    RUID: 1000, EUID: 1001, SUID: 1001\n    cat: file-read-only-by-sysadmin: Permission denied  # ç¬¬ä¸€æ¬¡è¾“å‡º\n    RUID: 1001, EUID: 1001, SUID: 1001\n    Test  # ç¬¬äºŒæ¬¡è¾“å‡º  \n  ```\n\n  ä»¥ä¸Šå‘½ä»¤ç¬¬ä¸€æ¬¡è¾“å‡ºè°ƒç”¨ shell è„šæœ¬è€Œæ— æ³•ä½¿ç”¨ set-user-ID æƒé™ä½è¿”å› `Permission denied`ã€‚ç¬¬äºŒæ¬¡è¾“å‡ºä½¿ç”¨ `setreuid()` ç³»ç»Ÿè°ƒç”¨ï¼Œå°† euid çš„å€¼ä»£æ›¿ ruid çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå› æ­¤ ruid ä¹Ÿè¿”å› 1001ï¼Œæ­¤æ—¶è¯¥è¿›ç¨‹å¯è¯»å–å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œä½†è¯·æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„çš„ ruid æ˜¯ setreuid() ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºï¼Œä» kernel çš„è§’åº¦æ¥çœ‹ ruid ä¾ç„¶æ˜¯å®é™…è¿è¡Œè¿›ç¨‹çš„ UIDï¼Œå³ä¸º godev(1000)ã€‚\n- å› æ­¤ï¼Œè‹¥è¦å®ç° shell è„šæœ¬ç›¸åŒçš„æ•ˆæœï¼Œå¯ä½¿ç”¨ `fopen()` ä¸ `fread()` å‡½æ•°å°†ä»¥ä¸Šæºç æ›´æ”¹ä¸ºåä¸º [process-cred-sample-adv.c](https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample-adv.c) ç¨‹åºï¼š\n  ```c\n  #define _GNU_SOURCE\n  #include <stdio.h>\n  #include <stdlib.h>\n  #include <string.h>\n  #include <unistd.h>\n  #include <sys/types.h>\n  \n  #define BUFF_SIZE 100\n  \n  void read_file() {\n      FILE *fp;\n      char buffer[BUFF_SIZE];\n  \n      /* Open file for both reading and writing */\n      fp = fopen(\"file-read-only-by-sysadmin\", \"r\");\n      /* Read and display data */\n      fread(buffer, BUFF_SIZE - 1, sizeof(char), fp);\n      printf(\"%s\\n\", buffer);\n      fclose(fp);\n  }\n  \n  int main()\n  {\n      uid_t ruid, euid, suid;\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      read_file();  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      setreuid(geteuid(), geteuid());\n      getresuid(&ruid, &euid, &suid);\n      printf(\"RUID: %d, EUID: %d, SUID: %d\\n\", ruid, euid, suid);\n      read_file();  // file-read-only-by-sysadmin: -r-------- sysadmin sysadmin\n      return 0;\n  }\n  ```\n  åŒæ ·ç¼–è¯‘ç¨‹åºï¼Œæ›´æ”¹å¯æ‰§è¡Œæ–‡ä»¶æ‰€æœ‰è€…å¹¶æ·»åŠ  set-user-ID æƒé™ä½ï¼š\n  ```bash\n  $ gcc -o process-cred-sample-adv process-cred-sample-adv.c\n  $ sudo chown sysadmin:godev process-cred-sample-adv\n  $ sudo chmod u+s process-cred-sample-adv\n  $ ./process-cred-sample-adv\n    RUID: 1000, EUID: 1001, SUID: 1001  # ç¬¬ä¸€æ¬¡è¾“å‡º\n    Test\n  \n    RUID: 1001, EUID: 1001, SUID: 1001  # ç¬¬äºŒæ¬¡è¾“å‡º\n    Test\n  ```\n  ç¬¬ä¸€æ¬¡è¾“å‡ºç”±äºç›´æ¥ä½¿ç”¨ fopen() ä¸ fread() å‡½æ•°ä¸” euid æ›´æ”¹ä¸º 1001ï¼Œå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œç¬¬äºŒæ¬¡è¾“å‡ºé€šè¿‡ setreuid() ç³»ç»Ÿè°ƒç”¨å°† ruid ä¸ euid éƒ½è®¾ç½®ä¸º 1001ï¼Œä¹Ÿå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œå› æ­¤å¯¹äºç³»ç»Ÿèµ„æºçš„è®¿é—®å–å†³äº `euid`ã€‚\n- ä»¥ä¸ŠéªŒè¯æºç ä¸æ–‡ä»¶çš„æƒé™å¦‚ä¸‹æ‰€ç¤ºï¼š![](linux-ruid-euid-test.png)\n\n### å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\n- ä½¿ç”¨ Audit å®¡è®¡ç³»ç»Ÿè¿‡ç¨‹ä¸­å¯¹æ–‡ä»¶ã€ç›®å½•æˆ–ç³»ç»Ÿè°ƒç”¨çš„å®¡è®¡ç»“æœä»¥å®¡è®¡æ—¥å¿—çš„æ–¹å¼å‘ˆç°ï¼Œåœ¨ä¼—å¤šçš„ type=SYSCALL ç±»å‹å®¡è®¡æ—¥å¿—ä¸­åŒ…å«äº†å¤§é‡çš„ auidã€uidã€euidã€suid ç­‰çš„ä¿¡æ¯ã€‚\n- ä»¥ä¸‹å°†å®¡è®¡ä¸Šè¿° process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿›ä¸€æ­¥ç†è§£å„ç±» UID çš„ä½œç”¨ï¼š  \n  ```bash\n  $ sudo apt-get install -y auditd\n  # å®‰è£… auditd è½¯ä»¶åŒ…\n  $ sudo systemctl enable --now auditd.service\n  # å¯åŠ¨ auditd.service å®ˆæŠ¤è¿›ç¨‹\n  $ sudo auditctl -w ~/backup/ruid-euid-suid-test/process-cred-sample-adv \\\n    -p x -k new-uid-adv\n  # æ·»åŠ åä¸º new-uid-adv æœç´¢å…³é”®å­—çš„å®¡è®¡è§„åˆ™ï¼Œç›‘æ§å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæƒé™å±æ€§ï¼Œæ—¥å¿—å°†å†™å…¥\n  # /var/log/audit/audit.log ä¸­\n  $ sudo auditctl -l\n    -w /home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv -p x -k new-uid-adv\n  $ ./process-cred-sample-adv\n  $ sudo ausearch -i -k new-uid-adv\n    type=PROCTITLE msg=audit(01/26/2023 13:47:38.727:1185) : proctitle=./process-cred-sample-adv \n    type=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=1 name=/lib64/ld-linux-x86-64.so.2 \n    inode=403317285 dev=08:02 mode=file,755 ouid=root ogid=root rdev=00:00 nametype=NORMAL cap_fp=none \n    cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 \n    type=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=0 name=./process-cred-sample-adv \n    inode=137438286 dev=08:03 mode=file,suid,775 ouid=sysadmin ogid=godev rdev=00:00 nametype=NORMAL \n    cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 \n    type=CWD msg=audit(01/26/2023 13:47:38.727:1185) : cwd=/home/godev/backup/ruid-euid-suid-test \n    type=EXECVE msg=audit(01/26/2023 13:47:38.727:1185) : argc=1 a0=./process-cred-sample-adv \n    type=SYSCALL msg=audit(01/26/2023 13:47:38.727:1185) : arch=x86_64 syscall=execve success=yes \n    exit=0 a0=0x55e64d0712b0 a1=0x55e64d1fab50 a2=0x55e64d1ed380 a3=0x8 items=2 ppid=22490 pid=41229 \n    auid=godev uid=godev gid=godev euid=sysadmin suid=sysadmin fsuid=sysadmin egid=godev sgid=godev \n    fsgid=godev tty=pts3 ses=4 comm=process-cred-sa exe=/home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv \n    subj=unconfined key=new-uid-adv\n  ```\n  åœ¨æ‰§è¡Œ process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶åï¼Œä½¿ç”¨ `ausearch` æŸ¥æ‰¾å¯¹åº”çš„æ‰§è¡Œæ—¥å¿—ï¼Œå…¶ä¸­ `type=SYSCALL` ä¸­ `uid=godev` ä¸º kernel ç¡®å®šçš„ ruid å€¼ 1000(godev)ï¼Œè™½ç„¶åœ¨ process-cred-sample-adv è¿›ç¨‹è¿”å›ä¸­ ruid ä¸º 1001ï¼Œä½†è¯¥å€¼ä¸º setreuid() ç³»ç»Ÿè°ƒç”¨é‡æ–°è®¾ç½®çš„å€¼ï¼ŒçœŸå®çš„ ruid ä¾ç„¶ä¸º 1000(godev)ã€‚`euid=sysadmin` ä¸ `suid=sysadmin` çš„ç»“æœä¸è¿›ç¨‹è¿”å›çš„ç»“æœå®Œå…¨ä¸€è‡´ã€‚\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [credentials(7) - Linux man page](https://linux.die.net/man/7/credentials)\n- [setreuid(2) - Linux manual page](https://man7.org/linux/man-pages/man2/setregid.2.html)\n- [Difference between Real User ID, Effective User ID and Saved User ID](https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id)\n- [æ·±åˆ»ç†è§£ - real user id, effective user id, saved user id in Linux](https://blog.csdn.net/fmeng23/article/details/23115989?spm=1001.2101.3001.6650.4&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&utm_relevant_index=5)\n- [ã€ŠLinux/Unix ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ï¼ˆä¸Šå†Œï¼‰- ç¬¬9ç«  è¿›ç¨‹å‡­è¯ï¼ˆæå–ç ï¼šwop8ï¼‰](https://pan.baidu.com/s/1DX8AEVBqepVDp3tiR06nBQ)\n- [ruid, euid, suid usage in Linux](https://mudongliang.github.io/2020/09/17/ruid-euid-suid-usage-in-linux.html)\n","slug":"linux-process-uid","published":1,"updated":"2023-01-28T09:40:27.275Z","_id":"cldfonoky000a16vd2mlvz048","comments":1,"layout":"post","photos":[],"link":"","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼š<code>Ubuntu 20.04.3 LTS</code></li>\n<li>kernel ç‰ˆæœ¬ï¼š<code>5.15.0-57-generic</code></li>\n<li>Linux ä¸­å„ç±» UID çš„è”ç³»ä¸åŒºåˆ«å¯¹äºç†è§£è¿›ç¨‹æƒé™ä¸ Audit å®¡è®¡ç³»ç»Ÿå‘æŒ¥è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œè¿™äº› UID ä½œä¸ºè¿›ç¨‹å‡­è¯ã€‚</li>\n<li>âœ å¯å‚è€ƒ <code>man 7 credentials</code> æ‰‹å†Œä¸­çš„è¯´æ˜åŠ ä»¥ç†è§£ã€‚</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>å„ç±» UID çš„è§£æ</li>\n<li>ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»</li>\n<li>ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹</li>\n<li>å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"å„ç±»-UID-çš„è§£æï¼š\"><a href=\"#å„ç±»-UID-çš„è§£æï¼š\" class=\"headerlink\" title=\"å„ç±» UID çš„è§£æï¼š\"></a>å„ç±» UID çš„è§£æï¼š</h3><ul>\n<li>user IDï¼š  <ul>\n<li>å¸¸è§„ Linux ç”¨æˆ· IDï¼Œä½œä¸ºç³»ç»Ÿä¸­ç”¨æˆ·çš„å”¯ä¸€è¯†åˆ«ç¬¦ã€‚</li>\n</ul>\n</li>\n<li>Real user IDï¼ˆ<code>ruid</code>ï¼‰ï¼š  <ul>\n<li>çœŸå®ç”¨æˆ· ID  </li>\n<li>ğŸ¤˜ ruid ä¸ºæ‹¥æœ‰å½“å‰è¿›ç¨‹çš„ç”¨æˆ· IDï¼Œå³è°ƒç”¨è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ç”¨æˆ·ã€‚  </li>\n<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åˆç™»å½• Shell çš„ user ID ä¸ ruid ç›¸åŒï¼Œä½†æ˜¯è¯¥ç™»å½•ç”¨æˆ·æœ‰å¯èƒ½é€šè¿‡ su æˆ– sudo ææƒä¸ºå…¶ä»–éç‰¹æƒç”¨æˆ·æˆ–ç‰¹æƒç”¨æˆ·ï¼Œæ­¤æ—¶çš„ ruid ä¸æœ€åˆçš„ç™»å½• user ID ä¸åŒã€‚</li>\n</ul>\n</li>\n<li><p>Effective user IDï¼ˆ<code>euid</code>ï¼‰ï¼š  </p>\n<ul>\n<li>æœ‰æ•ˆç”¨æˆ· ID  </li>\n<li>ğŸ¤˜ euid è¢«å†…æ ¸ä½¿ç”¨ç¡®å®šè¿›ç¨‹å¯è®¿é—®èµ„æºçš„æƒé™  </li>\n<li>è¿›ç¨‹çš„æƒé™ç”±ä¿å­˜åœ¨ euid ä¸­çš„ UID æ¥å†³å®š  </li>\n<li>é€šå¸¸è€Œè¨€ï¼Œè¿›ç¨‹çš„ ruid ä¸ euid ä¿æŒä¸€è‡´ï¼Œruid ä¸ euid å¯¹è¿›ç¨‹è€Œè¨€ã€‚  </li>\n<li>euid ä¸´æ—¶å­˜å‚¨äº†å¦ä¸€ä¸ªç”¨æˆ·çš„ UID  </li>\n<li>ğŸš€ euid åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¸æ‰§è¡Œ set-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºæ—¶è¢«ä¿®æ”¹ã€‚  </li>\n<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œset-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶å…¶æœ¬èº«ä¹Ÿéœ€è¦è®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰åï¼Œeuid è¢«æ›´æ”¹ä¸ºä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰€æœ‰è€…ï¼ˆownerï¼‰UID ç›¸åŒï¼Œè€Œæœªè®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œeuid ä¾ç„¶ä¸ ruid ä¿æŒä¸€è‡´ï¼Œå¯å‚è§ä¸‹æ–‡ â€œruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹â€ éƒ¨åˆ†ã€‚  </li>\n<li>set-user-ID æƒé™ä½æŒ‡çš„æ˜¯ Linux ä¸­çš„ç‰¹æ®Šæƒé™ suid</li>\n<li>privileged åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­éœ€åŠ ä»¥è¾¨åˆ«ï¼Œå¯èƒ½æ˜¯ç‰¹æƒç”¨æˆ· rootï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ™®é€šç”¨æˆ·ã€‚</li>\n</ul>\n</li>\n<li><p>Saved set-user-IDï¼š  </p>\n<ul>\n<li>ä¿å­˜è®¾ç½®ç”¨æˆ· ID  </li>\n<li>ğŸš€ è¯¥ ID ç›¸å½“äºä¸€ä¸ª <code>buffer</code>ï¼Œåœ¨è¿›ç¨‹å¯åŠ¨åï¼Œå®ƒä¼šä» euid æ‹·è´ä¿¡æ¯åˆ°è‡ªèº«ã€‚å¯¹äºé root ç”¨æˆ·ï¼Œå¯ä»¥åœ¨æœªæ¥ä½¿ç”¨ <code>setuid()</code> ç³»ç»Ÿè°ƒç”¨æ¥å°† euid è®¾ç½®æˆä¸º ruid å’Œ saved set-user-ID ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚ä½†æ˜¯é root ç”¨æˆ·æ˜¯ä¸å…è®¸ç”¨ setuid() å°† euid è®¾ç½®æˆä¸ºä»»ä½•ç¬¬ä¸‰ä¸ª user IDã€‚</li>\n</ul>\n</li>\n<li>Audit user IDï¼ˆ<code>auid</code>ï¼‰ï¼š  <ul>\n<li>å®¡è®¡ç”¨æˆ· IDï¼Œç”¨äºè®°å½• Linux Audit å®¡è®¡ç³»ç»Ÿä¸­çš„ç”¨æˆ·æ ‡è¯†ã€‚  </li>\n<li>auid ä¸ºæœ€åˆç™»å½• Shell çš„çš„ç”¨æˆ· ID</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ruidã€euid-ä¸-Saved-set-user-ID-é—´çš„å…³ç³»ï¼š\"><a href=\"#ruidã€euid-ä¸-Saved-set-user-ID-é—´çš„å…³ç³»ï¼š\" class=\"headerlink\" title=\"ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»ï¼š\"></a>ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»ï¼š</h3><ul>\n<li>è¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ä¸‰è€…çš„èµ‹å€¼å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src=\"linux-process-uid-mapping.png\" alt>  <ul>\n<li>1ï¸âƒ£2ï¸âƒ£ å‡å®šæœ€åˆç™»å½• Shell çš„ç”¨æˆ·å¯åŠ¨è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨è¿›ç¨‹ã€‚  </li>\n<li>3ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ <code>ruid/rgid</code> ä¸ºå½“å‰ç”¨æˆ·çš„ uid/gid  </li>\n<li>4ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ <code>euid/egid</code>ï¼Œæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„ <code>set-user-ID</code> ä¸ <code>set-group-ID</code> æƒé™ä½è¿›è¡Œè®¾ç½®ï¼Œå›¾ä¸­çº¢è‰² 0 è¡¨ç¤ºå…³é—­ï¼Œç´«è‰² 1 è¡¨ç¤ºå¼€å¯ã€‚ä¸º 1 æ—¶ï¼Œå°†è¿›ç¨‹çš„ euid/egid è®¾ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„ uid/gidï¼Œå¦åˆ™ä» ruid/rgid æ‹·è´ã€‚</li>\n</ul>\n</li>\n<li>ä»¥ä¸Šè¿‡ç¨‹å¯æ€»ç»“ä¸ºä¸‹è¡¨ï¼š<img src=\"linux-process-uid-table.png\" alt></li>\n</ul>\n<h3 id=\"ğŸš€-ruid-ä¸-euid-çš„éªŒè¯ç¤ºä¾‹ï¼š\"><a href=\"#ğŸš€-ruid-ä¸-euid-çš„éªŒè¯ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"ğŸš€ ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹ï¼š\"></a>ğŸš€ ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹ï¼š</h3><ul>\n<li><p>éœ€è¦æ³¨æ„çš„æ˜¯ Linux ç³»ç»Ÿä¸­ set-user-ID ä¸ set-group-ID æƒé™ä½å¯¹ shell è„šæœ¬æ— æ•ˆï¼Œå¦‚ä¸‹ <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample.c\" target=\"_blank\" rel=\"noopener\">process-cred-sample.c</a> ç¨‹åºæ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">uid_t</span> ruid, euid, suid;</span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    system(<span class=\"string\">\"cat file-read-only-by-sysadmin\"</span>);  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    setreuid(geteuid(), geteuid());  <span class=\"comment\">// use euid to set ruid</span></span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    system(<span class=\"string\">\"cat file-read-only-by-sysadmin\"</span>);  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Šç¨‹åºä¸­è·å–å½“å‰è¿›ç¨‹çš„ ruidã€euid ä¸ suidï¼Œä½†æ˜¯ <code>system()</code> å‡½æ•°è°ƒç”¨äº† shell è„šæœ¬ï¼Œå³ä½¿å°†è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½å¼€å¯ä¹Ÿæ— æ³•ä½¿ç”¨æ­¤æƒé™ä½ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ id</span><br><span class=\"line\">  uid=1000(godev) gid=1000(godev) groups=1000(godev)</span><br><span class=\"line\"><span class=\"comment\"># ç¬”è€…ç¤ºä¾‹ä½¿ç”¨ godev æ™®é€šç”¨æˆ·éªŒè¯</span></span><br><span class=\"line\">$ id -u sysadmin</span><br><span class=\"line\">  1001</span><br><span class=\"line\">$ ls -lh file-read-only-by-sysadmin </span><br><span class=\"line\">  -r-------- 1 sysadmin sysadmin 5 Jan 24 17:08 file-read-only-by-sysadmin</span><br><span class=\"line\"><span class=\"comment\"># å½“å‰ç›®å½•ä¸­å…ˆåˆ›å»ºè¯¥æ–‡ä»¶ï¼Œå…¶ä¸­ Test ä½œä¸ºæ–‡æœ¬å†…å®¹ã€‚</span></span><br><span class=\"line\">$ gcc -o process-cred-sample process-cred-sample.c</span><br><span class=\"line\">$ sudo chown sysadmin:godev process-cred-sample</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ”¹å¯æ‰§è¡Œç¨‹åºçš„æ‰€æœ‰è€…ï¼Œsysadmin ä¸ºç³»ç»Ÿä¸Šçš„å¦ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚</span></span><br><span class=\"line\">$ ./process-cred-sample</span><br><span class=\"line\">  RUID: 1000, EUID: 1000, SUID: 1000</span><br><span class=\"line\">  cat: file-read-only-by-sysadmin: Permission denied</span><br><span class=\"line\">  RUID: 1000, EUID: 1000, SUID: 1000</span><br><span class=\"line\">  cat: file-read-only-by-sysadmin: Permission denied</span><br><span class=\"line\"><span class=\"comment\"># ç”±äºå¯æ‰§è¡Œæ–‡ä»¶ä¸å…·æœ‰ set-user-ID æƒé™ä½è€Œæ— æ³•æ›´æ”¹ euid</span></span><br><span class=\"line\">$ sudo chmod u+s process-cred-sample</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½</span></span><br><span class=\"line\">$ ls -lh process-cred-sample</span><br><span class=\"line\">-rwsrwxr-x 1 sysadmin godev 17K Jan 25 23:19 process-cred-sample</span><br><span class=\"line\">$ ./process-cred-sample</span><br><span class=\"line\">  RUID: 1000, EUID: 1001, SUID: 1001</span><br><span class=\"line\">  cat: file-read-only-by-sysadmin: Permission denied  <span class=\"comment\"># ç¬¬ä¸€æ¬¡è¾“å‡º</span></span><br><span class=\"line\">  RUID: 1001, EUID: 1001, SUID: 1001</span><br><span class=\"line\">  Test  <span class=\"comment\"># ç¬¬äºŒæ¬¡è¾“å‡º</span></span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Šå‘½ä»¤ç¬¬ä¸€æ¬¡è¾“å‡ºè°ƒç”¨ shell è„šæœ¬è€Œæ— æ³•ä½¿ç”¨ set-user-ID æƒé™ä½è¿”å› <code>Permission denied</code>ã€‚ç¬¬äºŒæ¬¡è¾“å‡ºä½¿ç”¨ <code>setreuid()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå°† euid çš„å€¼ä»£æ›¿ ruid çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå› æ­¤ ruid ä¹Ÿè¿”å› 1001ï¼Œæ­¤æ—¶è¯¥è¿›ç¨‹å¯è¯»å–å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œä½†è¯·æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„çš„ ruid æ˜¯ setreuid() ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºï¼Œä» kernel çš„è§’åº¦æ¥çœ‹ ruid ä¾ç„¶æ˜¯å®é™…è¿è¡Œè¿›ç¨‹çš„ UIDï¼Œå³ä¸º godev(1000)ã€‚</p>\n</li>\n<li><p>å› æ­¤ï¼Œè‹¥è¦å®ç° shell è„šæœ¬ç›¸åŒçš„æ•ˆæœï¼Œå¯ä½¿ç”¨ <code>fopen()</code> ä¸ <code>fread()</code> å‡½æ•°å°†ä»¥ä¸Šæºç æ›´æ”¹ä¸ºåä¸º <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample-adv.c\" target=\"_blank\" rel=\"noopener\">process-cred-sample-adv.c</a> ç¨‹åºï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> BUFF_SIZE 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">read_file</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buffer[BUFF_SIZE];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Open file for both reading and writing */</span></span><br><span class=\"line\">    fp = fopen(<span class=\"string\">\"file-read-only-by-sysadmin\"</span>, <span class=\"string\">\"r\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">/* Read and display data */</span></span><br><span class=\"line\">    fread(buffer, BUFF_SIZE - <span class=\"number\">1</span>, <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">char</span>), fp);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\\n\"</span>, buffer);</span><br><span class=\"line\">    fclose(fp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">uid_t</span> ruid, euid, suid;</span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    read_file();  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    setreuid(geteuid(), geteuid());</span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    read_file();  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åŒæ ·ç¼–è¯‘ç¨‹åºï¼Œæ›´æ”¹å¯æ‰§è¡Œæ–‡ä»¶æ‰€æœ‰è€…å¹¶æ·»åŠ  set-user-ID æƒé™ä½ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gcc -o process-cred-sample-adv process-cred-sample-adv.c</span><br><span class=\"line\">$ sudo chown sysadmin:godev process-cred-sample-adv</span><br><span class=\"line\">$ sudo chmod u+s process-cred-sample-adv</span><br><span class=\"line\">$ ./process-cred-sample-adv</span><br><span class=\"line\">  RUID: 1000, EUID: 1001, SUID: 1001  <span class=\"comment\"># ç¬¬ä¸€æ¬¡è¾“å‡º</span></span><br><span class=\"line\">  Test</span><br><span class=\"line\"></span><br><span class=\"line\">  RUID: 1001, EUID: 1001, SUID: 1001  <span class=\"comment\"># ç¬¬äºŒæ¬¡è¾“å‡º</span></span><br><span class=\"line\">  Test</span><br></pre></td></tr></table></figure>\n<p>ç¬¬ä¸€æ¬¡è¾“å‡ºç”±äºç›´æ¥ä½¿ç”¨ fopen() ä¸ fread() å‡½æ•°ä¸” euid æ›´æ”¹ä¸º 1001ï¼Œå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œç¬¬äºŒæ¬¡è¾“å‡ºé€šè¿‡ setreuid() ç³»ç»Ÿè°ƒç”¨å°† ruid ä¸ euid éƒ½è®¾ç½®ä¸º 1001ï¼Œä¹Ÿå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œå› æ­¤å¯¹äºç³»ç»Ÿèµ„æºçš„è®¿é—®å–å†³äº <code>euid</code>ã€‚</p>\n</li>\n<li>ä»¥ä¸ŠéªŒè¯æºç ä¸æ–‡ä»¶çš„æƒé™å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"linux-ruid-euid-test.png\" alt></li>\n</ul>\n<h3 id=\"å„ç±»-UID-åœ¨-Audit-å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\"><a href=\"#å„ç±»-UID-åœ¨-Audit-å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\" class=\"headerlink\" title=\"å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\"></a>å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š</h3><ul>\n<li>ä½¿ç”¨ Audit å®¡è®¡ç³»ç»Ÿè¿‡ç¨‹ä¸­å¯¹æ–‡ä»¶ã€ç›®å½•æˆ–ç³»ç»Ÿè°ƒç”¨çš„å®¡è®¡ç»“æœä»¥å®¡è®¡æ—¥å¿—çš„æ–¹å¼å‘ˆç°ï¼Œåœ¨ä¼—å¤šçš„ type=SYSCALL ç±»å‹å®¡è®¡æ—¥å¿—ä¸­åŒ…å«äº†å¤§é‡çš„ auidã€uidã€euidã€suid ç­‰çš„ä¿¡æ¯ã€‚</li>\n<li><p>ä»¥ä¸‹å°†å®¡è®¡ä¸Šè¿° process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿›ä¸€æ­¥ç†è§£å„ç±» UID çš„ä½œç”¨ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo apt-get install -y auditd</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… auditd è½¯ä»¶åŒ…</span></span><br><span class=\"line\">$ sudo systemctl <span class=\"built_in\">enable</span> --now auditd.service</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ auditd.service å®ˆæŠ¤è¿›ç¨‹</span></span><br><span class=\"line\">$ sudo auditctl -w ~/backup/ruid-euid-suid-test/process-cred-sample-adv \\</span><br><span class=\"line\">  -p x -k new-uid-adv</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ åä¸º new-uid-adv æœç´¢å…³é”®å­—çš„å®¡è®¡è§„åˆ™ï¼Œç›‘æ§å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæƒé™å±æ€§ï¼Œæ—¥å¿—å°†å†™å…¥</span></span><br><span class=\"line\"><span class=\"comment\"># /var/log/audit/audit.log ä¸­</span></span><br><span class=\"line\">$ sudo auditctl -l</span><br><span class=\"line\">  -w /home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv -p x -k new-uid-adv</span><br><span class=\"line\">$ ./process-cred-sample-adv</span><br><span class=\"line\">$ sudo ausearch -i -k new-uid-adv</span><br><span class=\"line\">  <span class=\"built_in\">type</span>=PROCTITLE msg=audit(01/26/2023 13:47:38.727:1185) : proctitle=./process-cred-sample-adv </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=1 name=/lib64/ld-linux-x86-64.so.2 </span><br><span class=\"line\">  inode=403317285 dev=08:02 mode=file,755 ouid=root ogid=root rdev=00:00 nametype=NORMAL cap_fp=none </span><br><span class=\"line\">  cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=0 name=./process-cred-sample-adv </span><br><span class=\"line\">  inode=137438286 dev=08:03 mode=file,suid,775 ouid=sysadmin ogid=godev rdev=00:00 nametype=NORMAL </span><br><span class=\"line\">  cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=CWD msg=audit(01/26/2023 13:47:38.727:1185) : cwd=/home/godev/backup/ruid-euid-suid-test </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=EXECVE msg=audit(01/26/2023 13:47:38.727:1185) : argc=1 a0=./process-cred-sample-adv </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=SYSCALL msg=audit(01/26/2023 13:47:38.727:1185) : arch=x86_64 syscall=execve success=yes </span><br><span class=\"line\">  <span class=\"built_in\">exit</span>=0 a0=0x55e64d0712b0 a1=0x55e64d1fab50 a2=0x55e64d1ed380 a3=0x8 items=2 ppid=22490 pid=41229 </span><br><span class=\"line\">  auid=godev uid=godev gid=godev euid=sysadmin suid=sysadmin fsuid=sysadmin egid=godev sgid=godev </span><br><span class=\"line\">  fsgid=godev tty=pts3 ses=4 comm=process-cred-sa exe=/home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv </span><br><span class=\"line\">  subj=unconfined key=new-uid-adv</span><br></pre></td></tr></table></figure>\n<p>åœ¨æ‰§è¡Œ process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶åï¼Œä½¿ç”¨ <code>ausearch</code> æŸ¥æ‰¾å¯¹åº”çš„æ‰§è¡Œæ—¥å¿—ï¼Œå…¶ä¸­ <code>type=SYSCALL</code> ä¸­ <code>uid=godev</code> ä¸º kernel ç¡®å®šçš„ ruid å€¼ 1000(godev)ï¼Œè™½ç„¶åœ¨ process-cred-sample-adv è¿›ç¨‹è¿”å›ä¸­ ruid ä¸º 1001ï¼Œä½†è¯¥å€¼ä¸º setreuid() ç³»ç»Ÿè°ƒç”¨é‡æ–°è®¾ç½®çš„å€¼ï¼ŒçœŸå®çš„ ruid ä¾ç„¶ä¸º 1000(godev)ã€‚<code>euid=sysadmin</code> ä¸ <code>suid=sysadmin</code> çš„ç»“æœä¸è¿›ç¨‹è¿”å›çš„ç»“æœå®Œå…¨ä¸€è‡´ã€‚</p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://linux.die.net/man/7/credentials\" target=\"_blank\" rel=\"noopener\">credentials(7) - Linux man page</a></li>\n<li><a href=\"https://man7.org/linux/man-pages/man2/setregid.2.html\" target=\"_blank\" rel=\"noopener\">setreuid(2) - Linux manual page</a></li>\n<li><a href=\"https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id\" target=\"_blank\" rel=\"noopener\">Difference between Real User ID, Effective User ID and Saved User ID</a></li>\n<li><a href=\"https://blog.csdn.net/fmeng23/article/details/23115989?spm=1001.2101.3001.6650.4&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&amp;utm_relevant_index=5\" target=\"_blank\" rel=\"noopener\">æ·±åˆ»ç†è§£ - real user id, effective user id, saved user id in Linux</a></li>\n<li><a href=\"https://pan.baidu.com/s/1DX8AEVBqepVDp3tiR06nBQ\" target=\"_blank\" rel=\"noopener\">ã€ŠLinux/Unix ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ï¼ˆä¸Šå†Œï¼‰- ç¬¬9ç«  è¿›ç¨‹å‡­è¯ï¼ˆæå–ç ï¼šwop8ï¼‰</a></li>\n<li><a href=\"https://mudongliang.github.io/2020/09/17/ruid-euid-suid-usage-in-linux.html\" target=\"_blank\" rel=\"noopener\">ruid, euid, suid usage in Linux</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼š<code>Ubuntu 20.04.3 LTS</code></li>\n<li>kernel ç‰ˆæœ¬ï¼š<code>5.15.0-57-generic</code></li>\n<li>Linux ä¸­å„ç±» UID çš„è”ç³»ä¸åŒºåˆ«å¯¹äºç†è§£è¿›ç¨‹æƒé™ä¸ Audit å®¡è®¡ç³»ç»Ÿå‘æŒ¥è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œè¿™äº› UID ä½œä¸ºè¿›ç¨‹å‡­è¯ã€‚</li>\n<li>âœ å¯å‚è€ƒ <code>man 7 credentials</code> æ‰‹å†Œä¸­çš„è¯´æ˜åŠ ä»¥ç†è§£ã€‚</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>å„ç±» UID çš„è§£æ</li>\n<li>ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»</li>\n<li>ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹</li>\n<li>å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"å„ç±»-UID-çš„è§£æï¼š\"><a href=\"#å„ç±»-UID-çš„è§£æï¼š\" class=\"headerlink\" title=\"å„ç±» UID çš„è§£æï¼š\"></a>å„ç±» UID çš„è§£æï¼š</h3><ul>\n<li>user IDï¼š  <ul>\n<li>å¸¸è§„ Linux ç”¨æˆ· IDï¼Œä½œä¸ºç³»ç»Ÿä¸­ç”¨æˆ·çš„å”¯ä¸€è¯†åˆ«ç¬¦ã€‚</li>\n</ul>\n</li>\n<li>Real user IDï¼ˆ<code>ruid</code>ï¼‰ï¼š  <ul>\n<li>çœŸå®ç”¨æˆ· ID  </li>\n<li>ğŸ¤˜ ruid ä¸ºæ‹¥æœ‰å½“å‰è¿›ç¨‹çš„ç”¨æˆ· IDï¼Œå³è°ƒç”¨è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ç”¨æˆ·ã€‚  </li>\n<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åˆç™»å½• Shell çš„ user ID ä¸ ruid ç›¸åŒï¼Œä½†æ˜¯è¯¥ç™»å½•ç”¨æˆ·æœ‰å¯èƒ½é€šè¿‡ su æˆ– sudo ææƒä¸ºå…¶ä»–éç‰¹æƒç”¨æˆ·æˆ–ç‰¹æƒç”¨æˆ·ï¼Œæ­¤æ—¶çš„ ruid ä¸æœ€åˆçš„ç™»å½• user ID ä¸åŒã€‚</li>\n</ul>\n</li>\n<li><p>Effective user IDï¼ˆ<code>euid</code>ï¼‰ï¼š  </p>\n<ul>\n<li>æœ‰æ•ˆç”¨æˆ· ID  </li>\n<li>ğŸ¤˜ euid è¢«å†…æ ¸ä½¿ç”¨ç¡®å®šè¿›ç¨‹å¯è®¿é—®èµ„æºçš„æƒé™  </li>\n<li>è¿›ç¨‹çš„æƒé™ç”±ä¿å­˜åœ¨ euid ä¸­çš„ UID æ¥å†³å®š  </li>\n<li>é€šå¸¸è€Œè¨€ï¼Œè¿›ç¨‹çš„ ruid ä¸ euid ä¿æŒä¸€è‡´ï¼Œruid ä¸ euid å¯¹è¿›ç¨‹è€Œè¨€ã€‚  </li>\n<li>euid ä¸´æ—¶å­˜å‚¨äº†å¦ä¸€ä¸ªç”¨æˆ·çš„ UID  </li>\n<li>ğŸš€ euid åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ä¸æ‰§è¡Œ set-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºæ—¶è¢«ä¿®æ”¹ã€‚  </li>\n<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œset-user-ID ç¨‹åºæˆ– set-group-ID ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶å…¶æœ¬èº«ä¹Ÿéœ€è¦è®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰åï¼Œeuid è¢«æ›´æ”¹ä¸ºä¸å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰€æœ‰è€…ï¼ˆownerï¼‰UID ç›¸åŒï¼Œè€Œæœªè®¾ç½® set-user-ID æƒé™ä½ï¼ˆbitï¼‰çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œeuid ä¾ç„¶ä¸ ruid ä¿æŒä¸€è‡´ï¼Œå¯å‚è§ä¸‹æ–‡ â€œruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹â€ éƒ¨åˆ†ã€‚  </li>\n<li>set-user-ID æƒé™ä½æŒ‡çš„æ˜¯ Linux ä¸­çš„ç‰¹æ®Šæƒé™ suid</li>\n<li>privileged åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­éœ€åŠ ä»¥è¾¨åˆ«ï¼Œå¯èƒ½æ˜¯ç‰¹æƒç”¨æˆ· rootï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ™®é€šç”¨æˆ·ã€‚</li>\n</ul>\n</li>\n<li><p>Saved set-user-IDï¼š  </p>\n<ul>\n<li>ä¿å­˜è®¾ç½®ç”¨æˆ· ID  </li>\n<li>ğŸš€ è¯¥ ID ç›¸å½“äºä¸€ä¸ª <code>buffer</code>ï¼Œåœ¨è¿›ç¨‹å¯åŠ¨åï¼Œå®ƒä¼šä» euid æ‹·è´ä¿¡æ¯åˆ°è‡ªèº«ã€‚å¯¹äºé root ç”¨æˆ·ï¼Œå¯ä»¥åœ¨æœªæ¥ä½¿ç”¨ <code>setuid()</code> ç³»ç»Ÿè°ƒç”¨æ¥å°† euid è®¾ç½®æˆä¸º ruid å’Œ saved set-user-ID ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚ä½†æ˜¯é root ç”¨æˆ·æ˜¯ä¸å…è®¸ç”¨ setuid() å°† euid è®¾ç½®æˆä¸ºä»»ä½•ç¬¬ä¸‰ä¸ª user IDã€‚</li>\n</ul>\n</li>\n<li>Audit user IDï¼ˆ<code>auid</code>ï¼‰ï¼š  <ul>\n<li>å®¡è®¡ç”¨æˆ· IDï¼Œç”¨äºè®°å½• Linux Audit å®¡è®¡ç³»ç»Ÿä¸­çš„ç”¨æˆ·æ ‡è¯†ã€‚  </li>\n<li>auid ä¸ºæœ€åˆç™»å½• Shell çš„çš„ç”¨æˆ· ID</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ruidã€euid-ä¸-Saved-set-user-ID-é—´çš„å…³ç³»ï¼š\"><a href=\"#ruidã€euid-ä¸-Saved-set-user-ID-é—´çš„å…³ç³»ï¼š\" class=\"headerlink\" title=\"ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»ï¼š\"></a>ruidã€euid ä¸ Saved set-user-ID é—´çš„å…³ç³»ï¼š</h3><ul>\n<li>è¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ä¸‰è€…çš„èµ‹å€¼å…³ç³»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src=\"linux-process-uid-mapping.png\" alt>  <ul>\n<li>1ï¸âƒ£2ï¸âƒ£ å‡å®šæœ€åˆç™»å½• Shell çš„ç”¨æˆ·å¯åŠ¨è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨è¿›ç¨‹ã€‚  </li>\n<li>3ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ <code>ruid/rgid</code> ä¸ºå½“å‰ç”¨æˆ·çš„ uid/gid  </li>\n<li>4ï¸âƒ£ è®¾ç½®è¿›ç¨‹çš„ <code>euid/egid</code>ï¼Œæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶çš„ <code>set-user-ID</code> ä¸ <code>set-group-ID</code> æƒé™ä½è¿›è¡Œè®¾ç½®ï¼Œå›¾ä¸­çº¢è‰² 0 è¡¨ç¤ºå…³é—­ï¼Œç´«è‰² 1 è¡¨ç¤ºå¼€å¯ã€‚ä¸º 1 æ—¶ï¼Œå°†è¿›ç¨‹çš„ euid/egid è®¾ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„ uid/gidï¼Œå¦åˆ™ä» ruid/rgid æ‹·è´ã€‚</li>\n</ul>\n</li>\n<li>ä»¥ä¸Šè¿‡ç¨‹å¯æ€»ç»“ä¸ºä¸‹è¡¨ï¼š<img src=\"linux-process-uid-table.png\" alt></li>\n</ul>\n<h3 id=\"ğŸš€-ruid-ä¸-euid-çš„éªŒè¯ç¤ºä¾‹ï¼š\"><a href=\"#ğŸš€-ruid-ä¸-euid-çš„éªŒè¯ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"ğŸš€ ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹ï¼š\"></a>ğŸš€ ruid ä¸ euid çš„éªŒè¯ç¤ºä¾‹ï¼š</h3><ul>\n<li><p>éœ€è¦æ³¨æ„çš„æ˜¯ Linux ç³»ç»Ÿä¸­ set-user-ID ä¸ set-group-ID æƒé™ä½å¯¹ shell è„šæœ¬æ— æ•ˆï¼Œå¦‚ä¸‹ <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample.c\" target=\"_blank\" rel=\"noopener\">process-cred-sample.c</a> ç¨‹åºæ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">uid_t</span> ruid, euid, suid;</span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    system(<span class=\"string\">\"cat file-read-only-by-sysadmin\"</span>);  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    setreuid(geteuid(), geteuid());  <span class=\"comment\">// use euid to set ruid</span></span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    system(<span class=\"string\">\"cat file-read-only-by-sysadmin\"</span>);  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Šç¨‹åºä¸­è·å–å½“å‰è¿›ç¨‹çš„ ruidã€euid ä¸ suidï¼Œä½†æ˜¯ <code>system()</code> å‡½æ•°è°ƒç”¨äº† shell è„šæœ¬ï¼Œå³ä½¿å°†è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½å¼€å¯ä¹Ÿæ— æ³•ä½¿ç”¨æ­¤æƒé™ä½ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ id</span><br><span class=\"line\">  uid=1000(godev) gid=1000(godev) groups=1000(godev)</span><br><span class=\"line\"><span class=\"comment\"># ç¬”è€…ç¤ºä¾‹ä½¿ç”¨ godev æ™®é€šç”¨æˆ·éªŒè¯</span></span><br><span class=\"line\">$ id -u sysadmin</span><br><span class=\"line\">  1001</span><br><span class=\"line\">$ ls -lh file-read-only-by-sysadmin </span><br><span class=\"line\">  -r-------- 1 sysadmin sysadmin 5 Jan 24 17:08 file-read-only-by-sysadmin</span><br><span class=\"line\"><span class=\"comment\"># å½“å‰ç›®å½•ä¸­å…ˆåˆ›å»ºè¯¥æ–‡ä»¶ï¼Œå…¶ä¸­ Test ä½œä¸ºæ–‡æœ¬å†…å®¹ã€‚</span></span><br><span class=\"line\">$ gcc -o process-cred-sample process-cred-sample.c</span><br><span class=\"line\">$ sudo chown sysadmin:godev process-cred-sample</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ”¹å¯æ‰§è¡Œç¨‹åºçš„æ‰€æœ‰è€…ï¼Œsysadmin ä¸ºç³»ç»Ÿä¸Šçš„å¦ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚</span></span><br><span class=\"line\">$ ./process-cred-sample</span><br><span class=\"line\">  RUID: 1000, EUID: 1000, SUID: 1000</span><br><span class=\"line\">  cat: file-read-only-by-sysadmin: Permission denied</span><br><span class=\"line\">  RUID: 1000, EUID: 1000, SUID: 1000</span><br><span class=\"line\">  cat: file-read-only-by-sysadmin: Permission denied</span><br><span class=\"line\"><span class=\"comment\"># ç”±äºå¯æ‰§è¡Œæ–‡ä»¶ä¸å…·æœ‰ set-user-ID æƒé™ä½è€Œæ— æ³•æ›´æ”¹ euid</span></span><br><span class=\"line\">$ sudo chmod u+s process-cred-sample</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶çš„ set-user-ID æƒé™ä½</span></span><br><span class=\"line\">$ ls -lh process-cred-sample</span><br><span class=\"line\">-rwsrwxr-x 1 sysadmin godev 17K Jan 25 23:19 process-cred-sample</span><br><span class=\"line\">$ ./process-cred-sample</span><br><span class=\"line\">  RUID: 1000, EUID: 1001, SUID: 1001</span><br><span class=\"line\">  cat: file-read-only-by-sysadmin: Permission denied  <span class=\"comment\"># ç¬¬ä¸€æ¬¡è¾“å‡º</span></span><br><span class=\"line\">  RUID: 1001, EUID: 1001, SUID: 1001</span><br><span class=\"line\">  Test  <span class=\"comment\"># ç¬¬äºŒæ¬¡è¾“å‡º</span></span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Šå‘½ä»¤ç¬¬ä¸€æ¬¡è¾“å‡ºè°ƒç”¨ shell è„šæœ¬è€Œæ— æ³•ä½¿ç”¨ set-user-ID æƒé™ä½è¿”å› <code>Permission denied</code>ã€‚ç¬¬äºŒæ¬¡è¾“å‡ºä½¿ç”¨ <code>setreuid()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå°† euid çš„å€¼ä»£æ›¿ ruid çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå› æ­¤ ruid ä¹Ÿè¿”å› 1001ï¼Œæ­¤æ—¶è¯¥è¿›ç¨‹å¯è¯»å–å¯¹åº”çš„æ–‡ä»¶å†…å®¹ï¼Œä½†è¯·æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„çš„ ruid æ˜¯ setreuid() ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºï¼Œä» kernel çš„è§’åº¦æ¥çœ‹ ruid ä¾ç„¶æ˜¯å®é™…è¿è¡Œè¿›ç¨‹çš„ UIDï¼Œå³ä¸º godev(1000)ã€‚</p>\n</li>\n<li><p>å› æ­¤ï¼Œè‹¥è¦å®ç° shell è„šæœ¬ç›¸åŒçš„æ•ˆæœï¼Œå¯ä½¿ç”¨ <code>fopen()</code> ä¸ <code>fread()</code> å‡½æ•°å°†ä»¥ä¸Šæºç æ›´æ”¹ä¸ºåä¸º <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/ruid-euid-suid-test/process-cred-sample-adv.c\" target=\"_blank\" rel=\"noopener\">process-cred-sample-adv.c</a> ç¨‹åºï¼š</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> _GNU_SOURCE</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;unistd.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> BUFF_SIZE 100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">read_file</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    FILE *fp;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buffer[BUFF_SIZE];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Open file for both reading and writing */</span></span><br><span class=\"line\">    fp = fopen(<span class=\"string\">\"file-read-only-by-sysadmin\"</span>, <span class=\"string\">\"r\"</span>);</span><br><span class=\"line\">    <span class=\"comment\">/* Read and display data */</span></span><br><span class=\"line\">    fread(buffer, BUFF_SIZE - <span class=\"number\">1</span>, <span class=\"keyword\">sizeof</span>(<span class=\"keyword\">char</span>), fp);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\\n\"</span>, buffer);</span><br><span class=\"line\">    fclose(fp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">uid_t</span> ruid, euid, suid;</span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    read_file();  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    setreuid(geteuid(), geteuid());</span><br><span class=\"line\">    getresuid(&amp;ruid, &amp;euid, &amp;suid);</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"RUID: %d, EUID: %d, SUID: %d\\n\"</span>, ruid, euid, suid);</span><br><span class=\"line\">    read_file();  <span class=\"comment\">// file-read-only-by-sysadmin: -r-------- sysadmin sysadmin</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åŒæ ·ç¼–è¯‘ç¨‹åºï¼Œæ›´æ”¹å¯æ‰§è¡Œæ–‡ä»¶æ‰€æœ‰è€…å¹¶æ·»åŠ  set-user-ID æƒé™ä½ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ gcc -o process-cred-sample-adv process-cred-sample-adv.c</span><br><span class=\"line\">$ sudo chown sysadmin:godev process-cred-sample-adv</span><br><span class=\"line\">$ sudo chmod u+s process-cred-sample-adv</span><br><span class=\"line\">$ ./process-cred-sample-adv</span><br><span class=\"line\">  RUID: 1000, EUID: 1001, SUID: 1001  <span class=\"comment\"># ç¬¬ä¸€æ¬¡è¾“å‡º</span></span><br><span class=\"line\">  Test</span><br><span class=\"line\"></span><br><span class=\"line\">  RUID: 1001, EUID: 1001, SUID: 1001  <span class=\"comment\"># ç¬¬äºŒæ¬¡è¾“å‡º</span></span><br><span class=\"line\">  Test</span><br></pre></td></tr></table></figure>\n<p>ç¬¬ä¸€æ¬¡è¾“å‡ºç”±äºç›´æ¥ä½¿ç”¨ fopen() ä¸ fread() å‡½æ•°ä¸” euid æ›´æ”¹ä¸º 1001ï¼Œå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œç¬¬äºŒæ¬¡è¾“å‡ºé€šè¿‡ setreuid() ç³»ç»Ÿè°ƒç”¨å°† ruid ä¸ euid éƒ½è®¾ç½®ä¸º 1001ï¼Œä¹Ÿå¯è¯»å–å¯¹åº”æ–‡ä»¶çš„å†…å®¹ï¼Œå› æ­¤å¯¹äºç³»ç»Ÿèµ„æºçš„è®¿é—®å–å†³äº <code>euid</code>ã€‚</p>\n</li>\n<li>ä»¥ä¸ŠéªŒè¯æºç ä¸æ–‡ä»¶çš„æƒé™å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"linux-ruid-euid-test.png\" alt></li>\n</ul>\n<h3 id=\"å„ç±»-UID-åœ¨-Audit-å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\"><a href=\"#å„ç±»-UID-åœ¨-Audit-å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\" class=\"headerlink\" title=\"å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š\"></a>å„ç±» UID åœ¨ Audit å®¡è®¡ç³»ç»Ÿä¸­çš„è¯´æ˜ï¼š</h3><ul>\n<li>ä½¿ç”¨ Audit å®¡è®¡ç³»ç»Ÿè¿‡ç¨‹ä¸­å¯¹æ–‡ä»¶ã€ç›®å½•æˆ–ç³»ç»Ÿè°ƒç”¨çš„å®¡è®¡ç»“æœä»¥å®¡è®¡æ—¥å¿—çš„æ–¹å¼å‘ˆç°ï¼Œåœ¨ä¼—å¤šçš„ type=SYSCALL ç±»å‹å®¡è®¡æ—¥å¿—ä¸­åŒ…å«äº†å¤§é‡çš„ auidã€uidã€euidã€suid ç­‰çš„ä¿¡æ¯ã€‚</li>\n<li><p>ä»¥ä¸‹å°†å®¡è®¡ä¸Šè¿° process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿›ä¸€æ­¥ç†è§£å„ç±» UID çš„ä½œç”¨ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo apt-get install -y auditd</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… auditd è½¯ä»¶åŒ…</span></span><br><span class=\"line\">$ sudo systemctl <span class=\"built_in\">enable</span> --now auditd.service</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ auditd.service å®ˆæŠ¤è¿›ç¨‹</span></span><br><span class=\"line\">$ sudo auditctl -w ~/backup/ruid-euid-suid-test/process-cred-sample-adv \\</span><br><span class=\"line\">  -p x -k new-uid-adv</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ åä¸º new-uid-adv æœç´¢å…³é”®å­—çš„å®¡è®¡è§„åˆ™ï¼Œç›‘æ§å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæƒé™å±æ€§ï¼Œæ—¥å¿—å°†å†™å…¥</span></span><br><span class=\"line\"><span class=\"comment\"># /var/log/audit/audit.log ä¸­</span></span><br><span class=\"line\">$ sudo auditctl -l</span><br><span class=\"line\">  -w /home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv -p x -k new-uid-adv</span><br><span class=\"line\">$ ./process-cred-sample-adv</span><br><span class=\"line\">$ sudo ausearch -i -k new-uid-adv</span><br><span class=\"line\">  <span class=\"built_in\">type</span>=PROCTITLE msg=audit(01/26/2023 13:47:38.727:1185) : proctitle=./process-cred-sample-adv </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=1 name=/lib64/ld-linux-x86-64.so.2 </span><br><span class=\"line\">  inode=403317285 dev=08:02 mode=file,755 ouid=root ogid=root rdev=00:00 nametype=NORMAL cap_fp=none </span><br><span class=\"line\">  cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=PATH msg=audit(01/26/2023 13:47:38.727:1185) : item=0 name=./process-cred-sample-adv </span><br><span class=\"line\">  inode=137438286 dev=08:03 mode=file,suid,775 ouid=sysadmin ogid=godev rdev=00:00 nametype=NORMAL </span><br><span class=\"line\">  cap_fp=none cap_fi=none cap_fe=0 cap_fver=0 cap_frootid=0 </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=CWD msg=audit(01/26/2023 13:47:38.727:1185) : cwd=/home/godev/backup/ruid-euid-suid-test </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=EXECVE msg=audit(01/26/2023 13:47:38.727:1185) : argc=1 a0=./process-cred-sample-adv </span><br><span class=\"line\">  <span class=\"built_in\">type</span>=SYSCALL msg=audit(01/26/2023 13:47:38.727:1185) : arch=x86_64 syscall=execve success=yes </span><br><span class=\"line\">  <span class=\"built_in\">exit</span>=0 a0=0x55e64d0712b0 a1=0x55e64d1fab50 a2=0x55e64d1ed380 a3=0x8 items=2 ppid=22490 pid=41229 </span><br><span class=\"line\">  auid=godev uid=godev gid=godev euid=sysadmin suid=sysadmin fsuid=sysadmin egid=godev sgid=godev </span><br><span class=\"line\">  fsgid=godev tty=pts3 ses=4 comm=process-cred-sa exe=/home/godev/backup/ruid-euid-suid-test/process-cred-sample-adv </span><br><span class=\"line\">  subj=unconfined key=new-uid-adv</span><br></pre></td></tr></table></figure>\n<p>åœ¨æ‰§è¡Œ process-cred-sample-adv å¯æ‰§è¡Œæ–‡ä»¶åï¼Œä½¿ç”¨ <code>ausearch</code> æŸ¥æ‰¾å¯¹åº”çš„æ‰§è¡Œæ—¥å¿—ï¼Œå…¶ä¸­ <code>type=SYSCALL</code> ä¸­ <code>uid=godev</code> ä¸º kernel ç¡®å®šçš„ ruid å€¼ 1000(godev)ï¼Œè™½ç„¶åœ¨ process-cred-sample-adv è¿›ç¨‹è¿”å›ä¸­ ruid ä¸º 1001ï¼Œä½†è¯¥å€¼ä¸º setreuid() ç³»ç»Ÿè°ƒç”¨é‡æ–°è®¾ç½®çš„å€¼ï¼ŒçœŸå®çš„ ruid ä¾ç„¶ä¸º 1000(godev)ã€‚<code>euid=sysadmin</code> ä¸ <code>suid=sysadmin</code> çš„ç»“æœä¸è¿›ç¨‹è¿”å›çš„ç»“æœå®Œå…¨ä¸€è‡´ã€‚</p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://linux.die.net/man/7/credentials\" target=\"_blank\" rel=\"noopener\">credentials(7) - Linux man page</a></li>\n<li><a href=\"https://man7.org/linux/man-pages/man2/setregid.2.html\" target=\"_blank\" rel=\"noopener\">setreuid(2) - Linux manual page</a></li>\n<li><a href=\"https://stackoverflow.com/questions/32455684/difference-between-real-user-id-effective-user-id-and-saved-user-id\" target=\"_blank\" rel=\"noopener\">Difference between Real User ID, Effective User ID and Saved User ID</a></li>\n<li><a href=\"https://blog.csdn.net/fmeng23/article/details/23115989?spm=1001.2101.3001.6650.4&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-4-23115989-blog-40857821.pc_relevant_default&amp;utm_relevant_index=5\" target=\"_blank\" rel=\"noopener\">æ·±åˆ»ç†è§£ - real user id, effective user id, saved user id in Linux</a></li>\n<li><a href=\"https://pan.baidu.com/s/1DX8AEVBqepVDp3tiR06nBQ\" target=\"_blank\" rel=\"noopener\">ã€ŠLinux/Unix ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ï¼ˆä¸Šå†Œï¼‰- ç¬¬9ç«  è¿›ç¨‹å‡­è¯ï¼ˆæå–ç ï¼šwop8ï¼‰</a></li>\n<li><a href=\"https://mudongliang.github.io/2020/09/17/ruid-euid-suid-usage-in-linux.html\" target=\"_blank\" rel=\"noopener\">ruid, euid, suid usage in Linux</a></li>\n</ul>\n"},{"title":"ä¸€æ–‡å˜æ¸… HTTPS åŸç†ä¸åº”ç”¨","subtitle":"SSL/TLS handshake and HTTPS authentication","header-img":"https-bg.png","date":"2023-01-20T03:28:29.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼š`CentOS Linux release 7.9.2009 (Core)`\n- Kernel ç‰ˆæœ¬ï¼š`4.20.3-1.el7.elrepo.x86_64`\n- OpenSSL ç‰ˆæœ¬ï¼š`openssl-1.0.2k-21.el7_9.x86_64.rpm`\n- Docker ç‰ˆæœ¬ï¼š`20.10.8`\n- Nginx ç‰ˆæœ¬ï¼š`1.22.1`\n- âœ¨ HTTPS åœ¨å¸¸è§„ Web æœåŠ¡å™¨ã€ä¸­é—´ä»¶æœåŠ¡å™¨åŠ `RESTful API` ç­‰é€šä¿¡ä¸­å¹¿æ³›å¤§é‡ä½¿ç”¨ï¼Œå› æ­¤ç†è§£ HTTPS åŠç›¸å…³æ¦‚å¿µæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚\n- è¯¥æ–‡æ¡£ä½¿ç”¨ openssl å·¥å…·åˆ›å»ºä¸ç®¡ç†ç›¸å…³ç§é’¥ä¸è¯ä¹¦ï¼Œå½“ç„¶ä¹Ÿå¯ä½¿ç”¨ cfssl æˆ– certtoolï¼ˆæ¥æºäº gnutls-utils è½¯ä»¶åŒ…ï¼‰å·¥å…·åˆ›å»ºä¸ç®¡ç†ã€‚\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- åŠ å¯†é€šä¿¡èƒŒæ™¯\n- ä¿è¯æ•°æ®çš„æœºå¯†æ€§\n- ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§\n- ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯\n- æ•°å­—ç­¾ååŸç†\n- SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­\n- SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹\n- åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯\n- HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æ\n- HTTPS å•å‘è®¤è¯æµ‹è¯•\n- HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•\n- openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»\n- openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•\n- å‚è€ƒé“¾æ¥\n\n### åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\n- ç½‘ç»œå®‰å…¨é—®é¢˜ï¼š  \n  HTTP ä¸ä½¿ç”¨ SSL/TLS è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œæ‰€æœ‰ä¿¡æ¯æ˜æ–‡ä¼ æ’­ï¼Œå¸¦æ¥äº†ä¸‰å¤§é£é™©ï¼š  \n  - çªƒå¬é£é™©ï¼ˆeavesdroppingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥è·çŸ¥é€šä¿¡å†…å®¹  \n  - ç¯¡æ”¹é£é™©ï¼ˆtamperingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥ä¿®æ”¹é€šä¿¡å†…å®¹  \n  - å†’å……é£é™©ï¼ˆpretendingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥å†’å……ä»–äººèº«ä»½å‚ä¸é€šä¿¡\n- ç½‘ç»œå®‰å…¨é—®é¢˜çš„è§£å†³æ€è·¯ï¼š`SSL/TLS` åè®®  \n  - æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯åŠ å¯†ä¼ æ’­ï¼Œç¬¬ä¸‰æ–¹æ— æ³•çªƒå¬ã€‚  \n  - å…·æœ‰æ ¡éªŒæœºåˆ¶ï¼Œä¸€æ—¦è¢«ç¯¡æ”¹ï¼Œé€šä¿¡åŒæ–¹ä¼šç«‹åˆ»å‘ç°ã€‚  \n  - é…å¤‡èº«ä»½è¯ä¹¦ï¼Œé˜²æ­¢èº«ä»½è¢«å†’å……ã€‚\n\n### ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\n- ğŸ§¬ å®ç°æ–¹å¼ï¼šå¯¹ç§°åŠ å¯†ç®—æ³•\n- ğŸ’¥ å•çº¯çš„æ•°æ®åŠ å¯†åªèƒ½ä¿è¯æ•°æ®ä¸è¢«æ³„éœ²ï¼Œä½†ä¸èƒ½ä¿è¯æ¥æ”¶æ–¹æ”¶åˆ°çš„æ•°æ®çš„çœŸå®æ€§ã€‚\n\n### ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\n- æ•°æ®çš„çœŸå®æ€§ï¼šçœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œæ•°æ®æ˜¯ä»çœŸå®å‘é€è€…å‘æ¥ã€‚\n- ğŸ§¬ å®ç°æ–¹å¼ï¼šæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆæˆ–ç§°æ•£åˆ—ç®—æ³•/å•å‘æ•£åˆ—å‡½æ•°ï¼‰ç”Ÿæˆæ•°æ®æŒ‡çº¹ï¼ˆç‰¹å¾ç ï¼‰\n- ğŸ’¥ åˆ©ç”¨æå–æ•°æ®æŒ‡çº¹çš„æ–¹å¼ï¼Œå®Œæˆæ•°æ®ä¼ è¾“çš„å®Œæ•´æ€§éªŒè¯ã€‚\n- ğŸ”’ å®é™…çš„ç®—æ³•å®ç°è¿‡ç¨‹æ¦‚è¦ï¼š  \n  - ç»™ä¸€æ®µæ˜æ–‡æ•°æ®ï¼ˆplain textï¼‰åŠ ä¸Šæ•°æ®ä¿¡æ¯æŒ‡çº¹ï¼Œè¿™ä¸ªæŒ‡çº¹æ˜¯é€šè¿‡ç»“åˆæ•°æ®ä¿¡æ¯è¿›è¡Œç›¸åº”ç®—æ³•è·å¾—çš„æ•°æ®æŒ‡çº¹ã€‚  \n  - æ¥æ”¶æ–¹å½“æ”¶åˆ°æ•°æ®ä¿¡æ¯åï¼Œä¼šåˆ©ç”¨ç›¸åŒçš„ç®—æ³•å¯¹è·å–çš„æ•°æ®è®¡ç®—æŒ‡çº¹ï¼Œç¡®è®¤å¾—åˆ°çš„æŒ‡çº¹æ˜¯å¦ä¸ä¼ é€è¿‡æ¥çš„æè¿°æ•°æ®çš„æŒ‡çº¹ä¸€è‡´ã€‚  \n  - å¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®å®Œæ•´æ€§é­åˆ°ç ´åï¼Œæ•°æ®ä¸€æ¦‚ä¸äºˆä»¥æ¥æ”¶å¤„ç†ã€‚\n- ç”±äºå¯èƒ½å­˜åœ¨ä¸­é—´äººæ”»å‡»çš„å¯èƒ½æ€§ï¼Œå› æ­¤å¯å¯¹ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®æŒ‡çº¹è¿›è¡ŒåŠ å¯†ã€‚\n- å‘é€æ–¹åˆ©ç”¨å¯¹ç§°å¯†é’¥æ–¹å¼å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡ŒåŠ å¯†ï¼Œæ¥æ”¶æ–¹ä¼šåˆ©ç”¨ç›¸åŒçš„å¯†é’¥å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œä»è€Œç¡®è®¤æŒ‡çº¹æ˜¯å¦ä¸€è‡´ã€‚\n- å¦‚æœä¸­é—´äººå°†æ–°çš„æŒ‡çº¹ä¹Ÿè¿›è¡Œäº†åŠ å¯†ï¼Œå‘é€ç»™æ¥æ”¶æ–¹ï¼Œä½†æ¥æ”¶æ–¹æ— æ³•åˆ©ç”¨å’Œå‘é€æ–¹åå•†å¥½çš„è§£å¯†å¯†é’¥å¯¹æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œæœ€ç»ˆæ— æ³•è¯†åˆ«ä¸­é—´äººå‘é€è¿‡æ¥çš„æ•°æ®æŒ‡çº¹ä¿¡æ¯ã€‚\n- ğŸ¤˜ é€šè¿‡åŠ å¯†æŒ‡çº¹å¯ä»¥ä¿è¯çœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚\n\n### ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\n- ä»¥ä¸Šä¿¡æ¯åªæ˜¯è§£å†³æ•°æ®çš„äº¤æ¢è·å–é—®é¢˜ï¼Œä½†æ˜¯ç½‘ç»œçš„èº«ä»½éªŒè¯é—®é¢˜ä¾æ—§æ²¡æœ‰è§£å†³ã€‚\n- ğŸ§¬ å®ç°æ–¹å¼ï¼šéå¯¹ç§°åŠ å¯†\n- åˆ©ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ç½‘ç»œä¸­æ•°æ®ä¼ è¾“åŒæ–¹çš„å®‰å…¨èº«ä»½éªŒè¯é—®é¢˜ã€‚\n- ğŸ’¥ éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œå­˜åœ¨å¯†é’¥å¯¹çš„æ¦‚å¿µï¼Œå³æ‹¥æœ‰å…¬é’¥ï¼ˆ`public key`ï¼‰ä¸ç§é’¥ï¼ˆ`private key`ï¼‰ï¼Œå…¶ä¸­å…¬é’¥ä¸æ˜¯è‡ªè¡Œåˆ›å»ºå‡ºæ¥çš„è€Œæ˜¯ä»ç§é’¥ä¸­æå–å‡ºæ¥ä¸€éƒ¨åˆ†ä½œä¸ºå…¬é’¥ï¼Œå› æ­¤å¯ä»¥è¯´å…¬é’¥æ˜¯æ¥è‡ªäºç§é’¥çš„ï¼Œè€Œç§é’¥æ‰å†³å®šå¯†é’¥åŠ å¯†çš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”ç§é’¥çš„é•¿åº¦å¯èƒ½ä¼šéå¸¸é•¿ï¼Œä»æœ€åˆçš„ 1024ã€2048 åˆ° 4096 ä¸€ç›´åˆ°æ›´å¤šçš„ä½æ•°ã€‚å¢åŠ ç§é’¥å¯†é’¥ä½ï¼Œä»è€Œæå‡å¯†é’¥å®‰å…¨æ€§ã€‚\n- éå¯¹ç§°åŠ å¯†ç®—æ³•éµå¾ªçš„åŸºæœ¬åŸåˆ™ï¼šå…¬é’¥åŠ å¯†çš„åªèƒ½åˆ©ç”¨ä¸ä¹‹é…å¯¹çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œåä¹‹äº¦ç„¶ã€‚\n- éå¯¹ç§°åŠ å¯†ç®—æ³•å¯ä»¥æ»¡è¶³æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹ä¼ è¾“è€…èº«ä»½éªŒè¯çš„éœ€æ±‚ï¼Œå› ä¸ºæ¥æ”¶è€…å¯ä»¥æ‹¥æœ‰ç›¸åº”çš„å…¬é’¥ï¼Œåªæœ‰ä¸ä¹‹å¯¹åº”çš„å‘é€è€…ç”¨ç›¸åº”çš„ç§é’¥è¿›è¡ŒåŠ å¯†ä¿¡æ¯ï¼Œæ¥æ”¶è€…ç”¨å¯¹åº”çš„å…¬é’¥æ‰å¯è§£å¯†ï¼Œå¦åˆ™å¯ä»¥ç¡®è®¤å‘é€è€…èº«ä»½å·²ç»å‘ç”Ÿå˜åŒ–ã€‚\n\n### ğŸ¦„ æ•°å­—ç­¾ååŸç†ï¼š\n- **<font color=orange>å…¬é’¥åŠ å¯†ç®—æ³•</font>** è§£å†³é€šä¿¡åŒæ–¹èº«ä»½éªŒè¯é—®é¢˜ï¼Œä½†æ— æ³•ç¡®ä¿å…¬é’¥çš„çœŸå®æ€§ã€‚\n- å› æ­¤ï¼ŒCA æ•°å­—ç­¾åä½¿ç”¨è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertification Authorityï¼Œç®€ç§° `CA`ï¼‰è§£å†³é€šä¿¡åŒæ–¹äº¤æ¢çš„å…¬é’¥çš„çœŸå®æ€§ï¼Œå³æ•°å­—è¯ä¹¦çš„çœŸå®æ€§ï¼ˆå…¬é’¥åŒ…å«äºæ•°å­—è¯ä¹¦ä¸­ï¼‰ã€‚\n- æ•°å­—ç­¾åè¯ä¹¦çš„åˆ†ç±»ï¼š  \n  - è‡ªç­¾åæ•°å­—ç­¾åè¯ä¹¦ï¼š    \n    ä¸ä½¿ç”¨ `ca.key` åŠ å¯†ç”Ÿæˆç­¾åï¼Œä½¿ç”¨è‡ªèº«çš„ç§é’¥åŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ `GnuPG` é‚®ä»¶åŠ å¯†ä¼ è¾“ã€‚  \n  - CA æ•°å­—ç­¾åè¯ä¹¦ï¼š    \n    ä½¿ç”¨ CA è¯ä¹¦æˆæƒä¸­å¿ƒçš„ `ca.key` ä¸ `ca.crt` è¿›è¡ŒåŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ `kube-apiserver`ã€Apacheã€Nginxã€Tomcat ç­‰ï¼Œä»¥ä¸‹è®¨è®ºè¯¥ç±»å‹è¯ä¹¦ã€‚\n- ğŸ§¬ å®ç°æ–¹å¼ï¼š**<font color=orange>å…¬é’¥éå¯¹ç§°åŠ å¯†ç®—æ³• +Â æ¶ˆæ¯æ‘˜è¦ç®—æ³•</font>**\n- æ ‡å‡†çš„ `X.509` æ ¼å¼çš„ CA æ•°å­—ç­¾åè¯ä¹¦ç»„æˆï¼š  \n  - è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ï¼šæ˜æ–‡æ˜¾ç¤º    \n    - è¯ä¹¦çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersionï¼‰    \n    - è¯ä¹¦çš„åºåˆ—å·ï¼ˆSerial Numberï¼Œ`srl`ï¼‰ï¼šæ¯ä¸ªè¯ä¹¦éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¯ä¹¦åºåˆ—å·    \n    - è¯ä¹¦æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼š`sha256WithRSAEncryption`    \n    - è¯ä¹¦çš„å‘è¡Œæœºæ„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ `X.500` æ ¼å¼ï¼ˆç›®å½•æœåŠ¡åè®® X.500ï¼‰    \n    - â± è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼šç°åœ¨é€šç”¨çš„è¯ä¹¦ä¸€èˆ¬é‡‡ç”¨ UTC æ—¶é—´æ ¼å¼ï¼Œè®¡æ—¶èŒƒå›´ä¸º 1950-2049ã€‚    \n    - è¯ä¹¦æ‰€æœ‰äººçš„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ `X.500` æ ¼å¼    \n    - è¯ä¹¦æ‰€æœ‰äººçš„å…¬é’¥ä¿¡æ¯    \n    - CA æ•°å­—ç­¾åæ ¡éªŒç   \n  - è¯ä¹¦æ•°å­—ç­¾åï¼ˆSï¼‰ï¼šå¯†æ–‡æ˜¾ç¤º    \n    - è¯ä¹¦å‘è¡Œè€…ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰ä½¿ç”¨ CA ç§é’¥åŠ å¯†ç”Ÿæˆç­¾å\n- ğŸ”¥ CA æ•°å­—ç­¾åè¯ä¹¦ç”Ÿæˆè¿‡ç¨‹ï¼š  \n  - è¯¥ç”Ÿæˆè¿‡ç¨‹æ»¡è¶³å‡½æ•°è¡¨è¾¾å¼ï¼š`S = F(Digest(C))`\n  - å…¶ä¸­ S ä¸ºè¯ä¹¦æ•°å­—ç­¾åï¼ŒF ä¸ºç­¾åç®—æ³•ï¼ŒDigest ä¸ºæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆMD5/SHA1/SHA256ç­‰ï¼‰ï¼ŒC ä¸ºè¯ä¹¦ç›¸å…³ä¿¡æ¯ã€‚  \n  - 1ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯åˆ›å»ºå„è‡ªçš„ç§é’¥ï¼Œå¹¶ä½¿ç”¨è¯¥ç§é’¥åˆ›å»º `csr` è¯ä¹¦ç­¾åè¯·æ±‚ã€‚  \n  - 2ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ `csr` è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­åŒ…å«è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ä¸ç›¸åº”çš„å…¬é’¥ä¿¡æ¯ã€‚  \n  - 3ï¸âƒ£ ä½¿ç”¨æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ç”Ÿæˆç›¸åº”æŒ‡çº¹ï¼ˆfingerprintï¼‰ï¼Œå†ä½¿ç”¨ CA ç§é’¥ï¼ˆca.keyï¼‰é…åˆ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰åŠ å¯†è¯¥æŒ‡çº¹ï¼Œæœ€åç”ŸæˆæœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ CA æ•°å­—ç­¾åè¯ä¹¦ã€‚  \n  - è¯¥ CA æ•°å­—ç­¾ååªèƒ½è¢« CA ç§é’¥ï¼ˆca.keyï¼‰å¯¹åº”ä½äº CA æ ¹è¯ä¹¦ä¸­çš„ CA å…¬é’¥è§£å¼€ã€‚  \n  - åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼šä¹Ÿå¯å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/create-ssl-certs.sh) ä»¥è·å¾—ä»¥ä¸‹è¿‡ç¨‹çš„å®Œæ•´è„šæœ¬\n    ```bash\n    $ openssl genrsa -out CA-center.key 2048\n    $ openssl req -key CA-center.key \\\n      -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\" \\\n      -new -x509 -days 3650 -out CA-center.crt\n    # åˆ›å»º CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆè‡ªç­¾åï¼‰\n    $ openssl x509 -noout -text -in CA-center.crt\n      Certificate:\n        Data:\n            Version: 3 (0x2)\n            Serial Number:\n                fb:53:9c:3c:4d:81:f6:de\n        Signature Algorithm: sha256WithRSAEncryption\n            Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com\n            Validity\n                Not Before: Jan  2 14:04:46 2023 GMT\n                Not After : Dec 30 14:04:46 2032 GMT\n            Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com\n            # ç”±äºä½¿ç”¨ CA ç§é’¥è‡ªç­¾åç”Ÿæˆçš„ CA æ ¹è¯ä¹¦ï¼Œå…¶è¯ä¹¦å‘è¡Œæœºæ„ä¸æ‰€æœ‰äººç›¸åŒã€‚\n            Subject Public Key Info:\n                Public Key Algorithm: rsaEncryption\n                    Public-Key: (2048 bit)\n                    Modulus:\n                        00:bf:9a:3d:48:8c:b9:21:cb:d4:e5:30:df:4a:0e:\n                        05:e1:29:fe:5c:1f:06:4d:fb:89:fe:f5:01:c7:37:\n                        c5:ee:f5:66:8f:2f:bd:48:82:a1:80:1e:00:9d:a0:\n                        ...\n    ```\n    ```bash\n    $ openssl genrsa -out server.key 2048\n    $ openssl req -key server.key \\\n      -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\" \\\n      -new -out server.csr\n    $ openssl req -noout -text -in server.csr\n      Certificate Request:\n        Data:\n            Version: 0 (0x0)\n            Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com \n            # éœ€ç­¾åæœåŠ¡ç«¯è¯ä¹¦çš„æ‰€æœ‰äºº\n            Subject Public Key Info:  # csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸­çš„å…¬é’¥ä¿¡æ¯\n                Public Key Algorithm: rsaEncryption  # å…¬é’¥åŠ å¯†ç®—æ³•ï¼šRSAï¼ˆä¸å¯¹ç§°åŠ å¯†ï¼‰\n                    Public-Key: (2048 bit)\n                    Modulus:\n                        00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:\n                        e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:\n                        54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:\n                        ...\n    # åˆ›å»ºä¸æŸ¥çœ‹æœåŠ¡ç«¯ç§é’¥åŠ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶\n    \n    $ openssl x509 -req -in server.csr \\\n      -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\\n      -days 3650 -out server.crt\n    # ä½¿ç”¨ CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ç­¾å‘æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦\n    $ openssl x509 -noout -text -in server.crt\n      Certificate:\n        Data:\n            Version: 1 (0x0)\n            Serial Number:\n                a9:68:e7:c4:87:87:4e:03\n        Signature Algorithm: sha256WithRSAEncryption\n            Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com \n            # æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„å‘è¡Œæœºæ„ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰\n            Validity\n                Not Before: Jan  2 14:04:46 2023 GMT\n                Not After : Dec 30 14:04:46 2032 GMT\n            Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com\n            # æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„æ‰€æœ‰äººï¼šæœåŠ¡ç«¯ä¿¡æ¯\n            Subject Public Key Info:\n                Public Key Algorithm: rsaEncryption\n                    Public-Key: (2048 bit)\n                    Modulus:\n                        00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:\n                        e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:\n                        54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:\n                        ...\n    # è¯¥æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„æœåŠ¡ç«¯å…¬é’¥ä¿¡æ¯ä¸å…¶ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­çš„ç›¸åŒ\n    ```\n- å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦è¿‡ç¨‹ï¼š  \n  - éªŒè¯æœåŠ¡ç«¯ CA æ•°å­—ç­¾åï¼š    \n    - å®¢æˆ·ç«¯éœ€å…·æœ‰ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰    \n    - å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯ CA æ•°å­—ç­¾åçš„éªŒè¯æ»¡è¶³è¡¨è¾¾å¼ï¼š`F'(S) = Digest(C)`\n    - å®¢æˆ·ç«¯å°†æ‰§è¡Œä¸¤ç§è®¡ç®—ï¼Œå¹¶å°†è®¡ç®—ç»“æœè¿›è¡Œæ¯”å¯¹ï¼š      \n      1ï¸âƒ£ ç”±äºè¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ä»¥æ˜æ–‡æ˜¾ç¤ºï¼Œé€šè¿‡æ¶ˆæ¯æ‘˜è¦ç®—æ³•è®¡ç®— C çš„å“ˆå¸Œå€¼ã€‚      \n      2ï¸âƒ£ ä½¿ç”¨ CA å…¬é’¥è§£å¯†ç”±æœåŠ¡ç«¯é€šè¿‡ CA ç§é’¥åŠ å¯†çš„ CA æ•°å­—ç­¾åï¼Œè·å¾—åŸå§‹è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰çš„å“ˆå¸Œå€¼ã€‚      \n      3ï¸âƒ£ è‹¥ä¸¤è€…ç»“æœä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦æœ‰æ•ˆä¸”æ¥è‡ªè¯¥ CAï¼Œæœªè¢«ç¯¡æ”¹ï¼›è‹¥ä¸¤è€…ç»“æœä¸ä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦å·²è¢«ä¸­é—´äººç¯¡æ”¹æˆ–ä¸æ¥è‡ªè¯¥ CAã€‚  \n  - æå–æœåŠ¡ç«¯å…¬é’¥ï¼š    \n    - CA æ•°å­—ç­¾åéªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æå–å‡ºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥è¿›è¡Œé€šä¿¡ã€‚    \n    - ğŸ¤ è¯ä¹¦éªŒè¯åœ¨ `SSL/TLS` æ¡æ‰‹è¿‡ç¨‹çš„ `Server Hello Done` ä¸ `Client Key Exchange` ä¹‹é—´ã€‚  \n  - ğŸš€ éªŒè¯è¿‡ç¨‹ä¸åŸç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![](ca-signed-certification-verify.jpg)\n\n### SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­ï¼š\n- è¯ä¹¦æ ‡å‡†ï¼š`X.509`\n- ç¼–ç æ ¼å¼ï¼š  \n  - âœ¨ `PEM`ï¼š    \n    - privacy enhanced Mail    \n    - çº¯æ–‡æœ¬å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ˆBase64 ç¼–ç ï¼‰ï¼ŒApache ä¸ *nix æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚  \n  - `DER`ï¼š    \n    - distinguished encoding Rules    \n    - äºŒè¿›åˆ¶å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ŒJava ä¸ Windows æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚\n- è¯ä¹¦ï¼ˆæ•°å­—ç­¾åè¯ä¹¦ï¼‰ï¼šcertificateï¼ˆ`CER` æˆ– `CRT`ï¼‰\n- ç§é’¥ï¼šprivate key\n- ğŸ‘‰ è¯ä¹¦ç­¾åè¯·æ±‚ï¼š  \n  - certificate signing request: `CSR`  \n  - è¯¥æ–‡ä»¶ä½¿ç”¨ç§é’¥åŠ å¯†ï¼ŒåŒ…å«å…¬é’¥ä¸ç­¾åç”³è¯·è€…ä¿¡æ¯ç­‰ã€‚\n- CER ä¸ CRT ä¸¤è€…éƒ½ä¸ºè¯ä¹¦ï¼ŒCRT åœ¨ Linux ä¸Šæ›´å¸¸è§ã€‚\n- CERã€CRTã€KEYã€CSR éƒ½å¯ä¸º PEM æˆ– DER ç¼–ç æ ¼å¼ï¼\n- æ”¯æŒ SSL/TLS åè®®çš„å¼€æºå·¥å…·ï¼š`openssl`ã€`cfssl`ã€`gnutls`\n- ğŸ“š man æŸ¥çœ‹ä»¥ä¸‹å‘½ä»¤ï¼š  \n  opensslã€genrsaã€rsaã€reqã€x509ã€verifyã€s_clientã€s_server\n\n### SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\n- å®‰å…¨å¥—æ¥å­—å±‚åè®®ï¼šSecure Socket Layerï¼ˆSSLï¼‰\n- ä¼ è¾“å±‚å®‰å…¨åè®®ï¼šTransport Layer Securityï¼ˆTLSï¼‰\n- SSL/TLS å†å²èƒŒæ™¯ï¼š  \n  - 1994 å¹´ï¼ŒNetScape å…¬å¸è®¾è®¡äº† SSL åè®®çš„ 1.0 ç‰ˆï¼Œä½†æœªå‘å¸ƒã€‚  \n  - 1995 å¹´ï¼ŒNetScape å…¬å¸å‘å¸ƒ SSL 2.0 ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚  \n  - 1996 å¹´ï¼ŒSSL 3.0 ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚  \n  - 1999 å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ ISOC æ¥æ›¿ NetScape å…¬å¸ï¼Œå‘å¸ƒäº† SSL çš„å‡çº§ç‰ˆ `TLS 1.0` ç‰ˆã€‚  \n  - 2006 å¹´å’Œ 2008 å¹´ï¼ŒTLS è¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸º TLS 1.1 ç‰ˆå’Œ TLS 1.2 ç‰ˆã€‚  \n  - ğŸ‘‰ æœ€æ–°çš„å˜åŠ¨æ˜¯ 2011 å¹´ `TLS 1.2` çš„ä¿®è®¢ç‰ˆã€‚\n- TLS ä¸ SSL ä¹‹é—´çš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š  \n  - TLS 1.0 å¯¹åº” SSL 3.1  \n  - TLS 1.1 å¯¹åº” SSL 3.2  \n  - TLS 1.2 å¯¹åº” SSL 3.3\n- ğŸ‘‰ ä¸€èˆ¬ä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº†Â `TLS 1.2` çš„æ”¯æŒã€‚\n- SSL/TLS åè®®åœ¨ç½‘ç»œæ¨¡å‹ä¸­çš„ä½ç½®ï¼š![](ssl-tls-in-network-stack.png)\n- SSL/TLS åè®®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š  \n  - Handshake Protocolï¼š    \n    ğŸ¤ åå•†é€šä¿¡åŒæ–¹ä¹‹ååœ¨æœ¬æ¬¡ä¼šè¯ä¸­ç”¨äºæ•°æ®åŠ å¯†çš„ä¼šè¯å¯†é’¥ï¼ˆ`session key`ï¼‰ï¼Œè¯¥è¿‡ç¨‹ä¸º \"æ¡æ‰‹é˜¶æ®µ\"ï¼Œå…¶ä¸­ä¼šè¯å¯†é’¥ä¹Ÿç§°ä¸ºåå•†å¯†é’¥ã€‚  \n  - Record Protocolï¼š    \n    å®šä¹‰ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†çš„æ•°æ®çš„ä¼ è¾“æ ¼å¼ã€‚\n- SSL å±‚ï¼š  \n  å€ŸåŠ©ä¸‹å±‚åè®®ï¼ˆTCP å±‚ï¼‰çš„çš„ä¿¡é“å®‰å…¨åœ°åå•†å‡ºä¸€ä»½ä¼šè¯å¯†é’¥ï¼Œå¹¶ç”¨æ­¤å¯†é’¥æ¥åŠ å¯† HTTP è¯·æ±‚ã€‚\n- TCP å±‚ï¼š  \n  - ä¸ Web server çš„ 443 ç«¯å£å»ºç«‹è¿æ¥ï¼Œä¼ é€’ç”± SSL å¤„ç†åçš„æ•°æ®ã€‚  \n  - SSL åœ¨ TCP ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªåŠ å¯†é€šé“ï¼Œé€šè¿‡è¿™ä¸€å±‚çš„æ•°æ®ç»è¿‡äº†åŠ å¯†ï¼Œå› æ­¤è¾¾åˆ°ä¿å¯†çš„æ•ˆæœã€‚\n- æœåŠ¡ç«¯æœ¬åœ°ä¸å®¢æˆ·ç«¯æœ¬åœ°çš„ SSL å¥—æ¥å­—ä¸ TCP å¥—æ¥å­—çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![](client-server-tcp-ssl-socket.png)\n\n### ğŸš€ åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯ï¼š\n- ä»¥ä¸Šå…³äºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„éªŒè¯åªæ˜¯ HTTPS é€šä¿¡ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œéœ€é€šè¿‡å…¶ä»–æ­¥éª¤å…±åŒå®Œæˆ HTTPS åŠ å¯†é€šä¿¡ã€‚\n- HTTPS åŠ å¯†é€šä¿¡è®¤è¯åˆ†ä¸ºä¸¤ç±»ï¼šå•å‘è®¤è¯ã€åŒå‘è®¤è¯\n- å•å‘è®¤è¯ä¸­åªéœ€æœåŠ¡ç«¯æä¾›æœåŠ¡ç«¯è¯ä¹¦ä¸ç§é’¥å³å¯ï¼Œè€ŒåŒå‘è®¤è¯ä¸­æœåŠ¡ç«¯éœ€æä¾›è¯ä¹¦ä¸ç§é’¥å¤–è¿˜éœ€æä¾› CA æ ¹è¯ä¹¦ï¼ˆè¯¥è¯ä¹¦ç”¨äºå®¢æˆ·ç«¯è¯ä¹¦çš„ç­¾å‘ï¼‰ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯éœ€æä¾›å®¢æˆ·ç«¯è¯ä¹¦ä¸ç§é’¥ã€‚\n- å•å‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡ç«¯å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç„¶åå»ºç«‹å®‰å…¨é€šä¿¡é€šé“ã€‚\n- åŒå‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯é™¤äº†éœ€è¦ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡å™¨çš„å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯å¤–ï¼Œè¿˜éœ€è¦æŠŠå®¢æˆ·ç«¯çš„å…¬é’¥è¯ä¹¦ä¸Šä¼ åˆ°æœåŠ¡ç«¯ç»™æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ï¼Œç­‰åŒæ–¹éƒ½è®¤è¯é€šè¿‡äº†ï¼Œæ‰å¼€å§‹å»ºç«‹å®‰å…¨é€šä¿¡é€šé“è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚\n- ğŸ‘¨â€ğŸ« **<font color=red>æ€»ç»“ï¼š</font>**  \n  æ— è®º HTTPS å•å‘æˆ–åŒå‘è®¤è¯éƒ½æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åå•†å‡º **<font color=red>ä¼šè¯å¯†é’¥</font>** ä¸ **<font color=red>ä¼šè¯åŠ å¯†ç®—æ³•</font>** çš„è¿‡ç¨‹ã€‚\n- âœ¨ ä»¥ä¸‹ä» HTTPS æŠ“åŒ…çš„è§’åº¦è¯´æ˜ SSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹ï¼š![](ssl-four-handshakes-https-single-and-mutual-authentication.png)ä¸Šå›¾ä¸­ **é»‘è‰²ç®­å¤´** è¡¨ç¤ºåŒå‘è®¤è¯è¿‡ç¨‹ä¸­å¤šå‡ºçš„æ­¥éª¤ï¼Œå…¶ä½™è¿‡ç¨‹ä¸ºå•å‘è®¤è¯è¿‡ç¨‹ã€‚\n\n### ğŸ§ª HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æï¼š\n- æœ¬ä¾‹ä½¿ç”¨ `Nginx HTTPS` æœåŠ¡æµ‹è¯• HTTPSï¼ˆHTTP + SSL/TLSï¼‰åŠ å¯†é€šä¿¡ã€‚\n- ä½¿ç”¨å·²é…ç½®æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„ Nginx å®¹å™¨æµ‹è¯• HTTPS åŠ å¯†é€šä¿¡è¿‡ç¨‹ï¼Œå¹¶ä½¿ç”¨ `Wireshark` æŠ“åŒ…åˆ†æã€‚\n- æ„å»º Nginx å®¹å™¨ä½¿ç”¨çš„ [Dockerfile](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/nginx-ssl) å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```dockerfile\n  # modified date: \n  #     - 2019-12-10: initial Dockerfile\n  #     - 2023-01-16: update nginx and add client ssl authentication\n  \n  FROM docker.io/library/centos:7.9.2009\n  MAINTAINER lhua \"hualongfeiyyy@163.com\"\n  \n  # install nginx dependent packages\n  RUN yum repolist && \\ \n      yum install -y gcc* && \\\n      yum install -y pcre-devel openssl openssl-devel && \\\n      yum clean all && \\\n      mkdir -p /application/nginx-1.22.1 && \\\n      useradd -u 1005 -M -s /sbin/nologin nginx\n      # create nginx user to run nginx worker processes\n  \n  # copy nginx source package to container rootfs\n  ADD nginx-1.22.1.tar.gz /tmp/\n  \n  # make install nginx \n  RUN cd /tmp/nginx-1.22.1 && \\\n      ./configure --user=nginx --group=nginx --prefix=/application/nginx-1.22.1 \\\n        --with-http_stub_status_module --with-http_ssl_module && \\\n      make && \\\n      make install && \\\n      ln -s /application/nginx-1.22.1 /application/nginx && \\\n      mkdir /application/nginx/conf/extra && \\\n      mkdir /application/nginx/html/www && \\\n      mkdir /application/nginx/key\n      # create virtual server, html and key directory.\n  \n  # copy nginx configuration file, virtual server configuration file and certification file.\n  ADD nginx.conf /application/nginx/conf/\n  ADD www.conf /application/nginx/conf/extra/\n  ADD index.html /application/nginx/html/www/\n  ADD certs/server.key /application/nginx/key/\n  ADD certs/server.crt /application/nginx/key/\n  ADD certs/CA-center.crt /application/nginx/key/\n  \n  EXPOSE 443\n  \n  # Note: Don't run nginx as backend daemon\n  CMD [\"/application/nginx/sbin/nginx\", \"-g\", \"daemon off;\"]\n  ```\n- Nginx å®¹å™¨ä½¿ç”¨çš„ [é…ç½®æ–‡ä»¶](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/nginx-ssl/www.conf)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  âœ¨ è¯¥é…ç½®æ–‡ä»¶å¯ç”¨ HTTPS å•å‘è®¤è¯ï¼Œè‹¥éœ€å¼€å¯åŒå‘è®¤è¯è¿‡ç¨‹ï¼Œåªéœ€å¯ç”¨ `ssl_client_certificate` ä¸ `ssl_verify_client` å‚æ•°å³å¯ã€‚  \n  ```nginx\n  # Web Service: domain-based virtual machine\n  server {\n      listen  443;\n      # alias for domain-based virtual machine\n      server_name  www.etiantian.org etiantian.org;\n  \n      ssl  on;  # Nginx å¯ç”¨ SSL/TLS éªŒè¯ï¼šæŒ‡å®šæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥\n      # enable openssl module to support SSL/TLS\n      ssl_certificate  /application/nginx/key/server.crt;\n      # server.crt è¯ä¹¦å‘é€è‡³å®¢æˆ·ç«¯ç”¨äºéªŒè¯å…¶èº«ä»½ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å…¶ä¸­çš„å…¬é’¥åŠ å¯†\n      # pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°å¹¶å‘é€è‡³æœåŠ¡ç«¯åå•†ä¼šè¯å¯†é’¥ã€‚\n      ssl_certificate_key  /application/nginx/key/server.key;\n      # server.key ç”¨äºè§£å¯†ä»å®¢æˆ·ç«¯å‘é€æ¥çš„å·²åŠ å¯†çš„ pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°\n      #ssl_client_certificate  /application/nginx/key/CA-center.crt;\n      #ssl_verify_client  on;\n      # å¯ç”¨æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯ SSL/TLS åŒå‘éªŒè¯\n      # è‹¥åªéœ€æœåŠ¡ç«¯å•å‘éªŒè¯ï¼Œæ— éœ€å¯ç”¨ ssl_client_certificate ä¸ ssl_verify_clientã€‚\n      ssl_session_timeout  5m;\n      ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;\n      ssl_ciphers  ALL:!DH:!EXPORT:!RC4:+HIGH:+MEDIUM:-LOW:!aNULL:!eNULL;\n      ssl_prefer_server_ciphers  on; \n  \n      location / {\n          root   html/www;\n          index  index.html index.htm;\n      }\n  }\n  ```\n- æŠ“åŒ… HTTPS åŠ å¯†é€šä¿¡çš„ä¸‰ä¸ªè¿‡ç¨‹ï¼šTCP å»ºç«‹è¿æ¥ã€SSL/TLS æ¡æ‰‹ã€SSL/TLS åŠ å¯†é€šä¿¡\n- HTTPS åŠ å¯†é€šä¿¡ - æŠ“åŒ…æ•´ä½“ç¤ºæ„ï¼š![](wireshark-https-single-progress.png)\n- ğŸ¤ HTTPS åŠ å¯†é€šä¿¡ - 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ç¤ºæ„ï¼š![](ssl-tls-single-authentication-progress.png)ğŸ‘¨â€ğŸ’» ä»¥ä¸‹å°†æ¡æ‰‹è¿‡ç¨‹åˆ†ä¸º 4 ä¸ªé˜¶æ®µè¿›è¡Œæè¿°ã€‚\n- 1ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 1 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š`Client Hello`  \n  - å®¢æˆ·ç«¯é¦–å…ˆå‘æœåŠ¡ç«¯å‘é€ Client Hello çš„ SSL æ¡æ‰‹ä¿¡æ¯ã€‚  \n  - Client Hello æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š    \n    - å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä»¥æ˜æ–‡ä¼ è¾“è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€å®¢æˆ·ç«¯éšæœºæ•°ã€åŠ å¯†å¥—ä»¶å€™é€‰åˆ—è¡¨ã€å‹ç¼©ç®—æ³•å€™é€‰åˆ—è¡¨ã€æ‰©å±•å­—æ®µç­‰ä¿¡æ¯ã€‚    \n    - æ”¯æŒçš„æœ€é«˜ TLS åè®®ç‰ˆæœ¬ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ SSLv2ã€SSLv3ã€TLSv1ã€TLSv1.1ã€TLSv1.2ï¼Œå½“å‰åŸºæœ¬ä¸å†ä½¿ç”¨ä½äº TLSv1 çš„ç‰ˆæœ¬ã€‚    \n    - âœ¨ éšæœºæ•° `random_C`ï¼Œç”¨äºåç»­çš„ä¼šè¯å¯†é’¥ç”Ÿæˆã€‚    \n    - å®¢æˆ·ç«¯æ”¯æŒçš„åŠ å¯†å¥—ä»¶ `Cipher Suites` åˆ—è¡¨ï¼Œæ¯ä¸ªåŠ å¯†å¥—ä»¶å¯¹åº” TLS åŸç†ä¸­çš„å››ä¸ªåŠŸèƒ½çš„ç»„åˆï¼š      \n      - è®¤è¯ç®—æ³• `Au`ï¼šèº«ä»½éªŒè¯      \n      - å¯†é’¥äº¤æ¢ç®—æ³• `KeyExchange`ï¼šï¼ˆä¼šè¯ï¼‰å¯†é’¥åå•†      \n      - å¯¹ç§°åŠ å¯†ç®—æ³• `Enc`ï¼šä¿¡æ¯åŠ å¯†      \n      - ä¿¡æ¯æ‘˜è¦ `Mac`ï¼šå®Œæ•´æ€§æ ¡éªŒ    \n    - æ”¯æŒçš„å‹ç¼©ç®—æ³• `Compression Methods` åˆ—è¡¨ï¼Œç”¨äºåç»­çš„ä¿¡æ¯å‹ç¼©ä¼ è¾“ã€‚    \n    - æ‰©å±•å­—æ®µ Extensionsï¼Œæ”¯æŒåè®®ä¸ç®—æ³•çš„ç›¸å…³å‚æ•°ä»¥åŠå…¶å®ƒè¾…åŠ©ä¿¡æ¯ç­‰ï¼Œå¸¸è§çš„ SNI å°±å±äºæ‰©å±•å­—æ®µã€‚![](client-hello-body-1.png)  \n  - å®¢æˆ·ç«¯æ”¯æŒçš„ 17 ç§åŠ å¯†å¥—ä»¶ä¾›æœåŠ¡ç«¯é€‰æ‹©ä½¿ç”¨ã€‚![](client-hello-body-2.png)\n- 2ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 2 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤çš„ 4 æ¡ SSL æ¡æ‰‹ä¿¡æ¯![](server-response-to-client-ssl.png)\n  - `Server Hello`ï¼š    \n    - æœåŠ¡ç«¯è¿”å›åå•†çš„ä¿¡æ¯ç»“æœï¼ŒåŒ…æ‹¬é€‰æ‹©ä½¿ç”¨çš„åè®®ç‰ˆæœ¬ã€é€‰æ‹©çš„åŠ å¯†å¥—ä»¶ã€é€‰æ‹©çš„å‹ç¼©ç®—æ³•ã€éšæœºæ•° `random_S` ç­‰ï¼Œå…¶ä¸­éšæœºæ•°ç”¨äºåç»­çš„å¯†é’¥åå•†ã€‚    \n    - æœåŠ¡ç«¯é€‰æ‹© **<font color=orange>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</font>** ä½œä¸ºå¯†é’¥äº¤äº’çš„åŠ å¯†å¥—ä»¶ï¼Œè¯¥åŠ å¯†å¥—ä»¶çš„åå­—åœ¨å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ”¯æŒçš„ `17` ä¸ªåˆ—è¡¨ä¸­ã€‚    \n    - è¯¥åŠ å¯†å¥—ä»¶åŒ…å«ï¼š      \n      - éå¯¹ç§°åŠ å¯†ï¼ˆå¯†é’¥äº¤æ¢ç®—æ³•ï¼‰ï¼š`ECDHE + RSA`      \n      - å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š`AES + GCM`      \n      - æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼š`SHA-384`  \n  - `Certificate`ï¼šè¯¥ SSL æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦![](server-ca-signed-certification.png)  \n  - `Server Key Exchange`ï¼š    \n    ä½¿ç”¨ `EC Diffie-Hellman` ç®—æ³•ï¼ˆ`ECDHE`ï¼‰å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„å¯†é’¥äº¤æ¢ç®—æ³•åå•†ã€‚![](server-key-exchange.png)   \n    ğŸ’¥ å¯¹äºä½¿ç”¨ `DHE/ECDHE` éå¯¹ç§°å¯†é’¥åå•†ç®—æ³•çš„ SSL æ¡æ‰‹ï¼Œå°†å‘é€è¯¥ç±»å‹æ¡æ‰‹ã€‚`RSA`ã€`DH`ã€`ECDH` ç®—æ³•ä¸ä¼šè¿›è¡Œè¯¥ server key exchange æ¡æ‰‹æµç¨‹ã€‚ \n  - `Server Hello Done`ï¼šé€šçŸ¥å®¢æˆ·ç«¯ Server Hello ä¿¡æ¯å‘é€ç»“æŸ![](server-hello-done.jpg)\n- 3ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 3 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šå®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯å›å¤ 3 æ¡ SSL æ¡æ‰‹ä¿¡æ¯![](client-response-to-server-ssl.jpg)\n  - `Client Key Exchange`ï¼š    \n    - æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦åˆæ³•æ€§éªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯è®¡ç®—äº§ç”Ÿéšæœºæ•°å­— `Pre-master`ï¼Œå¹¶ç”¨æœåŠ¡ç«¯è¯ä¹¦ä¸­çš„å…¬é’¥åŠ å¯†ï¼Œå‘é€ç»™æœåŠ¡ç«¯ã€‚      \n      ğŸ’¥ æ³¨æ„ï¼šæœåŠ¡ç«¯è¯ä¹¦åˆæ³•æ€§éªŒè¯å¤±è´¥ï¼ŒSSL æ¡æ‰‹å³åœæ­¢ï¼    \n    - æ­¤æ—¶å®¢æˆ·ç«¯å·²ç»è·å–å…¨éƒ¨çš„è®¡ç®—ä¼šè¯å¯†é’¥éœ€è¦çš„ä¿¡æ¯ï¼š      \n      ğŸš€ ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° `random_C` å’Œ `random_S` ä¸è‡ªå·±è®¡ç®—äº§ç”Ÿçš„ `Pre-master`ï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚  \n  - `Change Cipher Spec`ï¼š    \n     ğŸš€ å®¢æˆ·ç«¯é€šçŸ¥æœåŠ¡ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ **<font color=red>ä¼šè¯å¯†é’¥</font>** å’Œ **<font color=red>ä¼šè¯åŠ å¯†ç®—æ³•</font>** è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  \n  - `Encrypted Handshake Message`ï¼š    \n    ç»“åˆä¹‹å‰æ‰€æœ‰é€šä¿¡å‚æ•°çš„å“ˆå¸Œå€¼ç”Ÿæˆä¸€æ®µæ•°æ®ï¼Œé‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™æœåŠ¡å™¨ç”¨äºæ•°æ®ä¸æ¡æ‰‹éªŒè¯ã€‚\n- 4ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤ 2 æ¡ SSL æ¡æ‰‹ä¿¡æ¯![](server-response-to-client-4-phase.png)\n  - `Change Cipher Spec`ï¼š    \n    - æœåŠ¡ç«¯ç”¨ç§é’¥è§£å¯†åŠ å¯†çš„ `Pre-master` éšæœºæ•°ï¼ŒåŸºäºä¹‹å‰äº¤æ¢çš„ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° random_C å’Œ random_Sï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚    \n    - è®¡ç®—ä¹‹å‰æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œç„¶åè§£å¯†å®¢æˆ·ç«¯å‘é€çš„ `Encrypted HandshakeÂ Message`ï¼ŒéªŒè¯ä¼šè¯å¯†é’¥å’Œæ•°æ®çš„å‡†ç¡®æ€§ã€‚    \n    - Change Cipher Spec éªŒè¯é€šè¿‡ä¹‹åï¼ŒæœåŠ¡ç«¯åŒæ ·å‘é€ Change Cipher Spec ä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ä¼šè¯å¯†é’¥ä¸ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  \n  - `Encrypted Handshake Message`ï¼š    \n    - æœåŠ¡å™¨ä¹Ÿç»“åˆæ‰€æœ‰å½“å‰çš„é€šä¿¡å‚æ•°ä¿¡æ¯ç”Ÿæˆä¸€æ®µæ•°æ®å¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å‘é€åˆ°å®¢æˆ·ç«¯ã€‚\n- HTTPS åŠ å¯†é€šä¿¡ - æ¡æ‰‹ç»“æŸï¼š  \n  - å®¢æˆ·ç«¯è®¡ç®—æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œå¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥è§£å¯† Encrypted Handshake Messageï¼ŒéªŒè¯æœåŠ¡å™¨å‘é€çš„ä¼šè¯å¯†é’¥å’Œæ•°æ®ï¼ŒéªŒè¯é€šè¿‡åˆ™æ¡æ‰‹å®Œæˆã€‚  \n  - å¼€å§‹ä½¿ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚![](ssl-tls-handshake-end.png)\n\n### HTTPS å•å‘è®¤è¯æµ‹è¯•ï¼š\n- æœåŠ¡ç«¯å¯ç”¨ HTTPS å•å‘è®¤è¯åï¼Œå¯ä»æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡Œè®¿é—®æµ‹è¯•ï¼š![](https-single-auth-chrome-error-1.png)\n- è¯¥æœåŠ¡ç«¯ CA æ•°å­—ç­¾åä½¿ç”¨æœªç»è®¤è¯çš„ CA ç­¾å‘ï¼Œå› æ­¤å®¢æˆ·ç«¯æµè§ˆå™¨æ— æ³•éªŒè¯å…¶å®‰å…¨æ€§è€Œå‘å‡ºè­¦å‘Šï¼Œå¯ç‚¹å‡» \"é«˜çº§\" æŒ‰é’®æ¥å—è¯¥è¯ä¹¦ç»§ç»­è®¿é—®ã€‚è‹¥æ‹’ç»è¯¥è¯ä¹¦ï¼Œå³æ–­å¼€æ­¤æ¬¡è®¤è¯è¿æ¥ï¼Œå¯åœ¨å¦‚ä¸‹ Wireshark æŠ“åŒ…ä¸­æ˜¾ç¤ºå®‰å…¨å‘Šè­¦ä¿¡æ¯ï¼š![](https-single-auth-chrome-error-2.png) \n\n### HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•ï¼š\n- HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­å…·ä½“çš„æ­¥éª¤å‚è§å‰æ–‡ \"SSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹\" ä¸å•å‘è®¤è¯çš„è¿‡ç¨‹ã€‚![](wireshark-https-single-progress.png)\n- HTTPS åŒå‘è®¤è¯è¿‡ç¨‹çš„å®¢æˆ·ç«¯æµ‹è¯•ï¼š  \n  - é…ç½®ç”Ÿæˆå®¢æˆ·ç«¯æ‰€éœ€çš„æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ï¼š    \n    ```bash\n    $ openssl genrsa -out client.key 2048\n    $ openssl req -key client.key \\\n      -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=firefox\" \\\n      -new -out client.csr\n    $ openssl x509 -req -in client.csr \\\n      -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\\n      -days 3650 -out client.crt\n    ```\n  - è‹¥å°†å®¢æˆ·ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ç”¨äº `Firefox` æˆ– `Chrome` æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œå¯å°†å…¶è½¬æ¢ä¸º `p12` æ ¼å¼ï¼š    \n    ```bash\n    $ openssl pkcs12 -export -clcerts \\\n      -in client.crt -inkey client.key -out client.p12\n    # åˆ›å»º client.p12 æ–‡ä»¶æ—¶å°†äº¤äº’å¼è¾“å…¥åŠ å¯†å¯†ç \n    ```\n  - å°† p12 æ ¼å¼çš„æ–‡ä»¶å¯¼å…¥ Firefox æµè§ˆå™¨å®¢æˆ·ç«¯ï¼š![](firefox-import-pc12-certs-1.png)![](firefox-import-pc12-certs-2.png)![](firefox-import-pc12-certs-3.png)![](firefox-import-pc12-certs-4.png)\n  - æ‰“å¼€ Firefox æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œæ­¤æ—¶éœ€æ¥å—å®¢æˆ·ç«¯è¯ä¹¦æ¥æ ‡è®°è‡ªå·±ï¼š![](firefox-import-pc12-certs-5.png)  \n  - ğŸ’¥ è‹¥åŒå‘è®¤è¯å®¢æˆ·ç«¯é…ç½®é”™è¯¯ï¼Œå°†æ— æ³•æ­£å¸¸è®¿é—®æœåŠ¡ç«¯ï¼Œå¹¶ä¸”æµè§ˆå™¨ç›´æ¥è¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼Œä¸” Wireshark æŠ“åŒ…æ˜¾ç¤º `Encrypted Alert`ï¼š![](https-mutual-no-client-cert-error-1.png)![](https-mutual-no-client-cert-error-2.png)\n\n### openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\n- `openssl req` å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»º `csr` è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦ï¼ˆæˆ–è‡ªç­¾åè¯ä¹¦ï¼‰  \n  ```bash\n  -key               æŒ‡å®šç”¨äºåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚çš„ç§é’¥            \n  -newkey alg:nbits  åˆ›å»ºæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸ç§é’¥ï¼ŒæŒ‡å®šåŠ å¯†ç®—æ³•ä¸åŠ å¯†ä½æ•°\n                    ï¼ˆé€šå¸¸ä¸º rsa:2048ï¼‰ã€‚             \n  -nodes             ä¸ä½¿ç”¨å¯†ç ä¸ºæ–°åˆ›å»ºçš„ç§é’¥åŠ å¯†\n  -keyout            æŒ‡å®šæ–°åˆ›å»ºç§é’¥çš„æ–‡ä»¶å\n  -sha256            ä½¿ç”¨ SHA-256 æ‘˜è¦ï¼ˆåˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦æ—¶ä½¿ç”¨ï¼‰\n  -subj              æŒ‡å®šåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯è‹¥æœªæŒ‡å®š\n                     è¯¥é€‰é¡¹ï¼Œå°†è¿›å…¥äº¤äº’æ¨¡å¼ã€‚\n  -new               ç”Ÿæˆæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚\n  -x509              ç”Ÿæˆæ•°å­—ç­¾åè¯ä¹¦ï¼ˆä¸ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰\n  -days              æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ã€‚\n  -out               æŒ‡å®šè¾“å‡ºçš„ csr è¯ä¹¦ç­¾åè¯·æ±‚æˆ–æ•°å­—ç­¾åè¯ä¹¦çš„åç§°\n  ```\n- `openssl x509` å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»ºä¸æŸ¥çœ‹æ•°å­—ç­¾åè¯ä¹¦  \n  ```bash\n  -req             æŒ‡å®š csr è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œä¸ -in é€‰é¡¹åˆç”¨ã€‚                \n  -in              æŒ‡å®šè¾“å…¥æ–‡ä»¶\n  -CAkey           æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA ç§é’¥\n  -CA              æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA æ ¹è¯ä¹¦\n  -CAcreateserial  åˆ›å»º CA åºåˆ—å·æ–‡ä»¶ï¼Œæ‰©å±•åä¸º \".srl\"ï¼Œè¯¥é€‰é¡¹å¿…é¡»ä¸ -CA é€‰é¡¹åˆç”¨ã€‚\n  -days            æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ï¼Œä¸ä¸\n                   -preserve_dates é€‰é¡¹åˆç”¨ã€‚\n  -out             æŒ‡å®šè¾“å‡ºçš„æ•°å­—ç­¾åè¯ä¹¦åç§°\n  ```\n- åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦çš„ 2 ç§æ–¹æ³•ï¼š  \n  - 1ï¸âƒ£ å…ˆåˆ›å»ºç§é’¥å†åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦  \n  - 2ï¸âƒ£ åŒæ—¶åˆ›å»ºç§é’¥ä¸è‡ªç­¾åæ•°å­—è¯ä¹¦    \n    ```bash\n    $ openssl req -newkey rsa:4096 -nodes -keyout server.key \\\n      -sha256 -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\" \\\n      -x509 -days 3650 -out server.crt\n    ```\n- åˆ›å»º CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆroot-caï¼‰ï¼š  \n  ```bash\n  $ openssl genrsa [-des3] -out ca.key [1024|2048|4096]\n  # åˆ›å»º CA RSA ç§é’¥\n  # -des3 é€‰é¡¹ï¼šäº¤äº’è¾“å…¥å¯†ç ä¸º RSA ç§é’¥åŠ å¯†\n  \n  $ openssl req -key ca.key \\\n    -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\" \\\n    -new -x509 \\\n    -days 3650 -out ca.crt\n  # åˆ›å»º CA è‡ªç­¾åæ ¹è¯ä¹¦\n  \n  $ openssl rsa -in ca.key -text -noout\n  # æŸ¥çœ‹ CA RSA ç§é’¥çš„è¯¦ç»†ä¿¡æ¯\n  \n  $ openssl x509 -in ca.crt -text -noout\n  # æŸ¥çœ‹ CA æ ¹è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯\n  ```\n- åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  \n  ```bash\n  $ openssl genrsa [-des3] -out server.key [1024|2048|4096]\n  # åˆ›å»º server ç«¯ RSA ç§é’¥\n  \n  $ openssl rsa -in server.key -pubout -out server.pub\n  # æå– server ç«¯ RSA ç§é’¥å¯¹åº”çš„å…¬é’¥ï¼ˆå…¬é’¥ç”±ç§é’¥ä¸­æå–ï¼‰\n  \n  $ openssl req -key server.key \\\n    -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\" \\\n    -new -out server.csr\n  # åˆ›å»º server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcertificate signing requestï¼‰\n  # æ³¨æ„ï¼š\n  #   1. åˆ›å»º csr ä¸ä½¿ç”¨ -x509 ä¸ -days é€‰é¡¹\n  #   2. åœ¨åˆ›å»ºç”ŸæˆæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚æ—¶å‡è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹ï¼š\n  #      a. CA æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å³å¯ï¼Œæ‰€æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¯ä¹¦è¯¥å­—æ®µ\n  #         éœ€è¦å¡«å†™ IP æˆ–åŸŸåã€‚\n  #      b. ä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼ŒCA æ ¹è¯ä¹¦çš„è¯¥å­—æ®µå’ŒæœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ä¸èƒ½ä¸€æ ·ã€‚\n  #      c. å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼ŒCA æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´ï¼Œæœ€åçš„å¯†ç \n  #         å¯ç›´æ¥å›è½¦è·³è¿‡ã€‚\n  \n  $ openssl req -noout -text -in server.csr\n  # æŸ¥çœ‹ server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯\n  \n  $ openssl x509 -req -in server.csr \\\n    -CAkey ca.key -CA ca.crt -CAcreateserial \\\n    -days 3650 -out server.crt\n  # ä½¿ç”¨ server ç«¯ csr è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦\n  \n  ### æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„ç›¸å…³ä¿¡æ¯ ###\n  $ openssl x509 -noout -serial -in server.crt\n  # æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„åºåˆ—å·\n  $ openssl x509 -noout -dates -in server.crt\n  # æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„æœ‰æ•ˆæœŸ\n  $ openssl x509 -noout -pubkey -in server.crt\n  # æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥ä¿¡æ¯ï¼Œè¯¥å…¬é’¥ä¸ç§é’¥ä¸­æå–çš„å…¬é’¥ä¸€è‡´ã€‚\n  ```\n- åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  \n  ```bash\n  $ openssl genrsa [-des3] -out client.key [1024|2048|4096]\n  # åˆ›å»º client ç«¯ RSA ç§é’¥\n  \n  $ openssl req -key client.key \\\n    -subj \"/C=CN/ST=Shanghai/L=Shanghai/CN=sec-srv.lab.example.com\" \\\n    -new -out client.csr\n  # åˆ›å»º client ç«¯è¯ä¹¦ç­¾åè¯·æ±‚\n  \n  $ openssl x509 -req -in client.csr \\\n    -CAkey ca.key -CA ca.crt -CAcreateserial \\\n    -days 3650 -out client.crt\n  # ä½¿ç”¨è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦\n  ```\n\n### openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\n- ä½¿ç”¨ server ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå•å‘è¿æ¥æµ‹è¯•ï¼š  \n  ```bash\n  $ openssl s_server -accept <port> -key server.key -cert server.crt    \n  # server ç«¯ï¼šå¯åŠ¨å•å‘å®‰å…¨è¿æ¥ï¼Œå¯åŠ¨åå°†ç­‰å¾… client ç«¯å‘é€ä¿¡æ¯å¹¶å›æ˜¾\n  $ openssl s_client -connect <host_ip>:<port>\n  # client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚\n  ```\n- ä½¿ç”¨ server ç«¯ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡ŒåŒå‘è¿æ¥æµ‹è¯•ï¼š  \n  ```bash\n  $ openssl s_server -accept <port> \\\n    -key server.key -cert server.crt -Verify <depth>\n  # server ç«¯ï¼šå¼ºåˆ¶è¦æ±‚ client ç«¯æä¾›ç§é’¥ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå®‰å…¨è¿æ¥\n  $ openssl s_server -accept 10001 \\\n    -key server.key -cert server.crt -Verify 5\n  \n  $ openssl s_client -connect <host_ip>:<port> \\\n    -key client.key -cert client.crt\n  # client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚\n  $ openssl s_client \\\n    -connect 10.197.11.100:10001 -key client.key -cert client.crt\n  ```\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [HTTPS åŠ å¯†åè®®è¯¦è§£ (å››)ï¼šTLS/SSL æ¡æ‰‹è¿‡ç¨‹](https://www.wosign.com/FAQ/faq2016-0309-04.htm)\n- [TLS/SSL åè®®è¯¦è§£(12) server key exchange](https://blog.csdn.net/mrpre/article/details/77867831)\n- [ä»€ä¹ˆæ˜¯ HTTPS åŒå‘è®¤è¯(MutualTLSauthentication)_API ç½‘å…³ - é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ](https://help.aliyun.com/document_detail/160093.html)\n- [HTTPS åŒå‘è¯ä¹¦è®¤è¯](https://blog.xizhibei.me/2021/02/03/https-two-way-authentication-with-certificates/)\n- [NGINX é…ç½®æœ¬åœ° HTTPS (åŒå‘è®¤è¯)](https://www.cnblogs.com/xiao987334176/p/11041241.html)\n- [å¸¸è§è¯ä¹¦æ ¼å¼å’Œè½¬æ¢](https://blog.csdn.net/justinjing0612/article/details/7770301)\n- [å¸¸è§è¯ä¹¦æ ¼å¼åŠç›¸äº’è½¬æ¢](https://www.cnblogs.com/lzjsky/archive/2010/11/14/1877143.html)\n- [openssl ç”Ÿæˆè‡ªç­¾è¯ä¹¦åŠæŸ¥çœ‹è¯ä¹¦ç»†èŠ‚](https://www.cnblogs.com/threegun/p/7130985.html)","source":"_posts/https-handshake-authentication.md","raw":"---\ntitle: ä¸€æ–‡å˜æ¸… HTTPS åŸç†ä¸åº”ç”¨\nsubtitle: SSL/TLS handshake and HTTPS authentication\nheader-img: https-bg.png\ndate: 2023-01-20 11:28:29\ntags:\n  - HTTPS\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼š`CentOS Linux release 7.9.2009 (Core)`\n- Kernel ç‰ˆæœ¬ï¼š`4.20.3-1.el7.elrepo.x86_64`\n- OpenSSL ç‰ˆæœ¬ï¼š`openssl-1.0.2k-21.el7_9.x86_64.rpm`\n- Docker ç‰ˆæœ¬ï¼š`20.10.8`\n- Nginx ç‰ˆæœ¬ï¼š`1.22.1`\n- âœ¨ HTTPS åœ¨å¸¸è§„ Web æœåŠ¡å™¨ã€ä¸­é—´ä»¶æœåŠ¡å™¨åŠ `RESTful API` ç­‰é€šä¿¡ä¸­å¹¿æ³›å¤§é‡ä½¿ç”¨ï¼Œå› æ­¤ç†è§£ HTTPS åŠç›¸å…³æ¦‚å¿µæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚\n- è¯¥æ–‡æ¡£ä½¿ç”¨ openssl å·¥å…·åˆ›å»ºä¸ç®¡ç†ç›¸å…³ç§é’¥ä¸è¯ä¹¦ï¼Œå½“ç„¶ä¹Ÿå¯ä½¿ç”¨ cfssl æˆ– certtoolï¼ˆæ¥æºäº gnutls-utils è½¯ä»¶åŒ…ï¼‰å·¥å…·åˆ›å»ºä¸ç®¡ç†ã€‚\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- åŠ å¯†é€šä¿¡èƒŒæ™¯\n- ä¿è¯æ•°æ®çš„æœºå¯†æ€§\n- ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§\n- ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯\n- æ•°å­—ç­¾ååŸç†\n- SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­\n- SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹\n- åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯\n- HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æ\n- HTTPS å•å‘è®¤è¯æµ‹è¯•\n- HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•\n- openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»\n- openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•\n- å‚è€ƒé“¾æ¥\n\n### åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\n- ç½‘ç»œå®‰å…¨é—®é¢˜ï¼š  \n  HTTP ä¸ä½¿ç”¨ SSL/TLS è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œæ‰€æœ‰ä¿¡æ¯æ˜æ–‡ä¼ æ’­ï¼Œå¸¦æ¥äº†ä¸‰å¤§é£é™©ï¼š  \n  - çªƒå¬é£é™©ï¼ˆeavesdroppingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥è·çŸ¥é€šä¿¡å†…å®¹  \n  - ç¯¡æ”¹é£é™©ï¼ˆtamperingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥ä¿®æ”¹é€šä¿¡å†…å®¹  \n  - å†’å……é£é™©ï¼ˆpretendingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥å†’å……ä»–äººèº«ä»½å‚ä¸é€šä¿¡\n- ç½‘ç»œå®‰å…¨é—®é¢˜çš„è§£å†³æ€è·¯ï¼š`SSL/TLS` åè®®  \n  - æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯åŠ å¯†ä¼ æ’­ï¼Œç¬¬ä¸‰æ–¹æ— æ³•çªƒå¬ã€‚  \n  - å…·æœ‰æ ¡éªŒæœºåˆ¶ï¼Œä¸€æ—¦è¢«ç¯¡æ”¹ï¼Œé€šä¿¡åŒæ–¹ä¼šç«‹åˆ»å‘ç°ã€‚  \n  - é…å¤‡èº«ä»½è¯ä¹¦ï¼Œé˜²æ­¢èº«ä»½è¢«å†’å……ã€‚\n\n### ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\n- ğŸ§¬ å®ç°æ–¹å¼ï¼šå¯¹ç§°åŠ å¯†ç®—æ³•\n- ğŸ’¥ å•çº¯çš„æ•°æ®åŠ å¯†åªèƒ½ä¿è¯æ•°æ®ä¸è¢«æ³„éœ²ï¼Œä½†ä¸èƒ½ä¿è¯æ¥æ”¶æ–¹æ”¶åˆ°çš„æ•°æ®çš„çœŸå®æ€§ã€‚\n\n### ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\n- æ•°æ®çš„çœŸå®æ€§ï¼šçœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œæ•°æ®æ˜¯ä»çœŸå®å‘é€è€…å‘æ¥ã€‚\n- ğŸ§¬ å®ç°æ–¹å¼ï¼šæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆæˆ–ç§°æ•£åˆ—ç®—æ³•/å•å‘æ•£åˆ—å‡½æ•°ï¼‰ç”Ÿæˆæ•°æ®æŒ‡çº¹ï¼ˆç‰¹å¾ç ï¼‰\n- ğŸ’¥ åˆ©ç”¨æå–æ•°æ®æŒ‡çº¹çš„æ–¹å¼ï¼Œå®Œæˆæ•°æ®ä¼ è¾“çš„å®Œæ•´æ€§éªŒè¯ã€‚\n- ğŸ”’ å®é™…çš„ç®—æ³•å®ç°è¿‡ç¨‹æ¦‚è¦ï¼š  \n  - ç»™ä¸€æ®µæ˜æ–‡æ•°æ®ï¼ˆplain textï¼‰åŠ ä¸Šæ•°æ®ä¿¡æ¯æŒ‡çº¹ï¼Œè¿™ä¸ªæŒ‡çº¹æ˜¯é€šè¿‡ç»“åˆæ•°æ®ä¿¡æ¯è¿›è¡Œç›¸åº”ç®—æ³•è·å¾—çš„æ•°æ®æŒ‡çº¹ã€‚  \n  - æ¥æ”¶æ–¹å½“æ”¶åˆ°æ•°æ®ä¿¡æ¯åï¼Œä¼šåˆ©ç”¨ç›¸åŒçš„ç®—æ³•å¯¹è·å–çš„æ•°æ®è®¡ç®—æŒ‡çº¹ï¼Œç¡®è®¤å¾—åˆ°çš„æŒ‡çº¹æ˜¯å¦ä¸ä¼ é€è¿‡æ¥çš„æè¿°æ•°æ®çš„æŒ‡çº¹ä¸€è‡´ã€‚  \n  - å¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®å®Œæ•´æ€§é­åˆ°ç ´åï¼Œæ•°æ®ä¸€æ¦‚ä¸äºˆä»¥æ¥æ”¶å¤„ç†ã€‚\n- ç”±äºå¯èƒ½å­˜åœ¨ä¸­é—´äººæ”»å‡»çš„å¯èƒ½æ€§ï¼Œå› æ­¤å¯å¯¹ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®æŒ‡çº¹è¿›è¡ŒåŠ å¯†ã€‚\n- å‘é€æ–¹åˆ©ç”¨å¯¹ç§°å¯†é’¥æ–¹å¼å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡ŒåŠ å¯†ï¼Œæ¥æ”¶æ–¹ä¼šåˆ©ç”¨ç›¸åŒçš„å¯†é’¥å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œä»è€Œç¡®è®¤æŒ‡çº¹æ˜¯å¦ä¸€è‡´ã€‚\n- å¦‚æœä¸­é—´äººå°†æ–°çš„æŒ‡çº¹ä¹Ÿè¿›è¡Œäº†åŠ å¯†ï¼Œå‘é€ç»™æ¥æ”¶æ–¹ï¼Œä½†æ¥æ”¶æ–¹æ— æ³•åˆ©ç”¨å’Œå‘é€æ–¹åå•†å¥½çš„è§£å¯†å¯†é’¥å¯¹æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œæœ€ç»ˆæ— æ³•è¯†åˆ«ä¸­é—´äººå‘é€è¿‡æ¥çš„æ•°æ®æŒ‡çº¹ä¿¡æ¯ã€‚\n- ğŸ¤˜ é€šè¿‡åŠ å¯†æŒ‡çº¹å¯ä»¥ä¿è¯çœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚\n\n### ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\n- ä»¥ä¸Šä¿¡æ¯åªæ˜¯è§£å†³æ•°æ®çš„äº¤æ¢è·å–é—®é¢˜ï¼Œä½†æ˜¯ç½‘ç»œçš„èº«ä»½éªŒè¯é—®é¢˜ä¾æ—§æ²¡æœ‰è§£å†³ã€‚\n- ğŸ§¬ å®ç°æ–¹å¼ï¼šéå¯¹ç§°åŠ å¯†\n- åˆ©ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ç½‘ç»œä¸­æ•°æ®ä¼ è¾“åŒæ–¹çš„å®‰å…¨èº«ä»½éªŒè¯é—®é¢˜ã€‚\n- ğŸ’¥ éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œå­˜åœ¨å¯†é’¥å¯¹çš„æ¦‚å¿µï¼Œå³æ‹¥æœ‰å…¬é’¥ï¼ˆ`public key`ï¼‰ä¸ç§é’¥ï¼ˆ`private key`ï¼‰ï¼Œå…¶ä¸­å…¬é’¥ä¸æ˜¯è‡ªè¡Œåˆ›å»ºå‡ºæ¥çš„è€Œæ˜¯ä»ç§é’¥ä¸­æå–å‡ºæ¥ä¸€éƒ¨åˆ†ä½œä¸ºå…¬é’¥ï¼Œå› æ­¤å¯ä»¥è¯´å…¬é’¥æ˜¯æ¥è‡ªäºç§é’¥çš„ï¼Œè€Œç§é’¥æ‰å†³å®šå¯†é’¥åŠ å¯†çš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”ç§é’¥çš„é•¿åº¦å¯èƒ½ä¼šéå¸¸é•¿ï¼Œä»æœ€åˆçš„ 1024ã€2048 åˆ° 4096 ä¸€ç›´åˆ°æ›´å¤šçš„ä½æ•°ã€‚å¢åŠ ç§é’¥å¯†é’¥ä½ï¼Œä»è€Œæå‡å¯†é’¥å®‰å…¨æ€§ã€‚\n- éå¯¹ç§°åŠ å¯†ç®—æ³•éµå¾ªçš„åŸºæœ¬åŸåˆ™ï¼šå…¬é’¥åŠ å¯†çš„åªèƒ½åˆ©ç”¨ä¸ä¹‹é…å¯¹çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œåä¹‹äº¦ç„¶ã€‚\n- éå¯¹ç§°åŠ å¯†ç®—æ³•å¯ä»¥æ»¡è¶³æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹ä¼ è¾“è€…èº«ä»½éªŒè¯çš„éœ€æ±‚ï¼Œå› ä¸ºæ¥æ”¶è€…å¯ä»¥æ‹¥æœ‰ç›¸åº”çš„å…¬é’¥ï¼Œåªæœ‰ä¸ä¹‹å¯¹åº”çš„å‘é€è€…ç”¨ç›¸åº”çš„ç§é’¥è¿›è¡ŒåŠ å¯†ä¿¡æ¯ï¼Œæ¥æ”¶è€…ç”¨å¯¹åº”çš„å…¬é’¥æ‰å¯è§£å¯†ï¼Œå¦åˆ™å¯ä»¥ç¡®è®¤å‘é€è€…èº«ä»½å·²ç»å‘ç”Ÿå˜åŒ–ã€‚\n\n### ğŸ¦„ æ•°å­—ç­¾ååŸç†ï¼š\n- **<font color=orange>å…¬é’¥åŠ å¯†ç®—æ³•</font>** è§£å†³é€šä¿¡åŒæ–¹èº«ä»½éªŒè¯é—®é¢˜ï¼Œä½†æ— æ³•ç¡®ä¿å…¬é’¥çš„çœŸå®æ€§ã€‚\n- å› æ­¤ï¼ŒCA æ•°å­—ç­¾åä½¿ç”¨è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertification Authorityï¼Œç®€ç§° `CA`ï¼‰è§£å†³é€šä¿¡åŒæ–¹äº¤æ¢çš„å…¬é’¥çš„çœŸå®æ€§ï¼Œå³æ•°å­—è¯ä¹¦çš„çœŸå®æ€§ï¼ˆå…¬é’¥åŒ…å«äºæ•°å­—è¯ä¹¦ä¸­ï¼‰ã€‚\n- æ•°å­—ç­¾åè¯ä¹¦çš„åˆ†ç±»ï¼š  \n  - è‡ªç­¾åæ•°å­—ç­¾åè¯ä¹¦ï¼š    \n    ä¸ä½¿ç”¨ `ca.key` åŠ å¯†ç”Ÿæˆç­¾åï¼Œä½¿ç”¨è‡ªèº«çš„ç§é’¥åŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ `GnuPG` é‚®ä»¶åŠ å¯†ä¼ è¾“ã€‚  \n  - CA æ•°å­—ç­¾åè¯ä¹¦ï¼š    \n    ä½¿ç”¨ CA è¯ä¹¦æˆæƒä¸­å¿ƒçš„ `ca.key` ä¸ `ca.crt` è¿›è¡ŒåŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ `kube-apiserver`ã€Apacheã€Nginxã€Tomcat ç­‰ï¼Œä»¥ä¸‹è®¨è®ºè¯¥ç±»å‹è¯ä¹¦ã€‚\n- ğŸ§¬ å®ç°æ–¹å¼ï¼š**<font color=orange>å…¬é’¥éå¯¹ç§°åŠ å¯†ç®—æ³• +Â æ¶ˆæ¯æ‘˜è¦ç®—æ³•</font>**\n- æ ‡å‡†çš„ `X.509` æ ¼å¼çš„ CA æ•°å­—ç­¾åè¯ä¹¦ç»„æˆï¼š  \n  - è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ï¼šæ˜æ–‡æ˜¾ç¤º    \n    - è¯ä¹¦çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersionï¼‰    \n    - è¯ä¹¦çš„åºåˆ—å·ï¼ˆSerial Numberï¼Œ`srl`ï¼‰ï¼šæ¯ä¸ªè¯ä¹¦éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¯ä¹¦åºåˆ—å·    \n    - è¯ä¹¦æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼š`sha256WithRSAEncryption`    \n    - è¯ä¹¦çš„å‘è¡Œæœºæ„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ `X.500` æ ¼å¼ï¼ˆç›®å½•æœåŠ¡åè®® X.500ï¼‰    \n    - â± è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼šç°åœ¨é€šç”¨çš„è¯ä¹¦ä¸€èˆ¬é‡‡ç”¨ UTC æ—¶é—´æ ¼å¼ï¼Œè®¡æ—¶èŒƒå›´ä¸º 1950-2049ã€‚    \n    - è¯ä¹¦æ‰€æœ‰äººçš„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ `X.500` æ ¼å¼    \n    - è¯ä¹¦æ‰€æœ‰äººçš„å…¬é’¥ä¿¡æ¯    \n    - CA æ•°å­—ç­¾åæ ¡éªŒç   \n  - è¯ä¹¦æ•°å­—ç­¾åï¼ˆSï¼‰ï¼šå¯†æ–‡æ˜¾ç¤º    \n    - è¯ä¹¦å‘è¡Œè€…ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰ä½¿ç”¨ CA ç§é’¥åŠ å¯†ç”Ÿæˆç­¾å\n- ğŸ”¥ CA æ•°å­—ç­¾åè¯ä¹¦ç”Ÿæˆè¿‡ç¨‹ï¼š  \n  - è¯¥ç”Ÿæˆè¿‡ç¨‹æ»¡è¶³å‡½æ•°è¡¨è¾¾å¼ï¼š`S = F(Digest(C))`\n  - å…¶ä¸­ S ä¸ºè¯ä¹¦æ•°å­—ç­¾åï¼ŒF ä¸ºç­¾åç®—æ³•ï¼ŒDigest ä¸ºæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆMD5/SHA1/SHA256ç­‰ï¼‰ï¼ŒC ä¸ºè¯ä¹¦ç›¸å…³ä¿¡æ¯ã€‚  \n  - 1ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯åˆ›å»ºå„è‡ªçš„ç§é’¥ï¼Œå¹¶ä½¿ç”¨è¯¥ç§é’¥åˆ›å»º `csr` è¯ä¹¦ç­¾åè¯·æ±‚ã€‚  \n  - 2ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ `csr` è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­åŒ…å«è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ä¸ç›¸åº”çš„å…¬é’¥ä¿¡æ¯ã€‚  \n  - 3ï¸âƒ£ ä½¿ç”¨æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ç”Ÿæˆç›¸åº”æŒ‡çº¹ï¼ˆfingerprintï¼‰ï¼Œå†ä½¿ç”¨ CA ç§é’¥ï¼ˆca.keyï¼‰é…åˆ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰åŠ å¯†è¯¥æŒ‡çº¹ï¼Œæœ€åç”ŸæˆæœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ CA æ•°å­—ç­¾åè¯ä¹¦ã€‚  \n  - è¯¥ CA æ•°å­—ç­¾ååªèƒ½è¢« CA ç§é’¥ï¼ˆca.keyï¼‰å¯¹åº”ä½äº CA æ ¹è¯ä¹¦ä¸­çš„ CA å…¬é’¥è§£å¼€ã€‚  \n  - åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼šä¹Ÿå¯å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/create-ssl-certs.sh) ä»¥è·å¾—ä»¥ä¸‹è¿‡ç¨‹çš„å®Œæ•´è„šæœ¬\n    ```bash\n    $ openssl genrsa -out CA-center.key 2048\n    $ openssl req -key CA-center.key \\\n      -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\" \\\n      -new -x509 -days 3650 -out CA-center.crt\n    # åˆ›å»º CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆè‡ªç­¾åï¼‰\n    $ openssl x509 -noout -text -in CA-center.crt\n      Certificate:\n        Data:\n            Version: 3 (0x2)\n            Serial Number:\n                fb:53:9c:3c:4d:81:f6:de\n        Signature Algorithm: sha256WithRSAEncryption\n            Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com\n            Validity\n                Not Before: Jan  2 14:04:46 2023 GMT\n                Not After : Dec 30 14:04:46 2032 GMT\n            Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com\n            # ç”±äºä½¿ç”¨ CA ç§é’¥è‡ªç­¾åç”Ÿæˆçš„ CA æ ¹è¯ä¹¦ï¼Œå…¶è¯ä¹¦å‘è¡Œæœºæ„ä¸æ‰€æœ‰äººç›¸åŒã€‚\n            Subject Public Key Info:\n                Public Key Algorithm: rsaEncryption\n                    Public-Key: (2048 bit)\n                    Modulus:\n                        00:bf:9a:3d:48:8c:b9:21:cb:d4:e5:30:df:4a:0e:\n                        05:e1:29:fe:5c:1f:06:4d:fb:89:fe:f5:01:c7:37:\n                        c5:ee:f5:66:8f:2f:bd:48:82:a1:80:1e:00:9d:a0:\n                        ...\n    ```\n    ```bash\n    $ openssl genrsa -out server.key 2048\n    $ openssl req -key server.key \\\n      -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\" \\\n      -new -out server.csr\n    $ openssl req -noout -text -in server.csr\n      Certificate Request:\n        Data:\n            Version: 0 (0x0)\n            Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com \n            # éœ€ç­¾åæœåŠ¡ç«¯è¯ä¹¦çš„æ‰€æœ‰äºº\n            Subject Public Key Info:  # csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸­çš„å…¬é’¥ä¿¡æ¯\n                Public Key Algorithm: rsaEncryption  # å…¬é’¥åŠ å¯†ç®—æ³•ï¼šRSAï¼ˆä¸å¯¹ç§°åŠ å¯†ï¼‰\n                    Public-Key: (2048 bit)\n                    Modulus:\n                        00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:\n                        e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:\n                        54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:\n                        ...\n    # åˆ›å»ºä¸æŸ¥çœ‹æœåŠ¡ç«¯ç§é’¥åŠ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶\n    \n    $ openssl x509 -req -in server.csr \\\n      -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\\n      -days 3650 -out server.crt\n    # ä½¿ç”¨ CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ç­¾å‘æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦\n    $ openssl x509 -noout -text -in server.crt\n      Certificate:\n        Data:\n            Version: 1 (0x0)\n            Serial Number:\n                a9:68:e7:c4:87:87:4e:03\n        Signature Algorithm: sha256WithRSAEncryption\n            Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com \n            # æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„å‘è¡Œæœºæ„ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰\n            Validity\n                Not Before: Jan  2 14:04:46 2023 GMT\n                Not After : Dec 30 14:04:46 2032 GMT\n            Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com\n            # æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„æ‰€æœ‰äººï¼šæœåŠ¡ç«¯ä¿¡æ¯\n            Subject Public Key Info:\n                Public Key Algorithm: rsaEncryption\n                    Public-Key: (2048 bit)\n                    Modulus:\n                        00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:\n                        e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:\n                        54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:\n                        ...\n    # è¯¥æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„æœåŠ¡ç«¯å…¬é’¥ä¿¡æ¯ä¸å…¶ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­çš„ç›¸åŒ\n    ```\n- å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦è¿‡ç¨‹ï¼š  \n  - éªŒè¯æœåŠ¡ç«¯ CA æ•°å­—ç­¾åï¼š    \n    - å®¢æˆ·ç«¯éœ€å…·æœ‰ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰    \n    - å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯ CA æ•°å­—ç­¾åçš„éªŒè¯æ»¡è¶³è¡¨è¾¾å¼ï¼š`F'(S) = Digest(C)`\n    - å®¢æˆ·ç«¯å°†æ‰§è¡Œä¸¤ç§è®¡ç®—ï¼Œå¹¶å°†è®¡ç®—ç»“æœè¿›è¡Œæ¯”å¯¹ï¼š      \n      1ï¸âƒ£ ç”±äºè¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ä»¥æ˜æ–‡æ˜¾ç¤ºï¼Œé€šè¿‡æ¶ˆæ¯æ‘˜è¦ç®—æ³•è®¡ç®— C çš„å“ˆå¸Œå€¼ã€‚      \n      2ï¸âƒ£ ä½¿ç”¨ CA å…¬é’¥è§£å¯†ç”±æœåŠ¡ç«¯é€šè¿‡ CA ç§é’¥åŠ å¯†çš„ CA æ•°å­—ç­¾åï¼Œè·å¾—åŸå§‹è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰çš„å“ˆå¸Œå€¼ã€‚      \n      3ï¸âƒ£ è‹¥ä¸¤è€…ç»“æœä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦æœ‰æ•ˆä¸”æ¥è‡ªè¯¥ CAï¼Œæœªè¢«ç¯¡æ”¹ï¼›è‹¥ä¸¤è€…ç»“æœä¸ä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦å·²è¢«ä¸­é—´äººç¯¡æ”¹æˆ–ä¸æ¥è‡ªè¯¥ CAã€‚  \n  - æå–æœåŠ¡ç«¯å…¬é’¥ï¼š    \n    - CA æ•°å­—ç­¾åéªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æå–å‡ºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥è¿›è¡Œé€šä¿¡ã€‚    \n    - ğŸ¤ è¯ä¹¦éªŒè¯åœ¨ `SSL/TLS` æ¡æ‰‹è¿‡ç¨‹çš„ `Server Hello Done` ä¸ `Client Key Exchange` ä¹‹é—´ã€‚  \n  - ğŸš€ éªŒè¯è¿‡ç¨‹ä¸åŸç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![](ca-signed-certification-verify.jpg)\n\n### SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­ï¼š\n- è¯ä¹¦æ ‡å‡†ï¼š`X.509`\n- ç¼–ç æ ¼å¼ï¼š  \n  - âœ¨ `PEM`ï¼š    \n    - privacy enhanced Mail    \n    - çº¯æ–‡æœ¬å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ˆBase64 ç¼–ç ï¼‰ï¼ŒApache ä¸ *nix æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚  \n  - `DER`ï¼š    \n    - distinguished encoding Rules    \n    - äºŒè¿›åˆ¶å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ŒJava ä¸ Windows æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚\n- è¯ä¹¦ï¼ˆæ•°å­—ç­¾åè¯ä¹¦ï¼‰ï¼šcertificateï¼ˆ`CER` æˆ– `CRT`ï¼‰\n- ç§é’¥ï¼šprivate key\n- ğŸ‘‰ è¯ä¹¦ç­¾åè¯·æ±‚ï¼š  \n  - certificate signing request: `CSR`  \n  - è¯¥æ–‡ä»¶ä½¿ç”¨ç§é’¥åŠ å¯†ï¼ŒåŒ…å«å…¬é’¥ä¸ç­¾åç”³è¯·è€…ä¿¡æ¯ç­‰ã€‚\n- CER ä¸ CRT ä¸¤è€…éƒ½ä¸ºè¯ä¹¦ï¼ŒCRT åœ¨ Linux ä¸Šæ›´å¸¸è§ã€‚\n- CERã€CRTã€KEYã€CSR éƒ½å¯ä¸º PEM æˆ– DER ç¼–ç æ ¼å¼ï¼\n- æ”¯æŒ SSL/TLS åè®®çš„å¼€æºå·¥å…·ï¼š`openssl`ã€`cfssl`ã€`gnutls`\n- ğŸ“š man æŸ¥çœ‹ä»¥ä¸‹å‘½ä»¤ï¼š  \n  opensslã€genrsaã€rsaã€reqã€x509ã€verifyã€s_clientã€s_server\n\n### SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\n- å®‰å…¨å¥—æ¥å­—å±‚åè®®ï¼šSecure Socket Layerï¼ˆSSLï¼‰\n- ä¼ è¾“å±‚å®‰å…¨åè®®ï¼šTransport Layer Securityï¼ˆTLSï¼‰\n- SSL/TLS å†å²èƒŒæ™¯ï¼š  \n  - 1994 å¹´ï¼ŒNetScape å…¬å¸è®¾è®¡äº† SSL åè®®çš„ 1.0 ç‰ˆï¼Œä½†æœªå‘å¸ƒã€‚  \n  - 1995 å¹´ï¼ŒNetScape å…¬å¸å‘å¸ƒ SSL 2.0 ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚  \n  - 1996 å¹´ï¼ŒSSL 3.0 ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚  \n  - 1999 å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ ISOC æ¥æ›¿ NetScape å…¬å¸ï¼Œå‘å¸ƒäº† SSL çš„å‡çº§ç‰ˆ `TLS 1.0` ç‰ˆã€‚  \n  - 2006 å¹´å’Œ 2008 å¹´ï¼ŒTLS è¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸º TLS 1.1 ç‰ˆå’Œ TLS 1.2 ç‰ˆã€‚  \n  - ğŸ‘‰ æœ€æ–°çš„å˜åŠ¨æ˜¯ 2011 å¹´ `TLS 1.2` çš„ä¿®è®¢ç‰ˆã€‚\n- TLS ä¸ SSL ä¹‹é—´çš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š  \n  - TLS 1.0 å¯¹åº” SSL 3.1  \n  - TLS 1.1 å¯¹åº” SSL 3.2  \n  - TLS 1.2 å¯¹åº” SSL 3.3\n- ğŸ‘‰ ä¸€èˆ¬ä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº†Â `TLS 1.2` çš„æ”¯æŒã€‚\n- SSL/TLS åè®®åœ¨ç½‘ç»œæ¨¡å‹ä¸­çš„ä½ç½®ï¼š![](ssl-tls-in-network-stack.png)\n- SSL/TLS åè®®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š  \n  - Handshake Protocolï¼š    \n    ğŸ¤ åå•†é€šä¿¡åŒæ–¹ä¹‹ååœ¨æœ¬æ¬¡ä¼šè¯ä¸­ç”¨äºæ•°æ®åŠ å¯†çš„ä¼šè¯å¯†é’¥ï¼ˆ`session key`ï¼‰ï¼Œè¯¥è¿‡ç¨‹ä¸º \"æ¡æ‰‹é˜¶æ®µ\"ï¼Œå…¶ä¸­ä¼šè¯å¯†é’¥ä¹Ÿç§°ä¸ºåå•†å¯†é’¥ã€‚  \n  - Record Protocolï¼š    \n    å®šä¹‰ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†çš„æ•°æ®çš„ä¼ è¾“æ ¼å¼ã€‚\n- SSL å±‚ï¼š  \n  å€ŸåŠ©ä¸‹å±‚åè®®ï¼ˆTCP å±‚ï¼‰çš„çš„ä¿¡é“å®‰å…¨åœ°åå•†å‡ºä¸€ä»½ä¼šè¯å¯†é’¥ï¼Œå¹¶ç”¨æ­¤å¯†é’¥æ¥åŠ å¯† HTTP è¯·æ±‚ã€‚\n- TCP å±‚ï¼š  \n  - ä¸ Web server çš„ 443 ç«¯å£å»ºç«‹è¿æ¥ï¼Œä¼ é€’ç”± SSL å¤„ç†åçš„æ•°æ®ã€‚  \n  - SSL åœ¨ TCP ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªåŠ å¯†é€šé“ï¼Œé€šè¿‡è¿™ä¸€å±‚çš„æ•°æ®ç»è¿‡äº†åŠ å¯†ï¼Œå› æ­¤è¾¾åˆ°ä¿å¯†çš„æ•ˆæœã€‚\n- æœåŠ¡ç«¯æœ¬åœ°ä¸å®¢æˆ·ç«¯æœ¬åœ°çš„ SSL å¥—æ¥å­—ä¸ TCP å¥—æ¥å­—çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![](client-server-tcp-ssl-socket.png)\n\n### ğŸš€ åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯ï¼š\n- ä»¥ä¸Šå…³äºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„éªŒè¯åªæ˜¯ HTTPS é€šä¿¡ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œéœ€é€šè¿‡å…¶ä»–æ­¥éª¤å…±åŒå®Œæˆ HTTPS åŠ å¯†é€šä¿¡ã€‚\n- HTTPS åŠ å¯†é€šä¿¡è®¤è¯åˆ†ä¸ºä¸¤ç±»ï¼šå•å‘è®¤è¯ã€åŒå‘è®¤è¯\n- å•å‘è®¤è¯ä¸­åªéœ€æœåŠ¡ç«¯æä¾›æœåŠ¡ç«¯è¯ä¹¦ä¸ç§é’¥å³å¯ï¼Œè€ŒåŒå‘è®¤è¯ä¸­æœåŠ¡ç«¯éœ€æä¾›è¯ä¹¦ä¸ç§é’¥å¤–è¿˜éœ€æä¾› CA æ ¹è¯ä¹¦ï¼ˆè¯¥è¯ä¹¦ç”¨äºå®¢æˆ·ç«¯è¯ä¹¦çš„ç­¾å‘ï¼‰ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯éœ€æä¾›å®¢æˆ·ç«¯è¯ä¹¦ä¸ç§é’¥ã€‚\n- å•å‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡ç«¯å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç„¶åå»ºç«‹å®‰å…¨é€šä¿¡é€šé“ã€‚\n- åŒå‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯é™¤äº†éœ€è¦ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡å™¨çš„å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯å¤–ï¼Œè¿˜éœ€è¦æŠŠå®¢æˆ·ç«¯çš„å…¬é’¥è¯ä¹¦ä¸Šä¼ åˆ°æœåŠ¡ç«¯ç»™æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ï¼Œç­‰åŒæ–¹éƒ½è®¤è¯é€šè¿‡äº†ï¼Œæ‰å¼€å§‹å»ºç«‹å®‰å…¨é€šä¿¡é€šé“è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚\n- ğŸ‘¨â€ğŸ« **<font color=red>æ€»ç»“ï¼š</font>**  \n  æ— è®º HTTPS å•å‘æˆ–åŒå‘è®¤è¯éƒ½æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åå•†å‡º **<font color=red>ä¼šè¯å¯†é’¥</font>** ä¸ **<font color=red>ä¼šè¯åŠ å¯†ç®—æ³•</font>** çš„è¿‡ç¨‹ã€‚\n- âœ¨ ä»¥ä¸‹ä» HTTPS æŠ“åŒ…çš„è§’åº¦è¯´æ˜ SSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹ï¼š![](ssl-four-handshakes-https-single-and-mutual-authentication.png)ä¸Šå›¾ä¸­ **é»‘è‰²ç®­å¤´** è¡¨ç¤ºåŒå‘è®¤è¯è¿‡ç¨‹ä¸­å¤šå‡ºçš„æ­¥éª¤ï¼Œå…¶ä½™è¿‡ç¨‹ä¸ºå•å‘è®¤è¯è¿‡ç¨‹ã€‚\n\n### ğŸ§ª HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æï¼š\n- æœ¬ä¾‹ä½¿ç”¨ `Nginx HTTPS` æœåŠ¡æµ‹è¯• HTTPSï¼ˆHTTP + SSL/TLSï¼‰åŠ å¯†é€šä¿¡ã€‚\n- ä½¿ç”¨å·²é…ç½®æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„ Nginx å®¹å™¨æµ‹è¯• HTTPS åŠ å¯†é€šä¿¡è¿‡ç¨‹ï¼Œå¹¶ä½¿ç”¨ `Wireshark` æŠ“åŒ…åˆ†æã€‚\n- æ„å»º Nginx å®¹å™¨ä½¿ç”¨çš„ [Dockerfile](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/nginx-ssl) å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```dockerfile\n  # modified date: \n  #     - 2019-12-10: initial Dockerfile\n  #     - 2023-01-16: update nginx and add client ssl authentication\n  \n  FROM docker.io/library/centos:7.9.2009\n  MAINTAINER lhua \"hualongfeiyyy@163.com\"\n  \n  # install nginx dependent packages\n  RUN yum repolist && \\ \n      yum install -y gcc* && \\\n      yum install -y pcre-devel openssl openssl-devel && \\\n      yum clean all && \\\n      mkdir -p /application/nginx-1.22.1 && \\\n      useradd -u 1005 -M -s /sbin/nologin nginx\n      # create nginx user to run nginx worker processes\n  \n  # copy nginx source package to container rootfs\n  ADD nginx-1.22.1.tar.gz /tmp/\n  \n  # make install nginx \n  RUN cd /tmp/nginx-1.22.1 && \\\n      ./configure --user=nginx --group=nginx --prefix=/application/nginx-1.22.1 \\\n        --with-http_stub_status_module --with-http_ssl_module && \\\n      make && \\\n      make install && \\\n      ln -s /application/nginx-1.22.1 /application/nginx && \\\n      mkdir /application/nginx/conf/extra && \\\n      mkdir /application/nginx/html/www && \\\n      mkdir /application/nginx/key\n      # create virtual server, html and key directory.\n  \n  # copy nginx configuration file, virtual server configuration file and certification file.\n  ADD nginx.conf /application/nginx/conf/\n  ADD www.conf /application/nginx/conf/extra/\n  ADD index.html /application/nginx/html/www/\n  ADD certs/server.key /application/nginx/key/\n  ADD certs/server.crt /application/nginx/key/\n  ADD certs/CA-center.crt /application/nginx/key/\n  \n  EXPOSE 443\n  \n  # Note: Don't run nginx as backend daemon\n  CMD [\"/application/nginx/sbin/nginx\", \"-g\", \"daemon off;\"]\n  ```\n- Nginx å®¹å™¨ä½¿ç”¨çš„ [é…ç½®æ–‡ä»¶](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/nginx-ssl/www.conf)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  âœ¨ è¯¥é…ç½®æ–‡ä»¶å¯ç”¨ HTTPS å•å‘è®¤è¯ï¼Œè‹¥éœ€å¼€å¯åŒå‘è®¤è¯è¿‡ç¨‹ï¼Œåªéœ€å¯ç”¨ `ssl_client_certificate` ä¸ `ssl_verify_client` å‚æ•°å³å¯ã€‚  \n  ```nginx\n  # Web Service: domain-based virtual machine\n  server {\n      listen  443;\n      # alias for domain-based virtual machine\n      server_name  www.etiantian.org etiantian.org;\n  \n      ssl  on;  # Nginx å¯ç”¨ SSL/TLS éªŒè¯ï¼šæŒ‡å®šæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥\n      # enable openssl module to support SSL/TLS\n      ssl_certificate  /application/nginx/key/server.crt;\n      # server.crt è¯ä¹¦å‘é€è‡³å®¢æˆ·ç«¯ç”¨äºéªŒè¯å…¶èº«ä»½ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å…¶ä¸­çš„å…¬é’¥åŠ å¯†\n      # pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°å¹¶å‘é€è‡³æœåŠ¡ç«¯åå•†ä¼šè¯å¯†é’¥ã€‚\n      ssl_certificate_key  /application/nginx/key/server.key;\n      # server.key ç”¨äºè§£å¯†ä»å®¢æˆ·ç«¯å‘é€æ¥çš„å·²åŠ å¯†çš„ pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°\n      #ssl_client_certificate  /application/nginx/key/CA-center.crt;\n      #ssl_verify_client  on;\n      # å¯ç”¨æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯ SSL/TLS åŒå‘éªŒè¯\n      # è‹¥åªéœ€æœåŠ¡ç«¯å•å‘éªŒè¯ï¼Œæ— éœ€å¯ç”¨ ssl_client_certificate ä¸ ssl_verify_clientã€‚\n      ssl_session_timeout  5m;\n      ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;\n      ssl_ciphers  ALL:!DH:!EXPORT:!RC4:+HIGH:+MEDIUM:-LOW:!aNULL:!eNULL;\n      ssl_prefer_server_ciphers  on; \n  \n      location / {\n          root   html/www;\n          index  index.html index.htm;\n      }\n  }\n  ```\n- æŠ“åŒ… HTTPS åŠ å¯†é€šä¿¡çš„ä¸‰ä¸ªè¿‡ç¨‹ï¼šTCP å»ºç«‹è¿æ¥ã€SSL/TLS æ¡æ‰‹ã€SSL/TLS åŠ å¯†é€šä¿¡\n- HTTPS åŠ å¯†é€šä¿¡ - æŠ“åŒ…æ•´ä½“ç¤ºæ„ï¼š![](wireshark-https-single-progress.png)\n- ğŸ¤ HTTPS åŠ å¯†é€šä¿¡ - 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ç¤ºæ„ï¼š![](ssl-tls-single-authentication-progress.png)ğŸ‘¨â€ğŸ’» ä»¥ä¸‹å°†æ¡æ‰‹è¿‡ç¨‹åˆ†ä¸º 4 ä¸ªé˜¶æ®µè¿›è¡Œæè¿°ã€‚\n- 1ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 1 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š`Client Hello`  \n  - å®¢æˆ·ç«¯é¦–å…ˆå‘æœåŠ¡ç«¯å‘é€ Client Hello çš„ SSL æ¡æ‰‹ä¿¡æ¯ã€‚  \n  - Client Hello æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š    \n    - å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä»¥æ˜æ–‡ä¼ è¾“è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€å®¢æˆ·ç«¯éšæœºæ•°ã€åŠ å¯†å¥—ä»¶å€™é€‰åˆ—è¡¨ã€å‹ç¼©ç®—æ³•å€™é€‰åˆ—è¡¨ã€æ‰©å±•å­—æ®µç­‰ä¿¡æ¯ã€‚    \n    - æ”¯æŒçš„æœ€é«˜ TLS åè®®ç‰ˆæœ¬ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ SSLv2ã€SSLv3ã€TLSv1ã€TLSv1.1ã€TLSv1.2ï¼Œå½“å‰åŸºæœ¬ä¸å†ä½¿ç”¨ä½äº TLSv1 çš„ç‰ˆæœ¬ã€‚    \n    - âœ¨ éšæœºæ•° `random_C`ï¼Œç”¨äºåç»­çš„ä¼šè¯å¯†é’¥ç”Ÿæˆã€‚    \n    - å®¢æˆ·ç«¯æ”¯æŒçš„åŠ å¯†å¥—ä»¶ `Cipher Suites` åˆ—è¡¨ï¼Œæ¯ä¸ªåŠ å¯†å¥—ä»¶å¯¹åº” TLS åŸç†ä¸­çš„å››ä¸ªåŠŸèƒ½çš„ç»„åˆï¼š      \n      - è®¤è¯ç®—æ³• `Au`ï¼šèº«ä»½éªŒè¯      \n      - å¯†é’¥äº¤æ¢ç®—æ³• `KeyExchange`ï¼šï¼ˆä¼šè¯ï¼‰å¯†é’¥åå•†      \n      - å¯¹ç§°åŠ å¯†ç®—æ³• `Enc`ï¼šä¿¡æ¯åŠ å¯†      \n      - ä¿¡æ¯æ‘˜è¦ `Mac`ï¼šå®Œæ•´æ€§æ ¡éªŒ    \n    - æ”¯æŒçš„å‹ç¼©ç®—æ³• `Compression Methods` åˆ—è¡¨ï¼Œç”¨äºåç»­çš„ä¿¡æ¯å‹ç¼©ä¼ è¾“ã€‚    \n    - æ‰©å±•å­—æ®µ Extensionsï¼Œæ”¯æŒåè®®ä¸ç®—æ³•çš„ç›¸å…³å‚æ•°ä»¥åŠå…¶å®ƒè¾…åŠ©ä¿¡æ¯ç­‰ï¼Œå¸¸è§çš„ SNI å°±å±äºæ‰©å±•å­—æ®µã€‚![](client-hello-body-1.png)  \n  - å®¢æˆ·ç«¯æ”¯æŒçš„ 17 ç§åŠ å¯†å¥—ä»¶ä¾›æœåŠ¡ç«¯é€‰æ‹©ä½¿ç”¨ã€‚![](client-hello-body-2.png)\n- 2ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 2 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤çš„ 4 æ¡ SSL æ¡æ‰‹ä¿¡æ¯![](server-response-to-client-ssl.png)\n  - `Server Hello`ï¼š    \n    - æœåŠ¡ç«¯è¿”å›åå•†çš„ä¿¡æ¯ç»“æœï¼ŒåŒ…æ‹¬é€‰æ‹©ä½¿ç”¨çš„åè®®ç‰ˆæœ¬ã€é€‰æ‹©çš„åŠ å¯†å¥—ä»¶ã€é€‰æ‹©çš„å‹ç¼©ç®—æ³•ã€éšæœºæ•° `random_S` ç­‰ï¼Œå…¶ä¸­éšæœºæ•°ç”¨äºåç»­çš„å¯†é’¥åå•†ã€‚    \n    - æœåŠ¡ç«¯é€‰æ‹© **<font color=orange>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</font>** ä½œä¸ºå¯†é’¥äº¤äº’çš„åŠ å¯†å¥—ä»¶ï¼Œè¯¥åŠ å¯†å¥—ä»¶çš„åå­—åœ¨å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ”¯æŒçš„ `17` ä¸ªåˆ—è¡¨ä¸­ã€‚    \n    - è¯¥åŠ å¯†å¥—ä»¶åŒ…å«ï¼š      \n      - éå¯¹ç§°åŠ å¯†ï¼ˆå¯†é’¥äº¤æ¢ç®—æ³•ï¼‰ï¼š`ECDHE + RSA`      \n      - å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š`AES + GCM`      \n      - æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼š`SHA-384`  \n  - `Certificate`ï¼šè¯¥ SSL æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦![](server-ca-signed-certification.png)  \n  - `Server Key Exchange`ï¼š    \n    ä½¿ç”¨ `EC Diffie-Hellman` ç®—æ³•ï¼ˆ`ECDHE`ï¼‰å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„å¯†é’¥äº¤æ¢ç®—æ³•åå•†ã€‚![](server-key-exchange.png)   \n    ğŸ’¥ å¯¹äºä½¿ç”¨ `DHE/ECDHE` éå¯¹ç§°å¯†é’¥åå•†ç®—æ³•çš„ SSL æ¡æ‰‹ï¼Œå°†å‘é€è¯¥ç±»å‹æ¡æ‰‹ã€‚`RSA`ã€`DH`ã€`ECDH` ç®—æ³•ä¸ä¼šè¿›è¡Œè¯¥ server key exchange æ¡æ‰‹æµç¨‹ã€‚ \n  - `Server Hello Done`ï¼šé€šçŸ¥å®¢æˆ·ç«¯ Server Hello ä¿¡æ¯å‘é€ç»“æŸ![](server-hello-done.jpg)\n- 3ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 3 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šå®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯å›å¤ 3 æ¡ SSL æ¡æ‰‹ä¿¡æ¯![](client-response-to-server-ssl.jpg)\n  - `Client Key Exchange`ï¼š    \n    - æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦åˆæ³•æ€§éªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯è®¡ç®—äº§ç”Ÿéšæœºæ•°å­— `Pre-master`ï¼Œå¹¶ç”¨æœåŠ¡ç«¯è¯ä¹¦ä¸­çš„å…¬é’¥åŠ å¯†ï¼Œå‘é€ç»™æœåŠ¡ç«¯ã€‚      \n      ğŸ’¥ æ³¨æ„ï¼šæœåŠ¡ç«¯è¯ä¹¦åˆæ³•æ€§éªŒè¯å¤±è´¥ï¼ŒSSL æ¡æ‰‹å³åœæ­¢ï¼    \n    - æ­¤æ—¶å®¢æˆ·ç«¯å·²ç»è·å–å…¨éƒ¨çš„è®¡ç®—ä¼šè¯å¯†é’¥éœ€è¦çš„ä¿¡æ¯ï¼š      \n      ğŸš€ ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° `random_C` å’Œ `random_S` ä¸è‡ªå·±è®¡ç®—äº§ç”Ÿçš„ `Pre-master`ï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚  \n  - `Change Cipher Spec`ï¼š    \n     ğŸš€ å®¢æˆ·ç«¯é€šçŸ¥æœåŠ¡ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ **<font color=red>ä¼šè¯å¯†é’¥</font>** å’Œ **<font color=red>ä¼šè¯åŠ å¯†ç®—æ³•</font>** è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  \n  - `Encrypted Handshake Message`ï¼š    \n    ç»“åˆä¹‹å‰æ‰€æœ‰é€šä¿¡å‚æ•°çš„å“ˆå¸Œå€¼ç”Ÿæˆä¸€æ®µæ•°æ®ï¼Œé‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™æœåŠ¡å™¨ç”¨äºæ•°æ®ä¸æ¡æ‰‹éªŒè¯ã€‚\n- 4ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤ 2 æ¡ SSL æ¡æ‰‹ä¿¡æ¯![](server-response-to-client-4-phase.png)\n  - `Change Cipher Spec`ï¼š    \n    - æœåŠ¡ç«¯ç”¨ç§é’¥è§£å¯†åŠ å¯†çš„ `Pre-master` éšæœºæ•°ï¼ŒåŸºäºä¹‹å‰äº¤æ¢çš„ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° random_C å’Œ random_Sï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚    \n    - è®¡ç®—ä¹‹å‰æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œç„¶åè§£å¯†å®¢æˆ·ç«¯å‘é€çš„ `Encrypted HandshakeÂ Message`ï¼ŒéªŒè¯ä¼šè¯å¯†é’¥å’Œæ•°æ®çš„å‡†ç¡®æ€§ã€‚    \n    - Change Cipher Spec éªŒè¯é€šè¿‡ä¹‹åï¼ŒæœåŠ¡ç«¯åŒæ ·å‘é€ Change Cipher Spec ä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ä¼šè¯å¯†é’¥ä¸ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  \n  - `Encrypted Handshake Message`ï¼š    \n    - æœåŠ¡å™¨ä¹Ÿç»“åˆæ‰€æœ‰å½“å‰çš„é€šä¿¡å‚æ•°ä¿¡æ¯ç”Ÿæˆä¸€æ®µæ•°æ®å¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å‘é€åˆ°å®¢æˆ·ç«¯ã€‚\n- HTTPS åŠ å¯†é€šä¿¡ - æ¡æ‰‹ç»“æŸï¼š  \n  - å®¢æˆ·ç«¯è®¡ç®—æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œå¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥è§£å¯† Encrypted Handshake Messageï¼ŒéªŒè¯æœåŠ¡å™¨å‘é€çš„ä¼šè¯å¯†é’¥å’Œæ•°æ®ï¼ŒéªŒè¯é€šè¿‡åˆ™æ¡æ‰‹å®Œæˆã€‚  \n  - å¼€å§‹ä½¿ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚![](ssl-tls-handshake-end.png)\n\n### HTTPS å•å‘è®¤è¯æµ‹è¯•ï¼š\n- æœåŠ¡ç«¯å¯ç”¨ HTTPS å•å‘è®¤è¯åï¼Œå¯ä»æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡Œè®¿é—®æµ‹è¯•ï¼š![](https-single-auth-chrome-error-1.png)\n- è¯¥æœåŠ¡ç«¯ CA æ•°å­—ç­¾åä½¿ç”¨æœªç»è®¤è¯çš„ CA ç­¾å‘ï¼Œå› æ­¤å®¢æˆ·ç«¯æµè§ˆå™¨æ— æ³•éªŒè¯å…¶å®‰å…¨æ€§è€Œå‘å‡ºè­¦å‘Šï¼Œå¯ç‚¹å‡» \"é«˜çº§\" æŒ‰é’®æ¥å—è¯¥è¯ä¹¦ç»§ç»­è®¿é—®ã€‚è‹¥æ‹’ç»è¯¥è¯ä¹¦ï¼Œå³æ–­å¼€æ­¤æ¬¡è®¤è¯è¿æ¥ï¼Œå¯åœ¨å¦‚ä¸‹ Wireshark æŠ“åŒ…ä¸­æ˜¾ç¤ºå®‰å…¨å‘Šè­¦ä¿¡æ¯ï¼š![](https-single-auth-chrome-error-2.png) \n\n### HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•ï¼š\n- HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­å…·ä½“çš„æ­¥éª¤å‚è§å‰æ–‡ \"SSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹\" ä¸å•å‘è®¤è¯çš„è¿‡ç¨‹ã€‚![](wireshark-https-single-progress.png)\n- HTTPS åŒå‘è®¤è¯è¿‡ç¨‹çš„å®¢æˆ·ç«¯æµ‹è¯•ï¼š  \n  - é…ç½®ç”Ÿæˆå®¢æˆ·ç«¯æ‰€éœ€çš„æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ï¼š    \n    ```bash\n    $ openssl genrsa -out client.key 2048\n    $ openssl req -key client.key \\\n      -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=firefox\" \\\n      -new -out client.csr\n    $ openssl x509 -req -in client.csr \\\n      -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\\n      -days 3650 -out client.crt\n    ```\n  - è‹¥å°†å®¢æˆ·ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ç”¨äº `Firefox` æˆ– `Chrome` æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œå¯å°†å…¶è½¬æ¢ä¸º `p12` æ ¼å¼ï¼š    \n    ```bash\n    $ openssl pkcs12 -export -clcerts \\\n      -in client.crt -inkey client.key -out client.p12\n    # åˆ›å»º client.p12 æ–‡ä»¶æ—¶å°†äº¤äº’å¼è¾“å…¥åŠ å¯†å¯†ç \n    ```\n  - å°† p12 æ ¼å¼çš„æ–‡ä»¶å¯¼å…¥ Firefox æµè§ˆå™¨å®¢æˆ·ç«¯ï¼š![](firefox-import-pc12-certs-1.png)![](firefox-import-pc12-certs-2.png)![](firefox-import-pc12-certs-3.png)![](firefox-import-pc12-certs-4.png)\n  - æ‰“å¼€ Firefox æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œæ­¤æ—¶éœ€æ¥å—å®¢æˆ·ç«¯è¯ä¹¦æ¥æ ‡è®°è‡ªå·±ï¼š![](firefox-import-pc12-certs-5.png)  \n  - ğŸ’¥ è‹¥åŒå‘è®¤è¯å®¢æˆ·ç«¯é…ç½®é”™è¯¯ï¼Œå°†æ— æ³•æ­£å¸¸è®¿é—®æœåŠ¡ç«¯ï¼Œå¹¶ä¸”æµè§ˆå™¨ç›´æ¥è¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼Œä¸” Wireshark æŠ“åŒ…æ˜¾ç¤º `Encrypted Alert`ï¼š![](https-mutual-no-client-cert-error-1.png)![](https-mutual-no-client-cert-error-2.png)\n\n### openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\n- `openssl req` å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»º `csr` è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦ï¼ˆæˆ–è‡ªç­¾åè¯ä¹¦ï¼‰  \n  ```bash\n  -key               æŒ‡å®šç”¨äºåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚çš„ç§é’¥            \n  -newkey alg:nbits  åˆ›å»ºæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸ç§é’¥ï¼ŒæŒ‡å®šåŠ å¯†ç®—æ³•ä¸åŠ å¯†ä½æ•°\n                    ï¼ˆé€šå¸¸ä¸º rsa:2048ï¼‰ã€‚             \n  -nodes             ä¸ä½¿ç”¨å¯†ç ä¸ºæ–°åˆ›å»ºçš„ç§é’¥åŠ å¯†\n  -keyout            æŒ‡å®šæ–°åˆ›å»ºç§é’¥çš„æ–‡ä»¶å\n  -sha256            ä½¿ç”¨ SHA-256 æ‘˜è¦ï¼ˆåˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦æ—¶ä½¿ç”¨ï¼‰\n  -subj              æŒ‡å®šåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯è‹¥æœªæŒ‡å®š\n                     è¯¥é€‰é¡¹ï¼Œå°†è¿›å…¥äº¤äº’æ¨¡å¼ã€‚\n  -new               ç”Ÿæˆæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚\n  -x509              ç”Ÿæˆæ•°å­—ç­¾åè¯ä¹¦ï¼ˆä¸ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰\n  -days              æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ã€‚\n  -out               æŒ‡å®šè¾“å‡ºçš„ csr è¯ä¹¦ç­¾åè¯·æ±‚æˆ–æ•°å­—ç­¾åè¯ä¹¦çš„åç§°\n  ```\n- `openssl x509` å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»ºä¸æŸ¥çœ‹æ•°å­—ç­¾åè¯ä¹¦  \n  ```bash\n  -req             æŒ‡å®š csr è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œä¸ -in é€‰é¡¹åˆç”¨ã€‚                \n  -in              æŒ‡å®šè¾“å…¥æ–‡ä»¶\n  -CAkey           æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA ç§é’¥\n  -CA              æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA æ ¹è¯ä¹¦\n  -CAcreateserial  åˆ›å»º CA åºåˆ—å·æ–‡ä»¶ï¼Œæ‰©å±•åä¸º \".srl\"ï¼Œè¯¥é€‰é¡¹å¿…é¡»ä¸ -CA é€‰é¡¹åˆç”¨ã€‚\n  -days            æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ï¼Œä¸ä¸\n                   -preserve_dates é€‰é¡¹åˆç”¨ã€‚\n  -out             æŒ‡å®šè¾“å‡ºçš„æ•°å­—ç­¾åè¯ä¹¦åç§°\n  ```\n- åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦çš„ 2 ç§æ–¹æ³•ï¼š  \n  - 1ï¸âƒ£ å…ˆåˆ›å»ºç§é’¥å†åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦  \n  - 2ï¸âƒ£ åŒæ—¶åˆ›å»ºç§é’¥ä¸è‡ªç­¾åæ•°å­—è¯ä¹¦    \n    ```bash\n    $ openssl req -newkey rsa:4096 -nodes -keyout server.key \\\n      -sha256 -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\" \\\n      -x509 -days 3650 -out server.crt\n    ```\n- åˆ›å»º CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆroot-caï¼‰ï¼š  \n  ```bash\n  $ openssl genrsa [-des3] -out ca.key [1024|2048|4096]\n  # åˆ›å»º CA RSA ç§é’¥\n  # -des3 é€‰é¡¹ï¼šäº¤äº’è¾“å…¥å¯†ç ä¸º RSA ç§é’¥åŠ å¯†\n  \n  $ openssl req -key ca.key \\\n    -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\" \\\n    -new -x509 \\\n    -days 3650 -out ca.crt\n  # åˆ›å»º CA è‡ªç­¾åæ ¹è¯ä¹¦\n  \n  $ openssl rsa -in ca.key -text -noout\n  # æŸ¥çœ‹ CA RSA ç§é’¥çš„è¯¦ç»†ä¿¡æ¯\n  \n  $ openssl x509 -in ca.crt -text -noout\n  # æŸ¥çœ‹ CA æ ¹è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯\n  ```\n- åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  \n  ```bash\n  $ openssl genrsa [-des3] -out server.key [1024|2048|4096]\n  # åˆ›å»º server ç«¯ RSA ç§é’¥\n  \n  $ openssl rsa -in server.key -pubout -out server.pub\n  # æå– server ç«¯ RSA ç§é’¥å¯¹åº”çš„å…¬é’¥ï¼ˆå…¬é’¥ç”±ç§é’¥ä¸­æå–ï¼‰\n  \n  $ openssl req -key server.key \\\n    -subj \"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\" \\\n    -new -out server.csr\n  # åˆ›å»º server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcertificate signing requestï¼‰\n  # æ³¨æ„ï¼š\n  #   1. åˆ›å»º csr ä¸ä½¿ç”¨ -x509 ä¸ -days é€‰é¡¹\n  #   2. åœ¨åˆ›å»ºç”ŸæˆæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚æ—¶å‡è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹ï¼š\n  #      a. CA æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å³å¯ï¼Œæ‰€æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¯ä¹¦è¯¥å­—æ®µ\n  #         éœ€è¦å¡«å†™ IP æˆ–åŸŸåã€‚\n  #      b. ä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼ŒCA æ ¹è¯ä¹¦çš„è¯¥å­—æ®µå’ŒæœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ä¸èƒ½ä¸€æ ·ã€‚\n  #      c. å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼ŒCA æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´ï¼Œæœ€åçš„å¯†ç \n  #         å¯ç›´æ¥å›è½¦è·³è¿‡ã€‚\n  \n  $ openssl req -noout -text -in server.csr\n  # æŸ¥çœ‹ server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯\n  \n  $ openssl x509 -req -in server.csr \\\n    -CAkey ca.key -CA ca.crt -CAcreateserial \\\n    -days 3650 -out server.crt\n  # ä½¿ç”¨ server ç«¯ csr è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦\n  \n  ### æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„ç›¸å…³ä¿¡æ¯ ###\n  $ openssl x509 -noout -serial -in server.crt\n  # æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„åºåˆ—å·\n  $ openssl x509 -noout -dates -in server.crt\n  # æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„æœ‰æ•ˆæœŸ\n  $ openssl x509 -noout -pubkey -in server.crt\n  # æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥ä¿¡æ¯ï¼Œè¯¥å…¬é’¥ä¸ç§é’¥ä¸­æå–çš„å…¬é’¥ä¸€è‡´ã€‚\n  ```\n- åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  \n  ```bash\n  $ openssl genrsa [-des3] -out client.key [1024|2048|4096]\n  # åˆ›å»º client ç«¯ RSA ç§é’¥\n  \n  $ openssl req -key client.key \\\n    -subj \"/C=CN/ST=Shanghai/L=Shanghai/CN=sec-srv.lab.example.com\" \\\n    -new -out client.csr\n  # åˆ›å»º client ç«¯è¯ä¹¦ç­¾åè¯·æ±‚\n  \n  $ openssl x509 -req -in client.csr \\\n    -CAkey ca.key -CA ca.crt -CAcreateserial \\\n    -days 3650 -out client.crt\n  # ä½¿ç”¨è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦\n  ```\n\n### openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\n- ä½¿ç”¨ server ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå•å‘è¿æ¥æµ‹è¯•ï¼š  \n  ```bash\n  $ openssl s_server -accept <port> -key server.key -cert server.crt    \n  # server ç«¯ï¼šå¯åŠ¨å•å‘å®‰å…¨è¿æ¥ï¼Œå¯åŠ¨åå°†ç­‰å¾… client ç«¯å‘é€ä¿¡æ¯å¹¶å›æ˜¾\n  $ openssl s_client -connect <host_ip>:<port>\n  # client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚\n  ```\n- ä½¿ç”¨ server ç«¯ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡ŒåŒå‘è¿æ¥æµ‹è¯•ï¼š  \n  ```bash\n  $ openssl s_server -accept <port> \\\n    -key server.key -cert server.crt -Verify <depth>\n  # server ç«¯ï¼šå¼ºåˆ¶è¦æ±‚ client ç«¯æä¾›ç§é’¥ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå®‰å…¨è¿æ¥\n  $ openssl s_server -accept 10001 \\\n    -key server.key -cert server.crt -Verify 5\n  \n  $ openssl s_client -connect <host_ip>:<port> \\\n    -key client.key -cert client.crt\n  # client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚\n  $ openssl s_client \\\n    -connect 10.197.11.100:10001 -key client.key -cert client.crt\n  ```\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [HTTPS åŠ å¯†åè®®è¯¦è§£ (å››)ï¼šTLS/SSL æ¡æ‰‹è¿‡ç¨‹](https://www.wosign.com/FAQ/faq2016-0309-04.htm)\n- [TLS/SSL åè®®è¯¦è§£(12) server key exchange](https://blog.csdn.net/mrpre/article/details/77867831)\n- [ä»€ä¹ˆæ˜¯ HTTPS åŒå‘è®¤è¯(MutualTLSauthentication)_API ç½‘å…³ - é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ](https://help.aliyun.com/document_detail/160093.html)\n- [HTTPS åŒå‘è¯ä¹¦è®¤è¯](https://blog.xizhibei.me/2021/02/03/https-two-way-authentication-with-certificates/)\n- [NGINX é…ç½®æœ¬åœ° HTTPS (åŒå‘è®¤è¯)](https://www.cnblogs.com/xiao987334176/p/11041241.html)\n- [å¸¸è§è¯ä¹¦æ ¼å¼å’Œè½¬æ¢](https://blog.csdn.net/justinjing0612/article/details/7770301)\n- [å¸¸è§è¯ä¹¦æ ¼å¼åŠç›¸äº’è½¬æ¢](https://www.cnblogs.com/lzjsky/archive/2010/11/14/1877143.html)\n- [openssl ç”Ÿæˆè‡ªç­¾è¯ä¹¦åŠæŸ¥çœ‹è¯ä¹¦ç»†èŠ‚](https://www.cnblogs.com/threegun/p/7130985.html)","slug":"https-handshake-authentication","published":1,"updated":"2023-01-20T06:02:32.409Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonol2000b16vdp2mvhc7i","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼š<code>CentOS Linux release 7.9.2009 (Core)</code></li>\n<li>Kernel ç‰ˆæœ¬ï¼š<code>4.20.3-1.el7.elrepo.x86_64</code></li>\n<li>OpenSSL ç‰ˆæœ¬ï¼š<code>openssl-1.0.2k-21.el7_9.x86_64.rpm</code></li>\n<li>Docker ç‰ˆæœ¬ï¼š<code>20.10.8</code></li>\n<li>Nginx ç‰ˆæœ¬ï¼š<code>1.22.1</code></li>\n<li>âœ¨ HTTPS åœ¨å¸¸è§„ Web æœåŠ¡å™¨ã€ä¸­é—´ä»¶æœåŠ¡å™¨åŠ <code>RESTful API</code> ç­‰é€šä¿¡ä¸­å¹¿æ³›å¤§é‡ä½¿ç”¨ï¼Œå› æ­¤ç†è§£ HTTPS åŠç›¸å…³æ¦‚å¿µæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚</li>\n<li>è¯¥æ–‡æ¡£ä½¿ç”¨ openssl å·¥å…·åˆ›å»ºä¸ç®¡ç†ç›¸å…³ç§é’¥ä¸è¯ä¹¦ï¼Œå½“ç„¶ä¹Ÿå¯ä½¿ç”¨ cfssl æˆ– certtoolï¼ˆæ¥æºäº gnutls-utils è½¯ä»¶åŒ…ï¼‰å·¥å…·åˆ›å»ºä¸ç®¡ç†ã€‚</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>åŠ å¯†é€šä¿¡èƒŒæ™¯</li>\n<li>ä¿è¯æ•°æ®çš„æœºå¯†æ€§</li>\n<li>ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§</li>\n<li>ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯</li>\n<li>æ•°å­—ç­¾ååŸç†</li>\n<li>SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­</li>\n<li>SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹</li>\n<li>åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯</li>\n<li>HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æ</li>\n<li>HTTPS å•å‘è®¤è¯æµ‹è¯•</li>\n<li>HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•</li>\n<li>openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»</li>\n<li>openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\"><a href=\"#åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\" class=\"headerlink\" title=\"åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\"></a>åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š</h3><ul>\n<li>ç½‘ç»œå®‰å…¨é—®é¢˜ï¼š<br>HTTP ä¸ä½¿ç”¨ SSL/TLS è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œæ‰€æœ‰ä¿¡æ¯æ˜æ–‡ä¼ æ’­ï¼Œå¸¦æ¥äº†ä¸‰å¤§é£é™©ï¼š  <ul>\n<li>çªƒå¬é£é™©ï¼ˆeavesdroppingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥è·çŸ¥é€šä¿¡å†…å®¹  </li>\n<li>ç¯¡æ”¹é£é™©ï¼ˆtamperingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥ä¿®æ”¹é€šä¿¡å†…å®¹  </li>\n<li>å†’å……é£é™©ï¼ˆpretendingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥å†’å……ä»–äººèº«ä»½å‚ä¸é€šä¿¡</li>\n</ul>\n</li>\n<li>ç½‘ç»œå®‰å…¨é—®é¢˜çš„è§£å†³æ€è·¯ï¼š<code>SSL/TLS</code> åè®®  <ul>\n<li>æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯åŠ å¯†ä¼ æ’­ï¼Œç¬¬ä¸‰æ–¹æ— æ³•çªƒå¬ã€‚  </li>\n<li>å…·æœ‰æ ¡éªŒæœºåˆ¶ï¼Œä¸€æ—¦è¢«ç¯¡æ”¹ï¼Œé€šä¿¡åŒæ–¹ä¼šç«‹åˆ»å‘ç°ã€‚  </li>\n<li>é…å¤‡èº«ä»½è¯ä¹¦ï¼Œé˜²æ­¢èº«ä»½è¢«å†’å……ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\"><a href=\"#ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\" class=\"headerlink\" title=\"ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\"></a>ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬</h3><ul>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼šå¯¹ç§°åŠ å¯†ç®—æ³•</li>\n<li>ğŸ’¥ å•çº¯çš„æ•°æ®åŠ å¯†åªèƒ½ä¿è¯æ•°æ®ä¸è¢«æ³„éœ²ï¼Œä½†ä¸èƒ½ä¿è¯æ¥æ”¶æ–¹æ”¶åˆ°çš„æ•°æ®çš„çœŸå®æ€§ã€‚</li>\n</ul>\n<h3 id=\"ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\"><a href=\"#ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\" class=\"headerlink\" title=\"ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\"></a>ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹</h3><ul>\n<li>æ•°æ®çš„çœŸå®æ€§ï¼šçœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œæ•°æ®æ˜¯ä»çœŸå®å‘é€è€…å‘æ¥ã€‚</li>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼šæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆæˆ–ç§°æ•£åˆ—ç®—æ³•/å•å‘æ•£åˆ—å‡½æ•°ï¼‰ç”Ÿæˆæ•°æ®æŒ‡çº¹ï¼ˆç‰¹å¾ç ï¼‰</li>\n<li>ğŸ’¥ åˆ©ç”¨æå–æ•°æ®æŒ‡çº¹çš„æ–¹å¼ï¼Œå®Œæˆæ•°æ®ä¼ è¾“çš„å®Œæ•´æ€§éªŒè¯ã€‚</li>\n<li>ğŸ”’ å®é™…çš„ç®—æ³•å®ç°è¿‡ç¨‹æ¦‚è¦ï¼š  <ul>\n<li>ç»™ä¸€æ®µæ˜æ–‡æ•°æ®ï¼ˆplain textï¼‰åŠ ä¸Šæ•°æ®ä¿¡æ¯æŒ‡çº¹ï¼Œè¿™ä¸ªæŒ‡çº¹æ˜¯é€šè¿‡ç»“åˆæ•°æ®ä¿¡æ¯è¿›è¡Œç›¸åº”ç®—æ³•è·å¾—çš„æ•°æ®æŒ‡çº¹ã€‚  </li>\n<li>æ¥æ”¶æ–¹å½“æ”¶åˆ°æ•°æ®ä¿¡æ¯åï¼Œä¼šåˆ©ç”¨ç›¸åŒçš„ç®—æ³•å¯¹è·å–çš„æ•°æ®è®¡ç®—æŒ‡çº¹ï¼Œç¡®è®¤å¾—åˆ°çš„æŒ‡çº¹æ˜¯å¦ä¸ä¼ é€è¿‡æ¥çš„æè¿°æ•°æ®çš„æŒ‡çº¹ä¸€è‡´ã€‚  </li>\n<li>å¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®å®Œæ•´æ€§é­åˆ°ç ´åï¼Œæ•°æ®ä¸€æ¦‚ä¸äºˆä»¥æ¥æ”¶å¤„ç†ã€‚</li>\n</ul>\n</li>\n<li>ç”±äºå¯èƒ½å­˜åœ¨ä¸­é—´äººæ”»å‡»çš„å¯èƒ½æ€§ï¼Œå› æ­¤å¯å¯¹ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®æŒ‡çº¹è¿›è¡ŒåŠ å¯†ã€‚</li>\n<li>å‘é€æ–¹åˆ©ç”¨å¯¹ç§°å¯†é’¥æ–¹å¼å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡ŒåŠ å¯†ï¼Œæ¥æ”¶æ–¹ä¼šåˆ©ç”¨ç›¸åŒçš„å¯†é’¥å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œä»è€Œç¡®è®¤æŒ‡çº¹æ˜¯å¦ä¸€è‡´ã€‚</li>\n<li>å¦‚æœä¸­é—´äººå°†æ–°çš„æŒ‡çº¹ä¹Ÿè¿›è¡Œäº†åŠ å¯†ï¼Œå‘é€ç»™æ¥æ”¶æ–¹ï¼Œä½†æ¥æ”¶æ–¹æ— æ³•åˆ©ç”¨å’Œå‘é€æ–¹åå•†å¥½çš„è§£å¯†å¯†é’¥å¯¹æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œæœ€ç»ˆæ— æ³•è¯†åˆ«ä¸­é—´äººå‘é€è¿‡æ¥çš„æ•°æ®æŒ‡çº¹ä¿¡æ¯ã€‚</li>\n<li>ğŸ¤˜ é€šè¿‡åŠ å¯†æŒ‡çº¹å¯ä»¥ä¿è¯çœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚</li>\n</ul>\n<h3 id=\"ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\"><a href=\"#ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\" class=\"headerlink\" title=\"ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\"></a>ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š</h3><ul>\n<li>ä»¥ä¸Šä¿¡æ¯åªæ˜¯è§£å†³æ•°æ®çš„äº¤æ¢è·å–é—®é¢˜ï¼Œä½†æ˜¯ç½‘ç»œçš„èº«ä»½éªŒè¯é—®é¢˜ä¾æ—§æ²¡æœ‰è§£å†³ã€‚</li>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼šéå¯¹ç§°åŠ å¯†</li>\n<li>åˆ©ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ç½‘ç»œä¸­æ•°æ®ä¼ è¾“åŒæ–¹çš„å®‰å…¨èº«ä»½éªŒè¯é—®é¢˜ã€‚</li>\n<li>ğŸ’¥ éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œå­˜åœ¨å¯†é’¥å¯¹çš„æ¦‚å¿µï¼Œå³æ‹¥æœ‰å…¬é’¥ï¼ˆ<code>public key</code>ï¼‰ä¸ç§é’¥ï¼ˆ<code>private key</code>ï¼‰ï¼Œå…¶ä¸­å…¬é’¥ä¸æ˜¯è‡ªè¡Œåˆ›å»ºå‡ºæ¥çš„è€Œæ˜¯ä»ç§é’¥ä¸­æå–å‡ºæ¥ä¸€éƒ¨åˆ†ä½œä¸ºå…¬é’¥ï¼Œå› æ­¤å¯ä»¥è¯´å…¬é’¥æ˜¯æ¥è‡ªäºç§é’¥çš„ï¼Œè€Œç§é’¥æ‰å†³å®šå¯†é’¥åŠ å¯†çš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”ç§é’¥çš„é•¿åº¦å¯èƒ½ä¼šéå¸¸é•¿ï¼Œä»æœ€åˆçš„ 1024ã€2048 åˆ° 4096 ä¸€ç›´åˆ°æ›´å¤šçš„ä½æ•°ã€‚å¢åŠ ç§é’¥å¯†é’¥ä½ï¼Œä»è€Œæå‡å¯†é’¥å®‰å…¨æ€§ã€‚</li>\n<li>éå¯¹ç§°åŠ å¯†ç®—æ³•éµå¾ªçš„åŸºæœ¬åŸåˆ™ï¼šå…¬é’¥åŠ å¯†çš„åªèƒ½åˆ©ç”¨ä¸ä¹‹é…å¯¹çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œåä¹‹äº¦ç„¶ã€‚</li>\n<li>éå¯¹ç§°åŠ å¯†ç®—æ³•å¯ä»¥æ»¡è¶³æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹ä¼ è¾“è€…èº«ä»½éªŒè¯çš„éœ€æ±‚ï¼Œå› ä¸ºæ¥æ”¶è€…å¯ä»¥æ‹¥æœ‰ç›¸åº”çš„å…¬é’¥ï¼Œåªæœ‰ä¸ä¹‹å¯¹åº”çš„å‘é€è€…ç”¨ç›¸åº”çš„ç§é’¥è¿›è¡ŒåŠ å¯†ä¿¡æ¯ï¼Œæ¥æ”¶è€…ç”¨å¯¹åº”çš„å…¬é’¥æ‰å¯è§£å¯†ï¼Œå¦åˆ™å¯ä»¥ç¡®è®¤å‘é€è€…èº«ä»½å·²ç»å‘ç”Ÿå˜åŒ–ã€‚</li>\n</ul>\n<h3 id=\"ğŸ¦„-æ•°å­—ç­¾ååŸç†ï¼š\"><a href=\"#ğŸ¦„-æ•°å­—ç­¾ååŸç†ï¼š\" class=\"headerlink\" title=\"ğŸ¦„ æ•°å­—ç­¾ååŸç†ï¼š\"></a>ğŸ¦„ æ•°å­—ç­¾ååŸç†ï¼š</h3><ul>\n<li><strong><font color=\"orange\">å…¬é’¥åŠ å¯†ç®—æ³•</font></strong> è§£å†³é€šä¿¡åŒæ–¹èº«ä»½éªŒè¯é—®é¢˜ï¼Œä½†æ— æ³•ç¡®ä¿å…¬é’¥çš„çœŸå®æ€§ã€‚</li>\n<li>å› æ­¤ï¼ŒCA æ•°å­—ç­¾åä½¿ç”¨è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertification Authorityï¼Œç®€ç§° <code>CA</code>ï¼‰è§£å†³é€šä¿¡åŒæ–¹äº¤æ¢çš„å…¬é’¥çš„çœŸå®æ€§ï¼Œå³æ•°å­—è¯ä¹¦çš„çœŸå®æ€§ï¼ˆå…¬é’¥åŒ…å«äºæ•°å­—è¯ä¹¦ä¸­ï¼‰ã€‚</li>\n<li>æ•°å­—ç­¾åè¯ä¹¦çš„åˆ†ç±»ï¼š  <ul>\n<li>è‡ªç­¾åæ•°å­—ç­¾åè¯ä¹¦ï¼š<br>ä¸ä½¿ç”¨ <code>ca.key</code> åŠ å¯†ç”Ÿæˆç­¾åï¼Œä½¿ç”¨è‡ªèº«çš„ç§é’¥åŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ <code>GnuPG</code> é‚®ä»¶åŠ å¯†ä¼ è¾“ã€‚  </li>\n<li>CA æ•°å­—ç­¾åè¯ä¹¦ï¼š<br>ä½¿ç”¨ CA è¯ä¹¦æˆæƒä¸­å¿ƒçš„ <code>ca.key</code> ä¸ <code>ca.crt</code> è¿›è¡ŒåŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ <code>kube-apiserver</code>ã€Apacheã€Nginxã€Tomcat ç­‰ï¼Œä»¥ä¸‹è®¨è®ºè¯¥ç±»å‹è¯ä¹¦ã€‚</li>\n</ul>\n</li>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼š<strong><font color=\"orange\">å…¬é’¥éå¯¹ç§°åŠ å¯†ç®—æ³• + æ¶ˆæ¯æ‘˜è¦ç®—æ³•</font></strong></li>\n<li>æ ‡å‡†çš„ <code>X.509</code> æ ¼å¼çš„ CA æ•°å­—ç­¾åè¯ä¹¦ç»„æˆï¼š  <ul>\n<li>è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ï¼šæ˜æ–‡æ˜¾ç¤º    <ul>\n<li>è¯ä¹¦çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersionï¼‰    </li>\n<li>è¯ä¹¦çš„åºåˆ—å·ï¼ˆSerial Numberï¼Œ<code>srl</code>ï¼‰ï¼šæ¯ä¸ªè¯ä¹¦éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¯ä¹¦åºåˆ—å·    </li>\n<li>è¯ä¹¦æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼š<code>sha256WithRSAEncryption</code>    </li>\n<li>è¯ä¹¦çš„å‘è¡Œæœºæ„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ <code>X.500</code> æ ¼å¼ï¼ˆç›®å½•æœåŠ¡åè®® X.500ï¼‰    </li>\n<li>â± è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼šç°åœ¨é€šç”¨çš„è¯ä¹¦ä¸€èˆ¬é‡‡ç”¨ UTC æ—¶é—´æ ¼å¼ï¼Œè®¡æ—¶èŒƒå›´ä¸º 1950-2049ã€‚    </li>\n<li>è¯ä¹¦æ‰€æœ‰äººçš„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ <code>X.500</code> æ ¼å¼    </li>\n<li>è¯ä¹¦æ‰€æœ‰äººçš„å…¬é’¥ä¿¡æ¯    </li>\n<li>CA æ•°å­—ç­¾åæ ¡éªŒç   </li>\n</ul>\n</li>\n<li>è¯ä¹¦æ•°å­—ç­¾åï¼ˆSï¼‰ï¼šå¯†æ–‡æ˜¾ç¤º    <ul>\n<li>è¯ä¹¦å‘è¡Œè€…ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰ä½¿ç”¨ CA ç§é’¥åŠ å¯†ç”Ÿæˆç­¾å</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>ğŸ”¥ CA æ•°å­—ç­¾åè¯ä¹¦ç”Ÿæˆè¿‡ç¨‹ï¼š  </p>\n<ul>\n<li>è¯¥ç”Ÿæˆè¿‡ç¨‹æ»¡è¶³å‡½æ•°è¡¨è¾¾å¼ï¼š<code>S = F(Digest(C))</code></li>\n<li>å…¶ä¸­ S ä¸ºè¯ä¹¦æ•°å­—ç­¾åï¼ŒF ä¸ºç­¾åç®—æ³•ï¼ŒDigest ä¸ºæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆMD5/SHA1/SHA256ç­‰ï¼‰ï¼ŒC ä¸ºè¯ä¹¦ç›¸å…³ä¿¡æ¯ã€‚  </li>\n<li>1ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯åˆ›å»ºå„è‡ªçš„ç§é’¥ï¼Œå¹¶ä½¿ç”¨è¯¥ç§é’¥åˆ›å»º <code>csr</code> è¯ä¹¦ç­¾åè¯·æ±‚ã€‚  </li>\n<li>2ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ <code>csr</code> è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­åŒ…å«è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ä¸ç›¸åº”çš„å…¬é’¥ä¿¡æ¯ã€‚  </li>\n<li>3ï¸âƒ£ ä½¿ç”¨æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ç”Ÿæˆç›¸åº”æŒ‡çº¹ï¼ˆfingerprintï¼‰ï¼Œå†ä½¿ç”¨ CA ç§é’¥ï¼ˆca.keyï¼‰é…åˆ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰åŠ å¯†è¯¥æŒ‡çº¹ï¼Œæœ€åç”ŸæˆæœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ CA æ•°å­—ç­¾åè¯ä¹¦ã€‚  </li>\n<li>è¯¥ CA æ•°å­—ç­¾ååªèƒ½è¢« CA ç§é’¥ï¼ˆca.keyï¼‰å¯¹åº”ä½äº CA æ ¹è¯ä¹¦ä¸­çš„ CA å…¬é’¥è§£å¼€ã€‚  </li>\n<li><p>åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼šä¹Ÿå¯å‚è€ƒè¯¥ <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/create-ssl-certs.sh\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a> ä»¥è·å¾—ä»¥ä¸‹è¿‡ç¨‹çš„å®Œæ•´è„šæœ¬</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa -out CA-center.key 2048</span><br><span class=\"line\">$ openssl req -key CA-center.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -x509 -days 3650 -out CA-center.crt</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆè‡ªç­¾åï¼‰</span></span><br><span class=\"line\">$ openssl x509 -noout -text -<span class=\"keyword\">in</span> CA-center.crt</span><br><span class=\"line\">  Certificate:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 3 (0x2)</span><br><span class=\"line\">        Serial Number:</span><br><span class=\"line\">            fb:53:9c:3c:4d:81:f6:de</span><br><span class=\"line\">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class=\"line\">        Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com</span><br><span class=\"line\">        Validity</span><br><span class=\"line\">            Not Before: Jan  2 14:04:46 2023 GMT</span><br><span class=\"line\">            Not After : Dec 30 14:04:46 2032 GMT</span><br><span class=\"line\">        Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com</span><br><span class=\"line\">        <span class=\"comment\"># ç”±äºä½¿ç”¨ CA ç§é’¥è‡ªç­¾åç”Ÿæˆçš„ CA æ ¹è¯ä¹¦ï¼Œå…¶è¯ä¹¦å‘è¡Œæœºæ„ä¸æ‰€æœ‰äººç›¸åŒã€‚</span></span><br><span class=\"line\">        Subject Public Key Info:</span><br><span class=\"line\">            Public Key Algorithm: rsaEncryption</span><br><span class=\"line\">                Public-Key: (2048 bit)</span><br><span class=\"line\">                Modulus:</span><br><span class=\"line\">                    00:bf:9a:3d:48:8c:b9:21:cb:d4:e5:30:df:4a:0e:</span><br><span class=\"line\">                    05:e1:29:fe:5c:1f:06:4d:fb:89:fe:f5:01:c7:37:</span><br><span class=\"line\">                    c5:ee:f5:66:8f:2f:bd:48:82:a1:80:1e:00:9d:a0:</span><br><span class=\"line\">                    ...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa -out server.key 2048</span><br><span class=\"line\">$ openssl req -key server.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -out server.csr</span><br><span class=\"line\">$ openssl req -noout -text -<span class=\"keyword\">in</span> server.csr</span><br><span class=\"line\">  Certificate Request:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 0 (0x0)</span><br><span class=\"line\">        Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com </span><br><span class=\"line\">        <span class=\"comment\"># éœ€ç­¾åæœåŠ¡ç«¯è¯ä¹¦çš„æ‰€æœ‰äºº</span></span><br><span class=\"line\">        Subject Public Key Info:  <span class=\"comment\"># csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸­çš„å…¬é’¥ä¿¡æ¯</span></span><br><span class=\"line\">            Public Key Algorithm: rsaEncryption  <span class=\"comment\"># å…¬é’¥åŠ å¯†ç®—æ³•ï¼šRSAï¼ˆä¸å¯¹ç§°åŠ å¯†ï¼‰</span></span><br><span class=\"line\">                Public-Key: (2048 bit)</span><br><span class=\"line\">                Modulus:</span><br><span class=\"line\">                    00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:</span><br><span class=\"line\">                    e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:</span><br><span class=\"line\">                    54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:</span><br><span class=\"line\">                    ...</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸æŸ¥çœ‹æœåŠ¡ç«¯ç§é’¥åŠ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> server.csr \\</span><br><span class=\"line\">  -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out server.crt</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ç­¾å‘æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦</span></span><br><span class=\"line\">$ openssl x509 -noout -text -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\">  Certificate:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 1 (0x0)</span><br><span class=\"line\">        Serial Number:</span><br><span class=\"line\">            a9:68:e7:c4:87:87:4e:03</span><br><span class=\"line\">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class=\"line\">        Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com </span><br><span class=\"line\">        <span class=\"comment\"># æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„å‘è¡Œæœºæ„ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰</span></span><br><span class=\"line\">        Validity</span><br><span class=\"line\">            Not Before: Jan  2 14:04:46 2023 GMT</span><br><span class=\"line\">            Not After : Dec 30 14:04:46 2032 GMT</span><br><span class=\"line\">        Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com</span><br><span class=\"line\">        <span class=\"comment\"># æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„æ‰€æœ‰äººï¼šæœåŠ¡ç«¯ä¿¡æ¯</span></span><br><span class=\"line\">        Subject Public Key Info:</span><br><span class=\"line\">            Public Key Algorithm: rsaEncryption</span><br><span class=\"line\">                Public-Key: (2048 bit)</span><br><span class=\"line\">                Modulus:</span><br><span class=\"line\">                    00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:</span><br><span class=\"line\">                    e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:</span><br><span class=\"line\">                    54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:</span><br><span class=\"line\">                    ...</span><br><span class=\"line\"><span class=\"comment\"># è¯¥æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„æœåŠ¡ç«¯å…¬é’¥ä¿¡æ¯ä¸å…¶ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­çš„ç›¸åŒ</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦è¿‡ç¨‹ï¼š  </p>\n<ul>\n<li>éªŒè¯æœåŠ¡ç«¯ CA æ•°å­—ç­¾åï¼š    <ul>\n<li>å®¢æˆ·ç«¯éœ€å…·æœ‰ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰    </li>\n<li>å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯ CA æ•°å­—ç­¾åçš„éªŒè¯æ»¡è¶³è¡¨è¾¾å¼ï¼š<code>F&#39;(S) = Digest(C)</code></li>\n<li>å®¢æˆ·ç«¯å°†æ‰§è¡Œä¸¤ç§è®¡ç®—ï¼Œå¹¶å°†è®¡ç®—ç»“æœè¿›è¡Œæ¯”å¯¹ï¼š<br>1ï¸âƒ£ ç”±äºè¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ä»¥æ˜æ–‡æ˜¾ç¤ºï¼Œé€šè¿‡æ¶ˆæ¯æ‘˜è¦ç®—æ³•è®¡ç®— C çš„å“ˆå¸Œå€¼ã€‚<br>2ï¸âƒ£ ä½¿ç”¨ CA å…¬é’¥è§£å¯†ç”±æœåŠ¡ç«¯é€šè¿‡ CA ç§é’¥åŠ å¯†çš„ CA æ•°å­—ç­¾åï¼Œè·å¾—åŸå§‹è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰çš„å“ˆå¸Œå€¼ã€‚<br>3ï¸âƒ£ è‹¥ä¸¤è€…ç»“æœä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦æœ‰æ•ˆä¸”æ¥è‡ªè¯¥ CAï¼Œæœªè¢«ç¯¡æ”¹ï¼›è‹¥ä¸¤è€…ç»“æœä¸ä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦å·²è¢«ä¸­é—´äººç¯¡æ”¹æˆ–ä¸æ¥è‡ªè¯¥ CAã€‚  </li>\n</ul>\n</li>\n<li>æå–æœåŠ¡ç«¯å…¬é’¥ï¼š    <ul>\n<li>CA æ•°å­—ç­¾åéªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æå–å‡ºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥è¿›è¡Œé€šä¿¡ã€‚    </li>\n<li>ğŸ¤ è¯ä¹¦éªŒè¯åœ¨ <code>SSL/TLS</code> æ¡æ‰‹è¿‡ç¨‹çš„ <code>Server Hello Done</code> ä¸ <code>Client Key Exchange</code> ä¹‹é—´ã€‚  </li>\n</ul>\n</li>\n<li>ğŸš€ éªŒè¯è¿‡ç¨‹ä¸åŸç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"ca-signed-certification-verify.jpg\" alt></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"SSL-TLS-ä¸-CA-ç›¸å…³æœ¯è¯­ï¼š\"><a href=\"#SSL-TLS-ä¸-CA-ç›¸å…³æœ¯è¯­ï¼š\" class=\"headerlink\" title=\"SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­ï¼š\"></a>SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­ï¼š</h3><ul>\n<li>è¯ä¹¦æ ‡å‡†ï¼š<code>X.509</code></li>\n<li>ç¼–ç æ ¼å¼ï¼š  <ul>\n<li>âœ¨ <code>PEM</code>ï¼š    <ul>\n<li>privacy enhanced Mail    </li>\n<li>çº¯æ–‡æœ¬å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ˆBase64 ç¼–ç ï¼‰ï¼ŒApache ä¸ *nix æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚  </li>\n</ul>\n</li>\n<li><code>DER</code>ï¼š    <ul>\n<li>distinguished encoding Rules    </li>\n<li>äºŒè¿›åˆ¶å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ŒJava ä¸ Windows æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>è¯ä¹¦ï¼ˆæ•°å­—ç­¾åè¯ä¹¦ï¼‰ï¼šcertificateï¼ˆ<code>CER</code> æˆ– <code>CRT</code>ï¼‰</li>\n<li>ç§é’¥ï¼šprivate key</li>\n<li>ğŸ‘‰ è¯ä¹¦ç­¾åè¯·æ±‚ï¼š  <ul>\n<li>certificate signing request: <code>CSR</code>  </li>\n<li>è¯¥æ–‡ä»¶ä½¿ç”¨ç§é’¥åŠ å¯†ï¼ŒåŒ…å«å…¬é’¥ä¸ç­¾åç”³è¯·è€…ä¿¡æ¯ç­‰ã€‚</li>\n</ul>\n</li>\n<li>CER ä¸ CRT ä¸¤è€…éƒ½ä¸ºè¯ä¹¦ï¼ŒCRT åœ¨ Linux ä¸Šæ›´å¸¸è§ã€‚</li>\n<li>CERã€CRTã€KEYã€CSR éƒ½å¯ä¸º PEM æˆ– DER ç¼–ç æ ¼å¼ï¼</li>\n<li>æ”¯æŒ SSL/TLS åè®®çš„å¼€æºå·¥å…·ï¼š<code>openssl</code>ã€<code>cfssl</code>ã€<code>gnutls</code></li>\n<li>ğŸ“š man æŸ¥çœ‹ä»¥ä¸‹å‘½ä»¤ï¼š<br>opensslã€genrsaã€rsaã€reqã€x509ã€verifyã€s_clientã€s_server</li>\n</ul>\n<h3 id=\"SSL-TLS-åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\"><a href=\"#SSL-TLS-åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\" class=\"headerlink\" title=\"SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\"></a>SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š</h3><ul>\n<li>å®‰å…¨å¥—æ¥å­—å±‚åè®®ï¼šSecure Socket Layerï¼ˆSSLï¼‰</li>\n<li>ä¼ è¾“å±‚å®‰å…¨åè®®ï¼šTransport Layer Securityï¼ˆTLSï¼‰</li>\n<li>SSL/TLS å†å²èƒŒæ™¯ï¼š  <ul>\n<li>1994 å¹´ï¼ŒNetScape å…¬å¸è®¾è®¡äº† SSL åè®®çš„ 1.0 ç‰ˆï¼Œä½†æœªå‘å¸ƒã€‚  </li>\n<li>1995 å¹´ï¼ŒNetScape å…¬å¸å‘å¸ƒ SSL 2.0 ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚  </li>\n<li>1996 å¹´ï¼ŒSSL 3.0 ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚  </li>\n<li>1999 å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ ISOC æ¥æ›¿ NetScape å…¬å¸ï¼Œå‘å¸ƒäº† SSL çš„å‡çº§ç‰ˆ <code>TLS 1.0</code> ç‰ˆã€‚  </li>\n<li>2006 å¹´å’Œ 2008 å¹´ï¼ŒTLS è¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸º TLS 1.1 ç‰ˆå’Œ TLS 1.2 ç‰ˆã€‚  </li>\n<li>ğŸ‘‰ æœ€æ–°çš„å˜åŠ¨æ˜¯ 2011 å¹´ <code>TLS 1.2</code> çš„ä¿®è®¢ç‰ˆã€‚</li>\n</ul>\n</li>\n<li>TLS ä¸ SSL ä¹‹é—´çš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š  <ul>\n<li>TLS 1.0 å¯¹åº” SSL 3.1  </li>\n<li>TLS 1.1 å¯¹åº” SSL 3.2  </li>\n<li>TLS 1.2 å¯¹åº” SSL 3.3</li>\n</ul>\n</li>\n<li>ğŸ‘‰ ä¸€èˆ¬ä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº† <code>TLS 1.2</code> çš„æ”¯æŒã€‚</li>\n<li>SSL/TLS åè®®åœ¨ç½‘ç»œæ¨¡å‹ä¸­çš„ä½ç½®ï¼š<img src=\"ssl-tls-in-network-stack.png\" alt></li>\n<li>SSL/TLS åè®®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š  <ul>\n<li>Handshake Protocolï¼š<br>ğŸ¤ åå•†é€šä¿¡åŒæ–¹ä¹‹ååœ¨æœ¬æ¬¡ä¼šè¯ä¸­ç”¨äºæ•°æ®åŠ å¯†çš„ä¼šè¯å¯†é’¥ï¼ˆ<code>session key</code>ï¼‰ï¼Œè¯¥è¿‡ç¨‹ä¸º â€œæ¡æ‰‹é˜¶æ®µâ€ï¼Œå…¶ä¸­ä¼šè¯å¯†é’¥ä¹Ÿç§°ä¸ºåå•†å¯†é’¥ã€‚  </li>\n<li>Record Protocolï¼š<br>å®šä¹‰ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†çš„æ•°æ®çš„ä¼ è¾“æ ¼å¼ã€‚</li>\n</ul>\n</li>\n<li>SSL å±‚ï¼š<br>å€ŸåŠ©ä¸‹å±‚åè®®ï¼ˆTCP å±‚ï¼‰çš„çš„ä¿¡é“å®‰å…¨åœ°åå•†å‡ºä¸€ä»½ä¼šè¯å¯†é’¥ï¼Œå¹¶ç”¨æ­¤å¯†é’¥æ¥åŠ å¯† HTTP è¯·æ±‚ã€‚</li>\n<li>TCP å±‚ï¼š  <ul>\n<li>ä¸ Web server çš„ 443 ç«¯å£å»ºç«‹è¿æ¥ï¼Œä¼ é€’ç”± SSL å¤„ç†åçš„æ•°æ®ã€‚  </li>\n<li>SSL åœ¨ TCP ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªåŠ å¯†é€šé“ï¼Œé€šè¿‡è¿™ä¸€å±‚çš„æ•°æ®ç»è¿‡äº†åŠ å¯†ï¼Œå› æ­¤è¾¾åˆ°ä¿å¯†çš„æ•ˆæœã€‚</li>\n</ul>\n</li>\n<li>æœåŠ¡ç«¯æœ¬åœ°ä¸å®¢æˆ·ç«¯æœ¬åœ°çš„ SSL å¥—æ¥å­—ä¸ TCP å¥—æ¥å­—çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"client-server-tcp-ssl-socket.png\" alt></li>\n</ul>\n<h3 id=\"ğŸš€-åŸºäº-SSL-TLS-åŠ å¯†è¿æ¥çš„-HTTPS-å•-åŒå‘è®¤è¯ï¼š\"><a href=\"#ğŸš€-åŸºäº-SSL-TLS-åŠ å¯†è¿æ¥çš„-HTTPS-å•-åŒå‘è®¤è¯ï¼š\" class=\"headerlink\" title=\"ğŸš€ åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯ï¼š\"></a>ğŸš€ åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯ï¼š</h3><ul>\n<li>ä»¥ä¸Šå…³äºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„éªŒè¯åªæ˜¯ HTTPS é€šä¿¡ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œéœ€é€šè¿‡å…¶ä»–æ­¥éª¤å…±åŒå®Œæˆ HTTPS åŠ å¯†é€šä¿¡ã€‚</li>\n<li>HTTPS åŠ å¯†é€šä¿¡è®¤è¯åˆ†ä¸ºä¸¤ç±»ï¼šå•å‘è®¤è¯ã€åŒå‘è®¤è¯</li>\n<li>å•å‘è®¤è¯ä¸­åªéœ€æœåŠ¡ç«¯æä¾›æœåŠ¡ç«¯è¯ä¹¦ä¸ç§é’¥å³å¯ï¼Œè€ŒåŒå‘è®¤è¯ä¸­æœåŠ¡ç«¯éœ€æä¾›è¯ä¹¦ä¸ç§é’¥å¤–è¿˜éœ€æä¾› CA æ ¹è¯ä¹¦ï¼ˆè¯¥è¯ä¹¦ç”¨äºå®¢æˆ·ç«¯è¯ä¹¦çš„ç­¾å‘ï¼‰ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯éœ€æä¾›å®¢æˆ·ç«¯è¯ä¹¦ä¸ç§é’¥ã€‚</li>\n<li>å•å‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡ç«¯å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç„¶åå»ºç«‹å®‰å…¨é€šä¿¡é€šé“ã€‚</li>\n<li>åŒå‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯é™¤äº†éœ€è¦ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡å™¨çš„å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯å¤–ï¼Œè¿˜éœ€è¦æŠŠå®¢æˆ·ç«¯çš„å…¬é’¥è¯ä¹¦ä¸Šä¼ åˆ°æœåŠ¡ç«¯ç»™æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ï¼Œç­‰åŒæ–¹éƒ½è®¤è¯é€šè¿‡äº†ï¼Œæ‰å¼€å§‹å»ºç«‹å®‰å…¨é€šä¿¡é€šé“è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>\n<li>ğŸ‘¨â€ğŸ« <strong><font color=\"red\">æ€»ç»“ï¼š</font></strong><br>æ— è®º HTTPS å•å‘æˆ–åŒå‘è®¤è¯éƒ½æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åå•†å‡º <strong><font color=\"red\">ä¼šè¯å¯†é’¥</font></strong> ä¸ <strong><font color=\"red\">ä¼šè¯åŠ å¯†ç®—æ³•</font></strong> çš„è¿‡ç¨‹ã€‚</li>\n<li>âœ¨ ä»¥ä¸‹ä» HTTPS æŠ“åŒ…çš„è§’åº¦è¯´æ˜ SSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹ï¼š<img src=\"ssl-four-handshakes-https-single-and-mutual-authentication.png\" alt>ä¸Šå›¾ä¸­ <strong>é»‘è‰²ç®­å¤´</strong> è¡¨ç¤ºåŒå‘è®¤è¯è¿‡ç¨‹ä¸­å¤šå‡ºçš„æ­¥éª¤ï¼Œå…¶ä½™è¿‡ç¨‹ä¸ºå•å‘è®¤è¯è¿‡ç¨‹ã€‚</li>\n</ul>\n<h3 id=\"ğŸ§ª-HTTPS-å•å‘è®¤è¯çš„-Wireshark-æŠ“åŒ…åˆ†æï¼š\"><a href=\"#ğŸ§ª-HTTPS-å•å‘è®¤è¯çš„-Wireshark-æŠ“åŒ…åˆ†æï¼š\" class=\"headerlink\" title=\"ğŸ§ª HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æï¼š\"></a>ğŸ§ª HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æï¼š</h3><ul>\n<li>æœ¬ä¾‹ä½¿ç”¨ <code>Nginx HTTPS</code> æœåŠ¡æµ‹è¯• HTTPSï¼ˆHTTP + SSL/TLSï¼‰åŠ å¯†é€šä¿¡ã€‚</li>\n<li>ä½¿ç”¨å·²é…ç½®æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„ Nginx å®¹å™¨æµ‹è¯• HTTPS åŠ å¯†é€šä¿¡è¿‡ç¨‹ï¼Œå¹¶ä½¿ç”¨ <code>Wireshark</code> æŠ“åŒ…åˆ†æã€‚</li>\n<li><p>æ„å»º Nginx å®¹å™¨ä½¿ç”¨çš„ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/nginx-ssl\" target=\"_blank\" rel=\"noopener\">Dockerfile</a> å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># modified date: </span></span><br><span class=\"line\"><span class=\"comment\">#     - 2019-12-10: initial Dockerfile</span></span><br><span class=\"line\"><span class=\"comment\">#     - 2023-01-16: update nginx and add client ssl authentication</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> docker.io/library/centos:<span class=\"number\">7.9</span>.<span class=\"number\">2009</span></span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> lhua <span class=\"string\">\"hualongfeiyyy@163.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># install nginx dependent packages</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> yum repolist &amp;&amp; \\ </span></span><br><span class=\"line\">    yum install -y gcc* &amp;&amp; \\</span><br><span class=\"line\">    yum install -y pcre-devel openssl openssl-devel &amp;&amp; \\</span><br><span class=\"line\">    yum clean all &amp;&amp; \\</span><br><span class=\"line\">    mkdir -p /application/nginx-<span class=\"number\">1.22</span>.<span class=\"number\">1</span> &amp;&amp; \\</span><br><span class=\"line\">    useradd -u <span class=\"number\">1005</span> -M -s /sbin/nologin nginx</span><br><span class=\"line\">    <span class=\"comment\"># create nginx user to run nginx worker processes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># copy nginx source package to container rootfs</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> nginx-1.22.1.tar.gz /tmp/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># make install nginx </span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> <span class=\"built_in\">cd</span> /tmp/nginx-1.22.1 &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    ./configure --user=nginx --group=nginx --prefix=/application/nginx-1.22.1 \\</span></span><br><span class=\"line\"><span class=\"bash\">      --with-http_stub_status_module --with-http_ssl_module &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    make &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    make install &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    ln -s /application/nginx-1.22.1 /application/nginx &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    mkdir /application/nginx/conf/extra &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    mkdir /application/nginx/html/www &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    mkdir /application/nginx/key</span></span><br><span class=\"line\">    <span class=\"comment\"># create virtual server, html and key directory.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># copy nginx configuration file, virtual server configuration file and certification file.</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> nginx.conf /application/nginx/conf/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> www.conf /application/nginx/conf/extra/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> index.html /application/nginx/html/www/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> certs/server.key /application/nginx/key/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> certs/server.crt /application/nginx/key/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> certs/CA-center.crt /application/nginx/key/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">443</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># <span class=\"doctag\">Note:</span> Don't run nginx as backend daemon</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">\"/application/nginx/sbin/nginx\"</span>, <span class=\"string\">\"-g\"</span>, <span class=\"string\">\"daemon off;\"</span>]</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Nginx å®¹å™¨ä½¿ç”¨çš„ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/nginx-ssl/www.conf\" target=\"_blank\" rel=\"noopener\">é…ç½®æ–‡ä»¶</a>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br>âœ¨ è¯¥é…ç½®æ–‡ä»¶å¯ç”¨ HTTPS å•å‘è®¤è¯ï¼Œè‹¥éœ€å¼€å¯åŒå‘è®¤è¯è¿‡ç¨‹ï¼Œåªéœ€å¯ç”¨ <code>ssl_client_certificate</code> ä¸ <code>ssl_verify_client</code> å‚æ•°å³å¯ã€‚  </p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Web Service: domain-based virtual machine</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>  <span class=\"number\">443</span>;</span><br><span class=\"line\">    <span class=\"comment\"># alias for domain-based virtual machine</span></span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.etiantian.org etiantian.org;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl</span>  <span class=\"literal\">on</span>;  <span class=\"comment\"># Nginx å¯ç”¨ SSL/TLS éªŒè¯ï¼šæŒ‡å®šæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥</span></span><br><span class=\"line\">    <span class=\"comment\"># enable openssl module to support SSL/TLS</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span>  /application/nginx/key/server.crt;</span><br><span class=\"line\">    <span class=\"comment\"># server.crt è¯ä¹¦å‘é€è‡³å®¢æˆ·ç«¯ç”¨äºéªŒè¯å…¶èº«ä»½ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å…¶ä¸­çš„å…¬é’¥åŠ å¯†</span></span><br><span class=\"line\">    <span class=\"comment\"># pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°å¹¶å‘é€è‡³æœåŠ¡ç«¯åå•†ä¼šè¯å¯†é’¥ã€‚</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span>  /application/nginx/key/server.key;</span><br><span class=\"line\">    <span class=\"comment\"># server.key ç”¨äºè§£å¯†ä»å®¢æˆ·ç«¯å‘é€æ¥çš„å·²åŠ å¯†çš„ pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°</span></span><br><span class=\"line\">    <span class=\"comment\">#ssl_client_certificate  /application/nginx/key/CA-center.crt;</span></span><br><span class=\"line\">    <span class=\"comment\">#ssl_verify_client  on;</span></span><br><span class=\"line\">    <span class=\"comment\"># å¯ç”¨æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯ SSL/TLS åŒå‘éªŒè¯</span></span><br><span class=\"line\">    <span class=\"comment\"># è‹¥åªéœ€æœåŠ¡ç«¯å•å‘éªŒè¯ï¼Œæ— éœ€å¯ç”¨ ssl_client_certificate ä¸ ssl_verify_clientã€‚</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_session_timeout</span>  <span class=\"number\">5m</span>;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_protocols</span>  TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_ciphers</span>  ALL:!DH:!EXPORT:!RC4:+HIGH:+MEDIUM:-LOW:!aNULL:!eNULL;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_prefer_server_ciphers</span>  <span class=\"literal\">on</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>   html/www;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æŠ“åŒ… HTTPS åŠ å¯†é€šä¿¡çš„ä¸‰ä¸ªè¿‡ç¨‹ï¼šTCP å»ºç«‹è¿æ¥ã€SSL/TLS æ¡æ‰‹ã€SSL/TLS åŠ å¯†é€šä¿¡</p>\n</li>\n<li>HTTPS åŠ å¯†é€šä¿¡ - æŠ“åŒ…æ•´ä½“ç¤ºæ„ï¼š<img src=\"wireshark-https-single-progress.png\" alt></li>\n<li>ğŸ¤ HTTPS åŠ å¯†é€šä¿¡ - 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ç¤ºæ„ï¼š<img src=\"ssl-tls-single-authentication-progress.png\" alt>ğŸ‘¨â€ğŸ’» ä»¥ä¸‹å°†æ¡æ‰‹è¿‡ç¨‹åˆ†ä¸º 4 ä¸ªé˜¶æ®µè¿›è¡Œæè¿°ã€‚</li>\n<li>1ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 1 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š<code>Client Hello</code>  <ul>\n<li>å®¢æˆ·ç«¯é¦–å…ˆå‘æœåŠ¡ç«¯å‘é€ Client Hello çš„ SSL æ¡æ‰‹ä¿¡æ¯ã€‚  </li>\n<li>Client Hello æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š    <ul>\n<li>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä»¥æ˜æ–‡ä¼ è¾“è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€å®¢æˆ·ç«¯éšæœºæ•°ã€åŠ å¯†å¥—ä»¶å€™é€‰åˆ—è¡¨ã€å‹ç¼©ç®—æ³•å€™é€‰åˆ—è¡¨ã€æ‰©å±•å­—æ®µç­‰ä¿¡æ¯ã€‚    </li>\n<li>æ”¯æŒçš„æœ€é«˜ TLS åè®®ç‰ˆæœ¬ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ SSLv2ã€SSLv3ã€TLSv1ã€TLSv1.1ã€TLSv1.2ï¼Œå½“å‰åŸºæœ¬ä¸å†ä½¿ç”¨ä½äº TLSv1 çš„ç‰ˆæœ¬ã€‚    </li>\n<li>âœ¨ éšæœºæ•° <code>random_C</code>ï¼Œç”¨äºåç»­çš„ä¼šè¯å¯†é’¥ç”Ÿæˆã€‚    </li>\n<li>å®¢æˆ·ç«¯æ”¯æŒçš„åŠ å¯†å¥—ä»¶ <code>Cipher Suites</code> åˆ—è¡¨ï¼Œæ¯ä¸ªåŠ å¯†å¥—ä»¶å¯¹åº” TLS åŸç†ä¸­çš„å››ä¸ªåŠŸèƒ½çš„ç»„åˆï¼š      <ul>\n<li>è®¤è¯ç®—æ³• <code>Au</code>ï¼šèº«ä»½éªŒè¯      </li>\n<li>å¯†é’¥äº¤æ¢ç®—æ³• <code>KeyExchange</code>ï¼šï¼ˆä¼šè¯ï¼‰å¯†é’¥åå•†      </li>\n<li>å¯¹ç§°åŠ å¯†ç®—æ³• <code>Enc</code>ï¼šä¿¡æ¯åŠ å¯†      </li>\n<li>ä¿¡æ¯æ‘˜è¦ <code>Mac</code>ï¼šå®Œæ•´æ€§æ ¡éªŒ    </li>\n</ul>\n</li>\n<li>æ”¯æŒçš„å‹ç¼©ç®—æ³• <code>Compression Methods</code> åˆ—è¡¨ï¼Œç”¨äºåç»­çš„ä¿¡æ¯å‹ç¼©ä¼ è¾“ã€‚    </li>\n<li>æ‰©å±•å­—æ®µ Extensionsï¼Œæ”¯æŒåè®®ä¸ç®—æ³•çš„ç›¸å…³å‚æ•°ä»¥åŠå…¶å®ƒè¾…åŠ©ä¿¡æ¯ç­‰ï¼Œå¸¸è§çš„ SNI å°±å±äºæ‰©å±•å­—æ®µã€‚<img src=\"client-hello-body-1.png\" alt>  </li>\n</ul>\n</li>\n<li>å®¢æˆ·ç«¯æ”¯æŒçš„ 17 ç§åŠ å¯†å¥—ä»¶ä¾›æœåŠ¡ç«¯é€‰æ‹©ä½¿ç”¨ã€‚<img src=\"client-hello-body-2.png\" alt></li>\n</ul>\n</li>\n<li>2ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 2 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤çš„ 4 æ¡ SSL æ¡æ‰‹ä¿¡æ¯<img src=\"server-response-to-client-ssl.png\" alt><ul>\n<li><code>Server Hello</code>ï¼š    <ul>\n<li>æœåŠ¡ç«¯è¿”å›åå•†çš„ä¿¡æ¯ç»“æœï¼ŒåŒ…æ‹¬é€‰æ‹©ä½¿ç”¨çš„åè®®ç‰ˆæœ¬ã€é€‰æ‹©çš„åŠ å¯†å¥—ä»¶ã€é€‰æ‹©çš„å‹ç¼©ç®—æ³•ã€éšæœºæ•° <code>random_S</code> ç­‰ï¼Œå…¶ä¸­éšæœºæ•°ç”¨äºåç»­çš„å¯†é’¥åå•†ã€‚    </li>\n<li>æœåŠ¡ç«¯é€‰æ‹© <strong><font color=\"orange\">TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</font></strong> ä½œä¸ºå¯†é’¥äº¤äº’çš„åŠ å¯†å¥—ä»¶ï¼Œè¯¥åŠ å¯†å¥—ä»¶çš„åå­—åœ¨å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ”¯æŒçš„ <code>17</code> ä¸ªåˆ—è¡¨ä¸­ã€‚    </li>\n<li>è¯¥åŠ å¯†å¥—ä»¶åŒ…å«ï¼š      <ul>\n<li>éå¯¹ç§°åŠ å¯†ï¼ˆå¯†é’¥äº¤æ¢ç®—æ³•ï¼‰ï¼š<code>ECDHE + RSA</code>      </li>\n<li>å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š<code>AES + GCM</code>      </li>\n<li>æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼š<code>SHA-384</code>  </li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>Certificate</code>ï¼šè¯¥ SSL æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦<img src=\"server-ca-signed-certification.png\" alt>  </li>\n<li><code>Server Key Exchange</code>ï¼š<br>ä½¿ç”¨ <code>EC Diffie-Hellman</code> ç®—æ³•ï¼ˆ<code>ECDHE</code>ï¼‰å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„å¯†é’¥äº¤æ¢ç®—æ³•åå•†ã€‚<img src=\"server-key-exchange.png\" alt><br>ğŸ’¥ å¯¹äºä½¿ç”¨ <code>DHE/ECDHE</code> éå¯¹ç§°å¯†é’¥åå•†ç®—æ³•çš„ SSL æ¡æ‰‹ï¼Œå°†å‘é€è¯¥ç±»å‹æ¡æ‰‹ã€‚<code>RSA</code>ã€<code>DH</code>ã€<code>ECDH</code> ç®—æ³•ä¸ä¼šè¿›è¡Œè¯¥ server key exchange æ¡æ‰‹æµç¨‹ã€‚ </li>\n<li><code>Server Hello Done</code>ï¼šé€šçŸ¥å®¢æˆ·ç«¯ Server Hello ä¿¡æ¯å‘é€ç»“æŸ<img src=\"server-hello-done.jpg\" alt></li>\n</ul>\n</li>\n<li>3ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 3 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šå®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯å›å¤ 3 æ¡ SSL æ¡æ‰‹ä¿¡æ¯<img src=\"client-response-to-server-ssl.jpg\" alt><ul>\n<li><code>Client Key Exchange</code>ï¼š    <ul>\n<li>æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦åˆæ³•æ€§éªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯è®¡ç®—äº§ç”Ÿéšæœºæ•°å­— <code>Pre-master</code>ï¼Œå¹¶ç”¨æœåŠ¡ç«¯è¯ä¹¦ä¸­çš„å…¬é’¥åŠ å¯†ï¼Œå‘é€ç»™æœåŠ¡ç«¯ã€‚<br>ğŸ’¥ æ³¨æ„ï¼šæœåŠ¡ç«¯è¯ä¹¦åˆæ³•æ€§éªŒè¯å¤±è´¥ï¼ŒSSL æ¡æ‰‹å³åœæ­¢ï¼    </li>\n<li>æ­¤æ—¶å®¢æˆ·ç«¯å·²ç»è·å–å…¨éƒ¨çš„è®¡ç®—ä¼šè¯å¯†é’¥éœ€è¦çš„ä¿¡æ¯ï¼š<br>ğŸš€ ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° <code>random_C</code> å’Œ <code>random_S</code> ä¸è‡ªå·±è®¡ç®—äº§ç”Ÿçš„ <code>Pre-master</code>ï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚  </li>\n</ul>\n</li>\n<li><code>Change Cipher Spec</code>ï¼š<br> ğŸš€ å®¢æˆ·ç«¯é€šçŸ¥æœåŠ¡ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ <strong><font color=\"red\">ä¼šè¯å¯†é’¥</font></strong> å’Œ <strong><font color=\"red\">ä¼šè¯åŠ å¯†ç®—æ³•</font></strong> è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  </li>\n<li><code>Encrypted Handshake Message</code>ï¼š<br>ç»“åˆä¹‹å‰æ‰€æœ‰é€šä¿¡å‚æ•°çš„å“ˆå¸Œå€¼ç”Ÿæˆä¸€æ®µæ•°æ®ï¼Œé‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™æœåŠ¡å™¨ç”¨äºæ•°æ®ä¸æ¡æ‰‹éªŒè¯ã€‚</li>\n</ul>\n</li>\n<li>4ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤ 2 æ¡ SSL æ¡æ‰‹ä¿¡æ¯<img src=\"server-response-to-client-4-phase.png\" alt><ul>\n<li><code>Change Cipher Spec</code>ï¼š    <ul>\n<li>æœåŠ¡ç«¯ç”¨ç§é’¥è§£å¯†åŠ å¯†çš„ <code>Pre-master</code> éšæœºæ•°ï¼ŒåŸºäºä¹‹å‰äº¤æ¢çš„ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° random_C å’Œ random_Sï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚    </li>\n<li>è®¡ç®—ä¹‹å‰æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œç„¶åè§£å¯†å®¢æˆ·ç«¯å‘é€çš„ <code>Encrypted Handshake Message</code>ï¼ŒéªŒè¯ä¼šè¯å¯†é’¥å’Œæ•°æ®çš„å‡†ç¡®æ€§ã€‚    </li>\n<li>Change Cipher Spec éªŒè¯é€šè¿‡ä¹‹åï¼ŒæœåŠ¡ç«¯åŒæ ·å‘é€ Change Cipher Spec ä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ä¼šè¯å¯†é’¥ä¸ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  </li>\n</ul>\n</li>\n<li><code>Encrypted Handshake Message</code>ï¼š    <ul>\n<li>æœåŠ¡å™¨ä¹Ÿç»“åˆæ‰€æœ‰å½“å‰çš„é€šä¿¡å‚æ•°ä¿¡æ¯ç”Ÿæˆä¸€æ®µæ•°æ®å¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å‘é€åˆ°å®¢æˆ·ç«¯ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>HTTPS åŠ å¯†é€šä¿¡ - æ¡æ‰‹ç»“æŸï¼š  <ul>\n<li>å®¢æˆ·ç«¯è®¡ç®—æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œå¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥è§£å¯† Encrypted Handshake Messageï¼ŒéªŒè¯æœåŠ¡å™¨å‘é€çš„ä¼šè¯å¯†é’¥å’Œæ•°æ®ï¼ŒéªŒè¯é€šè¿‡åˆ™æ¡æ‰‹å®Œæˆã€‚  </li>\n<li>å¼€å§‹ä½¿ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚<img src=\"ssl-tls-handshake-end.png\" alt></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"HTTPS-å•å‘è®¤è¯æµ‹è¯•ï¼š\"><a href=\"#HTTPS-å•å‘è®¤è¯æµ‹è¯•ï¼š\" class=\"headerlink\" title=\"HTTPS å•å‘è®¤è¯æµ‹è¯•ï¼š\"></a>HTTPS å•å‘è®¤è¯æµ‹è¯•ï¼š</h3><ul>\n<li>æœåŠ¡ç«¯å¯ç”¨ HTTPS å•å‘è®¤è¯åï¼Œå¯ä»æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡Œè®¿é—®æµ‹è¯•ï¼š<img src=\"https-single-auth-chrome-error-1.png\" alt></li>\n<li>è¯¥æœåŠ¡ç«¯ CA æ•°å­—ç­¾åä½¿ç”¨æœªç»è®¤è¯çš„ CA ç­¾å‘ï¼Œå› æ­¤å®¢æˆ·ç«¯æµè§ˆå™¨æ— æ³•éªŒè¯å…¶å®‰å…¨æ€§è€Œå‘å‡ºè­¦å‘Šï¼Œå¯ç‚¹å‡» â€œé«˜çº§â€ æŒ‰é’®æ¥å—è¯¥è¯ä¹¦ç»§ç»­è®¿é—®ã€‚è‹¥æ‹’ç»è¯¥è¯ä¹¦ï¼Œå³æ–­å¼€æ­¤æ¬¡è®¤è¯è¿æ¥ï¼Œå¯åœ¨å¦‚ä¸‹ Wireshark æŠ“åŒ…ä¸­æ˜¾ç¤ºå®‰å…¨å‘Šè­¦ä¿¡æ¯ï¼š<img src=\"https-single-auth-chrome-error-2.png\" alt> </li>\n</ul>\n<h3 id=\"HTTPS-åŒå‘è®¤è¯çš„-Wireshark-æŠ“åŒ…ä¸æµ‹è¯•ï¼š\"><a href=\"#HTTPS-åŒå‘è®¤è¯çš„-Wireshark-æŠ“åŒ…ä¸æµ‹è¯•ï¼š\" class=\"headerlink\" title=\"HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•ï¼š\"></a>HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•ï¼š</h3><ul>\n<li>HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­å…·ä½“çš„æ­¥éª¤å‚è§å‰æ–‡ â€œSSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹â€ ä¸å•å‘è®¤è¯çš„è¿‡ç¨‹ã€‚<img src=\"wireshark-https-single-progress.png\" alt></li>\n<li><p>HTTPS åŒå‘è®¤è¯è¿‡ç¨‹çš„å®¢æˆ·ç«¯æµ‹è¯•ï¼š  </p>\n<ul>\n<li><p>é…ç½®ç”Ÿæˆå®¢æˆ·ç«¯æ‰€éœ€çš„æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa -out client.key 2048</span><br><span class=\"line\">$ openssl req -key client.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=firefox\"</span> \\</span><br><span class=\"line\">  -new -out client.csr</span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> client.csr \\</span><br><span class=\"line\">  -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out client.crt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è‹¥å°†å®¢æˆ·ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ç”¨äº <code>Firefox</code> æˆ– <code>Chrome</code> æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œå¯å°†å…¶è½¬æ¢ä¸º <code>p12</code> æ ¼å¼ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl pkcs12 -<span class=\"built_in\">export</span> -clcerts \\</span><br><span class=\"line\">  -<span class=\"keyword\">in</span> client.crt -inkey client.key -out client.p12</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º client.p12 æ–‡ä»¶æ—¶å°†äº¤äº’å¼è¾“å…¥åŠ å¯†å¯†ç </span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å°† p12 æ ¼å¼çš„æ–‡ä»¶å¯¼å…¥ Firefox æµè§ˆå™¨å®¢æˆ·ç«¯ï¼š<img src=\"firefox-import-pc12-certs-1.png\" alt><img src=\"firefox-import-pc12-certs-2.png\" alt><img src=\"firefox-import-pc12-certs-3.png\" alt><img src=\"firefox-import-pc12-certs-4.png\" alt></p>\n</li>\n<li>æ‰“å¼€ Firefox æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œæ­¤æ—¶éœ€æ¥å—å®¢æˆ·ç«¯è¯ä¹¦æ¥æ ‡è®°è‡ªå·±ï¼š<img src=\"firefox-import-pc12-certs-5.png\" alt>  </li>\n<li>ğŸ’¥ è‹¥åŒå‘è®¤è¯å®¢æˆ·ç«¯é…ç½®é”™è¯¯ï¼Œå°†æ— æ³•æ­£å¸¸è®¿é—®æœåŠ¡ç«¯ï¼Œå¹¶ä¸”æµè§ˆå™¨ç›´æ¥è¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼Œä¸” Wireshark æŠ“åŒ…æ˜¾ç¤º <code>Encrypted Alert</code>ï¼š<img src=\"https-mutual-no-client-cert-error-1.png\" alt><img src=\"https-mutual-no-client-cert-error-2.png\" alt></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"openssl-å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\"><a href=\"#openssl-å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\" class=\"headerlink\" title=\"openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\"></a>openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š</h3><ul>\n<li><p><code>openssl req</code> å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»º <code>csr</code> è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦ï¼ˆæˆ–è‡ªç­¾åè¯ä¹¦ï¼‰  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-key               æŒ‡å®šç”¨äºåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚çš„ç§é’¥            </span><br><span class=\"line\">-newkey alg:nbits  åˆ›å»ºæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸ç§é’¥ï¼ŒæŒ‡å®šåŠ å¯†ç®—æ³•ä¸åŠ å¯†ä½æ•°</span><br><span class=\"line\">                  ï¼ˆé€šå¸¸ä¸º rsa:2048ï¼‰ã€‚             </span><br><span class=\"line\">-nodes             ä¸ä½¿ç”¨å¯†ç ä¸ºæ–°åˆ›å»ºçš„ç§é’¥åŠ å¯†</span><br><span class=\"line\">-keyout            æŒ‡å®šæ–°åˆ›å»ºç§é’¥çš„æ–‡ä»¶å</span><br><span class=\"line\">-sha256            ä½¿ç”¨ SHA-256 æ‘˜è¦ï¼ˆåˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦æ—¶ä½¿ç”¨ï¼‰</span><br><span class=\"line\">-subj              æŒ‡å®šåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯è‹¥æœªæŒ‡å®š</span><br><span class=\"line\">                   è¯¥é€‰é¡¹ï¼Œå°†è¿›å…¥äº¤äº’æ¨¡å¼ã€‚</span><br><span class=\"line\">-new               ç”Ÿæˆæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚</span><br><span class=\"line\">-x509              ç”Ÿæˆæ•°å­—ç­¾åè¯ä¹¦ï¼ˆä¸ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰</span><br><span class=\"line\">-days              æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ã€‚</span><br><span class=\"line\">-out               æŒ‡å®šè¾“å‡ºçš„ csr è¯ä¹¦ç­¾åè¯·æ±‚æˆ–æ•°å­—ç­¾åè¯ä¹¦çš„åç§°</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>openssl x509</code> å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»ºä¸æŸ¥çœ‹æ•°å­—ç­¾åè¯ä¹¦  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-req             æŒ‡å®š csr è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œä¸ -<span class=\"keyword\">in</span> é€‰é¡¹åˆç”¨ã€‚                </span><br><span class=\"line\">-<span class=\"keyword\">in</span>              æŒ‡å®šè¾“å…¥æ–‡ä»¶</span><br><span class=\"line\">-CAkey           æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA ç§é’¥</span><br><span class=\"line\">-CA              æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br><span class=\"line\">-CAcreateserial  åˆ›å»º CA åºåˆ—å·æ–‡ä»¶ï¼Œæ‰©å±•åä¸º <span class=\"string\">\".srl\"</span>ï¼Œè¯¥é€‰é¡¹å¿…é¡»ä¸ -CA é€‰é¡¹åˆç”¨ã€‚</span><br><span class=\"line\">-days            æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ï¼Œä¸ä¸</span><br><span class=\"line\">                 -preserve_dates é€‰é¡¹åˆç”¨ã€‚</span><br><span class=\"line\">-out             æŒ‡å®šè¾“å‡ºçš„æ•°å­—ç­¾åè¯ä¹¦åç§°</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦çš„ 2 ç§æ–¹æ³•ï¼š  </p>\n<ul>\n<li>1ï¸âƒ£ å…ˆåˆ›å»ºç§é’¥å†åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦  </li>\n<li>2ï¸âƒ£ åŒæ—¶åˆ›å»ºç§é’¥ä¸è‡ªç­¾åæ•°å­—è¯ä¹¦    <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl req -newkey rsa:4096 -nodes -keyout server.key \\</span><br><span class=\"line\">  -sha256 -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\"</span> \\</span><br><span class=\"line\">  -x509 -days 3650 -out server.crt</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>åˆ›å»º CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆroot-caï¼‰ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa [-des3] -out ca.key [1024|2048|4096]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º CA RSA ç§é’¥</span></span><br><span class=\"line\"><span class=\"comment\"># -des3 é€‰é¡¹ï¼šäº¤äº’è¾“å…¥å¯†ç ä¸º RSA ç§é’¥åŠ å¯†</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -key ca.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -x509 \\</span><br><span class=\"line\">  -days 3650 -out ca.crt</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º CA è‡ªç­¾åæ ¹è¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl rsa -<span class=\"keyword\">in</span> ca.key -text -noout</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ CA RSA ç§é’¥çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -<span class=\"keyword\">in</span> ca.crt -text -noout</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ CA æ ¹è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa [-des3] -out server.key [1024|2048|4096]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º server ç«¯ RSA ç§é’¥</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl rsa -<span class=\"keyword\">in</span> server.key -pubout -out server.pub</span><br><span class=\"line\"><span class=\"comment\"># æå– server ç«¯ RSA ç§é’¥å¯¹åº”çš„å…¬é’¥ï¼ˆå…¬é’¥ç”±ç§é’¥ä¸­æå–ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -key server.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -out server.csr</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcertificate signing requestï¼‰</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. åˆ›å»º csr ä¸ä½¿ç”¨ -x509 ä¸ -days é€‰é¡¹</span></span><br><span class=\"line\"><span class=\"comment\">#   2. åœ¨åˆ›å»ºç”ŸæˆæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚æ—¶å‡è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#      a. CA æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å³å¯ï¼Œæ‰€æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¯ä¹¦è¯¥å­—æ®µ</span></span><br><span class=\"line\"><span class=\"comment\">#         éœ€è¦å¡«å†™ IP æˆ–åŸŸåã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#      b. ä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼ŒCA æ ¹è¯ä¹¦çš„è¯¥å­—æ®µå’ŒæœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ä¸èƒ½ä¸€æ ·ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#      c. å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼ŒCA æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´ï¼Œæœ€åçš„å¯†ç </span></span><br><span class=\"line\"><span class=\"comment\">#         å¯ç›´æ¥å›è½¦è·³è¿‡ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -noout -text -<span class=\"keyword\">in</span> server.csr</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> server.csr \\</span><br><span class=\"line\">  -CAkey ca.key -CA ca.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out server.crt</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ server ç«¯ csr è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„ç›¸å…³ä¿¡æ¯ ###</span></span><br><span class=\"line\">$ openssl x509 -noout -serial -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„åºåˆ—å·</span></span><br><span class=\"line\">$ openssl x509 -noout -dates -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„æœ‰æ•ˆæœŸ</span></span><br><span class=\"line\">$ openssl x509 -noout -pubkey -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥ä¿¡æ¯ï¼Œè¯¥å…¬é’¥ä¸ç§é’¥ä¸­æå–çš„å…¬é’¥ä¸€è‡´ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa [-des3] -out client.key [1024|2048|4096]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º client ç«¯ RSA ç§é’¥</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -key client.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/CN=sec-srv.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -out client.csr</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º client ç«¯è¯ä¹¦ç­¾åè¯·æ±‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> client.csr \\</span><br><span class=\"line\">  -CAkey ca.key -CA ca.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out client.crt</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"openssl-ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\"><a href=\"#openssl-ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\" class=\"headerlink\" title=\"openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\"></a>openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š</h3><ul>\n<li><p>ä½¿ç”¨ server ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå•å‘è¿æ¥æµ‹è¯•ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl s_server -accept &lt;port&gt; -key server.key -cert server.crt    </span><br><span class=\"line\"><span class=\"comment\"># server ç«¯ï¼šå¯åŠ¨å•å‘å®‰å…¨è¿æ¥ï¼Œå¯åŠ¨åå°†ç­‰å¾… client ç«¯å‘é€ä¿¡æ¯å¹¶å›æ˜¾</span></span><br><span class=\"line\">$ openssl s_client -connect &lt;host_ip&gt;:&lt;port&gt;</span><br><span class=\"line\"><span class=\"comment\"># client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä½¿ç”¨ server ç«¯ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡ŒåŒå‘è¿æ¥æµ‹è¯•ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl s_server -accept &lt;port&gt; \\</span><br><span class=\"line\">  -key server.key -cert server.crt -Verify &lt;depth&gt;</span><br><span class=\"line\"><span class=\"comment\"># server ç«¯ï¼šå¼ºåˆ¶è¦æ±‚ client ç«¯æä¾›ç§é’¥ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå®‰å…¨è¿æ¥</span></span><br><span class=\"line\">$ openssl s_server -accept 10001 \\</span><br><span class=\"line\">  -key server.key -cert server.crt -Verify 5</span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl s_client -connect &lt;host_ip&gt;:&lt;port&gt; \\</span><br><span class=\"line\">  -key client.key -cert client.crt</span><br><span class=\"line\"><span class=\"comment\"># client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚</span></span><br><span class=\"line\">$ openssl s_client \\</span><br><span class=\"line\">  -connect 10.197.11.100:10001 -key client.key -cert client.crt</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://www.wosign.com/FAQ/faq2016-0309-04.htm\" target=\"_blank\" rel=\"noopener\">HTTPS åŠ å¯†åè®®è¯¦è§£ (å››)ï¼šTLS/SSL æ¡æ‰‹è¿‡ç¨‹</a></li>\n<li><a href=\"https://blog.csdn.net/mrpre/article/details/77867831\" target=\"_blank\" rel=\"noopener\">TLS/SSL åè®®è¯¦è§£(12) server key exchange</a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/160093.html\" target=\"_blank\" rel=\"noopener\">ä»€ä¹ˆæ˜¯ HTTPS åŒå‘è®¤è¯(MutualTLSauthentication)_API ç½‘å…³ - é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ</a></li>\n<li><a href=\"https://blog.xizhibei.me/2021/02/03/https-two-way-authentication-with-certificates/\" target=\"_blank\" rel=\"noopener\">HTTPS åŒå‘è¯ä¹¦è®¤è¯</a></li>\n<li><a href=\"https://www.cnblogs.com/xiao987334176/p/11041241.html\" target=\"_blank\" rel=\"noopener\">NGINX é…ç½®æœ¬åœ° HTTPS (åŒå‘è®¤è¯)</a></li>\n<li><a href=\"https://blog.csdn.net/justinjing0612/article/details/7770301\" target=\"_blank\" rel=\"noopener\">å¸¸è§è¯ä¹¦æ ¼å¼å’Œè½¬æ¢</a></li>\n<li><a href=\"https://www.cnblogs.com/lzjsky/archive/2010/11/14/1877143.html\" target=\"_blank\" rel=\"noopener\">å¸¸è§è¯ä¹¦æ ¼å¼åŠç›¸äº’è½¬æ¢</a></li>\n<li><a href=\"https://www.cnblogs.com/threegun/p/7130985.html\" target=\"_blank\" rel=\"noopener\">openssl ç”Ÿæˆè‡ªç­¾è¯ä¹¦åŠæŸ¥çœ‹è¯ä¹¦ç»†èŠ‚</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼š<code>CentOS Linux release 7.9.2009 (Core)</code></li>\n<li>Kernel ç‰ˆæœ¬ï¼š<code>4.20.3-1.el7.elrepo.x86_64</code></li>\n<li>OpenSSL ç‰ˆæœ¬ï¼š<code>openssl-1.0.2k-21.el7_9.x86_64.rpm</code></li>\n<li>Docker ç‰ˆæœ¬ï¼š<code>20.10.8</code></li>\n<li>Nginx ç‰ˆæœ¬ï¼š<code>1.22.1</code></li>\n<li>âœ¨ HTTPS åœ¨å¸¸è§„ Web æœåŠ¡å™¨ã€ä¸­é—´ä»¶æœåŠ¡å™¨åŠ <code>RESTful API</code> ç­‰é€šä¿¡ä¸­å¹¿æ³›å¤§é‡ä½¿ç”¨ï¼Œå› æ­¤ç†è§£ HTTPS åŠç›¸å…³æ¦‚å¿µæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚</li>\n<li>è¯¥æ–‡æ¡£ä½¿ç”¨ openssl å·¥å…·åˆ›å»ºä¸ç®¡ç†ç›¸å…³ç§é’¥ä¸è¯ä¹¦ï¼Œå½“ç„¶ä¹Ÿå¯ä½¿ç”¨ cfssl æˆ– certtoolï¼ˆæ¥æºäº gnutls-utils è½¯ä»¶åŒ…ï¼‰å·¥å…·åˆ›å»ºä¸ç®¡ç†ã€‚</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>åŠ å¯†é€šä¿¡èƒŒæ™¯</li>\n<li>ä¿è¯æ•°æ®çš„æœºå¯†æ€§</li>\n<li>ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§</li>\n<li>ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯</li>\n<li>æ•°å­—ç­¾ååŸç†</li>\n<li>SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­</li>\n<li>SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹</li>\n<li>åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯</li>\n<li>HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æ</li>\n<li>HTTPS å•å‘è®¤è¯æµ‹è¯•</li>\n<li>HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•</li>\n<li>openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»</li>\n<li>openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\"><a href=\"#åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\" class=\"headerlink\" title=\"åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š\"></a>åŠ å¯†é€šä¿¡èƒŒæ™¯ï¼š</h3><ul>\n<li>ç½‘ç»œå®‰å…¨é—®é¢˜ï¼š<br>HTTP ä¸ä½¿ç”¨ SSL/TLS è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œæ‰€æœ‰ä¿¡æ¯æ˜æ–‡ä¼ æ’­ï¼Œå¸¦æ¥äº†ä¸‰å¤§é£é™©ï¼š  <ul>\n<li>çªƒå¬é£é™©ï¼ˆeavesdroppingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥è·çŸ¥é€šä¿¡å†…å®¹  </li>\n<li>ç¯¡æ”¹é£é™©ï¼ˆtamperingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥ä¿®æ”¹é€šä¿¡å†…å®¹  </li>\n<li>å†’å……é£é™©ï¼ˆpretendingï¼‰ï¼šç¬¬ä¸‰æ–¹å¯ä»¥å†’å……ä»–äººèº«ä»½å‚ä¸é€šä¿¡</li>\n</ul>\n</li>\n<li>ç½‘ç»œå®‰å…¨é—®é¢˜çš„è§£å†³æ€è·¯ï¼š<code>SSL/TLS</code> åè®®  <ul>\n<li>æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯åŠ å¯†ä¼ æ’­ï¼Œç¬¬ä¸‰æ–¹æ— æ³•çªƒå¬ã€‚  </li>\n<li>å…·æœ‰æ ¡éªŒæœºåˆ¶ï¼Œä¸€æ—¦è¢«ç¯¡æ”¹ï¼Œé€šä¿¡åŒæ–¹ä¼šç«‹åˆ»å‘ç°ã€‚  </li>\n<li>é…å¤‡èº«ä»½è¯ä¹¦ï¼Œé˜²æ­¢èº«ä»½è¢«å†’å……ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\"><a href=\"#ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\" class=\"headerlink\" title=\"ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬\"></a>ä¿è¯æ•°æ®çš„æœºå¯†æ€§ï¼šä¸è¢«çªƒå¬</h3><ul>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼šå¯¹ç§°åŠ å¯†ç®—æ³•</li>\n<li>ğŸ’¥ å•çº¯çš„æ•°æ®åŠ å¯†åªèƒ½ä¿è¯æ•°æ®ä¸è¢«æ³„éœ²ï¼Œä½†ä¸èƒ½ä¿è¯æ¥æ”¶æ–¹æ”¶åˆ°çš„æ•°æ®çš„çœŸå®æ€§ã€‚</li>\n</ul>\n<h3 id=\"ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\"><a href=\"#ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\" class=\"headerlink\" title=\"ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹\"></a>ä¿è¯æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ï¼šä¸è¢«ç¯¡æ”¹</h3><ul>\n<li>æ•°æ®çš„çœŸå®æ€§ï¼šçœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œæ•°æ®æ˜¯ä»çœŸå®å‘é€è€…å‘æ¥ã€‚</li>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼šæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆæˆ–ç§°æ•£åˆ—ç®—æ³•/å•å‘æ•£åˆ—å‡½æ•°ï¼‰ç”Ÿæˆæ•°æ®æŒ‡çº¹ï¼ˆç‰¹å¾ç ï¼‰</li>\n<li>ğŸ’¥ åˆ©ç”¨æå–æ•°æ®æŒ‡çº¹çš„æ–¹å¼ï¼Œå®Œæˆæ•°æ®ä¼ è¾“çš„å®Œæ•´æ€§éªŒè¯ã€‚</li>\n<li>ğŸ”’ å®é™…çš„ç®—æ³•å®ç°è¿‡ç¨‹æ¦‚è¦ï¼š  <ul>\n<li>ç»™ä¸€æ®µæ˜æ–‡æ•°æ®ï¼ˆplain textï¼‰åŠ ä¸Šæ•°æ®ä¿¡æ¯æŒ‡çº¹ï¼Œè¿™ä¸ªæŒ‡çº¹æ˜¯é€šè¿‡ç»“åˆæ•°æ®ä¿¡æ¯è¿›è¡Œç›¸åº”ç®—æ³•è·å¾—çš„æ•°æ®æŒ‡çº¹ã€‚  </li>\n<li>æ¥æ”¶æ–¹å½“æ”¶åˆ°æ•°æ®ä¿¡æ¯åï¼Œä¼šåˆ©ç”¨ç›¸åŒçš„ç®—æ³•å¯¹è·å–çš„æ•°æ®è®¡ç®—æŒ‡çº¹ï¼Œç¡®è®¤å¾—åˆ°çš„æŒ‡çº¹æ˜¯å¦ä¸ä¼ é€è¿‡æ¥çš„æè¿°æ•°æ®çš„æŒ‡çº¹ä¸€è‡´ã€‚  </li>\n<li>å¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œè¡¨ç¤ºæ•°æ®å®Œæ•´æ€§é­åˆ°ç ´åï¼Œæ•°æ®ä¸€æ¦‚ä¸äºˆä»¥æ¥æ”¶å¤„ç†ã€‚</li>\n</ul>\n</li>\n<li>ç”±äºå¯èƒ½å­˜åœ¨ä¸­é—´äººæ”»å‡»çš„å¯èƒ½æ€§ï¼Œå› æ­¤å¯å¯¹ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ•°æ®æŒ‡çº¹è¿›è¡ŒåŠ å¯†ã€‚</li>\n<li>å‘é€æ–¹åˆ©ç”¨å¯¹ç§°å¯†é’¥æ–¹å¼å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡ŒåŠ å¯†ï¼Œæ¥æ”¶æ–¹ä¼šåˆ©ç”¨ç›¸åŒçš„å¯†é’¥å¯¹æ‰‹ä¸­çš„æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œä»è€Œç¡®è®¤æŒ‡çº¹æ˜¯å¦ä¸€è‡´ã€‚</li>\n<li>å¦‚æœä¸­é—´äººå°†æ–°çš„æŒ‡çº¹ä¹Ÿè¿›è¡Œäº†åŠ å¯†ï¼Œå‘é€ç»™æ¥æ”¶æ–¹ï¼Œä½†æ¥æ”¶æ–¹æ— æ³•åˆ©ç”¨å’Œå‘é€æ–¹åå•†å¥½çš„è§£å¯†å¯†é’¥å¯¹æŒ‡çº¹è¿›è¡Œè§£å¯†ï¼Œæœ€ç»ˆæ— æ³•è¯†åˆ«ä¸­é—´äººå‘é€è¿‡æ¥çš„æ•°æ®æŒ‡çº¹ä¿¡æ¯ã€‚</li>\n<li>ğŸ¤˜ é€šè¿‡åŠ å¯†æŒ‡çº¹å¯ä»¥ä¿è¯çœŸå®æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚</li>\n</ul>\n<h3 id=\"ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\"><a href=\"#ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\" class=\"headerlink\" title=\"ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š\"></a>ä¿è¯ä¼ è¾“åŒæ–¹çš„èº«ä»½éªŒè¯ï¼š</h3><ul>\n<li>ä»¥ä¸Šä¿¡æ¯åªæ˜¯è§£å†³æ•°æ®çš„äº¤æ¢è·å–é—®é¢˜ï¼Œä½†æ˜¯ç½‘ç»œçš„èº«ä»½éªŒè¯é—®é¢˜ä¾æ—§æ²¡æœ‰è§£å†³ã€‚</li>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼šéå¯¹ç§°åŠ å¯†</li>\n<li>åˆ©ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³ç½‘ç»œä¸­æ•°æ®ä¼ è¾“åŒæ–¹çš„å®‰å…¨èº«ä»½éªŒè¯é—®é¢˜ã€‚</li>\n<li>ğŸ’¥ éå¯¹ç§°åŠ å¯†ç®—æ³•ä¸­ï¼Œå­˜åœ¨å¯†é’¥å¯¹çš„æ¦‚å¿µï¼Œå³æ‹¥æœ‰å…¬é’¥ï¼ˆ<code>public key</code>ï¼‰ä¸ç§é’¥ï¼ˆ<code>private key</code>ï¼‰ï¼Œå…¶ä¸­å…¬é’¥ä¸æ˜¯è‡ªè¡Œåˆ›å»ºå‡ºæ¥çš„è€Œæ˜¯ä»ç§é’¥ä¸­æå–å‡ºæ¥ä¸€éƒ¨åˆ†ä½œä¸ºå…¬é’¥ï¼Œå› æ­¤å¯ä»¥è¯´å…¬é’¥æ˜¯æ¥è‡ªäºç§é’¥çš„ï¼Œè€Œç§é’¥æ‰å†³å®šå¯†é’¥åŠ å¯†çš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”ç§é’¥çš„é•¿åº¦å¯èƒ½ä¼šéå¸¸é•¿ï¼Œä»æœ€åˆçš„ 1024ã€2048 åˆ° 4096 ä¸€ç›´åˆ°æ›´å¤šçš„ä½æ•°ã€‚å¢åŠ ç§é’¥å¯†é’¥ä½ï¼Œä»è€Œæå‡å¯†é’¥å®‰å…¨æ€§ã€‚</li>\n<li>éå¯¹ç§°åŠ å¯†ç®—æ³•éµå¾ªçš„åŸºæœ¬åŸåˆ™ï¼šå…¬é’¥åŠ å¯†çš„åªèƒ½åˆ©ç”¨ä¸ä¹‹é…å¯¹çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œåä¹‹äº¦ç„¶ã€‚</li>\n<li>éå¯¹ç§°åŠ å¯†ç®—æ³•å¯ä»¥æ»¡è¶³æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­å¯¹ä¼ è¾“è€…èº«ä»½éªŒè¯çš„éœ€æ±‚ï¼Œå› ä¸ºæ¥æ”¶è€…å¯ä»¥æ‹¥æœ‰ç›¸åº”çš„å…¬é’¥ï¼Œåªæœ‰ä¸ä¹‹å¯¹åº”çš„å‘é€è€…ç”¨ç›¸åº”çš„ç§é’¥è¿›è¡ŒåŠ å¯†ä¿¡æ¯ï¼Œæ¥æ”¶è€…ç”¨å¯¹åº”çš„å…¬é’¥æ‰å¯è§£å¯†ï¼Œå¦åˆ™å¯ä»¥ç¡®è®¤å‘é€è€…èº«ä»½å·²ç»å‘ç”Ÿå˜åŒ–ã€‚</li>\n</ul>\n<h3 id=\"ğŸ¦„-æ•°å­—ç­¾ååŸç†ï¼š\"><a href=\"#ğŸ¦„-æ•°å­—ç­¾ååŸç†ï¼š\" class=\"headerlink\" title=\"ğŸ¦„ æ•°å­—ç­¾ååŸç†ï¼š\"></a>ğŸ¦„ æ•°å­—ç­¾ååŸç†ï¼š</h3><ul>\n<li><strong><font color=\"orange\">å…¬é’¥åŠ å¯†ç®—æ³•</font></strong> è§£å†³é€šä¿¡åŒæ–¹èº«ä»½éªŒè¯é—®é¢˜ï¼Œä½†æ— æ³•ç¡®ä¿å…¬é’¥çš„çœŸå®æ€§ã€‚</li>\n<li>å› æ­¤ï¼ŒCA æ•°å­—ç­¾åä½¿ç”¨è¯ä¹¦æˆæƒä¸­å¿ƒï¼ˆCertification Authorityï¼Œç®€ç§° <code>CA</code>ï¼‰è§£å†³é€šä¿¡åŒæ–¹äº¤æ¢çš„å…¬é’¥çš„çœŸå®æ€§ï¼Œå³æ•°å­—è¯ä¹¦çš„çœŸå®æ€§ï¼ˆå…¬é’¥åŒ…å«äºæ•°å­—è¯ä¹¦ä¸­ï¼‰ã€‚</li>\n<li>æ•°å­—ç­¾åè¯ä¹¦çš„åˆ†ç±»ï¼š  <ul>\n<li>è‡ªç­¾åæ•°å­—ç­¾åè¯ä¹¦ï¼š<br>ä¸ä½¿ç”¨ <code>ca.key</code> åŠ å¯†ç”Ÿæˆç­¾åï¼Œä½¿ç”¨è‡ªèº«çš„ç§é’¥åŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ <code>GnuPG</code> é‚®ä»¶åŠ å¯†ä¼ è¾“ã€‚  </li>\n<li>CA æ•°å­—ç­¾åè¯ä¹¦ï¼š<br>ä½¿ç”¨ CA è¯ä¹¦æˆæƒä¸­å¿ƒçš„ <code>ca.key</code> ä¸ <code>ca.crt</code> è¿›è¡ŒåŠ å¯†ç”Ÿæˆç­¾åï¼Œå¦‚ <code>kube-apiserver</code>ã€Apacheã€Nginxã€Tomcat ç­‰ï¼Œä»¥ä¸‹è®¨è®ºè¯¥ç±»å‹è¯ä¹¦ã€‚</li>\n</ul>\n</li>\n<li>ğŸ§¬ å®ç°æ–¹å¼ï¼š<strong><font color=\"orange\">å…¬é’¥éå¯¹ç§°åŠ å¯†ç®—æ³• + æ¶ˆæ¯æ‘˜è¦ç®—æ³•</font></strong></li>\n<li>æ ‡å‡†çš„ <code>X.509</code> æ ¼å¼çš„ CA æ•°å­—ç­¾åè¯ä¹¦ç»„æˆï¼š  <ul>\n<li>è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ï¼šæ˜æ–‡æ˜¾ç¤º    <ul>\n<li>è¯ä¹¦çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersionï¼‰    </li>\n<li>è¯ä¹¦çš„åºåˆ—å·ï¼ˆSerial Numberï¼Œ<code>srl</code>ï¼‰ï¼šæ¯ä¸ªè¯ä¹¦éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„è¯ä¹¦åºåˆ—å·    </li>\n<li>è¯ä¹¦æ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼š<code>sha256WithRSAEncryption</code>    </li>\n<li>è¯ä¹¦çš„å‘è¡Œæœºæ„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ <code>X.500</code> æ ¼å¼ï¼ˆç›®å½•æœåŠ¡åè®® X.500ï¼‰    </li>\n<li>â± è¯ä¹¦çš„æœ‰æ•ˆæœŸï¼šç°åœ¨é€šç”¨çš„è¯ä¹¦ä¸€èˆ¬é‡‡ç”¨ UTC æ—¶é—´æ ¼å¼ï¼Œè®¡æ—¶èŒƒå›´ä¸º 1950-2049ã€‚    </li>\n<li>è¯ä¹¦æ‰€æœ‰äººçš„åç§°ï¼šå‘½åè§„åˆ™ä¸€èˆ¬é‡‡ç”¨ <code>X.500</code> æ ¼å¼    </li>\n<li>è¯ä¹¦æ‰€æœ‰äººçš„å…¬é’¥ä¿¡æ¯    </li>\n<li>CA æ•°å­—ç­¾åæ ¡éªŒç   </li>\n</ul>\n</li>\n<li>è¯ä¹¦æ•°å­—ç­¾åï¼ˆSï¼‰ï¼šå¯†æ–‡æ˜¾ç¤º    <ul>\n<li>è¯ä¹¦å‘è¡Œè€…ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰ä½¿ç”¨ CA ç§é’¥åŠ å¯†ç”Ÿæˆç­¾å</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>ğŸ”¥ CA æ•°å­—ç­¾åè¯ä¹¦ç”Ÿæˆè¿‡ç¨‹ï¼š  </p>\n<ul>\n<li>è¯¥ç”Ÿæˆè¿‡ç¨‹æ»¡è¶³å‡½æ•°è¡¨è¾¾å¼ï¼š<code>S = F(Digest(C))</code></li>\n<li>å…¶ä¸­ S ä¸ºè¯ä¹¦æ•°å­—ç­¾åï¼ŒF ä¸ºç­¾åç®—æ³•ï¼ŒDigest ä¸ºæ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼ˆMD5/SHA1/SHA256ç­‰ï¼‰ï¼ŒC ä¸ºè¯ä¹¦ç›¸å…³ä¿¡æ¯ã€‚  </li>\n<li>1ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯åˆ›å»ºå„è‡ªçš„ç§é’¥ï¼Œå¹¶ä½¿ç”¨è¯¥ç§é’¥åˆ›å»º <code>csr</code> è¯ä¹¦ç­¾åè¯·æ±‚ã€‚  </li>\n<li>2ï¸âƒ£ æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ <code>csr</code> è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­åŒ…å«è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ä¸ç›¸åº”çš„å…¬é’¥ä¿¡æ¯ã€‚  </li>\n<li>3ï¸âƒ£ ä½¿ç”¨æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯ä¹¦ç›¸å…³ä¿¡æ¯ C ç”Ÿæˆç›¸åº”æŒ‡çº¹ï¼ˆfingerprintï¼‰ï¼Œå†ä½¿ç”¨ CA ç§é’¥ï¼ˆca.keyï¼‰é…åˆ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰åŠ å¯†è¯¥æŒ‡çº¹ï¼Œæœ€åç”ŸæˆæœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯çš„ CA æ•°å­—ç­¾åè¯ä¹¦ã€‚  </li>\n<li>è¯¥ CA æ•°å­—ç­¾ååªèƒ½è¢« CA ç§é’¥ï¼ˆca.keyï¼‰å¯¹åº”ä½äº CA æ ¹è¯ä¹¦ä¸­çš„ CA å…¬é’¥è§£å¼€ã€‚  </li>\n<li><p>åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼šä¹Ÿå¯å‚è€ƒè¯¥ <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/create-ssl-certs.sh\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a> ä»¥è·å¾—ä»¥ä¸‹è¿‡ç¨‹çš„å®Œæ•´è„šæœ¬</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa -out CA-center.key 2048</span><br><span class=\"line\">$ openssl req -key CA-center.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -x509 -days 3650 -out CA-center.crt</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆè‡ªç­¾åï¼‰</span></span><br><span class=\"line\">$ openssl x509 -noout -text -<span class=\"keyword\">in</span> CA-center.crt</span><br><span class=\"line\">  Certificate:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 3 (0x2)</span><br><span class=\"line\">        Serial Number:</span><br><span class=\"line\">            fb:53:9c:3c:4d:81:f6:de</span><br><span class=\"line\">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class=\"line\">        Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com</span><br><span class=\"line\">        Validity</span><br><span class=\"line\">            Not Before: Jan  2 14:04:46 2023 GMT</span><br><span class=\"line\">            Not After : Dec 30 14:04:46 2032 GMT</span><br><span class=\"line\">        Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com</span><br><span class=\"line\">        <span class=\"comment\"># ç”±äºä½¿ç”¨ CA ç§é’¥è‡ªç­¾åç”Ÿæˆçš„ CA æ ¹è¯ä¹¦ï¼Œå…¶è¯ä¹¦å‘è¡Œæœºæ„ä¸æ‰€æœ‰äººç›¸åŒã€‚</span></span><br><span class=\"line\">        Subject Public Key Info:</span><br><span class=\"line\">            Public Key Algorithm: rsaEncryption</span><br><span class=\"line\">                Public-Key: (2048 bit)</span><br><span class=\"line\">                Modulus:</span><br><span class=\"line\">                    00:bf:9a:3d:48:8c:b9:21:cb:d4:e5:30:df:4a:0e:</span><br><span class=\"line\">                    05:e1:29:fe:5c:1f:06:4d:fb:89:fe:f5:01:c7:37:</span><br><span class=\"line\">                    c5:ee:f5:66:8f:2f:bd:48:82:a1:80:1e:00:9d:a0:</span><br><span class=\"line\">                    ...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa -out server.key 2048</span><br><span class=\"line\">$ openssl req -key server.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -out server.csr</span><br><span class=\"line\">$ openssl req -noout -text -<span class=\"keyword\">in</span> server.csr</span><br><span class=\"line\">  Certificate Request:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 0 (0x0)</span><br><span class=\"line\">        Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com </span><br><span class=\"line\">        <span class=\"comment\"># éœ€ç­¾åæœåŠ¡ç«¯è¯ä¹¦çš„æ‰€æœ‰äºº</span></span><br><span class=\"line\">        Subject Public Key Info:  <span class=\"comment\"># csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸­çš„å…¬é’¥ä¿¡æ¯</span></span><br><span class=\"line\">            Public Key Algorithm: rsaEncryption  <span class=\"comment\"># å…¬é’¥åŠ å¯†ç®—æ³•ï¼šRSAï¼ˆä¸å¯¹ç§°åŠ å¯†ï¼‰</span></span><br><span class=\"line\">                Public-Key: (2048 bit)</span><br><span class=\"line\">                Modulus:</span><br><span class=\"line\">                    00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:</span><br><span class=\"line\">                    e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:</span><br><span class=\"line\">                    54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:</span><br><span class=\"line\">                    ...</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºä¸æŸ¥çœ‹æœåŠ¡ç«¯ç§é’¥åŠ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> server.csr \\</span><br><span class=\"line\">  -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out server.crt</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ CA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ç­¾å‘æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦</span></span><br><span class=\"line\">$ openssl x509 -noout -text -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\">  Certificate:</span><br><span class=\"line\">    Data:</span><br><span class=\"line\">        Version: 1 (0x0)</span><br><span class=\"line\">        Serial Number:</span><br><span class=\"line\">            a9:68:e7:c4:87:87:4e:03</span><br><span class=\"line\">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class=\"line\">        Issuer: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=CA-center.lab.example.com </span><br><span class=\"line\">        <span class=\"comment\"># æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„å‘è¡Œæœºæ„ï¼ˆCA è¯ä¹¦æˆæƒä¸­å¿ƒï¼‰</span></span><br><span class=\"line\">        Validity</span><br><span class=\"line\">            Not Before: Jan  2 14:04:46 2023 GMT</span><br><span class=\"line\">            Not After : Dec 30 14:04:46 2032 GMT</span><br><span class=\"line\">        Subject: C=CN, ST=Shanghai, L=Shanghai, O=RedHat, OU=GLS, CN=cloud-ctl.lab.example.com</span><br><span class=\"line\">        <span class=\"comment\"># æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„æ‰€æœ‰äººï¼šæœåŠ¡ç«¯ä¿¡æ¯</span></span><br><span class=\"line\">        Subject Public Key Info:</span><br><span class=\"line\">            Public Key Algorithm: rsaEncryption</span><br><span class=\"line\">                Public-Key: (2048 bit)</span><br><span class=\"line\">                Modulus:</span><br><span class=\"line\">                    00:e0:bd:e9:ff:f5:16:e5:a9:94:9c:61:2f:27:c5:</span><br><span class=\"line\">                    e9:76:a2:4b:e3:0f:1a:82:7d:7a:f1:bf:52:37:8d:</span><br><span class=\"line\">                    54:ea:96:39:8c:c9:55:39:d6:5a:ac:03:2d:16:52:</span><br><span class=\"line\">                    ...</span><br><span class=\"line\"><span class=\"comment\"># è¯¥æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„æœåŠ¡ç«¯å…¬é’¥ä¿¡æ¯ä¸å…¶ csr è¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ä¸­çš„ç›¸åŒ</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦è¿‡ç¨‹ï¼š  </p>\n<ul>\n<li>éªŒè¯æœåŠ¡ç«¯ CA æ•°å­—ç­¾åï¼š    <ul>\n<li>å®¢æˆ·ç«¯éœ€å…·æœ‰ CA æ ¹è¯ä¹¦ï¼ˆca.crtï¼‰    </li>\n<li>å®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯ CA æ•°å­—ç­¾åçš„éªŒè¯æ»¡è¶³è¡¨è¾¾å¼ï¼š<code>F&#39;(S) = Digest(C)</code></li>\n<li>å®¢æˆ·ç«¯å°†æ‰§è¡Œä¸¤ç§è®¡ç®—ï¼Œå¹¶å°†è®¡ç®—ç»“æœè¿›è¡Œæ¯”å¯¹ï¼š<br>1ï¸âƒ£ ç”±äºè¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰ä»¥æ˜æ–‡æ˜¾ç¤ºï¼Œé€šè¿‡æ¶ˆæ¯æ‘˜è¦ç®—æ³•è®¡ç®— C çš„å“ˆå¸Œå€¼ã€‚<br>2ï¸âƒ£ ä½¿ç”¨ CA å…¬é’¥è§£å¯†ç”±æœåŠ¡ç«¯é€šè¿‡ CA ç§é’¥åŠ å¯†çš„ CA æ•°å­—ç­¾åï¼Œè·å¾—åŸå§‹è¯ä¹¦ç›¸å…³ä¿¡æ¯ï¼ˆCï¼‰çš„å“ˆå¸Œå€¼ã€‚<br>3ï¸âƒ£ è‹¥ä¸¤è€…ç»“æœä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦æœ‰æ•ˆä¸”æ¥è‡ªè¯¥ CAï¼Œæœªè¢«ç¯¡æ”¹ï¼›è‹¥ä¸¤è€…ç»“æœä¸ä¸€è‡´ï¼Œè¯´æ˜è¯ä¹¦å·²è¢«ä¸­é—´äººç¯¡æ”¹æˆ–ä¸æ¥è‡ªè¯¥ CAã€‚  </li>\n</ul>\n</li>\n<li>æå–æœåŠ¡ç«¯å…¬é’¥ï¼š    <ul>\n<li>CA æ•°å­—ç­¾åéªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥æå–å‡ºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥è¿›è¡Œé€šä¿¡ã€‚    </li>\n<li>ğŸ¤ è¯ä¹¦éªŒè¯åœ¨ <code>SSL/TLS</code> æ¡æ‰‹è¿‡ç¨‹çš„ <code>Server Hello Done</code> ä¸ <code>Client Key Exchange</code> ä¹‹é—´ã€‚  </li>\n</ul>\n</li>\n<li>ğŸš€ éªŒè¯è¿‡ç¨‹ä¸åŸç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"ca-signed-certification-verify.jpg\" alt></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"SSL-TLS-ä¸-CA-ç›¸å…³æœ¯è¯­ï¼š\"><a href=\"#SSL-TLS-ä¸-CA-ç›¸å…³æœ¯è¯­ï¼š\" class=\"headerlink\" title=\"SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­ï¼š\"></a>SSL/TLS ä¸ CA ç›¸å…³æœ¯è¯­ï¼š</h3><ul>\n<li>è¯ä¹¦æ ‡å‡†ï¼š<code>X.509</code></li>\n<li>ç¼–ç æ ¼å¼ï¼š  <ul>\n<li>âœ¨ <code>PEM</code>ï¼š    <ul>\n<li>privacy enhanced Mail    </li>\n<li>çº¯æ–‡æœ¬å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ˆBase64 ç¼–ç ï¼‰ï¼ŒApache ä¸ *nix æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚  </li>\n</ul>\n</li>\n<li><code>DER</code>ï¼š    <ul>\n<li>distinguished encoding Rules    </li>\n<li>äºŒè¿›åˆ¶å½¢å¼çš„ç¼–ç æ ¼å¼ï¼ŒJava ä¸ Windows æœåŠ¡å™¨åå‘äºä½¿ç”¨è¯¥æ ¼å¼ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>è¯ä¹¦ï¼ˆæ•°å­—ç­¾åè¯ä¹¦ï¼‰ï¼šcertificateï¼ˆ<code>CER</code> æˆ– <code>CRT</code>ï¼‰</li>\n<li>ç§é’¥ï¼šprivate key</li>\n<li>ğŸ‘‰ è¯ä¹¦ç­¾åè¯·æ±‚ï¼š  <ul>\n<li>certificate signing request: <code>CSR</code>  </li>\n<li>è¯¥æ–‡ä»¶ä½¿ç”¨ç§é’¥åŠ å¯†ï¼ŒåŒ…å«å…¬é’¥ä¸ç­¾åç”³è¯·è€…ä¿¡æ¯ç­‰ã€‚</li>\n</ul>\n</li>\n<li>CER ä¸ CRT ä¸¤è€…éƒ½ä¸ºè¯ä¹¦ï¼ŒCRT åœ¨ Linux ä¸Šæ›´å¸¸è§ã€‚</li>\n<li>CERã€CRTã€KEYã€CSR éƒ½å¯ä¸º PEM æˆ– DER ç¼–ç æ ¼å¼ï¼</li>\n<li>æ”¯æŒ SSL/TLS åè®®çš„å¼€æºå·¥å…·ï¼š<code>openssl</code>ã€<code>cfssl</code>ã€<code>gnutls</code></li>\n<li>ğŸ“š man æŸ¥çœ‹ä»¥ä¸‹å‘½ä»¤ï¼š<br>opensslã€genrsaã€rsaã€reqã€x509ã€verifyã€s_clientã€s_server</li>\n</ul>\n<h3 id=\"SSL-TLS-åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\"><a href=\"#SSL-TLS-åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\" class=\"headerlink\" title=\"SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š\"></a>SSL/TLS åŠ å¯†é€šä¿¡è¦ç‚¹ï¼š</h3><ul>\n<li>å®‰å…¨å¥—æ¥å­—å±‚åè®®ï¼šSecure Socket Layerï¼ˆSSLï¼‰</li>\n<li>ä¼ è¾“å±‚å®‰å…¨åè®®ï¼šTransport Layer Securityï¼ˆTLSï¼‰</li>\n<li>SSL/TLS å†å²èƒŒæ™¯ï¼š  <ul>\n<li>1994 å¹´ï¼ŒNetScape å…¬å¸è®¾è®¡äº† SSL åè®®çš„ 1.0 ç‰ˆï¼Œä½†æœªå‘å¸ƒã€‚  </li>\n<li>1995 å¹´ï¼ŒNetScape å…¬å¸å‘å¸ƒ SSL 2.0 ç‰ˆï¼Œå¾ˆå¿«å‘ç°æœ‰ä¸¥é‡æ¼æ´ã€‚  </li>\n<li>1996 å¹´ï¼ŒSSL 3.0 ç‰ˆé—®ä¸–ï¼Œå¾—åˆ°å¤§è§„æ¨¡åº”ç”¨ã€‚  </li>\n<li>1999 å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡ ISOC æ¥æ›¿ NetScape å…¬å¸ï¼Œå‘å¸ƒäº† SSL çš„å‡çº§ç‰ˆ <code>TLS 1.0</code> ç‰ˆã€‚  </li>\n<li>2006 å¹´å’Œ 2008 å¹´ï¼ŒTLS è¿›è¡Œäº†ä¸¤æ¬¡å‡çº§ï¼Œåˆ†åˆ«ä¸º TLS 1.1 ç‰ˆå’Œ TLS 1.2 ç‰ˆã€‚  </li>\n<li>ğŸ‘‰ æœ€æ–°çš„å˜åŠ¨æ˜¯ 2011 å¹´ <code>TLS 1.2</code> çš„ä¿®è®¢ç‰ˆã€‚</li>\n</ul>\n</li>\n<li>TLS ä¸ SSL ä¹‹é—´çš„ç‰ˆæœ¬å¯¹åº”å…³ç³»ï¼š  <ul>\n<li>TLS 1.0 å¯¹åº” SSL 3.1  </li>\n<li>TLS 1.1 å¯¹åº” SSL 3.2  </li>\n<li>TLS 1.2 å¯¹åº” SSL 3.3</li>\n</ul>\n</li>\n<li>ğŸ‘‰ ä¸€èˆ¬ä¸»æµæµè§ˆå™¨éƒ½å·²ç»å®ç°äº† <code>TLS 1.2</code> çš„æ”¯æŒã€‚</li>\n<li>SSL/TLS åè®®åœ¨ç½‘ç»œæ¨¡å‹ä¸­çš„ä½ç½®ï¼š<img src=\"ssl-tls-in-network-stack.png\" alt></li>\n<li>SSL/TLS åè®®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š  <ul>\n<li>Handshake Protocolï¼š<br>ğŸ¤ åå•†é€šä¿¡åŒæ–¹ä¹‹ååœ¨æœ¬æ¬¡ä¼šè¯ä¸­ç”¨äºæ•°æ®åŠ å¯†çš„ä¼šè¯å¯†é’¥ï¼ˆ<code>session key</code>ï¼‰ï¼Œè¯¥è¿‡ç¨‹ä¸º â€œæ¡æ‰‹é˜¶æ®µâ€ï¼Œå…¶ä¸­ä¼šè¯å¯†é’¥ä¹Ÿç§°ä¸ºåå•†å¯†é’¥ã€‚  </li>\n<li>Record Protocolï¼š<br>å®šä¹‰ä½¿ç”¨ä¼šè¯å¯†é’¥åŠ å¯†çš„æ•°æ®çš„ä¼ è¾“æ ¼å¼ã€‚</li>\n</ul>\n</li>\n<li>SSL å±‚ï¼š<br>å€ŸåŠ©ä¸‹å±‚åè®®ï¼ˆTCP å±‚ï¼‰çš„çš„ä¿¡é“å®‰å…¨åœ°åå•†å‡ºä¸€ä»½ä¼šè¯å¯†é’¥ï¼Œå¹¶ç”¨æ­¤å¯†é’¥æ¥åŠ å¯† HTTP è¯·æ±‚ã€‚</li>\n<li>TCP å±‚ï¼š  <ul>\n<li>ä¸ Web server çš„ 443 ç«¯å£å»ºç«‹è¿æ¥ï¼Œä¼ é€’ç”± SSL å¤„ç†åçš„æ•°æ®ã€‚  </li>\n<li>SSL åœ¨ TCP ä¹‹ä¸Šå»ºç«‹ä¸€ä¸ªåŠ å¯†é€šé“ï¼Œé€šè¿‡è¿™ä¸€å±‚çš„æ•°æ®ç»è¿‡äº†åŠ å¯†ï¼Œå› æ­¤è¾¾åˆ°ä¿å¯†çš„æ•ˆæœã€‚</li>\n</ul>\n</li>\n<li>æœåŠ¡ç«¯æœ¬åœ°ä¸å®¢æˆ·ç«¯æœ¬åœ°çš„ SSL å¥—æ¥å­—ä¸ TCP å¥—æ¥å­—çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"client-server-tcp-ssl-socket.png\" alt></li>\n</ul>\n<h3 id=\"ğŸš€-åŸºäº-SSL-TLS-åŠ å¯†è¿æ¥çš„-HTTPS-å•-åŒå‘è®¤è¯ï¼š\"><a href=\"#ğŸš€-åŸºäº-SSL-TLS-åŠ å¯†è¿æ¥çš„-HTTPS-å•-åŒå‘è®¤è¯ï¼š\" class=\"headerlink\" title=\"ğŸš€ åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯ï¼š\"></a>ğŸš€ åŸºäº SSL/TLS åŠ å¯†è¿æ¥çš„ HTTPS å•/åŒå‘è®¤è¯ï¼š</h3><ul>\n<li>ä»¥ä¸Šå…³äºæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„éªŒè¯åªæ˜¯ HTTPS é€šä¿¡ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œéœ€é€šè¿‡å…¶ä»–æ­¥éª¤å…±åŒå®Œæˆ HTTPS åŠ å¯†é€šä¿¡ã€‚</li>\n<li>HTTPS åŠ å¯†é€šä¿¡è®¤è¯åˆ†ä¸ºä¸¤ç±»ï¼šå•å‘è®¤è¯ã€åŒå‘è®¤è¯</li>\n<li>å•å‘è®¤è¯ä¸­åªéœ€æœåŠ¡ç«¯æä¾›æœåŠ¡ç«¯è¯ä¹¦ä¸ç§é’¥å³å¯ï¼Œè€ŒåŒå‘è®¤è¯ä¸­æœåŠ¡ç«¯éœ€æä¾›è¯ä¹¦ä¸ç§é’¥å¤–è¿˜éœ€æä¾› CA æ ¹è¯ä¹¦ï¼ˆè¯¥è¯ä¹¦ç”¨äºå®¢æˆ·ç«¯è¯ä¹¦çš„ç­¾å‘ï¼‰ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯éœ€æä¾›å®¢æˆ·ç«¯è¯ä¹¦ä¸ç§é’¥ã€‚</li>\n<li>å•å‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡ç«¯å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œç„¶åå»ºç«‹å®‰å…¨é€šä¿¡é€šé“ã€‚</li>\n<li>åŒå‘è®¤è¯çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯é™¤äº†éœ€è¦ä»æœåŠ¡ç«¯ä¸‹è½½æœåŠ¡å™¨çš„å…¬é’¥è¯ä¹¦è¿›è¡ŒéªŒè¯å¤–ï¼Œè¿˜éœ€è¦æŠŠå®¢æˆ·ç«¯çš„å…¬é’¥è¯ä¹¦ä¸Šä¼ åˆ°æœåŠ¡ç«¯ç»™æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯ï¼Œç­‰åŒæ–¹éƒ½è®¤è¯é€šè¿‡äº†ï¼Œæ‰å¼€å§‹å»ºç«‹å®‰å…¨é€šä¿¡é€šé“è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>\n<li>ğŸ‘¨â€ğŸ« <strong><font color=\"red\">æ€»ç»“ï¼š</font></strong><br>æ— è®º HTTPS å•å‘æˆ–åŒå‘è®¤è¯éƒ½æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯åå•†å‡º <strong><font color=\"red\">ä¼šè¯å¯†é’¥</font></strong> ä¸ <strong><font color=\"red\">ä¼šè¯åŠ å¯†ç®—æ³•</font></strong> çš„è¿‡ç¨‹ã€‚</li>\n<li>âœ¨ ä»¥ä¸‹ä» HTTPS æŠ“åŒ…çš„è§’åº¦è¯´æ˜ SSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹ï¼š<img src=\"ssl-four-handshakes-https-single-and-mutual-authentication.png\" alt>ä¸Šå›¾ä¸­ <strong>é»‘è‰²ç®­å¤´</strong> è¡¨ç¤ºåŒå‘è®¤è¯è¿‡ç¨‹ä¸­å¤šå‡ºçš„æ­¥éª¤ï¼Œå…¶ä½™è¿‡ç¨‹ä¸ºå•å‘è®¤è¯è¿‡ç¨‹ã€‚</li>\n</ul>\n<h3 id=\"ğŸ§ª-HTTPS-å•å‘è®¤è¯çš„-Wireshark-æŠ“åŒ…åˆ†æï¼š\"><a href=\"#ğŸ§ª-HTTPS-å•å‘è®¤è¯çš„-Wireshark-æŠ“åŒ…åˆ†æï¼š\" class=\"headerlink\" title=\"ğŸ§ª HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æï¼š\"></a>ğŸ§ª HTTPS å•å‘è®¤è¯çš„ Wireshark æŠ“åŒ…åˆ†æï¼š</h3><ul>\n<li>æœ¬ä¾‹ä½¿ç”¨ <code>Nginx HTTPS</code> æœåŠ¡æµ‹è¯• HTTPSï¼ˆHTTP + SSL/TLSï¼‰åŠ å¯†é€šä¿¡ã€‚</li>\n<li>ä½¿ç”¨å·²é…ç½®æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦çš„ Nginx å®¹å™¨æµ‹è¯• HTTPS åŠ å¯†é€šä¿¡è¿‡ç¨‹ï¼Œå¹¶ä½¿ç”¨ <code>Wireshark</code> æŠ“åŒ…åˆ†æã€‚</li>\n<li><p>æ„å»º Nginx å®¹å™¨ä½¿ç”¨çš„ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/tree/master/nginx-ssl\" target=\"_blank\" rel=\"noopener\">Dockerfile</a> å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># modified date: </span></span><br><span class=\"line\"><span class=\"comment\">#     - 2019-12-10: initial Dockerfile</span></span><br><span class=\"line\"><span class=\"comment\">#     - 2023-01-16: update nginx and add client ssl authentication</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> docker.io/library/centos:<span class=\"number\">7.9</span>.<span class=\"number\">2009</span></span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> lhua <span class=\"string\">\"hualongfeiyyy@163.com\"</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># install nginx dependent packages</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> yum repolist &amp;&amp; \\ </span></span><br><span class=\"line\">    yum install -y gcc* &amp;&amp; \\</span><br><span class=\"line\">    yum install -y pcre-devel openssl openssl-devel &amp;&amp; \\</span><br><span class=\"line\">    yum clean all &amp;&amp; \\</span><br><span class=\"line\">    mkdir -p /application/nginx-<span class=\"number\">1.22</span>.<span class=\"number\">1</span> &amp;&amp; \\</span><br><span class=\"line\">    useradd -u <span class=\"number\">1005</span> -M -s /sbin/nologin nginx</span><br><span class=\"line\">    <span class=\"comment\"># create nginx user to run nginx worker processes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># copy nginx source package to container rootfs</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> nginx-1.22.1.tar.gz /tmp/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># make install nginx </span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"bash\"> <span class=\"built_in\">cd</span> /tmp/nginx-1.22.1 &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    ./configure --user=nginx --group=nginx --prefix=/application/nginx-1.22.1 \\</span></span><br><span class=\"line\"><span class=\"bash\">      --with-http_stub_status_module --with-http_ssl_module &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    make &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    make install &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    ln -s /application/nginx-1.22.1 /application/nginx &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    mkdir /application/nginx/conf/extra &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    mkdir /application/nginx/html/www &amp;&amp; \\</span></span><br><span class=\"line\"><span class=\"bash\">    mkdir /application/nginx/key</span></span><br><span class=\"line\">    <span class=\"comment\"># create virtual server, html and key directory.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># copy nginx configuration file, virtual server configuration file and certification file.</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> nginx.conf /application/nginx/conf/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> www.conf /application/nginx/conf/extra/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> index.html /application/nginx/html/www/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> certs/server.key /application/nginx/key/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> certs/server.crt /application/nginx/key/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"bash\"> certs/CA-center.crt /application/nginx/key/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">443</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># <span class=\"doctag\">Note:</span> Don't run nginx as backend daemon</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"bash\"> [<span class=\"string\">\"/application/nginx/sbin/nginx\"</span>, <span class=\"string\">\"-g\"</span>, <span class=\"string\">\"daemon off;\"</span>]</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Nginx å®¹å™¨ä½¿ç”¨çš„ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/nginx-ssl/www.conf\" target=\"_blank\" rel=\"noopener\">é…ç½®æ–‡ä»¶</a>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br>âœ¨ è¯¥é…ç½®æ–‡ä»¶å¯ç”¨ HTTPS å•å‘è®¤è¯ï¼Œè‹¥éœ€å¼€å¯åŒå‘è®¤è¯è¿‡ç¨‹ï¼Œåªéœ€å¯ç”¨ <code>ssl_client_certificate</code> ä¸ <code>ssl_verify_client</code> å‚æ•°å³å¯ã€‚  </p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Web Service: domain-based virtual machine</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>  <span class=\"number\">443</span>;</span><br><span class=\"line\">    <span class=\"comment\"># alias for domain-based virtual machine</span></span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  www.etiantian.org etiantian.org;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl</span>  <span class=\"literal\">on</span>;  <span class=\"comment\"># Nginx å¯ç”¨ SSL/TLS éªŒè¯ï¼šæŒ‡å®šæœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥</span></span><br><span class=\"line\">    <span class=\"comment\"># enable openssl module to support SSL/TLS</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span>  /application/nginx/key/server.crt;</span><br><span class=\"line\">    <span class=\"comment\"># server.crt è¯ä¹¦å‘é€è‡³å®¢æˆ·ç«¯ç”¨äºéªŒè¯å…¶èº«ä»½ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å…¶ä¸­çš„å…¬é’¥åŠ å¯†</span></span><br><span class=\"line\">    <span class=\"comment\"># pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°å¹¶å‘é€è‡³æœåŠ¡ç«¯åå•†ä¼šè¯å¯†é’¥ã€‚</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span>  /application/nginx/key/server.key;</span><br><span class=\"line\">    <span class=\"comment\"># server.key ç”¨äºè§£å¯†ä»å®¢æˆ·ç«¯å‘é€æ¥çš„å·²åŠ å¯†çš„ pre-master ç¬¬ä¸‰ä¸ªéšæœºæ•°</span></span><br><span class=\"line\">    <span class=\"comment\">#ssl_client_certificate  /application/nginx/key/CA-center.crt;</span></span><br><span class=\"line\">    <span class=\"comment\">#ssl_verify_client  on;</span></span><br><span class=\"line\">    <span class=\"comment\"># å¯ç”¨æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯ SSL/TLS åŒå‘éªŒè¯</span></span><br><span class=\"line\">    <span class=\"comment\"># è‹¥åªéœ€æœåŠ¡ç«¯å•å‘éªŒè¯ï¼Œæ— éœ€å¯ç”¨ ssl_client_certificate ä¸ ssl_verify_clientã€‚</span></span><br><span class=\"line\">    <span class=\"attribute\">ssl_session_timeout</span>  <span class=\"number\">5m</span>;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_protocols</span>  TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_ciphers</span>  ALL:!DH:!EXPORT:!RC4:+HIGH:+MEDIUM:-LOW:!aNULL:!eNULL;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_prefer_server_ciphers</span>  <span class=\"literal\">on</span>; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>   html/www;</span><br><span class=\"line\">        <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æŠ“åŒ… HTTPS åŠ å¯†é€šä¿¡çš„ä¸‰ä¸ªè¿‡ç¨‹ï¼šTCP å»ºç«‹è¿æ¥ã€SSL/TLS æ¡æ‰‹ã€SSL/TLS åŠ å¯†é€šä¿¡</p>\n</li>\n<li>HTTPS åŠ å¯†é€šä¿¡ - æŠ“åŒ…æ•´ä½“ç¤ºæ„ï¼š<img src=\"wireshark-https-single-progress.png\" alt></li>\n<li>ğŸ¤ HTTPS åŠ å¯†é€šä¿¡ - 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ç¤ºæ„ï¼š<img src=\"ssl-tls-single-authentication-progress.png\" alt>ğŸ‘¨â€ğŸ’» ä»¥ä¸‹å°†æ¡æ‰‹è¿‡ç¨‹åˆ†ä¸º 4 ä¸ªé˜¶æ®µè¿›è¡Œæè¿°ã€‚</li>\n<li>1ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 1 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š<code>Client Hello</code>  <ul>\n<li>å®¢æˆ·ç«¯é¦–å…ˆå‘æœåŠ¡ç«¯å‘é€ Client Hello çš„ SSL æ¡æ‰‹ä¿¡æ¯ã€‚  </li>\n<li>Client Hello æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«å¦‚ä¸‹å†…å®¹ï¼š    <ul>\n<li>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œä»¥æ˜æ–‡ä¼ è¾“è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€å®¢æˆ·ç«¯éšæœºæ•°ã€åŠ å¯†å¥—ä»¶å€™é€‰åˆ—è¡¨ã€å‹ç¼©ç®—æ³•å€™é€‰åˆ—è¡¨ã€æ‰©å±•å­—æ®µç­‰ä¿¡æ¯ã€‚    </li>\n<li>æ”¯æŒçš„æœ€é«˜ TLS åè®®ç‰ˆæœ¬ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ SSLv2ã€SSLv3ã€TLSv1ã€TLSv1.1ã€TLSv1.2ï¼Œå½“å‰åŸºæœ¬ä¸å†ä½¿ç”¨ä½äº TLSv1 çš„ç‰ˆæœ¬ã€‚    </li>\n<li>âœ¨ éšæœºæ•° <code>random_C</code>ï¼Œç”¨äºåç»­çš„ä¼šè¯å¯†é’¥ç”Ÿæˆã€‚    </li>\n<li>å®¢æˆ·ç«¯æ”¯æŒçš„åŠ å¯†å¥—ä»¶ <code>Cipher Suites</code> åˆ—è¡¨ï¼Œæ¯ä¸ªåŠ å¯†å¥—ä»¶å¯¹åº” TLS åŸç†ä¸­çš„å››ä¸ªåŠŸèƒ½çš„ç»„åˆï¼š      <ul>\n<li>è®¤è¯ç®—æ³• <code>Au</code>ï¼šèº«ä»½éªŒè¯      </li>\n<li>å¯†é’¥äº¤æ¢ç®—æ³• <code>KeyExchange</code>ï¼šï¼ˆä¼šè¯ï¼‰å¯†é’¥åå•†      </li>\n<li>å¯¹ç§°åŠ å¯†ç®—æ³• <code>Enc</code>ï¼šä¿¡æ¯åŠ å¯†      </li>\n<li>ä¿¡æ¯æ‘˜è¦ <code>Mac</code>ï¼šå®Œæ•´æ€§æ ¡éªŒ    </li>\n</ul>\n</li>\n<li>æ”¯æŒçš„å‹ç¼©ç®—æ³• <code>Compression Methods</code> åˆ—è¡¨ï¼Œç”¨äºåç»­çš„ä¿¡æ¯å‹ç¼©ä¼ è¾“ã€‚    </li>\n<li>æ‰©å±•å­—æ®µ Extensionsï¼Œæ”¯æŒåè®®ä¸ç®—æ³•çš„ç›¸å…³å‚æ•°ä»¥åŠå…¶å®ƒè¾…åŠ©ä¿¡æ¯ç­‰ï¼Œå¸¸è§çš„ SNI å°±å±äºæ‰©å±•å­—æ®µã€‚<img src=\"client-hello-body-1.png\" alt>  </li>\n</ul>\n</li>\n<li>å®¢æˆ·ç«¯æ”¯æŒçš„ 17 ç§åŠ å¯†å¥—ä»¶ä¾›æœåŠ¡ç«¯é€‰æ‹©ä½¿ç”¨ã€‚<img src=\"client-hello-body-2.png\" alt></li>\n</ul>\n</li>\n<li>2ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 2 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤çš„ 4 æ¡ SSL æ¡æ‰‹ä¿¡æ¯<img src=\"server-response-to-client-ssl.png\" alt><ul>\n<li><code>Server Hello</code>ï¼š    <ul>\n<li>æœåŠ¡ç«¯è¿”å›åå•†çš„ä¿¡æ¯ç»“æœï¼ŒåŒ…æ‹¬é€‰æ‹©ä½¿ç”¨çš„åè®®ç‰ˆæœ¬ã€é€‰æ‹©çš„åŠ å¯†å¥—ä»¶ã€é€‰æ‹©çš„å‹ç¼©ç®—æ³•ã€éšæœºæ•° <code>random_S</code> ç­‰ï¼Œå…¶ä¸­éšæœºæ•°ç”¨äºåç»­çš„å¯†é’¥åå•†ã€‚    </li>\n<li>æœåŠ¡ç«¯é€‰æ‹© <strong><font color=\"orange\">TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</font></strong> ä½œä¸ºå¯†é’¥äº¤äº’çš„åŠ å¯†å¥—ä»¶ï¼Œè¯¥åŠ å¯†å¥—ä»¶çš„åå­—åœ¨å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ”¯æŒçš„ <code>17</code> ä¸ªåˆ—è¡¨ä¸­ã€‚    </li>\n<li>è¯¥åŠ å¯†å¥—ä»¶åŒ…å«ï¼š      <ul>\n<li>éå¯¹ç§°åŠ å¯†ï¼ˆå¯†é’¥äº¤æ¢ç®—æ³•ï¼‰ï¼š<code>ECDHE + RSA</code>      </li>\n<li>å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š<code>AES + GCM</code>      </li>\n<li>æ¶ˆæ¯æ‘˜è¦ç®—æ³•ï¼š<code>SHA-384</code>  </li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>Certificate</code>ï¼šè¯¥ SSL æ¡æ‰‹ä¿¡æ¯ä¸­åŒ…å«æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦<img src=\"server-ca-signed-certification.png\" alt>  </li>\n<li><code>Server Key Exchange</code>ï¼š<br>ä½¿ç”¨ <code>EC Diffie-Hellman</code> ç®—æ³•ï¼ˆ<code>ECDHE</code>ï¼‰å®ç°æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„å¯†é’¥äº¤æ¢ç®—æ³•åå•†ã€‚<img src=\"server-key-exchange.png\" alt><br>ğŸ’¥ å¯¹äºä½¿ç”¨ <code>DHE/ECDHE</code> éå¯¹ç§°å¯†é’¥åå•†ç®—æ³•çš„ SSL æ¡æ‰‹ï¼Œå°†å‘é€è¯¥ç±»å‹æ¡æ‰‹ã€‚<code>RSA</code>ã€<code>DH</code>ã€<code>ECDH</code> ç®—æ³•ä¸ä¼šè¿›è¡Œè¯¥ server key exchange æ¡æ‰‹æµç¨‹ã€‚ </li>\n<li><code>Server Hello Done</code>ï¼šé€šçŸ¥å®¢æˆ·ç«¯ Server Hello ä¿¡æ¯å‘é€ç»“æŸ<img src=\"server-hello-done.jpg\" alt></li>\n</ul>\n</li>\n<li>3ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 3 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šå®¢æˆ·ç«¯ç»™æœåŠ¡ç«¯å›å¤ 3 æ¡ SSL æ¡æ‰‹ä¿¡æ¯<img src=\"client-response-to-server-ssl.jpg\" alt><ul>\n<li><code>Client Key Exchange</code>ï¼š    <ul>\n<li>æœåŠ¡ç«¯ CA æ•°å­—ç­¾åè¯ä¹¦åˆæ³•æ€§éªŒè¯é€šè¿‡åï¼Œå®¢æˆ·ç«¯è®¡ç®—äº§ç”Ÿéšæœºæ•°å­— <code>Pre-master</code>ï¼Œå¹¶ç”¨æœåŠ¡ç«¯è¯ä¹¦ä¸­çš„å…¬é’¥åŠ å¯†ï¼Œå‘é€ç»™æœåŠ¡ç«¯ã€‚<br>ğŸ’¥ æ³¨æ„ï¼šæœåŠ¡ç«¯è¯ä¹¦åˆæ³•æ€§éªŒè¯å¤±è´¥ï¼ŒSSL æ¡æ‰‹å³åœæ­¢ï¼    </li>\n<li>æ­¤æ—¶å®¢æˆ·ç«¯å·²ç»è·å–å…¨éƒ¨çš„è®¡ç®—ä¼šè¯å¯†é’¥éœ€è¦çš„ä¿¡æ¯ï¼š<br>ğŸš€ ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° <code>random_C</code> å’Œ <code>random_S</code> ä¸è‡ªå·±è®¡ç®—äº§ç”Ÿçš„ <code>Pre-master</code>ï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚  </li>\n</ul>\n</li>\n<li><code>Change Cipher Spec</code>ï¼š<br> ğŸš€ å®¢æˆ·ç«¯é€šçŸ¥æœåŠ¡ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ <strong><font color=\"red\">ä¼šè¯å¯†é’¥</font></strong> å’Œ <strong><font color=\"red\">ä¼šè¯åŠ å¯†ç®—æ³•</font></strong> è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  </li>\n<li><code>Encrypted Handshake Message</code>ï¼š<br>ç»“åˆä¹‹å‰æ‰€æœ‰é€šä¿¡å‚æ•°çš„å“ˆå¸Œå€¼ç”Ÿæˆä¸€æ®µæ•°æ®ï¼Œé‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™æœåŠ¡å™¨ç”¨äºæ•°æ®ä¸æ¡æ‰‹éªŒè¯ã€‚</li>\n</ul>\n</li>\n<li>4ï¸âƒ£ HTTPS åŠ å¯†é€šä¿¡ - ç¬¬ 4 æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼šæœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯å›å¤ 2 æ¡ SSL æ¡æ‰‹ä¿¡æ¯<img src=\"server-response-to-client-4-phase.png\" alt><ul>\n<li><code>Change Cipher Spec</code>ï¼š    <ul>\n<li>æœåŠ¡ç«¯ç”¨ç§é’¥è§£å¯†åŠ å¯†çš„ <code>Pre-master</code> éšæœºæ•°ï¼ŒåŸºäºä¹‹å‰äº¤æ¢çš„ä¸¤ä¸ªæ˜æ–‡éšæœºæ•° random_C å’Œ random_Sï¼Œè®¡ç®—å¾—åˆ°ä¼šè¯å¯†é’¥ã€‚    </li>\n<li>è®¡ç®—ä¹‹å‰æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œç„¶åè§£å¯†å®¢æˆ·ç«¯å‘é€çš„ <code>Encrypted Handshake Message</code>ï¼ŒéªŒè¯ä¼šè¯å¯†é’¥å’Œæ•°æ®çš„å‡†ç¡®æ€§ã€‚    </li>\n<li>Change Cipher Spec éªŒè¯é€šè¿‡ä¹‹åï¼ŒæœåŠ¡ç«¯åŒæ ·å‘é€ Change Cipher Spec ä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯åç»­çš„é€šä¿¡éƒ½é‡‡ç”¨åå•†çš„ä¼šè¯å¯†é’¥ä¸ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚  </li>\n</ul>\n</li>\n<li><code>Encrypted Handshake Message</code>ï¼š    <ul>\n<li>æœåŠ¡å™¨ä¹Ÿç»“åˆæ‰€æœ‰å½“å‰çš„é€šä¿¡å‚æ•°ä¿¡æ¯ç”Ÿæˆä¸€æ®µæ•°æ®å¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å‘é€åˆ°å®¢æˆ·ç«¯ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>HTTPS åŠ å¯†é€šä¿¡ - æ¡æ‰‹ç»“æŸï¼š  <ul>\n<li>å®¢æˆ·ç«¯è®¡ç®—æ‰€æœ‰æ¥æ”¶ä¿¡æ¯çš„å“ˆå¸Œå€¼ï¼Œå¹¶é‡‡ç”¨ä¼šè¯å¯†é’¥è§£å¯† Encrypted Handshake Messageï¼ŒéªŒè¯æœåŠ¡å™¨å‘é€çš„ä¼šè¯å¯†é’¥å’Œæ•°æ®ï¼ŒéªŒè¯é€šè¿‡åˆ™æ¡æ‰‹å®Œæˆã€‚  </li>\n<li>å¼€å§‹ä½¿ç”¨ä¼šè¯å¯†é’¥ä¸åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚<img src=\"ssl-tls-handshake-end.png\" alt></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"HTTPS-å•å‘è®¤è¯æµ‹è¯•ï¼š\"><a href=\"#HTTPS-å•å‘è®¤è¯æµ‹è¯•ï¼š\" class=\"headerlink\" title=\"HTTPS å•å‘è®¤è¯æµ‹è¯•ï¼š\"></a>HTTPS å•å‘è®¤è¯æµ‹è¯•ï¼š</h3><ul>\n<li>æœåŠ¡ç«¯å¯ç”¨ HTTPS å•å‘è®¤è¯åï¼Œå¯ä»æµè§ˆå™¨å®¢æˆ·ç«¯è¿›è¡Œè®¿é—®æµ‹è¯•ï¼š<img src=\"https-single-auth-chrome-error-1.png\" alt></li>\n<li>è¯¥æœåŠ¡ç«¯ CA æ•°å­—ç­¾åä½¿ç”¨æœªç»è®¤è¯çš„ CA ç­¾å‘ï¼Œå› æ­¤å®¢æˆ·ç«¯æµè§ˆå™¨æ— æ³•éªŒè¯å…¶å®‰å…¨æ€§è€Œå‘å‡ºè­¦å‘Šï¼Œå¯ç‚¹å‡» â€œé«˜çº§â€ æŒ‰é’®æ¥å—è¯¥è¯ä¹¦ç»§ç»­è®¿é—®ã€‚è‹¥æ‹’ç»è¯¥è¯ä¹¦ï¼Œå³æ–­å¼€æ­¤æ¬¡è®¤è¯è¿æ¥ï¼Œå¯åœ¨å¦‚ä¸‹ Wireshark æŠ“åŒ…ä¸­æ˜¾ç¤ºå®‰å…¨å‘Šè­¦ä¿¡æ¯ï¼š<img src=\"https-single-auth-chrome-error-2.png\" alt> </li>\n</ul>\n<h3 id=\"HTTPS-åŒå‘è®¤è¯çš„-Wireshark-æŠ“åŒ…ä¸æµ‹è¯•ï¼š\"><a href=\"#HTTPS-åŒå‘è®¤è¯çš„-Wireshark-æŠ“åŒ…ä¸æµ‹è¯•ï¼š\" class=\"headerlink\" title=\"HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•ï¼š\"></a>HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…ä¸æµ‹è¯•ï¼š</h3><ul>\n<li>HTTPS åŒå‘è®¤è¯çš„ Wireshark æŠ“åŒ…è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶ä¸­å…·ä½“çš„æ­¥éª¤å‚è§å‰æ–‡ â€œSSL/TLS å››æ¬¡æ¡æ‰‹ä¸ HTTPS å•/åŒå‘è®¤è¯çš„è¯¦ç»†è¿‡ç¨‹â€ ä¸å•å‘è®¤è¯çš„è¿‡ç¨‹ã€‚<img src=\"wireshark-https-single-progress.png\" alt></li>\n<li><p>HTTPS åŒå‘è®¤è¯è¿‡ç¨‹çš„å®¢æˆ·ç«¯æµ‹è¯•ï¼š  </p>\n<ul>\n<li><p>é…ç½®ç”Ÿæˆå®¢æˆ·ç«¯æ‰€éœ€çš„æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa -out client.key 2048</span><br><span class=\"line\">$ openssl req -key client.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=firefox\"</span> \\</span><br><span class=\"line\">  -new -out client.csr</span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> client.csr \\</span><br><span class=\"line\">  -CAkey CA-center.key -CA CA-center.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out client.crt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è‹¥å°†å®¢æˆ·ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸ç§é’¥ç”¨äº <code>Firefox</code> æˆ– <code>Chrome</code> æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œå¯å°†å…¶è½¬æ¢ä¸º <code>p12</code> æ ¼å¼ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl pkcs12 -<span class=\"built_in\">export</span> -clcerts \\</span><br><span class=\"line\">  -<span class=\"keyword\">in</span> client.crt -inkey client.key -out client.p12</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º client.p12 æ–‡ä»¶æ—¶å°†äº¤äº’å¼è¾“å…¥åŠ å¯†å¯†ç </span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å°† p12 æ ¼å¼çš„æ–‡ä»¶å¯¼å…¥ Firefox æµè§ˆå™¨å®¢æˆ·ç«¯ï¼š<img src=\"firefox-import-pc12-certs-1.png\" alt><img src=\"firefox-import-pc12-certs-2.png\" alt><img src=\"firefox-import-pc12-certs-3.png\" alt><img src=\"firefox-import-pc12-certs-4.png\" alt></p>\n</li>\n<li>æ‰“å¼€ Firefox æµè§ˆå™¨è®¿é—®æœåŠ¡ç«¯ï¼Œæ­¤æ—¶éœ€æ¥å—å®¢æˆ·ç«¯è¯ä¹¦æ¥æ ‡è®°è‡ªå·±ï¼š<img src=\"firefox-import-pc12-certs-5.png\" alt>  </li>\n<li>ğŸ’¥ è‹¥åŒå‘è®¤è¯å®¢æˆ·ç«¯é…ç½®é”™è¯¯ï¼Œå°†æ— æ³•æ­£å¸¸è®¿é—®æœåŠ¡ç«¯ï¼Œå¹¶ä¸”æµè§ˆå™¨ç›´æ¥è¿”å›å¦‚ä¸‹ä¿¡æ¯ï¼Œä¸” Wireshark æŠ“åŒ…æ˜¾ç¤º <code>Encrypted Alert</code>ï¼š<img src=\"https-mutual-no-client-cert-error-1.png\" alt><img src=\"https-mutual-no-client-cert-error-2.png\" alt></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"openssl-å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\"><a href=\"#openssl-å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\" class=\"headerlink\" title=\"openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š\"></a>openssl å¸¸ç”¨å‘½ä»¤æ±‡æ€»ï¼š</h3><ul>\n<li><p><code>openssl req</code> å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»º <code>csr</code> è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦ï¼ˆæˆ–è‡ªç­¾åè¯ä¹¦ï¼‰  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-key               æŒ‡å®šç”¨äºåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚çš„ç§é’¥            </span><br><span class=\"line\">-newkey alg:nbits  åˆ›å»ºæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸ç§é’¥ï¼ŒæŒ‡å®šåŠ å¯†ç®—æ³•ä¸åŠ å¯†ä½æ•°</span><br><span class=\"line\">                  ï¼ˆé€šå¸¸ä¸º rsa:2048ï¼‰ã€‚             </span><br><span class=\"line\">-nodes             ä¸ä½¿ç”¨å¯†ç ä¸ºæ–°åˆ›å»ºçš„ç§é’¥åŠ å¯†</span><br><span class=\"line\">-keyout            æŒ‡å®šæ–°åˆ›å»ºç§é’¥çš„æ–‡ä»¶å</span><br><span class=\"line\">-sha256            ä½¿ç”¨ SHA-256 æ‘˜è¦ï¼ˆåˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦æ—¶ä½¿ç”¨ï¼‰</span><br><span class=\"line\">-subj              æŒ‡å®šåˆ›å»º csr è¯ä¹¦ç­¾åè¯·æ±‚ä¸æ•°å­—ç­¾åè¯ä¹¦æ‰€éœ€çš„è¯¦ç»†ä¿¡æ¯è‹¥æœªæŒ‡å®š</span><br><span class=\"line\">                   è¯¥é€‰é¡¹ï¼Œå°†è¿›å…¥äº¤äº’æ¨¡å¼ã€‚</span><br><span class=\"line\">-new               ç”Ÿæˆæ–°çš„ csr è¯ä¹¦ç­¾åè¯·æ±‚</span><br><span class=\"line\">-x509              ç”Ÿæˆæ•°å­—ç­¾åè¯ä¹¦ï¼ˆä¸ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰</span><br><span class=\"line\">-days              æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ã€‚</span><br><span class=\"line\">-out               æŒ‡å®šè¾“å‡ºçš„ csr è¯ä¹¦ç­¾åè¯·æ±‚æˆ–æ•°å­—ç­¾åè¯ä¹¦çš„åç§°</span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>openssl x509</code> å‘½ä»¤é€‰é¡¹ï¼šåˆ›å»ºä¸æŸ¥çœ‹æ•°å­—ç­¾åè¯ä¹¦  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-req             æŒ‡å®š csr è¯ä¹¦ç­¾åè¯·æ±‚ï¼Œä¸ -<span class=\"keyword\">in</span> é€‰é¡¹åˆç”¨ã€‚                </span><br><span class=\"line\">-<span class=\"keyword\">in</span>              æŒ‡å®šè¾“å…¥æ–‡ä»¶</span><br><span class=\"line\">-CAkey           æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA ç§é’¥</span><br><span class=\"line\">-CA              æŒ‡å®šç”¨äºç­¾ç½²è¯ä¹¦çš„ CA æ ¹è¯ä¹¦</span><br><span class=\"line\">-CAcreateserial  åˆ›å»º CA åºåˆ—å·æ–‡ä»¶ï¼Œæ‰©å±•åä¸º <span class=\"string\">\".srl\"</span>ï¼Œè¯¥é€‰é¡¹å¿…é¡»ä¸ -CA é€‰é¡¹åˆç”¨ã€‚</span><br><span class=\"line\">-days            æŒ‡å®šæ•°å­—ç­¾åè¯ä¹¦çš„åˆæ³•æ—¶é—´ï¼ˆæœ‰æ•ˆæœŸï¼‰ï¼Œé»˜è®¤ 30 å¤©ï¼Œä¸ä¸</span><br><span class=\"line\">                 -preserve_dates é€‰é¡¹åˆç”¨ã€‚</span><br><span class=\"line\">-out             æŒ‡å®šè¾“å‡ºçš„æ•°å­—ç­¾åè¯ä¹¦åç§°</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦çš„ 2 ç§æ–¹æ³•ï¼š  </p>\n<ul>\n<li>1ï¸âƒ£ å…ˆåˆ›å»ºç§é’¥å†åˆ›å»ºè‡ªç­¾åæ•°å­—è¯ä¹¦  </li>\n<li>2ï¸âƒ£ åŒæ—¶åˆ›å»ºç§é’¥ä¸è‡ªç­¾åæ•°å­—è¯ä¹¦    <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl req -newkey rsa:4096 -nodes -keyout server.key \\</span><br><span class=\"line\">  -sha256 -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\"</span> \\</span><br><span class=\"line\">  -x509 -days 3650 -out server.crt</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>åˆ›å»º CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦ï¼ˆroot-caï¼‰ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa [-des3] -out ca.key [1024|2048|4096]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º CA RSA ç§é’¥</span></span><br><span class=\"line\"><span class=\"comment\"># -des3 é€‰é¡¹ï¼šäº¤äº’è¾“å…¥å¯†ç ä¸º RSA ç§é’¥åŠ å¯†</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -key ca.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=CA-center.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -x509 \\</span><br><span class=\"line\">  -days 3650 -out ca.crt</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º CA è‡ªç­¾åæ ¹è¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl rsa -<span class=\"keyword\">in</span> ca.key -text -noout</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ CA RSA ç§é’¥çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -<span class=\"keyword\">in</span> ca.crt -text -noout</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ CA æ ¹è¯ä¹¦çš„è¯¦ç»†ä¿¡æ¯</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa [-des3] -out server.key [1024|2048|4096]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º server ç«¯ RSA ç§é’¥</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl rsa -<span class=\"keyword\">in</span> server.key -pubout -out server.pub</span><br><span class=\"line\"><span class=\"comment\"># æå– server ç«¯ RSA ç§é’¥å¯¹åº”çš„å…¬é’¥ï¼ˆå…¬é’¥ç”±ç§é’¥ä¸­æå–ï¼‰</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -key server.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/O=RedHat/OU=GLS/CN=cloud-ctl.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -out server.csr</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆcertificate signing requestï¼‰</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. åˆ›å»º csr ä¸ä½¿ç”¨ -x509 ä¸ -days é€‰é¡¹</span></span><br><span class=\"line\"><span class=\"comment\">#   2. åœ¨åˆ›å»ºç”ŸæˆæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚æ—¶å‡è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#      a. CA æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å³å¯ï¼Œæ‰€æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„è¯ä¹¦è¯¥å­—æ®µ</span></span><br><span class=\"line\"><span class=\"comment\">#         éœ€è¦å¡«å†™ IP æˆ–åŸŸåã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#      b. ä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼ŒCA æ ¹è¯ä¹¦çš„è¯¥å­—æ®µå’ŒæœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦ä¸èƒ½ä¸€æ ·ã€‚</span></span><br><span class=\"line\"><span class=\"comment\">#      c. å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼ŒCA æ ¹è¯ä¹¦ã€æœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´ï¼Œæœ€åçš„å¯†ç </span></span><br><span class=\"line\"><span class=\"comment\">#         å¯ç›´æ¥å›è½¦è·³è¿‡ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -noout -text -<span class=\"keyword\">in</span> server.csr</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯è¯ä¹¦ç­¾åè¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> server.csr \\</span><br><span class=\"line\">  -CAkey ca.key -CA ca.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out server.crt</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ server ç«¯ csr è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º server ç«¯æ•°å­—ç­¾åè¯ä¹¦</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„ç›¸å…³ä¿¡æ¯ ###</span></span><br><span class=\"line\">$ openssl x509 -noout -serial -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„åºåˆ—å·</span></span><br><span class=\"line\">$ openssl x509 -noout -dates -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦çš„æœ‰æ•ˆæœŸ</span></span><br><span class=\"line\">$ openssl x509 -noout -pubkey -<span class=\"keyword\">in</span> server.crt</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ server ç«¯æ•°å­—ç­¾åè¯ä¹¦ä¸­çš„å…¬é’¥ä¿¡æ¯ï¼Œè¯¥å…¬é’¥ä¸ç§é’¥ä¸­æå–çš„å…¬é’¥ä¸€è‡´ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åŸºäº CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl genrsa [-des3] -out client.key [1024|2048|4096]</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º client ç«¯ RSA ç§é’¥</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl req -key client.key \\</span><br><span class=\"line\">  -subj <span class=\"string\">\"/C=CN/ST=Shanghai/L=Shanghai/CN=sec-srv.lab.example.com\"</span> \\</span><br><span class=\"line\">  -new -out client.csr</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º client ç«¯è¯ä¹¦ç­¾åè¯·æ±‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl x509 -req -<span class=\"keyword\">in</span> client.csr \\</span><br><span class=\"line\">  -CAkey ca.key -CA ca.crt -CAcreateserial \\</span><br><span class=\"line\">  -days 3650 -out client.crt</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨è¯ä¹¦ç­¾åè¯·æ±‚ã€CA RSA ç§é’¥ä¸ CA æ ¹è¯ä¹¦åˆ›å»º client ç«¯æ•°å­—ç­¾åè¯ä¹¦</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"openssl-ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\"><a href=\"#openssl-ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\" class=\"headerlink\" title=\"openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š\"></a>openssl ä½¿ç”¨æ•°å­—ç­¾åè¯ä¹¦çš„å•åŒå‘è¿æ¥æµ‹è¯•ï¼š</h3><ul>\n<li><p>ä½¿ç”¨ server ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå•å‘è¿æ¥æµ‹è¯•ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl s_server -accept &lt;port&gt; -key server.key -cert server.crt    </span><br><span class=\"line\"><span class=\"comment\"># server ç«¯ï¼šå¯åŠ¨å•å‘å®‰å…¨è¿æ¥ï¼Œå¯åŠ¨åå°†ç­‰å¾… client ç«¯å‘é€ä¿¡æ¯å¹¶å›æ˜¾</span></span><br><span class=\"line\">$ openssl s_client -connect &lt;host_ip&gt;:&lt;port&gt;</span><br><span class=\"line\"><span class=\"comment\"># client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä½¿ç”¨ server ç«¯ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡ŒåŒå‘è¿æ¥æµ‹è¯•ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ openssl s_server -accept &lt;port&gt; \\</span><br><span class=\"line\">  -key server.key -cert server.crt -Verify &lt;depth&gt;</span><br><span class=\"line\"><span class=\"comment\"># server ç«¯ï¼šå¼ºåˆ¶è¦æ±‚ client ç«¯æä¾›ç§é’¥ä¸ client ç«¯æ•°å­—ç­¾åè¯ä¹¦è¿›è¡Œå®‰å…¨è¿æ¥</span></span><br><span class=\"line\">$ openssl s_server -accept 10001 \\</span><br><span class=\"line\">  -key server.key -cert server.crt -Verify 5</span><br><span class=\"line\"></span><br><span class=\"line\">$ openssl s_client -connect &lt;host_ip&gt;:&lt;port&gt; \\</span><br><span class=\"line\">  -key client.key -cert client.crt</span><br><span class=\"line\"><span class=\"comment\"># client ç«¯ï¼šè¿æ¥ server ç«¯ï¼Œè‹¥è¿æ¥æˆåŠŸåå°†åœ¨ä»»æ„ä¸€ç«¯è¾“å…¥ä¿¡æ¯åä¼šåœ¨å¦ä¸€ç«¯æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚</span></span><br><span class=\"line\">$ openssl s_client \\</span><br><span class=\"line\">  -connect 10.197.11.100:10001 -key client.key -cert client.crt</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://www.wosign.com/FAQ/faq2016-0309-04.htm\" target=\"_blank\" rel=\"noopener\">HTTPS åŠ å¯†åè®®è¯¦è§£ (å››)ï¼šTLS/SSL æ¡æ‰‹è¿‡ç¨‹</a></li>\n<li><a href=\"https://blog.csdn.net/mrpre/article/details/77867831\" target=\"_blank\" rel=\"noopener\">TLS/SSL åè®®è¯¦è§£(12) server key exchange</a></li>\n<li><a href=\"https://help.aliyun.com/document_detail/160093.html\" target=\"_blank\" rel=\"noopener\">ä»€ä¹ˆæ˜¯ HTTPS åŒå‘è®¤è¯(MutualTLSauthentication)_API ç½‘å…³ - é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ</a></li>\n<li><a href=\"https://blog.xizhibei.me/2021/02/03/https-two-way-authentication-with-certificates/\" target=\"_blank\" rel=\"noopener\">HTTPS åŒå‘è¯ä¹¦è®¤è¯</a></li>\n<li><a href=\"https://www.cnblogs.com/xiao987334176/p/11041241.html\" target=\"_blank\" rel=\"noopener\">NGINX é…ç½®æœ¬åœ° HTTPS (åŒå‘è®¤è¯)</a></li>\n<li><a href=\"https://blog.csdn.net/justinjing0612/article/details/7770301\" target=\"_blank\" rel=\"noopener\">å¸¸è§è¯ä¹¦æ ¼å¼å’Œè½¬æ¢</a></li>\n<li><a href=\"https://www.cnblogs.com/lzjsky/archive/2010/11/14/1877143.html\" target=\"_blank\" rel=\"noopener\">å¸¸è§è¯ä¹¦æ ¼å¼åŠç›¸äº’è½¬æ¢</a></li>\n<li><a href=\"https://www.cnblogs.com/threegun/p/7130985.html\" target=\"_blank\" rel=\"noopener\">openssl ç”Ÿæˆè‡ªç­¾è¯ä¹¦åŠæŸ¥çœ‹è¯ä¹¦ç»†èŠ‚</a></li>\n</ul>\n"},{"title":"Kani - Ansible å¿«é€Ÿéƒ¨ç½²ä¸ç®¡ç† Kubernetes v1.22.1","subtitle":"Use Kani to Rapidly Deploy Kubernetes Cluster","header-img":"kani-ansible-k8s.svg","date":"2022-11-28T06:01:23.000Z","_content":"\n### æ–‡æ¡£ç›®å½•ï¼š\n- é¡¹ç›®ç›®çš„\n- å®æ–½ç¯å¢ƒ\n- éœ€è¦æ›´æ”¹çš„å‚æ•°\n- å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•\n- Kani çš„ä½¿ç”¨æ–¹æ³•\n- å‚è€ƒé“¾æ¥\n\n### é¡¹ç›®ç›®çš„ï¼š\n- è™½ç„¶ç›®å‰å…·æœ‰å¤§é‡çš„ Kubernetes é›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­å®˜æ–¹çš„ `KubeSpray` å³ä¸ºä½¿ç”¨ Ansible çš„æ–¹å¼éƒ¨ç½²ï¼Œä½†æƒ³å°è¯•è‡ªå·±æ‰‹åŠ¨é€ è½®å­ï¼Œå› æ­¤åˆ›å»ºäº† Kani é¡¹ç›®ã€‚\n- Kani é¡¹ç›®çš„ç›®çš„åœ¨äºä½¿ç”¨ Ansible å¿«é€Ÿéƒ¨ç½²ä¸ç®¡ç† Kubernetes é›†ç¾¤åŠå…¶ç›¸å…³ç»„ä»¶ã€‚\n- å½“å‰ç‰ˆæœ¬ä¸­ Kani æ”¯æŒï¼š  \n  - `Containerd` runtime  \n  - `Calico` CNI  \n  - `Red Hat Quay v3 registry`\n- Kani çš„å¯é€‰åŠŸèƒ½åŒ…æ‹¬éƒ¨ç½²ä¸ç®¡ç†å…¶ä»–é¢å¤–çš„äº‘åŸç”Ÿã€DevOps ä¸ GitOps ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - å®¹å™¨é•œåƒä»“åº“ï¼šRed Hat Quay v3 registry  \n  - ä»£ç ä»“åº“ï¼šGitLab\n- å¯ç‚¹å‡» [æ­¤å¤„](https://github.com/Alberthua-Perl/kani) è·å– Kani é¡¹ç›® ğŸ‘‹\n\n### å®æ–½ç¯å¢ƒï¼š\n- OS ç‰ˆæœ¬ï¼š`CentOS Linux release 7.9.2009` (Core)\n- kernel ç‰ˆæœ¬ï¼š`5.13.12`\n> å¯ä½¿ç”¨ `elrepo repository` å‡çº§ Linux kernelã€‚\n- Ansible ç‰ˆæœ¬ï¼š`2.9.25`\n- Containerd ç‰ˆæœ¬ï¼š`1.5.5`\n- Kubernetes ç‰ˆæœ¬ï¼š`v1.22.1`\n- å‡†å¤‡ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Ansible æ§åˆ¶èŠ‚ç‚¹ç”¨äºè¿è¡Œ Kaniï¼Œå¹¶å®‰è£… `ansible`ã€`rhel-system-roles` RPM è½¯ä»¶åŒ…ã€‚ \n- ä½¿ç”¨æ™®é€šç”¨æˆ·å…‹éš†è¯¥é¡¹ç›®ï¼Œç¬”è€…ç¯å¢ƒä¸­ä½¿ç”¨ `godev` ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·ä¸é¡¹ç›®ç›®å½•ä¸­çš„ `vars/all.yml` ä¸­çš„ `operator_user` ä¸ºåŒä¸€ç”¨æˆ·ã€‚\n> ğŸ’¥ ä½¿ç”¨ Kani æ—¶ï¼Œéœ€æ³¨æ„å°†æ‚¨çš„æ™®é€šç”¨æˆ·ä¸ operator_user ä¿æŒä¸€è‡´ï¼\n\n### ğŸ¤˜ éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\n- æ ¹æ®æ‚¨çš„å®é™…ç¯å¢ƒåœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ›´æ”¹å¯¹åº”çš„å‚æ•°ï¼š  \n  - `ansible.cfg` (Ansible config file):    \n    - remote_userï¼šå„ä¸ª Ansible å—ç®¡ä¸»æœºä¸Šçš„ç™»å½•ç”¨æˆ·  \n  - `files/kubeadm-conf.yml` (kubeadm config file):    \n    - localAPIEndpoint.advertiseAddressï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬åœ°å€    \n    - localAPIEndpoint.bindPortï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬ç«¯å£    \n    - nodeRegistration.criSocketï¼šmaster èŠ‚ç‚¹ containerd çš„ Unix å¥—æ¥å­—æ–‡ä»¶    \n    - nodeRegistration.nameï¼šmaster èŠ‚ç‚¹çš„ FQDN    \n    - nodeRegistration.taintsï¼šä¸º master èŠ‚ç‚¹æ·»åŠ ä¸å¯è°ƒåº¦çš„æ±¡ç‚¹    \n    - modeï¼škube-proxy çš„å·¥ä½œæ¨¡å¼    \n    - imageRepositoryï¼šæŒ‡å®šå®¹å™¨é•œåƒçš„ä»“åº“åœ°å€    \n    - KubernetesVersionï¼šé›†ç¾¤çš„å®‰è£…ç‰ˆæœ¬    \n    - `networking.serviceSubnet`ï¼šé›†ç¾¤çš„ Service Cluster IP ç½‘æ®µ    \n    - `networking.podSubnet`ï¼šé›†ç¾¤çš„ Pod IP ç½‘æ®µ    \n    - cgroupDriverï¼šæŒ‡å®šæ§åˆ¶ç»„é©±åŠ¨ç±»å‹    \n    - `clusterDNS`ï¼šé›†ç¾¤çš„ CoreDNS çš„ Service Cluster IP  \n  - `inventory-kubecluster` (Ansible inventory file):    \n    - æ ¹æ®æ‚¨æ‰€åœ¨çš„åœºæ™¯ä¿®æ”¹çŸ­ä¸»æœºåï¼Œæ­¤å¤„ä¸ºç¬”è€…æ‰€åœ¨çš„ç¯å¢ƒèŠ‚ç‚¹ä¿¡æ¯ã€‚  \n  - `vars/all.yml` (variables file):    \n    > ğŸ’¥ æ ¹æ®æ‚¨æ‰€åœ¨çš„ç¯å¢ƒä¿®æ”¹ `!!! NEED TO EDIT !!!` ä¸­çš„å‚æ•°ï¼Œå…¶ä½™å‚æ•°å¯é€‰æ‹©æ€§åœ°ä¿®æ”¹ã€‚    \n    - gatewayï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹çš„çš„é»˜è®¤ç½‘å…³    \n    - nicï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹è¿æ¥é»˜è®¤ç½‘å…³çš„ç½‘å¡æ¥å£    \n    - operator_userï¼šAnsible æ§åˆ¶èŠ‚ç‚¹ä¸å—ç®¡ä¸»æœºä¸Šè¿œç¨‹è¿æ¥çš„æ™®é€šç”¨æˆ·    \n    > ğŸ‘‰ operator_user ä¸ ansible.cfg ä¸­çš„ remote_user ç›¸åŒã€‚    \n    - kube_master_nodeï¼šmaster èŠ‚ç‚¹çš„çŸ­ä¸»æœºå    \n    > ğŸ’¥ è¯¥å‚æ•°ä¸ inventory-kubecluster ä¸­çš„çŸ­ä¸»æœºåç›¸åŒã€‚\n\n### å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\n- Kubernetes éƒ¨ç½²è¿‡ç¨‹ä¸­çš„éƒ¨åˆ†æŠ¥é”™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  `kubeadm init` åˆå§‹åŒ– master èŠ‚ç‚¹å¤±è´¥ï¼Œå¹¶ä¸”æŠ¥é”™ `node not found`ã€‚ç”±äºæ‰€æœ‰çš„ `pause infra images` æœªæ ‡è¯†ï¼ˆtaggedï¼‰`k8s.io/pause:3.5`ï¼Œå› æ­¤åœ¨ master èŠ‚ç‚¹ä¸Šçš„ `kubelet` ä¸èƒ½åˆ›å»º `sandbox`ã€‚  \n  ![kubeadm-init-master-error-1.jpg](kubeadm-init-master-error-1.jpg)![kubeadm-init-master-error-2.jpg](kubeadm-init-master-error-2.jpg)\n- playbook ä¸­çš„ `register` æ³¨å†Œå˜é‡ä¸èƒ½åœ¨ä¸åŒçš„ play é—´å¼•ç”¨ã€‚  \n  ![register-var-used-between-two-plays-error.jpg](register-var-used-between-two-plays-error.jpg)\n- ç”±äºä½¿ç”¨ `containerd` æ¥è¿è¡Œå®¹å™¨ï¼Œå› æ­¤ `ctr`ã€`crictl` ä¸ `nerdctl` å¯è¢«ç”¨æ¥è·å–å®¹å™¨é•œåƒä¸å®¹å™¨è‡ªèº«çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œä»…ä»… `crictl` å¯ç›´æ¥ä½¿ç”¨ containerd é…ç½®æ–‡ä»¶ `/etc/containerd/config.toml`ã€‚crictl å¯åŠ è½½é…ç½®æœ‰ quay registry endpointã€user ä¸ password çš„é…ç½®æ–‡ä»¶ã€‚\n- è‹¥ä½¿ç”¨è‡ªç­¾åçš„ CA è¯ä¹¦ï¼Œcrictl ä¸èƒ½ä» quay å®¹å™¨é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œå¹¶ä¸”æ€»æ˜¯æŠ¥é”™ `x509 cert file error`ï¼š  \n  ![crictl-ssl-ca-request-quay-error.jpg](crictl-ssl-ca-request-quay-error.jpg)\n- é€šè¿‡é…ç½®åœ¨ containerd é…ç½®æ–‡ä»¶ä¸­çš„ `insecure_skip_verify = true` è·³è¿‡ tls éªŒè¯æ‰èƒ½æ‹‰å–é•œåƒã€‚\n\n### ğŸš€ Kani çš„ä½¿ç”¨æ–¹æ³•ï¼š\n- Kani é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  â”Œâ”€[godev][paas-ctl][~/kani]\n  â””â”€â tree .\n  .\n  â”œâ”€â”€ 00-general-prepare-kube.yml\n  â”œâ”€â”€ 01-containerd-kube-deploy.yml\n  â”œâ”€â”€ 02-kube-cluster-calio-deploy.yml\n  â”œâ”€â”€ 03-post-kube-deploy.yml\n  â”œâ”€â”€ ansible.cfg\n  â”œâ”€â”€ destroy-kube-cluster.yml\n  â”œâ”€â”€ files\n  â”‚   â”œâ”€â”€ cni\n  â”‚   â”‚   â””â”€â”€ calico-v3.21.yml\n  â”‚   â”œâ”€â”€ containerd\n  â”‚   â”‚   â”œâ”€â”€ config.toml\n  â”‚   â”‚   â”œâ”€â”€ containerd-rootless-setuptool.sh\n  â”‚   â”‚   â”œâ”€â”€ containerd-rootless.sh\n  â”‚   â”‚   â”œâ”€â”€ cri-containerd-cni-1.5.5-linux-amd64.tar.gz  # è¯¥æ–‡ä»¶å¯ä»ä¸‹æ–‡ç™¾åº¦ç½‘ç›˜ä¸‹è½½\n  â”‚   â”‚   â””â”€â”€ nerdctl\n  â”‚   â”œâ”€â”€ kube-utils\n  â”‚   â”‚   â”œâ”€â”€ k9s_Linux_x86_64.tar.gz\n  â”‚   â”‚   â”œâ”€â”€ kubeadm-conf.yml\n  â”‚   â”‚   â”œâ”€â”€ kube-dashboard-admin.yml\n  â”‚   â”‚   â””â”€â”€ kube-dashboard-v2.3.1.yml\n  â”‚   â”œâ”€â”€ quay\n  â”‚   â”‚   â””â”€â”€ deploy-quay-registry.sh\n  â”‚   â”œâ”€â”€ repos\n  â”‚   â”‚   â”œâ”€â”€ docker-ce.repo\n  â”‚   â”‚   â””â”€â”€ kubernetes.repo\n  â”‚   â”œâ”€â”€ rpms\n  â”‚   â”‚   â”œâ”€â”€ kubeadm-1.22.1-0.x86_64.rpm\n  â”‚   â”‚   â”œâ”€â”€ kubectl-1.22.1-0.x86_64.rpm\n  â”‚   â”‚   â”œâ”€â”€ kubelet-1.22.1-0.x86_64.rpm\n  â”‚   â”‚   â””â”€â”€ kubernetes-cni-0.8.7-0.x86_64.rpm\n  â”‚   â””â”€â”€ vimrc\n  â”œâ”€â”€ inventory-kubecluster\n  â”œâ”€â”€ job-for-terminate-kube.yml\n  â”œâ”€â”€ kani\n  â”œâ”€â”€ kube-reverse\n  â”œâ”€â”€ provision-quay-registry.yml\n  â”œâ”€â”€ templates\n  â”‚   â””â”€â”€ hosts.j2\n  â”œâ”€â”€ terminate-kube-cluster.yml\n  â””â”€â”€ vars\n      â””â”€â”€ all.yml\n  \n  9 directories, 32 files\n  ```\n\n  > 1. ç”±äº GitHub å¯¹äºä¸Šä¼ æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼ˆ100 MiBï¼‰ï¼Œ`files/containerd/cri-containerd-cni-1.5.5-linux-amd64.tar.gz` å¯ä» [ç™¾åº¦ç½‘ç›˜](https://pan.baidu.com/s/1ytxDjSN0u5Tewy5rcEGWNQ) ä¸‹è½½ï¼Œä¸‹è½½å¯†ç ä¸º apdlã€‚\n  > 2. ğŸ’¥ ç”±äºåœ¨ aliyun yum æºä¸­çš„ kubeadmã€kubectlã€kubelet ä¸ kubernetes-cni çš„ rpm è½¯ä»¶åŒ…å¯èƒ½å­˜åœ¨æ— æ³•è·å–çš„æƒ…å†µï¼Œå› æ­¤å·²å°†è½¯ä»¶åŒ…åŒé¡¹ç›®ä¸€èµ·ä¸Šä¼ ï¼\n\n- æ›´æ”¹æ‰€æœ‰æ–‡ä»¶ä¸­çš„å‚æ•°åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤éƒ¨ç½²é›†ç¾¤ï¼š  \n  ```bash\n  $ cd kani\n  $ chmod +x ./kani\n  $ ./kani --help\n  # æŸ¥çœ‹ kani çš„ä½¿ç”¨æ–¹æ³•\n  Rapid deploy kubernetes cluster and elements by ansible\n  \n  Usage:\n    kani [command]\n  \n  Available Commands:\n    deploy-kube     Deploy single master node kubernetes cluster with calico cni\n    terminate-kube  Terminate kubernetes master and worker nodes\n    destroy-kube    Destroy and prepare to re-install kubernetes cluster\n    config-quay     Config and run quay config container\n    deploy-quay     Deploy quay registry\n  \n  $ ./kani deploy-kube\n  # éƒ¨ç½² Kubernetes é›†ç¾¤\n  ```\n\n  > ğŸ¤˜ æ³¨æ„ï¼šåœ¨ kubeadm init åˆå§‹åŒ– master èŠ‚ç‚¹åï¼Œç”±äºè¿˜æœªå°†å…¶ä»– node èŠ‚ç‚¹åŠ å…¥è‡³é›†ç¾¤ä¸­ï¼Œæ­¤æ—¶å„ä¸ª node èŠ‚ç‚¹ä¸Šçš„ `kubelet` å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½å¤„äº `active (auto-restarting)` çŠ¶æ€ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹ /var/log/messages ä¸­å­˜åœ¨å¤§é‡çš„ `/etc/kubernetes/pki/ca.crt not found` çš„æŠ¥é”™ï¼Œè¿™æ˜¯ç”±äº kubeadm join è¿˜æœªå°† node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä»¥åŠè¿˜æœªåŒæ­¥ master èŠ‚ç‚¹çš„ CA è¯ä¹¦æ‰€è‡´ï¼Œå¾… node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­å kubelet çŠ¶æ€å°†æ¢å¤ `active` çŠ¶æ€ã€‚\n\n- Kubernetes é›†ç¾¤éƒ¨ç½²åçš„ node ä¸ pod çŠ¶æ€ï¼š![kubernetes-cluster-status.jpg](kubernetes-cluster-status.jpg)\n  \n  > ğŸ¤˜ æ³¨æ„ï¼šKubernetes é›†ç¾¤ä¸­ `coredns pod` åœ¨ Calico CNI æœªå®Œå…¨ ready æ—¶å°†å¤„äº `pending` çŠ¶æ€ï¼Œç›´è‡³æ‰€æœ‰ calico pod å¤„äº Running çŠ¶æ€æ—¶ä¹Ÿå°†å¤„äº Running çŠ¶æ€ã€‚\n\n- åœæ­¢ Kubernetes é›†ç¾¤ï¼š  \n  ```bash\n  $ ./kani terminate-kube\n  ```\n- ç ´åä¸é‡è£… Kubernetes é›†ç¾¤ï¼š  \n  ```bash\n  $ ./kani destroy-kube\n  ```\n- ï¼ˆå¯é€‰æ“ä½œï¼‰éƒ¨ç½² `Red Hat Quay v3 registry` å¹¶ä¸ Kubernetes é›†ç¾¤é›†æˆï¼š  \n  è‹¥éœ€ä½¿ç”¨ `Red Hat Quay v3 registry` ä½œä¸ºå®¹å™¨é•œåƒä»“åº“ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š  \n  ```bash\n  $ ./kani config-quay\n  # ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ Quay çš„çš„ Web UI é…ç½®ç•Œé¢\n  $ firefox &\n  # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Web UI é…ç½® Quay\n  $ ./kani deploy-quay\n  # ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½² Quay\n  ```\n\n  - å¯é€šè¿‡ [Red Hat Quay v3 registry åŸç†ä¸å®ç°](https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/) æ–‡æ¡£äº†è§£å¦‚ä½•é€šè¿‡ Web UI é…ç½® Quayã€‚\n\n  - é…ç½® Kubernetes é›†ç¾¤è¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼š    \n    - è‹¥åœ¨é›†ç¾¤è§„åˆ’æ—¶éœ€å°† Quay ä¸ Kubernetes é›†ç¾¤è¿æ¥çš„è¯ï¼Œéœ€åœ¨è¿è¡Œ kani å‘½ä»¤å‰æ›´æ”¹å¥½ `files/containerd/config.toml` æ–‡ä»¶ï¼Œä»¥ä¿è¯é›†ç¾¤éƒ¨ç½²å®Œæˆåå¯ä¸ Quay å¯¹æ¥ã€‚      \n      å…¶ä¸­ `username` ä¸ `password` ä¸º Quay ä¸­çš„ç™»å½•ç”¨æˆ·åä¸å¯†ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š      \n      ```ini\n      [plugins.\"io.containerd.grpc.v1.cri\".registry]\n            config_path = \"\"\n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.auths]\n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.configs]\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".tls]\n                insecure_skip_verify = true\n                # ä½¿ç”¨è‡ªç­¾å CA è¯ä¹¦ä¹Ÿéœ€é…ç½®ä¸º true\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".auth]\n                username = \"godev\"\n                password = \"redhat321\"\n                # Quay ä¸­éœ€é…ç½®çš„ç”¨æˆ·åä¸å¯†ç          \n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.headers]\n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n            ### modified by hualf to configure registry mirror\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n                endpoint = [\"https://bqr1dr1n.mirror.aliyuncs.com\"]\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n                endpoint = [\"https://registry.aliyuncs.com/k8sxio\"]\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay-registry.lab.example.com\"]\n                endpoint = [\"https://quay-registry.lab.example.com\"]\n                # å†…éƒ¨ç§æœ‰çš„å®¹å™¨é•œåƒä»“åº“\n              # containerd å®ˆæŠ¤è¿›ç¨‹å¯è®¿é—®çš„å…¬å…±ä¸ç§æœ‰å®¹å™¨é•œåƒä»“åº“ \n      ```\n    - è‹¥åœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²å®Œæˆåå†ä¸ Quay é›†æˆï¼Œéœ€æ›´æ”¹æ¯ä¸ªè¿è¡Œ Containerd èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ï¼Œå†é‡å¯æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ containerd å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰èƒ½ä¿è¯ä¸ Quay çš„å¯¹æ¥ã€‚   \n    - åœ¨ç¬”è€…çš„ç¯å¢ƒä¸­ï¼Œcontainerd é…ç½®æ–‡ä»¶ä¸­å·²é…ç½®äº† `godev` ç”¨æˆ·ä¸ç›¸åº”å¯†ç ç”¨äºè¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼Œå› æ­¤ï¼Œåœ¨ Quay ä¸­éœ€åˆ›å»ºå¯¹åº”çš„ç”¨æˆ·ã€‚\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Kubernetes Docs - ä½¿ç”¨ Kubespray å®‰è£… Kubernetes](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/)\n- [Kubernetes Docs - Bootstrapping clusters with kubeadm](https://v1-22.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/)\n- [Install Calico](https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises)","source":"_posts/kani-deploy-k8s.md","raw":"---\ntitle: Kani - Ansible å¿«é€Ÿéƒ¨ç½²ä¸ç®¡ç† Kubernetes v1.22.1\nsubtitle: Use Kani to Rapidly Deploy Kubernetes Cluster\nheader-img: kani-ansible-k8s.svg\ndate: 2022-11-28 14:01:23\ntags:\n  - Kubernetes\n  - äº‘åŸç”Ÿ\n  - Ansible\n---\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- é¡¹ç›®ç›®çš„\n- å®æ–½ç¯å¢ƒ\n- éœ€è¦æ›´æ”¹çš„å‚æ•°\n- å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•\n- Kani çš„ä½¿ç”¨æ–¹æ³•\n- å‚è€ƒé“¾æ¥\n\n### é¡¹ç›®ç›®çš„ï¼š\n- è™½ç„¶ç›®å‰å…·æœ‰å¤§é‡çš„ Kubernetes é›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­å®˜æ–¹çš„ `KubeSpray` å³ä¸ºä½¿ç”¨ Ansible çš„æ–¹å¼éƒ¨ç½²ï¼Œä½†æƒ³å°è¯•è‡ªå·±æ‰‹åŠ¨é€ è½®å­ï¼Œå› æ­¤åˆ›å»ºäº† Kani é¡¹ç›®ã€‚\n- Kani é¡¹ç›®çš„ç›®çš„åœ¨äºä½¿ç”¨ Ansible å¿«é€Ÿéƒ¨ç½²ä¸ç®¡ç† Kubernetes é›†ç¾¤åŠå…¶ç›¸å…³ç»„ä»¶ã€‚\n- å½“å‰ç‰ˆæœ¬ä¸­ Kani æ”¯æŒï¼š  \n  - `Containerd` runtime  \n  - `Calico` CNI  \n  - `Red Hat Quay v3 registry`\n- Kani çš„å¯é€‰åŠŸèƒ½åŒ…æ‹¬éƒ¨ç½²ä¸ç®¡ç†å…¶ä»–é¢å¤–çš„äº‘åŸç”Ÿã€DevOps ä¸ GitOps ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - å®¹å™¨é•œåƒä»“åº“ï¼šRed Hat Quay v3 registry  \n  - ä»£ç ä»“åº“ï¼šGitLab\n- å¯ç‚¹å‡» [æ­¤å¤„](https://github.com/Alberthua-Perl/kani) è·å– Kani é¡¹ç›® ğŸ‘‹\n\n### å®æ–½ç¯å¢ƒï¼š\n- OS ç‰ˆæœ¬ï¼š`CentOS Linux release 7.9.2009` (Core)\n- kernel ç‰ˆæœ¬ï¼š`5.13.12`\n> å¯ä½¿ç”¨ `elrepo repository` å‡çº§ Linux kernelã€‚\n- Ansible ç‰ˆæœ¬ï¼š`2.9.25`\n- Containerd ç‰ˆæœ¬ï¼š`1.5.5`\n- Kubernetes ç‰ˆæœ¬ï¼š`v1.22.1`\n- å‡†å¤‡ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Ansible æ§åˆ¶èŠ‚ç‚¹ç”¨äºè¿è¡Œ Kaniï¼Œå¹¶å®‰è£… `ansible`ã€`rhel-system-roles` RPM è½¯ä»¶åŒ…ã€‚ \n- ä½¿ç”¨æ™®é€šç”¨æˆ·å…‹éš†è¯¥é¡¹ç›®ï¼Œç¬”è€…ç¯å¢ƒä¸­ä½¿ç”¨ `godev` ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·ä¸é¡¹ç›®ç›®å½•ä¸­çš„ `vars/all.yml` ä¸­çš„ `operator_user` ä¸ºåŒä¸€ç”¨æˆ·ã€‚\n> ğŸ’¥ ä½¿ç”¨ Kani æ—¶ï¼Œéœ€æ³¨æ„å°†æ‚¨çš„æ™®é€šç”¨æˆ·ä¸ operator_user ä¿æŒä¸€è‡´ï¼\n\n### ğŸ¤˜ éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\n- æ ¹æ®æ‚¨çš„å®é™…ç¯å¢ƒåœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ›´æ”¹å¯¹åº”çš„å‚æ•°ï¼š  \n  - `ansible.cfg` (Ansible config file):    \n    - remote_userï¼šå„ä¸ª Ansible å—ç®¡ä¸»æœºä¸Šçš„ç™»å½•ç”¨æˆ·  \n  - `files/kubeadm-conf.yml` (kubeadm config file):    \n    - localAPIEndpoint.advertiseAddressï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬åœ°å€    \n    - localAPIEndpoint.bindPortï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬ç«¯å£    \n    - nodeRegistration.criSocketï¼šmaster èŠ‚ç‚¹ containerd çš„ Unix å¥—æ¥å­—æ–‡ä»¶    \n    - nodeRegistration.nameï¼šmaster èŠ‚ç‚¹çš„ FQDN    \n    - nodeRegistration.taintsï¼šä¸º master èŠ‚ç‚¹æ·»åŠ ä¸å¯è°ƒåº¦çš„æ±¡ç‚¹    \n    - modeï¼škube-proxy çš„å·¥ä½œæ¨¡å¼    \n    - imageRepositoryï¼šæŒ‡å®šå®¹å™¨é•œåƒçš„ä»“åº“åœ°å€    \n    - KubernetesVersionï¼šé›†ç¾¤çš„å®‰è£…ç‰ˆæœ¬    \n    - `networking.serviceSubnet`ï¼šé›†ç¾¤çš„ Service Cluster IP ç½‘æ®µ    \n    - `networking.podSubnet`ï¼šé›†ç¾¤çš„ Pod IP ç½‘æ®µ    \n    - cgroupDriverï¼šæŒ‡å®šæ§åˆ¶ç»„é©±åŠ¨ç±»å‹    \n    - `clusterDNS`ï¼šé›†ç¾¤çš„ CoreDNS çš„ Service Cluster IP  \n  - `inventory-kubecluster` (Ansible inventory file):    \n    - æ ¹æ®æ‚¨æ‰€åœ¨çš„åœºæ™¯ä¿®æ”¹çŸ­ä¸»æœºåï¼Œæ­¤å¤„ä¸ºç¬”è€…æ‰€åœ¨çš„ç¯å¢ƒèŠ‚ç‚¹ä¿¡æ¯ã€‚  \n  - `vars/all.yml` (variables file):    \n    > ğŸ’¥ æ ¹æ®æ‚¨æ‰€åœ¨çš„ç¯å¢ƒä¿®æ”¹ `!!! NEED TO EDIT !!!` ä¸­çš„å‚æ•°ï¼Œå…¶ä½™å‚æ•°å¯é€‰æ‹©æ€§åœ°ä¿®æ”¹ã€‚    \n    - gatewayï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹çš„çš„é»˜è®¤ç½‘å…³    \n    - nicï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹è¿æ¥é»˜è®¤ç½‘å…³çš„ç½‘å¡æ¥å£    \n    - operator_userï¼šAnsible æ§åˆ¶èŠ‚ç‚¹ä¸å—ç®¡ä¸»æœºä¸Šè¿œç¨‹è¿æ¥çš„æ™®é€šç”¨æˆ·    \n    > ğŸ‘‰ operator_user ä¸ ansible.cfg ä¸­çš„ remote_user ç›¸åŒã€‚    \n    - kube_master_nodeï¼šmaster èŠ‚ç‚¹çš„çŸ­ä¸»æœºå    \n    > ğŸ’¥ è¯¥å‚æ•°ä¸ inventory-kubecluster ä¸­çš„çŸ­ä¸»æœºåç›¸åŒã€‚\n\n### å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\n- Kubernetes éƒ¨ç½²è¿‡ç¨‹ä¸­çš„éƒ¨åˆ†æŠ¥é”™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  `kubeadm init` åˆå§‹åŒ– master èŠ‚ç‚¹å¤±è´¥ï¼Œå¹¶ä¸”æŠ¥é”™ `node not found`ã€‚ç”±äºæ‰€æœ‰çš„ `pause infra images` æœªæ ‡è¯†ï¼ˆtaggedï¼‰`k8s.io/pause:3.5`ï¼Œå› æ­¤åœ¨ master èŠ‚ç‚¹ä¸Šçš„ `kubelet` ä¸èƒ½åˆ›å»º `sandbox`ã€‚  \n  ![kubeadm-init-master-error-1.jpg](kubeadm-init-master-error-1.jpg)![kubeadm-init-master-error-2.jpg](kubeadm-init-master-error-2.jpg)\n- playbook ä¸­çš„ `register` æ³¨å†Œå˜é‡ä¸èƒ½åœ¨ä¸åŒçš„ play é—´å¼•ç”¨ã€‚  \n  ![register-var-used-between-two-plays-error.jpg](register-var-used-between-two-plays-error.jpg)\n- ç”±äºä½¿ç”¨ `containerd` æ¥è¿è¡Œå®¹å™¨ï¼Œå› æ­¤ `ctr`ã€`crictl` ä¸ `nerdctl` å¯è¢«ç”¨æ¥è·å–å®¹å™¨é•œåƒä¸å®¹å™¨è‡ªèº«çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œä»…ä»… `crictl` å¯ç›´æ¥ä½¿ç”¨ containerd é…ç½®æ–‡ä»¶ `/etc/containerd/config.toml`ã€‚crictl å¯åŠ è½½é…ç½®æœ‰ quay registry endpointã€user ä¸ password çš„é…ç½®æ–‡ä»¶ã€‚\n- è‹¥ä½¿ç”¨è‡ªç­¾åçš„ CA è¯ä¹¦ï¼Œcrictl ä¸èƒ½ä» quay å®¹å™¨é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œå¹¶ä¸”æ€»æ˜¯æŠ¥é”™ `x509 cert file error`ï¼š  \n  ![crictl-ssl-ca-request-quay-error.jpg](crictl-ssl-ca-request-quay-error.jpg)\n- é€šè¿‡é…ç½®åœ¨ containerd é…ç½®æ–‡ä»¶ä¸­çš„ `insecure_skip_verify = true` è·³è¿‡ tls éªŒè¯æ‰èƒ½æ‹‰å–é•œåƒã€‚\n\n### ğŸš€ Kani çš„ä½¿ç”¨æ–¹æ³•ï¼š\n- Kani é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  â”Œâ”€[godev][paas-ctl][~/kani]\n  â””â”€â tree .\n  .\n  â”œâ”€â”€ 00-general-prepare-kube.yml\n  â”œâ”€â”€ 01-containerd-kube-deploy.yml\n  â”œâ”€â”€ 02-kube-cluster-calio-deploy.yml\n  â”œâ”€â”€ 03-post-kube-deploy.yml\n  â”œâ”€â”€ ansible.cfg\n  â”œâ”€â”€ destroy-kube-cluster.yml\n  â”œâ”€â”€ files\n  â”‚   â”œâ”€â”€ cni\n  â”‚   â”‚   â””â”€â”€ calico-v3.21.yml\n  â”‚   â”œâ”€â”€ containerd\n  â”‚   â”‚   â”œâ”€â”€ config.toml\n  â”‚   â”‚   â”œâ”€â”€ containerd-rootless-setuptool.sh\n  â”‚   â”‚   â”œâ”€â”€ containerd-rootless.sh\n  â”‚   â”‚   â”œâ”€â”€ cri-containerd-cni-1.5.5-linux-amd64.tar.gz  # è¯¥æ–‡ä»¶å¯ä»ä¸‹æ–‡ç™¾åº¦ç½‘ç›˜ä¸‹è½½\n  â”‚   â”‚   â””â”€â”€ nerdctl\n  â”‚   â”œâ”€â”€ kube-utils\n  â”‚   â”‚   â”œâ”€â”€ k9s_Linux_x86_64.tar.gz\n  â”‚   â”‚   â”œâ”€â”€ kubeadm-conf.yml\n  â”‚   â”‚   â”œâ”€â”€ kube-dashboard-admin.yml\n  â”‚   â”‚   â””â”€â”€ kube-dashboard-v2.3.1.yml\n  â”‚   â”œâ”€â”€ quay\n  â”‚   â”‚   â””â”€â”€ deploy-quay-registry.sh\n  â”‚   â”œâ”€â”€ repos\n  â”‚   â”‚   â”œâ”€â”€ docker-ce.repo\n  â”‚   â”‚   â””â”€â”€ kubernetes.repo\n  â”‚   â”œâ”€â”€ rpms\n  â”‚   â”‚   â”œâ”€â”€ kubeadm-1.22.1-0.x86_64.rpm\n  â”‚   â”‚   â”œâ”€â”€ kubectl-1.22.1-0.x86_64.rpm\n  â”‚   â”‚   â”œâ”€â”€ kubelet-1.22.1-0.x86_64.rpm\n  â”‚   â”‚   â””â”€â”€ kubernetes-cni-0.8.7-0.x86_64.rpm\n  â”‚   â””â”€â”€ vimrc\n  â”œâ”€â”€ inventory-kubecluster\n  â”œâ”€â”€ job-for-terminate-kube.yml\n  â”œâ”€â”€ kani\n  â”œâ”€â”€ kube-reverse\n  â”œâ”€â”€ provision-quay-registry.yml\n  â”œâ”€â”€ templates\n  â”‚   â””â”€â”€ hosts.j2\n  â”œâ”€â”€ terminate-kube-cluster.yml\n  â””â”€â”€ vars\n      â””â”€â”€ all.yml\n  \n  9 directories, 32 files\n  ```\n\n  > 1. ç”±äº GitHub å¯¹äºä¸Šä¼ æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼ˆ100 MiBï¼‰ï¼Œ`files/containerd/cri-containerd-cni-1.5.5-linux-amd64.tar.gz` å¯ä» [ç™¾åº¦ç½‘ç›˜](https://pan.baidu.com/s/1ytxDjSN0u5Tewy5rcEGWNQ) ä¸‹è½½ï¼Œä¸‹è½½å¯†ç ä¸º apdlã€‚\n  > 2. ğŸ’¥ ç”±äºåœ¨ aliyun yum æºä¸­çš„ kubeadmã€kubectlã€kubelet ä¸ kubernetes-cni çš„ rpm è½¯ä»¶åŒ…å¯èƒ½å­˜åœ¨æ— æ³•è·å–çš„æƒ…å†µï¼Œå› æ­¤å·²å°†è½¯ä»¶åŒ…åŒé¡¹ç›®ä¸€èµ·ä¸Šä¼ ï¼\n\n- æ›´æ”¹æ‰€æœ‰æ–‡ä»¶ä¸­çš„å‚æ•°åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤éƒ¨ç½²é›†ç¾¤ï¼š  \n  ```bash\n  $ cd kani\n  $ chmod +x ./kani\n  $ ./kani --help\n  # æŸ¥çœ‹ kani çš„ä½¿ç”¨æ–¹æ³•\n  Rapid deploy kubernetes cluster and elements by ansible\n  \n  Usage:\n    kani [command]\n  \n  Available Commands:\n    deploy-kube     Deploy single master node kubernetes cluster with calico cni\n    terminate-kube  Terminate kubernetes master and worker nodes\n    destroy-kube    Destroy and prepare to re-install kubernetes cluster\n    config-quay     Config and run quay config container\n    deploy-quay     Deploy quay registry\n  \n  $ ./kani deploy-kube\n  # éƒ¨ç½² Kubernetes é›†ç¾¤\n  ```\n\n  > ğŸ¤˜ æ³¨æ„ï¼šåœ¨ kubeadm init åˆå§‹åŒ– master èŠ‚ç‚¹åï¼Œç”±äºè¿˜æœªå°†å…¶ä»– node èŠ‚ç‚¹åŠ å…¥è‡³é›†ç¾¤ä¸­ï¼Œæ­¤æ—¶å„ä¸ª node èŠ‚ç‚¹ä¸Šçš„ `kubelet` å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½å¤„äº `active (auto-restarting)` çŠ¶æ€ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹ /var/log/messages ä¸­å­˜åœ¨å¤§é‡çš„ `/etc/kubernetes/pki/ca.crt not found` çš„æŠ¥é”™ï¼Œè¿™æ˜¯ç”±äº kubeadm join è¿˜æœªå°† node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä»¥åŠè¿˜æœªåŒæ­¥ master èŠ‚ç‚¹çš„ CA è¯ä¹¦æ‰€è‡´ï¼Œå¾… node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­å kubelet çŠ¶æ€å°†æ¢å¤ `active` çŠ¶æ€ã€‚\n\n- Kubernetes é›†ç¾¤éƒ¨ç½²åçš„ node ä¸ pod çŠ¶æ€ï¼š![kubernetes-cluster-status.jpg](kubernetes-cluster-status.jpg)\n  \n  > ğŸ¤˜ æ³¨æ„ï¼šKubernetes é›†ç¾¤ä¸­ `coredns pod` åœ¨ Calico CNI æœªå®Œå…¨ ready æ—¶å°†å¤„äº `pending` çŠ¶æ€ï¼Œç›´è‡³æ‰€æœ‰ calico pod å¤„äº Running çŠ¶æ€æ—¶ä¹Ÿå°†å¤„äº Running çŠ¶æ€ã€‚\n\n- åœæ­¢ Kubernetes é›†ç¾¤ï¼š  \n  ```bash\n  $ ./kani terminate-kube\n  ```\n- ç ´åä¸é‡è£… Kubernetes é›†ç¾¤ï¼š  \n  ```bash\n  $ ./kani destroy-kube\n  ```\n- ï¼ˆå¯é€‰æ“ä½œï¼‰éƒ¨ç½² `Red Hat Quay v3 registry` å¹¶ä¸ Kubernetes é›†ç¾¤é›†æˆï¼š  \n  è‹¥éœ€ä½¿ç”¨ `Red Hat Quay v3 registry` ä½œä¸ºå®¹å™¨é•œåƒä»“åº“ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š  \n  ```bash\n  $ ./kani config-quay\n  # ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ Quay çš„çš„ Web UI é…ç½®ç•Œé¢\n  $ firefox &\n  # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Web UI é…ç½® Quay\n  $ ./kani deploy-quay\n  # ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½² Quay\n  ```\n\n  - å¯é€šè¿‡ [Red Hat Quay v3 registry åŸç†ä¸å®ç°](https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/) æ–‡æ¡£äº†è§£å¦‚ä½•é€šè¿‡ Web UI é…ç½® Quayã€‚\n\n  - é…ç½® Kubernetes é›†ç¾¤è¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼š    \n    - è‹¥åœ¨é›†ç¾¤è§„åˆ’æ—¶éœ€å°† Quay ä¸ Kubernetes é›†ç¾¤è¿æ¥çš„è¯ï¼Œéœ€åœ¨è¿è¡Œ kani å‘½ä»¤å‰æ›´æ”¹å¥½ `files/containerd/config.toml` æ–‡ä»¶ï¼Œä»¥ä¿è¯é›†ç¾¤éƒ¨ç½²å®Œæˆåå¯ä¸ Quay å¯¹æ¥ã€‚      \n      å…¶ä¸­ `username` ä¸ `password` ä¸º Quay ä¸­çš„ç™»å½•ç”¨æˆ·åä¸å¯†ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š      \n      ```ini\n      [plugins.\"io.containerd.grpc.v1.cri\".registry]\n            config_path = \"\"\n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.auths]\n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.configs]\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".tls]\n                insecure_skip_verify = true\n                # ä½¿ç”¨è‡ªç­¾å CA è¯ä¹¦ä¹Ÿéœ€é…ç½®ä¸º true\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".auth]\n                username = \"godev\"\n                password = \"redhat321\"\n                # Quay ä¸­éœ€é…ç½®çš„ç”¨æˆ·åä¸å¯†ç          \n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.headers]\n      \n            [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]\n            ### modified by hualf to configure registry mirror\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]\n                endpoint = [\"https://bqr1dr1n.mirror.aliyuncs.com\"]\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]\n                endpoint = [\"https://registry.aliyuncs.com/k8sxio\"]\n              [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay-registry.lab.example.com\"]\n                endpoint = [\"https://quay-registry.lab.example.com\"]\n                # å†…éƒ¨ç§æœ‰çš„å®¹å™¨é•œåƒä»“åº“\n              # containerd å®ˆæŠ¤è¿›ç¨‹å¯è®¿é—®çš„å…¬å…±ä¸ç§æœ‰å®¹å™¨é•œåƒä»“åº“ \n      ```\n    - è‹¥åœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²å®Œæˆåå†ä¸ Quay é›†æˆï¼Œéœ€æ›´æ”¹æ¯ä¸ªè¿è¡Œ Containerd èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ï¼Œå†é‡å¯æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ containerd å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰èƒ½ä¿è¯ä¸ Quay çš„å¯¹æ¥ã€‚   \n    - åœ¨ç¬”è€…çš„ç¯å¢ƒä¸­ï¼Œcontainerd é…ç½®æ–‡ä»¶ä¸­å·²é…ç½®äº† `godev` ç”¨æˆ·ä¸ç›¸åº”å¯†ç ç”¨äºè¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼Œå› æ­¤ï¼Œåœ¨ Quay ä¸­éœ€åˆ›å»ºå¯¹åº”çš„ç”¨æˆ·ã€‚\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Kubernetes Docs - ä½¿ç”¨ Kubespray å®‰è£… Kubernetes](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/)\n- [Kubernetes Docs - Bootstrapping clusters with kubeadm](https://v1-22.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/)\n- [Install Calico](https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises)","slug":"kani-deploy-k8s","published":1,"updated":"2022-12-06T02:50:48.521Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonola000d16vdd44th76p","content":"<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>é¡¹ç›®ç›®çš„</li>\n<li>å®æ–½ç¯å¢ƒ</li>\n<li>éœ€è¦æ›´æ”¹çš„å‚æ•°</li>\n<li>å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•</li>\n<li>Kani çš„ä½¿ç”¨æ–¹æ³•</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"é¡¹ç›®ç›®çš„ï¼š\"><a href=\"#é¡¹ç›®ç›®çš„ï¼š\" class=\"headerlink\" title=\"é¡¹ç›®ç›®çš„ï¼š\"></a>é¡¹ç›®ç›®çš„ï¼š</h3><ul>\n<li>è™½ç„¶ç›®å‰å…·æœ‰å¤§é‡çš„ Kubernetes é›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­å®˜æ–¹çš„ <code>KubeSpray</code> å³ä¸ºä½¿ç”¨ Ansible çš„æ–¹å¼éƒ¨ç½²ï¼Œä½†æƒ³å°è¯•è‡ªå·±æ‰‹åŠ¨é€ è½®å­ï¼Œå› æ­¤åˆ›å»ºäº† Kani é¡¹ç›®ã€‚</li>\n<li>Kani é¡¹ç›®çš„ç›®çš„åœ¨äºä½¿ç”¨ Ansible å¿«é€Ÿéƒ¨ç½²ä¸ç®¡ç† Kubernetes é›†ç¾¤åŠå…¶ç›¸å…³ç»„ä»¶ã€‚</li>\n<li>å½“å‰ç‰ˆæœ¬ä¸­ Kani æ”¯æŒï¼š  <ul>\n<li><code>Containerd</code> runtime  </li>\n<li><code>Calico</code> CNI  </li>\n<li><code>Red Hat Quay v3 registry</code></li>\n</ul>\n</li>\n<li>Kani çš„å¯é€‰åŠŸèƒ½åŒ…æ‹¬éƒ¨ç½²ä¸ç®¡ç†å…¶ä»–é¢å¤–çš„äº‘åŸç”Ÿã€DevOps ä¸ GitOps ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <ul>\n<li>å®¹å™¨é•œåƒä»“åº“ï¼šRed Hat Quay v3 registry  </li>\n<li>ä»£ç ä»“åº“ï¼šGitLab</li>\n</ul>\n</li>\n<li>å¯ç‚¹å‡» <a href=\"https://github.com/Alberthua-Perl/kani\" target=\"_blank\" rel=\"noopener\">æ­¤å¤„</a> è·å– Kani é¡¹ç›® ğŸ‘‹</li>\n</ul>\n<h3 id=\"å®æ–½ç¯å¢ƒï¼š\"><a href=\"#å®æ–½ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"å®æ–½ç¯å¢ƒï¼š\"></a>å®æ–½ç¯å¢ƒï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼š<code>CentOS Linux release 7.9.2009</code> (Core)</li>\n<li>kernel ç‰ˆæœ¬ï¼š<code>5.13.12</code><blockquote>\n<p>å¯ä½¿ç”¨ <code>elrepo repository</code> å‡çº§ Linux kernelã€‚</p>\n</blockquote>\n</li>\n<li>Ansible ç‰ˆæœ¬ï¼š<code>2.9.25</code></li>\n<li>Containerd ç‰ˆæœ¬ï¼š<code>1.5.5</code></li>\n<li>Kubernetes ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n<li>å‡†å¤‡ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Ansible æ§åˆ¶èŠ‚ç‚¹ç”¨äºè¿è¡Œ Kaniï¼Œå¹¶å®‰è£… <code>ansible</code>ã€<code>rhel-system-roles</code> RPM è½¯ä»¶åŒ…ã€‚ </li>\n<li>ä½¿ç”¨æ™®é€šç”¨æˆ·å…‹éš†è¯¥é¡¹ç›®ï¼Œç¬”è€…ç¯å¢ƒä¸­ä½¿ç”¨ <code>godev</code> ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·ä¸é¡¹ç›®ç›®å½•ä¸­çš„ <code>vars/all.yml</code> ä¸­çš„ <code>operator_user</code> ä¸ºåŒä¸€ç”¨æˆ·ã€‚<blockquote>\n<p>ğŸ’¥ ä½¿ç”¨ Kani æ—¶ï¼Œéœ€æ³¨æ„å°†æ‚¨çš„æ™®é€šç”¨æˆ·ä¸ operator_user ä¿æŒä¸€è‡´ï¼</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"ğŸ¤˜-éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\"><a href=\"#ğŸ¤˜-éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\" class=\"headerlink\" title=\"ğŸ¤˜ éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\"></a>ğŸ¤˜ éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š</h3><ul>\n<li>æ ¹æ®æ‚¨çš„å®é™…ç¯å¢ƒåœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ›´æ”¹å¯¹åº”çš„å‚æ•°ï¼š  <ul>\n<li><code>ansible.cfg</code> (Ansible config file):    <ul>\n<li>remote_userï¼šå„ä¸ª Ansible å—ç®¡ä¸»æœºä¸Šçš„ç™»å½•ç”¨æˆ·  </li>\n</ul>\n</li>\n<li><code>files/kubeadm-conf.yml</code> (kubeadm config file):    <ul>\n<li>localAPIEndpoint.advertiseAddressï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬åœ°å€    </li>\n<li>localAPIEndpoint.bindPortï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬ç«¯å£    </li>\n<li>nodeRegistration.criSocketï¼šmaster èŠ‚ç‚¹ containerd çš„ Unix å¥—æ¥å­—æ–‡ä»¶    </li>\n<li>nodeRegistration.nameï¼šmaster èŠ‚ç‚¹çš„ FQDN    </li>\n<li>nodeRegistration.taintsï¼šä¸º master èŠ‚ç‚¹æ·»åŠ ä¸å¯è°ƒåº¦çš„æ±¡ç‚¹    </li>\n<li>modeï¼škube-proxy çš„å·¥ä½œæ¨¡å¼    </li>\n<li>imageRepositoryï¼šæŒ‡å®šå®¹å™¨é•œåƒçš„ä»“åº“åœ°å€    </li>\n<li>KubernetesVersionï¼šé›†ç¾¤çš„å®‰è£…ç‰ˆæœ¬    </li>\n<li><code>networking.serviceSubnet</code>ï¼šé›†ç¾¤çš„ Service Cluster IP ç½‘æ®µ    </li>\n<li><code>networking.podSubnet</code>ï¼šé›†ç¾¤çš„ Pod IP ç½‘æ®µ    </li>\n<li>cgroupDriverï¼šæŒ‡å®šæ§åˆ¶ç»„é©±åŠ¨ç±»å‹    </li>\n<li><code>clusterDNS</code>ï¼šé›†ç¾¤çš„ CoreDNS çš„ Service Cluster IP  </li>\n</ul>\n</li>\n<li><code>inventory-kubecluster</code> (Ansible inventory file):    <ul>\n<li>æ ¹æ®æ‚¨æ‰€åœ¨çš„åœºæ™¯ä¿®æ”¹çŸ­ä¸»æœºåï¼Œæ­¤å¤„ä¸ºç¬”è€…æ‰€åœ¨çš„ç¯å¢ƒèŠ‚ç‚¹ä¿¡æ¯ã€‚  </li>\n</ul>\n</li>\n<li><code>vars/all.yml</code> (variables file):    <blockquote>\n<p>ğŸ’¥ æ ¹æ®æ‚¨æ‰€åœ¨çš„ç¯å¢ƒä¿®æ”¹ <code>!!! NEED TO EDIT !!!</code> ä¸­çš„å‚æ•°ï¼Œå…¶ä½™å‚æ•°å¯é€‰æ‹©æ€§åœ°ä¿®æ”¹ã€‚    </p>\n<ul>\n<li>gatewayï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹çš„çš„é»˜è®¤ç½‘å…³    </li>\n<li>nicï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹è¿æ¥é»˜è®¤ç½‘å…³çš„ç½‘å¡æ¥å£    </li>\n<li>operator_userï¼šAnsible æ§åˆ¶èŠ‚ç‚¹ä¸å—ç®¡ä¸»æœºä¸Šè¿œç¨‹è¿æ¥çš„æ™®é€šç”¨æˆ·<br>ğŸ‘‰ operator_user ä¸ ansible.cfg ä¸­çš„ remote_user ç›¸åŒã€‚    </li>\n<li>kube_master_nodeï¼šmaster èŠ‚ç‚¹çš„çŸ­ä¸»æœºå<br>ğŸ’¥ è¯¥å‚æ•°ä¸ inventory-kubecluster ä¸­çš„çŸ­ä¸»æœºåç›¸åŒã€‚</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\"><a href=\"#å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\" class=\"headerlink\" title=\"å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\"></a>å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š</h3><ul>\n<li>Kubernetes éƒ¨ç½²è¿‡ç¨‹ä¸­çš„éƒ¨åˆ†æŠ¥é”™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><code>kubeadm init</code> åˆå§‹åŒ– master èŠ‚ç‚¹å¤±è´¥ï¼Œå¹¶ä¸”æŠ¥é”™ <code>node not found</code>ã€‚ç”±äºæ‰€æœ‰çš„ <code>pause infra images</code> æœªæ ‡è¯†ï¼ˆtaggedï¼‰<code>k8s.io/pause:3.5</code>ï¼Œå› æ­¤åœ¨ master èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> ä¸èƒ½åˆ›å»º <code>sandbox</code>ã€‚<br><img src=\"kubeadm-init-master-error-1.jpg\" alt=\"kubeadm-init-master-error-1.jpg\"><img src=\"kubeadm-init-master-error-2.jpg\" alt=\"kubeadm-init-master-error-2.jpg\"></li>\n<li>playbook ä¸­çš„ <code>register</code> æ³¨å†Œå˜é‡ä¸èƒ½åœ¨ä¸åŒçš„ play é—´å¼•ç”¨ã€‚<br><img src=\"register-var-used-between-two-plays-error.jpg\" alt=\"register-var-used-between-two-plays-error.jpg\"></li>\n<li>ç”±äºä½¿ç”¨ <code>containerd</code> æ¥è¿è¡Œå®¹å™¨ï¼Œå› æ­¤ <code>ctr</code>ã€<code>crictl</code> ä¸ <code>nerdctl</code> å¯è¢«ç”¨æ¥è·å–å®¹å™¨é•œåƒä¸å®¹å™¨è‡ªèº«çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œä»…ä»… <code>crictl</code> å¯ç›´æ¥ä½¿ç”¨ containerd é…ç½®æ–‡ä»¶ <code>/etc/containerd/config.toml</code>ã€‚crictl å¯åŠ è½½é…ç½®æœ‰ quay registry endpointã€user ä¸ password çš„é…ç½®æ–‡ä»¶ã€‚</li>\n<li>è‹¥ä½¿ç”¨è‡ªç­¾åçš„ CA è¯ä¹¦ï¼Œcrictl ä¸èƒ½ä» quay å®¹å™¨é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œå¹¶ä¸”æ€»æ˜¯æŠ¥é”™ <code>x509 cert file error</code>ï¼š<br><img src=\"crictl-ssl-ca-request-quay-error.jpg\" alt=\"crictl-ssl-ca-request-quay-error.jpg\"></li>\n<li>é€šè¿‡é…ç½®åœ¨ containerd é…ç½®æ–‡ä»¶ä¸­çš„ <code>insecure_skip_verify = true</code> è·³è¿‡ tls éªŒè¯æ‰èƒ½æ‹‰å–é•œåƒã€‚</li>\n</ul>\n<h3 id=\"ğŸš€-Kani-çš„ä½¿ç”¨æ–¹æ³•ï¼š\"><a href=\"#ğŸš€-Kani-çš„ä½¿ç”¨æ–¹æ³•ï¼š\" class=\"headerlink\" title=\"ğŸš€ Kani çš„ä½¿ç”¨æ–¹æ³•ï¼š\"></a>ğŸš€ Kani çš„ä½¿ç”¨æ–¹æ³•ï¼š</h3><ul>\n<li><p>Kani é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â”Œâ”€[godev][paas-ctl][~/kani]</span><br><span class=\"line\">â””â”€â tree .</span><br><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ 00-general-prepare-kube.yml</span><br><span class=\"line\">â”œâ”€â”€ 01-containerd-kube-deploy.yml</span><br><span class=\"line\">â”œâ”€â”€ 02-kube-cluster-calio-deploy.yml</span><br><span class=\"line\">â”œâ”€â”€ 03-post-kube-deploy.yml</span><br><span class=\"line\">â”œâ”€â”€ ansible.cfg</span><br><span class=\"line\">â”œâ”€â”€ destroy-kube-cluster.yml</span><br><span class=\"line\">â”œâ”€â”€ files</span><br><span class=\"line\">â”‚   â”œâ”€â”€ cni</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ calico-v3.21.yml</span><br><span class=\"line\">â”‚   â”œâ”€â”€ containerd</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ config.toml</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ containerd-rootless-setuptool.sh</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ containerd-rootless.sh</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ cri-containerd-cni-1.5.5-linux-amd64.tar.gz  <span class=\"comment\"># è¯¥æ–‡ä»¶å¯ä»ä¸‹æ–‡ç™¾åº¦ç½‘ç›˜ä¸‹è½½</span></span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ nerdctl</span><br><span class=\"line\">â”‚   â”œâ”€â”€ kube-utils</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ k9s_Linux_x86_64.tar.gz</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubeadm-conf.yml</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kube-dashboard-admin.yml</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ kube-dashboard-v2.3.1.yml</span><br><span class=\"line\">â”‚   â”œâ”€â”€ quay</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ deploy-quay-registry.sh</span><br><span class=\"line\">â”‚   â”œâ”€â”€ repos</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ docker-ce.repo</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ kubernetes.repo</span><br><span class=\"line\">â”‚   â”œâ”€â”€ rpms</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubeadm-1.22.1-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubectl-1.22.1-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubelet-1.22.1-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ kubernetes-cni-0.8.7-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â””â”€â”€ vimrc</span><br><span class=\"line\">â”œâ”€â”€ inventory-kubecluster</span><br><span class=\"line\">â”œâ”€â”€ job-for-terminate-kube.yml</span><br><span class=\"line\">â”œâ”€â”€ kani</span><br><span class=\"line\">â”œâ”€â”€ kube-reverse</span><br><span class=\"line\">â”œâ”€â”€ provision-quay-registry.yml</span><br><span class=\"line\">â”œâ”€â”€ templates</span><br><span class=\"line\">â”‚   â””â”€â”€ hosts.j2</span><br><span class=\"line\">â”œâ”€â”€ terminate-kube-cluster.yml</span><br><span class=\"line\">â””â”€â”€ vars</span><br><span class=\"line\">    â””â”€â”€ all.yml</span><br><span class=\"line\"></span><br><span class=\"line\">9 directories, 32 files</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol>\n<li>ç”±äº GitHub å¯¹äºä¸Šä¼ æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼ˆ100 MiBï¼‰ï¼Œ<code>files/containerd/cri-containerd-cni-1.5.5-linux-amd64.tar.gz</code> å¯ä» <a href=\"https://pan.baidu.com/s/1ytxDjSN0u5Tewy5rcEGWNQ\" target=\"_blank\" rel=\"noopener\">ç™¾åº¦ç½‘ç›˜</a> ä¸‹è½½ï¼Œä¸‹è½½å¯†ç ä¸º apdlã€‚</li>\n<li>ğŸ’¥ ç”±äºåœ¨ aliyun yum æºä¸­çš„ kubeadmã€kubectlã€kubelet ä¸ kubernetes-cni çš„ rpm è½¯ä»¶åŒ…å¯èƒ½å­˜åœ¨æ— æ³•è·å–çš„æƒ…å†µï¼Œå› æ­¤å·²å°†è½¯ä»¶åŒ…åŒé¡¹ç›®ä¸€èµ·ä¸Šä¼ ï¼</li>\n</ol>\n</blockquote>\n</li>\n<li><p>æ›´æ”¹æ‰€æœ‰æ–‡ä»¶ä¸­çš„å‚æ•°åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤éƒ¨ç½²é›†ç¾¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> kani</span><br><span class=\"line\">$ chmod +x ./kani</span><br><span class=\"line\">$ ./kani --<span class=\"built_in\">help</span></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ kani çš„ä½¿ç”¨æ–¹æ³•</span></span><br><span class=\"line\">Rapid deploy kubernetes cluster and elements by ansible</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">  kani [<span class=\"built_in\">command</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">Available Commands:</span><br><span class=\"line\">  deploy-kube     Deploy single master node kubernetes cluster with calico cni</span><br><span class=\"line\">  terminate-kube  Terminate kubernetes master and worker nodes</span><br><span class=\"line\">  destroy-kube    Destroy and prepare to re-install kubernetes cluster</span><br><span class=\"line\">  config-quay     Config and run quay config container</span><br><span class=\"line\">  deploy-quay     Deploy quay registry</span><br><span class=\"line\"></span><br><span class=\"line\">$ ./kani deploy-kube</span><br><span class=\"line\"><span class=\"comment\"># éƒ¨ç½² Kubernetes é›†ç¾¤</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ğŸ¤˜ æ³¨æ„ï¼šåœ¨ kubeadm init åˆå§‹åŒ– master èŠ‚ç‚¹åï¼Œç”±äºè¿˜æœªå°†å…¶ä»– node èŠ‚ç‚¹åŠ å…¥è‡³é›†ç¾¤ä¸­ï¼Œæ­¤æ—¶å„ä¸ª node èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½å¤„äº <code>active (auto-restarting)</code> çŠ¶æ€ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹ /var/log/messages ä¸­å­˜åœ¨å¤§é‡çš„ <code>/etc/kubernetes/pki/ca.crt not found</code> çš„æŠ¥é”™ï¼Œè¿™æ˜¯ç”±äº kubeadm join è¿˜æœªå°† node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä»¥åŠè¿˜æœªåŒæ­¥ master èŠ‚ç‚¹çš„ CA è¯ä¹¦æ‰€è‡´ï¼Œå¾… node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­å kubelet çŠ¶æ€å°†æ¢å¤ <code>active</code> çŠ¶æ€ã€‚</p>\n</blockquote>\n</li>\n<li><p>Kubernetes é›†ç¾¤éƒ¨ç½²åçš„ node ä¸ pod çŠ¶æ€ï¼š<img src=\"kubernetes-cluster-status.jpg\" alt=\"kubernetes-cluster-status.jpg\"></p>\n<blockquote>\n<p>ğŸ¤˜ æ³¨æ„ï¼šKubernetes é›†ç¾¤ä¸­ <code>coredns pod</code> åœ¨ Calico CNI æœªå®Œå…¨ ready æ—¶å°†å¤„äº <code>pending</code> çŠ¶æ€ï¼Œç›´è‡³æ‰€æœ‰ calico pod å¤„äº Running çŠ¶æ€æ—¶ä¹Ÿå°†å¤„äº Running çŠ¶æ€ã€‚</p>\n</blockquote>\n</li>\n<li><p>åœæ­¢ Kubernetes é›†ç¾¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./kani terminate-kube</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç ´åä¸é‡è£… Kubernetes é›†ç¾¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./kani destroy-kube</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ï¼ˆå¯é€‰æ“ä½œï¼‰éƒ¨ç½² <code>Red Hat Quay v3 registry</code> å¹¶ä¸ Kubernetes é›†ç¾¤é›†æˆï¼š<br>è‹¥éœ€ä½¿ç”¨ <code>Red Hat Quay v3 registry</code> ä½œä¸ºå®¹å™¨é•œåƒä»“åº“ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./kani config-quay</span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ Quay çš„çš„ Web UI é…ç½®ç•Œé¢</span></span><br><span class=\"line\">$ firefox &amp;</span><br><span class=\"line\"><span class=\"comment\"># ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Web UI é…ç½® Quay</span></span><br><span class=\"line\">$ ./kani deploy-quay</span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½² Quay</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>å¯é€šè¿‡ <a href=\"https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/\">Red Hat Quay v3 registry åŸç†ä¸å®ç°</a> æ–‡æ¡£äº†è§£å¦‚ä½•é€šè¿‡ Web UI é…ç½® Quayã€‚</p>\n</li>\n<li><p>é…ç½® Kubernetes é›†ç¾¤è¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼š    </p>\n<ul>\n<li><p>è‹¥åœ¨é›†ç¾¤è§„åˆ’æ—¶éœ€å°† Quay ä¸ Kubernetes é›†ç¾¤è¿æ¥çš„è¯ï¼Œéœ€åœ¨è¿è¡Œ kani å‘½ä»¤å‰æ›´æ”¹å¥½ <code>files/containerd/config.toml</code> æ–‡ä»¶ï¼Œä»¥ä¿è¯é›†ç¾¤éƒ¨ç½²å®Œæˆåå¯ä¸ Quay å¯¹æ¥ã€‚<br>å…¶ä¸­ <code>username</code> ä¸ <code>password</code> ä¸º Quay ä¸­çš„ç™»å½•ç”¨æˆ·åä¸å¯†ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š      </p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry]</span></span><br><span class=\"line\">      config_path = \"\"</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.auths]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs]</span></span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".tls]</span></span><br><span class=\"line\">          insecure_skip_verify = true</span><br><span class=\"line\">          <span class=\"comment\"># ä½¿ç”¨è‡ªç­¾å CA è¯ä¹¦ä¹Ÿéœ€é…ç½®ä¸º true</span></span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".auth]</span></span><br><span class=\"line\">          username = \"godev\"</span><br><span class=\"line\">          password = \"redhat321\"</span><br><span class=\"line\">          <span class=\"comment\"># Quay ä¸­éœ€é…ç½®çš„ç”¨æˆ·åä¸å¯†ç          </span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.headers]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]</span></span><br><span class=\"line\">      <span class=\"comment\">### modified by hualf to configure registry mirror</span></span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]</span></span><br><span class=\"line\">          endpoint = [\"https://bqr1dr1n.mirror.aliyuncs.com\"]</span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]</span></span><br><span class=\"line\">          endpoint = [\"https://registry.aliyuncs.com/k8sxio\"]</span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay-registry.lab.example.com\"]</span></span><br><span class=\"line\">          endpoint = [\"https://quay-registry.lab.example.com\"]</span><br><span class=\"line\">          <span class=\"comment\"># å†…éƒ¨ç§æœ‰çš„å®¹å™¨é•œåƒä»“åº“</span></span><br><span class=\"line\">        <span class=\"comment\"># containerd å®ˆæŠ¤è¿›ç¨‹å¯è®¿é—®çš„å…¬å…±ä¸ç§æœ‰å®¹å™¨é•œåƒä»“åº“</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è‹¥åœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²å®Œæˆåå†ä¸ Quay é›†æˆï¼Œéœ€æ›´æ”¹æ¯ä¸ªè¿è¡Œ Containerd èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ï¼Œå†é‡å¯æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ containerd å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰èƒ½ä¿è¯ä¸ Quay çš„å¯¹æ¥ã€‚   </p>\n</li>\n<li>åœ¨ç¬”è€…çš„ç¯å¢ƒä¸­ï¼Œcontainerd é…ç½®æ–‡ä»¶ä¸­å·²é…ç½®äº† <code>godev</code> ç”¨æˆ·ä¸ç›¸åº”å¯†ç ç”¨äºè¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼Œå› æ­¤ï¼Œåœ¨ Quay ä¸­éœ€åˆ›å»ºå¯¹åº”çš„ç”¨æˆ·ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/\" target=\"_blank\" rel=\"noopener\">Kubernetes Docs - ä½¿ç”¨ Kubespray å®‰è£… Kubernetes</a></li>\n<li><a href=\"https://v1-22.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/\" target=\"_blank\" rel=\"noopener\">Kubernetes Docs - Bootstrapping clusters with kubeadm</a></li>\n<li><a href=\"https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises\" target=\"_blank\" rel=\"noopener\">Install Calico</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>é¡¹ç›®ç›®çš„</li>\n<li>å®æ–½ç¯å¢ƒ</li>\n<li>éœ€è¦æ›´æ”¹çš„å‚æ•°</li>\n<li>å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•</li>\n<li>Kani çš„ä½¿ç”¨æ–¹æ³•</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"é¡¹ç›®ç›®çš„ï¼š\"><a href=\"#é¡¹ç›®ç›®çš„ï¼š\" class=\"headerlink\" title=\"é¡¹ç›®ç›®çš„ï¼š\"></a>é¡¹ç›®ç›®çš„ï¼š</h3><ul>\n<li>è™½ç„¶ç›®å‰å…·æœ‰å¤§é‡çš„ Kubernetes é›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½²è§£å†³æ–¹æ¡ˆï¼Œå…¶ä¸­å®˜æ–¹çš„ <code>KubeSpray</code> å³ä¸ºä½¿ç”¨ Ansible çš„æ–¹å¼éƒ¨ç½²ï¼Œä½†æƒ³å°è¯•è‡ªå·±æ‰‹åŠ¨é€ è½®å­ï¼Œå› æ­¤åˆ›å»ºäº† Kani é¡¹ç›®ã€‚</li>\n<li>Kani é¡¹ç›®çš„ç›®çš„åœ¨äºä½¿ç”¨ Ansible å¿«é€Ÿéƒ¨ç½²ä¸ç®¡ç† Kubernetes é›†ç¾¤åŠå…¶ç›¸å…³ç»„ä»¶ã€‚</li>\n<li>å½“å‰ç‰ˆæœ¬ä¸­ Kani æ”¯æŒï¼š  <ul>\n<li><code>Containerd</code> runtime  </li>\n<li><code>Calico</code> CNI  </li>\n<li><code>Red Hat Quay v3 registry</code></li>\n</ul>\n</li>\n<li>Kani çš„å¯é€‰åŠŸèƒ½åŒ…æ‹¬éƒ¨ç½²ä¸ç®¡ç†å…¶ä»–é¢å¤–çš„äº‘åŸç”Ÿã€DevOps ä¸ GitOps ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <ul>\n<li>å®¹å™¨é•œåƒä»“åº“ï¼šRed Hat Quay v3 registry  </li>\n<li>ä»£ç ä»“åº“ï¼šGitLab</li>\n</ul>\n</li>\n<li>å¯ç‚¹å‡» <a href=\"https://github.com/Alberthua-Perl/kani\" target=\"_blank\" rel=\"noopener\">æ­¤å¤„</a> è·å– Kani é¡¹ç›® ğŸ‘‹</li>\n</ul>\n<h3 id=\"å®æ–½ç¯å¢ƒï¼š\"><a href=\"#å®æ–½ç¯å¢ƒï¼š\" class=\"headerlink\" title=\"å®æ–½ç¯å¢ƒï¼š\"></a>å®æ–½ç¯å¢ƒï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼š<code>CentOS Linux release 7.9.2009</code> (Core)</li>\n<li>kernel ç‰ˆæœ¬ï¼š<code>5.13.12</code><blockquote>\n<p>å¯ä½¿ç”¨ <code>elrepo repository</code> å‡çº§ Linux kernelã€‚</p>\n</blockquote>\n</li>\n<li>Ansible ç‰ˆæœ¬ï¼š<code>2.9.25</code></li>\n<li>Containerd ç‰ˆæœ¬ï¼š<code>1.5.5</code></li>\n<li>Kubernetes ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n<li>å‡†å¤‡ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸º Ansible æ§åˆ¶èŠ‚ç‚¹ç”¨äºè¿è¡Œ Kaniï¼Œå¹¶å®‰è£… <code>ansible</code>ã€<code>rhel-system-roles</code> RPM è½¯ä»¶åŒ…ã€‚ </li>\n<li>ä½¿ç”¨æ™®é€šç”¨æˆ·å…‹éš†è¯¥é¡¹ç›®ï¼Œç¬”è€…ç¯å¢ƒä¸­ä½¿ç”¨ <code>godev</code> ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·ä¸é¡¹ç›®ç›®å½•ä¸­çš„ <code>vars/all.yml</code> ä¸­çš„ <code>operator_user</code> ä¸ºåŒä¸€ç”¨æˆ·ã€‚<blockquote>\n<p>ğŸ’¥ ä½¿ç”¨ Kani æ—¶ï¼Œéœ€æ³¨æ„å°†æ‚¨çš„æ™®é€šç”¨æˆ·ä¸ operator_user ä¿æŒä¸€è‡´ï¼</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"ğŸ¤˜-éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\"><a href=\"#ğŸ¤˜-éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\" class=\"headerlink\" title=\"ğŸ¤˜ éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š\"></a>ğŸ¤˜ éœ€è¦æ›´æ”¹çš„å‚æ•°ï¼š</h3><ul>\n<li>æ ¹æ®æ‚¨çš„å®é™…ç¯å¢ƒåœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­æ›´æ”¹å¯¹åº”çš„å‚æ•°ï¼š  <ul>\n<li><code>ansible.cfg</code> (Ansible config file):    <ul>\n<li>remote_userï¼šå„ä¸ª Ansible å—ç®¡ä¸»æœºä¸Šçš„ç™»å½•ç”¨æˆ·  </li>\n</ul>\n</li>\n<li><code>files/kubeadm-conf.yml</code> (kubeadm config file):    <ul>\n<li>localAPIEndpoint.advertiseAddressï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬åœ°å€    </li>\n<li>localAPIEndpoint.bindPortï¼šmaster èŠ‚ç‚¹çš„ API ç«¯ç‚¹ç›‘å¬ç«¯å£    </li>\n<li>nodeRegistration.criSocketï¼šmaster èŠ‚ç‚¹ containerd çš„ Unix å¥—æ¥å­—æ–‡ä»¶    </li>\n<li>nodeRegistration.nameï¼šmaster èŠ‚ç‚¹çš„ FQDN    </li>\n<li>nodeRegistration.taintsï¼šä¸º master èŠ‚ç‚¹æ·»åŠ ä¸å¯è°ƒåº¦çš„æ±¡ç‚¹    </li>\n<li>modeï¼škube-proxy çš„å·¥ä½œæ¨¡å¼    </li>\n<li>imageRepositoryï¼šæŒ‡å®šå®¹å™¨é•œåƒçš„ä»“åº“åœ°å€    </li>\n<li>KubernetesVersionï¼šé›†ç¾¤çš„å®‰è£…ç‰ˆæœ¬    </li>\n<li><code>networking.serviceSubnet</code>ï¼šé›†ç¾¤çš„ Service Cluster IP ç½‘æ®µ    </li>\n<li><code>networking.podSubnet</code>ï¼šé›†ç¾¤çš„ Pod IP ç½‘æ®µ    </li>\n<li>cgroupDriverï¼šæŒ‡å®šæ§åˆ¶ç»„é©±åŠ¨ç±»å‹    </li>\n<li><code>clusterDNS</code>ï¼šé›†ç¾¤çš„ CoreDNS çš„ Service Cluster IP  </li>\n</ul>\n</li>\n<li><code>inventory-kubecluster</code> (Ansible inventory file):    <ul>\n<li>æ ¹æ®æ‚¨æ‰€åœ¨çš„åœºæ™¯ä¿®æ”¹çŸ­ä¸»æœºåï¼Œæ­¤å¤„ä¸ºç¬”è€…æ‰€åœ¨çš„ç¯å¢ƒèŠ‚ç‚¹ä¿¡æ¯ã€‚  </li>\n</ul>\n</li>\n<li><code>vars/all.yml</code> (variables file):    <blockquote>\n<p>ğŸ’¥ æ ¹æ®æ‚¨æ‰€åœ¨çš„ç¯å¢ƒä¿®æ”¹ <code>!!! NEED TO EDIT !!!</code> ä¸­çš„å‚æ•°ï¼Œå…¶ä½™å‚æ•°å¯é€‰æ‹©æ€§åœ°ä¿®æ”¹ã€‚    </p>\n<ul>\n<li>gatewayï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹çš„çš„é»˜è®¤ç½‘å…³    </li>\n<li>nicï¼šæ‰€æœ‰ Kubernetes èŠ‚ç‚¹è¿æ¥é»˜è®¤ç½‘å…³çš„ç½‘å¡æ¥å£    </li>\n<li>operator_userï¼šAnsible æ§åˆ¶èŠ‚ç‚¹ä¸å—ç®¡ä¸»æœºä¸Šè¿œç¨‹è¿æ¥çš„æ™®é€šç”¨æˆ·<br>ğŸ‘‰ operator_user ä¸ ansible.cfg ä¸­çš„ remote_user ç›¸åŒã€‚    </li>\n<li>kube_master_nodeï¼šmaster èŠ‚ç‚¹çš„çŸ­ä¸»æœºå<br>ğŸ’¥ è¯¥å‚æ•°ä¸ inventory-kubecluster ä¸­çš„çŸ­ä¸»æœºåç›¸åŒã€‚</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\"><a href=\"#å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\" class=\"headerlink\" title=\"å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š\"></a>å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•ï¼š</h3><ul>\n<li>Kubernetes éƒ¨ç½²è¿‡ç¨‹ä¸­çš„éƒ¨åˆ†æŠ¥é”™ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><code>kubeadm init</code> åˆå§‹åŒ– master èŠ‚ç‚¹å¤±è´¥ï¼Œå¹¶ä¸”æŠ¥é”™ <code>node not found</code>ã€‚ç”±äºæ‰€æœ‰çš„ <code>pause infra images</code> æœªæ ‡è¯†ï¼ˆtaggedï¼‰<code>k8s.io/pause:3.5</code>ï¼Œå› æ­¤åœ¨ master èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> ä¸èƒ½åˆ›å»º <code>sandbox</code>ã€‚<br><img src=\"kubeadm-init-master-error-1.jpg\" alt=\"kubeadm-init-master-error-1.jpg\"><img src=\"kubeadm-init-master-error-2.jpg\" alt=\"kubeadm-init-master-error-2.jpg\"></li>\n<li>playbook ä¸­çš„ <code>register</code> æ³¨å†Œå˜é‡ä¸èƒ½åœ¨ä¸åŒçš„ play é—´å¼•ç”¨ã€‚<br><img src=\"register-var-used-between-two-plays-error.jpg\" alt=\"register-var-used-between-two-plays-error.jpg\"></li>\n<li>ç”±äºä½¿ç”¨ <code>containerd</code> æ¥è¿è¡Œå®¹å™¨ï¼Œå› æ­¤ <code>ctr</code>ã€<code>crictl</code> ä¸ <code>nerdctl</code> å¯è¢«ç”¨æ¥è·å–å®¹å™¨é•œåƒä¸å®¹å™¨è‡ªèº«çš„çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œä»…ä»… <code>crictl</code> å¯ç›´æ¥ä½¿ç”¨ containerd é…ç½®æ–‡ä»¶ <code>/etc/containerd/config.toml</code>ã€‚crictl å¯åŠ è½½é…ç½®æœ‰ quay registry endpointã€user ä¸ password çš„é…ç½®æ–‡ä»¶ã€‚</li>\n<li>è‹¥ä½¿ç”¨è‡ªç­¾åçš„ CA è¯ä¹¦ï¼Œcrictl ä¸èƒ½ä» quay å®¹å™¨é•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œå¹¶ä¸”æ€»æ˜¯æŠ¥é”™ <code>x509 cert file error</code>ï¼š<br><img src=\"crictl-ssl-ca-request-quay-error.jpg\" alt=\"crictl-ssl-ca-request-quay-error.jpg\"></li>\n<li>é€šè¿‡é…ç½®åœ¨ containerd é…ç½®æ–‡ä»¶ä¸­çš„ <code>insecure_skip_verify = true</code> è·³è¿‡ tls éªŒè¯æ‰èƒ½æ‹‰å–é•œåƒã€‚</li>\n</ul>\n<h3 id=\"ğŸš€-Kani-çš„ä½¿ç”¨æ–¹æ³•ï¼š\"><a href=\"#ğŸš€-Kani-çš„ä½¿ç”¨æ–¹æ³•ï¼š\" class=\"headerlink\" title=\"ğŸš€ Kani çš„ä½¿ç”¨æ–¹æ³•ï¼š\"></a>ğŸš€ Kani çš„ä½¿ç”¨æ–¹æ³•ï¼š</h3><ul>\n<li><p>Kani é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">â”Œâ”€[godev][paas-ctl][~/kani]</span><br><span class=\"line\">â””â”€â tree .</span><br><span class=\"line\">.</span><br><span class=\"line\">â”œâ”€â”€ 00-general-prepare-kube.yml</span><br><span class=\"line\">â”œâ”€â”€ 01-containerd-kube-deploy.yml</span><br><span class=\"line\">â”œâ”€â”€ 02-kube-cluster-calio-deploy.yml</span><br><span class=\"line\">â”œâ”€â”€ 03-post-kube-deploy.yml</span><br><span class=\"line\">â”œâ”€â”€ ansible.cfg</span><br><span class=\"line\">â”œâ”€â”€ destroy-kube-cluster.yml</span><br><span class=\"line\">â”œâ”€â”€ files</span><br><span class=\"line\">â”‚   â”œâ”€â”€ cni</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ calico-v3.21.yml</span><br><span class=\"line\">â”‚   â”œâ”€â”€ containerd</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ config.toml</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ containerd-rootless-setuptool.sh</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ containerd-rootless.sh</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ cri-containerd-cni-1.5.5-linux-amd64.tar.gz  <span class=\"comment\"># è¯¥æ–‡ä»¶å¯ä»ä¸‹æ–‡ç™¾åº¦ç½‘ç›˜ä¸‹è½½</span></span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ nerdctl</span><br><span class=\"line\">â”‚   â”œâ”€â”€ kube-utils</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ k9s_Linux_x86_64.tar.gz</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubeadm-conf.yml</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kube-dashboard-admin.yml</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ kube-dashboard-v2.3.1.yml</span><br><span class=\"line\">â”‚   â”œâ”€â”€ quay</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ deploy-quay-registry.sh</span><br><span class=\"line\">â”‚   â”œâ”€â”€ repos</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ docker-ce.repo</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ kubernetes.repo</span><br><span class=\"line\">â”‚   â”œâ”€â”€ rpms</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubeadm-1.22.1-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubectl-1.22.1-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â”‚   â”œâ”€â”€ kubelet-1.22.1-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â”‚   â””â”€â”€ kubernetes-cni-0.8.7-0.x86_64.rpm</span><br><span class=\"line\">â”‚   â””â”€â”€ vimrc</span><br><span class=\"line\">â”œâ”€â”€ inventory-kubecluster</span><br><span class=\"line\">â”œâ”€â”€ job-for-terminate-kube.yml</span><br><span class=\"line\">â”œâ”€â”€ kani</span><br><span class=\"line\">â”œâ”€â”€ kube-reverse</span><br><span class=\"line\">â”œâ”€â”€ provision-quay-registry.yml</span><br><span class=\"line\">â”œâ”€â”€ templates</span><br><span class=\"line\">â”‚   â””â”€â”€ hosts.j2</span><br><span class=\"line\">â”œâ”€â”€ terminate-kube-cluster.yml</span><br><span class=\"line\">â””â”€â”€ vars</span><br><span class=\"line\">    â””â”€â”€ all.yml</span><br><span class=\"line\"></span><br><span class=\"line\">9 directories, 32 files</span><br></pre></td></tr></table></figure>\n<blockquote>\n<ol>\n<li>ç”±äº GitHub å¯¹äºä¸Šä¼ æ–‡ä»¶çš„å¤§å°é™åˆ¶ï¼ˆ100 MiBï¼‰ï¼Œ<code>files/containerd/cri-containerd-cni-1.5.5-linux-amd64.tar.gz</code> å¯ä» <a href=\"https://pan.baidu.com/s/1ytxDjSN0u5Tewy5rcEGWNQ\" target=\"_blank\" rel=\"noopener\">ç™¾åº¦ç½‘ç›˜</a> ä¸‹è½½ï¼Œä¸‹è½½å¯†ç ä¸º apdlã€‚</li>\n<li>ğŸ’¥ ç”±äºåœ¨ aliyun yum æºä¸­çš„ kubeadmã€kubectlã€kubelet ä¸ kubernetes-cni çš„ rpm è½¯ä»¶åŒ…å¯èƒ½å­˜åœ¨æ— æ³•è·å–çš„æƒ…å†µï¼Œå› æ­¤å·²å°†è½¯ä»¶åŒ…åŒé¡¹ç›®ä¸€èµ·ä¸Šä¼ ï¼</li>\n</ol>\n</blockquote>\n</li>\n<li><p>æ›´æ”¹æ‰€æœ‰æ–‡ä»¶ä¸­çš„å‚æ•°åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤éƒ¨ç½²é›†ç¾¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">cd</span> kani</span><br><span class=\"line\">$ chmod +x ./kani</span><br><span class=\"line\">$ ./kani --<span class=\"built_in\">help</span></span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ kani çš„ä½¿ç”¨æ–¹æ³•</span></span><br><span class=\"line\">Rapid deploy kubernetes cluster and elements by ansible</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">  kani [<span class=\"built_in\">command</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">Available Commands:</span><br><span class=\"line\">  deploy-kube     Deploy single master node kubernetes cluster with calico cni</span><br><span class=\"line\">  terminate-kube  Terminate kubernetes master and worker nodes</span><br><span class=\"line\">  destroy-kube    Destroy and prepare to re-install kubernetes cluster</span><br><span class=\"line\">  config-quay     Config and run quay config container</span><br><span class=\"line\">  deploy-quay     Deploy quay registry</span><br><span class=\"line\"></span><br><span class=\"line\">$ ./kani deploy-kube</span><br><span class=\"line\"><span class=\"comment\"># éƒ¨ç½² Kubernetes é›†ç¾¤</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ğŸ¤˜ æ³¨æ„ï¼šåœ¨ kubeadm init åˆå§‹åŒ– master èŠ‚ç‚¹åï¼Œç”±äºè¿˜æœªå°†å…¶ä»– node èŠ‚ç‚¹åŠ å…¥è‡³é›†ç¾¤ä¸­ï¼Œæ­¤æ—¶å„ä¸ª node èŠ‚ç‚¹ä¸Šçš„ <code>kubelet</code> å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½å¤„äº <code>active (auto-restarting)</code> çŠ¶æ€ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹ /var/log/messages ä¸­å­˜åœ¨å¤§é‡çš„ <code>/etc/kubernetes/pki/ca.crt not found</code> çš„æŠ¥é”™ï¼Œè¿™æ˜¯ç”±äº kubeadm join è¿˜æœªå°† node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä»¥åŠè¿˜æœªåŒæ­¥ master èŠ‚ç‚¹çš„ CA è¯ä¹¦æ‰€è‡´ï¼Œå¾… node èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­å kubelet çŠ¶æ€å°†æ¢å¤ <code>active</code> çŠ¶æ€ã€‚</p>\n</blockquote>\n</li>\n<li><p>Kubernetes é›†ç¾¤éƒ¨ç½²åçš„ node ä¸ pod çŠ¶æ€ï¼š<img src=\"kubernetes-cluster-status.jpg\" alt=\"kubernetes-cluster-status.jpg\"></p>\n<blockquote>\n<p>ğŸ¤˜ æ³¨æ„ï¼šKubernetes é›†ç¾¤ä¸­ <code>coredns pod</code> åœ¨ Calico CNI æœªå®Œå…¨ ready æ—¶å°†å¤„äº <code>pending</code> çŠ¶æ€ï¼Œç›´è‡³æ‰€æœ‰ calico pod å¤„äº Running çŠ¶æ€æ—¶ä¹Ÿå°†å¤„äº Running çŠ¶æ€ã€‚</p>\n</blockquote>\n</li>\n<li><p>åœæ­¢ Kubernetes é›†ç¾¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./kani terminate-kube</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç ´åä¸é‡è£… Kubernetes é›†ç¾¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./kani destroy-kube</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ï¼ˆå¯é€‰æ“ä½œï¼‰éƒ¨ç½² <code>Red Hat Quay v3 registry</code> å¹¶ä¸ Kubernetes é›†ç¾¤é›†æˆï¼š<br>è‹¥éœ€ä½¿ç”¨ <code>Red Hat Quay v3 registry</code> ä½œä¸ºå®¹å™¨é•œåƒä»“åº“ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./kani config-quay</span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸€æ­¥ï¼šå¯åŠ¨ Quay çš„çš„ Web UI é…ç½®ç•Œé¢</span></span><br><span class=\"line\">$ firefox &amp;</span><br><span class=\"line\"><span class=\"comment\"># ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Web UI é…ç½® Quay</span></span><br><span class=\"line\">$ ./kani deploy-quay</span><br><span class=\"line\"><span class=\"comment\"># ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½² Quay</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><p>å¯é€šè¿‡ <a href=\"https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/\">Red Hat Quay v3 registry åŸç†ä¸å®ç°</a> æ–‡æ¡£äº†è§£å¦‚ä½•é€šè¿‡ Web UI é…ç½® Quayã€‚</p>\n</li>\n<li><p>é…ç½® Kubernetes é›†ç¾¤è¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼š    </p>\n<ul>\n<li><p>è‹¥åœ¨é›†ç¾¤è§„åˆ’æ—¶éœ€å°† Quay ä¸ Kubernetes é›†ç¾¤è¿æ¥çš„è¯ï¼Œéœ€åœ¨è¿è¡Œ kani å‘½ä»¤å‰æ›´æ”¹å¥½ <code>files/containerd/config.toml</code> æ–‡ä»¶ï¼Œä»¥ä¿è¯é›†ç¾¤éƒ¨ç½²å®Œæˆåå¯ä¸ Quay å¯¹æ¥ã€‚<br>å…¶ä¸­ <code>username</code> ä¸ <code>password</code> ä¸º Quay ä¸­çš„ç™»å½•ç”¨æˆ·åä¸å¯†ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š      </p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry]</span></span><br><span class=\"line\">      config_path = \"\"</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.auths]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs]</span></span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".tls]</span></span><br><span class=\"line\">          insecure_skip_verify = true</span><br><span class=\"line\">          <span class=\"comment\"># ä½¿ç”¨è‡ªç­¾å CA è¯ä¹¦ä¹Ÿéœ€é…ç½®ä¸º true</span></span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"quay-registry.lab.example.com\".auth]</span></span><br><span class=\"line\">          username = \"godev\"</span><br><span class=\"line\">          password = \"redhat321\"</span><br><span class=\"line\">          <span class=\"comment\"># Quay ä¸­éœ€é…ç½®çš„ç”¨æˆ·åä¸å¯†ç          </span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.headers]</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors]</span></span><br><span class=\"line\">      <span class=\"comment\">### modified by hualf to configure registry mirror</span></span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]</span></span><br><span class=\"line\">          endpoint = [\"https://bqr1dr1n.mirror.aliyuncs.com\"]</span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"k8s.gcr.io\"]</span></span><br><span class=\"line\">          endpoint = [\"https://registry.aliyuncs.com/k8sxio\"]</span><br><span class=\"line\">        <span class=\"section\">[plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"quay-registry.lab.example.com\"]</span></span><br><span class=\"line\">          endpoint = [\"https://quay-registry.lab.example.com\"]</span><br><span class=\"line\">          <span class=\"comment\"># å†…éƒ¨ç§æœ‰çš„å®¹å™¨é•œåƒä»“åº“</span></span><br><span class=\"line\">        <span class=\"comment\"># containerd å®ˆæŠ¤è¿›ç¨‹å¯è®¿é—®çš„å…¬å…±ä¸ç§æœ‰å®¹å™¨é•œåƒä»“åº“</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è‹¥åœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²å®Œæˆåå†ä¸ Quay é›†æˆï¼Œéœ€æ›´æ”¹æ¯ä¸ªè¿è¡Œ Containerd èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ï¼Œå†é‡å¯æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ containerd å®ˆæŠ¤è¿›ç¨‹ï¼Œæ‰èƒ½ä¿è¯ä¸ Quay çš„å¯¹æ¥ã€‚   </p>\n</li>\n<li>åœ¨ç¬”è€…çš„ç¯å¢ƒä¸­ï¼Œcontainerd é…ç½®æ–‡ä»¶ä¸­å·²é…ç½®äº† <code>godev</code> ç”¨æˆ·ä¸ç›¸åº”å¯†ç ç”¨äºè¿æ¥ Quay ä¸æ‹‰å–é•œåƒï¼Œå› æ­¤ï¼Œåœ¨ Quay ä¸­éœ€åˆ›å»ºå¯¹åº”çš„ç”¨æˆ·ã€‚</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://kubernetes.io/zh/docs/setup/production-environment/tools/kubespray/\" target=\"_blank\" rel=\"noopener\">Kubernetes Docs - ä½¿ç”¨ Kubespray å®‰è£… Kubernetes</a></li>\n<li><a href=\"https://v1-22.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/\" target=\"_blank\" rel=\"noopener\">Kubernetes Docs - Bootstrapping clusters with kubeadm</a></li>\n<li><a href=\"https://projectcalico.docs.tigera.io/getting-started/kubernetes/self-managed-onprem/onpremises\" target=\"_blank\" rel=\"noopener\">Install Calico</a></li>\n</ul>\n"},{"title":"éƒ¨ç½² loganalyzer ç®¡ç†é›†ä¸­å¼æ—¥å¿—","subtitle":"Deploy loganalyzer to Manage Centralized Logs","header-img":"hello-world-dark-bg.jpg","date":"2022-12-05T08:12:20.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼šRed Hat Enterprise Linux 8.2 (Ootpa)\n- Podman ç‰ˆæœ¬ï¼špodman-1.9.3-2.module+el8.2.1+6867+366c07d6.x86_64\n- loganalyzer ç‰ˆæœ¬ï¼šloganalyzer-4.1.11.tar.gz\n- è¯¥ç¤ºä¾‹ä¸­ä½¿ç”¨ yum å®‰è£…çš„è½¯ä»¶åŒ…è‹¥æœªæŒ‡å®šç‰¹å®šç‰ˆæœ¬å‡ä¸ºç³»ç»Ÿè‡ªå¸¦è½¯ä»¶åŒ…ã€‚\n\n### æ¶æ„ç¤ºä¾‹ï¼š\n![loganalyzer-mysql-rsyslogserver.jpg](loganalyzer-mysql-rsyslogserver.jpg)\nå¦‚å›¾æ‰€ç¤ºï¼Œ`rsyslog-server` æœåŠ¡ç«¯æ”¶é›†æ¥è‡ª `rsyslog-client` å®¢æˆ·ç«¯å‘é€çš„æŒ‡å®šç³»ç»Ÿæ—¥å¿—æ•°æ®ï¼Œå¹¶ä¸” Apache httpd server ä¸ MySQL æ•°æ®åº“å‡ä»¥å®¹å™¨çš„æ–¹å¼ä¸€åŒéƒ¨ç½²äºæœåŠ¡ç«¯ã€‚\n\n### loganalyzer ä¸ MySQL çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\n- éƒ¨ç½²ç”¨ `Shell` è„šæœ¬å¯å‚è€ƒ [æ­¤é“¾æ¥](https://github.com/Alberthua-Perl/scripts-confs/blob/master/deploy-rsyslog-viewer/deploy-rsyslog-viewer.sh)ã€‚\n- éƒ¨ç½²ç”¨èŠ‚ç‚¹ï¼š\n  - serverb.lab.example.com (RH294v8.0 course)ï¼š2 vCPUï¼Œ4GiB RAM\n  - firewalld æœåŠ¡å·²ç¦ç”¨   \n  - SELinux ä¸º enforcing æ¨¡å¼   \n- æ­¤æ¬¡ä½¿ç”¨ **`podman runtime`** å®¹å™¨è¿è¡Œæ—¶è¿è¡Œæ‰€æœ‰å®¹å™¨ã€‚\n- è¯¥éƒ¨ç½²ç¯å¢ƒä¸­å·²é¢„é…ç½® `Red Hat Quay 3.3.0`ï¼Œå¹¶ä¸”å·²å°† `mysql-57-rhel7:latest` ä¸Šä¼ è‡³è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„ `rhscl organization` ä¸­ã€‚\n- å°†å®¹å™¨é•œåƒä¸Šä¼ è‡³ Quay ä¸­ï¼Œéœ€æå‰åˆ›å»ºç›¸åº”çš„ organizaionï¼Œå¦åˆ™å°†ä¸Šä¼ å¤±è´¥æŠ¥é”™ï¼\n  ![quay-push-error-1..jpg](quay-push-error-1.jpg)![quay-push-error-2.jpg](quay-push-error-2.jpg)\n- åŠ¡å¿…å…³é—­å¹¶ç¦ç”¨èŠ‚ç‚¹ `firewalld` æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¸ `iptables NAT` è§„åˆ™å†²çªï¼Œåœ¨å¯ç”¨çš„æƒ…å†µä¸‹å°†æ— æ³•å®ç°å®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œiptables NAT è§„åˆ™æ— æ³•å»ºç«‹ï¼\n- ç”±äº loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨å‡ä½äºåŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä¸”å®¹å™¨é€šè¿‡ `CNI bridge` (cni-podman0) è¿æ¥ï¼Œå› æ­¤ loganalyzer è¿æ¥ MySQL æ—¶åº”ä½¿ç”¨èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œä½† MySQL å¯¹æŒ‡å®šç”¨æˆ·çš„æˆæƒè¯­å¥åº”ä½¿ç”¨ `CNI Gateway` çš„ IP åœ°å€ï¼Œå¦åˆ™åœ¨å‰ç«¯ Web ä¸Šæ— æ³•å»ºç«‹è¿æ¥ã€‚\n   ```sql\n   grant all on Syslog.* to '${SYSLOG_USER}'@'${CNI_GATEWAY}' identified by '${SYSLOG_PASS}';\n   ```\n- loganalyzer å®¹å™¨é•œåƒåŸºäº `Apache httpd server` æ„å»ºï¼Œå¯å‚è€ƒ [æ­¤é“¾æ¥](https://github.com/Alberthua-Perl/Dockerfile-examples/tree/master/loganalyzer-viewer)ã€‚\n- loganalyzer é¡¹ç›®åŸºäº PHPï¼Œå¯ä½œä¸º MySQL æ•°æ®åº“æ£€ç´¢æ—¥å¿—æ•°æ®çš„ Web å‰ç«¯ã€‚\n- MySQL å®¹å™¨ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼ˆå·æ˜ å°„ï¼‰æ—¶ï¼Œç”±äºä½¿ç”¨ Red Hat å®˜æ–¹é•œåƒï¼Œå¯åŠ¨å®¹å™¨æ—¶ä¸ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œ mysql å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œä½¿ç”¨ **UID 27** (mysql) è¿è¡Œï¼Œéœ€è®¾ç½®å®¿ä¸»æœºæ˜ å°„ç›®å½•çš„æ‰€æœ‰è€…ä¸æ‰€å±ç»„ï¼Œä¸æ›´æ”¹å°†æ— æ³•è¿è¡Œå®¹å™¨ã€‚    \n- å®¹å™¨ä¸­æŠ¥é”™æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š![mysql-container-run-error.jpg](mysql-container-run-error.jpg)\n- loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨éƒ¨ç½²æˆåŠŸä¸”æ­£å¸¸è¿è¡Œåï¼Œéœ€è®¿é—® loganalyzer å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹ä»¥å®Œæˆä¸¤è€…çš„å¯¹æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![loganalyzer-web-1.jpg](loganalyzer-web-1.jpg)![loganalyzer-web-2.jpg](loganalyzer-web-2.jpg)![loganalyzer-web-3.jpg](loganalyzer-web-3.jpg)![loganalyzer-web-4.jpg](loganalyzer-web-4.jpg)![loganalyzer-web-5.jpg](loganalyzer-web-5.jpg)![loganalyzer-web-6.jpg](loganalyzer-web-6.jpg)![loganalyzer-web-7.jpg](loganalyzer-web-7.jpg)![loganalyzer-web-8.jpg](loganalyzer-web-8.jpg)![loganalyzer-web-9.jpg](loganalyzer-web-9.jpg)![loganalyzer-web-10.jpg](loganalyzer-web-10.jpg)\n\n### loganalyzer çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\n- loganalyzer ä¹Ÿå¯ç›´æ¥ä½¿ç”¨è§£å‹çš„å‹ç¼©åŒ…ï¼ˆPHP æºç ï¼‰å®ç°å®‰è£…ï¼Œæ–¹æ³•ä½äºéƒ¨ç½²è„šæœ¬çš„æœ€åæ³¨é‡Šéƒ¨åˆ†ã€‚\n- SELinux ä¸º `enforcing` æ¨¡å¼æ—¶ï¼Œloganalyzer æ— æ³•ä¸ MySQL å®¹å™¨è¿æ¥ï¼Œéœ€æ‰“å¼€ PHP ä¸ MySQLçš„ç½‘ç»œè¿æ¥å¸ƒå°”å€¼ä»¥æ”¯æŒã€‚![selinux-php-mysql-connection.jpg](selinux-php-mysql-connection.jpg)\n","source":"_posts/loganalyzer-rsyslog-mysql.md","raw":"---\ntitle: éƒ¨ç½² loganalyzer ç®¡ç†é›†ä¸­å¼æ—¥å¿—\nsubtitle: Deploy loganalyzer to Manage Centralized Logs\nheader-img: hello-world-dark-bg.jpg \ndate: 2022-12-05 16:12:20\ntags:\n  - Linux\n  - å®¹å™¨\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼šRed Hat Enterprise Linux 8.2 (Ootpa)\n- Podman ç‰ˆæœ¬ï¼špodman-1.9.3-2.module+el8.2.1+6867+366c07d6.x86_64\n- loganalyzer ç‰ˆæœ¬ï¼šloganalyzer-4.1.11.tar.gz\n- è¯¥ç¤ºä¾‹ä¸­ä½¿ç”¨ yum å®‰è£…çš„è½¯ä»¶åŒ…è‹¥æœªæŒ‡å®šç‰¹å®šç‰ˆæœ¬å‡ä¸ºç³»ç»Ÿè‡ªå¸¦è½¯ä»¶åŒ…ã€‚\n\n### æ¶æ„ç¤ºä¾‹ï¼š\n![loganalyzer-mysql-rsyslogserver.jpg](loganalyzer-mysql-rsyslogserver.jpg)\nå¦‚å›¾æ‰€ç¤ºï¼Œ`rsyslog-server` æœåŠ¡ç«¯æ”¶é›†æ¥è‡ª `rsyslog-client` å®¢æˆ·ç«¯å‘é€çš„æŒ‡å®šç³»ç»Ÿæ—¥å¿—æ•°æ®ï¼Œå¹¶ä¸” Apache httpd server ä¸ MySQL æ•°æ®åº“å‡ä»¥å®¹å™¨çš„æ–¹å¼ä¸€åŒéƒ¨ç½²äºæœåŠ¡ç«¯ã€‚\n\n### loganalyzer ä¸ MySQL çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\n- éƒ¨ç½²ç”¨ `Shell` è„šæœ¬å¯å‚è€ƒ [æ­¤é“¾æ¥](https://github.com/Alberthua-Perl/scripts-confs/blob/master/deploy-rsyslog-viewer/deploy-rsyslog-viewer.sh)ã€‚\n- éƒ¨ç½²ç”¨èŠ‚ç‚¹ï¼š\n  - serverb.lab.example.com (RH294v8.0 course)ï¼š2 vCPUï¼Œ4GiB RAM\n  - firewalld æœåŠ¡å·²ç¦ç”¨   \n  - SELinux ä¸º enforcing æ¨¡å¼   \n- æ­¤æ¬¡ä½¿ç”¨ **`podman runtime`** å®¹å™¨è¿è¡Œæ—¶è¿è¡Œæ‰€æœ‰å®¹å™¨ã€‚\n- è¯¥éƒ¨ç½²ç¯å¢ƒä¸­å·²é¢„é…ç½® `Red Hat Quay 3.3.0`ï¼Œå¹¶ä¸”å·²å°† `mysql-57-rhel7:latest` ä¸Šä¼ è‡³è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„ `rhscl organization` ä¸­ã€‚\n- å°†å®¹å™¨é•œåƒä¸Šä¼ è‡³ Quay ä¸­ï¼Œéœ€æå‰åˆ›å»ºç›¸åº”çš„ organizaionï¼Œå¦åˆ™å°†ä¸Šä¼ å¤±è´¥æŠ¥é”™ï¼\n  ![quay-push-error-1..jpg](quay-push-error-1.jpg)![quay-push-error-2.jpg](quay-push-error-2.jpg)\n- åŠ¡å¿…å…³é—­å¹¶ç¦ç”¨èŠ‚ç‚¹ `firewalld` æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¸ `iptables NAT` è§„åˆ™å†²çªï¼Œåœ¨å¯ç”¨çš„æƒ…å†µä¸‹å°†æ— æ³•å®ç°å®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œiptables NAT è§„åˆ™æ— æ³•å»ºç«‹ï¼\n- ç”±äº loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨å‡ä½äºåŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä¸”å®¹å™¨é€šè¿‡ `CNI bridge` (cni-podman0) è¿æ¥ï¼Œå› æ­¤ loganalyzer è¿æ¥ MySQL æ—¶åº”ä½¿ç”¨èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œä½† MySQL å¯¹æŒ‡å®šç”¨æˆ·çš„æˆæƒè¯­å¥åº”ä½¿ç”¨ `CNI Gateway` çš„ IP åœ°å€ï¼Œå¦åˆ™åœ¨å‰ç«¯ Web ä¸Šæ— æ³•å»ºç«‹è¿æ¥ã€‚\n   ```sql\n   grant all on Syslog.* to '${SYSLOG_USER}'@'${CNI_GATEWAY}' identified by '${SYSLOG_PASS}';\n   ```\n- loganalyzer å®¹å™¨é•œåƒåŸºäº `Apache httpd server` æ„å»ºï¼Œå¯å‚è€ƒ [æ­¤é“¾æ¥](https://github.com/Alberthua-Perl/Dockerfile-examples/tree/master/loganalyzer-viewer)ã€‚\n- loganalyzer é¡¹ç›®åŸºäº PHPï¼Œå¯ä½œä¸º MySQL æ•°æ®åº“æ£€ç´¢æ—¥å¿—æ•°æ®çš„ Web å‰ç«¯ã€‚\n- MySQL å®¹å™¨ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼ˆå·æ˜ å°„ï¼‰æ—¶ï¼Œç”±äºä½¿ç”¨ Red Hat å®˜æ–¹é•œåƒï¼Œå¯åŠ¨å®¹å™¨æ—¶ä¸ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œ mysql å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œä½¿ç”¨ **UID 27** (mysql) è¿è¡Œï¼Œéœ€è®¾ç½®å®¿ä¸»æœºæ˜ å°„ç›®å½•çš„æ‰€æœ‰è€…ä¸æ‰€å±ç»„ï¼Œä¸æ›´æ”¹å°†æ— æ³•è¿è¡Œå®¹å™¨ã€‚    \n- å®¹å™¨ä¸­æŠ¥é”™æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š![mysql-container-run-error.jpg](mysql-container-run-error.jpg)\n- loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨éƒ¨ç½²æˆåŠŸä¸”æ­£å¸¸è¿è¡Œåï¼Œéœ€è®¿é—® loganalyzer å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹ä»¥å®Œæˆä¸¤è€…çš„å¯¹æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![loganalyzer-web-1.jpg](loganalyzer-web-1.jpg)![loganalyzer-web-2.jpg](loganalyzer-web-2.jpg)![loganalyzer-web-3.jpg](loganalyzer-web-3.jpg)![loganalyzer-web-4.jpg](loganalyzer-web-4.jpg)![loganalyzer-web-5.jpg](loganalyzer-web-5.jpg)![loganalyzer-web-6.jpg](loganalyzer-web-6.jpg)![loganalyzer-web-7.jpg](loganalyzer-web-7.jpg)![loganalyzer-web-8.jpg](loganalyzer-web-8.jpg)![loganalyzer-web-9.jpg](loganalyzer-web-9.jpg)![loganalyzer-web-10.jpg](loganalyzer-web-10.jpg)\n\n### loganalyzer çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\n- loganalyzer ä¹Ÿå¯ç›´æ¥ä½¿ç”¨è§£å‹çš„å‹ç¼©åŒ…ï¼ˆPHP æºç ï¼‰å®ç°å®‰è£…ï¼Œæ–¹æ³•ä½äºéƒ¨ç½²è„šæœ¬çš„æœ€åæ³¨é‡Šéƒ¨åˆ†ã€‚\n- SELinux ä¸º `enforcing` æ¨¡å¼æ—¶ï¼Œloganalyzer æ— æ³•ä¸ MySQL å®¹å™¨è¿æ¥ï¼Œéœ€æ‰“å¼€ PHP ä¸ MySQLçš„ç½‘ç»œè¿æ¥å¸ƒå°”å€¼ä»¥æ”¯æŒã€‚![selinux-php-mysql-connection.jpg](selinux-php-mysql-connection.jpg)\n","slug":"loganalyzer-rsyslog-mysql","published":1,"updated":"2022-12-05T08:59:29.210Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonoll000e16vdvqcp5vmt","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼šRed Hat Enterprise Linux 8.2 (Ootpa)</li>\n<li>Podman ç‰ˆæœ¬ï¼špodman-1.9.3-2.module+el8.2.1+6867+366c07d6.x86_64</li>\n<li>loganalyzer ç‰ˆæœ¬ï¼šloganalyzer-4.1.11.tar.gz</li>\n<li>è¯¥ç¤ºä¾‹ä¸­ä½¿ç”¨ yum å®‰è£…çš„è½¯ä»¶åŒ…è‹¥æœªæŒ‡å®šç‰¹å®šç‰ˆæœ¬å‡ä¸ºç³»ç»Ÿè‡ªå¸¦è½¯ä»¶åŒ…ã€‚</li>\n</ul>\n<h3 id=\"æ¶æ„ç¤ºä¾‹ï¼š\"><a href=\"#æ¶æ„ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"æ¶æ„ç¤ºä¾‹ï¼š\"></a>æ¶æ„ç¤ºä¾‹ï¼š</h3><p><img src=\"loganalyzer-mysql-rsyslogserver.jpg\" alt=\"loganalyzer-mysql-rsyslogserver.jpg\"><br>å¦‚å›¾æ‰€ç¤ºï¼Œ<code>rsyslog-server</code> æœåŠ¡ç«¯æ”¶é›†æ¥è‡ª <code>rsyslog-client</code> å®¢æˆ·ç«¯å‘é€çš„æŒ‡å®šç³»ç»Ÿæ—¥å¿—æ•°æ®ï¼Œå¹¶ä¸” Apache httpd server ä¸ MySQL æ•°æ®åº“å‡ä»¥å®¹å™¨çš„æ–¹å¼ä¸€åŒéƒ¨ç½²äºæœåŠ¡ç«¯ã€‚</p>\n<h3 id=\"loganalyzer-ä¸-MySQL-çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\"><a href=\"#loganalyzer-ä¸-MySQL-çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\" class=\"headerlink\" title=\"loganalyzer ä¸ MySQL çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\"></a>loganalyzer ä¸ MySQL çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š</h3><ul>\n<li>éƒ¨ç½²ç”¨ <code>Shell</code> è„šæœ¬å¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/deploy-rsyslog-viewer/deploy-rsyslog-viewer.sh\" target=\"_blank\" rel=\"noopener\">æ­¤é“¾æ¥</a>ã€‚</li>\n<li>éƒ¨ç½²ç”¨èŠ‚ç‚¹ï¼š<ul>\n<li>serverb.lab.example.com (RH294v8.0 course)ï¼š2 vCPUï¼Œ4GiB RAM</li>\n<li>firewalld æœåŠ¡å·²ç¦ç”¨   </li>\n<li>SELinux ä¸º enforcing æ¨¡å¼   </li>\n</ul>\n</li>\n<li>æ­¤æ¬¡ä½¿ç”¨ <strong><code>podman runtime</code></strong> å®¹å™¨è¿è¡Œæ—¶è¿è¡Œæ‰€æœ‰å®¹å™¨ã€‚</li>\n<li>è¯¥éƒ¨ç½²ç¯å¢ƒä¸­å·²é¢„é…ç½® <code>Red Hat Quay 3.3.0</code>ï¼Œå¹¶ä¸”å·²å°† <code>mysql-57-rhel7:latest</code> ä¸Šä¼ è‡³è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„ <code>rhscl organization</code> ä¸­ã€‚</li>\n<li>å°†å®¹å™¨é•œåƒä¸Šä¼ è‡³ Quay ä¸­ï¼Œéœ€æå‰åˆ›å»ºç›¸åº”çš„ organizaionï¼Œå¦åˆ™å°†ä¸Šä¼ å¤±è´¥æŠ¥é”™ï¼<br><img src=\"quay-push-error-1.jpg\" alt=\"quay-push-error-1..jpg\"><img src=\"quay-push-error-2.jpg\" alt=\"quay-push-error-2.jpg\"></li>\n<li>åŠ¡å¿…å…³é—­å¹¶ç¦ç”¨èŠ‚ç‚¹ <code>firewalld</code> æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¸ <code>iptables NAT</code> è§„åˆ™å†²çªï¼Œåœ¨å¯ç”¨çš„æƒ…å†µä¸‹å°†æ— æ³•å®ç°å®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œiptables NAT è§„åˆ™æ— æ³•å»ºç«‹ï¼</li>\n<li><p>ç”±äº loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨å‡ä½äºåŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä¸”å®¹å™¨é€šè¿‡ <code>CNI bridge</code> (cni-podman0) è¿æ¥ï¼Œå› æ­¤ loganalyzer è¿æ¥ MySQL æ—¶åº”ä½¿ç”¨èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œä½† MySQL å¯¹æŒ‡å®šç”¨æˆ·çš„æˆæƒè¯­å¥åº”ä½¿ç”¨ <code>CNI Gateway</code> çš„ IP åœ°å€ï¼Œå¦åˆ™åœ¨å‰ç«¯ Web ä¸Šæ— æ³•å»ºç«‹è¿æ¥ã€‚</p>\n <figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">grant</span> <span class=\"keyword\">all</span> <span class=\"keyword\">on</span> Syslog.* <span class=\"keyword\">to</span> <span class=\"string\">'$&#123;SYSLOG_USER&#125;'</span>@<span class=\"string\">'$&#123;CNI_GATEWAY&#125;'</span> <span class=\"keyword\">identified</span> <span class=\"keyword\">by</span> <span class=\"string\">'$&#123;SYSLOG_PASS&#125;'</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>loganalyzer å®¹å™¨é•œåƒåŸºäº <code>Apache httpd server</code> æ„å»ºï¼Œå¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/Dockerfile-examples/tree/master/loganalyzer-viewer\" target=\"_blank\" rel=\"noopener\">æ­¤é“¾æ¥</a>ã€‚</p>\n</li>\n<li>loganalyzer é¡¹ç›®åŸºäº PHPï¼Œå¯ä½œä¸º MySQL æ•°æ®åº“æ£€ç´¢æ—¥å¿—æ•°æ®çš„ Web å‰ç«¯ã€‚</li>\n<li>MySQL å®¹å™¨ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼ˆå·æ˜ å°„ï¼‰æ—¶ï¼Œç”±äºä½¿ç”¨ Red Hat å®˜æ–¹é•œåƒï¼Œå¯åŠ¨å®¹å™¨æ—¶ä¸ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œ mysql å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œä½¿ç”¨ <strong>UID 27</strong> (mysql) è¿è¡Œï¼Œéœ€è®¾ç½®å®¿ä¸»æœºæ˜ å°„ç›®å½•çš„æ‰€æœ‰è€…ä¸æ‰€å±ç»„ï¼Œä¸æ›´æ”¹å°†æ— æ³•è¿è¡Œå®¹å™¨ã€‚    </li>\n<li>å®¹å™¨ä¸­æŠ¥é”™æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"mysql-container-run-error.jpg\" alt=\"mysql-container-run-error.jpg\"></li>\n<li>loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨éƒ¨ç½²æˆåŠŸä¸”æ­£å¸¸è¿è¡Œåï¼Œéœ€è®¿é—® loganalyzer å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹ä»¥å®Œæˆä¸¤è€…çš„å¯¹æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"loganalyzer-web-1.jpg\" alt=\"loganalyzer-web-1.jpg\"><img src=\"loganalyzer-web-2.jpg\" alt=\"loganalyzer-web-2.jpg\"><img src=\"loganalyzer-web-3.jpg\" alt=\"loganalyzer-web-3.jpg\"><img src=\"loganalyzer-web-4.jpg\" alt=\"loganalyzer-web-4.jpg\"><img src=\"loganalyzer-web-5.jpg\" alt=\"loganalyzer-web-5.jpg\"><img src=\"loganalyzer-web-6.jpg\" alt=\"loganalyzer-web-6.jpg\"><img src=\"loganalyzer-web-7.jpg\" alt=\"loganalyzer-web-7.jpg\"><img src=\"loganalyzer-web-8.jpg\" alt=\"loganalyzer-web-8.jpg\"><img src=\"loganalyzer-web-9.jpg\" alt=\"loganalyzer-web-9.jpg\"><img src=\"loganalyzer-web-10.jpg\" alt=\"loganalyzer-web-10.jpg\"></li>\n</ul>\n<h3 id=\"loganalyzer-çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\"><a href=\"#loganalyzer-çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\" class=\"headerlink\" title=\"loganalyzer çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\"></a>loganalyzer çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š</h3><ul>\n<li>loganalyzer ä¹Ÿå¯ç›´æ¥ä½¿ç”¨è§£å‹çš„å‹ç¼©åŒ…ï¼ˆPHP æºç ï¼‰å®ç°å®‰è£…ï¼Œæ–¹æ³•ä½äºéƒ¨ç½²è„šæœ¬çš„æœ€åæ³¨é‡Šéƒ¨åˆ†ã€‚</li>\n<li>SELinux ä¸º <code>enforcing</code> æ¨¡å¼æ—¶ï¼Œloganalyzer æ— æ³•ä¸ MySQL å®¹å™¨è¿æ¥ï¼Œéœ€æ‰“å¼€ PHP ä¸ MySQLçš„ç½‘ç»œè¿æ¥å¸ƒå°”å€¼ä»¥æ”¯æŒã€‚<img src=\"selinux-php-mysql-connection.jpg\" alt=\"selinux-php-mysql-connection.jpg\"></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼šRed Hat Enterprise Linux 8.2 (Ootpa)</li>\n<li>Podman ç‰ˆæœ¬ï¼špodman-1.9.3-2.module+el8.2.1+6867+366c07d6.x86_64</li>\n<li>loganalyzer ç‰ˆæœ¬ï¼šloganalyzer-4.1.11.tar.gz</li>\n<li>è¯¥ç¤ºä¾‹ä¸­ä½¿ç”¨ yum å®‰è£…çš„è½¯ä»¶åŒ…è‹¥æœªæŒ‡å®šç‰¹å®šç‰ˆæœ¬å‡ä¸ºç³»ç»Ÿè‡ªå¸¦è½¯ä»¶åŒ…ã€‚</li>\n</ul>\n<h3 id=\"æ¶æ„ç¤ºä¾‹ï¼š\"><a href=\"#æ¶æ„ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"æ¶æ„ç¤ºä¾‹ï¼š\"></a>æ¶æ„ç¤ºä¾‹ï¼š</h3><p><img src=\"loganalyzer-mysql-rsyslogserver.jpg\" alt=\"loganalyzer-mysql-rsyslogserver.jpg\"><br>å¦‚å›¾æ‰€ç¤ºï¼Œ<code>rsyslog-server</code> æœåŠ¡ç«¯æ”¶é›†æ¥è‡ª <code>rsyslog-client</code> å®¢æˆ·ç«¯å‘é€çš„æŒ‡å®šç³»ç»Ÿæ—¥å¿—æ•°æ®ï¼Œå¹¶ä¸” Apache httpd server ä¸ MySQL æ•°æ®åº“å‡ä»¥å®¹å™¨çš„æ–¹å¼ä¸€åŒéƒ¨ç½²äºæœåŠ¡ç«¯ã€‚</p>\n<h3 id=\"loganalyzer-ä¸-MySQL-çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\"><a href=\"#loganalyzer-ä¸-MySQL-çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\" class=\"headerlink\" title=\"loganalyzer ä¸ MySQL çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š\"></a>loganalyzer ä¸ MySQL çš„å®¹å™¨åŒ–éƒ¨ç½²è¦ç‚¹ï¼š</h3><ul>\n<li>éƒ¨ç½²ç”¨ <code>Shell</code> è„šæœ¬å¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/deploy-rsyslog-viewer/deploy-rsyslog-viewer.sh\" target=\"_blank\" rel=\"noopener\">æ­¤é“¾æ¥</a>ã€‚</li>\n<li>éƒ¨ç½²ç”¨èŠ‚ç‚¹ï¼š<ul>\n<li>serverb.lab.example.com (RH294v8.0 course)ï¼š2 vCPUï¼Œ4GiB RAM</li>\n<li>firewalld æœåŠ¡å·²ç¦ç”¨   </li>\n<li>SELinux ä¸º enforcing æ¨¡å¼   </li>\n</ul>\n</li>\n<li>æ­¤æ¬¡ä½¿ç”¨ <strong><code>podman runtime</code></strong> å®¹å™¨è¿è¡Œæ—¶è¿è¡Œæ‰€æœ‰å®¹å™¨ã€‚</li>\n<li>è¯¥éƒ¨ç½²ç¯å¢ƒä¸­å·²é¢„é…ç½® <code>Red Hat Quay 3.3.0</code>ï¼Œå¹¶ä¸”å·²å°† <code>mysql-57-rhel7:latest</code> ä¸Šä¼ è‡³è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„ <code>rhscl organization</code> ä¸­ã€‚</li>\n<li>å°†å®¹å™¨é•œåƒä¸Šä¼ è‡³ Quay ä¸­ï¼Œéœ€æå‰åˆ›å»ºç›¸åº”çš„ organizaionï¼Œå¦åˆ™å°†ä¸Šä¼ å¤±è´¥æŠ¥é”™ï¼<br><img src=\"quay-push-error-1.jpg\" alt=\"quay-push-error-1..jpg\"><img src=\"quay-push-error-2.jpg\" alt=\"quay-push-error-2.jpg\"></li>\n<li>åŠ¡å¿…å…³é—­å¹¶ç¦ç”¨èŠ‚ç‚¹ <code>firewalld</code> æœåŠ¡ï¼Œè¯¥æœåŠ¡ä¸ <code>iptables NAT</code> è§„åˆ™å†²çªï¼Œåœ¨å¯ç”¨çš„æƒ…å†µä¸‹å°†æ— æ³•å®ç°å®¹å™¨çš„ç«¯å£æ˜ å°„ï¼Œiptables NAT è§„åˆ™æ— æ³•å»ºç«‹ï¼</li>\n<li><p>ç”±äº loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨å‡ä½äºåŒä¸€èŠ‚ç‚¹ä¸Šï¼Œä¸”å®¹å™¨é€šè¿‡ <code>CNI bridge</code> (cni-podman0) è¿æ¥ï¼Œå› æ­¤ loganalyzer è¿æ¥ MySQL æ—¶åº”ä½¿ç”¨èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œä½† MySQL å¯¹æŒ‡å®šç”¨æˆ·çš„æˆæƒè¯­å¥åº”ä½¿ç”¨ <code>CNI Gateway</code> çš„ IP åœ°å€ï¼Œå¦åˆ™åœ¨å‰ç«¯ Web ä¸Šæ— æ³•å»ºç«‹è¿æ¥ã€‚</p>\n <figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">grant</span> <span class=\"keyword\">all</span> <span class=\"keyword\">on</span> Syslog.* <span class=\"keyword\">to</span> <span class=\"string\">'$&#123;SYSLOG_USER&#125;'</span>@<span class=\"string\">'$&#123;CNI_GATEWAY&#125;'</span> <span class=\"keyword\">identified</span> <span class=\"keyword\">by</span> <span class=\"string\">'$&#123;SYSLOG_PASS&#125;'</span>;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>loganalyzer å®¹å™¨é•œåƒåŸºäº <code>Apache httpd server</code> æ„å»ºï¼Œå¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/Dockerfile-examples/tree/master/loganalyzer-viewer\" target=\"_blank\" rel=\"noopener\">æ­¤é“¾æ¥</a>ã€‚</p>\n</li>\n<li>loganalyzer é¡¹ç›®åŸºäº PHPï¼Œå¯ä½œä¸º MySQL æ•°æ®åº“æ£€ç´¢æ—¥å¿—æ•°æ®çš„ Web å‰ç«¯ã€‚</li>\n<li>MySQL å®¹å™¨ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼ˆå·æ˜ å°„ï¼‰æ—¶ï¼Œç”±äºä½¿ç”¨ Red Hat å®˜æ–¹é•œåƒï¼Œå¯åŠ¨å®¹å™¨æ—¶ä¸ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œ mysql å®ˆæŠ¤è¿›ç¨‹ï¼Œè€Œä½¿ç”¨ <strong>UID 27</strong> (mysql) è¿è¡Œï¼Œéœ€è®¾ç½®å®¿ä¸»æœºæ˜ å°„ç›®å½•çš„æ‰€æœ‰è€…ä¸æ‰€å±ç»„ï¼Œä¸æ›´æ”¹å°†æ— æ³•è¿è¡Œå®¹å™¨ã€‚    </li>\n<li>å®¹å™¨ä¸­æŠ¥é”™æ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"mysql-container-run-error.jpg\" alt=\"mysql-container-run-error.jpg\"></li>\n<li>loganalyzer å®¹å™¨ä¸ MySQL å®¹å™¨éƒ¨ç½²æˆåŠŸä¸”æ­£å¸¸è¿è¡Œåï¼Œéœ€è®¿é—® loganalyzer å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹ä»¥å®Œæˆä¸¤è€…çš„å¯¹æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"loganalyzer-web-1.jpg\" alt=\"loganalyzer-web-1.jpg\"><img src=\"loganalyzer-web-2.jpg\" alt=\"loganalyzer-web-2.jpg\"><img src=\"loganalyzer-web-3.jpg\" alt=\"loganalyzer-web-3.jpg\"><img src=\"loganalyzer-web-4.jpg\" alt=\"loganalyzer-web-4.jpg\"><img src=\"loganalyzer-web-5.jpg\" alt=\"loganalyzer-web-5.jpg\"><img src=\"loganalyzer-web-6.jpg\" alt=\"loganalyzer-web-6.jpg\"><img src=\"loganalyzer-web-7.jpg\" alt=\"loganalyzer-web-7.jpg\"><img src=\"loganalyzer-web-8.jpg\" alt=\"loganalyzer-web-8.jpg\"><img src=\"loganalyzer-web-9.jpg\" alt=\"loganalyzer-web-9.jpg\"><img src=\"loganalyzer-web-10.jpg\" alt=\"loganalyzer-web-10.jpg\"></li>\n</ul>\n<h3 id=\"loganalyzer-çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\"><a href=\"#loganalyzer-çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\" class=\"headerlink\" title=\"loganalyzer çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š\"></a>loganalyzer çš„å¸¸è§„éƒ¨ç½²è¦ç‚¹ï¼š</h3><ul>\n<li>loganalyzer ä¹Ÿå¯ç›´æ¥ä½¿ç”¨è§£å‹çš„å‹ç¼©åŒ…ï¼ˆPHP æºç ï¼‰å®ç°å®‰è£…ï¼Œæ–¹æ³•ä½äºéƒ¨ç½²è„šæœ¬çš„æœ€åæ³¨é‡Šéƒ¨åˆ†ã€‚</li>\n<li>SELinux ä¸º <code>enforcing</code> æ¨¡å¼æ—¶ï¼Œloganalyzer æ— æ³•ä¸ MySQL å®¹å™¨è¿æ¥ï¼Œéœ€æ‰“å¼€ PHP ä¸ MySQLçš„ç½‘ç»œè¿æ¥å¸ƒå°”å€¼ä»¥æ”¯æŒã€‚<img src=\"selinux-php-mysql-connection.jpg\" alt=\"selinux-php-mysql-connection.jpg\"></li>\n</ul>\n"},{"title":"Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ1ï¼‰","subtitle":"Podman Architecture and Usage (1)","header-img":"podman-bg.webp","date":"2022-12-05T05:01:29.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- å®éªŒç”¨ OS ç‰ˆæœ¬ï¼š  \n  - CentOS 7.9ã€RHEL 8.0ã€RHEL 8.2ã€Ubuntu 20.04.3 LTS\n- å®éªŒç”¨ kernel ç‰ˆæœ¬ï¼š  \n  - 3.10.0-1160.41.1.el7.x86_64  \n  - 4.18.0-193.el8.x86_64  \n  - 5.14.0-1.el7.elrepo.x86_64\n- å®éªŒç”¨ Podman ç‰ˆæœ¬ï¼š1.6.4ã€3.2.3ã€3.3.1\n- å®éªŒç”¨ podman-compose ç‰ˆæœ¬ï¼š0.1.8\n- å®éªŒç”¨ Docker ç‰ˆæœ¬ï¼š20.10.8\n- è‹¥æœªåšç‰¹æ®Šè¯´æ˜ï¼Œä»¥ä¸‹ç¤ºä¾‹å‡äº `RHEL 8.2`ï¼ˆ`4.18.0-193.el8.x86_64`ï¼‰ä¸Šæ‰§è¡Œï¼ŒPodman ç‰ˆæœ¬ä¸º `3.2.3`ã€‚\n- è¯¥æ–‡æ¡£ä¸­æœªæ¶‰åŠ podman å‘½ä»¤çš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ï¼Œå¯å‚é˜… [è¯¥æ–‡æ¡£](https://mp.weixin.qq.com/s/MDi4RB5V60EGl3ii9usD0Q) åŠ ä»¥ç†Ÿæ‚‰ã€‚\n- ğŸ’¥ é‡è¦æç¤ºï¼šPodman é¡¹ç›®æ­£åœ¨ä¸æ–­æ¼”è¿›ä¸å®Œå–„ä¸­ï¼Œè¯·ä»¥è‡ªèº«ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºå‡†è¿›è¡Œæµ‹è¯•ä¸ä½¿ç”¨ï¼\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Podman çš„ç‰¹æ€§æ¦‚è¿°\n- Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒ\n- Podman çš„æ‰©å±•åŠŸèƒ½\n- Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…\n- Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒ\n- Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰\n- Podman çš„ macvlan ç½‘ç»œå®ç°\n- Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼\n- å‚è€ƒé“¾æ¥\n\n### Podman çš„ç‰¹æ€§æ¦‚è¿°ï¼š\n- LXCã€`LXD`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ã€`systemd-nspawn` å‡å¯ä½œä¸º Linux å®¹å™¨ï¼Œä½†ç¼ºå°‘å®¹å™¨è·¨ä¸»æœºè¿è¡Œä¸åº”ç”¨æ‰“åŒ…çš„èƒ½åŠ›ã€‚\n- Docker ä¸ Podman å¯ä½¿ç”¨å®¹å™¨é•œåƒå®ç°åº”ç”¨æ‰“åŒ…å‘å¸ƒï¼Œå¿«é€Ÿä¸”è½»é‡ã€‚\n- Docker ä¸ Podman éƒ½ä½¿ç”¨ `runC`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸ºåº•å±‚ `oci-runtime`ã€‚\n- Docker ä¸ Podman éƒ½æ”¯æŒ `OCI Image Format`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ï¼Œéƒ½èƒ½ä½¿ç”¨ DockerHub ä¸Šçš„å®¹å™¨é•œåƒï¼Œè€Œ systemd-nspawn æ— æ³•ä½¿ç”¨å®ƒä»¬çš„é•œåƒã€‚\n- ğŸ‘‰ Podman ä½¿ç”¨ `CNI`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸º rootfull å®¹å™¨ç½‘ç»œåº•å±‚ï¼Œå®ç°æ¯” Docker ç½‘ç»œå±‚ç•¥å¾®ç®€å•ä½†åŸç†ç›¸åŒã€‚\n- ç›¸å¯¹äº LXD ä¸ systemd-nspawnï¼ŒCNI å¯ä»¥é¿å…ç¼–å†™å¤§é‡çš„ç½‘ç»œè§„åˆ™ã€‚\n- ğŸš€ ä¸ºäº†å®ç°æ™®é€šç”¨æˆ· rootless å®¹å™¨ç½‘ç»œï¼ŒPodman å¯ä»¥ä½¿ç”¨ `slirp4netns` ç¨‹åºï¼Œé¿å… `kernel space` ä¸­çš„å¤§é‡ `veth pair` è™šæ‹Ÿæ¥å£çš„å‡ºç°, å¹¶ä¸”æ€§èƒ½æ›´å¥½ã€‚\n- Docker è¿è¡Œå®¹å™¨å¿…é¡»ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸”ä½¿ç”¨ root æƒé™ï¼Œå­˜åœ¨ç³»ç»Ÿå®‰å…¨é—®é¢˜ï¼Œè€Œ Podman é’ˆå¯¹æ­¤é—®é¢˜ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªç‰¹æ€§åŠ ä»¥è§£å†³ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - Podman æ”¯æŒæ— å®ˆæŠ¤è¿›ç¨‹ï¼ˆ`no-daemon`ï¼‰è¿è¡Œå®¹å™¨ã€‚  \n  - Podman æ”¯æŒæ™®é€šç”¨æˆ·è¿è¡Œ `rootless` å®¹å™¨ï¼Œå³ï¼Œæ™®é€šç”¨æˆ·ç›´æ¥è¿è¡Œå®¹å™¨æ— éœ€ææƒå…·æœ‰ root æƒé™ã€‚\n- è™½ç„¶ Docker ä¸ Podman çš„å®ç°åŸç†ä¸åŒï¼Œä½†å¯¹äºä½¿ç”¨è€…è€Œè¨€å…¶ CLI ååˆ†ç›¸ä¼¼ï¼Œå¯å¹³æ»‘åœ°ä» Docker è¿‡æ¸¡è‡³ Podmanã€‚\n- Podman çš„ç›®æ ‡ä¸æ˜¯å®¹å™¨çš„ç¼–æ’ï¼Œç¼–æ’å¯ä»¥ä½¿ç”¨æ›´åŠ ä¸“ä¸šçš„ Kubernetesã€Open Shiftã€Rancher ç­‰ï¼Œä½¿ç”¨ Podman å¯ä»¥æ›´è½»é‡çš„è¿è¡Œå®¹å™¨ä¸”ä¸å— root æƒé™çš„å®‰å…¨é—®é¢˜ï¼Œå³ä¾¿æ˜¯ root ç”¨æˆ·ä¹Ÿæ— æ³•æŸ¥çœ‹å…¶å®ƒæ™®é€šç”¨æˆ·ç©ºé—´ä¸‹çš„å®¹å™¨ï¼ŒPodman é€šè¿‡ `user namespace` è¿›è¡Œéš”ç¦»ã€‚\n- ğŸ‘‰ Podman å¯ä½¿ç”¨ `systemd service` å•å…ƒæ–‡ä»¶ç›´æ¥ç®¡ç†å®¹å™¨ï¼Œå®ç°å®¹å™¨æœåŠ¡éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ã€‚\n- ğŸ‘‰ Podman é‡Œé›†æˆäº† `CRIU`ï¼Œå› æ­¤ Podman ä¸­çš„å®¹å™¨å¯ä»¥åœ¨å•æœºä¸Šçƒ­è¿ç§»ã€‚\n- ç”±äº Kubernetes å°†ä» `v1.24.x` ç‰ˆæœ¬åæ”¾å¼ƒä½¿ç”¨ `dockershim` æ¥å£å±‚ï¼Œå®¹å™¨è¿è¡Œæ—¶å¯é€‰æ‹©ä½¿ç”¨ `Containerd` æˆ–è€… `CRI-O`ï¼Œä¸¤è€…è™½ç„¶å‡æ”¯æŒ OCI image è§„èŒƒï¼Œä½†å®ƒä»¬ä¸æ˜¯é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…ç›´æ¥ç®¡ç†å®¹å™¨æˆ–é•œåƒçš„å·¥å…·ï¼Œè€Œ Podman å¯ç›´æ¥é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…æ“ä½œå®¹å™¨æˆ–é•œåƒã€‚\n- Podman å‘½ä»¤çš„å­è¿›ç¨‹åˆ›å»º pod ä¸å®¹å™¨ã€‚\n\n### Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\n- Podman ç‰ˆæœ¬ã€kernel ç‰ˆæœ¬ä¸ OS ç‰ˆæœ¬çš„å…¼å®¹æ€§å°†ç›´æ¥å½±å“æ™®é€šç”¨æˆ·ä½¿ç”¨ rootless å®¹å™¨ã€‚\n- å¦‚ä¸‹æ‰€ç¤ºï¼Œkernel ä¸æ”¯æŒ rootless å®¹å™¨ï¼š  \n  ![centos79-kernel-not-support-podman-rootless.jpg](centos79-kernel-not-support-podman-rootless.jpg)\n\n- æ™®é€šç”¨æˆ· rootless å®¹å™¨å…¼å®¹æ€§æ¯”è¾ƒï¼š\n  ![podman-version-compare.png](podman-version-compare.png)\n\n  > ğŸ“Œ**æ³¨æ„ï¼š**\n  > \n  > rootless å®¹å™¨ç‰¹æ€§å–å†³äº kernel çš„ç‰ˆæœ¬ï¼Œä¸å–å†³äº OS ä¸ Podman çš„ç‰ˆæœ¬ã€‚\n\n  - ç”±äº `user namespace` ç‰¹æ€§åœ¨ kernel `4.9.0` ä¹‹åå‡ºç°ï¼Œå› æ­¤å‡çº§ kernel å³å¯è§£å†³ rootless é—®é¢˜ã€‚\n  - å…³äº rootless ç‰¹æ€§åœ¨ RHEL 8 ä¸­çš„è®¾ç½®ï¼Œå¯ [ç‚¹å‡»æ­¤å¤„](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/assembly_starting-with-containers_building-running-and-managing-containers#proc_setting-up-rootless-containers_assembly_starting-with-containers) å‚è€ƒ Red Hat çš„å®˜æ–¹é…ç½®è¯´æ˜ã€‚\n\n### Podman çš„æ‰©å±•åŠŸèƒ½ï¼š\n- `cockpit-podman` è½¯ä»¶åŒ…ä½œä¸º cockpit æ’ä»¶å¯é›†æˆäº `Web UI` ä¸­ï¼Œå®ç° Web UI ç®¡ç†å®¹å™¨ã€‚  \n  - cockpit-podman æœåŠ¡å®‰è£…ä¸å¯ç”¨ï¼š    \n    ```bash\n    $ sudo yum install -y cockpit-podman\n    $ sudo systemctl enable --now cockpit.socket\n    $ sudo systemctl status cockpit.service\n    # å®‰è£… cockpit-podman è½¯ä»¶åŒ…ï¼Œå¹¶å¯ç”¨ cockpit æœåŠ¡ã€‚\n    $ sudo netstat -tunlp | grep 9090\n    # æŸ¥çœ‹ systemd ç›‘å¬çš„ 9090 ç«¯å£æ˜¯å¦å¯ç”¨\n    ```\n  - åœ¨ Web UI ä¸­å¯æŸ¥çœ‹å¹¶ç®¡ç† podman å®¹å™¨ä¸é•œåƒï¼š    \n    ![podman-arch-usage/cockpit-podman-1.jpg](cockpit-podman-1.jpg)![cockpit-podman-2.jpg](cockpit-podman-2.jpg)\n- `podman-compose` æ—¨åœ¨ä½¿ç”¨æ›´è½»é‡çš„æ–¹å¼å®ç°`å•æœºå®¹å™¨ç¼–æ’`ï¼Œä»¥ç”¨äºæ›¿æ¢ `docker-compose`ï¼Œè¿™ç§æ–¹å¼å°†ä¸å†ä¾èµ–å®ˆæŠ¤è¿›ç¨‹ä¸ root æƒé™ï¼ŒåŒæ—¶å¯ä½¿ç”¨ rootless å®¹å™¨ï¼Œè¯¦ç»†ç¤ºä¾‹è§ä¸‹æ–‡ã€‚\n- podman-compose ä½¿ç”¨ `Python` å¼€å‘ï¼Œå› æ­¤å¯ç›´æ¥ä½¿ç”¨ `pip3` å®‰è£…è¯¥ç»„ä»¶ï¼Œæˆ–ä½¿ç”¨ rpm è½¯ä»¶åŒ…æ–¹å¼å®‰è£…ã€‚\n- ç”±äº podman-compose ä¾ç„¶å¤„äº `dev` é˜¶æ®µï¼Œä»…ä½œä¸ºåŠŸèƒ½æµ‹è¯•ä½¿ç”¨ï¼Œæš‚æœªå—åˆ° GA ç¯å¢ƒæ”¯æŒã€‚\n\n### Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\n- CentOS 7.x/8.x æˆ– RHEL 7.x/8.x ä¸­ï¼šyum å‘½ä»¤ä½¿ç”¨ podman `rpm` è½¯ä»¶åŒ…å®‰è£…  \n  ```bash\n  $ sudo yum install -y podman-3.2.3-0.11.module_el8.4.0+942+d25aada8.x86_64\n  # å®‰è£… podman æœ€æ–°ç‰ˆæœ¬ï¼Œä½ç‰ˆæœ¬ podman å­˜åœ¨è¾ƒå¤š bugã€‚\n  # æ³¨æ„ï¼š\n  #   1. éœ€é…ç½® CentOS 8 çš„ yum è½¯ä»¶æºä»¥å®‰è£…æœ€æ–°ç‰ˆçš„ podman åŠå…¶ä¾èµ–è½¯ä»¶åŒ…\n  #   2. yum å®‰è£… podman æ—¶ä¹Ÿå°†å®‰è£… containernetworking-plugins è½¯ä»¶åŒ…\n  ```\n- ğŸ¤˜ Ubuntu 20.04.2 LTS ä¸­ï¼šapt-get å‘½ä»¤ä½¿ç”¨ podman `deb` è½¯ä»¶åŒ…å®‰è£…  \n  ```bash\n$ . /etc/os-release\n# æŸ¥çœ‹å½“å‰çš„ç³»ç»Ÿå‘è¡Œç‰ˆ\n$ echo \"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/ /\" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list\n$ curl -L \"https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/Release.key\" | sudo apt-key add -\n# æ·»åŠ  podman è½¯ä»¶æºä¸ apt å…¬é’¥\n$ sudo apt-get update -y\n$ sudo apt-get upgrade -y\n# æ›´æ–°ç³»ç»Ÿè½¯ä»¶æºå¹¶å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…\n$ sudo apt-get install -y podman\n  Reading package lists... Done\n  Building dependency tree       \n  Reading state information... Done\n  ...\n  The following NEW packages will be installed:\n    catatonit conmon containernetworking-plugins containers-common criu crun fuse-overlayfs fuse3 libfuse3-3 libnet1 libprotobuf-c1\n    podman podman-machine-cni podman-plugins\n  ...\n# å®‰è£… podman ä¸ç›¸å…³çš„è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ conmonã€containernetworking-pluginsã€crun ç­‰ã€‚  \n  ```\n  å®‰è£…å‚è€ƒé“¾æ¥ï¼š  \n  - [Podman Doc - installation](https://podman.io/getting-started/installation)\n  - [Easy to Install Podman on Ubuntu 20.04](https://www.hostnextra.com/kb/easy-to-install-podman-on-ubuntu-20-04/)\n  - [podman from devel:kubic:libcontainers:stable project](https://software.opensuse.org//download.html?project=devel%3Akubic%3Alibcontainers%3Astable&package=podman)\n\n### ğŸ¤˜ Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\n- Docker v20.10.8 ä½¿ç”¨ `dockerd` ä¸ `containerd` å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å®¹å™¨ä¸é•œåƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿è¡ŒçŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š \n  ```bash\n  $ sudo systemctl status docker.service\n  â— docker.service - Docker Application Container Engine\n     Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)\n     Active: active (running) since Wed 2022-10-19 10:53:04 CST; 6min ago\n       Docs: https://docs.docker.com\n   Main PID: 79556 (dockerd)\n      Tasks: 21\n     Memory: 42.6M\n     CGroup: /system.slice/docker.service\n             â”œâ”€79556 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n             â”œâ”€79677 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 4000 -container-ip 172.17.0.2 -container-port 4000\n             â””â”€79683 /usr/bin/docker-proxy -proto tcp -host-ip :: -host-port 4000 -container-ip 172.17.0.2 -container-port 4000\n  \n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.197803867+08:00\" level=info msg=\"scheme \\\"unix\\\" not registered, fallback to default scheme\" module=grpc\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.197837924+08:00\" level=info msg=\"ccResolverWrapper: sending update to cc: {[{unix:///run/containerd/containerd.sock  <nil> 0 <nil>}] <nil> <nil>}\" module=grpc\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.197860326+08:00\" level=info msg=\"ClientConn switching balancer to \\\"pick_first\\\"\" module=grpc\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.220416627+08:00\" level=info msg=\"Loading containers: start.\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.347884960+08:00\" level=info msg=\"Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.725361851+08:00\" level=info msg=\"Loading containers: done.\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.755449128+08:00\" level=info msg=\"Docker daemon\" commit=75249d8 graphdriver(s)=overlay2 version=20.10.8\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.755527994+08:00\" level=info msg=\"Daemon has completed initialization\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com systemd[1]: Started Docker Application Container Engine.\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.776865058+08:00\" level=info msg=\"API listen on /var/run/docker.sock\"\n  # dockerd å®ˆæŠ¤è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€\n  \n  $ sudo systemctl status containerd\n  â— containerd.service - containerd container runtime\n     Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled)\n     Active: active (running) since Tue 2022-10-18 15:08:06 CST; 20h ago\n       Docs: https://containerd.io\n   Main PID: 1892 (containerd)\n      Tasks: 20\n     Memory: 103.4M\n     CGroup: /system.slice/containerd.service\n             â”œâ”€ 1892 /usr/bin/containerd\n             â””â”€79696 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock\n  # containerd é€šè¿‡è°ƒç”¨ containerd-shim-runc-v2 è¿è¡ŒæŒ‡å®šå®¹å™¨\n  $ sudo ps -ef | grep -E \"dockerd|containerd|containerd-shim-runc-v2\"\n    root       1892      1  0 Oct18 ?        00:05:01 /usr/bin/containerd\n    root      79556      1  0 10:53 ?        00:00:03 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n    root      79696      1  0 10:53 ?        00:00:01 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock\n  # PID 79696 ä¸ºå®é™…çš„å®¹å™¨è¿è¡Œè¿›ç¨‹\n  ```\n- Podman ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œæˆ–ç®¡ç†å®¹å™¨ï¼Œå¯¹äº rootfull å®¹å™¨æˆ– rootless å®¹å™¨çš„è¿è¡Œæ–¹å¼å­˜åœ¨å·®å¼‚ï¼š  \n  - rootfull å®¹å™¨çš„è¿›ç¨‹ï¼š    \n    ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n    $ sudo ps -ef | egrep \"podman|slirp4netns|conmon\"\n      root        3879    3476  1 06:31 pts/3    00:00:00 podman run -it --name=mydebian docker.io/library/debian:latest /bin/sh\n      root        3945       1  0 06:31 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -u 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata -p /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/pidfile -n mydebian --exit-dir /run/libpod/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/oci-log -t --conmon-pidfile /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg cni --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt=nodev,metacopy=on --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba\n    # ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹\n    ```\n    ğŸ‘‰ ä»¥ `detach` æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n    $ sudo ps -ef | egrep \"podman|slirp4netns|conmon\"\n      root        3744       1  0 06:25 ?        00:00:00 /usr/bin/conmon --api-version 1 -c b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -u b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata -p /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/pidfile -n apache-rhce8.2-alpine --exit-dir /run/libpod/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/oci-log --conmon-pidfile /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg cni --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt=nodev,metacopy=on --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272\n    # podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œè€Œ rootfull å®¹å™¨çš„ CNI æ’ä»¶\n    # å¯ç›´æ¥ä½¿ç”¨ iptables çš„æ–¹å¼å®ç°ã€‚\n    ```\n  - rootless å®¹å™¨çš„è¿›ç¨‹ï¼š    \n    ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š\n    ```bash\n    $ ps -ef | egrep \"podman|slirp4netns|conmon\"\n      core        3418    2762  0 06:17 pts/2    00:00:05 podman run -it --name=mybusybox docker.io/library/busybox:latest /bin/sh\n      core        3430    3418  0 06:17 pts/2    00:00:00 /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp --enable-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-19eb5630-c0a8-4ea9-8790-76ecdcdf2dbc tap0\n      core        3433       1  0 06:17 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -u 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -r /usr/bin/crun -b /var/home/core/.local/share/containers/storage/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata -p /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/pidfile -n mybusybox --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/oci-log -t --conmon-pidfile /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/home/core/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg netavark --exit-command-arg --volumepath --exit-command-arg /var/home/core/.local/share/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160\n    # ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹ï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹\n    # ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚\n    ``` \n    ğŸ‘‰ ä»¥ `detach` æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š   \n    ```bash\n    $ ps -ef | egrep \"podman|slirp4netns|conmon\"\n      core        3308       1  0 06:15 pts/2    00:00:00 /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp --enable-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-f9f6f9dd-bf80-f6ca-6f39-7c9d9cd6beea tap0\n      core        3325       1  0 06:15 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -u 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -r /usr/bin/crun -b /var/home/core/.local/share/containers/storage/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata -p /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/pidfile -n apache-rhce8.2-alpine --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/oci-log --conmon-pidfile /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/home/core/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg netavark --exit-command-arg --volumepath --exit-command-arg /var/home/core/.local/share/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab\n    # podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹\n    # ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚\n    ```\n\n### Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰ï¼š\n- Podman æ”¯æŒçš„å®¹å™¨ç½‘ç»œæ¨¡å¼å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ![podman-network-mode.jpg](podman-network-mode.jpg)\n- root ç”¨æˆ·è¿è¡Œ rootfull å®¹å™¨ç½‘ç»œåˆ†æï¼š  \n  - é»˜è®¤æƒ…å†µä¸‹ï¼Œrootfull å®¹å™¨ä½¿ç”¨ bridge ç½‘ç»œæ¨¡å¼ï¼Œå¹¶ä¸”åœ¨æœªåˆ›å»ºä»»ä½•å®¹å™¨å‰ç³»ç»Ÿä¸Šä¸ä¼šè‡ªåŠ¨åˆ›å»º `cni-podman0 `ç½‘æ¡¥ï¼Œåªæœ‰åˆ›å»ºå®¹å™¨åè‡ªåŠ¨ç”Ÿæˆã€‚  \n  - root ç”¨æˆ·ä½¿ç”¨å…¨å±€èŒƒå›´å†…çš„ CNI æ’ä»¶ï¼Œpodman é»˜è®¤ä½¿ç”¨ `bridge`ã€`portmap` æ’ä»¶ï¼Œå…¶é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š    \n    ```bash\n    $ cat /etc/cni/net.d/87-podman-bridge.conflist\n    {\n      \"cniVersion\": \"0.4.0\",\n      \"name\": \"podman\",\n      \"plugins\": [\n        {\n          \"type\": \"bridge\",\n          \"bridge\": \"cni-podman0\",\n          \"isGateway\": true,\n          \"ipMasq\": true,\n          \"hairpinMode\": true,\n          \"ipam\": {\n            \"type\": \"host-local\",\n            \"routes\": [{ \"dst\": \"0.0.0.0/0\" }],\n            \"ranges\": [\n              [\n                {\n                  \"subnet\": \"10.88.0.0/16\",\n                  \"gateway\": \"10.88.0.1\"\n                }\n              ]\n            ]\n          }\n        },\n        {\n          \"type\": \"portmap\",\n          \"capabilities\": {\n            \"portMappings\": true\n          }\n        },\n        {\n          \"type\": \"firewall\"\n        },\n        {\n          \"type\": \"tuning\"\n        }\n      ]\n    # è¯¥é…ç½®æ–‡ä»¶ä½äº Podman æºç  cni/87-podman-bridge.conflist\n    # Podman å¯è°ƒç”¨ bridgeã€portmap ç­‰ CNI æ’ä»¶\n    \n    $ sudo podman inspect <container_name> | jq .[0].HostConfig.NetworkMode\n      \"bridge\"\n    # root ç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼\n    ```\n  - root ç”¨æˆ·åˆ›å»ºå…·æœ‰ç«¯å£æ˜ å°„çš„å®¹å™¨æ—¶ï¼Œiptables filter è¡¨ä¸ nat è¡¨è§„åˆ™å°†ç›¸åº”å¢åŠ ï¼š    \n    ```bash\n    # ----- filter è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----\n    *filter\n    -A FORWARD -m comment --comment \"CNI firewall plugin rules\" -j CNI-FORWARD\n    -A CNI-FORWARD -m comment --comment \"CNI firewall plugin admin overrides\" -j CNI-ADMIN\n    -A CNI-FORWARD -d 10.88.0.3/32 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n    # æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘ç›®æ ‡åœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œconntrack æ¨¡å—è¿›è¡Œè¿æ¥çŠ¶æ€è¿½è¸ªã€‚\n    # å½“å®¹å™¨é€šè¿‡ MASQUERADE å¯¹å¤–è®¿é—®ï¼Œå›åŒ…å†æ¬¡è¿›å…¥å®¹å™¨å®¿ä¸»æœºæ—¶ä¸å†é€šè¿‡ DNAT è½¬å‘ï¼Œè€Œé€šè¿‡ conntrack \n    # è®°å½•çš„è¿æ¥çŠ¶æ€ç›´æ¥è½¬å‘è‡³è¯¥è§„åˆ™å¹¶é€šè¿‡ cni-podman0 ç½‘æ¡¥è¿›å…¥å®¹å™¨ã€‚\n    -A CNI-FORWARD -s 10.88.0.3/32 -j ACCEPT\n    # æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘æºåœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆå‡ºå®¹å™¨çš„æµé‡ï¼‰ã€‚\n    \n    # ----- nat è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----\n    *nat\n    -A PREROUTING -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT\n    -A POSTROUTING -m comment --comment \"CNI portfwd requiring masquerade\" -j CNI-HOSTPORT-MASQ\n    -A POSTROUTING -s 10.88.0.3/32 -m comment --comment \"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -j CNI-b6c5fb6c593e895d843cb5bd\n    # æ–°å¢è§„åˆ™ï¼šæ¥è‡ªäº 10.88.0.3 å®¹å™¨çš„æµé‡è½¬å‘è‡³ CNI-b6c5fb6c593e895d843cb5bd é“¾\n    -A OUTPUT -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT\n    # å¯ç”¨ CNI åå³åˆ›å»ºçš„è§„åˆ™ï¼Œè¯¥è§„åˆ™æ¥æ”¶æ¥è‡ªæœ¬åœ°åº”ç”¨çš„æµé‡å¹¶è½¬å‘è‡³ CNI-HOSTPORT-DNAT é“¾\n    -A CNI-HOSTPORT-SETMARK -m comment --comment \"CNI portfwd masquerade mark\" -j MARK --set-xmark 0x2000/0x2000\n    -A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE\n    ### ä»¥ä¸‹ 6 æ¡åœ¨åˆ›å»ºæ–°å®¹å™¨æ—¶åŒæ—¶åˆ›å»º \n    -A CNI-HOSTPORT-DNAT -p tcp -m comment --comment \"dnat name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -m multiport --dports 8843 -j CNI-DN-b6c5fb6c593e895d843cb\n    # è‡ªå®šä¹‰ DNAT é“¾ï¼Œå‘é€è‡³æœ¬åœ° 8843 ç«¯å£çš„æµé‡è½¬å‘è‡³ CNI-DN-b6c5fb6c593e895d843cb é“¾ã€‚\n    -A CNI-b6c5fb6c593e895d843cb5bd -d 10.88.0.0/16 -m comment --comment \"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -j ACCEPT\n    # å…è®¸è½¬å‘ç›®æ ‡ç½‘æ®µä¸º 10.88.0.0/16 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œè¯¥ç½‘æ®µä¸ºå®¹å™¨æ‰€åœ¨çš„ç½‘ç»œã€‚\n    -A CNI-b6c5fb6c593e895d843cb5bd ! -d 224.0.0.0/4 -m comment --comment \"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -j MASQUERADE\n    # MASQUERADE å‡ºå®¹å™¨æµé‡\n    -A CNI-DN-b6c5fb6c593e895d843cb -s 10.88.0.0/16 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK\n    -A CNI-DN-b6c5fb6c593e895d843cb -s 127.0.0.1/32 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK\n    -A CNI-DN-b6c5fb6c593e895d843cb -p tcp -m tcp --dport 8843 -j DNAT --to-destination 10.88.0.3:443\n    # è‡ªå®šä¹‰ DNAT é“¾å®ç°å®¹å™¨å®¿ä¸»æœºè‡³å®¹å™¨çš„ç«¯å£æ˜ å°„\n    ```\n  - ğŸš€ ç¤ºä¾‹ï¼šå¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæ¶‰åŠçš„å®¿ä¸»æœº iptablesï¼š\n    ![external-access-container-web-service-iptables.jpg](external-access-container-web-service-iptables.jpg)ä»å¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæµé‡å°†é€šè¿‡ PREROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ`CNI-HOSTPORT-DNAT`ã€`CNI-DN-xxxx`ã€`DNAT`ï¼‰ï¼Œç»ç”± FORWARD é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ`CNI-FORWARD`ï¼‰çš„ä¸‰å±‚è½¬å‘ä¸ `cni-podman0` ç½‘æ¡¥çš„äºŒå±‚è½¬å‘è¿›å…¥å®¹å™¨ï¼Œå®¹å™¨å¯¹å¤–å“åº”çš„æµé‡å°†ç»è¿‡ cni-podman0 ç½‘æ¡¥è½¬å‘ï¼Œå¹¶ç»è¿‡ CNI-FORWARD é“¾ä¸ POSTROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ`CNI-HOSTPORT-MASQ`ï¼‰å‡ºå®¹å™¨å®¿ä¸»æœºã€‚  \n  - ğŸš€ ç¤ºä¾‹ï¼šç›´æ¥ä»å®¹å™¨å†…è®¿é—®å¤–éƒ¨æ—¶ï¼Œè¿”å›å®¹å™¨çš„å›åŒ…å°†ç›´æ¥ä½¿ç”¨ conntrack æ¨¡å—è¿½è¸ªçš„è¿æ¥çŠ¶æ€ï¼Œæµé‡é€šè¿‡ `CNI-FORWARD` é“¾çš„ä¸‰å±‚è½¬å‘ä¸ cni-podman0 çš„äºŒå±‚è½¬å‘è‡³å®¹å™¨ä¸­ï¼Œå³ï¼Œå›åŒ…è¿›å…¥å®¹å™¨å®¿ä¸»æœºä¸å†é€šè¿‡`CNI-HOSTPORT-DNAT`é“¾ã€‚    \n    å¦‚ä¸‹æ‰€ç¤ºï¼Œç›¸å…³çš„ DNAT é“¾æ— æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ï¼ŒCNI-FORWARD é“¾å‡æœ‰æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ã€‚    \n    ![container-access-external-iptables.jpg](container-access-external-iptables.jpg)\n    \n    > ğŸ“Œ **Kubernetes ç›¸å…³é—®é¢˜æç¤ºï¼š**\n    > \n    > 1. å®¹å™¨æˆ– pod é€šè¿‡ cni ç½‘æ¡¥æ¡¥æ¥çš„æ–¹å¼åœ¨ Kubernetes æˆ– OpenShift3 ä¸­éœ€åœ¨è®¡ç®—èŠ‚ç‚¹ï¼ˆworker nodeï¼‰ä¸Šé…ç½® `net.bridge.bridge-nf-call-iptables` ä¸ `net.bridge.bridge-nf-call-iptables6` å†…æ ¸å‚æ•°ï¼Œä½¿ cni äºŒå±‚ç½‘æ¡¥å¯è°ƒç”¨ iptables çš„ conntrack æ¨¡å—ï¼Œä»¥è§£å†³å‰åç«¯ pod åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šæ—¶ï¼Œç”±äº pod ç›´è¿ cni äºŒå±‚ç½‘æ¡¥ï¼Œè€ŒäºŒå±‚ç½‘æ¡¥åªå®ç°äºŒå±‚è½¬å‘ï¼Œæ— æ³•è¿½è¸ªå‰åç«¯çš„è¿æ¥çŠ¶æ€ï¼Œé€ æˆåç«¯ pod å‘å‰ç«¯ pod å›åŒ…æ—¶æ— æ³•å¤„äºåŒä¸€è¿æ¥é“¾è·¯çš„é—®é¢˜ï¼Œå¯ [ç‚¹å‡»æ­¤å¤„](https://imroc.cc/k8s/faq/why-enable-bridge-nf-call-iptables/) è·å¾—æ›´å¤šå¸®åŠ©ã€‚\n    > 2. ä½¿ç”¨ä»¥ä¸Šå†…æ ¸å‚æ•°æ—¶ï¼Œéœ€åŠ è½½ `br_netfilter` å†…æ ¸æ¨¡å—æ–¹èƒ½ç”Ÿæ•ˆã€‚\n  \n  - ä½¿ç”¨ `iperf3` å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ![rootfull-container-to-container-bandwidth.jpg](rootfull-container-to-container-bandwidth.jpg)\n- æ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ç½‘ç»œåˆ†æï¼š  \n  - `slirp4netns` ç¨‹åºæ”¯æŒ user rootless network namespaceï¼Œè€Œéé€šè¿‡ `iptables` ä¸ CNI å®ç°ã€‚  \n  - ğŸ‘‰ æ™®é€šç”¨æˆ·ä½¿ç”¨ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨å®¿ä¸»æœº 1024 ä»¥ä¸Šçš„ç«¯å£å®ç°æ˜ å°„ï¼Œä½†å¯ä½¿ç”¨ `net.ipv4.ip_unprivileged_port_start` å†…æ ¸å‚æ•°å®ç°ä½äº 1024 çš„ç«¯å£å¼€å§‹æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n### æ–¹å¼ 1ï¼š###\n$ sysctl -w net.ipv4.ip_unprivileged_port_start=80\n# ä¸´æ—¶é…ç½®ï¼šå…è®¸æ™®é€šç”¨æˆ·ä» 80 ç«¯å£å¼€å§‹çš„ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨\n    \n### æ–¹å¼ 2ï¼š###\n$ echo \"net.ipv4.ip_unprivileged_port_start=80\" >> /etc/sysctl.d/rootless.conf\n# æ°¸ä¹…é…ç½®ï¼šå°†è¯¥å†…æ ¸å‚æ•°å†™å…¥å†…æ ¸å‚æ•°é…ç½®æ–‡ä»¶ï¼Œä½¿å…¶å¼€æœºæ°¸ä¹…ç”Ÿæ•ˆã€‚\n$ sysctl -p\n# ä½¿é…ç½®çš„å†…æ ¸å‚æ•°ç”Ÿæ•ˆ\n\n - æ™®é€šç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼ä¸º `slirp4netns`ï¼ˆslirp4netns è½¯ä»¶åŒ…å®ç°ï¼‰ã€‚    \n    ```bash\n    $ podman inspect <container_name> | jq .[0].HostConfig.NetworkMode\n      \"slirp4netns\"\n    # æ™®é€šç”¨æˆ·åˆ›å»ºçš„ rootless å®¹å™¨ç½‘ç»œæ¨¡å¼\n    ```\n  - æ¯ä¸ªæ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨éƒ½å°†ç”Ÿæˆ slirp4netns è¿›ç¨‹ç”¨äºéš”ç¦»è¯¥ç”¨æˆ·çš„ `network namespace`ï¼Œä»¥ä¸‹åˆ†åˆ«ä½¿ç”¨ godev ä¸ hualf ç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ï¼š    \n    ![godev-rootless-container.jpg](godev-rootless-container.jpg)![hualf-rootless-container.jpg](hualf-rootless-container.jpg) \n  - slirp4netns å®ç°çš„ç½‘ç»œæ¨¡å¼ä¸å¸¦å®½æ¯”è¾ƒï¼š    \n    ![rootless-slirp4netns-networking.jpg](rootless-slirp4netns-networking.jpg) \n  - ä½¿ç”¨ `iperf3` å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootless å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n    ![rootless-container-to-container-bandwidth.jpg](rootless-container-to-container-bandwidth.jpg)å¯¹æ¯” rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½æ¥çœ‹ï¼Œslirp4netns å®ç°çš„ rootless å®¹å™¨åœ¨ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´å†…çš„é€šä¿¡æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œè€Œ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ç›¸æ¯”å‰è€…åœ¨æ­¤æ¬¡æµ‹è¯•ä¸­é«˜å‡ºè¿‘ 5 å€ã€‚ \n  - å…³äº slirp4netns æ›´åŠ è¯¦ç»†çš„å†…å®¹ï¼Œè¯·å‚è€ƒ [Github é¡¹ç›®](https://github.com/rootless-containers/slirp4netns)ã€‚\n\n### Podman çš„ macvlan ç½‘ç»œå®ç°ï¼š\n- `macvlan` ä½œä¸º CNI åœ¨ Kubernetes ä¸ OpenShift v4 ä¸­ä½œä¸º `Multus CNI` æ”¯æŒçš„é¢å¤–æ’ä»¶ç±»å‹ä½¿ç”¨æ„ˆåŠ å¹¿æ³›ï¼Œé›†ç¾¤ä¸­é™¤äº†å¸¸è§„ä½¿ç”¨çš„ Flannelã€Calico ç­‰ä½œä¸º `slow path` çš„æ’ä»¶å¤–ï¼Œè¦æ±‚é«˜æ€§èƒ½çš„ä¸šåŠ¡æµé‡å¯ä½¿ç”¨ macvlan ç›´è¿ pod å®¿ä¸»æœºç‰©ç†ç½‘å£å®ç° `fast path`ã€‚\n- ä¸ºåç»­ç†Ÿæ‚‰ä»¥ä¸Šåœºæ™¯çš„å®ç°ï¼Œå› æ­¤åœ¨ Podman `rootfull` å®¹å™¨ä¸­ä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼ã€‚\n- å…³äº macvlan çš„åŸºç¡€çŸ¥è¯†å¯å‚è€ƒ [Linux è™šæ‹Ÿç½‘å¡æŠ€æœ¯ï¼šMacvlan](https://mp.weixin.qq.com/s?__biz=MzU1MzY4NzQ1OA==&mid=2247484064&idx=1&sn=ffd745069b6c4aeac0589de00467b2f2&chksm=fbee426dcc99cb7bdf26f5e6a21bbeaebba7ccd384a02f850d4461ea92331ed140edf98ffaec&mpshare=1&scene=1&srcid=03049MKwF55OVgEZ4OCH39wd&sharer_sharetime=1583337046541&sharer_shareid=8eaca72194dae7b3d51d5c708436eee4#rd) ä¸ [linux ç½‘ç»œè™šæ‹ŸåŒ–ï¼šmacvlan](https://cizixs.com/2017/02/14/network-virtualization-macvlan/)\n- macvlan ç‰¹æ€§ç”± `Linux kernel` æ”¯æŒï¼Œç¬”è€…çš„å®éªŒç¯å¢ƒæ»¡è¶³ macvlan çš„è¦æ±‚ï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¡®å®šï¼š  \n  ```bash\n  $ sudo lsmod | grep macvlan\n  # è‹¥æ— ä»»ä½•è¿”å›ï¼Œè¯´æ˜è¿˜æœªåŠ è½½ macvlan å†…æ ¸æ¨¡å—ã€‚\n  $ sudo modprobe macvlan\n  # åŠ è½½ macvlan å†…æ ¸æ¨¡å—ï¼Œè‹¥æ‰§è¡ŒæŠ¥é”™ï¼Œè¯´æ˜ kernel ä¸æ”¯æŒè¯¥ç‰¹æ€§ã€‚\n  ```\n- podman ä¸ macvlan ç±»å‹ç½‘ç»œçš„é›†æˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  $ sudo podman network create -d macvlan -o parent=ens33 <network_name>\n    /etc/cni/net.d/<network_name>.conflist\n  # åˆ›å»º macvlan ç±»å‹ç½‘ç»œ  \n  $ sudo podman network ls\n  $ sudo /opt/cni/bin/dhcp daemon\n  # åœ¨å¦ä¸€ä¸ªçª—å£ä¸­å¯åŠ¨ dhcp å®ˆæŠ¤è¿›ç¨‹ä¾› macvlan æ’ä»¶è°ƒç”¨ï¼Œä¸ºå®¹å™¨ç½‘å£åˆ†é… IP åœ°å€ã€‚\n  $ sudo podman run -it --rm \\\n    --name <container_name> --network=<network_name> \\\n    <container_image>:<tag> /bin/sh\n  # åˆ›å»ºæ”¯æŒ macvlan ç±»å‹ç½‘ç»œçš„ rootfull å®¹å™¨  \n  ```\n- ä»ä¸ rootfull å®¹å™¨åœ¨åŒä¸€å¹¿æ’­åŸŸçš„å…¶ä»–èŠ‚ç‚¹ä¸Š ping è¯¥å®¹å™¨ï¼Œå¯æ­£å¸¸é€šä¿¡ï¼š  \n  ![podman-macvlan-network.png](podman-macvlan-network.png)\n  \n  > ğŸ¤” ä»¥ä¸Šç¤ºä¾‹çš„å®¹å™¨ä¸­è¿è¡Œ Web æœåŠ¡ï¼ˆå¯æš´éœ² 443 ç«¯å£ï¼‰ï¼Œä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼å¯æ‰“é€šä¸åŒä¸€å¹¿æ’­åŸŸä¸­å¤–éƒ¨èŠ‚ç‚¹çš„é€šä¿¡ï¼Œä½†æ— æ³•è®¿é—®å…¶ä¸­çš„æœåŠ¡ï¼Œå¯é‡‡å–ä½•ç§æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼Ÿ  \n\n### Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\n- Podman rootless å®¹å™¨çš„å®ç°æ ¸å¿ƒåœ¨äºè§£å†³ network namespaceï¼ˆNetNSï¼‰ ä¸ user namespaceï¼ˆUserNSï¼‰ çš„é—®é¢˜ï¼Œå‰æ–‡å·²ä»‹ç» NetNS çš„å®ç°æ–¹å¼ï¼Œåæ–‡å°†ä»‹ç» UserNS çš„å®ç°æ–¹å¼ã€‚\n- è‹¥è¦ä½¿ç”¨ rootless å®¹å™¨ï¼Œéœ€ç¡®è®¤ OS æ˜¯å¦å¼€å¯ user namespace åŠŸèƒ½ï¼š  \n  ```bash\n  $ sudo sysctl -a | grep user\\.max_user_namespaces\n    user.max_user_namespaces = 47494\n  ```\n- ç³»ç»Ÿä¸Šæ¯åˆ›å»ºä¸€ä¸ªç”¨æˆ·å°±ä¼šåœ¨ `/etc/subuid` ä¸ `/etc/subgid` ä¸­ç”Ÿæˆå¯¹åº”ç”¨æˆ·åœ¨å…¶ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ˜ å°„è§„åˆ™ï¼Œä»¥ /etc/subuid ä¸ºä¾‹ï¼Œå‚æ•°ä»¥å†’å·åˆ†éš”ï¼Œæ¯ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆuidï¼‰ï¼šç”¨æˆ·åç§°  \n  - ç¬¬äºŒä¸ªå‚æ•°ï¼ˆloweruidï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´ä¸­èµ·å§‹çš„æ˜ å°„ uid\n- ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆcountï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´å†…éƒ¨ä¸å¤–éƒ¨å¯æ˜ å°„ uid æ•°é‡ï¼ˆå¯ç†è§£ä¸ºæ‰€æœ‰å®¹å™¨æ™®é€šç”¨æˆ·çš„ uid æ•°é‡å’Œï¼‰  \n  ![rootless-user-namespace-mapping.jpg](rootless-user-namespace-mapping.jpg)\n- ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶å…è®¸è¿è¡Œè¿›ç¨‹çš„ uid æ˜ å°„èŒƒå›´ï¼Œåœ¨ `/proc/<pid>/uid_map` ä¸­å®šä¹‰ã€‚\n- å¯è¿‡æ»¤å®¹å™¨ `conmon` è¿›ç¨‹çš„ pid ç¡®è®¤æ¯ä¸ªå®¹å™¨ä¸­çš„ uid æ˜ å°„æƒ…å†µï¼Œå‚è§ä»¥ä¸‹ç¤ºä¾‹ã€‚\n- å…³äºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶çš„å…·ä½“è¯´æ˜å¯å‚è€ƒ `newuidmap` ä¸ `newgidmap` å‘½ä»¤çš„ man æ‰‹å†Œã€‚\n- å¯å‚è€ƒ Podman å®˜æ–¹æ¨èçš„å‘½ä»¤åˆ›å»º uid çš„æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  $ sudo usermod --add-subuids 10000-75535 $(whoami)\n  \n  # ----- ç¤ºä¾‹ -----\n  $ sudo cat /etc/subuid\n    appuser:10000:500\n  $ sudo cat /etc/subgid\n    appuser:500:50\n  # è¯¥ç”¨æˆ·åˆ›å»ºçš„ user namespace ä¸­å¯ä»¥ä½¿ç”¨ä» 10000 å¼€å§‹çš„ 500 ä¸ª UID å’Œä» 500 å¼€å§‹çš„ 50 ä¸ª GID çš„æ˜ å°„ã€‚\n  ```\n- ğŸš€ ç¤ºä¾‹ï¼š  \n  æ™®é€šç”¨æˆ· hualf åœ¨ /etc/subuid ä¸­æ˜ å°„ä¸º hualf:165536:65536ï¼Œè¯´æ˜åœ¨è¯¥ç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯åµŒå¥—ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·å‘½åç©ºé—´ï¼ˆæˆ–å®¹å™¨ï¼‰ï¼Œæ¯ä¸ªå®¹å™¨ä¸­çš„ root ç”¨æˆ· uid 0 éƒ½æ˜ å°„ä¸º hualf ç”¨æˆ·çš„ uid 1001ï¼ˆè¿è¡Œå®¹å™¨è¿›ç¨‹çš„ç”¨æˆ·ï¼‰ï¼Œè€Œå®¹å™¨ä¸­æ™®é€šç”¨æˆ·çš„ uid æ˜ å°„è‡³å®¿ä¸»æœºçš„ subuid èŒƒå›´ä¸­ï¼Œå¯¹äºæ­¤ä¾‹ subuid èŒƒå›´ä¸º 165536~231071ï¼Œå®¹å™¨ä¸­çš„ uid 1 ç”¨æˆ·æ˜ å°„ä¸ºå®¿ä¸»æœº uid 165536ï¼Œå› æ­¤å®¹å™¨ä¸­ admin ç”¨æˆ· uid 1000 æ˜ å°„ä¸ºå®¿ä¸»æœº uid 166535ï¼ˆ165536+999ï¼‰ã€‚  \n  é€šè¿‡å®¹å™¨å®¿ä¸»æœºä¸Šæ¯ä¸ªæ™®é€šç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´çš„ subuid æ˜ å°„èŒƒå›´ï¼Œå¯åˆ†é…ä¼—å¤š uid åœ¨ rootless å®¹å™¨ä¸­è¿è¡Œåº”ç”¨è¿›ç¨‹ã€‚  \n  ![user-namespace-subuid-mapping-1-edited.png](user-namespace-subuid-mapping-1-edited.png)![user-namespace-subuid-mapping-2-edited.png](user-namespace-subuid-mapping-2-edited.png)\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Reintroduction of Podman](https://projectatomic.io/blog/2018/02/reintroduction-podman/)\n- [Using pods with Podman on Fedora](https://fedoramagazine.org/podman-pods-fedora-containers/)\n- [Configuring container networking with Podman](https://www.redhat.com/sysadmin/container-networking-podman)\n- [RedHat docs - Building, running, and managing Linux containers on Red Hat Enterprise Linux 8](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/index)\n- [å®¹å™¨å®‰å…¨æ‹¾é— - Rootless Containeråˆæ¢](https://developer.aliyun.com/article/700923)\n- [Documentation for /proc/sys/user/](https://www.kernel.org/doc/html/latest/admin-guide/sysctl/user.html)\n- [docker docs - Overview of Docker Compose](https://docs.docker.com/compose/)\n- [CNI docs - firewall plugin](https://www.cni.dev/plugins/current/meta/firewall/)\n- [CNI docs - Port-mapping plugin](https://www.cni.dev/plugins/current/meta/firewall/)\n- https://fossies.org/linux/podman/docs/tutorials/basic_networking.md\n","source":"_posts/podman-arch-usage.md","raw":"---\ntitle: Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ1ï¼‰\nsubtitle: Podman Architecture and Usage (1)\nheader-img: podman-bg.webp\ndate: 2022-12-05 13:01:29\ntags:\n  - å®¹å™¨\n  - äº‘åŸç”Ÿ\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- å®éªŒç”¨ OS ç‰ˆæœ¬ï¼š  \n  - CentOS 7.9ã€RHEL 8.0ã€RHEL 8.2ã€Ubuntu 20.04.3 LTS\n- å®éªŒç”¨ kernel ç‰ˆæœ¬ï¼š  \n  - 3.10.0-1160.41.1.el7.x86_64  \n  - 4.18.0-193.el8.x86_64  \n  - 5.14.0-1.el7.elrepo.x86_64\n- å®éªŒç”¨ Podman ç‰ˆæœ¬ï¼š1.6.4ã€3.2.3ã€3.3.1\n- å®éªŒç”¨ podman-compose ç‰ˆæœ¬ï¼š0.1.8\n- å®éªŒç”¨ Docker ç‰ˆæœ¬ï¼š20.10.8\n- è‹¥æœªåšç‰¹æ®Šè¯´æ˜ï¼Œä»¥ä¸‹ç¤ºä¾‹å‡äº `RHEL 8.2`ï¼ˆ`4.18.0-193.el8.x86_64`ï¼‰ä¸Šæ‰§è¡Œï¼ŒPodman ç‰ˆæœ¬ä¸º `3.2.3`ã€‚\n- è¯¥æ–‡æ¡£ä¸­æœªæ¶‰åŠ podman å‘½ä»¤çš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ï¼Œå¯å‚é˜… [è¯¥æ–‡æ¡£](https://mp.weixin.qq.com/s/MDi4RB5V60EGl3ii9usD0Q) åŠ ä»¥ç†Ÿæ‚‰ã€‚\n- ğŸ’¥ é‡è¦æç¤ºï¼šPodman é¡¹ç›®æ­£åœ¨ä¸æ–­æ¼”è¿›ä¸å®Œå–„ä¸­ï¼Œè¯·ä»¥è‡ªèº«ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºå‡†è¿›è¡Œæµ‹è¯•ä¸ä½¿ç”¨ï¼\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Podman çš„ç‰¹æ€§æ¦‚è¿°\n- Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒ\n- Podman çš„æ‰©å±•åŠŸèƒ½\n- Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…\n- Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒ\n- Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰\n- Podman çš„ macvlan ç½‘ç»œå®ç°\n- Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼\n- å‚è€ƒé“¾æ¥\n\n### Podman çš„ç‰¹æ€§æ¦‚è¿°ï¼š\n- LXCã€`LXD`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ã€`systemd-nspawn` å‡å¯ä½œä¸º Linux å®¹å™¨ï¼Œä½†ç¼ºå°‘å®¹å™¨è·¨ä¸»æœºè¿è¡Œä¸åº”ç”¨æ‰“åŒ…çš„èƒ½åŠ›ã€‚\n- Docker ä¸ Podman å¯ä½¿ç”¨å®¹å™¨é•œåƒå®ç°åº”ç”¨æ‰“åŒ…å‘å¸ƒï¼Œå¿«é€Ÿä¸”è½»é‡ã€‚\n- Docker ä¸ Podman éƒ½ä½¿ç”¨ `runC`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸ºåº•å±‚ `oci-runtime`ã€‚\n- Docker ä¸ Podman éƒ½æ”¯æŒ `OCI Image Format`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ï¼Œéƒ½èƒ½ä½¿ç”¨ DockerHub ä¸Šçš„å®¹å™¨é•œåƒï¼Œè€Œ systemd-nspawn æ— æ³•ä½¿ç”¨å®ƒä»¬çš„é•œåƒã€‚\n- ğŸ‘‰ Podman ä½¿ç”¨ `CNI`ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸º rootfull å®¹å™¨ç½‘ç»œåº•å±‚ï¼Œå®ç°æ¯” Docker ç½‘ç»œå±‚ç•¥å¾®ç®€å•ä½†åŸç†ç›¸åŒã€‚\n- ç›¸å¯¹äº LXD ä¸ systemd-nspawnï¼ŒCNI å¯ä»¥é¿å…ç¼–å†™å¤§é‡çš„ç½‘ç»œè§„åˆ™ã€‚\n- ğŸš€ ä¸ºäº†å®ç°æ™®é€šç”¨æˆ· rootless å®¹å™¨ç½‘ç»œï¼ŒPodman å¯ä»¥ä½¿ç”¨ `slirp4netns` ç¨‹åºï¼Œé¿å… `kernel space` ä¸­çš„å¤§é‡ `veth pair` è™šæ‹Ÿæ¥å£çš„å‡ºç°, å¹¶ä¸”æ€§èƒ½æ›´å¥½ã€‚\n- Docker è¿è¡Œå®¹å™¨å¿…é¡»ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸”ä½¿ç”¨ root æƒé™ï¼Œå­˜åœ¨ç³»ç»Ÿå®‰å…¨é—®é¢˜ï¼Œè€Œ Podman é’ˆå¯¹æ­¤é—®é¢˜ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªç‰¹æ€§åŠ ä»¥è§£å†³ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - Podman æ”¯æŒæ— å®ˆæŠ¤è¿›ç¨‹ï¼ˆ`no-daemon`ï¼‰è¿è¡Œå®¹å™¨ã€‚  \n  - Podman æ”¯æŒæ™®é€šç”¨æˆ·è¿è¡Œ `rootless` å®¹å™¨ï¼Œå³ï¼Œæ™®é€šç”¨æˆ·ç›´æ¥è¿è¡Œå®¹å™¨æ— éœ€ææƒå…·æœ‰ root æƒé™ã€‚\n- è™½ç„¶ Docker ä¸ Podman çš„å®ç°åŸç†ä¸åŒï¼Œä½†å¯¹äºä½¿ç”¨è€…è€Œè¨€å…¶ CLI ååˆ†ç›¸ä¼¼ï¼Œå¯å¹³æ»‘åœ°ä» Docker è¿‡æ¸¡è‡³ Podmanã€‚\n- Podman çš„ç›®æ ‡ä¸æ˜¯å®¹å™¨çš„ç¼–æ’ï¼Œç¼–æ’å¯ä»¥ä½¿ç”¨æ›´åŠ ä¸“ä¸šçš„ Kubernetesã€Open Shiftã€Rancher ç­‰ï¼Œä½¿ç”¨ Podman å¯ä»¥æ›´è½»é‡çš„è¿è¡Œå®¹å™¨ä¸”ä¸å— root æƒé™çš„å®‰å…¨é—®é¢˜ï¼Œå³ä¾¿æ˜¯ root ç”¨æˆ·ä¹Ÿæ— æ³•æŸ¥çœ‹å…¶å®ƒæ™®é€šç”¨æˆ·ç©ºé—´ä¸‹çš„å®¹å™¨ï¼ŒPodman é€šè¿‡ `user namespace` è¿›è¡Œéš”ç¦»ã€‚\n- ğŸ‘‰ Podman å¯ä½¿ç”¨ `systemd service` å•å…ƒæ–‡ä»¶ç›´æ¥ç®¡ç†å®¹å™¨ï¼Œå®ç°å®¹å™¨æœåŠ¡éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ã€‚\n- ğŸ‘‰ Podman é‡Œé›†æˆäº† `CRIU`ï¼Œå› æ­¤ Podman ä¸­çš„å®¹å™¨å¯ä»¥åœ¨å•æœºä¸Šçƒ­è¿ç§»ã€‚\n- ç”±äº Kubernetes å°†ä» `v1.24.x` ç‰ˆæœ¬åæ”¾å¼ƒä½¿ç”¨ `dockershim` æ¥å£å±‚ï¼Œå®¹å™¨è¿è¡Œæ—¶å¯é€‰æ‹©ä½¿ç”¨ `Containerd` æˆ–è€… `CRI-O`ï¼Œä¸¤è€…è™½ç„¶å‡æ”¯æŒ OCI image è§„èŒƒï¼Œä½†å®ƒä»¬ä¸æ˜¯é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…ç›´æ¥ç®¡ç†å®¹å™¨æˆ–é•œåƒçš„å·¥å…·ï¼Œè€Œ Podman å¯ç›´æ¥é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…æ“ä½œå®¹å™¨æˆ–é•œåƒã€‚\n- Podman å‘½ä»¤çš„å­è¿›ç¨‹åˆ›å»º pod ä¸å®¹å™¨ã€‚\n\n### Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\n- Podman ç‰ˆæœ¬ã€kernel ç‰ˆæœ¬ä¸ OS ç‰ˆæœ¬çš„å…¼å®¹æ€§å°†ç›´æ¥å½±å“æ™®é€šç”¨æˆ·ä½¿ç”¨ rootless å®¹å™¨ã€‚\n- å¦‚ä¸‹æ‰€ç¤ºï¼Œkernel ä¸æ”¯æŒ rootless å®¹å™¨ï¼š  \n  ![centos79-kernel-not-support-podman-rootless.jpg](centos79-kernel-not-support-podman-rootless.jpg)\n\n- æ™®é€šç”¨æˆ· rootless å®¹å™¨å…¼å®¹æ€§æ¯”è¾ƒï¼š\n  ![podman-version-compare.png](podman-version-compare.png)\n\n  > ğŸ“Œ**æ³¨æ„ï¼š**\n  > \n  > rootless å®¹å™¨ç‰¹æ€§å–å†³äº kernel çš„ç‰ˆæœ¬ï¼Œä¸å–å†³äº OS ä¸ Podman çš„ç‰ˆæœ¬ã€‚\n\n  - ç”±äº `user namespace` ç‰¹æ€§åœ¨ kernel `4.9.0` ä¹‹åå‡ºç°ï¼Œå› æ­¤å‡çº§ kernel å³å¯è§£å†³ rootless é—®é¢˜ã€‚\n  - å…³äº rootless ç‰¹æ€§åœ¨ RHEL 8 ä¸­çš„è®¾ç½®ï¼Œå¯ [ç‚¹å‡»æ­¤å¤„](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/assembly_starting-with-containers_building-running-and-managing-containers#proc_setting-up-rootless-containers_assembly_starting-with-containers) å‚è€ƒ Red Hat çš„å®˜æ–¹é…ç½®è¯´æ˜ã€‚\n\n### Podman çš„æ‰©å±•åŠŸèƒ½ï¼š\n- `cockpit-podman` è½¯ä»¶åŒ…ä½œä¸º cockpit æ’ä»¶å¯é›†æˆäº `Web UI` ä¸­ï¼Œå®ç° Web UI ç®¡ç†å®¹å™¨ã€‚  \n  - cockpit-podman æœåŠ¡å®‰è£…ä¸å¯ç”¨ï¼š    \n    ```bash\n    $ sudo yum install -y cockpit-podman\n    $ sudo systemctl enable --now cockpit.socket\n    $ sudo systemctl status cockpit.service\n    # å®‰è£… cockpit-podman è½¯ä»¶åŒ…ï¼Œå¹¶å¯ç”¨ cockpit æœåŠ¡ã€‚\n    $ sudo netstat -tunlp | grep 9090\n    # æŸ¥çœ‹ systemd ç›‘å¬çš„ 9090 ç«¯å£æ˜¯å¦å¯ç”¨\n    ```\n  - åœ¨ Web UI ä¸­å¯æŸ¥çœ‹å¹¶ç®¡ç† podman å®¹å™¨ä¸é•œåƒï¼š    \n    ![podman-arch-usage/cockpit-podman-1.jpg](cockpit-podman-1.jpg)![cockpit-podman-2.jpg](cockpit-podman-2.jpg)\n- `podman-compose` æ—¨åœ¨ä½¿ç”¨æ›´è½»é‡çš„æ–¹å¼å®ç°`å•æœºå®¹å™¨ç¼–æ’`ï¼Œä»¥ç”¨äºæ›¿æ¢ `docker-compose`ï¼Œè¿™ç§æ–¹å¼å°†ä¸å†ä¾èµ–å®ˆæŠ¤è¿›ç¨‹ä¸ root æƒé™ï¼ŒåŒæ—¶å¯ä½¿ç”¨ rootless å®¹å™¨ï¼Œè¯¦ç»†ç¤ºä¾‹è§ä¸‹æ–‡ã€‚\n- podman-compose ä½¿ç”¨ `Python` å¼€å‘ï¼Œå› æ­¤å¯ç›´æ¥ä½¿ç”¨ `pip3` å®‰è£…è¯¥ç»„ä»¶ï¼Œæˆ–ä½¿ç”¨ rpm è½¯ä»¶åŒ…æ–¹å¼å®‰è£…ã€‚\n- ç”±äº podman-compose ä¾ç„¶å¤„äº `dev` é˜¶æ®µï¼Œä»…ä½œä¸ºåŠŸèƒ½æµ‹è¯•ä½¿ç”¨ï¼Œæš‚æœªå—åˆ° GA ç¯å¢ƒæ”¯æŒã€‚\n\n### Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\n- CentOS 7.x/8.x æˆ– RHEL 7.x/8.x ä¸­ï¼šyum å‘½ä»¤ä½¿ç”¨ podman `rpm` è½¯ä»¶åŒ…å®‰è£…  \n  ```bash\n  $ sudo yum install -y podman-3.2.3-0.11.module_el8.4.0+942+d25aada8.x86_64\n  # å®‰è£… podman æœ€æ–°ç‰ˆæœ¬ï¼Œä½ç‰ˆæœ¬ podman å­˜åœ¨è¾ƒå¤š bugã€‚\n  # æ³¨æ„ï¼š\n  #   1. éœ€é…ç½® CentOS 8 çš„ yum è½¯ä»¶æºä»¥å®‰è£…æœ€æ–°ç‰ˆçš„ podman åŠå…¶ä¾èµ–è½¯ä»¶åŒ…\n  #   2. yum å®‰è£… podman æ—¶ä¹Ÿå°†å®‰è£… containernetworking-plugins è½¯ä»¶åŒ…\n  ```\n- ğŸ¤˜ Ubuntu 20.04.2 LTS ä¸­ï¼šapt-get å‘½ä»¤ä½¿ç”¨ podman `deb` è½¯ä»¶åŒ…å®‰è£…  \n  ```bash\n$ . /etc/os-release\n# æŸ¥çœ‹å½“å‰çš„ç³»ç»Ÿå‘è¡Œç‰ˆ\n$ echo \"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/ /\" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list\n$ curl -L \"https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/Release.key\" | sudo apt-key add -\n# æ·»åŠ  podman è½¯ä»¶æºä¸ apt å…¬é’¥\n$ sudo apt-get update -y\n$ sudo apt-get upgrade -y\n# æ›´æ–°ç³»ç»Ÿè½¯ä»¶æºå¹¶å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…\n$ sudo apt-get install -y podman\n  Reading package lists... Done\n  Building dependency tree       \n  Reading state information... Done\n  ...\n  The following NEW packages will be installed:\n    catatonit conmon containernetworking-plugins containers-common criu crun fuse-overlayfs fuse3 libfuse3-3 libnet1 libprotobuf-c1\n    podman podman-machine-cni podman-plugins\n  ...\n# å®‰è£… podman ä¸ç›¸å…³çš„è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ conmonã€containernetworking-pluginsã€crun ç­‰ã€‚  \n  ```\n  å®‰è£…å‚è€ƒé“¾æ¥ï¼š  \n  - [Podman Doc - installation](https://podman.io/getting-started/installation)\n  - [Easy to Install Podman on Ubuntu 20.04](https://www.hostnextra.com/kb/easy-to-install-podman-on-ubuntu-20-04/)\n  - [podman from devel:kubic:libcontainers:stable project](https://software.opensuse.org//download.html?project=devel%3Akubic%3Alibcontainers%3Astable&package=podman)\n\n### ğŸ¤˜ Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\n- Docker v20.10.8 ä½¿ç”¨ `dockerd` ä¸ `containerd` å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å®¹å™¨ä¸é•œåƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿è¡ŒçŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š \n  ```bash\n  $ sudo systemctl status docker.service\n  â— docker.service - Docker Application Container Engine\n     Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)\n     Active: active (running) since Wed 2022-10-19 10:53:04 CST; 6min ago\n       Docs: https://docs.docker.com\n   Main PID: 79556 (dockerd)\n      Tasks: 21\n     Memory: 42.6M\n     CGroup: /system.slice/docker.service\n             â”œâ”€79556 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n             â”œâ”€79677 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 4000 -container-ip 172.17.0.2 -container-port 4000\n             â””â”€79683 /usr/bin/docker-proxy -proto tcp -host-ip :: -host-port 4000 -container-ip 172.17.0.2 -container-port 4000\n  \n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.197803867+08:00\" level=info msg=\"scheme \\\"unix\\\" not registered, fallback to default scheme\" module=grpc\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.197837924+08:00\" level=info msg=\"ccResolverWrapper: sending update to cc: {[{unix:///run/containerd/containerd.sock  <nil> 0 <nil>}] <nil> <nil>}\" module=grpc\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.197860326+08:00\" level=info msg=\"ClientConn switching balancer to \\\"pick_first\\\"\" module=grpc\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.220416627+08:00\" level=info msg=\"Loading containers: start.\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.347884960+08:00\" level=info msg=\"Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.725361851+08:00\" level=info msg=\"Loading containers: done.\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.755449128+08:00\" level=info msg=\"Docker daemon\" commit=75249d8 graphdriver(s)=overlay2 version=20.10.8\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.755527994+08:00\" level=info msg=\"Daemon has completed initialization\"\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com systemd[1]: Started Docker Application Container Engine.\n  Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=\"2022-10-19T10:53:04.776865058+08:00\" level=info msg=\"API listen on /var/run/docker.sock\"\n  # dockerd å®ˆæŠ¤è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€\n  \n  $ sudo systemctl status containerd\n  â— containerd.service - containerd container runtime\n     Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled)\n     Active: active (running) since Tue 2022-10-18 15:08:06 CST; 20h ago\n       Docs: https://containerd.io\n   Main PID: 1892 (containerd)\n      Tasks: 20\n     Memory: 103.4M\n     CGroup: /system.slice/containerd.service\n             â”œâ”€ 1892 /usr/bin/containerd\n             â””â”€79696 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock\n  # containerd é€šè¿‡è°ƒç”¨ containerd-shim-runc-v2 è¿è¡ŒæŒ‡å®šå®¹å™¨\n  $ sudo ps -ef | grep -E \"dockerd|containerd|containerd-shim-runc-v2\"\n    root       1892      1  0 Oct18 ?        00:05:01 /usr/bin/containerd\n    root      79556      1  0 10:53 ?        00:00:03 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n    root      79696      1  0 10:53 ?        00:00:01 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock\n  # PID 79696 ä¸ºå®é™…çš„å®¹å™¨è¿è¡Œè¿›ç¨‹\n  ```\n- Podman ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œæˆ–ç®¡ç†å®¹å™¨ï¼Œå¯¹äº rootfull å®¹å™¨æˆ– rootless å®¹å™¨çš„è¿è¡Œæ–¹å¼å­˜åœ¨å·®å¼‚ï¼š  \n  - rootfull å®¹å™¨çš„è¿›ç¨‹ï¼š    \n    ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n    $ sudo ps -ef | egrep \"podman|slirp4netns|conmon\"\n      root        3879    3476  1 06:31 pts/3    00:00:00 podman run -it --name=mydebian docker.io/library/debian:latest /bin/sh\n      root        3945       1  0 06:31 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -u 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata -p /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/pidfile -n mydebian --exit-dir /run/libpod/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/oci-log -t --conmon-pidfile /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg cni --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt=nodev,metacopy=on --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba\n    # ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹\n    ```\n    ğŸ‘‰ ä»¥ `detach` æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n    $ sudo ps -ef | egrep \"podman|slirp4netns|conmon\"\n      root        3744       1  0 06:25 ?        00:00:00 /usr/bin/conmon --api-version 1 -c b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -u b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata -p /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/pidfile -n apache-rhce8.2-alpine --exit-dir /run/libpod/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/oci-log --conmon-pidfile /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/lib/containers/storage --exit-command-arg --runroot --exit-command-arg /run/containers/storage --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/libpod --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg cni --exit-command-arg --volumepath --exit-command-arg /var/lib/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --storage-opt --exit-command-arg overlay.mountopt=nodev,metacopy=on --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272\n    # podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œè€Œ rootfull å®¹å™¨çš„ CNI æ’ä»¶\n    # å¯ç›´æ¥ä½¿ç”¨ iptables çš„æ–¹å¼å®ç°ã€‚\n    ```\n  - rootless å®¹å™¨çš„è¿›ç¨‹ï¼š    \n    ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š\n    ```bash\n    $ ps -ef | egrep \"podman|slirp4netns|conmon\"\n      core        3418    2762  0 06:17 pts/2    00:00:05 podman run -it --name=mybusybox docker.io/library/busybox:latest /bin/sh\n      core        3430    3418  0 06:17 pts/2    00:00:00 /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp --enable-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-19eb5630-c0a8-4ea9-8790-76ecdcdf2dbc tap0\n      core        3433       1  0 06:17 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -u 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -r /usr/bin/crun -b /var/home/core/.local/share/containers/storage/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata -p /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/pidfile -n mybusybox --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/oci-log -t --conmon-pidfile /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/home/core/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg netavark --exit-command-arg --volumepath --exit-command-arg /var/home/core/.local/share/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160\n    # ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹ï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹\n    # ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚\n    ``` \n    ğŸ‘‰ ä»¥ `detach` æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š   \n    ```bash\n    $ ps -ef | egrep \"podman|slirp4netns|conmon\"\n      core        3308       1  0 06:15 pts/2    00:00:00 /usr/bin/slirp4netns --disable-host-loopback --mtu=65520 --enable-sandbox --enable-seccomp --enable-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-f9f6f9dd-bf80-f6ca-6f39-7c9d9cd6beea tap0\n      core        3325       1  0 06:15 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -u 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -r /usr/bin/crun -b /var/home/core/.local/share/containers/storage/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata -p /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/pidfile -n apache-rhce8.2-alpine --exit-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --log-level warning --runtime-arg --log-format=json --runtime-arg --log --runtime-arg=/run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/oci-log --conmon-pidfile /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/conmon.pid --exit-command /usr/bin/podman --exit-command-arg --root --exit-command-arg /var/home/core/.local/share/containers/storage --exit-command-arg --runroot --exit-command-arg /run/user/1000/containers --exit-command-arg --log-level --exit-command-arg warning --exit-command-arg --cgroup-manager --exit-command-arg systemd --exit-command-arg --tmpdir --exit-command-arg /run/user/1000/libpod/tmp --exit-command-arg --network-config-dir --exit-command-arg  --exit-command-arg --network-backend --exit-command-arg netavark --exit-command-arg --volumepath --exit-command-arg /var/home/core/.local/share/containers/storage/volumes --exit-command-arg --runtime --exit-command-arg crun --exit-command-arg --storage-driver --exit-command-arg overlay --exit-command-arg --events-backend --exit-command-arg journald --exit-command-arg container --exit-command-arg cleanup --exit-command-arg 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab\n    # podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹\n    # ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚\n    ```\n\n### Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰ï¼š\n- Podman æ”¯æŒçš„å®¹å™¨ç½‘ç»œæ¨¡å¼å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ![podman-network-mode.jpg](podman-network-mode.jpg)\n- root ç”¨æˆ·è¿è¡Œ rootfull å®¹å™¨ç½‘ç»œåˆ†æï¼š  \n  - é»˜è®¤æƒ…å†µä¸‹ï¼Œrootfull å®¹å™¨ä½¿ç”¨ bridge ç½‘ç»œæ¨¡å¼ï¼Œå¹¶ä¸”åœ¨æœªåˆ›å»ºä»»ä½•å®¹å™¨å‰ç³»ç»Ÿä¸Šä¸ä¼šè‡ªåŠ¨åˆ›å»º `cni-podman0 `ç½‘æ¡¥ï¼Œåªæœ‰åˆ›å»ºå®¹å™¨åè‡ªåŠ¨ç”Ÿæˆã€‚  \n  - root ç”¨æˆ·ä½¿ç”¨å…¨å±€èŒƒå›´å†…çš„ CNI æ’ä»¶ï¼Œpodman é»˜è®¤ä½¿ç”¨ `bridge`ã€`portmap` æ’ä»¶ï¼Œå…¶é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š    \n    ```bash\n    $ cat /etc/cni/net.d/87-podman-bridge.conflist\n    {\n      \"cniVersion\": \"0.4.0\",\n      \"name\": \"podman\",\n      \"plugins\": [\n        {\n          \"type\": \"bridge\",\n          \"bridge\": \"cni-podman0\",\n          \"isGateway\": true,\n          \"ipMasq\": true,\n          \"hairpinMode\": true,\n          \"ipam\": {\n            \"type\": \"host-local\",\n            \"routes\": [{ \"dst\": \"0.0.0.0/0\" }],\n            \"ranges\": [\n              [\n                {\n                  \"subnet\": \"10.88.0.0/16\",\n                  \"gateway\": \"10.88.0.1\"\n                }\n              ]\n            ]\n          }\n        },\n        {\n          \"type\": \"portmap\",\n          \"capabilities\": {\n            \"portMappings\": true\n          }\n        },\n        {\n          \"type\": \"firewall\"\n        },\n        {\n          \"type\": \"tuning\"\n        }\n      ]\n    # è¯¥é…ç½®æ–‡ä»¶ä½äº Podman æºç  cni/87-podman-bridge.conflist\n    # Podman å¯è°ƒç”¨ bridgeã€portmap ç­‰ CNI æ’ä»¶\n    \n    $ sudo podman inspect <container_name> | jq .[0].HostConfig.NetworkMode\n      \"bridge\"\n    # root ç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼\n    ```\n  - root ç”¨æˆ·åˆ›å»ºå…·æœ‰ç«¯å£æ˜ å°„çš„å®¹å™¨æ—¶ï¼Œiptables filter è¡¨ä¸ nat è¡¨è§„åˆ™å°†ç›¸åº”å¢åŠ ï¼š    \n    ```bash\n    # ----- filter è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----\n    *filter\n    -A FORWARD -m comment --comment \"CNI firewall plugin rules\" -j CNI-FORWARD\n    -A CNI-FORWARD -m comment --comment \"CNI firewall plugin admin overrides\" -j CNI-ADMIN\n    -A CNI-FORWARD -d 10.88.0.3/32 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\n    # æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘ç›®æ ‡åœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œconntrack æ¨¡å—è¿›è¡Œè¿æ¥çŠ¶æ€è¿½è¸ªã€‚\n    # å½“å®¹å™¨é€šè¿‡ MASQUERADE å¯¹å¤–è®¿é—®ï¼Œå›åŒ…å†æ¬¡è¿›å…¥å®¹å™¨å®¿ä¸»æœºæ—¶ä¸å†é€šè¿‡ DNAT è½¬å‘ï¼Œè€Œé€šè¿‡ conntrack \n    # è®°å½•çš„è¿æ¥çŠ¶æ€ç›´æ¥è½¬å‘è‡³è¯¥è§„åˆ™å¹¶é€šè¿‡ cni-podman0 ç½‘æ¡¥è¿›å…¥å®¹å™¨ã€‚\n    -A CNI-FORWARD -s 10.88.0.3/32 -j ACCEPT\n    # æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘æºåœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆå‡ºå®¹å™¨çš„æµé‡ï¼‰ã€‚\n    \n    # ----- nat è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----\n    *nat\n    -A PREROUTING -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT\n    -A POSTROUTING -m comment --comment \"CNI portfwd requiring masquerade\" -j CNI-HOSTPORT-MASQ\n    -A POSTROUTING -s 10.88.0.3/32 -m comment --comment \"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -j CNI-b6c5fb6c593e895d843cb5bd\n    # æ–°å¢è§„åˆ™ï¼šæ¥è‡ªäº 10.88.0.3 å®¹å™¨çš„æµé‡è½¬å‘è‡³ CNI-b6c5fb6c593e895d843cb5bd é“¾\n    -A OUTPUT -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT\n    # å¯ç”¨ CNI åå³åˆ›å»ºçš„è§„åˆ™ï¼Œè¯¥è§„åˆ™æ¥æ”¶æ¥è‡ªæœ¬åœ°åº”ç”¨çš„æµé‡å¹¶è½¬å‘è‡³ CNI-HOSTPORT-DNAT é“¾\n    -A CNI-HOSTPORT-SETMARK -m comment --comment \"CNI portfwd masquerade mark\" -j MARK --set-xmark 0x2000/0x2000\n    -A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE\n    ### ä»¥ä¸‹ 6 æ¡åœ¨åˆ›å»ºæ–°å®¹å™¨æ—¶åŒæ—¶åˆ›å»º \n    -A CNI-HOSTPORT-DNAT -p tcp -m comment --comment \"dnat name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -m multiport --dports 8843 -j CNI-DN-b6c5fb6c593e895d843cb\n    # è‡ªå®šä¹‰ DNAT é“¾ï¼Œå‘é€è‡³æœ¬åœ° 8843 ç«¯å£çš„æµé‡è½¬å‘è‡³ CNI-DN-b6c5fb6c593e895d843cb é“¾ã€‚\n    -A CNI-b6c5fb6c593e895d843cb5bd -d 10.88.0.0/16 -m comment --comment \"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -j ACCEPT\n    # å…è®¸è½¬å‘ç›®æ ‡ç½‘æ®µä¸º 10.88.0.0/16 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œè¯¥ç½‘æ®µä¸ºå®¹å™¨æ‰€åœ¨çš„ç½‘ç»œã€‚\n    -A CNI-b6c5fb6c593e895d843cb5bd ! -d 224.0.0.0/4 -m comment --comment \"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\" -j MASQUERADE\n    # MASQUERADE å‡ºå®¹å™¨æµé‡\n    -A CNI-DN-b6c5fb6c593e895d843cb -s 10.88.0.0/16 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK\n    -A CNI-DN-b6c5fb6c593e895d843cb -s 127.0.0.1/32 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK\n    -A CNI-DN-b6c5fb6c593e895d843cb -p tcp -m tcp --dport 8843 -j DNAT --to-destination 10.88.0.3:443\n    # è‡ªå®šä¹‰ DNAT é“¾å®ç°å®¹å™¨å®¿ä¸»æœºè‡³å®¹å™¨çš„ç«¯å£æ˜ å°„\n    ```\n  - ğŸš€ ç¤ºä¾‹ï¼šå¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæ¶‰åŠçš„å®¿ä¸»æœº iptablesï¼š\n    ![external-access-container-web-service-iptables.jpg](external-access-container-web-service-iptables.jpg)ä»å¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæµé‡å°†é€šè¿‡ PREROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ`CNI-HOSTPORT-DNAT`ã€`CNI-DN-xxxx`ã€`DNAT`ï¼‰ï¼Œç»ç”± FORWARD é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ`CNI-FORWARD`ï¼‰çš„ä¸‰å±‚è½¬å‘ä¸ `cni-podman0` ç½‘æ¡¥çš„äºŒå±‚è½¬å‘è¿›å…¥å®¹å™¨ï¼Œå®¹å™¨å¯¹å¤–å“åº”çš„æµé‡å°†ç»è¿‡ cni-podman0 ç½‘æ¡¥è½¬å‘ï¼Œå¹¶ç»è¿‡ CNI-FORWARD é“¾ä¸ POSTROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ`CNI-HOSTPORT-MASQ`ï¼‰å‡ºå®¹å™¨å®¿ä¸»æœºã€‚  \n  - ğŸš€ ç¤ºä¾‹ï¼šç›´æ¥ä»å®¹å™¨å†…è®¿é—®å¤–éƒ¨æ—¶ï¼Œè¿”å›å®¹å™¨çš„å›åŒ…å°†ç›´æ¥ä½¿ç”¨ conntrack æ¨¡å—è¿½è¸ªçš„è¿æ¥çŠ¶æ€ï¼Œæµé‡é€šè¿‡ `CNI-FORWARD` é“¾çš„ä¸‰å±‚è½¬å‘ä¸ cni-podman0 çš„äºŒå±‚è½¬å‘è‡³å®¹å™¨ä¸­ï¼Œå³ï¼Œå›åŒ…è¿›å…¥å®¹å™¨å®¿ä¸»æœºä¸å†é€šè¿‡`CNI-HOSTPORT-DNAT`é“¾ã€‚    \n    å¦‚ä¸‹æ‰€ç¤ºï¼Œç›¸å…³çš„ DNAT é“¾æ— æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ï¼ŒCNI-FORWARD é“¾å‡æœ‰æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ã€‚    \n    ![container-access-external-iptables.jpg](container-access-external-iptables.jpg)\n    \n    > ğŸ“Œ **Kubernetes ç›¸å…³é—®é¢˜æç¤ºï¼š**\n    > \n    > 1. å®¹å™¨æˆ– pod é€šè¿‡ cni ç½‘æ¡¥æ¡¥æ¥çš„æ–¹å¼åœ¨ Kubernetes æˆ– OpenShift3 ä¸­éœ€åœ¨è®¡ç®—èŠ‚ç‚¹ï¼ˆworker nodeï¼‰ä¸Šé…ç½® `net.bridge.bridge-nf-call-iptables` ä¸ `net.bridge.bridge-nf-call-iptables6` å†…æ ¸å‚æ•°ï¼Œä½¿ cni äºŒå±‚ç½‘æ¡¥å¯è°ƒç”¨ iptables çš„ conntrack æ¨¡å—ï¼Œä»¥è§£å†³å‰åç«¯ pod åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šæ—¶ï¼Œç”±äº pod ç›´è¿ cni äºŒå±‚ç½‘æ¡¥ï¼Œè€ŒäºŒå±‚ç½‘æ¡¥åªå®ç°äºŒå±‚è½¬å‘ï¼Œæ— æ³•è¿½è¸ªå‰åç«¯çš„è¿æ¥çŠ¶æ€ï¼Œé€ æˆåç«¯ pod å‘å‰ç«¯ pod å›åŒ…æ—¶æ— æ³•å¤„äºåŒä¸€è¿æ¥é“¾è·¯çš„é—®é¢˜ï¼Œå¯ [ç‚¹å‡»æ­¤å¤„](https://imroc.cc/k8s/faq/why-enable-bridge-nf-call-iptables/) è·å¾—æ›´å¤šå¸®åŠ©ã€‚\n    > 2. ä½¿ç”¨ä»¥ä¸Šå†…æ ¸å‚æ•°æ—¶ï¼Œéœ€åŠ è½½ `br_netfilter` å†…æ ¸æ¨¡å—æ–¹èƒ½ç”Ÿæ•ˆã€‚\n  \n  - ä½¿ç”¨ `iperf3` å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ![rootfull-container-to-container-bandwidth.jpg](rootfull-container-to-container-bandwidth.jpg)\n- æ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ç½‘ç»œåˆ†æï¼š  \n  - `slirp4netns` ç¨‹åºæ”¯æŒ user rootless network namespaceï¼Œè€Œéé€šè¿‡ `iptables` ä¸ CNI å®ç°ã€‚  \n  - ğŸ‘‰ æ™®é€šç”¨æˆ·ä½¿ç”¨ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨å®¿ä¸»æœº 1024 ä»¥ä¸Šçš„ç«¯å£å®ç°æ˜ å°„ï¼Œä½†å¯ä½¿ç”¨ `net.ipv4.ip_unprivileged_port_start` å†…æ ¸å‚æ•°å®ç°ä½äº 1024 çš„ç«¯å£å¼€å§‹æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    \n    ```bash\n### æ–¹å¼ 1ï¼š###\n$ sysctl -w net.ipv4.ip_unprivileged_port_start=80\n# ä¸´æ—¶é…ç½®ï¼šå…è®¸æ™®é€šç”¨æˆ·ä» 80 ç«¯å£å¼€å§‹çš„ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨\n    \n### æ–¹å¼ 2ï¼š###\n$ echo \"net.ipv4.ip_unprivileged_port_start=80\" >> /etc/sysctl.d/rootless.conf\n# æ°¸ä¹…é…ç½®ï¼šå°†è¯¥å†…æ ¸å‚æ•°å†™å…¥å†…æ ¸å‚æ•°é…ç½®æ–‡ä»¶ï¼Œä½¿å…¶å¼€æœºæ°¸ä¹…ç”Ÿæ•ˆã€‚\n$ sysctl -p\n# ä½¿é…ç½®çš„å†…æ ¸å‚æ•°ç”Ÿæ•ˆ\n\n - æ™®é€šç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼ä¸º `slirp4netns`ï¼ˆslirp4netns è½¯ä»¶åŒ…å®ç°ï¼‰ã€‚    \n    ```bash\n    $ podman inspect <container_name> | jq .[0].HostConfig.NetworkMode\n      \"slirp4netns\"\n    # æ™®é€šç”¨æˆ·åˆ›å»ºçš„ rootless å®¹å™¨ç½‘ç»œæ¨¡å¼\n    ```\n  - æ¯ä¸ªæ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨éƒ½å°†ç”Ÿæˆ slirp4netns è¿›ç¨‹ç”¨äºéš”ç¦»è¯¥ç”¨æˆ·çš„ `network namespace`ï¼Œä»¥ä¸‹åˆ†åˆ«ä½¿ç”¨ godev ä¸ hualf ç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ï¼š    \n    ![godev-rootless-container.jpg](godev-rootless-container.jpg)![hualf-rootless-container.jpg](hualf-rootless-container.jpg) \n  - slirp4netns å®ç°çš„ç½‘ç»œæ¨¡å¼ä¸å¸¦å®½æ¯”è¾ƒï¼š    \n    ![rootless-slirp4netns-networking.jpg](rootless-slirp4netns-networking.jpg) \n  - ä½¿ç”¨ `iperf3` å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootless å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n    ![rootless-container-to-container-bandwidth.jpg](rootless-container-to-container-bandwidth.jpg)å¯¹æ¯” rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½æ¥çœ‹ï¼Œslirp4netns å®ç°çš„ rootless å®¹å™¨åœ¨ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´å†…çš„é€šä¿¡æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œè€Œ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ç›¸æ¯”å‰è€…åœ¨æ­¤æ¬¡æµ‹è¯•ä¸­é«˜å‡ºè¿‘ 5 å€ã€‚ \n  - å…³äº slirp4netns æ›´åŠ è¯¦ç»†çš„å†…å®¹ï¼Œè¯·å‚è€ƒ [Github é¡¹ç›®](https://github.com/rootless-containers/slirp4netns)ã€‚\n\n### Podman çš„ macvlan ç½‘ç»œå®ç°ï¼š\n- `macvlan` ä½œä¸º CNI åœ¨ Kubernetes ä¸ OpenShift v4 ä¸­ä½œä¸º `Multus CNI` æ”¯æŒçš„é¢å¤–æ’ä»¶ç±»å‹ä½¿ç”¨æ„ˆåŠ å¹¿æ³›ï¼Œé›†ç¾¤ä¸­é™¤äº†å¸¸è§„ä½¿ç”¨çš„ Flannelã€Calico ç­‰ä½œä¸º `slow path` çš„æ’ä»¶å¤–ï¼Œè¦æ±‚é«˜æ€§èƒ½çš„ä¸šåŠ¡æµé‡å¯ä½¿ç”¨ macvlan ç›´è¿ pod å®¿ä¸»æœºç‰©ç†ç½‘å£å®ç° `fast path`ã€‚\n- ä¸ºåç»­ç†Ÿæ‚‰ä»¥ä¸Šåœºæ™¯çš„å®ç°ï¼Œå› æ­¤åœ¨ Podman `rootfull` å®¹å™¨ä¸­ä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼ã€‚\n- å…³äº macvlan çš„åŸºç¡€çŸ¥è¯†å¯å‚è€ƒ [Linux è™šæ‹Ÿç½‘å¡æŠ€æœ¯ï¼šMacvlan](https://mp.weixin.qq.com/s?__biz=MzU1MzY4NzQ1OA==&mid=2247484064&idx=1&sn=ffd745069b6c4aeac0589de00467b2f2&chksm=fbee426dcc99cb7bdf26f5e6a21bbeaebba7ccd384a02f850d4461ea92331ed140edf98ffaec&mpshare=1&scene=1&srcid=03049MKwF55OVgEZ4OCH39wd&sharer_sharetime=1583337046541&sharer_shareid=8eaca72194dae7b3d51d5c708436eee4#rd) ä¸ [linux ç½‘ç»œè™šæ‹ŸåŒ–ï¼šmacvlan](https://cizixs.com/2017/02/14/network-virtualization-macvlan/)\n- macvlan ç‰¹æ€§ç”± `Linux kernel` æ”¯æŒï¼Œç¬”è€…çš„å®éªŒç¯å¢ƒæ»¡è¶³ macvlan çš„è¦æ±‚ï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¡®å®šï¼š  \n  ```bash\n  $ sudo lsmod | grep macvlan\n  # è‹¥æ— ä»»ä½•è¿”å›ï¼Œè¯´æ˜è¿˜æœªåŠ è½½ macvlan å†…æ ¸æ¨¡å—ã€‚\n  $ sudo modprobe macvlan\n  # åŠ è½½ macvlan å†…æ ¸æ¨¡å—ï¼Œè‹¥æ‰§è¡ŒæŠ¥é”™ï¼Œè¯´æ˜ kernel ä¸æ”¯æŒè¯¥ç‰¹æ€§ã€‚\n  ```\n- podman ä¸ macvlan ç±»å‹ç½‘ç»œçš„é›†æˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  $ sudo podman network create -d macvlan -o parent=ens33 <network_name>\n    /etc/cni/net.d/<network_name>.conflist\n  # åˆ›å»º macvlan ç±»å‹ç½‘ç»œ  \n  $ sudo podman network ls\n  $ sudo /opt/cni/bin/dhcp daemon\n  # åœ¨å¦ä¸€ä¸ªçª—å£ä¸­å¯åŠ¨ dhcp å®ˆæŠ¤è¿›ç¨‹ä¾› macvlan æ’ä»¶è°ƒç”¨ï¼Œä¸ºå®¹å™¨ç½‘å£åˆ†é… IP åœ°å€ã€‚\n  $ sudo podman run -it --rm \\\n    --name <container_name> --network=<network_name> \\\n    <container_image>:<tag> /bin/sh\n  # åˆ›å»ºæ”¯æŒ macvlan ç±»å‹ç½‘ç»œçš„ rootfull å®¹å™¨  \n  ```\n- ä»ä¸ rootfull å®¹å™¨åœ¨åŒä¸€å¹¿æ’­åŸŸçš„å…¶ä»–èŠ‚ç‚¹ä¸Š ping è¯¥å®¹å™¨ï¼Œå¯æ­£å¸¸é€šä¿¡ï¼š  \n  ![podman-macvlan-network.png](podman-macvlan-network.png)\n  \n  > ğŸ¤” ä»¥ä¸Šç¤ºä¾‹çš„å®¹å™¨ä¸­è¿è¡Œ Web æœåŠ¡ï¼ˆå¯æš´éœ² 443 ç«¯å£ï¼‰ï¼Œä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼å¯æ‰“é€šä¸åŒä¸€å¹¿æ’­åŸŸä¸­å¤–éƒ¨èŠ‚ç‚¹çš„é€šä¿¡ï¼Œä½†æ— æ³•è®¿é—®å…¶ä¸­çš„æœåŠ¡ï¼Œå¯é‡‡å–ä½•ç§æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼Ÿ  \n\n### Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\n- Podman rootless å®¹å™¨çš„å®ç°æ ¸å¿ƒåœ¨äºè§£å†³ network namespaceï¼ˆNetNSï¼‰ ä¸ user namespaceï¼ˆUserNSï¼‰ çš„é—®é¢˜ï¼Œå‰æ–‡å·²ä»‹ç» NetNS çš„å®ç°æ–¹å¼ï¼Œåæ–‡å°†ä»‹ç» UserNS çš„å®ç°æ–¹å¼ã€‚\n- è‹¥è¦ä½¿ç”¨ rootless å®¹å™¨ï¼Œéœ€ç¡®è®¤ OS æ˜¯å¦å¼€å¯ user namespace åŠŸèƒ½ï¼š  \n  ```bash\n  $ sudo sysctl -a | grep user\\.max_user_namespaces\n    user.max_user_namespaces = 47494\n  ```\n- ç³»ç»Ÿä¸Šæ¯åˆ›å»ºä¸€ä¸ªç”¨æˆ·å°±ä¼šåœ¨ `/etc/subuid` ä¸ `/etc/subgid` ä¸­ç”Ÿæˆå¯¹åº”ç”¨æˆ·åœ¨å…¶ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ˜ å°„è§„åˆ™ï¼Œä»¥ /etc/subuid ä¸ºä¾‹ï¼Œå‚æ•°ä»¥å†’å·åˆ†éš”ï¼Œæ¯ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆuidï¼‰ï¼šç”¨æˆ·åç§°  \n  - ç¬¬äºŒä¸ªå‚æ•°ï¼ˆloweruidï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´ä¸­èµ·å§‹çš„æ˜ å°„ uid\n- ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆcountï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´å†…éƒ¨ä¸å¤–éƒ¨å¯æ˜ å°„ uid æ•°é‡ï¼ˆå¯ç†è§£ä¸ºæ‰€æœ‰å®¹å™¨æ™®é€šç”¨æˆ·çš„ uid æ•°é‡å’Œï¼‰  \n  ![rootless-user-namespace-mapping.jpg](rootless-user-namespace-mapping.jpg)\n- ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶å…è®¸è¿è¡Œè¿›ç¨‹çš„ uid æ˜ å°„èŒƒå›´ï¼Œåœ¨ `/proc/<pid>/uid_map` ä¸­å®šä¹‰ã€‚\n- å¯è¿‡æ»¤å®¹å™¨ `conmon` è¿›ç¨‹çš„ pid ç¡®è®¤æ¯ä¸ªå®¹å™¨ä¸­çš„ uid æ˜ å°„æƒ…å†µï¼Œå‚è§ä»¥ä¸‹ç¤ºä¾‹ã€‚\n- å…³äºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶çš„å…·ä½“è¯´æ˜å¯å‚è€ƒ `newuidmap` ä¸ `newgidmap` å‘½ä»¤çš„ man æ‰‹å†Œã€‚\n- å¯å‚è€ƒ Podman å®˜æ–¹æ¨èçš„å‘½ä»¤åˆ›å»º uid çš„æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  $ sudo usermod --add-subuids 10000-75535 $(whoami)\n  \n  # ----- ç¤ºä¾‹ -----\n  $ sudo cat /etc/subuid\n    appuser:10000:500\n  $ sudo cat /etc/subgid\n    appuser:500:50\n  # è¯¥ç”¨æˆ·åˆ›å»ºçš„ user namespace ä¸­å¯ä»¥ä½¿ç”¨ä» 10000 å¼€å§‹çš„ 500 ä¸ª UID å’Œä» 500 å¼€å§‹çš„ 50 ä¸ª GID çš„æ˜ å°„ã€‚\n  ```\n- ğŸš€ ç¤ºä¾‹ï¼š  \n  æ™®é€šç”¨æˆ· hualf åœ¨ /etc/subuid ä¸­æ˜ å°„ä¸º hualf:165536:65536ï¼Œè¯´æ˜åœ¨è¯¥ç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯åµŒå¥—ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·å‘½åç©ºé—´ï¼ˆæˆ–å®¹å™¨ï¼‰ï¼Œæ¯ä¸ªå®¹å™¨ä¸­çš„ root ç”¨æˆ· uid 0 éƒ½æ˜ å°„ä¸º hualf ç”¨æˆ·çš„ uid 1001ï¼ˆè¿è¡Œå®¹å™¨è¿›ç¨‹çš„ç”¨æˆ·ï¼‰ï¼Œè€Œå®¹å™¨ä¸­æ™®é€šç”¨æˆ·çš„ uid æ˜ å°„è‡³å®¿ä¸»æœºçš„ subuid èŒƒå›´ä¸­ï¼Œå¯¹äºæ­¤ä¾‹ subuid èŒƒå›´ä¸º 165536~231071ï¼Œå®¹å™¨ä¸­çš„ uid 1 ç”¨æˆ·æ˜ å°„ä¸ºå®¿ä¸»æœº uid 165536ï¼Œå› æ­¤å®¹å™¨ä¸­ admin ç”¨æˆ· uid 1000 æ˜ å°„ä¸ºå®¿ä¸»æœº uid 166535ï¼ˆ165536+999ï¼‰ã€‚  \n  é€šè¿‡å®¹å™¨å®¿ä¸»æœºä¸Šæ¯ä¸ªæ™®é€šç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´çš„ subuid æ˜ å°„èŒƒå›´ï¼Œå¯åˆ†é…ä¼—å¤š uid åœ¨ rootless å®¹å™¨ä¸­è¿è¡Œåº”ç”¨è¿›ç¨‹ã€‚  \n  ![user-namespace-subuid-mapping-1-edited.png](user-namespace-subuid-mapping-1-edited.png)![user-namespace-subuid-mapping-2-edited.png](user-namespace-subuid-mapping-2-edited.png)\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Reintroduction of Podman](https://projectatomic.io/blog/2018/02/reintroduction-podman/)\n- [Using pods with Podman on Fedora](https://fedoramagazine.org/podman-pods-fedora-containers/)\n- [Configuring container networking with Podman](https://www.redhat.com/sysadmin/container-networking-podman)\n- [RedHat docs - Building, running, and managing Linux containers on Red Hat Enterprise Linux 8](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/index)\n- [å®¹å™¨å®‰å…¨æ‹¾é— - Rootless Containeråˆæ¢](https://developer.aliyun.com/article/700923)\n- [Documentation for /proc/sys/user/](https://www.kernel.org/doc/html/latest/admin-guide/sysctl/user.html)\n- [docker docs - Overview of Docker Compose](https://docs.docker.com/compose/)\n- [CNI docs - firewall plugin](https://www.cni.dev/plugins/current/meta/firewall/)\n- [CNI docs - Port-mapping plugin](https://www.cni.dev/plugins/current/meta/firewall/)\n- https://fossies.org/linux/podman/docs/tutorials/basic_networking.md\n","slug":"podman-arch-usage","published":1,"updated":"2022-12-05T07:11:38.946Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonols000g16vdrnw9xusi","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>å®éªŒç”¨ OS ç‰ˆæœ¬ï¼š  <ul>\n<li>CentOS 7.9ã€RHEL 8.0ã€RHEL 8.2ã€Ubuntu 20.04.3 LTS</li>\n</ul>\n</li>\n<li>å®éªŒç”¨ kernel ç‰ˆæœ¬ï¼š  <ul>\n<li>3.10.0-1160.41.1.el7.x86_64  </li>\n<li>4.18.0-193.el8.x86_64  </li>\n<li>5.14.0-1.el7.elrepo.x86_64</li>\n</ul>\n</li>\n<li>å®éªŒç”¨ Podman ç‰ˆæœ¬ï¼š1.6.4ã€3.2.3ã€3.3.1</li>\n<li>å®éªŒç”¨ podman-compose ç‰ˆæœ¬ï¼š0.1.8</li>\n<li>å®éªŒç”¨ Docker ç‰ˆæœ¬ï¼š20.10.8</li>\n<li>è‹¥æœªåšç‰¹æ®Šè¯´æ˜ï¼Œä»¥ä¸‹ç¤ºä¾‹å‡äº <code>RHEL 8.2</code>ï¼ˆ<code>4.18.0-193.el8.x86_64</code>ï¼‰ä¸Šæ‰§è¡Œï¼ŒPodman ç‰ˆæœ¬ä¸º <code>3.2.3</code>ã€‚</li>\n<li>è¯¥æ–‡æ¡£ä¸­æœªæ¶‰åŠ podman å‘½ä»¤çš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ï¼Œå¯å‚é˜… <a href=\"https://mp.weixin.qq.com/s/MDi4RB5V60EGl3ii9usD0Q\" target=\"_blank\" rel=\"noopener\">è¯¥æ–‡æ¡£</a> åŠ ä»¥ç†Ÿæ‚‰ã€‚</li>\n<li>ğŸ’¥ é‡è¦æç¤ºï¼šPodman é¡¹ç›®æ­£åœ¨ä¸æ–­æ¼”è¿›ä¸å®Œå–„ä¸­ï¼Œè¯·ä»¥è‡ªèº«ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºå‡†è¿›è¡Œæµ‹è¯•ä¸ä½¿ç”¨ï¼</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Podman çš„ç‰¹æ€§æ¦‚è¿°</li>\n<li>Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒ</li>\n<li>Podman çš„æ‰©å±•åŠŸèƒ½</li>\n<li>Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…</li>\n<li>Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒ</li>\n<li>Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰</li>\n<li>Podman çš„ macvlan ç½‘ç»œå®ç°</li>\n<li>Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"Podman-çš„ç‰¹æ€§æ¦‚è¿°ï¼š\"><a href=\"#Podman-çš„ç‰¹æ€§æ¦‚è¿°ï¼š\" class=\"headerlink\" title=\"Podman çš„ç‰¹æ€§æ¦‚è¿°ï¼š\"></a>Podman çš„ç‰¹æ€§æ¦‚è¿°ï¼š</h3><ul>\n<li>LXCã€<code>LXD</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ã€<code>systemd-nspawn</code> å‡å¯ä½œä¸º Linux å®¹å™¨ï¼Œä½†ç¼ºå°‘å®¹å™¨è·¨ä¸»æœºè¿è¡Œä¸åº”ç”¨æ‰“åŒ…çš„èƒ½åŠ›ã€‚</li>\n<li>Docker ä¸ Podman å¯ä½¿ç”¨å®¹å™¨é•œåƒå®ç°åº”ç”¨æ‰“åŒ…å‘å¸ƒï¼Œå¿«é€Ÿä¸”è½»é‡ã€‚</li>\n<li>Docker ä¸ Podman éƒ½ä½¿ç”¨ <code>runC</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸ºåº•å±‚ <code>oci-runtime</code>ã€‚</li>\n<li>Docker ä¸ Podman éƒ½æ”¯æŒ <code>OCI Image Format</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ï¼Œéƒ½èƒ½ä½¿ç”¨ DockerHub ä¸Šçš„å®¹å™¨é•œåƒï¼Œè€Œ systemd-nspawn æ— æ³•ä½¿ç”¨å®ƒä»¬çš„é•œåƒã€‚</li>\n<li>ğŸ‘‰ Podman ä½¿ç”¨ <code>CNI</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸º rootfull å®¹å™¨ç½‘ç»œåº•å±‚ï¼Œå®ç°æ¯” Docker ç½‘ç»œå±‚ç•¥å¾®ç®€å•ä½†åŸç†ç›¸åŒã€‚</li>\n<li>ç›¸å¯¹äº LXD ä¸ systemd-nspawnï¼ŒCNI å¯ä»¥é¿å…ç¼–å†™å¤§é‡çš„ç½‘ç»œè§„åˆ™ã€‚</li>\n<li>ğŸš€ ä¸ºäº†å®ç°æ™®é€šç”¨æˆ· rootless å®¹å™¨ç½‘ç»œï¼ŒPodman å¯ä»¥ä½¿ç”¨ <code>slirp4netns</code> ç¨‹åºï¼Œé¿å… <code>kernel space</code> ä¸­çš„å¤§é‡ <code>veth pair</code> è™šæ‹Ÿæ¥å£çš„å‡ºç°, å¹¶ä¸”æ€§èƒ½æ›´å¥½ã€‚</li>\n<li>Docker è¿è¡Œå®¹å™¨å¿…é¡»ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸”ä½¿ç”¨ root æƒé™ï¼Œå­˜åœ¨ç³»ç»Ÿå®‰å…¨é—®é¢˜ï¼Œè€Œ Podman é’ˆå¯¹æ­¤é—®é¢˜ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªç‰¹æ€§åŠ ä»¥è§£å†³ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <ul>\n<li>Podman æ”¯æŒæ— å®ˆæŠ¤è¿›ç¨‹ï¼ˆ<code>no-daemon</code>ï¼‰è¿è¡Œå®¹å™¨ã€‚  </li>\n<li>Podman æ”¯æŒæ™®é€šç”¨æˆ·è¿è¡Œ <code>rootless</code> å®¹å™¨ï¼Œå³ï¼Œæ™®é€šç”¨æˆ·ç›´æ¥è¿è¡Œå®¹å™¨æ— éœ€ææƒå…·æœ‰ root æƒé™ã€‚</li>\n</ul>\n</li>\n<li>è™½ç„¶ Docker ä¸ Podman çš„å®ç°åŸç†ä¸åŒï¼Œä½†å¯¹äºä½¿ç”¨è€…è€Œè¨€å…¶ CLI ååˆ†ç›¸ä¼¼ï¼Œå¯å¹³æ»‘åœ°ä» Docker è¿‡æ¸¡è‡³ Podmanã€‚</li>\n<li>Podman çš„ç›®æ ‡ä¸æ˜¯å®¹å™¨çš„ç¼–æ’ï¼Œç¼–æ’å¯ä»¥ä½¿ç”¨æ›´åŠ ä¸“ä¸šçš„ Kubernetesã€Open Shiftã€Rancher ç­‰ï¼Œä½¿ç”¨ Podman å¯ä»¥æ›´è½»é‡çš„è¿è¡Œå®¹å™¨ä¸”ä¸å— root æƒé™çš„å®‰å…¨é—®é¢˜ï¼Œå³ä¾¿æ˜¯ root ç”¨æˆ·ä¹Ÿæ— æ³•æŸ¥çœ‹å…¶å®ƒæ™®é€šç”¨æˆ·ç©ºé—´ä¸‹çš„å®¹å™¨ï¼ŒPodman é€šè¿‡ <code>user namespace</code> è¿›è¡Œéš”ç¦»ã€‚</li>\n<li>ğŸ‘‰ Podman å¯ä½¿ç”¨ <code>systemd service</code> å•å…ƒæ–‡ä»¶ç›´æ¥ç®¡ç†å®¹å™¨ï¼Œå®ç°å®¹å™¨æœåŠ¡éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ã€‚</li>\n<li>ğŸ‘‰ Podman é‡Œé›†æˆäº† <code>CRIU</code>ï¼Œå› æ­¤ Podman ä¸­çš„å®¹å™¨å¯ä»¥åœ¨å•æœºä¸Šçƒ­è¿ç§»ã€‚</li>\n<li>ç”±äº Kubernetes å°†ä» <code>v1.24.x</code> ç‰ˆæœ¬åæ”¾å¼ƒä½¿ç”¨ <code>dockershim</code> æ¥å£å±‚ï¼Œå®¹å™¨è¿è¡Œæ—¶å¯é€‰æ‹©ä½¿ç”¨ <code>Containerd</code> æˆ–è€… <code>CRI-O</code>ï¼Œä¸¤è€…è™½ç„¶å‡æ”¯æŒ OCI image è§„èŒƒï¼Œä½†å®ƒä»¬ä¸æ˜¯é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…ç›´æ¥ç®¡ç†å®¹å™¨æˆ–é•œåƒçš„å·¥å…·ï¼Œè€Œ Podman å¯ç›´æ¥é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…æ“ä½œå®¹å™¨æˆ–é•œåƒã€‚</li>\n<li>Podman å‘½ä»¤çš„å­è¿›ç¨‹åˆ›å»º pod ä¸å®¹å™¨ã€‚</li>\n</ul>\n<h3 id=\"Podman-ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\"><a href=\"#Podman-ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\" class=\"headerlink\" title=\"Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\"></a>Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š</h3><ul>\n<li>Podman ç‰ˆæœ¬ã€kernel ç‰ˆæœ¬ä¸ OS ç‰ˆæœ¬çš„å…¼å®¹æ€§å°†ç›´æ¥å½±å“æ™®é€šç”¨æˆ·ä½¿ç”¨ rootless å®¹å™¨ã€‚</li>\n<li><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œkernel ä¸æ”¯æŒ rootless å®¹å™¨ï¼š<br><img src=\"centos79-kernel-not-support-podman-rootless.jpg\" alt=\"centos79-kernel-not-support-podman-rootless.jpg\"></p>\n</li>\n<li><p>æ™®é€šç”¨æˆ· rootless å®¹å™¨å…¼å®¹æ€§æ¯”è¾ƒï¼š<br><img src=\"podman-version-compare.png\" alt=\"podman-version-compare.png\"></p>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<p>rootless å®¹å™¨ç‰¹æ€§å–å†³äº kernel çš„ç‰ˆæœ¬ï¼Œä¸å–å†³äº OS ä¸ Podman çš„ç‰ˆæœ¬ã€‚</p>\n</blockquote>\n<ul>\n<li>ç”±äº <code>user namespace</code> ç‰¹æ€§åœ¨ kernel <code>4.9.0</code> ä¹‹åå‡ºç°ï¼Œå› æ­¤å‡çº§ kernel å³å¯è§£å†³ rootless é—®é¢˜ã€‚</li>\n<li>å…³äº rootless ç‰¹æ€§åœ¨ RHEL 8 ä¸­çš„è®¾ç½®ï¼Œå¯ <a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/assembly_starting-with-containers_building-running-and-managing-containers#proc_setting-up-rootless-containers_assembly_starting-with-containers\" target=\"_blank\" rel=\"noopener\">ç‚¹å‡»æ­¤å¤„</a> å‚è€ƒ Red Hat çš„å®˜æ–¹é…ç½®è¯´æ˜ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Podman-çš„æ‰©å±•åŠŸèƒ½ï¼š\"><a href=\"#Podman-çš„æ‰©å±•åŠŸèƒ½ï¼š\" class=\"headerlink\" title=\"Podman çš„æ‰©å±•åŠŸèƒ½ï¼š\"></a>Podman çš„æ‰©å±•åŠŸèƒ½ï¼š</h3><ul>\n<li><p><code>cockpit-podman</code> è½¯ä»¶åŒ…ä½œä¸º cockpit æ’ä»¶å¯é›†æˆäº <code>Web UI</code> ä¸­ï¼Œå®ç° Web UI ç®¡ç†å®¹å™¨ã€‚  </p>\n<ul>\n<li><p>cockpit-podman æœåŠ¡å®‰è£…ä¸å¯ç”¨ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y cockpit-podman</span><br><span class=\"line\">$ sudo systemctl <span class=\"built_in\">enable</span> --now cockpit.socket</span><br><span class=\"line\">$ sudo systemctl status cockpit.service</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… cockpit-podman è½¯ä»¶åŒ…ï¼Œå¹¶å¯ç”¨ cockpit æœåŠ¡ã€‚</span></span><br><span class=\"line\">$ sudo netstat -tunlp | grep 9090</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ systemd ç›‘å¬çš„ 9090 ç«¯å£æ˜¯å¦å¯ç”¨</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åœ¨ Web UI ä¸­å¯æŸ¥çœ‹å¹¶ç®¡ç† podman å®¹å™¨ä¸é•œåƒï¼š<br><img src=\"cockpit-podman-1.jpg\" alt=\"podman-arch-usage/cockpit-podman-1.jpg\"><img src=\"cockpit-podman-2.jpg\" alt=\"cockpit-podman-2.jpg\"></p>\n</li>\n</ul>\n</li>\n<li><code>podman-compose</code> æ—¨åœ¨ä½¿ç”¨æ›´è½»é‡çš„æ–¹å¼å®ç°<code>å•æœºå®¹å™¨ç¼–æ’</code>ï¼Œä»¥ç”¨äºæ›¿æ¢ <code>docker-compose</code>ï¼Œè¿™ç§æ–¹å¼å°†ä¸å†ä¾èµ–å®ˆæŠ¤è¿›ç¨‹ä¸ root æƒé™ï¼ŒåŒæ—¶å¯ä½¿ç”¨ rootless å®¹å™¨ï¼Œè¯¦ç»†ç¤ºä¾‹è§ä¸‹æ–‡ã€‚</li>\n<li>podman-compose ä½¿ç”¨ <code>Python</code> å¼€å‘ï¼Œå› æ­¤å¯ç›´æ¥ä½¿ç”¨ <code>pip3</code> å®‰è£…è¯¥ç»„ä»¶ï¼Œæˆ–ä½¿ç”¨ rpm è½¯ä»¶åŒ…æ–¹å¼å®‰è£…ã€‚</li>\n<li>ç”±äº podman-compose ä¾ç„¶å¤„äº <code>dev</code> é˜¶æ®µï¼Œä»…ä½œä¸ºåŠŸèƒ½æµ‹è¯•ä½¿ç”¨ï¼Œæš‚æœªå—åˆ° GA ç¯å¢ƒæ”¯æŒã€‚</li>\n</ul>\n<h3 id=\"Podman-åœ¨ä¸åŒ-OS-ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\"><a href=\"#Podman-åœ¨ä¸åŒ-OS-ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\" class=\"headerlink\" title=\"Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\"></a>Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š</h3><ul>\n<li><p>CentOS 7.x/8.x æˆ– RHEL 7.x/8.x ä¸­ï¼šyum å‘½ä»¤ä½¿ç”¨ podman <code>rpm</code> è½¯ä»¶åŒ…å®‰è£…  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y podman-3.2.3-0.11.module_el8.4.0+942+d25aada8.x86_64</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… podman æœ€æ–°ç‰ˆæœ¬ï¼Œä½ç‰ˆæœ¬ podman å­˜åœ¨è¾ƒå¤š bugã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. éœ€é…ç½® CentOS 8 çš„ yum è½¯ä»¶æºä»¥å®‰è£…æœ€æ–°ç‰ˆçš„ podman åŠå…¶ä¾èµ–è½¯ä»¶åŒ…</span></span><br><span class=\"line\"><span class=\"comment\">#   2. yum å®‰è£… podman æ—¶ä¹Ÿå°†å®‰è£… containernetworking-plugins è½¯ä»¶åŒ…</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ¤˜ Ubuntu 20.04.2 LTS ä¸­ï¼šapt-get å‘½ä»¤ä½¿ç”¨ podman <code>deb</code> è½¯ä»¶åŒ…å®‰è£…  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ . /etc/os-release</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰çš„ç³»ç»Ÿå‘è¡Œç‰ˆ</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/ /\"</span> | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list</span><br><span class=\"line\">$ curl -L <span class=\"string\">\"https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/Release.key\"</span> | sudo apt-key add -</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ  podman è½¯ä»¶æºä¸ apt å…¬é’¥</span></span><br><span class=\"line\">$ sudo apt-get update -y</span><br><span class=\"line\">$ sudo apt-get upgrade -y</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–°ç³»ç»Ÿè½¯ä»¶æºå¹¶å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…</span></span><br><span class=\"line\">$ sudo apt-get install -y podman</span><br><span class=\"line\">  Reading package lists... Done</span><br><span class=\"line\">  Building dependency tree       </span><br><span class=\"line\">  Reading state information... Done</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  The following NEW packages will be installed:</span><br><span class=\"line\">    catatonit conmon containernetworking-plugins containers-common criu crun fuse-overlayfs fuse3 libfuse3-3 libnet1 libprotobuf-c1</span><br><span class=\"line\">    podman podman-machine-cni podman-plugins</span><br><span class=\"line\">  ...</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… podman ä¸ç›¸å…³çš„è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ conmonã€containernetworking-pluginsã€crun ç­‰ã€‚</span></span><br></pre></td></tr></table></figure>\n<p>å®‰è£…å‚è€ƒé“¾æ¥ï¼š  </p>\n<ul>\n<li><a href=\"https://podman.io/getting-started/installation\" target=\"_blank\" rel=\"noopener\">Podman Doc - installation</a></li>\n<li><a href=\"https://www.hostnextra.com/kb/easy-to-install-podman-on-ubuntu-20-04/\" target=\"_blank\" rel=\"noopener\">Easy to Install Podman on Ubuntu 20.04</a></li>\n<li><a href=\"https://software.opensuse.org//download.html?project=devel%3Akubic%3Alibcontainers%3Astable&amp;package=podman\" target=\"_blank\" rel=\"noopener\">podman from devel:kubic:libcontainers:stable project</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ğŸ¤˜-Docker-ä¸-Podman-è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\"><a href=\"#ğŸ¤˜-Docker-ä¸-Podman-è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\" class=\"headerlink\" title=\"ğŸ¤˜ Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\"></a>ğŸ¤˜ Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š</h3><ul>\n<li><p>Docker v20.10.8 ä½¿ç”¨ <code>dockerd</code> ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å®¹å™¨ä¸é•œåƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿è¡ŒçŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo systemctl status docker.service</span><br><span class=\"line\">â— docker.service - Docker Application Container Engine</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class=\"line\">   Active: active (running) since Wed 2022-10-19 10:53:04 CST; 6min ago</span><br><span class=\"line\">     Docs: https://docs.docker.com</span><br><span class=\"line\"> Main PID: 79556 (dockerd)</span><br><span class=\"line\">    Tasks: 21</span><br><span class=\"line\">   Memory: 42.6M</span><br><span class=\"line\">   CGroup: /system.slice/docker.service</span><br><span class=\"line\">           â”œâ”€79556 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\">           â”œâ”€79677 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 4000 -container-ip 172.17.0.2 -container-port 4000</span><br><span class=\"line\">           â””â”€79683 /usr/bin/docker-proxy -proto tcp -host-ip :: -host-port 4000 -container-ip 172.17.0.2 -container-port 4000</span><br><span class=\"line\"></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.197803867+08:00\"</span> level=info msg=<span class=\"string\">\"scheme \\\"unix\\\" not registered, fallback to default scheme\"</span> module=grpc</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.197837924+08:00\"</span> level=info msg=<span class=\"string\">\"ccResolverWrapper: sending update to cc: &#123;[&#123;unix:///run/containerd/containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;] &lt;nil&gt; &lt;nil&gt;&#125;\"</span> module=grpc</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.197860326+08:00\"</span> level=info msg=<span class=\"string\">\"ClientConn switching balancer to \\\"pick_first\\\"\"</span> module=grpc</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.220416627+08:00\"</span> level=info msg=<span class=\"string\">\"Loading containers: start.\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.347884960+08:00\"</span> level=info msg=<span class=\"string\">\"Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.725361851+08:00\"</span> level=info msg=<span class=\"string\">\"Loading containers: done.\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.755449128+08:00\"</span> level=info msg=<span class=\"string\">\"Docker daemon\"</span> commit=75249d8 graphdriver(s)=overlay2 version=20.10.8</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.755527994+08:00\"</span> level=info msg=<span class=\"string\">\"Daemon has completed initialization\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com systemd[1]: Started Docker Application Container Engine.</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.776865058+08:00\"</span> level=info msg=<span class=\"string\">\"API listen on /var/run/docker.sock\"</span></span><br><span class=\"line\"><span class=\"comment\"># dockerd å®ˆæŠ¤è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo systemctl status containerd</span><br><span class=\"line\">â— containerd.service - containerd container runtime</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled)</span><br><span class=\"line\">   Active: active (running) since Tue 2022-10-18 15:08:06 CST; 20h ago</span><br><span class=\"line\">     Docs: https://containerd.io</span><br><span class=\"line\"> Main PID: 1892 (containerd)</span><br><span class=\"line\">    Tasks: 20</span><br><span class=\"line\">   Memory: 103.4M</span><br><span class=\"line\">   CGroup: /system.slice/containerd.service</span><br><span class=\"line\">           â”œâ”€ 1892 /usr/bin/containerd</span><br><span class=\"line\">           â””â”€79696 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># containerd é€šè¿‡è°ƒç”¨ containerd-shim-runc-v2 è¿è¡ŒæŒ‡å®šå®¹å™¨</span></span><br><span class=\"line\">$ sudo ps -ef | grep -E <span class=\"string\">\"dockerd|containerd|containerd-shim-runc-v2\"</span></span><br><span class=\"line\">  root       1892      1  0 Oct18 ?        00:05:01 /usr/bin/containerd</span><br><span class=\"line\">  root      79556      1  0 10:53 ?        00:00:03 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\">  root      79696      1  0 10:53 ?        00:00:01 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># PID 79696 ä¸ºå®é™…çš„å®¹å™¨è¿è¡Œè¿›ç¨‹</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Podman ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œæˆ–ç®¡ç†å®¹å™¨ï¼Œå¯¹äº rootfull å®¹å™¨æˆ– rootless å®¹å™¨çš„è¿è¡Œæ–¹å¼å­˜åœ¨å·®å¼‚ï¼š  </p>\n<ul>\n<li><p>rootfull å®¹å™¨çš„è¿›ç¨‹ï¼š<br>ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  root        3879    3476  1 06:31 pts/3    00:00:00 podman run -it --name=mydebian docker.io/library/debian:latest /bin/sh</span><br><span class=\"line\">  root        3945       1  0 06:31 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -u 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata -p /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/pidfile -n mydebian --<span class=\"built_in\">exit</span>-dir /run/libpod/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/oci-log -t --conmon-pidfile /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/containers/storage --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/libpod --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg cni --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --storage-opt --<span class=\"built_in\">exit</span>-command-arg overlay.mountopt=nodev,metacopy=on --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba</span><br><span class=\"line\"><span class=\"comment\"># ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ‘‰ ä»¥ <code>detach</code> æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  root        3744       1  0 06:25 ?        00:00:00 /usr/bin/conmon --api-version 1 -c b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -u b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata -p /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/pidfile -n apache-rhce8.2-alpine --<span class=\"built_in\">exit</span>-dir /run/libpod/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/oci-log --conmon-pidfile /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/containers/storage --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/libpod --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg cni --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --storage-opt --<span class=\"built_in\">exit</span>-command-arg overlay.mountopt=nodev,metacopy=on --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272</span><br><span class=\"line\"><span class=\"comment\"># podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œè€Œ rootfull å®¹å™¨çš„ CNI æ’ä»¶</span></span><br><span class=\"line\"><span class=\"comment\"># å¯ç›´æ¥ä½¿ç”¨ iptables çš„æ–¹å¼å®ç°ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>rootless å®¹å™¨çš„è¿›ç¨‹ï¼š<br>ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  core        3418    2762  0 06:17 pts/2    00:00:05 podman run -it --name=mybusybox docker.io/library/busybox:latest /bin/sh</span><br><span class=\"line\">  core        3430    3418  0 06:17 pts/2    00:00:00 /usr/bin/slirp4netns --<span class=\"built_in\">disable</span>-host-loopback --mtu=65520 --<span class=\"built_in\">enable</span>-sandbox --<span class=\"built_in\">enable</span>-seccomp --<span class=\"built_in\">enable</span>-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-19eb5630-c0a8-4ea9-8790-76ecdcdf2dbc tap0</span><br><span class=\"line\">  core        3433       1  0 06:17 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -u 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -r /usr/bin/crun -b /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata -p /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/pidfile -n mybusybox --<span class=\"built_in\">exit</span>-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/oci-log -t --conmon-pidfile /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/containers --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/libpod/tmp --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg netavark --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160</span><br><span class=\"line\"><span class=\"comment\"># ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹ï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\"># ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚</span></span><br><span class=\"line\">``` </span><br><span class=\"line\">ğŸ‘‰ ä»¥ `detach` æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š   </span><br><span class=\"line\">```bash</span><br><span class=\"line\">$ ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  core        3308       1  0 06:15 pts/2    00:00:00 /usr/bin/slirp4netns --<span class=\"built_in\">disable</span>-host-loopback --mtu=65520 --<span class=\"built_in\">enable</span>-sandbox --<span class=\"built_in\">enable</span>-seccomp --<span class=\"built_in\">enable</span>-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-f9f6f9dd-bf80-f6ca-6f39-7c9d9cd6beea tap0</span><br><span class=\"line\">  core        3325       1  0 06:15 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -u 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -r /usr/bin/crun -b /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata -p /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/pidfile -n apache-rhce8.2-alpine --<span class=\"built_in\">exit</span>-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/oci-log --conmon-pidfile /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/containers --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/libpod/tmp --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg netavark --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab</span><br><span class=\"line\"><span class=\"comment\"># podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\"># ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Podman-çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull-ä¸-rootlessï¼‰ï¼š\"><a href=\"#Podman-çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull-ä¸-rootlessï¼‰ï¼š\" class=\"headerlink\" title=\"Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰ï¼š\"></a>Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰ï¼š</h3><ul>\n<li>Podman æ”¯æŒçš„å®¹å™¨ç½‘ç»œæ¨¡å¼å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"podman-network-mode.jpg\" alt=\"podman-network-mode.jpg\"></li>\n<li><p>root ç”¨æˆ·è¿è¡Œ rootfull å®¹å™¨ç½‘ç»œåˆ†æï¼š  </p>\n<ul>\n<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œrootfull å®¹å™¨ä½¿ç”¨ bridge ç½‘ç»œæ¨¡å¼ï¼Œå¹¶ä¸”åœ¨æœªåˆ›å»ºä»»ä½•å®¹å™¨å‰ç³»ç»Ÿä¸Šä¸ä¼šè‡ªåŠ¨åˆ›å»º <code>cni-podman0</code>ç½‘æ¡¥ï¼Œåªæœ‰åˆ›å»ºå®¹å™¨åè‡ªåŠ¨ç”Ÿæˆã€‚  </li>\n<li><p>root ç”¨æˆ·ä½¿ç”¨å…¨å±€èŒƒå›´å†…çš„ CNI æ’ä»¶ï¼Œpodman é»˜è®¤ä½¿ç”¨ <code>bridge</code>ã€<code>portmap</code> æ’ä»¶ï¼Œå…¶é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/cni/net.d/87-podman-bridge.conflist</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"cniVersion\"</span>: <span class=\"string\">\"0.4.0\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"podman\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"plugins\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"bridge\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"bridge\"</span>: <span class=\"string\">\"cni-podman0\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"isGateway\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ipMasq\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">\"hairpinMode\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ipam\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"type\"</span>: <span class=\"string\">\"host-local\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"routes\"</span>: [&#123; <span class=\"string\">\"dst\"</span>: <span class=\"string\">\"0.0.0.0/0\"</span> &#125;],</span><br><span class=\"line\">        <span class=\"string\">\"ranges\"</span>: [</span><br><span class=\"line\">          [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"string\">\"subnet\"</span>: <span class=\"string\">\"10.88.0.0/16\"</span>,</span><br><span class=\"line\">              <span class=\"string\">\"gateway\"</span>: <span class=\"string\">\"10.88.0.1\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"portmap\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"capabilities\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"portMappings\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"firewall\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"tuning\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\"><span class=\"comment\"># è¯¥é…ç½®æ–‡ä»¶ä½äº Podman æºç  cni/87-podman-bridge.conflist</span></span><br><span class=\"line\"><span class=\"comment\"># Podman å¯è°ƒç”¨ bridgeã€portmap ç­‰ CNI æ’ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo podman inspect &lt;container_name&gt; | jq .[0].HostConfig.NetworkMode</span><br><span class=\"line\">  <span class=\"string\">\"bridge\"</span></span><br><span class=\"line\"><span class=\"comment\"># root ç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>root ç”¨æˆ·åˆ›å»ºå…·æœ‰ç«¯å£æ˜ å°„çš„å®¹å™¨æ—¶ï¼Œiptables filter è¡¨ä¸ nat è¡¨è§„åˆ™å°†ç›¸åº”å¢åŠ ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ----- filter è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----</span></span><br><span class=\"line\">*filter</span><br><span class=\"line\">-A FORWARD -m comment --comment <span class=\"string\">\"CNI firewall plugin rules\"</span> -j CNI-FORWARD</span><br><span class=\"line\">-A CNI-FORWARD -m comment --comment <span class=\"string\">\"CNI firewall plugin admin overrides\"</span> -j CNI-ADMIN</span><br><span class=\"line\">-A CNI-FORWARD -d 10.88.0.3/32 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class=\"line\"><span class=\"comment\"># æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘ç›®æ ‡åœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œconntrack æ¨¡å—è¿›è¡Œè¿æ¥çŠ¶æ€è¿½è¸ªã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># å½“å®¹å™¨é€šè¿‡ MASQUERADE å¯¹å¤–è®¿é—®ï¼Œå›åŒ…å†æ¬¡è¿›å…¥å®¹å™¨å®¿ä¸»æœºæ—¶ä¸å†é€šè¿‡ DNAT è½¬å‘ï¼Œè€Œé€šè¿‡ conntrack </span></span><br><span class=\"line\"><span class=\"comment\"># è®°å½•çš„è¿æ¥çŠ¶æ€ç›´æ¥è½¬å‘è‡³è¯¥è§„åˆ™å¹¶é€šè¿‡ cni-podman0 ç½‘æ¡¥è¿›å…¥å®¹å™¨ã€‚</span></span><br><span class=\"line\">-A CNI-FORWARD -s 10.88.0.3/32 -j ACCEPT</span><br><span class=\"line\"><span class=\"comment\"># æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘æºåœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆå‡ºå®¹å™¨çš„æµé‡ï¼‰ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----- nat è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----</span></span><br><span class=\"line\">*nat</span><br><span class=\"line\">-A PREROUTING -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT</span><br><span class=\"line\">-A POSTROUTING -m comment --comment <span class=\"string\">\"CNI portfwd requiring masquerade\"</span> -j CNI-HOSTPORT-MASQ</span><br><span class=\"line\">-A POSTROUTING -s 10.88.0.3/32 -m comment --comment <span class=\"string\">\"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -j CNI-b6c5fb6c593e895d843cb5bd</span><br><span class=\"line\"><span class=\"comment\"># æ–°å¢è§„åˆ™ï¼šæ¥è‡ªäº 10.88.0.3 å®¹å™¨çš„æµé‡è½¬å‘è‡³ CNI-b6c5fb6c593e895d843cb5bd é“¾</span></span><br><span class=\"line\">-A OUTPUT -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT</span><br><span class=\"line\"><span class=\"comment\"># å¯ç”¨ CNI åå³åˆ›å»ºçš„è§„åˆ™ï¼Œè¯¥è§„åˆ™æ¥æ”¶æ¥è‡ªæœ¬åœ°åº”ç”¨çš„æµé‡å¹¶è½¬å‘è‡³ CNI-HOSTPORT-DNAT é“¾</span></span><br><span class=\"line\">-A CNI-HOSTPORT-SETMARK -m comment --comment <span class=\"string\">\"CNI portfwd masquerade mark\"</span> -j MARK --<span class=\"built_in\">set</span>-xmark 0x2000/0x2000</span><br><span class=\"line\">-A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE</span><br><span class=\"line\"><span class=\"comment\">### ä»¥ä¸‹ 6 æ¡åœ¨åˆ›å»ºæ–°å®¹å™¨æ—¶åŒæ—¶åˆ›å»º </span></span><br><span class=\"line\">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment <span class=\"string\">\"dnat name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -m multiport --dports 8843 -j CNI-DN-b6c5fb6c593e895d843cb</span><br><span class=\"line\"><span class=\"comment\"># è‡ªå®šä¹‰ DNAT é“¾ï¼Œå‘é€è‡³æœ¬åœ° 8843 ç«¯å£çš„æµé‡è½¬å‘è‡³ CNI-DN-b6c5fb6c593e895d843cb é“¾ã€‚</span></span><br><span class=\"line\">-A CNI-b6c5fb6c593e895d843cb5bd -d 10.88.0.0/16 -m comment --comment <span class=\"string\">\"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -j ACCEPT</span><br><span class=\"line\"><span class=\"comment\"># å…è®¸è½¬å‘ç›®æ ‡ç½‘æ®µä¸º 10.88.0.0/16 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œè¯¥ç½‘æ®µä¸ºå®¹å™¨æ‰€åœ¨çš„ç½‘ç»œã€‚</span></span><br><span class=\"line\">-A CNI-b6c5fb6c593e895d843cb5bd ! -d 224.0.0.0/4 -m comment --comment <span class=\"string\">\"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -j MASQUERADE</span><br><span class=\"line\"><span class=\"comment\"># MASQUERADE å‡ºå®¹å™¨æµé‡</span></span><br><span class=\"line\">-A CNI-DN-b6c5fb6c593e895d843cb -s 10.88.0.0/16 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK</span><br><span class=\"line\">-A CNI-DN-b6c5fb6c593e895d843cb -s 127.0.0.1/32 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK</span><br><span class=\"line\">-A CNI-DN-b6c5fb6c593e895d843cb -p tcp -m tcp --dport 8843 -j DNAT --to-destination 10.88.0.3:443</span><br><span class=\"line\"><span class=\"comment\"># è‡ªå®šä¹‰ DNAT é“¾å®ç°å®¹å™¨å®¿ä¸»æœºè‡³å®¹å™¨çš„ç«¯å£æ˜ å°„</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸš€ ç¤ºä¾‹ï¼šå¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæ¶‰åŠçš„å®¿ä¸»æœº iptablesï¼š<br><img src=\"external-access-container-web-service-iptables.jpg\" alt=\"external-access-container-web-service-iptables.jpg\">ä»å¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæµé‡å°†é€šè¿‡ PREROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ<code>CNI-HOSTPORT-DNAT</code>ã€<code>CNI-DN-xxxx</code>ã€<code>DNAT</code>ï¼‰ï¼Œç»ç”± FORWARD é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ<code>CNI-FORWARD</code>ï¼‰çš„ä¸‰å±‚è½¬å‘ä¸ <code>cni-podman0</code> ç½‘æ¡¥çš„äºŒå±‚è½¬å‘è¿›å…¥å®¹å™¨ï¼Œå®¹å™¨å¯¹å¤–å“åº”çš„æµé‡å°†ç»è¿‡ cni-podman0 ç½‘æ¡¥è½¬å‘ï¼Œå¹¶ç»è¿‡ CNI-FORWARD é“¾ä¸ POSTROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ<code>CNI-HOSTPORT-MASQ</code>ï¼‰å‡ºå®¹å™¨å®¿ä¸»æœºã€‚  </p>\n</li>\n<li><p>ğŸš€ ç¤ºä¾‹ï¼šç›´æ¥ä»å®¹å™¨å†…è®¿é—®å¤–éƒ¨æ—¶ï¼Œè¿”å›å®¹å™¨çš„å›åŒ…å°†ç›´æ¥ä½¿ç”¨ conntrack æ¨¡å—è¿½è¸ªçš„è¿æ¥çŠ¶æ€ï¼Œæµé‡é€šè¿‡ <code>CNI-FORWARD</code> é“¾çš„ä¸‰å±‚è½¬å‘ä¸ cni-podman0 çš„äºŒå±‚è½¬å‘è‡³å®¹å™¨ä¸­ï¼Œå³ï¼Œå›åŒ…è¿›å…¥å®¹å™¨å®¿ä¸»æœºä¸å†é€šè¿‡<code>CNI-HOSTPORT-DNAT</code>é“¾ã€‚<br>å¦‚ä¸‹æ‰€ç¤ºï¼Œç›¸å…³çš„ DNAT é“¾æ— æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ï¼ŒCNI-FORWARD é“¾å‡æœ‰æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ã€‚<br><img src=\"container-access-external-iptables.jpg\" alt=\"container-access-external-iptables.jpg\"></p>\n<blockquote>\n<p>ğŸ“Œ <strong>Kubernetes ç›¸å…³é—®é¢˜æç¤ºï¼š</strong></p>\n<ol>\n<li>å®¹å™¨æˆ– pod é€šè¿‡ cni ç½‘æ¡¥æ¡¥æ¥çš„æ–¹å¼åœ¨ Kubernetes æˆ– OpenShift3 ä¸­éœ€åœ¨è®¡ç®—èŠ‚ç‚¹ï¼ˆworker nodeï¼‰ä¸Šé…ç½® <code>net.bridge.bridge-nf-call-iptables</code> ä¸ <code>net.bridge.bridge-nf-call-iptables6</code> å†…æ ¸å‚æ•°ï¼Œä½¿ cni äºŒå±‚ç½‘æ¡¥å¯è°ƒç”¨ iptables çš„ conntrack æ¨¡å—ï¼Œä»¥è§£å†³å‰åç«¯ pod åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šæ—¶ï¼Œç”±äº pod ç›´è¿ cni äºŒå±‚ç½‘æ¡¥ï¼Œè€ŒäºŒå±‚ç½‘æ¡¥åªå®ç°äºŒå±‚è½¬å‘ï¼Œæ— æ³•è¿½è¸ªå‰åç«¯çš„è¿æ¥çŠ¶æ€ï¼Œé€ æˆåç«¯ pod å‘å‰ç«¯ pod å›åŒ…æ—¶æ— æ³•å¤„äºåŒä¸€è¿æ¥é“¾è·¯çš„é—®é¢˜ï¼Œå¯ <a href=\"https://imroc.cc/k8s/faq/why-enable-bridge-nf-call-iptables/\" target=\"_blank\" rel=\"noopener\">ç‚¹å‡»æ­¤å¤„</a> è·å¾—æ›´å¤šå¸®åŠ©ã€‚</li>\n<li>ä½¿ç”¨ä»¥ä¸Šå†…æ ¸å‚æ•°æ—¶ï¼Œéœ€åŠ è½½ <code>br_netfilter</code> å†…æ ¸æ¨¡å—æ–¹èƒ½ç”Ÿæ•ˆã€‚</li>\n</ol>\n</blockquote>\n</li>\n<li><p>ä½¿ç”¨ <code>iperf3</code> å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"rootfull-container-to-container-bandwidth.jpg\" alt=\"rootfull-container-to-container-bandwidth.jpg\"></p>\n</li>\n</ul>\n</li>\n<li><p>æ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ç½‘ç»œåˆ†æï¼š  </p>\n<ul>\n<li><code>slirp4netns</code> ç¨‹åºæ”¯æŒ user rootless network namespaceï¼Œè€Œéé€šè¿‡ <code>iptables</code> ä¸ CNI å®ç°ã€‚  </li>\n<li><p>ğŸ‘‰ æ™®é€šç”¨æˆ·ä½¿ç”¨ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨å®¿ä¸»æœº 1024 ä»¥ä¸Šçš„ç«¯å£å®ç°æ˜ å°„ï¼Œä½†å¯ä½¿ç”¨ <code>net.ipv4.ip_unprivileged_port_start</code> å†…æ ¸å‚æ•°å®ç°ä½äº 1024 çš„ç«¯å£å¼€å§‹æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### æ–¹å¼ 1ï¼š###</span></span><br><span class=\"line\">$ sysctl -w net.ipv4.ip_unprivileged_port_start=80</span><br><span class=\"line\"><span class=\"comment\"># ä¸´æ—¶é…ç½®ï¼šå…è®¸æ™®é€šç”¨æˆ·ä» 80 ç«¯å£å¼€å§‹çš„ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">### æ–¹å¼ 2ï¼š###</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_unprivileged_port_start=80\"</span> &gt;&gt; /etc/sysctl.d/rootless.conf</span><br><span class=\"line\"><span class=\"comment\"># æ°¸ä¹…é…ç½®ï¼šå°†è¯¥å†…æ ¸å‚æ•°å†™å…¥å†…æ ¸å‚æ•°é…ç½®æ–‡ä»¶ï¼Œä½¿å…¶å¼€æœºæ°¸ä¹…ç”Ÿæ•ˆã€‚</span></span><br><span class=\"line\">$ sysctl -p</span><br><span class=\"line\"><span class=\"comment\"># ä½¿é…ç½®çš„å†…æ ¸å‚æ•°ç”Ÿæ•ˆ</span></span><br><span class=\"line\"></span><br><span class=\"line\"> - æ™®é€šç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼ä¸º `slirp4netns`ï¼ˆslirp4netns è½¯ä»¶åŒ…å®ç°ï¼‰ã€‚    </span><br><span class=\"line\">    ```bash</span><br><span class=\"line\">    $ podman inspect &lt;container_name&gt; | jq .[0].HostConfig.NetworkMode</span><br><span class=\"line\">      <span class=\"string\">\"slirp4netns\"</span></span><br><span class=\"line\">    <span class=\"comment\"># æ™®é€šç”¨æˆ·åˆ›å»ºçš„ rootless å®¹å™¨ç½‘ç»œæ¨¡å¼</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æ¯ä¸ªæ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨éƒ½å°†ç”Ÿæˆ slirp4netns è¿›ç¨‹ç”¨äºéš”ç¦»è¯¥ç”¨æˆ·çš„ <code>network namespace</code>ï¼Œä»¥ä¸‹åˆ†åˆ«ä½¿ç”¨ godev ä¸ hualf ç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ï¼š<br><img src=\"godev-rootless-container.jpg\" alt=\"godev-rootless-container.jpg\"><img src=\"hualf-rootless-container.jpg\" alt=\"hualf-rootless-container.jpg\"> </p>\n</li>\n<li>slirp4netns å®ç°çš„ç½‘ç»œæ¨¡å¼ä¸å¸¦å®½æ¯”è¾ƒï¼š<br><img src=\"rootless-slirp4netns-networking.jpg\" alt=\"rootless-slirp4netns-networking.jpg\"> </li>\n<li>ä½¿ç”¨ <code>iperf3</code> å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootless å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"rootless-container-to-container-bandwidth.jpg\" alt=\"rootless-container-to-container-bandwidth.jpg\">å¯¹æ¯” rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½æ¥çœ‹ï¼Œslirp4netns å®ç°çš„ rootless å®¹å™¨åœ¨ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´å†…çš„é€šä¿¡æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œè€Œ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ç›¸æ¯”å‰è€…åœ¨æ­¤æ¬¡æµ‹è¯•ä¸­é«˜å‡ºè¿‘ 5 å€ã€‚ </li>\n<li>å…³äº slirp4netns æ›´åŠ è¯¦ç»†çš„å†…å®¹ï¼Œè¯·å‚è€ƒ <a href=\"https://github.com/rootless-containers/slirp4netns\" target=\"_blank\" rel=\"noopener\">Github é¡¹ç›®</a>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Podman-çš„-macvlan-ç½‘ç»œå®ç°ï¼š\"><a href=\"#Podman-çš„-macvlan-ç½‘ç»œå®ç°ï¼š\" class=\"headerlink\" title=\"Podman çš„ macvlan ç½‘ç»œå®ç°ï¼š\"></a>Podman çš„ macvlan ç½‘ç»œå®ç°ï¼š</h3><ul>\n<li><code>macvlan</code> ä½œä¸º CNI åœ¨ Kubernetes ä¸ OpenShift v4 ä¸­ä½œä¸º <code>Multus CNI</code> æ”¯æŒçš„é¢å¤–æ’ä»¶ç±»å‹ä½¿ç”¨æ„ˆåŠ å¹¿æ³›ï¼Œé›†ç¾¤ä¸­é™¤äº†å¸¸è§„ä½¿ç”¨çš„ Flannelã€Calico ç­‰ä½œä¸º <code>slow path</code> çš„æ’ä»¶å¤–ï¼Œè¦æ±‚é«˜æ€§èƒ½çš„ä¸šåŠ¡æµé‡å¯ä½¿ç”¨ macvlan ç›´è¿ pod å®¿ä¸»æœºç‰©ç†ç½‘å£å®ç° <code>fast path</code>ã€‚</li>\n<li>ä¸ºåç»­ç†Ÿæ‚‰ä»¥ä¸Šåœºæ™¯çš„å®ç°ï¼Œå› æ­¤åœ¨ Podman <code>rootfull</code> å®¹å™¨ä¸­ä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼ã€‚</li>\n<li>å…³äº macvlan çš„åŸºç¡€çŸ¥è¯†å¯å‚è€ƒ <a href=\"https://mp.weixin.qq.com/s?__biz=MzU1MzY4NzQ1OA==&amp;mid=2247484064&amp;idx=1&amp;sn=ffd745069b6c4aeac0589de00467b2f2&amp;chksm=fbee426dcc99cb7bdf26f5e6a21bbeaebba7ccd384a02f850d4461ea92331ed140edf98ffaec&amp;mpshare=1&amp;scene=1&amp;srcid=03049MKwF55OVgEZ4OCH39wd&amp;sharer_sharetime=1583337046541&amp;sharer_shareid=8eaca72194dae7b3d51d5c708436eee4#rd\" target=\"_blank\" rel=\"noopener\">Linux è™šæ‹Ÿç½‘å¡æŠ€æœ¯ï¼šMacvlan</a> ä¸ <a href=\"https://cizixs.com/2017/02/14/network-virtualization-macvlan/\" target=\"_blank\" rel=\"noopener\">linux ç½‘ç»œè™šæ‹ŸåŒ–ï¼šmacvlan</a></li>\n<li><p>macvlan ç‰¹æ€§ç”± <code>Linux kernel</code> æ”¯æŒï¼Œç¬”è€…çš„å®éªŒç¯å¢ƒæ»¡è¶³ macvlan çš„è¦æ±‚ï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¡®å®šï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo lsmod | grep macvlan</span><br><span class=\"line\"><span class=\"comment\"># è‹¥æ— ä»»ä½•è¿”å›ï¼Œè¯´æ˜è¿˜æœªåŠ è½½ macvlan å†…æ ¸æ¨¡å—ã€‚</span></span><br><span class=\"line\">$ sudo modprobe macvlan</span><br><span class=\"line\"><span class=\"comment\"># åŠ è½½ macvlan å†…æ ¸æ¨¡å—ï¼Œè‹¥æ‰§è¡ŒæŠ¥é”™ï¼Œè¯´æ˜ kernel ä¸æ”¯æŒè¯¥ç‰¹æ€§ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>podman ä¸ macvlan ç±»å‹ç½‘ç»œçš„é›†æˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo podman network create -d macvlan -o parent=ens33 &lt;network_name&gt;</span><br><span class=\"line\">  /etc/cni/net.d/&lt;network_name&gt;.conflist</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º macvlan ç±»å‹ç½‘ç»œ  </span></span><br><span class=\"line\">$ sudo podman network ls</span><br><span class=\"line\">$ sudo /opt/cni/bin/dhcp daemon</span><br><span class=\"line\"><span class=\"comment\"># åœ¨å¦ä¸€ä¸ªçª—å£ä¸­å¯åŠ¨ dhcp å®ˆæŠ¤è¿›ç¨‹ä¾› macvlan æ’ä»¶è°ƒç”¨ï¼Œä¸ºå®¹å™¨ç½‘å£åˆ†é… IP åœ°å€ã€‚</span></span><br><span class=\"line\">$ sudo podman run -it --rm \\</span><br><span class=\"line\">  --name &lt;container_name&gt; --network=&lt;network_name&gt; \\</span><br><span class=\"line\">  &lt;container_image&gt;:&lt;tag&gt; /bin/sh</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæ”¯æŒ macvlan ç±»å‹ç½‘ç»œçš„ rootfull å®¹å™¨</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä»ä¸ rootfull å®¹å™¨åœ¨åŒä¸€å¹¿æ’­åŸŸçš„å…¶ä»–èŠ‚ç‚¹ä¸Š ping è¯¥å®¹å™¨ï¼Œå¯æ­£å¸¸é€šä¿¡ï¼š<br><img src=\"podman-macvlan-network.png\" alt=\"podman-macvlan-network.png\"></p>\n<blockquote>\n<p>ğŸ¤” ä»¥ä¸Šç¤ºä¾‹çš„å®¹å™¨ä¸­è¿è¡Œ Web æœåŠ¡ï¼ˆå¯æš´éœ² 443 ç«¯å£ï¼‰ï¼Œä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼å¯æ‰“é€šä¸åŒä¸€å¹¿æ’­åŸŸä¸­å¤–éƒ¨èŠ‚ç‚¹çš„é€šä¿¡ï¼Œä½†æ— æ³•è®¿é—®å…¶ä¸­çš„æœåŠ¡ï¼Œå¯é‡‡å–ä½•ç§æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼Ÿ  </p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"Podman-rootless-å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\"><a href=\"#Podman-rootless-å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\" class=\"headerlink\" title=\"Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\"></a>Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š</h3><ul>\n<li>Podman rootless å®¹å™¨çš„å®ç°æ ¸å¿ƒåœ¨äºè§£å†³ network namespaceï¼ˆNetNSï¼‰ ä¸ user namespaceï¼ˆUserNSï¼‰ çš„é—®é¢˜ï¼Œå‰æ–‡å·²ä»‹ç» NetNS çš„å®ç°æ–¹å¼ï¼Œåæ–‡å°†ä»‹ç» UserNS çš„å®ç°æ–¹å¼ã€‚</li>\n<li><p>è‹¥è¦ä½¿ç”¨ rootless å®¹å™¨ï¼Œéœ€ç¡®è®¤ OS æ˜¯å¦å¼€å¯ user namespace åŠŸèƒ½ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo sysctl -a | grep user\\.max_user_namespaces</span><br><span class=\"line\">  user.max_user_namespaces = 47494</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç³»ç»Ÿä¸Šæ¯åˆ›å»ºä¸€ä¸ªç”¨æˆ·å°±ä¼šåœ¨ <code>/etc/subuid</code> ä¸ <code>/etc/subgid</code> ä¸­ç”Ÿæˆå¯¹åº”ç”¨æˆ·åœ¨å…¶ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ˜ å°„è§„åˆ™ï¼Œä»¥ /etc/subuid ä¸ºä¾‹ï¼Œå‚æ•°ä»¥å†’å·åˆ†éš”ï¼Œæ¯ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<ul>\n<li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆuidï¼‰ï¼šç”¨æˆ·åç§°  </li>\n<li>ç¬¬äºŒä¸ªå‚æ•°ï¼ˆloweruidï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´ä¸­èµ·å§‹çš„æ˜ å°„ uid</li>\n</ul>\n</li>\n<li>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆcountï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´å†…éƒ¨ä¸å¤–éƒ¨å¯æ˜ å°„ uid æ•°é‡ï¼ˆå¯ç†è§£ä¸ºæ‰€æœ‰å®¹å™¨æ™®é€šç”¨æˆ·çš„ uid æ•°é‡å’Œï¼‰<br><img src=\"rootless-user-namespace-mapping.jpg\" alt=\"rootless-user-namespace-mapping.jpg\"></li>\n<li>ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶å…è®¸è¿è¡Œè¿›ç¨‹çš„ uid æ˜ å°„èŒƒå›´ï¼Œåœ¨ <code>/proc/&lt;pid&gt;/uid_map</code> ä¸­å®šä¹‰ã€‚</li>\n<li>å¯è¿‡æ»¤å®¹å™¨ <code>conmon</code> è¿›ç¨‹çš„ pid ç¡®è®¤æ¯ä¸ªå®¹å™¨ä¸­çš„ uid æ˜ å°„æƒ…å†µï¼Œå‚è§ä»¥ä¸‹ç¤ºä¾‹ã€‚</li>\n<li>å…³äºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶çš„å…·ä½“è¯´æ˜å¯å‚è€ƒ <code>newuidmap</code> ä¸ <code>newgidmap</code> å‘½ä»¤çš„ man æ‰‹å†Œã€‚</li>\n<li><p>å¯å‚è€ƒ Podman å®˜æ–¹æ¨èçš„å‘½ä»¤åˆ›å»º uid çš„æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo usermod --add-subuids 10000-75535 $(whoami)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----- ç¤ºä¾‹ -----</span></span><br><span class=\"line\">$ sudo cat /etc/subuid</span><br><span class=\"line\">  appuser:10000:500</span><br><span class=\"line\">$ sudo cat /etc/subgid</span><br><span class=\"line\">  appuser:500:50</span><br><span class=\"line\"><span class=\"comment\"># è¯¥ç”¨æˆ·åˆ›å»ºçš„ user namespace ä¸­å¯ä»¥ä½¿ç”¨ä» 10000 å¼€å§‹çš„ 500 ä¸ª UID å’Œä» 500 å¼€å§‹çš„ 50 ä¸ª GID çš„æ˜ å°„ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸš€ ç¤ºä¾‹ï¼š<br>æ™®é€šç”¨æˆ· hualf åœ¨ /etc/subuid ä¸­æ˜ å°„ä¸º hualf:165536:65536ï¼Œè¯´æ˜åœ¨è¯¥ç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯åµŒå¥—ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·å‘½åç©ºé—´ï¼ˆæˆ–å®¹å™¨ï¼‰ï¼Œæ¯ä¸ªå®¹å™¨ä¸­çš„ root ç”¨æˆ· uid 0 éƒ½æ˜ å°„ä¸º hualf ç”¨æˆ·çš„ uid 1001ï¼ˆè¿è¡Œå®¹å™¨è¿›ç¨‹çš„ç”¨æˆ·ï¼‰ï¼Œè€Œå®¹å™¨ä¸­æ™®é€šç”¨æˆ·çš„ uid æ˜ å°„è‡³å®¿ä¸»æœºçš„ subuid èŒƒå›´ä¸­ï¼Œå¯¹äºæ­¤ä¾‹ subuid èŒƒå›´ä¸º 165536~231071ï¼Œå®¹å™¨ä¸­çš„ uid 1 ç”¨æˆ·æ˜ å°„ä¸ºå®¿ä¸»æœº uid 165536ï¼Œå› æ­¤å®¹å™¨ä¸­ admin ç”¨æˆ· uid 1000 æ˜ å°„ä¸ºå®¿ä¸»æœº uid 166535ï¼ˆ165536+999ï¼‰ã€‚<br>é€šè¿‡å®¹å™¨å®¿ä¸»æœºä¸Šæ¯ä¸ªæ™®é€šç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´çš„ subuid æ˜ å°„èŒƒå›´ï¼Œå¯åˆ†é…ä¼—å¤š uid åœ¨ rootless å®¹å™¨ä¸­è¿è¡Œåº”ç”¨è¿›ç¨‹ã€‚<br><img src=\"user-namespace-subuid-mapping-1-edited.png\" alt=\"user-namespace-subuid-mapping-1-edited.png\"><img src=\"user-namespace-subuid-mapping-2-edited.png\" alt=\"user-namespace-subuid-mapping-2-edited.png\"></p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://projectatomic.io/blog/2018/02/reintroduction-podman/\" target=\"_blank\" rel=\"noopener\">Reintroduction of Podman</a></li>\n<li><a href=\"https://fedoramagazine.org/podman-pods-fedora-containers/\" target=\"_blank\" rel=\"noopener\">Using pods with Podman on Fedora</a></li>\n<li><a href=\"https://www.redhat.com/sysadmin/container-networking-podman\" target=\"_blank\" rel=\"noopener\">Configuring container networking with Podman</a></li>\n<li><a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/index\" target=\"_blank\" rel=\"noopener\">RedHat docs - Building, running, and managing Linux containers on Red Hat Enterprise Linux 8</a></li>\n<li><a href=\"https://developer.aliyun.com/article/700923\" target=\"_blank\" rel=\"noopener\">å®¹å™¨å®‰å…¨æ‹¾é— - Rootless Containeråˆæ¢</a></li>\n<li><a href=\"https://www.kernel.org/doc/html/latest/admin-guide/sysctl/user.html\" target=\"_blank\" rel=\"noopener\">Documentation for /proc/sys/user/</a></li>\n<li><a href=\"https://docs.docker.com/compose/\" target=\"_blank\" rel=\"noopener\">docker docs - Overview of Docker Compose</a></li>\n<li><a href=\"https://www.cni.dev/plugins/current/meta/firewall/\" target=\"_blank\" rel=\"noopener\">CNI docs - firewall plugin</a></li>\n<li><a href=\"https://www.cni.dev/plugins/current/meta/firewall/\" target=\"_blank\" rel=\"noopener\">CNI docs - Port-mapping plugin</a></li>\n<li><a href=\"https://fossies.org/linux/podman/docs/tutorials/basic_networking.md\" target=\"_blank\" rel=\"noopener\">https://fossies.org/linux/podman/docs/tutorials/basic_networking.md</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>å®éªŒç”¨ OS ç‰ˆæœ¬ï¼š  <ul>\n<li>CentOS 7.9ã€RHEL 8.0ã€RHEL 8.2ã€Ubuntu 20.04.3 LTS</li>\n</ul>\n</li>\n<li>å®éªŒç”¨ kernel ç‰ˆæœ¬ï¼š  <ul>\n<li>3.10.0-1160.41.1.el7.x86_64  </li>\n<li>4.18.0-193.el8.x86_64  </li>\n<li>5.14.0-1.el7.elrepo.x86_64</li>\n</ul>\n</li>\n<li>å®éªŒç”¨ Podman ç‰ˆæœ¬ï¼š1.6.4ã€3.2.3ã€3.3.1</li>\n<li>å®éªŒç”¨ podman-compose ç‰ˆæœ¬ï¼š0.1.8</li>\n<li>å®éªŒç”¨ Docker ç‰ˆæœ¬ï¼š20.10.8</li>\n<li>è‹¥æœªåšç‰¹æ®Šè¯´æ˜ï¼Œä»¥ä¸‹ç¤ºä¾‹å‡äº <code>RHEL 8.2</code>ï¼ˆ<code>4.18.0-193.el8.x86_64</code>ï¼‰ä¸Šæ‰§è¡Œï¼ŒPodman ç‰ˆæœ¬ä¸º <code>3.2.3</code>ã€‚</li>\n<li>è¯¥æ–‡æ¡£ä¸­æœªæ¶‰åŠ podman å‘½ä»¤çš„åŸºç¡€ä½¿ç”¨æ–¹æ³•ï¼Œå¯å‚é˜… <a href=\"https://mp.weixin.qq.com/s/MDi4RB5V60EGl3ii9usD0Q\" target=\"_blank\" rel=\"noopener\">è¯¥æ–‡æ¡£</a> åŠ ä»¥ç†Ÿæ‚‰ã€‚</li>\n<li>ğŸ’¥ é‡è¦æç¤ºï¼šPodman é¡¹ç›®æ­£åœ¨ä¸æ–­æ¼”è¿›ä¸å®Œå–„ä¸­ï¼Œè¯·ä»¥è‡ªèº«ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºå‡†è¿›è¡Œæµ‹è¯•ä¸ä½¿ç”¨ï¼</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Podman çš„ç‰¹æ€§æ¦‚è¿°</li>\n<li>Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒ</li>\n<li>Podman çš„æ‰©å±•åŠŸèƒ½</li>\n<li>Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…</li>\n<li>Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒ</li>\n<li>Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰</li>\n<li>Podman çš„ macvlan ç½‘ç»œå®ç°</li>\n<li>Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"Podman-çš„ç‰¹æ€§æ¦‚è¿°ï¼š\"><a href=\"#Podman-çš„ç‰¹æ€§æ¦‚è¿°ï¼š\" class=\"headerlink\" title=\"Podman çš„ç‰¹æ€§æ¦‚è¿°ï¼š\"></a>Podman çš„ç‰¹æ€§æ¦‚è¿°ï¼š</h3><ul>\n<li>LXCã€<code>LXD</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ã€<code>systemd-nspawn</code> å‡å¯ä½œä¸º Linux å®¹å™¨ï¼Œä½†ç¼ºå°‘å®¹å™¨è·¨ä¸»æœºè¿è¡Œä¸åº”ç”¨æ‰“åŒ…çš„èƒ½åŠ›ã€‚</li>\n<li>Docker ä¸ Podman å¯ä½¿ç”¨å®¹å™¨é•œåƒå®ç°åº”ç”¨æ‰“åŒ…å‘å¸ƒï¼Œå¿«é€Ÿä¸”è½»é‡ã€‚</li>\n<li>Docker ä¸ Podman éƒ½ä½¿ç”¨ <code>runC</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸ºåº•å±‚ <code>oci-runtime</code>ã€‚</li>\n<li>Docker ä¸ Podman éƒ½æ”¯æŒ <code>OCI Image Format</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ï¼Œéƒ½èƒ½ä½¿ç”¨ DockerHub ä¸Šçš„å®¹å™¨é•œåƒï¼Œè€Œ systemd-nspawn æ— æ³•ä½¿ç”¨å®ƒä»¬çš„é•œåƒã€‚</li>\n<li>ğŸ‘‰ Podman ä½¿ç”¨ <code>CNI</code>ï¼ˆGo è¯­è¨€å¼€å‘ï¼‰ä½œä¸º rootfull å®¹å™¨ç½‘ç»œåº•å±‚ï¼Œå®ç°æ¯” Docker ç½‘ç»œå±‚ç•¥å¾®ç®€å•ä½†åŸç†ç›¸åŒã€‚</li>\n<li>ç›¸å¯¹äº LXD ä¸ systemd-nspawnï¼ŒCNI å¯ä»¥é¿å…ç¼–å†™å¤§é‡çš„ç½‘ç»œè§„åˆ™ã€‚</li>\n<li>ğŸš€ ä¸ºäº†å®ç°æ™®é€šç”¨æˆ· rootless å®¹å™¨ç½‘ç»œï¼ŒPodman å¯ä»¥ä½¿ç”¨ <code>slirp4netns</code> ç¨‹åºï¼Œé¿å… <code>kernel space</code> ä¸­çš„å¤§é‡ <code>veth pair</code> è™šæ‹Ÿæ¥å£çš„å‡ºç°, å¹¶ä¸”æ€§èƒ½æ›´å¥½ã€‚</li>\n<li>Docker è¿è¡Œå®¹å™¨å¿…é¡»ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸”ä½¿ç”¨ root æƒé™ï¼Œå­˜åœ¨ç³»ç»Ÿå®‰å…¨é—®é¢˜ï¼Œè€Œ Podman é’ˆå¯¹æ­¤é—®é¢˜ä½¿ç”¨ä»¥ä¸‹ä¸¤ä¸ªç‰¹æ€§åŠ ä»¥è§£å†³ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <ul>\n<li>Podman æ”¯æŒæ— å®ˆæŠ¤è¿›ç¨‹ï¼ˆ<code>no-daemon</code>ï¼‰è¿è¡Œå®¹å™¨ã€‚  </li>\n<li>Podman æ”¯æŒæ™®é€šç”¨æˆ·è¿è¡Œ <code>rootless</code> å®¹å™¨ï¼Œå³ï¼Œæ™®é€šç”¨æˆ·ç›´æ¥è¿è¡Œå®¹å™¨æ— éœ€ææƒå…·æœ‰ root æƒé™ã€‚</li>\n</ul>\n</li>\n<li>è™½ç„¶ Docker ä¸ Podman çš„å®ç°åŸç†ä¸åŒï¼Œä½†å¯¹äºä½¿ç”¨è€…è€Œè¨€å…¶ CLI ååˆ†ç›¸ä¼¼ï¼Œå¯å¹³æ»‘åœ°ä» Docker è¿‡æ¸¡è‡³ Podmanã€‚</li>\n<li>Podman çš„ç›®æ ‡ä¸æ˜¯å®¹å™¨çš„ç¼–æ’ï¼Œç¼–æ’å¯ä»¥ä½¿ç”¨æ›´åŠ ä¸“ä¸šçš„ Kubernetesã€Open Shiftã€Rancher ç­‰ï¼Œä½¿ç”¨ Podman å¯ä»¥æ›´è½»é‡çš„è¿è¡Œå®¹å™¨ä¸”ä¸å— root æƒé™çš„å®‰å…¨é—®é¢˜ï¼Œå³ä¾¿æ˜¯ root ç”¨æˆ·ä¹Ÿæ— æ³•æŸ¥çœ‹å…¶å®ƒæ™®é€šç”¨æˆ·ç©ºé—´ä¸‹çš„å®¹å™¨ï¼ŒPodman é€šè¿‡ <code>user namespace</code> è¿›è¡Œéš”ç¦»ã€‚</li>\n<li>ğŸ‘‰ Podman å¯ä½¿ç”¨ <code>systemd service</code> å•å…ƒæ–‡ä»¶ç›´æ¥ç®¡ç†å®¹å™¨ï¼Œå®ç°å®¹å™¨æœåŠ¡éšç³»ç»Ÿå¯åŠ¨è€Œå¯åŠ¨ã€‚</li>\n<li>ğŸ‘‰ Podman é‡Œé›†æˆäº† <code>CRIU</code>ï¼Œå› æ­¤ Podman ä¸­çš„å®¹å™¨å¯ä»¥åœ¨å•æœºä¸Šçƒ­è¿ç§»ã€‚</li>\n<li>ç”±äº Kubernetes å°†ä» <code>v1.24.x</code> ç‰ˆæœ¬åæ”¾å¼ƒä½¿ç”¨ <code>dockershim</code> æ¥å£å±‚ï¼Œå®¹å™¨è¿è¡Œæ—¶å¯é€‰æ‹©ä½¿ç”¨ <code>Containerd</code> æˆ–è€… <code>CRI-O</code>ï¼Œä¸¤è€…è™½ç„¶å‡æ”¯æŒ OCI image è§„èŒƒï¼Œä½†å®ƒä»¬ä¸æ˜¯é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…ç›´æ¥ç®¡ç†å®¹å™¨æˆ–é•œåƒçš„å·¥å…·ï¼Œè€Œ Podman å¯ç›´æ¥é¢å‘ä½¿ç”¨è€…æˆ–å¼€å‘è€…æ“ä½œå®¹å™¨æˆ–é•œåƒã€‚</li>\n<li>Podman å‘½ä»¤çš„å­è¿›ç¨‹åˆ›å»º pod ä¸å®¹å™¨ã€‚</li>\n</ul>\n<h3 id=\"Podman-ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\"><a href=\"#Podman-ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\" class=\"headerlink\" title=\"Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š\"></a>Podman ç‰ˆæœ¬å…¼å®¹æ€§æ¯”è¾ƒï¼š</h3><ul>\n<li>Podman ç‰ˆæœ¬ã€kernel ç‰ˆæœ¬ä¸ OS ç‰ˆæœ¬çš„å…¼å®¹æ€§å°†ç›´æ¥å½±å“æ™®é€šç”¨æˆ·ä½¿ç”¨ rootless å®¹å™¨ã€‚</li>\n<li><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œkernel ä¸æ”¯æŒ rootless å®¹å™¨ï¼š<br><img src=\"centos79-kernel-not-support-podman-rootless.jpg\" alt=\"centos79-kernel-not-support-podman-rootless.jpg\"></p>\n</li>\n<li><p>æ™®é€šç”¨æˆ· rootless å®¹å™¨å…¼å®¹æ€§æ¯”è¾ƒï¼š<br><img src=\"podman-version-compare.png\" alt=\"podman-version-compare.png\"></p>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<p>rootless å®¹å™¨ç‰¹æ€§å–å†³äº kernel çš„ç‰ˆæœ¬ï¼Œä¸å–å†³äº OS ä¸ Podman çš„ç‰ˆæœ¬ã€‚</p>\n</blockquote>\n<ul>\n<li>ç”±äº <code>user namespace</code> ç‰¹æ€§åœ¨ kernel <code>4.9.0</code> ä¹‹åå‡ºç°ï¼Œå› æ­¤å‡çº§ kernel å³å¯è§£å†³ rootless é—®é¢˜ã€‚</li>\n<li>å…³äº rootless ç‰¹æ€§åœ¨ RHEL 8 ä¸­çš„è®¾ç½®ï¼Œå¯ <a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/assembly_starting-with-containers_building-running-and-managing-containers#proc_setting-up-rootless-containers_assembly_starting-with-containers\" target=\"_blank\" rel=\"noopener\">ç‚¹å‡»æ­¤å¤„</a> å‚è€ƒ Red Hat çš„å®˜æ–¹é…ç½®è¯´æ˜ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Podman-çš„æ‰©å±•åŠŸèƒ½ï¼š\"><a href=\"#Podman-çš„æ‰©å±•åŠŸèƒ½ï¼š\" class=\"headerlink\" title=\"Podman çš„æ‰©å±•åŠŸèƒ½ï¼š\"></a>Podman çš„æ‰©å±•åŠŸèƒ½ï¼š</h3><ul>\n<li><p><code>cockpit-podman</code> è½¯ä»¶åŒ…ä½œä¸º cockpit æ’ä»¶å¯é›†æˆäº <code>Web UI</code> ä¸­ï¼Œå®ç° Web UI ç®¡ç†å®¹å™¨ã€‚  </p>\n<ul>\n<li><p>cockpit-podman æœåŠ¡å®‰è£…ä¸å¯ç”¨ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y cockpit-podman</span><br><span class=\"line\">$ sudo systemctl <span class=\"built_in\">enable</span> --now cockpit.socket</span><br><span class=\"line\">$ sudo systemctl status cockpit.service</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… cockpit-podman è½¯ä»¶åŒ…ï¼Œå¹¶å¯ç”¨ cockpit æœåŠ¡ã€‚</span></span><br><span class=\"line\">$ sudo netstat -tunlp | grep 9090</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ systemd ç›‘å¬çš„ 9090 ç«¯å£æ˜¯å¦å¯ç”¨</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>åœ¨ Web UI ä¸­å¯æŸ¥çœ‹å¹¶ç®¡ç† podman å®¹å™¨ä¸é•œåƒï¼š<br><img src=\"cockpit-podman-1.jpg\" alt=\"podman-arch-usage/cockpit-podman-1.jpg\"><img src=\"cockpit-podman-2.jpg\" alt=\"cockpit-podman-2.jpg\"></p>\n</li>\n</ul>\n</li>\n<li><code>podman-compose</code> æ—¨åœ¨ä½¿ç”¨æ›´è½»é‡çš„æ–¹å¼å®ç°<code>å•æœºå®¹å™¨ç¼–æ’</code>ï¼Œä»¥ç”¨äºæ›¿æ¢ <code>docker-compose</code>ï¼Œè¿™ç§æ–¹å¼å°†ä¸å†ä¾èµ–å®ˆæŠ¤è¿›ç¨‹ä¸ root æƒé™ï¼ŒåŒæ—¶å¯ä½¿ç”¨ rootless å®¹å™¨ï¼Œè¯¦ç»†ç¤ºä¾‹è§ä¸‹æ–‡ã€‚</li>\n<li>podman-compose ä½¿ç”¨ <code>Python</code> å¼€å‘ï¼Œå› æ­¤å¯ç›´æ¥ä½¿ç”¨ <code>pip3</code> å®‰è£…è¯¥ç»„ä»¶ï¼Œæˆ–ä½¿ç”¨ rpm è½¯ä»¶åŒ…æ–¹å¼å®‰è£…ã€‚</li>\n<li>ç”±äº podman-compose ä¾ç„¶å¤„äº <code>dev</code> é˜¶æ®µï¼Œä»…ä½œä¸ºåŠŸèƒ½æµ‹è¯•ä½¿ç”¨ï¼Œæš‚æœªå—åˆ° GA ç¯å¢ƒæ”¯æŒã€‚</li>\n</ul>\n<h3 id=\"Podman-åœ¨ä¸åŒ-OS-ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\"><a href=\"#Podman-åœ¨ä¸åŒ-OS-ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\" class=\"headerlink\" title=\"Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š\"></a>Podman åœ¨ä¸åŒ OS ç‰ˆæœ¬ä¸­çš„å®‰è£…ï¼š</h3><ul>\n<li><p>CentOS 7.x/8.x æˆ– RHEL 7.x/8.x ä¸­ï¼šyum å‘½ä»¤ä½¿ç”¨ podman <code>rpm</code> è½¯ä»¶åŒ…å®‰è£…  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo yum install -y podman-3.2.3-0.11.module_el8.4.0+942+d25aada8.x86_64</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… podman æœ€æ–°ç‰ˆæœ¬ï¼Œä½ç‰ˆæœ¬ podman å­˜åœ¨è¾ƒå¤š bugã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   1. éœ€é…ç½® CentOS 8 çš„ yum è½¯ä»¶æºä»¥å®‰è£…æœ€æ–°ç‰ˆçš„ podman åŠå…¶ä¾èµ–è½¯ä»¶åŒ…</span></span><br><span class=\"line\"><span class=\"comment\">#   2. yum å®‰è£… podman æ—¶ä¹Ÿå°†å®‰è£… containernetworking-plugins è½¯ä»¶åŒ…</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ¤˜ Ubuntu 20.04.2 LTS ä¸­ï¼šapt-get å‘½ä»¤ä½¿ç”¨ podman <code>deb</code> è½¯ä»¶åŒ…å®‰è£…  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ . /etc/os-release</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å½“å‰çš„ç³»ç»Ÿå‘è¡Œç‰ˆ</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/ /\"</span> | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list</span><br><span class=\"line\">$ curl -L <span class=\"string\">\"https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_<span class=\"variable\">$&#123;VERSION_ID&#125;</span>/Release.key\"</span> | sudo apt-key add -</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ  podman è½¯ä»¶æºä¸ apt å…¬é’¥</span></span><br><span class=\"line\">$ sudo apt-get update -y</span><br><span class=\"line\">$ sudo apt-get upgrade -y</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ–°ç³»ç»Ÿè½¯ä»¶æºå¹¶å‡çº§ç³»ç»Ÿè½¯ä»¶åŒ…</span></span><br><span class=\"line\">$ sudo apt-get install -y podman</span><br><span class=\"line\">  Reading package lists... Done</span><br><span class=\"line\">  Building dependency tree       </span><br><span class=\"line\">  Reading state information... Done</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  The following NEW packages will be installed:</span><br><span class=\"line\">    catatonit conmon containernetworking-plugins containers-common criu crun fuse-overlayfs fuse3 libfuse3-3 libnet1 libprotobuf-c1</span><br><span class=\"line\">    podman podman-machine-cni podman-plugins</span><br><span class=\"line\">  ...</span><br><span class=\"line\"><span class=\"comment\"># å®‰è£… podman ä¸ç›¸å…³çš„è½¯ä»¶åŒ…ï¼ŒåŒ…æ‹¬ conmonã€containernetworking-pluginsã€crun ç­‰ã€‚</span></span><br></pre></td></tr></table></figure>\n<p>å®‰è£…å‚è€ƒé“¾æ¥ï¼š  </p>\n<ul>\n<li><a href=\"https://podman.io/getting-started/installation\" target=\"_blank\" rel=\"noopener\">Podman Doc - installation</a></li>\n<li><a href=\"https://www.hostnextra.com/kb/easy-to-install-podman-on-ubuntu-20-04/\" target=\"_blank\" rel=\"noopener\">Easy to Install Podman on Ubuntu 20.04</a></li>\n<li><a href=\"https://software.opensuse.org//download.html?project=devel%3Akubic%3Alibcontainers%3Astable&amp;package=podman\" target=\"_blank\" rel=\"noopener\">podman from devel:kubic:libcontainers:stable project</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ğŸ¤˜-Docker-ä¸-Podman-è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\"><a href=\"#ğŸ¤˜-Docker-ä¸-Podman-è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\" class=\"headerlink\" title=\"ğŸ¤˜ Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š\"></a>ğŸ¤˜ Docker ä¸ Podman è¿›ç¨‹ç®¡ç†æ–¹å¼æ¯”è¾ƒï¼š</h3><ul>\n<li><p>Docker v20.10.8 ä½¿ç”¨ <code>dockerd</code> ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å®¹å™¨ä¸é•œåƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿è¡ŒçŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo systemctl status docker.service</span><br><span class=\"line\">â— docker.service - Docker Application Container Engine</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)</span><br><span class=\"line\">   Active: active (running) since Wed 2022-10-19 10:53:04 CST; 6min ago</span><br><span class=\"line\">     Docs: https://docs.docker.com</span><br><span class=\"line\"> Main PID: 79556 (dockerd)</span><br><span class=\"line\">    Tasks: 21</span><br><span class=\"line\">   Memory: 42.6M</span><br><span class=\"line\">   CGroup: /system.slice/docker.service</span><br><span class=\"line\">           â”œâ”€79556 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\">           â”œâ”€79677 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 4000 -container-ip 172.17.0.2 -container-port 4000</span><br><span class=\"line\">           â””â”€79683 /usr/bin/docker-proxy -proto tcp -host-ip :: -host-port 4000 -container-ip 172.17.0.2 -container-port 4000</span><br><span class=\"line\"></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.197803867+08:00\"</span> level=info msg=<span class=\"string\">\"scheme \\\"unix\\\" not registered, fallback to default scheme\"</span> module=grpc</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.197837924+08:00\"</span> level=info msg=<span class=\"string\">\"ccResolverWrapper: sending update to cc: &#123;[&#123;unix:///run/containerd/containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;] &lt;nil&gt; &lt;nil&gt;&#125;\"</span> module=grpc</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.197860326+08:00\"</span> level=info msg=<span class=\"string\">\"ClientConn switching balancer to \\\"pick_first\\\"\"</span> module=grpc</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.220416627+08:00\"</span> level=info msg=<span class=\"string\">\"Loading containers: start.\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.347884960+08:00\"</span> level=info msg=<span class=\"string\">\"Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --bip can be used to set a preferred IP address\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.725361851+08:00\"</span> level=info msg=<span class=\"string\">\"Loading containers: done.\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.755449128+08:00\"</span> level=info msg=<span class=\"string\">\"Docker daemon\"</span> commit=75249d8 graphdriver(s)=overlay2 version=20.10.8</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.755527994+08:00\"</span> level=info msg=<span class=\"string\">\"Daemon has completed initialization\"</span></span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com systemd[1]: Started Docker Application Container Engine.</span><br><span class=\"line\">Oct 19 10:53:04 cloud-ctl.domain12.example.com dockerd[79556]: time=<span class=\"string\">\"2022-10-19T10:53:04.776865058+08:00\"</span> level=info msg=<span class=\"string\">\"API listen on /var/run/docker.sock\"</span></span><br><span class=\"line\"><span class=\"comment\"># dockerd å®ˆæŠ¤è¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo systemctl status containerd</span><br><span class=\"line\">â— containerd.service - containerd container runtime</span><br><span class=\"line\">   Loaded: loaded (/usr/lib/systemd/system/containerd.service; enabled; vendor preset: disabled)</span><br><span class=\"line\">   Active: active (running) since Tue 2022-10-18 15:08:06 CST; 20h ago</span><br><span class=\"line\">     Docs: https://containerd.io</span><br><span class=\"line\"> Main PID: 1892 (containerd)</span><br><span class=\"line\">    Tasks: 20</span><br><span class=\"line\">   Memory: 103.4M</span><br><span class=\"line\">   CGroup: /system.slice/containerd.service</span><br><span class=\"line\">           â”œâ”€ 1892 /usr/bin/containerd</span><br><span class=\"line\">           â””â”€79696 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># containerd é€šè¿‡è°ƒç”¨ containerd-shim-runc-v2 è¿è¡ŒæŒ‡å®šå®¹å™¨</span></span><br><span class=\"line\">$ sudo ps -ef | grep -E <span class=\"string\">\"dockerd|containerd|containerd-shim-runc-v2\"</span></span><br><span class=\"line\">  root       1892      1  0 Oct18 ?        00:05:01 /usr/bin/containerd</span><br><span class=\"line\">  root      79556      1  0 10:53 ?        00:00:03 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class=\"line\">  root      79696      1  0 10:53 ?        00:00:01 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 3ea752c1cce6a65b39af7f68c971186e020992514b663ab7a917f47da70450fa -address /run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"comment\"># PID 79696 ä¸ºå®é™…çš„å®¹å™¨è¿è¡Œè¿›ç¨‹</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Podman ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œæˆ–ç®¡ç†å®¹å™¨ï¼Œå¯¹äº rootfull å®¹å™¨æˆ– rootless å®¹å™¨çš„è¿è¡Œæ–¹å¼å­˜åœ¨å·®å¼‚ï¼š  </p>\n<ul>\n<li><p>rootfull å®¹å™¨çš„è¿›ç¨‹ï¼š<br>ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  root        3879    3476  1 06:31 pts/3    00:00:00 podman run -it --name=mydebian docker.io/library/debian:latest /bin/sh</span><br><span class=\"line\">  root        3945       1  0 06:31 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -u 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata -p /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/pidfile -n mydebian --<span class=\"built_in\">exit</span>-dir /run/libpod/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/oci-log -t --conmon-pidfile /run/containers/storage/overlay-containers/29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/containers/storage --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/libpod --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg cni --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --storage-opt --<span class=\"built_in\">exit</span>-command-arg overlay.mountopt=nodev,metacopy=on --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg 29260258303cef76f1191c8b83f16eb7ba70c5424bb17a729e2d3b051680adba</span><br><span class=\"line\"><span class=\"comment\"># ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ‘‰ ä»¥ <code>detach</code> æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  root        3744       1  0 06:25 ?        00:00:00 /usr/bin/conmon --api-version 1 -c b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -u b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272 -r /usr/bin/crun -b /var/lib/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata -p /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/pidfile -n apache-rhce8.2-alpine --<span class=\"built_in\">exit</span>-dir /run/libpod/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/oci-log --conmon-pidfile /run/containers/storage/overlay-containers/b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/containers/storage --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/libpod --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg cni --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/lib/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --storage-opt --<span class=\"built_in\">exit</span>-command-arg overlay.mountopt=nodev,metacopy=on --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg b8ad3fce848ef26197a1d8bd43be5a2a72c66211e05cd90ccfaa55e1515ed272</span><br><span class=\"line\"><span class=\"comment\"># podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œè€Œ rootfull å®¹å™¨çš„ CNI æ’ä»¶</span></span><br><span class=\"line\"><span class=\"comment\"># å¯ç›´æ¥ä½¿ç”¨ iptables çš„æ–¹å¼å®ç°ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>rootless å®¹å™¨çš„è¿›ç¨‹ï¼š<br>ğŸ‘‰ ä»¥äº¤äº’å¼æ–¹å¼è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  core        3418    2762  0 06:17 pts/2    00:00:05 podman run -it --name=mybusybox docker.io/library/busybox:latest /bin/sh</span><br><span class=\"line\">  core        3430    3418  0 06:17 pts/2    00:00:00 /usr/bin/slirp4netns --<span class=\"built_in\">disable</span>-host-loopback --mtu=65520 --<span class=\"built_in\">enable</span>-sandbox --<span class=\"built_in\">enable</span>-seccomp --<span class=\"built_in\">enable</span>-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-19eb5630-c0a8-4ea9-8790-76ecdcdf2dbc tap0</span><br><span class=\"line\">  core        3433       1  0 06:17 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -u 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160 -r /usr/bin/crun -b /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata -p /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/pidfile -n mybusybox --<span class=\"built_in\">exit</span>-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/oci-log -t --conmon-pidfile /run/user/1000/containers/overlay-containers/5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/containers --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/libpod/tmp --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg netavark --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg 5acc7fc4127d5492866b966d6c0c04dce880995c49eddb8421c11e7efc661160</span><br><span class=\"line\"><span class=\"comment\"># ç”±äºå…·æœ‰äº¤äº’å¼å‘½ä»¤è¡Œè¿è¡Œä¾ç„¶ä¿ç•™ podman è¿›ç¨‹ï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\"># ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚</span></span><br><span class=\"line\">``` </span><br><span class=\"line\">ğŸ‘‰ ä»¥ `detach` æ–¹å¼ï¼ˆåå°ï¼‰è¿è¡Œçš„å®¹å™¨è¿›ç¨‹çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š   </span><br><span class=\"line\">```bash</span><br><span class=\"line\">$ ps -ef | egrep <span class=\"string\">\"podman|slirp4netns|conmon\"</span></span><br><span class=\"line\">  core        3308       1  0 06:15 pts/2    00:00:00 /usr/bin/slirp4netns --<span class=\"built_in\">disable</span>-host-loopback --mtu=65520 --<span class=\"built_in\">enable</span>-sandbox --<span class=\"built_in\">enable</span>-seccomp --<span class=\"built_in\">enable</span>-ipv6 -c -e 3 -r 4 --netns-type=path /run/user/1000/netns/netns-f9f6f9dd-bf80-f6ca-6f39-7c9d9cd6beea tap0</span><br><span class=\"line\">  core        3325       1  0 06:15 ?        00:00:00 /usr/bin/conmon --api-version 1 -c 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -u 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab -r /usr/bin/crun -b /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata -p /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/pidfile -n apache-rhce8.2-alpine --<span class=\"built_in\">exit</span>-dir /run/user/1000/libpod/tmp/exits --full-attach -s -l journald --<span class=\"built_in\">log</span>-level warning --runtime-arg --<span class=\"built_in\">log</span>-format=json --runtime-arg --<span class=\"built_in\">log</span> --runtime-arg=/run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/oci-log --conmon-pidfile /run/user/1000/containers/overlay-containers/91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab/userdata/conmon.pid --<span class=\"built_in\">exit</span>-command /usr/bin/podman --<span class=\"built_in\">exit</span>-command-arg --root --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage --<span class=\"built_in\">exit</span>-command-arg --runroot --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/containers --<span class=\"built_in\">exit</span>-command-arg --<span class=\"built_in\">log</span>-level --<span class=\"built_in\">exit</span>-command-arg warning --<span class=\"built_in\">exit</span>-command-arg --cgroup-manager --<span class=\"built_in\">exit</span>-command-arg systemd --<span class=\"built_in\">exit</span>-command-arg --tmpdir --<span class=\"built_in\">exit</span>-command-arg /run/user/1000/libpod/tmp --<span class=\"built_in\">exit</span>-command-arg --network-config-dir --<span class=\"built_in\">exit</span>-command-arg  --<span class=\"built_in\">exit</span>-command-arg --network-backend --<span class=\"built_in\">exit</span>-command-arg netavark --<span class=\"built_in\">exit</span>-command-arg --volumepath --<span class=\"built_in\">exit</span>-command-arg /var/home/core/.<span class=\"built_in\">local</span>/share/containers/storage/volumes --<span class=\"built_in\">exit</span>-command-arg --runtime --<span class=\"built_in\">exit</span>-command-arg crun --<span class=\"built_in\">exit</span>-command-arg --storage-driver --<span class=\"built_in\">exit</span>-command-arg overlay --<span class=\"built_in\">exit</span>-command-arg --events-backend --<span class=\"built_in\">exit</span>-command-arg journald --<span class=\"built_in\">exit</span>-command-arg container --<span class=\"built_in\">exit</span>-command-arg cleanup --<span class=\"built_in\">exit</span>-command-arg 91b49d5726023b9ca1c4e30a6665fc21c9b3c3182a1accddb0adb259d0ba20ab</span><br><span class=\"line\"><span class=\"comment\"># podman åœ¨è°ƒç”¨ conmon ç¨‹åºåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨åé€€å‡ºï¼Œå¹¶ä¸”ç”± podman è¿›ç¨‹åˆ›å»º slirp4netns å­è¿›ç¨‹</span></span><br><span class=\"line\"><span class=\"comment\"># ç”¨äº rootless å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ä¹‹é—´çš„é€šä¿¡ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Podman-çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull-ä¸-rootlessï¼‰ï¼š\"><a href=\"#Podman-çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull-ä¸-rootlessï¼‰ï¼š\" class=\"headerlink\" title=\"Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰ï¼š\"></a>Podman çš„ç½‘ç»œå®ç°åŸç†ï¼ˆrootfull ä¸ rootlessï¼‰ï¼š</h3><ul>\n<li>Podman æ”¯æŒçš„å®¹å™¨ç½‘ç»œæ¨¡å¼å¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"podman-network-mode.jpg\" alt=\"podman-network-mode.jpg\"></li>\n<li><p>root ç”¨æˆ·è¿è¡Œ rootfull å®¹å™¨ç½‘ç»œåˆ†æï¼š  </p>\n<ul>\n<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œrootfull å®¹å™¨ä½¿ç”¨ bridge ç½‘ç»œæ¨¡å¼ï¼Œå¹¶ä¸”åœ¨æœªåˆ›å»ºä»»ä½•å®¹å™¨å‰ç³»ç»Ÿä¸Šä¸ä¼šè‡ªåŠ¨åˆ›å»º <code>cni-podman0</code>ç½‘æ¡¥ï¼Œåªæœ‰åˆ›å»ºå®¹å™¨åè‡ªåŠ¨ç”Ÿæˆã€‚  </li>\n<li><p>root ç”¨æˆ·ä½¿ç”¨å…¨å±€èŒƒå›´å†…çš„ CNI æ’ä»¶ï¼Œpodman é»˜è®¤ä½¿ç”¨ <code>bridge</code>ã€<code>portmap</code> æ’ä»¶ï¼Œå…¶é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat /etc/cni/net.d/87-podman-bridge.conflist</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"cniVersion\"</span>: <span class=\"string\">\"0.4.0\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"name\"</span>: <span class=\"string\">\"podman\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"plugins\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"bridge\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"bridge\"</span>: <span class=\"string\">\"cni-podman0\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"isGateway\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ipMasq\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">\"hairpinMode\"</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ipam\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"type\"</span>: <span class=\"string\">\"host-local\"</span>,</span><br><span class=\"line\">        <span class=\"string\">\"routes\"</span>: [&#123; <span class=\"string\">\"dst\"</span>: <span class=\"string\">\"0.0.0.0/0\"</span> &#125;],</span><br><span class=\"line\">        <span class=\"string\">\"ranges\"</span>: [</span><br><span class=\"line\">          [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              <span class=\"string\">\"subnet\"</span>: <span class=\"string\">\"10.88.0.0/16\"</span>,</span><br><span class=\"line\">              <span class=\"string\">\"gateway\"</span>: <span class=\"string\">\"10.88.0.1\"</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          ]</span><br><span class=\"line\">        ]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"portmap\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"capabilities\"</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">\"portMappings\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"firewall\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"type\"</span>: <span class=\"string\">\"tuning\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\"><span class=\"comment\"># è¯¥é…ç½®æ–‡ä»¶ä½äº Podman æºç  cni/87-podman-bridge.conflist</span></span><br><span class=\"line\"><span class=\"comment\"># Podman å¯è°ƒç”¨ bridgeã€portmap ç­‰ CNI æ’ä»¶</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ sudo podman inspect &lt;container_name&gt; | jq .[0].HostConfig.NetworkMode</span><br><span class=\"line\">  <span class=\"string\">\"bridge\"</span></span><br><span class=\"line\"><span class=\"comment\"># root ç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>root ç”¨æˆ·åˆ›å»ºå…·æœ‰ç«¯å£æ˜ å°„çš„å®¹å™¨æ—¶ï¼Œiptables filter è¡¨ä¸ nat è¡¨è§„åˆ™å°†ç›¸åº”å¢åŠ ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ----- filter è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----</span></span><br><span class=\"line\">*filter</span><br><span class=\"line\">-A FORWARD -m comment --comment <span class=\"string\">\"CNI firewall plugin rules\"</span> -j CNI-FORWARD</span><br><span class=\"line\">-A CNI-FORWARD -m comment --comment <span class=\"string\">\"CNI firewall plugin admin overrides\"</span> -j CNI-ADMIN</span><br><span class=\"line\">-A CNI-FORWARD -d 10.88.0.3/32 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class=\"line\"><span class=\"comment\"># æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘ç›®æ ‡åœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œconntrack æ¨¡å—è¿›è¡Œè¿æ¥çŠ¶æ€è¿½è¸ªã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># å½“å®¹å™¨é€šè¿‡ MASQUERADE å¯¹å¤–è®¿é—®ï¼Œå›åŒ…å†æ¬¡è¿›å…¥å®¹å™¨å®¿ä¸»æœºæ—¶ä¸å†é€šè¿‡ DNAT è½¬å‘ï¼Œè€Œé€šè¿‡ conntrack </span></span><br><span class=\"line\"><span class=\"comment\"># è®°å½•çš„è¿æ¥çŠ¶æ€ç›´æ¥è½¬å‘è‡³è¯¥è§„åˆ™å¹¶é€šè¿‡ cni-podman0 ç½‘æ¡¥è¿›å…¥å®¹å™¨ã€‚</span></span><br><span class=\"line\">-A CNI-FORWARD -s 10.88.0.3/32 -j ACCEPT</span><br><span class=\"line\"><span class=\"comment\"># æ–°å¢è§„åˆ™ï¼šå…è®¸ 3 å±‚è½¬å‘æºåœ°å€ä¸º 10.88.0.3 çš„æµé‡ï¼ˆå‡ºå®¹å™¨çš„æµé‡ï¼‰ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----- nat è¡¨ä¸­åˆ›å»ºæ–°å®¹å™¨åçš„æ–°å¢è§„åˆ™ -----</span></span><br><span class=\"line\">*nat</span><br><span class=\"line\">-A PREROUTING -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT</span><br><span class=\"line\">-A POSTROUTING -m comment --comment <span class=\"string\">\"CNI portfwd requiring masquerade\"</span> -j CNI-HOSTPORT-MASQ</span><br><span class=\"line\">-A POSTROUTING -s 10.88.0.3/32 -m comment --comment <span class=\"string\">\"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -j CNI-b6c5fb6c593e895d843cb5bd</span><br><span class=\"line\"><span class=\"comment\"># æ–°å¢è§„åˆ™ï¼šæ¥è‡ªäº 10.88.0.3 å®¹å™¨çš„æµé‡è½¬å‘è‡³ CNI-b6c5fb6c593e895d843cb5bd é“¾</span></span><br><span class=\"line\">-A OUTPUT -m addrtype --dst-type LOCAL -j CNI-HOSTPORT-DNAT</span><br><span class=\"line\"><span class=\"comment\"># å¯ç”¨ CNI åå³åˆ›å»ºçš„è§„åˆ™ï¼Œè¯¥è§„åˆ™æ¥æ”¶æ¥è‡ªæœ¬åœ°åº”ç”¨çš„æµé‡å¹¶è½¬å‘è‡³ CNI-HOSTPORT-DNAT é“¾</span></span><br><span class=\"line\">-A CNI-HOSTPORT-SETMARK -m comment --comment <span class=\"string\">\"CNI portfwd masquerade mark\"</span> -j MARK --<span class=\"built_in\">set</span>-xmark 0x2000/0x2000</span><br><span class=\"line\">-A CNI-HOSTPORT-MASQ -m mark --mark 0x2000/0x2000 -j MASQUERADE</span><br><span class=\"line\"><span class=\"comment\">### ä»¥ä¸‹ 6 æ¡åœ¨åˆ›å»ºæ–°å®¹å™¨æ—¶åŒæ—¶åˆ›å»º </span></span><br><span class=\"line\">-A CNI-HOSTPORT-DNAT -p tcp -m comment --comment <span class=\"string\">\"dnat name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -m multiport --dports 8843 -j CNI-DN-b6c5fb6c593e895d843cb</span><br><span class=\"line\"><span class=\"comment\"># è‡ªå®šä¹‰ DNAT é“¾ï¼Œå‘é€è‡³æœ¬åœ° 8843 ç«¯å£çš„æµé‡è½¬å‘è‡³ CNI-DN-b6c5fb6c593e895d843cb é“¾ã€‚</span></span><br><span class=\"line\">-A CNI-b6c5fb6c593e895d843cb5bd -d 10.88.0.0/16 -m comment --comment <span class=\"string\">\"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -j ACCEPT</span><br><span class=\"line\"><span class=\"comment\"># å…è®¸è½¬å‘ç›®æ ‡ç½‘æ®µä¸º 10.88.0.0/16 çš„æµé‡ï¼ˆè¿›å…¥å®¹å™¨çš„æµé‡ï¼‰ï¼Œè¯¥ç½‘æ®µä¸ºå®¹å™¨æ‰€åœ¨çš„ç½‘ç»œã€‚</span></span><br><span class=\"line\">-A CNI-b6c5fb6c593e895d843cb5bd ! -d 224.0.0.0/4 -m comment --comment <span class=\"string\">\"name: \\\"podman\\\" id: \\\"2d2b3521457cb1d9b7ae6657304d05789a854e7a48916276a40da543df9aa217\\\"\"</span> -j MASQUERADE</span><br><span class=\"line\"><span class=\"comment\"># MASQUERADE å‡ºå®¹å™¨æµé‡</span></span><br><span class=\"line\">-A CNI-DN-b6c5fb6c593e895d843cb -s 10.88.0.0/16 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK</span><br><span class=\"line\">-A CNI-DN-b6c5fb6c593e895d843cb -s 127.0.0.1/32 -p tcp -m tcp --dport 8843 -j CNI-HOSTPORT-SETMARK</span><br><span class=\"line\">-A CNI-DN-b6c5fb6c593e895d843cb -p tcp -m tcp --dport 8843 -j DNAT --to-destination 10.88.0.3:443</span><br><span class=\"line\"><span class=\"comment\"># è‡ªå®šä¹‰ DNAT é“¾å®ç°å®¹å™¨å®¿ä¸»æœºè‡³å®¹å™¨çš„ç«¯å£æ˜ å°„</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸš€ ç¤ºä¾‹ï¼šå¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæ¶‰åŠçš„å®¿ä¸»æœº iptablesï¼š<br><img src=\"external-access-container-web-service-iptables.jpg\" alt=\"external-access-container-web-service-iptables.jpg\">ä»å¤–éƒ¨è®¿é—®å®¹å™¨å†… Web æœåŠ¡æ—¶ï¼Œæµé‡å°†é€šè¿‡ PREROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ<code>CNI-HOSTPORT-DNAT</code>ã€<code>CNI-DN-xxxx</code>ã€<code>DNAT</code>ï¼‰ï¼Œç»ç”± FORWARD é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ<code>CNI-FORWARD</code>ï¼‰çš„ä¸‰å±‚è½¬å‘ä¸ <code>cni-podman0</code> ç½‘æ¡¥çš„äºŒå±‚è½¬å‘è¿›å…¥å®¹å™¨ï¼Œå®¹å™¨å¯¹å¤–å“åº”çš„æµé‡å°†ç»è¿‡ cni-podman0 ç½‘æ¡¥è½¬å‘ï¼Œå¹¶ç»è¿‡ CNI-FORWARD é“¾ä¸ POSTROUTING é“¾åŠè‡ªå®šä¹‰é“¾ï¼ˆ<code>CNI-HOSTPORT-MASQ</code>ï¼‰å‡ºå®¹å™¨å®¿ä¸»æœºã€‚  </p>\n</li>\n<li><p>ğŸš€ ç¤ºä¾‹ï¼šç›´æ¥ä»å®¹å™¨å†…è®¿é—®å¤–éƒ¨æ—¶ï¼Œè¿”å›å®¹å™¨çš„å›åŒ…å°†ç›´æ¥ä½¿ç”¨ conntrack æ¨¡å—è¿½è¸ªçš„è¿æ¥çŠ¶æ€ï¼Œæµé‡é€šè¿‡ <code>CNI-FORWARD</code> é“¾çš„ä¸‰å±‚è½¬å‘ä¸ cni-podman0 çš„äºŒå±‚è½¬å‘è‡³å®¹å™¨ä¸­ï¼Œå³ï¼Œå›åŒ…è¿›å…¥å®¹å™¨å®¿ä¸»æœºä¸å†é€šè¿‡<code>CNI-HOSTPORT-DNAT</code>é“¾ã€‚<br>å¦‚ä¸‹æ‰€ç¤ºï¼Œç›¸å…³çš„ DNAT é“¾æ— æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ï¼ŒCNI-FORWARD é“¾å‡æœ‰æµé‡é€šè¿‡ï¼ˆè“æ¡†ï¼‰ã€‚<br><img src=\"container-access-external-iptables.jpg\" alt=\"container-access-external-iptables.jpg\"></p>\n<blockquote>\n<p>ğŸ“Œ <strong>Kubernetes ç›¸å…³é—®é¢˜æç¤ºï¼š</strong></p>\n<ol>\n<li>å®¹å™¨æˆ– pod é€šè¿‡ cni ç½‘æ¡¥æ¡¥æ¥çš„æ–¹å¼åœ¨ Kubernetes æˆ– OpenShift3 ä¸­éœ€åœ¨è®¡ç®—èŠ‚ç‚¹ï¼ˆworker nodeï¼‰ä¸Šé…ç½® <code>net.bridge.bridge-nf-call-iptables</code> ä¸ <code>net.bridge.bridge-nf-call-iptables6</code> å†…æ ¸å‚æ•°ï¼Œä½¿ cni äºŒå±‚ç½‘æ¡¥å¯è°ƒç”¨ iptables çš„ conntrack æ¨¡å—ï¼Œä»¥è§£å†³å‰åç«¯ pod åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šæ—¶ï¼Œç”±äº pod ç›´è¿ cni äºŒå±‚ç½‘æ¡¥ï¼Œè€ŒäºŒå±‚ç½‘æ¡¥åªå®ç°äºŒå±‚è½¬å‘ï¼Œæ— æ³•è¿½è¸ªå‰åç«¯çš„è¿æ¥çŠ¶æ€ï¼Œé€ æˆåç«¯ pod å‘å‰ç«¯ pod å›åŒ…æ—¶æ— æ³•å¤„äºåŒä¸€è¿æ¥é“¾è·¯çš„é—®é¢˜ï¼Œå¯ <a href=\"https://imroc.cc/k8s/faq/why-enable-bridge-nf-call-iptables/\" target=\"_blank\" rel=\"noopener\">ç‚¹å‡»æ­¤å¤„</a> è·å¾—æ›´å¤šå¸®åŠ©ã€‚</li>\n<li>ä½¿ç”¨ä»¥ä¸Šå†…æ ¸å‚æ•°æ—¶ï¼Œéœ€åŠ è½½ <code>br_netfilter</code> å†…æ ¸æ¨¡å—æ–¹èƒ½ç”Ÿæ•ˆã€‚</li>\n</ol>\n</blockquote>\n</li>\n<li><p>ä½¿ç”¨ <code>iperf3</code> å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"rootfull-container-to-container-bandwidth.jpg\" alt=\"rootfull-container-to-container-bandwidth.jpg\"></p>\n</li>\n</ul>\n</li>\n<li><p>æ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ç½‘ç»œåˆ†æï¼š  </p>\n<ul>\n<li><code>slirp4netns</code> ç¨‹åºæ”¯æŒ user rootless network namespaceï¼Œè€Œéé€šè¿‡ <code>iptables</code> ä¸ CNI å®ç°ã€‚  </li>\n<li><p>ğŸ‘‰ æ™®é€šç”¨æˆ·ä½¿ç”¨ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨å®¿ä¸»æœº 1024 ä»¥ä¸Šçš„ç«¯å£å®ç°æ˜ å°„ï¼Œä½†å¯ä½¿ç”¨ <code>net.ipv4.ip_unprivileged_port_start</code> å†…æ ¸å‚æ•°å®ç°ä½äº 1024 çš„ç«¯å£å¼€å§‹æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### æ–¹å¼ 1ï¼š###</span></span><br><span class=\"line\">$ sysctl -w net.ipv4.ip_unprivileged_port_start=80</span><br><span class=\"line\"><span class=\"comment\"># ä¸´æ—¶é…ç½®ï¼šå…è®¸æ™®é€šç”¨æˆ·ä» 80 ç«¯å£å¼€å§‹çš„ç«¯å£æ˜ å°„è¿è¡Œ rootless å®¹å™¨</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">### æ–¹å¼ 2ï¼š###</span></span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"net.ipv4.ip_unprivileged_port_start=80\"</span> &gt;&gt; /etc/sysctl.d/rootless.conf</span><br><span class=\"line\"><span class=\"comment\"># æ°¸ä¹…é…ç½®ï¼šå°†è¯¥å†…æ ¸å‚æ•°å†™å…¥å†…æ ¸å‚æ•°é…ç½®æ–‡ä»¶ï¼Œä½¿å…¶å¼€æœºæ°¸ä¹…ç”Ÿæ•ˆã€‚</span></span><br><span class=\"line\">$ sysctl -p</span><br><span class=\"line\"><span class=\"comment\"># ä½¿é…ç½®çš„å†…æ ¸å‚æ•°ç”Ÿæ•ˆ</span></span><br><span class=\"line\"></span><br><span class=\"line\"> - æ™®é€šç”¨æˆ·åˆ›å»ºçš„å®¹å™¨ç½‘ç»œæ¨¡å¼ä¸º `slirp4netns`ï¼ˆslirp4netns è½¯ä»¶åŒ…å®ç°ï¼‰ã€‚    </span><br><span class=\"line\">    ```bash</span><br><span class=\"line\">    $ podman inspect &lt;container_name&gt; | jq .[0].HostConfig.NetworkMode</span><br><span class=\"line\">      <span class=\"string\">\"slirp4netns\"</span></span><br><span class=\"line\">    <span class=\"comment\"># æ™®é€šç”¨æˆ·åˆ›å»ºçš„ rootless å®¹å™¨ç½‘ç»œæ¨¡å¼</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æ¯ä¸ªæ™®é€šç”¨æˆ·è¿è¡Œ rootless å®¹å™¨éƒ½å°†ç”Ÿæˆ slirp4netns è¿›ç¨‹ç”¨äºéš”ç¦»è¯¥ç”¨æˆ·çš„ <code>network namespace</code>ï¼Œä»¥ä¸‹åˆ†åˆ«ä½¿ç”¨ godev ä¸ hualf ç”¨æˆ·è¿è¡Œ rootless å®¹å™¨ï¼š<br><img src=\"godev-rootless-container.jpg\" alt=\"godev-rootless-container.jpg\"><img src=\"hualf-rootless-container.jpg\" alt=\"hualf-rootless-container.jpg\"> </p>\n</li>\n<li>slirp4netns å®ç°çš„ç½‘ç»œæ¨¡å¼ä¸å¸¦å®½æ¯”è¾ƒï¼š<br><img src=\"rootless-slirp4netns-networking.jpg\" alt=\"rootless-slirp4netns-networking.jpg\"> </li>\n<li>ä½¿ç”¨ <code>iperf3</code> å·¥å…·çš„å®¹å™¨æµ‹è¯•ä¸åŒ rootless å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<br><img src=\"rootless-container-to-container-bandwidth.jpg\" alt=\"rootless-container-to-container-bandwidth.jpg\">å¯¹æ¯” rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½æ¥çœ‹ï¼Œslirp4netns å®ç°çš„ rootless å®¹å™¨åœ¨ä¸åŒçš„ç½‘ç»œå‘½åç©ºé—´å†…çš„é€šä¿¡æ€§èƒ½æŸè€—è¾ƒå¤§ï¼Œè€Œ rootfull å®¹å™¨ä¹‹é—´çš„ç½‘ç»œæ€§èƒ½ç›¸æ¯”å‰è€…åœ¨æ­¤æ¬¡æµ‹è¯•ä¸­é«˜å‡ºè¿‘ 5 å€ã€‚ </li>\n<li>å…³äº slirp4netns æ›´åŠ è¯¦ç»†çš„å†…å®¹ï¼Œè¯·å‚è€ƒ <a href=\"https://github.com/rootless-containers/slirp4netns\" target=\"_blank\" rel=\"noopener\">Github é¡¹ç›®</a>ã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Podman-çš„-macvlan-ç½‘ç»œå®ç°ï¼š\"><a href=\"#Podman-çš„-macvlan-ç½‘ç»œå®ç°ï¼š\" class=\"headerlink\" title=\"Podman çš„ macvlan ç½‘ç»œå®ç°ï¼š\"></a>Podman çš„ macvlan ç½‘ç»œå®ç°ï¼š</h3><ul>\n<li><code>macvlan</code> ä½œä¸º CNI åœ¨ Kubernetes ä¸ OpenShift v4 ä¸­ä½œä¸º <code>Multus CNI</code> æ”¯æŒçš„é¢å¤–æ’ä»¶ç±»å‹ä½¿ç”¨æ„ˆåŠ å¹¿æ³›ï¼Œé›†ç¾¤ä¸­é™¤äº†å¸¸è§„ä½¿ç”¨çš„ Flannelã€Calico ç­‰ä½œä¸º <code>slow path</code> çš„æ’ä»¶å¤–ï¼Œè¦æ±‚é«˜æ€§èƒ½çš„ä¸šåŠ¡æµé‡å¯ä½¿ç”¨ macvlan ç›´è¿ pod å®¿ä¸»æœºç‰©ç†ç½‘å£å®ç° <code>fast path</code>ã€‚</li>\n<li>ä¸ºåç»­ç†Ÿæ‚‰ä»¥ä¸Šåœºæ™¯çš„å®ç°ï¼Œå› æ­¤åœ¨ Podman <code>rootfull</code> å®¹å™¨ä¸­ä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼ã€‚</li>\n<li>å…³äº macvlan çš„åŸºç¡€çŸ¥è¯†å¯å‚è€ƒ <a href=\"https://mp.weixin.qq.com/s?__biz=MzU1MzY4NzQ1OA==&amp;mid=2247484064&amp;idx=1&amp;sn=ffd745069b6c4aeac0589de00467b2f2&amp;chksm=fbee426dcc99cb7bdf26f5e6a21bbeaebba7ccd384a02f850d4461ea92331ed140edf98ffaec&amp;mpshare=1&amp;scene=1&amp;srcid=03049MKwF55OVgEZ4OCH39wd&amp;sharer_sharetime=1583337046541&amp;sharer_shareid=8eaca72194dae7b3d51d5c708436eee4#rd\" target=\"_blank\" rel=\"noopener\">Linux è™šæ‹Ÿç½‘å¡æŠ€æœ¯ï¼šMacvlan</a> ä¸ <a href=\"https://cizixs.com/2017/02/14/network-virtualization-macvlan/\" target=\"_blank\" rel=\"noopener\">linux ç½‘ç»œè™šæ‹ŸåŒ–ï¼šmacvlan</a></li>\n<li><p>macvlan ç‰¹æ€§ç”± <code>Linux kernel</code> æ”¯æŒï¼Œç¬”è€…çš„å®éªŒç¯å¢ƒæ»¡è¶³ macvlan çš„è¦æ±‚ï¼Œè¯·ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¡®å®šï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo lsmod | grep macvlan</span><br><span class=\"line\"><span class=\"comment\"># è‹¥æ— ä»»ä½•è¿”å›ï¼Œè¯´æ˜è¿˜æœªåŠ è½½ macvlan å†…æ ¸æ¨¡å—ã€‚</span></span><br><span class=\"line\">$ sudo modprobe macvlan</span><br><span class=\"line\"><span class=\"comment\"># åŠ è½½ macvlan å†…æ ¸æ¨¡å—ï¼Œè‹¥æ‰§è¡ŒæŠ¥é”™ï¼Œè¯´æ˜ kernel ä¸æ”¯æŒè¯¥ç‰¹æ€§ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>podman ä¸ macvlan ç±»å‹ç½‘ç»œçš„é›†æˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo podman network create -d macvlan -o parent=ens33 &lt;network_name&gt;</span><br><span class=\"line\">  /etc/cni/net.d/&lt;network_name&gt;.conflist</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º macvlan ç±»å‹ç½‘ç»œ  </span></span><br><span class=\"line\">$ sudo podman network ls</span><br><span class=\"line\">$ sudo /opt/cni/bin/dhcp daemon</span><br><span class=\"line\"><span class=\"comment\"># åœ¨å¦ä¸€ä¸ªçª—å£ä¸­å¯åŠ¨ dhcp å®ˆæŠ¤è¿›ç¨‹ä¾› macvlan æ’ä»¶è°ƒç”¨ï¼Œä¸ºå®¹å™¨ç½‘å£åˆ†é… IP åœ°å€ã€‚</span></span><br><span class=\"line\">$ sudo podman run -it --rm \\</span><br><span class=\"line\">  --name &lt;container_name&gt; --network=&lt;network_name&gt; \\</span><br><span class=\"line\">  &lt;container_image&gt;:&lt;tag&gt; /bin/sh</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæ”¯æŒ macvlan ç±»å‹ç½‘ç»œçš„ rootfull å®¹å™¨</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä»ä¸ rootfull å®¹å™¨åœ¨åŒä¸€å¹¿æ’­åŸŸçš„å…¶ä»–èŠ‚ç‚¹ä¸Š ping è¯¥å®¹å™¨ï¼Œå¯æ­£å¸¸é€šä¿¡ï¼š<br><img src=\"podman-macvlan-network.png\" alt=\"podman-macvlan-network.png\"></p>\n<blockquote>\n<p>ğŸ¤” ä»¥ä¸Šç¤ºä¾‹çš„å®¹å™¨ä¸­è¿è¡Œ Web æœåŠ¡ï¼ˆå¯æš´éœ² 443 ç«¯å£ï¼‰ï¼Œä½¿ç”¨ macvlan ç½‘ç»œæ¨¡å¼å¯æ‰“é€šä¸åŒä¸€å¹¿æ’­åŸŸä¸­å¤–éƒ¨èŠ‚ç‚¹çš„é€šä¿¡ï¼Œä½†æ— æ³•è®¿é—®å…¶ä¸­çš„æœåŠ¡ï¼Œå¯é‡‡å–ä½•ç§æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼Ÿ  </p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"Podman-rootless-å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\"><a href=\"#Podman-rootless-å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\" class=\"headerlink\" title=\"Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š\"></a>Podman rootless å®¹å™¨ç”¨æˆ·æ˜ å°„å®ç°æ–¹å¼ï¼š</h3><ul>\n<li>Podman rootless å®¹å™¨çš„å®ç°æ ¸å¿ƒåœ¨äºè§£å†³ network namespaceï¼ˆNetNSï¼‰ ä¸ user namespaceï¼ˆUserNSï¼‰ çš„é—®é¢˜ï¼Œå‰æ–‡å·²ä»‹ç» NetNS çš„å®ç°æ–¹å¼ï¼Œåæ–‡å°†ä»‹ç» UserNS çš„å®ç°æ–¹å¼ã€‚</li>\n<li><p>è‹¥è¦ä½¿ç”¨ rootless å®¹å™¨ï¼Œéœ€ç¡®è®¤ OS æ˜¯å¦å¼€å¯ user namespace åŠŸèƒ½ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo sysctl -a | grep user\\.max_user_namespaces</span><br><span class=\"line\">  user.max_user_namespaces = 47494</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç³»ç»Ÿä¸Šæ¯åˆ›å»ºä¸€ä¸ªç”¨æˆ·å°±ä¼šåœ¨ <code>/etc/subuid</code> ä¸ <code>/etc/subgid</code> ä¸­ç”Ÿæˆå¯¹åº”ç”¨æˆ·åœ¨å…¶ç”¨æˆ·å‘½åç©ºé—´ä¸­çš„æ˜ å°„è§„åˆ™ï¼Œä»¥ /etc/subuid ä¸ºä¾‹ï¼Œå‚æ•°ä»¥å†’å·åˆ†éš”ï¼Œæ¯ä¸ªå‚æ•°å«ä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<ul>\n<li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆuidï¼‰ï¼šç”¨æˆ·åç§°  </li>\n<li>ç¬¬äºŒä¸ªå‚æ•°ï¼ˆloweruidï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´ä¸­èµ·å§‹çš„æ˜ å°„ uid</li>\n</ul>\n</li>\n<li>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆcountï¼‰ï¼šç”¨æˆ·å‘½åç©ºé—´å†…éƒ¨ä¸å¤–éƒ¨å¯æ˜ å°„ uid æ•°é‡ï¼ˆå¯ç†è§£ä¸ºæ‰€æœ‰å®¹å™¨æ™®é€šç”¨æˆ·çš„ uid æ•°é‡å’Œï¼‰<br><img src=\"rootless-user-namespace-mapping.jpg\" alt=\"rootless-user-namespace-mapping.jpg\"></li>\n<li>ä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶å…è®¸è¿è¡Œè¿›ç¨‹çš„ uid æ˜ å°„èŒƒå›´ï¼Œåœ¨ <code>/proc/&lt;pid&gt;/uid_map</code> ä¸­å®šä¹‰ã€‚</li>\n<li>å¯è¿‡æ»¤å®¹å™¨ <code>conmon</code> è¿›ç¨‹çš„ pid ç¡®è®¤æ¯ä¸ªå®¹å™¨ä¸­çš„ uid æ˜ å°„æƒ…å†µï¼Œå‚è§ä»¥ä¸‹ç¤ºä¾‹ã€‚</li>\n<li>å…³äºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶çš„å…·ä½“è¯´æ˜å¯å‚è€ƒ <code>newuidmap</code> ä¸ <code>newgidmap</code> å‘½ä»¤çš„ man æ‰‹å†Œã€‚</li>\n<li><p>å¯å‚è€ƒ Podman å®˜æ–¹æ¨èçš„å‘½ä»¤åˆ›å»º uid çš„æ˜ å°„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo usermod --add-subuids 10000-75535 $(whoami)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ----- ç¤ºä¾‹ -----</span></span><br><span class=\"line\">$ sudo cat /etc/subuid</span><br><span class=\"line\">  appuser:10000:500</span><br><span class=\"line\">$ sudo cat /etc/subgid</span><br><span class=\"line\">  appuser:500:50</span><br><span class=\"line\"><span class=\"comment\"># è¯¥ç”¨æˆ·åˆ›å»ºçš„ user namespace ä¸­å¯ä»¥ä½¿ç”¨ä» 10000 å¼€å§‹çš„ 500 ä¸ª UID å’Œä» 500 å¼€å§‹çš„ 50 ä¸ª GID çš„æ˜ å°„ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸš€ ç¤ºä¾‹ï¼š<br>æ™®é€šç”¨æˆ· hualf åœ¨ /etc/subuid ä¸­æ˜ å°„ä¸º hualf:165536:65536ï¼Œè¯´æ˜åœ¨è¯¥ç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´ä¸­å¯åµŒå¥—ä¸€ä¸ªæˆ–å¤šä¸ªç”¨æˆ·å‘½åç©ºé—´ï¼ˆæˆ–å®¹å™¨ï¼‰ï¼Œæ¯ä¸ªå®¹å™¨ä¸­çš„ root ç”¨æˆ· uid 0 éƒ½æ˜ å°„ä¸º hualf ç”¨æˆ·çš„ uid 1001ï¼ˆè¿è¡Œå®¹å™¨è¿›ç¨‹çš„ç”¨æˆ·ï¼‰ï¼Œè€Œå®¹å™¨ä¸­æ™®é€šç”¨æˆ·çš„ uid æ˜ å°„è‡³å®¿ä¸»æœºçš„ subuid èŒƒå›´ä¸­ï¼Œå¯¹äºæ­¤ä¾‹ subuid èŒƒå›´ä¸º 165536~231071ï¼Œå®¹å™¨ä¸­çš„ uid 1 ç”¨æˆ·æ˜ å°„ä¸ºå®¿ä¸»æœº uid 165536ï¼Œå› æ­¤å®¹å™¨ä¸­ admin ç”¨æˆ· uid 1000 æ˜ å°„ä¸ºå®¿ä¸»æœº uid 166535ï¼ˆ165536+999ï¼‰ã€‚<br>é€šè¿‡å®¹å™¨å®¿ä¸»æœºä¸Šæ¯ä¸ªæ™®é€šç”¨æˆ·çš„ç”¨æˆ·å‘½åç©ºé—´çš„ subuid æ˜ å°„èŒƒå›´ï¼Œå¯åˆ†é…ä¼—å¤š uid åœ¨ rootless å®¹å™¨ä¸­è¿è¡Œåº”ç”¨è¿›ç¨‹ã€‚<br><img src=\"user-namespace-subuid-mapping-1-edited.png\" alt=\"user-namespace-subuid-mapping-1-edited.png\"><img src=\"user-namespace-subuid-mapping-2-edited.png\" alt=\"user-namespace-subuid-mapping-2-edited.png\"></p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://projectatomic.io/blog/2018/02/reintroduction-podman/\" target=\"_blank\" rel=\"noopener\">Reintroduction of Podman</a></li>\n<li><a href=\"https://fedoramagazine.org/podman-pods-fedora-containers/\" target=\"_blank\" rel=\"noopener\">Using pods with Podman on Fedora</a></li>\n<li><a href=\"https://www.redhat.com/sysadmin/container-networking-podman\" target=\"_blank\" rel=\"noopener\">Configuring container networking with Podman</a></li>\n<li><a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/building_running_and_managing_containers/index\" target=\"_blank\" rel=\"noopener\">RedHat docs - Building, running, and managing Linux containers on Red Hat Enterprise Linux 8</a></li>\n<li><a href=\"https://developer.aliyun.com/article/700923\" target=\"_blank\" rel=\"noopener\">å®¹å™¨å®‰å…¨æ‹¾é— - Rootless Containeråˆæ¢</a></li>\n<li><a href=\"https://www.kernel.org/doc/html/latest/admin-guide/sysctl/user.html\" target=\"_blank\" rel=\"noopener\">Documentation for /proc/sys/user/</a></li>\n<li><a href=\"https://docs.docker.com/compose/\" target=\"_blank\" rel=\"noopener\">docker docs - Overview of Docker Compose</a></li>\n<li><a href=\"https://www.cni.dev/plugins/current/meta/firewall/\" target=\"_blank\" rel=\"noopener\">CNI docs - firewall plugin</a></li>\n<li><a href=\"https://www.cni.dev/plugins/current/meta/firewall/\" target=\"_blank\" rel=\"noopener\">CNI docs - Port-mapping plugin</a></li>\n<li><a href=\"https://fossies.org/linux/podman/docs/tutorials/basic_networking.md\" target=\"_blank\" rel=\"noopener\">https://fossies.org/linux/podman/docs/tutorials/basic_networking.md</a></li>\n</ul>\n"},{"title":"Red Hat Quay v3 registry åŸç†ä¸å®ç°","subtitle":"Red Hat Quay v3 registry Architecture and Implement","header-img":"redhat-quay-bg.jpg","date":"2022-12-05T09:05:39.000Z","_content":"\n### æ–‡æ¡£ç›®å½•ï¼š\n- å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“\n- Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“\n- Red Hat å®¹å™¨é•œåƒå®‰å…¨\n- Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²\n- å‚è€ƒé“¾æ¥\n\n### å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\n- Harbor v1/v2ï¼šç”± `VMware` ä¸»å¯¼å¼€å‘ï¼Œå¹¶ä» `CNCF` äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šå­µåŒ–æˆåŠŸã€‚\n- **`Red Hat Quay v3`**ï¼šç”± `Red Hat` å¼€æºçš„ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œç±»ä¼¼äº `CoreOS` çš„ Quayã€‚\n- registry v2ï¼š`Docker` å…¬å¸å‘å¸ƒçš„ v2 ç‰ˆæœ¬å®¹å™¨é•œåƒä»“åº“é•œåƒï¼Œå¯ç›´æ¥è¿è¡Œæä¾›æœåŠ¡ã€‚\n- docker-distributionï¼šç”± `docker-distribution` RPM è½¯ä»¶åŒ…æä¾›ï¼Œ`systemd` æ–¹å¼è¿è¡Œã€‚\n\n### Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\n- **Red Hat Container Registry**ï¼š`registry.access.redhat.com`  \n  - è¯¥ä»“åº“ä¸ºå…¬å…±é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œæ— éœ€èº«ä»½éªŒè¯ã€‚  \n  - ä½†è¯·æ³¨æ„ï¼Œè™½ç„¶æ­¤å®¹å™¨é•œåƒä»“åº“æ˜¯å…¬å…±çš„ï¼Œä½† Red Hat çš„å¤§å¤šæ•°å®¹å™¨é•œåƒè§„å®šè¦æ±‚ç”¨æˆ·æ‹¥æœ‰æ¿€æ´»çš„ Red Hat äº§å“è®¢é˜…ï¼Œå¹¶ä¸”ä»–ä»¬éµå®ˆäº§å“çš„ç»ˆç«¯ç”¨æˆ·åè®®ï¼ˆEUAï¼‰ã€‚  \n  - åªæœ‰åŸºäº Red Hat Enterprise Linux Universal Base Images (`UBI`) çš„é•œåƒå¯ä»è¯¥é•œåƒä»“åº“ä¸­è‡ªç”±åœ°é‡æ–°å‘å¸ƒã€‚\n- **RedÂ Hat terms-based registry**ï¼š`registry.redhat.io`  \n  - è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œå¹¶ä¸”éœ€è¦èº«ä»½éªŒè¯ã€‚  \n  - ä»è¯¥ä»“åº“æ‹‰å–é•œåƒæ—¶ï¼Œéœ€æä¾› Red Hat Customer Portal å‡­è¯ï¼ˆcredentialï¼‰è¿›è¡Œèº«ä»½éªŒè¯ã€‚  \n  - å¯¹äºå…±äº«ç¯å¢ƒï¼Œå¦‚ OpenShift æˆ– CI/CD ç®¡é“ï¼Œå¯åˆ›å»º `service account` æˆ–èº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä»¥é¿å…æš´éœ²ä¸ªäººå‡­æ®ã€‚\n- **RedÂ Hat partner registry**ï¼š`registry.connect.redhat.com`  \n  - è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡æ¥è‡ªè®¤è¯åˆä½œä¼™ä¼´çš„ç¬¬ä¸‰æ–¹äº§å“çš„é•œåƒã€‚  \n  - å®ƒè¿˜éœ€æä¾› Red Hat Customer Portal å‡­è¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚  \n  - å®ƒä»¬å¯èƒ½å—åˆ¶äºåˆä¼™ä¼™ä¼´çš„è®¤è´­æˆ–è®¸å¯ã€‚\n- **Quay.io**ï¼š  \n  - Red Hat è¿˜ç®¡ç† `Quay.io` å®¹å™¨é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œä¸€ä¸ªå…è´¹å¸æˆ·ï¼Œå¹¶å‘å¸ƒè‡ªå·±çš„å®¹å™¨é•œåƒã€‚  \n  - Red Hat å¯¹ä»»ä½•æ‰˜ç®¡åœ¨ Quay.io ä¸Šçš„å®¹å™¨é•œåƒéƒ½æ²¡æœ‰æä¾›ä¿è¯ã€‚  \n  - å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ Quay.io ä½œä¸ºä¸€ä¸ªå…¬å…±é•œåƒä»“åº“ï¼Œä½†æ˜¯ç»„ç»‡ï¼ˆorganizationï¼‰ä¹Ÿå¯ä»¥è´­ä¹°å…è®¸ä½¿ç”¨ Quay.io ä½œä¸ºç§æœ‰é•œåƒä»“åº“ã€‚\n> ğŸ‘‰ å…³äº Red Hat å®¹å™¨é•œåƒä»“åº“çš„è¯´æ˜å¯å‚è€ƒ [Red Hat Container Registry Authentication](https://access.redhat.com/RegistryAuthentication)\n\n### Red Hat å®¹å™¨é•œåƒå®‰å…¨ï¼š\n- [Red Hat Container Catalog](https://catalog.redhat.com/software/containers/search)ï¼ˆRHCCï¼‰å¯æä¾›æ„å»º S2I æ„å»ºé•œåƒçš„åŸºç¡€å®¹å™¨é•œåƒï¼Œä¹Ÿå¯ç›´æ¥æä¾› S2I æ„å»ºé•œåƒï¼ŒRed Hat Container Catalog é€šè¿‡ `https://registry.redhat.io` ä½œä¸ºå®¹å™¨é•œåƒæ‹‰å–ä¸æ¨é€çš„ portalã€‚\n- è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒé€šè¿‡ `Container Health Index` è¿›è¡Œå®‰å…¨æ€§è¯„ä¼°ï¼Œå¯æ ¹æ®ä¸åŒçš„è¯„ä¼°ç»“æœé€‰å–å¼€å‘è€…æ‰€éœ€è¦çš„é•œåƒï¼Œä¸€èˆ¬é€‰æ‹©å®‰å…¨ç­‰çº§ä¸º `A` æˆ– `B` çš„é•œåƒï¼Œä»¥ä¸‹ä»¥ `Go Toolset` é•œåƒä¸ºä¾‹ç¡®å®šå…¶å®‰å…¨ç­‰çº§ï¼š![go-toolset-catalog.jpg](go-toolset-catalog.jpg)\n- å…³äº [Red Hat å®¹å™¨é•œåƒå®‰å…¨ç­‰çº§è¯´æ˜](https://access.redhat.com/articles/2803031)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![catalog-health-index.jpg](catalog-health-index.jpg)\n  - Red Hat å®‰å…¨è¯„çº§è¯´æ˜æ–‡æ¡£å¯å‚è€ƒ [Understanding Red Hat security ratings](https://access.redhat.com/security/updates/classification)\n- å®¹å™¨é•œåƒçš„å®‰å…¨è¯„åˆ†ä¸åˆ†çº§å¯å‚è€ƒ [Security Scoring and Grading for Container Images](https://access.redhat.com/blogs/product-security/posts/container-security-scoring)\n\n### Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\n- Red Hat Quay å®¹å™¨é•œåƒä»“åº“çš„é«˜çº§ç‰¹æ€§ï¼š  \n  - é•œåƒå®‰å…¨æ‰«æï¼ˆimage security scanningï¼‰  \n  - åŸºäºè§’è‰²çš„è®¿é—®ï¼ˆrole-based accessï¼‰  \n  - ç»„ç»‡ä¸å›¢é˜Ÿç®¡ç†ï¼ˆorganization and team managementï¼‰  \n  - é•œåƒè‡ªåŠ¨åŒ–æ„å»ºï¼ˆimage build automationï¼‰  \n  - å®¡è®¡ï¼ˆauditingï¼‰  \n  - å¼‚åœ°å¤åˆ¶ï¼ˆgeo-replicationï¼‰  \n  - é«˜å¯ç”¨ï¼ˆhigh availabilityï¼‰\n- è¯¥æ–‡æ¡£ä½¿ç”¨ `basic` æ–¹å¼å®¹å™¨éƒ¨ç½²ï¼Œé **`HA`** æ–¹å¼ã€‚\n- Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“ç»„ä»¶ï¼š  \n  - `Database`ï¼šMySQL æˆ– PostgreSQL æ•°æ®åº“ï¼Œä¸»è¦å­˜å‚¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè€Œéé•œåƒå­˜å‚¨ã€‚  \n  - `Redis`ï¼šé”®å€¼å‹å­˜å‚¨ï¼Œå­˜å‚¨å®æ—¶æ„å»ºæ—¥å¿—ä¸ Quay çš„å‘å¯¼ã€‚  \n  - `Quay`ï¼šå®¹å™¨é•œåƒä»“åº“ï¼Œä¸»è¦è¿è¡Œ quay å®¹å™¨æœåŠ¡ï¼Œè¯¥æœåŠ¡ç”±å¤šä¸ªç»„ä»¶ç»„æˆã€‚  \n  - **`Clair`**ï¼šé™æ€å®¹å™¨é•œåƒæ‰«æå·¥å…·ï¼Œå¯è¯†åˆ«å®‰å…¨éšæ‚£ä¸ä¿®å¤é—®é¢˜ï¼ˆfixesï¼‰ã€‚\n- éƒ¨ç½²çš„å®¹å™¨é•œåƒä¸ç‰ˆæœ¬ï¼š  \n  - MySQLï¼š[registry.access.redhat.com/rhscl/mysql-57-rhel7:latest](http://registry.access.redhat.com/rhscl/mysql-57-rhel7:latest)  \n  - Redisï¼š[registry.assess.redhat.com/rhscl/redis-32-rhel7:latest](http://registry.assess.redhat.com/rhscl/redis-32-rhel7:latest)  \n  - Quayï¼šquay.io/redhat/quay:v3.3.0\n> **æ³¨æ„**ï¼šæ‹‰å–è¯¥å®¹å™¨é•œåƒå‰å¿…é¡»å…ˆä½¿ç”¨ç›¸åº”è´¦å·ç™»å½• Quayï¼Œå¦‚ä¸‹è„šæœ¬æ‰€ç¤ºã€‚\n- ä½¿ç”¨ `docker` è¿è¡Œå„ä¸ªå•å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· [å‚è€ƒæ­¤å¤„](https://github.com/Alberthua-Perl/summary-scripts/blob/master/shell-examples/deploy-quay-registry.sh)ã€‚\n- ğŸš€ æ¨èï¼š  \n  ä½¿ç”¨ `podman` è¿è¡Œå• `pod` é›†æˆä»¥ä¸Šæ‰€æœ‰å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· [å‚è€ƒæ­¤å¤„](https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/quay-pod-manage.sh)ï¼ˆæœªé›†æˆ Clairï¼‰ã€‚  \n  è¯¥æ–¹å¼ä¸­ quay-aio pod å°†æ‰€æœ‰å®¹å™¨é™åˆ¶åœ¨åŒä¸€ `network namespace` ä¸­ï¼ŒQuay çš„é…ç½®ã€éƒ¨ç½²ä¸è®¿é—®æ¶‰åŠä¼—å¤šç«¯å£ï¼Œä½¿ç”¨å•å®¹å™¨è¿è¡Œäºå®¿ä¸»æœºä¸Šå°†ç”Ÿæˆå¤šæ¡ iptables `filter` ä¸ `nat` è¡¨è§„åˆ™ï¼Œè€Œé›†æˆåœ¨å• pod ä¸­æ›´åŠ ä¾¿äºç®¡ç†ã€‚\n- ä»¥ç¬¬äºŒç§æ–¹å¼ä¸ºä¾‹ï¼Œé¦–å…ˆæ‰§è¡Œ `quay-pod-manage config` å‘½ä»¤ï¼Œå†è¿›è¡Œä»¥ä¸‹é…ç½®ã€‚\n- éƒ¨ç½²å‰é¦–æ¬¡é…ç½® Quay æ—¶ï¼Œéœ€é€šè¿‡ Web é¡µé¢å°† Quay ä¸ MySQL å¯¹æ¥ï¼ŒæŒ‡å®šä»“åº“ FQDN åŠå¯¹æ¥çš„ Redis æ•°æ®åº“åœ°å€ï¼Œè‹¥ä½¿ç”¨ pod æ–¹å¼éƒ¨ç½²ï¼Œå…¶åœ°å€å³ä¸º pod æ‰€åœ¨ `network namespace` çš„ ip åœ°å€ï¼Œå¹¶æœ€ç»ˆä¸‹è½½ quay çš„ `.tar.gz` é…ç½®æ–‡ä»¶ã€‚\n- è¿è¡Œä»¥ä¸Šå‘½ä»¤å¯èƒ½å‡ºç°çš„æŠ¥é”™ï¼ˆç°å·²è§£å†³ï¼‰ï¼š  \n  - æŠ¥é”™ 1ï¼šç”±äº `/mnt/quay/config/ssl.key` æƒé™é—®é¢˜å¯¼è‡´æ— æ³•å¯åŠ¨ quay-master å®¹å™¨ï¼Œæ›´æ”¹å…¶æƒé™ä¸º `0644` å³å¯ã€‚![ssl-key-permission-run-quay-error.jpg](ssl-key-permission-run-quay-error.jpg)\n  - æŠ¥é”™ 2ï¼šç”±äº `/mnt/quay/storage/` æ‰€æœ‰è€…é—®é¢˜å¯¼è‡´æ— æ³•ä»å®¢æˆ·ç«¯æ¨é€å®¹å™¨é•œåƒè‡³é•œåƒä»“åº“ä¸­ï¼Œæ›´æ”¹ç›®å½•çš„æ‰€æœ‰è€…ä¸º `1001` å³å¯ï¼Œè¯¥ç”¨æˆ·ä¸º quay-master å®¹å™¨ä¸­ä¸»è¿›ç¨‹çš„è¿è¡Œç”¨æˆ·ï¼Œå¿…é¡»å¯¹å®¿ä¸»æœºæ˜ å°„çš„ç›®å½•å…·æœ‰å†™æƒé™ã€‚![podman-push-quay-permission-denied-1001-1.jpg](podman-push-quay-permission-denied-1001-1.jpg)![podman-push-quay-permission-denied-1001-2.jpg](podman-push-quay-permission-denied-1001-2.jpg)\n- `Web UI` ä¸­çš„é…ç½®è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - é…ç½®å¹¶ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š    \n    - ç™»å½• Quay å¹¶å®Œæˆè®¤è¯ï¼š![first-login-config-quay.png](first-login-config-quay.png)    \n    - ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š![config-quay-1.png](config-quay-1.png)![config-quay-2.png](config-quay-2.png)![config-quay-3.png](config-quay-3.png)![config-quay-4.png](config-quay-4.png)![config-quay-5.png](config-quay-5.png)![config-quay-6.png](config-quay-6.png)![config-quay-7.png](config-quay-7.png)![config-quay-8.png](config-quay-8.png)\n- ä¸‹è½½ quay çš„é…ç½®å‹ç¼©æ–‡ä»¶åï¼Œå¯æ‰§è¡Œ `quay-pod-manage deploy` å‘½ä»¤å®Œæˆ Quay çš„éƒ¨ç½²ã€‚\n- è‹¥éƒ¨ç½²å¤±è´¥å¯æ‰§è¡Œ `quay-pod-manage destroy` å‘½ä»¤é”€æ¯ podã€‚\n- è‹¥è¿è¡Œ Quay çš„ quay-master å®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼Œå¯æ‰§è¡Œ `quay-pod-manage recover` å‘½ä»¤æ¢å¤æ•…éšœçš„å®¹å™¨ã€‚\n- ç™»å½•ä¸éªŒè¯ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š  \n  ç”¨æˆ·åï¼š`admin` å¯†ç ï¼š`1qazZSE$`![normal-login-quay.png](normal-login-quay.png)\n- Podman å®¢æˆ·ç«¯ç™»å½• Quayï¼š  \n  ä½¿ç”¨åŸºäº `Docker registry API` çš„ `OCI distribution API` ç™»å½•å¹¶è®¿é—® Quay å®¹å™¨é•œåƒä»“åº“ï¼ŒRed Hat æ¨èä½¿ç”¨åŸºäº RHEL çš„å®¹å™¨å·¥å…·ï¼Œå³ `Podman`ã€`Buildah` ä¸ `Skopeo` æ¥è®¿é—®è¯¥ APIã€‚  \n  ```bash\n  $ sudo mkdir /etc/docker/certs.d/<quay_registry_fqdn>/\n  # åˆ›å»º Podman å®¢æˆ·ç«¯ Quay CA è¯ä¹¦å­˜å‚¨ç›®å½•\n  $ sudo scp root@<quay_registry_fqdn>:/mnt/quay/config/ssl.cert \\\n    /etc/docker/certs.d/<quay_registry_fqdn>/ssl.crt\n  # åŒæ­¥ Quay CA è¯ä¹¦è‡³ Podman å®¢æˆ·ç«¯\n  \n  # su - contsvc\n  $ vim ~/.config/containers/registries.conf\n    unqualified-search-registries = ['<quay_registry_fqdn>']\n    # è¯¥åœ°å€å½¢å¦‚ registry.lab.example.com\n    [[registry]]\n    location = \"<quay_registry_fqdn>\"\n    insecure = true\n    blocked = false\n  # é…ç½®æ™®é€šç”¨æˆ·çš„ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“åœ°å€\n  \n  $ podman login <quay_registry_fqdn> \\\n    --username admin --password 1qazZSE$ \\\n    --log-level=debug\n  # æˆåŠŸç™»å½• Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶å¼€å¯ debug æ¨¡å¼ã€‚\n  ```\n- Docker å®¢æˆ·ç«¯ç™»å½• Quayï¼ˆå¯é€‰ï¼‰ï¼š![docker-client-login-quay-registry.jpg](docker-client-login-quay-registry.jpg)\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Quay åŸºç¡€ç‰ˆå®‰è£…å’Œéƒ¨ç½²](https://www.cnblogs.com/ericnie/p/12233269.html)\n- [Deploy Project Quay for proof-of-concept (non-production) purposes](https://docs.projectquay.io/deploy_quay.html)\n- [docker.github.io/registry/deploying.md](https://github.com/docker/docker.github.io/blob/master/registry/deploying.md#get-a-certificate)\n- [docker.github.io/registry/insecure.md](https://github.com/docker/docker.github.io/blob/master/registry/insecure.md)","source":"_posts/redhat-quay-v3-registry.md","raw":"---\ntitle: Red Hat Quay v3 registry åŸç†ä¸å®ç°\nsubtitle: Red Hat Quay v3 registry Architecture and Implement\nheader-img: redhat-quay-bg.jpg\ndate: 2022-12-05 17:05:39\ntags:\n  - å®¹å™¨\n  - äº‘åŸç”Ÿ\n---\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“\n- Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“\n- Red Hat å®¹å™¨é•œåƒå®‰å…¨\n- Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²\n- å‚è€ƒé“¾æ¥\n\n### å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\n- Harbor v1/v2ï¼šç”± `VMware` ä¸»å¯¼å¼€å‘ï¼Œå¹¶ä» `CNCF` äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šå­µåŒ–æˆåŠŸã€‚\n- **`Red Hat Quay v3`**ï¼šç”± `Red Hat` å¼€æºçš„ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œç±»ä¼¼äº `CoreOS` çš„ Quayã€‚\n- registry v2ï¼š`Docker` å…¬å¸å‘å¸ƒçš„ v2 ç‰ˆæœ¬å®¹å™¨é•œåƒä»“åº“é•œåƒï¼Œå¯ç›´æ¥è¿è¡Œæä¾›æœåŠ¡ã€‚\n- docker-distributionï¼šç”± `docker-distribution` RPM è½¯ä»¶åŒ…æä¾›ï¼Œ`systemd` æ–¹å¼è¿è¡Œã€‚\n\n### Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\n- **Red Hat Container Registry**ï¼š`registry.access.redhat.com`  \n  - è¯¥ä»“åº“ä¸ºå…¬å…±é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œæ— éœ€èº«ä»½éªŒè¯ã€‚  \n  - ä½†è¯·æ³¨æ„ï¼Œè™½ç„¶æ­¤å®¹å™¨é•œåƒä»“åº“æ˜¯å…¬å…±çš„ï¼Œä½† Red Hat çš„å¤§å¤šæ•°å®¹å™¨é•œåƒè§„å®šè¦æ±‚ç”¨æˆ·æ‹¥æœ‰æ¿€æ´»çš„ Red Hat äº§å“è®¢é˜…ï¼Œå¹¶ä¸”ä»–ä»¬éµå®ˆäº§å“çš„ç»ˆç«¯ç”¨æˆ·åè®®ï¼ˆEUAï¼‰ã€‚  \n  - åªæœ‰åŸºäº Red Hat Enterprise Linux Universal Base Images (`UBI`) çš„é•œåƒå¯ä»è¯¥é•œåƒä»“åº“ä¸­è‡ªç”±åœ°é‡æ–°å‘å¸ƒã€‚\n- **RedÂ Hat terms-based registry**ï¼š`registry.redhat.io`  \n  - è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œå¹¶ä¸”éœ€è¦èº«ä»½éªŒè¯ã€‚  \n  - ä»è¯¥ä»“åº“æ‹‰å–é•œåƒæ—¶ï¼Œéœ€æä¾› Red Hat Customer Portal å‡­è¯ï¼ˆcredentialï¼‰è¿›è¡Œèº«ä»½éªŒè¯ã€‚  \n  - å¯¹äºå…±äº«ç¯å¢ƒï¼Œå¦‚ OpenShift æˆ– CI/CD ç®¡é“ï¼Œå¯åˆ›å»º `service account` æˆ–èº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä»¥é¿å…æš´éœ²ä¸ªäººå‡­æ®ã€‚\n- **RedÂ Hat partner registry**ï¼š`registry.connect.redhat.com`  \n  - è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡æ¥è‡ªè®¤è¯åˆä½œä¼™ä¼´çš„ç¬¬ä¸‰æ–¹äº§å“çš„é•œåƒã€‚  \n  - å®ƒè¿˜éœ€æä¾› Red Hat Customer Portal å‡­è¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚  \n  - å®ƒä»¬å¯èƒ½å—åˆ¶äºåˆä¼™ä¼™ä¼´çš„è®¤è´­æˆ–è®¸å¯ã€‚\n- **Quay.io**ï¼š  \n  - Red Hat è¿˜ç®¡ç† `Quay.io` å®¹å™¨é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œä¸€ä¸ªå…è´¹å¸æˆ·ï¼Œå¹¶å‘å¸ƒè‡ªå·±çš„å®¹å™¨é•œåƒã€‚  \n  - Red Hat å¯¹ä»»ä½•æ‰˜ç®¡åœ¨ Quay.io ä¸Šçš„å®¹å™¨é•œåƒéƒ½æ²¡æœ‰æä¾›ä¿è¯ã€‚  \n  - å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ Quay.io ä½œä¸ºä¸€ä¸ªå…¬å…±é•œåƒä»“åº“ï¼Œä½†æ˜¯ç»„ç»‡ï¼ˆorganizationï¼‰ä¹Ÿå¯ä»¥è´­ä¹°å…è®¸ä½¿ç”¨ Quay.io ä½œä¸ºç§æœ‰é•œåƒä»“åº“ã€‚\n> ğŸ‘‰ å…³äº Red Hat å®¹å™¨é•œåƒä»“åº“çš„è¯´æ˜å¯å‚è€ƒ [Red Hat Container Registry Authentication](https://access.redhat.com/RegistryAuthentication)\n\n### Red Hat å®¹å™¨é•œåƒå®‰å…¨ï¼š\n- [Red Hat Container Catalog](https://catalog.redhat.com/software/containers/search)ï¼ˆRHCCï¼‰å¯æä¾›æ„å»º S2I æ„å»ºé•œåƒçš„åŸºç¡€å®¹å™¨é•œåƒï¼Œä¹Ÿå¯ç›´æ¥æä¾› S2I æ„å»ºé•œåƒï¼ŒRed Hat Container Catalog é€šè¿‡ `https://registry.redhat.io` ä½œä¸ºå®¹å™¨é•œåƒæ‹‰å–ä¸æ¨é€çš„ portalã€‚\n- è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒé€šè¿‡ `Container Health Index` è¿›è¡Œå®‰å…¨æ€§è¯„ä¼°ï¼Œå¯æ ¹æ®ä¸åŒçš„è¯„ä¼°ç»“æœé€‰å–å¼€å‘è€…æ‰€éœ€è¦çš„é•œåƒï¼Œä¸€èˆ¬é€‰æ‹©å®‰å…¨ç­‰çº§ä¸º `A` æˆ– `B` çš„é•œåƒï¼Œä»¥ä¸‹ä»¥ `Go Toolset` é•œåƒä¸ºä¾‹ç¡®å®šå…¶å®‰å…¨ç­‰çº§ï¼š![go-toolset-catalog.jpg](go-toolset-catalog.jpg)\n- å…³äº [Red Hat å®¹å™¨é•œåƒå®‰å…¨ç­‰çº§è¯´æ˜](https://access.redhat.com/articles/2803031)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![catalog-health-index.jpg](catalog-health-index.jpg)\n  - Red Hat å®‰å…¨è¯„çº§è¯´æ˜æ–‡æ¡£å¯å‚è€ƒ [Understanding Red Hat security ratings](https://access.redhat.com/security/updates/classification)\n- å®¹å™¨é•œåƒçš„å®‰å…¨è¯„åˆ†ä¸åˆ†çº§å¯å‚è€ƒ [Security Scoring and Grading for Container Images](https://access.redhat.com/blogs/product-security/posts/container-security-scoring)\n\n### Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\n- Red Hat Quay å®¹å™¨é•œåƒä»“åº“çš„é«˜çº§ç‰¹æ€§ï¼š  \n  - é•œåƒå®‰å…¨æ‰«æï¼ˆimage security scanningï¼‰  \n  - åŸºäºè§’è‰²çš„è®¿é—®ï¼ˆrole-based accessï¼‰  \n  - ç»„ç»‡ä¸å›¢é˜Ÿç®¡ç†ï¼ˆorganization and team managementï¼‰  \n  - é•œåƒè‡ªåŠ¨åŒ–æ„å»ºï¼ˆimage build automationï¼‰  \n  - å®¡è®¡ï¼ˆauditingï¼‰  \n  - å¼‚åœ°å¤åˆ¶ï¼ˆgeo-replicationï¼‰  \n  - é«˜å¯ç”¨ï¼ˆhigh availabilityï¼‰\n- è¯¥æ–‡æ¡£ä½¿ç”¨ `basic` æ–¹å¼å®¹å™¨éƒ¨ç½²ï¼Œé **`HA`** æ–¹å¼ã€‚\n- Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“ç»„ä»¶ï¼š  \n  - `Database`ï¼šMySQL æˆ– PostgreSQL æ•°æ®åº“ï¼Œä¸»è¦å­˜å‚¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè€Œéé•œåƒå­˜å‚¨ã€‚  \n  - `Redis`ï¼šé”®å€¼å‹å­˜å‚¨ï¼Œå­˜å‚¨å®æ—¶æ„å»ºæ—¥å¿—ä¸ Quay çš„å‘å¯¼ã€‚  \n  - `Quay`ï¼šå®¹å™¨é•œåƒä»“åº“ï¼Œä¸»è¦è¿è¡Œ quay å®¹å™¨æœåŠ¡ï¼Œè¯¥æœåŠ¡ç”±å¤šä¸ªç»„ä»¶ç»„æˆã€‚  \n  - **`Clair`**ï¼šé™æ€å®¹å™¨é•œåƒæ‰«æå·¥å…·ï¼Œå¯è¯†åˆ«å®‰å…¨éšæ‚£ä¸ä¿®å¤é—®é¢˜ï¼ˆfixesï¼‰ã€‚\n- éƒ¨ç½²çš„å®¹å™¨é•œåƒä¸ç‰ˆæœ¬ï¼š  \n  - MySQLï¼š[registry.access.redhat.com/rhscl/mysql-57-rhel7:latest](http://registry.access.redhat.com/rhscl/mysql-57-rhel7:latest)  \n  - Redisï¼š[registry.assess.redhat.com/rhscl/redis-32-rhel7:latest](http://registry.assess.redhat.com/rhscl/redis-32-rhel7:latest)  \n  - Quayï¼šquay.io/redhat/quay:v3.3.0\n> **æ³¨æ„**ï¼šæ‹‰å–è¯¥å®¹å™¨é•œåƒå‰å¿…é¡»å…ˆä½¿ç”¨ç›¸åº”è´¦å·ç™»å½• Quayï¼Œå¦‚ä¸‹è„šæœ¬æ‰€ç¤ºã€‚\n- ä½¿ç”¨ `docker` è¿è¡Œå„ä¸ªå•å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· [å‚è€ƒæ­¤å¤„](https://github.com/Alberthua-Perl/summary-scripts/blob/master/shell-examples/deploy-quay-registry.sh)ã€‚\n- ğŸš€ æ¨èï¼š  \n  ä½¿ç”¨ `podman` è¿è¡Œå• `pod` é›†æˆä»¥ä¸Šæ‰€æœ‰å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· [å‚è€ƒæ­¤å¤„](https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/quay-pod-manage.sh)ï¼ˆæœªé›†æˆ Clairï¼‰ã€‚  \n  è¯¥æ–¹å¼ä¸­ quay-aio pod å°†æ‰€æœ‰å®¹å™¨é™åˆ¶åœ¨åŒä¸€ `network namespace` ä¸­ï¼ŒQuay çš„é…ç½®ã€éƒ¨ç½²ä¸è®¿é—®æ¶‰åŠä¼—å¤šç«¯å£ï¼Œä½¿ç”¨å•å®¹å™¨è¿è¡Œäºå®¿ä¸»æœºä¸Šå°†ç”Ÿæˆå¤šæ¡ iptables `filter` ä¸ `nat` è¡¨è§„åˆ™ï¼Œè€Œé›†æˆåœ¨å• pod ä¸­æ›´åŠ ä¾¿äºç®¡ç†ã€‚\n- ä»¥ç¬¬äºŒç§æ–¹å¼ä¸ºä¾‹ï¼Œé¦–å…ˆæ‰§è¡Œ `quay-pod-manage config` å‘½ä»¤ï¼Œå†è¿›è¡Œä»¥ä¸‹é…ç½®ã€‚\n- éƒ¨ç½²å‰é¦–æ¬¡é…ç½® Quay æ—¶ï¼Œéœ€é€šè¿‡ Web é¡µé¢å°† Quay ä¸ MySQL å¯¹æ¥ï¼ŒæŒ‡å®šä»“åº“ FQDN åŠå¯¹æ¥çš„ Redis æ•°æ®åº“åœ°å€ï¼Œè‹¥ä½¿ç”¨ pod æ–¹å¼éƒ¨ç½²ï¼Œå…¶åœ°å€å³ä¸º pod æ‰€åœ¨ `network namespace` çš„ ip åœ°å€ï¼Œå¹¶æœ€ç»ˆä¸‹è½½ quay çš„ `.tar.gz` é…ç½®æ–‡ä»¶ã€‚\n- è¿è¡Œä»¥ä¸Šå‘½ä»¤å¯èƒ½å‡ºç°çš„æŠ¥é”™ï¼ˆç°å·²è§£å†³ï¼‰ï¼š  \n  - æŠ¥é”™ 1ï¼šç”±äº `/mnt/quay/config/ssl.key` æƒé™é—®é¢˜å¯¼è‡´æ— æ³•å¯åŠ¨ quay-master å®¹å™¨ï¼Œæ›´æ”¹å…¶æƒé™ä¸º `0644` å³å¯ã€‚![ssl-key-permission-run-quay-error.jpg](ssl-key-permission-run-quay-error.jpg)\n  - æŠ¥é”™ 2ï¼šç”±äº `/mnt/quay/storage/` æ‰€æœ‰è€…é—®é¢˜å¯¼è‡´æ— æ³•ä»å®¢æˆ·ç«¯æ¨é€å®¹å™¨é•œåƒè‡³é•œåƒä»“åº“ä¸­ï¼Œæ›´æ”¹ç›®å½•çš„æ‰€æœ‰è€…ä¸º `1001` å³å¯ï¼Œè¯¥ç”¨æˆ·ä¸º quay-master å®¹å™¨ä¸­ä¸»è¿›ç¨‹çš„è¿è¡Œç”¨æˆ·ï¼Œå¿…é¡»å¯¹å®¿ä¸»æœºæ˜ å°„çš„ç›®å½•å…·æœ‰å†™æƒé™ã€‚![podman-push-quay-permission-denied-1001-1.jpg](podman-push-quay-permission-denied-1001-1.jpg)![podman-push-quay-permission-denied-1001-2.jpg](podman-push-quay-permission-denied-1001-2.jpg)\n- `Web UI` ä¸­çš„é…ç½®è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  - é…ç½®å¹¶ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š    \n    - ç™»å½• Quay å¹¶å®Œæˆè®¤è¯ï¼š![first-login-config-quay.png](first-login-config-quay.png)    \n    - ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š![config-quay-1.png](config-quay-1.png)![config-quay-2.png](config-quay-2.png)![config-quay-3.png](config-quay-3.png)![config-quay-4.png](config-quay-4.png)![config-quay-5.png](config-quay-5.png)![config-quay-6.png](config-quay-6.png)![config-quay-7.png](config-quay-7.png)![config-quay-8.png](config-quay-8.png)\n- ä¸‹è½½ quay çš„é…ç½®å‹ç¼©æ–‡ä»¶åï¼Œå¯æ‰§è¡Œ `quay-pod-manage deploy` å‘½ä»¤å®Œæˆ Quay çš„éƒ¨ç½²ã€‚\n- è‹¥éƒ¨ç½²å¤±è´¥å¯æ‰§è¡Œ `quay-pod-manage destroy` å‘½ä»¤é”€æ¯ podã€‚\n- è‹¥è¿è¡Œ Quay çš„ quay-master å®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼Œå¯æ‰§è¡Œ `quay-pod-manage recover` å‘½ä»¤æ¢å¤æ•…éšœçš„å®¹å™¨ã€‚\n- ç™»å½•ä¸éªŒè¯ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š  \n  ç”¨æˆ·åï¼š`admin` å¯†ç ï¼š`1qazZSE$`![normal-login-quay.png](normal-login-quay.png)\n- Podman å®¢æˆ·ç«¯ç™»å½• Quayï¼š  \n  ä½¿ç”¨åŸºäº `Docker registry API` çš„ `OCI distribution API` ç™»å½•å¹¶è®¿é—® Quay å®¹å™¨é•œåƒä»“åº“ï¼ŒRed Hat æ¨èä½¿ç”¨åŸºäº RHEL çš„å®¹å™¨å·¥å…·ï¼Œå³ `Podman`ã€`Buildah` ä¸ `Skopeo` æ¥è®¿é—®è¯¥ APIã€‚  \n  ```bash\n  $ sudo mkdir /etc/docker/certs.d/<quay_registry_fqdn>/\n  # åˆ›å»º Podman å®¢æˆ·ç«¯ Quay CA è¯ä¹¦å­˜å‚¨ç›®å½•\n  $ sudo scp root@<quay_registry_fqdn>:/mnt/quay/config/ssl.cert \\\n    /etc/docker/certs.d/<quay_registry_fqdn>/ssl.crt\n  # åŒæ­¥ Quay CA è¯ä¹¦è‡³ Podman å®¢æˆ·ç«¯\n  \n  # su - contsvc\n  $ vim ~/.config/containers/registries.conf\n    unqualified-search-registries = ['<quay_registry_fqdn>']\n    # è¯¥åœ°å€å½¢å¦‚ registry.lab.example.com\n    [[registry]]\n    location = \"<quay_registry_fqdn>\"\n    insecure = true\n    blocked = false\n  # é…ç½®æ™®é€šç”¨æˆ·çš„ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“åœ°å€\n  \n  $ podman login <quay_registry_fqdn> \\\n    --username admin --password 1qazZSE$ \\\n    --log-level=debug\n  # æˆåŠŸç™»å½• Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶å¼€å¯ debug æ¨¡å¼ã€‚\n  ```\n- Docker å®¢æˆ·ç«¯ç™»å½• Quayï¼ˆå¯é€‰ï¼‰ï¼š![docker-client-login-quay-registry.jpg](docker-client-login-quay-registry.jpg)\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [Quay åŸºç¡€ç‰ˆå®‰è£…å’Œéƒ¨ç½²](https://www.cnblogs.com/ericnie/p/12233269.html)\n- [Deploy Project Quay for proof-of-concept (non-production) purposes](https://docs.projectquay.io/deploy_quay.html)\n- [docker.github.io/registry/deploying.md](https://github.com/docker/docker.github.io/blob/master/registry/deploying.md#get-a-certificate)\n- [docker.github.io/registry/insecure.md](https://github.com/docker/docker.github.io/blob/master/registry/insecure.md)","slug":"redhat-quay-v3-registry","published":1,"updated":"2022-12-05T09:31:43.745Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonoly000i16vdoy45as4e","content":"<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“</li>\n<li>Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“</li>\n<li>Red Hat å®¹å™¨é•œåƒå®‰å…¨</li>\n<li>Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\"><a href=\"#å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\" class=\"headerlink\" title=\"å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\"></a>å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š</h3><ul>\n<li>Harbor v1/v2ï¼šç”± <code>VMware</code> ä¸»å¯¼å¼€å‘ï¼Œå¹¶ä» <code>CNCF</code> äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šå­µåŒ–æˆåŠŸã€‚</li>\n<li><strong><code>Red Hat Quay v3</code></strong>ï¼šç”± <code>Red Hat</code> å¼€æºçš„ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œç±»ä¼¼äº <code>CoreOS</code> çš„ Quayã€‚</li>\n<li>registry v2ï¼š<code>Docker</code> å…¬å¸å‘å¸ƒçš„ v2 ç‰ˆæœ¬å®¹å™¨é•œåƒä»“åº“é•œåƒï¼Œå¯ç›´æ¥è¿è¡Œæä¾›æœåŠ¡ã€‚</li>\n<li>docker-distributionï¼šç”± <code>docker-distribution</code> RPM è½¯ä»¶åŒ…æä¾›ï¼Œ<code>systemd</code> æ–¹å¼è¿è¡Œã€‚</li>\n</ul>\n<h3 id=\"Red-Hat-æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\"><a href=\"#Red-Hat-æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\" class=\"headerlink\" title=\"Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\"></a>Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š</h3><ul>\n<li><strong>Red Hat Container Registry</strong>ï¼š<code>registry.access.redhat.com</code>  <ul>\n<li>è¯¥ä»“åº“ä¸ºå…¬å…±é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œæ— éœ€èº«ä»½éªŒè¯ã€‚  </li>\n<li>ä½†è¯·æ³¨æ„ï¼Œè™½ç„¶æ­¤å®¹å™¨é•œåƒä»“åº“æ˜¯å…¬å…±çš„ï¼Œä½† Red Hat çš„å¤§å¤šæ•°å®¹å™¨é•œåƒè§„å®šè¦æ±‚ç”¨æˆ·æ‹¥æœ‰æ¿€æ´»çš„ Red Hat äº§å“è®¢é˜…ï¼Œå¹¶ä¸”ä»–ä»¬éµå®ˆäº§å“çš„ç»ˆç«¯ç”¨æˆ·åè®®ï¼ˆEUAï¼‰ã€‚  </li>\n<li>åªæœ‰åŸºäº Red Hat Enterprise Linux Universal Base Images (<code>UBI</code>) çš„é•œåƒå¯ä»è¯¥é•œåƒä»“åº“ä¸­è‡ªç”±åœ°é‡æ–°å‘å¸ƒã€‚</li>\n</ul>\n</li>\n<li><strong>Red Hat terms-based registry</strong>ï¼š<code>registry.redhat.io</code>  <ul>\n<li>è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œå¹¶ä¸”éœ€è¦èº«ä»½éªŒè¯ã€‚  </li>\n<li>ä»è¯¥ä»“åº“æ‹‰å–é•œåƒæ—¶ï¼Œéœ€æä¾› Red Hat Customer Portal å‡­è¯ï¼ˆcredentialï¼‰è¿›è¡Œèº«ä»½éªŒè¯ã€‚  </li>\n<li>å¯¹äºå…±äº«ç¯å¢ƒï¼Œå¦‚ OpenShift æˆ– CI/CD ç®¡é“ï¼Œå¯åˆ›å»º <code>service account</code> æˆ–èº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä»¥é¿å…æš´éœ²ä¸ªäººå‡­æ®ã€‚</li>\n</ul>\n</li>\n<li><strong>Red Hat partner registry</strong>ï¼š<code>registry.connect.redhat.com</code>  <ul>\n<li>è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡æ¥è‡ªè®¤è¯åˆä½œä¼™ä¼´çš„ç¬¬ä¸‰æ–¹äº§å“çš„é•œåƒã€‚  </li>\n<li>å®ƒè¿˜éœ€æä¾› Red Hat Customer Portal å‡­è¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚  </li>\n<li>å®ƒä»¬å¯èƒ½å—åˆ¶äºåˆä¼™ä¼™ä¼´çš„è®¤è´­æˆ–è®¸å¯ã€‚</li>\n</ul>\n</li>\n<li><strong>Quay.io</strong>ï¼š  <ul>\n<li>Red Hat è¿˜ç®¡ç† <code>Quay.io</code> å®¹å™¨é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œä¸€ä¸ªå…è´¹å¸æˆ·ï¼Œå¹¶å‘å¸ƒè‡ªå·±çš„å®¹å™¨é•œåƒã€‚  </li>\n<li>Red Hat å¯¹ä»»ä½•æ‰˜ç®¡åœ¨ Quay.io ä¸Šçš„å®¹å™¨é•œåƒéƒ½æ²¡æœ‰æä¾›ä¿è¯ã€‚  </li>\n<li>å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ Quay.io ä½œä¸ºä¸€ä¸ªå…¬å…±é•œåƒä»“åº“ï¼Œä½†æ˜¯ç»„ç»‡ï¼ˆorganizationï¼‰ä¹Ÿå¯ä»¥è´­ä¹°å…è®¸ä½¿ç”¨ Quay.io ä½œä¸ºç§æœ‰é•œåƒä»“åº“ã€‚<blockquote>\n<p>ğŸ‘‰ å…³äº Red Hat å®¹å™¨é•œåƒä»“åº“çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://access.redhat.com/RegistryAuthentication\" target=\"_blank\" rel=\"noopener\">Red Hat Container Registry Authentication</a></p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Red-Hat-å®¹å™¨é•œåƒå®‰å…¨ï¼š\"><a href=\"#Red-Hat-å®¹å™¨é•œåƒå®‰å…¨ï¼š\" class=\"headerlink\" title=\"Red Hat å®¹å™¨é•œåƒå®‰å…¨ï¼š\"></a>Red Hat å®¹å™¨é•œåƒå®‰å…¨ï¼š</h3><ul>\n<li><a href=\"https://catalog.redhat.com/software/containers/search\" target=\"_blank\" rel=\"noopener\">Red Hat Container Catalog</a>ï¼ˆRHCCï¼‰å¯æä¾›æ„å»º S2I æ„å»ºé•œåƒçš„åŸºç¡€å®¹å™¨é•œåƒï¼Œä¹Ÿå¯ç›´æ¥æä¾› S2I æ„å»ºé•œåƒï¼ŒRed Hat Container Catalog é€šè¿‡ <code>https://registry.redhat.io</code> ä½œä¸ºå®¹å™¨é•œåƒæ‹‰å–ä¸æ¨é€çš„ portalã€‚</li>\n<li>è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒé€šè¿‡ <code>Container Health Index</code> è¿›è¡Œå®‰å…¨æ€§è¯„ä¼°ï¼Œå¯æ ¹æ®ä¸åŒçš„è¯„ä¼°ç»“æœé€‰å–å¼€å‘è€…æ‰€éœ€è¦çš„é•œåƒï¼Œä¸€èˆ¬é€‰æ‹©å®‰å…¨ç­‰çº§ä¸º <code>A</code> æˆ– <code>B</code> çš„é•œåƒï¼Œä»¥ä¸‹ä»¥ <code>Go Toolset</code> é•œåƒä¸ºä¾‹ç¡®å®šå…¶å®‰å…¨ç­‰çº§ï¼š<img src=\"go-toolset-catalog.jpg\" alt=\"go-toolset-catalog.jpg\"></li>\n<li>å…³äº <a href=\"https://access.redhat.com/articles/2803031\" target=\"_blank\" rel=\"noopener\">Red Hat å®¹å™¨é•œåƒå®‰å…¨ç­‰çº§è¯´æ˜</a>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"catalog-health-index.jpg\" alt=\"catalog-health-index.jpg\"><ul>\n<li>Red Hat å®‰å…¨è¯„çº§è¯´æ˜æ–‡æ¡£å¯å‚è€ƒ <a href=\"https://access.redhat.com/security/updates/classification\" target=\"_blank\" rel=\"noopener\">Understanding Red Hat security ratings</a></li>\n</ul>\n</li>\n<li>å®¹å™¨é•œåƒçš„å®‰å…¨è¯„åˆ†ä¸åˆ†çº§å¯å‚è€ƒ <a href=\"https://access.redhat.com/blogs/product-security/posts/container-security-scoring\" target=\"_blank\" rel=\"noopener\">Security Scoring and Grading for Container Images</a></li>\n</ul>\n<h3 id=\"Red-Hat-Quay-v3-ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\"><a href=\"#Red-Hat-Quay-v3-ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\" class=\"headerlink\" title=\"Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\"></a>Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š</h3><ul>\n<li>Red Hat Quay å®¹å™¨é•œåƒä»“åº“çš„é«˜çº§ç‰¹æ€§ï¼š  <ul>\n<li>é•œåƒå®‰å…¨æ‰«æï¼ˆimage security scanningï¼‰  </li>\n<li>åŸºäºè§’è‰²çš„è®¿é—®ï¼ˆrole-based accessï¼‰  </li>\n<li>ç»„ç»‡ä¸å›¢é˜Ÿç®¡ç†ï¼ˆorganization and team managementï¼‰  </li>\n<li>é•œåƒè‡ªåŠ¨åŒ–æ„å»ºï¼ˆimage build automationï¼‰  </li>\n<li>å®¡è®¡ï¼ˆauditingï¼‰  </li>\n<li>å¼‚åœ°å¤åˆ¶ï¼ˆgeo-replicationï¼‰  </li>\n<li>é«˜å¯ç”¨ï¼ˆhigh availabilityï¼‰</li>\n</ul>\n</li>\n<li>è¯¥æ–‡æ¡£ä½¿ç”¨ <code>basic</code> æ–¹å¼å®¹å™¨éƒ¨ç½²ï¼Œé <strong><code>HA</code></strong> æ–¹å¼ã€‚</li>\n<li>Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“ç»„ä»¶ï¼š  <ul>\n<li><code>Database</code>ï¼šMySQL æˆ– PostgreSQL æ•°æ®åº“ï¼Œä¸»è¦å­˜å‚¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè€Œéé•œåƒå­˜å‚¨ã€‚  </li>\n<li><code>Redis</code>ï¼šé”®å€¼å‹å­˜å‚¨ï¼Œå­˜å‚¨å®æ—¶æ„å»ºæ—¥å¿—ä¸ Quay çš„å‘å¯¼ã€‚  </li>\n<li><code>Quay</code>ï¼šå®¹å™¨é•œåƒä»“åº“ï¼Œä¸»è¦è¿è¡Œ quay å®¹å™¨æœåŠ¡ï¼Œè¯¥æœåŠ¡ç”±å¤šä¸ªç»„ä»¶ç»„æˆã€‚  </li>\n<li><strong><code>Clair</code></strong>ï¼šé™æ€å®¹å™¨é•œåƒæ‰«æå·¥å…·ï¼Œå¯è¯†åˆ«å®‰å…¨éšæ‚£ä¸ä¿®å¤é—®é¢˜ï¼ˆfixesï¼‰ã€‚</li>\n</ul>\n</li>\n<li>éƒ¨ç½²çš„å®¹å™¨é•œåƒä¸ç‰ˆæœ¬ï¼š  <ul>\n<li>MySQLï¼š<a href=\"http://registry.access.redhat.com/rhscl/mysql-57-rhel7:latest\" target=\"_blank\" rel=\"noopener\">registry.access.redhat.com/rhscl/mysql-57-rhel7:latest</a>  </li>\n<li>Redisï¼š<a href=\"http://registry.assess.redhat.com/rhscl/redis-32-rhel7:latest\" target=\"_blank\" rel=\"noopener\">registry.assess.redhat.com/rhscl/redis-32-rhel7:latest</a>  </li>\n<li>Quayï¼šquay.io/redhat/quay:v3.3.0<blockquote>\n<p><strong>æ³¨æ„</strong>ï¼šæ‹‰å–è¯¥å®¹å™¨é•œåƒå‰å¿…é¡»å…ˆä½¿ç”¨ç›¸åº”è´¦å·ç™»å½• Quayï¼Œå¦‚ä¸‹è„šæœ¬æ‰€ç¤ºã€‚</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>ä½¿ç”¨ <code>docker</code> è¿è¡Œå„ä¸ªå•å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· <a href=\"https://github.com/Alberthua-Perl/summary-scripts/blob/master/shell-examples/deploy-quay-registry.sh\" target=\"_blank\" rel=\"noopener\">å‚è€ƒæ­¤å¤„</a>ã€‚</li>\n<li>ğŸš€ æ¨èï¼š<br>ä½¿ç”¨ <code>podman</code> è¿è¡Œå• <code>pod</code> é›†æˆä»¥ä¸Šæ‰€æœ‰å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/quay-pod-manage.sh\" target=\"_blank\" rel=\"noopener\">å‚è€ƒæ­¤å¤„</a>ï¼ˆæœªé›†æˆ Clairï¼‰ã€‚<br>è¯¥æ–¹å¼ä¸­ quay-aio pod å°†æ‰€æœ‰å®¹å™¨é™åˆ¶åœ¨åŒä¸€ <code>network namespace</code> ä¸­ï¼ŒQuay çš„é…ç½®ã€éƒ¨ç½²ä¸è®¿é—®æ¶‰åŠä¼—å¤šç«¯å£ï¼Œä½¿ç”¨å•å®¹å™¨è¿è¡Œäºå®¿ä¸»æœºä¸Šå°†ç”Ÿæˆå¤šæ¡ iptables <code>filter</code> ä¸ <code>nat</code> è¡¨è§„åˆ™ï¼Œè€Œé›†æˆåœ¨å• pod ä¸­æ›´åŠ ä¾¿äºç®¡ç†ã€‚</li>\n<li>ä»¥ç¬¬äºŒç§æ–¹å¼ä¸ºä¾‹ï¼Œé¦–å…ˆæ‰§è¡Œ <code>quay-pod-manage config</code> å‘½ä»¤ï¼Œå†è¿›è¡Œä»¥ä¸‹é…ç½®ã€‚</li>\n<li>éƒ¨ç½²å‰é¦–æ¬¡é…ç½® Quay æ—¶ï¼Œéœ€é€šè¿‡ Web é¡µé¢å°† Quay ä¸ MySQL å¯¹æ¥ï¼ŒæŒ‡å®šä»“åº“ FQDN åŠå¯¹æ¥çš„ Redis æ•°æ®åº“åœ°å€ï¼Œè‹¥ä½¿ç”¨ pod æ–¹å¼éƒ¨ç½²ï¼Œå…¶åœ°å€å³ä¸º pod æ‰€åœ¨ <code>network namespace</code> çš„ ip åœ°å€ï¼Œå¹¶æœ€ç»ˆä¸‹è½½ quay çš„ <code>.tar.gz</code> é…ç½®æ–‡ä»¶ã€‚</li>\n<li>è¿è¡Œä»¥ä¸Šå‘½ä»¤å¯èƒ½å‡ºç°çš„æŠ¥é”™ï¼ˆç°å·²è§£å†³ï¼‰ï¼š  <ul>\n<li>æŠ¥é”™ 1ï¼šç”±äº <code>/mnt/quay/config/ssl.key</code> æƒé™é—®é¢˜å¯¼è‡´æ— æ³•å¯åŠ¨ quay-master å®¹å™¨ï¼Œæ›´æ”¹å…¶æƒé™ä¸º <code>0644</code> å³å¯ã€‚<img src=\"ssl-key-permission-run-quay-error.jpg\" alt=\"ssl-key-permission-run-quay-error.jpg\"></li>\n<li>æŠ¥é”™ 2ï¼šç”±äº <code>/mnt/quay/storage/</code> æ‰€æœ‰è€…é—®é¢˜å¯¼è‡´æ— æ³•ä»å®¢æˆ·ç«¯æ¨é€å®¹å™¨é•œåƒè‡³é•œåƒä»“åº“ä¸­ï¼Œæ›´æ”¹ç›®å½•çš„æ‰€æœ‰è€…ä¸º <code>1001</code> å³å¯ï¼Œè¯¥ç”¨æˆ·ä¸º quay-master å®¹å™¨ä¸­ä¸»è¿›ç¨‹çš„è¿è¡Œç”¨æˆ·ï¼Œå¿…é¡»å¯¹å®¿ä¸»æœºæ˜ å°„çš„ç›®å½•å…·æœ‰å†™æƒé™ã€‚<img src=\"podman-push-quay-permission-denied-1001-1.jpg\" alt=\"podman-push-quay-permission-denied-1001-1.jpg\"><img src=\"podman-push-quay-permission-denied-1001-2.jpg\" alt=\"podman-push-quay-permission-denied-1001-2.jpg\"></li>\n</ul>\n</li>\n<li><code>Web UI</code> ä¸­çš„é…ç½®è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  <ul>\n<li>é…ç½®å¹¶ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š    <ul>\n<li>ç™»å½• Quay å¹¶å®Œæˆè®¤è¯ï¼š<img src=\"first-login-config-quay.png\" alt=\"first-login-config-quay.png\">    </li>\n<li>ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š<img src=\"config-quay-1.png\" alt=\"config-quay-1.png\"><img src=\"config-quay-2.png\" alt=\"config-quay-2.png\"><img src=\"config-quay-3.png\" alt=\"config-quay-3.png\"><img src=\"config-quay-4.png\" alt=\"config-quay-4.png\"><img src=\"config-quay-5.png\" alt=\"config-quay-5.png\"><img src=\"config-quay-6.png\" alt=\"config-quay-6.png\"><img src=\"config-quay-7.png\" alt=\"config-quay-7.png\"><img src=\"config-quay-8.png\" alt=\"config-quay-8.png\"></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ä¸‹è½½ quay çš„é…ç½®å‹ç¼©æ–‡ä»¶åï¼Œå¯æ‰§è¡Œ <code>quay-pod-manage deploy</code> å‘½ä»¤å®Œæˆ Quay çš„éƒ¨ç½²ã€‚</li>\n<li>è‹¥éƒ¨ç½²å¤±è´¥å¯æ‰§è¡Œ <code>quay-pod-manage destroy</code> å‘½ä»¤é”€æ¯ podã€‚</li>\n<li>è‹¥è¿è¡Œ Quay çš„ quay-master å®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼Œå¯æ‰§è¡Œ <code>quay-pod-manage recover</code> å‘½ä»¤æ¢å¤æ•…éšœçš„å®¹å™¨ã€‚</li>\n<li>ç™»å½•ä¸éªŒè¯ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š<br>ç”¨æˆ·åï¼š<code>admin</code> å¯†ç ï¼š<code>1qazZSE$</code><img src=\"normal-login-quay.png\" alt=\"normal-login-quay.png\"></li>\n<li><p>Podman å®¢æˆ·ç«¯ç™»å½• Quayï¼š<br>ä½¿ç”¨åŸºäº <code>Docker registry API</code> çš„ <code>OCI distribution API</code> ç™»å½•å¹¶è®¿é—® Quay å®¹å™¨é•œåƒä»“åº“ï¼ŒRed Hat æ¨èä½¿ç”¨åŸºäº RHEL çš„å®¹å™¨å·¥å…·ï¼Œå³ <code>Podman</code>ã€<code>Buildah</code> ä¸ <code>Skopeo</code> æ¥è®¿é—®è¯¥ APIã€‚  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo mkdir /etc/docker/certs.d/&lt;quay_registry_fqdn&gt;/</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Podman å®¢æˆ·ç«¯ Quay CA è¯ä¹¦å­˜å‚¨ç›®å½•</span></span><br><span class=\"line\">$ sudo scp root@&lt;quay_registry_fqdn&gt;:/mnt/quay/config/ssl.cert \\</span><br><span class=\"line\">  /etc/docker/certs.d/&lt;quay_registry_fqdn&gt;/ssl.crt</span><br><span class=\"line\"><span class=\"comment\"># åŒæ­¥ Quay CA è¯ä¹¦è‡³ Podman å®¢æˆ·ç«¯</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># su - contsvc</span></span><br><span class=\"line\">$ vim ~/.config/containers/registries.conf</span><br><span class=\"line\">  unqualified-search-registries = [<span class=\"string\">'&lt;quay_registry_fqdn&gt;'</span>]</span><br><span class=\"line\">  <span class=\"comment\"># è¯¥åœ°å€å½¢å¦‚ registry.lab.example.com</span></span><br><span class=\"line\">  [[registry]]</span><br><span class=\"line\">  location = <span class=\"string\">\"&lt;quay_registry_fqdn&gt;\"</span></span><br><span class=\"line\">  insecure = <span class=\"literal\">true</span></span><br><span class=\"line\">  blocked = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®æ™®é€šç”¨æˆ·çš„ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“åœ°å€</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ podman login &lt;quay_registry_fqdn&gt; \\</span><br><span class=\"line\">  --username admin --password 1qazZSE$ \\</span><br><span class=\"line\">  --<span class=\"built_in\">log</span>-level=debug</span><br><span class=\"line\"><span class=\"comment\"># æˆåŠŸç™»å½• Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶å¼€å¯ debug æ¨¡å¼ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Docker å®¢æˆ·ç«¯ç™»å½• Quayï¼ˆå¯é€‰ï¼‰ï¼š<img src=\"docker-client-login-quay-registry.jpg\" alt=\"docker-client-login-quay-registry.jpg\"></p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://www.cnblogs.com/ericnie/p/12233269.html\" target=\"_blank\" rel=\"noopener\">Quay åŸºç¡€ç‰ˆå®‰è£…å’Œéƒ¨ç½²</a></li>\n<li><a href=\"https://docs.projectquay.io/deploy_quay.html\" target=\"_blank\" rel=\"noopener\">Deploy Project Quay for proof-of-concept (non-production) purposes</a></li>\n<li><a href=\"https://github.com/docker/docker.github.io/blob/master/registry/deploying.md#get-a-certificate\" target=\"_blank\" rel=\"noopener\">docker.github.io/registry/deploying.md</a></li>\n<li><a href=\"https://github.com/docker/docker.github.io/blob/master/registry/insecure.md\" target=\"_blank\" rel=\"noopener\">docker.github.io/registry/insecure.md</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“</li>\n<li>Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“</li>\n<li>Red Hat å®¹å™¨é•œåƒå®‰å…¨</li>\n<li>Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\"><a href=\"#å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\" class=\"headerlink\" title=\"å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š\"></a>å¸¸ç”¨ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š</h3><ul>\n<li>Harbor v1/v2ï¼šç”± <code>VMware</code> ä¸»å¯¼å¼€å‘ï¼Œå¹¶ä» <code>CNCF</code> äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šå­µåŒ–æˆåŠŸã€‚</li>\n<li><strong><code>Red Hat Quay v3</code></strong>ï¼šç”± <code>Red Hat</code> å¼€æºçš„ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œç±»ä¼¼äº <code>CoreOS</code> çš„ Quayã€‚</li>\n<li>registry v2ï¼š<code>Docker</code> å…¬å¸å‘å¸ƒçš„ v2 ç‰ˆæœ¬å®¹å™¨é•œåƒä»“åº“é•œåƒï¼Œå¯ç›´æ¥è¿è¡Œæä¾›æœåŠ¡ã€‚</li>\n<li>docker-distributionï¼šç”± <code>docker-distribution</code> RPM è½¯ä»¶åŒ…æä¾›ï¼Œ<code>systemd</code> æ–¹å¼è¿è¡Œã€‚</li>\n</ul>\n<h3 id=\"Red-Hat-æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\"><a href=\"#Red-Hat-æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\" class=\"headerlink\" title=\"Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š\"></a>Red Hat æ”¯æŒçš„å®¹å™¨é•œåƒä»“åº“ï¼š</h3><ul>\n<li><strong>Red Hat Container Registry</strong>ï¼š<code>registry.access.redhat.com</code>  <ul>\n<li>è¯¥ä»“åº“ä¸ºå…¬å…±é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œæ— éœ€èº«ä»½éªŒè¯ã€‚  </li>\n<li>ä½†è¯·æ³¨æ„ï¼Œè™½ç„¶æ­¤å®¹å™¨é•œåƒä»“åº“æ˜¯å…¬å…±çš„ï¼Œä½† Red Hat çš„å¤§å¤šæ•°å®¹å™¨é•œåƒè§„å®šè¦æ±‚ç”¨æˆ·æ‹¥æœ‰æ¿€æ´»çš„ Red Hat äº§å“è®¢é˜…ï¼Œå¹¶ä¸”ä»–ä»¬éµå®ˆäº§å“çš„ç»ˆç«¯ç”¨æˆ·åè®®ï¼ˆEUAï¼‰ã€‚  </li>\n<li>åªæœ‰åŸºäº Red Hat Enterprise Linux Universal Base Images (<code>UBI</code>) çš„é•œåƒå¯ä»è¯¥é•œåƒä»“åº“ä¸­è‡ªç”±åœ°é‡æ–°å‘å¸ƒã€‚</li>\n</ul>\n</li>\n<li><strong>Red Hat terms-based registry</strong>ï¼š<code>registry.redhat.io</code>  <ul>\n<li>è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡ Red Hat äº§å“çš„é•œåƒï¼Œå¹¶ä¸”éœ€è¦èº«ä»½éªŒè¯ã€‚  </li>\n<li>ä»è¯¥ä»“åº“æ‹‰å–é•œåƒæ—¶ï¼Œéœ€æä¾› Red Hat Customer Portal å‡­è¯ï¼ˆcredentialï¼‰è¿›è¡Œèº«ä»½éªŒè¯ã€‚  </li>\n<li>å¯¹äºå…±äº«ç¯å¢ƒï¼Œå¦‚ OpenShift æˆ– CI/CD ç®¡é“ï¼Œå¯åˆ›å»º <code>service account</code> æˆ–èº«ä»½éªŒè¯ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œä»¥é¿å…æš´éœ²ä¸ªäººå‡­æ®ã€‚</li>\n</ul>\n</li>\n<li><strong>Red Hat partner registry</strong>ï¼š<code>registry.connect.redhat.com</code>  <ul>\n<li>è¯¥ä»“åº“ä¸ºç§æœ‰é•œåƒä»“åº“ï¼Œç”¨äºæ‰˜ç®¡æ¥è‡ªè®¤è¯åˆä½œä¼™ä¼´çš„ç¬¬ä¸‰æ–¹äº§å“çš„é•œåƒã€‚  </li>\n<li>å®ƒè¿˜éœ€æä¾› Red Hat Customer Portal å‡­è¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚  </li>\n<li>å®ƒä»¬å¯èƒ½å—åˆ¶äºåˆä¼™ä¼™ä¼´çš„è®¤è´­æˆ–è®¸å¯ã€‚</li>\n</ul>\n</li>\n<li><strong>Quay.io</strong>ï¼š  <ul>\n<li>Red Hat è¿˜ç®¡ç† <code>Quay.io</code> å®¹å™¨é•œåƒä»“åº“ï¼Œä»»ä½•äººéƒ½å¯ä»¥æ³¨å†Œä¸€ä¸ªå…è´¹å¸æˆ·ï¼Œå¹¶å‘å¸ƒè‡ªå·±çš„å®¹å™¨é•œåƒã€‚  </li>\n<li>Red Hat å¯¹ä»»ä½•æ‰˜ç®¡åœ¨ Quay.io ä¸Šçš„å®¹å™¨é•œåƒéƒ½æ²¡æœ‰æä¾›ä¿è¯ã€‚  </li>\n<li>å¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ Quay.io ä½œä¸ºä¸€ä¸ªå…¬å…±é•œåƒä»“åº“ï¼Œä½†æ˜¯ç»„ç»‡ï¼ˆorganizationï¼‰ä¹Ÿå¯ä»¥è´­ä¹°å…è®¸ä½¿ç”¨ Quay.io ä½œä¸ºç§æœ‰é•œåƒä»“åº“ã€‚<blockquote>\n<p>ğŸ‘‰ å…³äº Red Hat å®¹å™¨é•œåƒä»“åº“çš„è¯´æ˜å¯å‚è€ƒ <a href=\"https://access.redhat.com/RegistryAuthentication\" target=\"_blank\" rel=\"noopener\">Red Hat Container Registry Authentication</a></p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Red-Hat-å®¹å™¨é•œåƒå®‰å…¨ï¼š\"><a href=\"#Red-Hat-å®¹å™¨é•œåƒå®‰å…¨ï¼š\" class=\"headerlink\" title=\"Red Hat å®¹å™¨é•œåƒå®‰å…¨ï¼š\"></a>Red Hat å®¹å™¨é•œåƒå®‰å…¨ï¼š</h3><ul>\n<li><a href=\"https://catalog.redhat.com/software/containers/search\" target=\"_blank\" rel=\"noopener\">Red Hat Container Catalog</a>ï¼ˆRHCCï¼‰å¯æä¾›æ„å»º S2I æ„å»ºé•œåƒçš„åŸºç¡€å®¹å™¨é•œåƒï¼Œä¹Ÿå¯ç›´æ¥æä¾› S2I æ„å»ºé•œåƒï¼ŒRed Hat Container Catalog é€šè¿‡ <code>https://registry.redhat.io</code> ä½œä¸ºå®¹å™¨é•œåƒæ‹‰å–ä¸æ¨é€çš„ portalã€‚</li>\n<li>è¯¥å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒé€šè¿‡ <code>Container Health Index</code> è¿›è¡Œå®‰å…¨æ€§è¯„ä¼°ï¼Œå¯æ ¹æ®ä¸åŒçš„è¯„ä¼°ç»“æœé€‰å–å¼€å‘è€…æ‰€éœ€è¦çš„é•œåƒï¼Œä¸€èˆ¬é€‰æ‹©å®‰å…¨ç­‰çº§ä¸º <code>A</code> æˆ– <code>B</code> çš„é•œåƒï¼Œä»¥ä¸‹ä»¥ <code>Go Toolset</code> é•œåƒä¸ºä¾‹ç¡®å®šå…¶å®‰å…¨ç­‰çº§ï¼š<img src=\"go-toolset-catalog.jpg\" alt=\"go-toolset-catalog.jpg\"></li>\n<li>å…³äº <a href=\"https://access.redhat.com/articles/2803031\" target=\"_blank\" rel=\"noopener\">Red Hat å®¹å™¨é•œåƒå®‰å…¨ç­‰çº§è¯´æ˜</a>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"catalog-health-index.jpg\" alt=\"catalog-health-index.jpg\"><ul>\n<li>Red Hat å®‰å…¨è¯„çº§è¯´æ˜æ–‡æ¡£å¯å‚è€ƒ <a href=\"https://access.redhat.com/security/updates/classification\" target=\"_blank\" rel=\"noopener\">Understanding Red Hat security ratings</a></li>\n</ul>\n</li>\n<li>å®¹å™¨é•œåƒçš„å®‰å…¨è¯„åˆ†ä¸åˆ†çº§å¯å‚è€ƒ <a href=\"https://access.redhat.com/blogs/product-security/posts/container-security-scoring\" target=\"_blank\" rel=\"noopener\">Security Scoring and Grading for Container Images</a></li>\n</ul>\n<h3 id=\"Red-Hat-Quay-v3-ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\"><a href=\"#Red-Hat-Quay-v3-ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\" class=\"headerlink\" title=\"Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š\"></a>Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“éƒ¨ç½²ï¼š</h3><ul>\n<li>Red Hat Quay å®¹å™¨é•œåƒä»“åº“çš„é«˜çº§ç‰¹æ€§ï¼š  <ul>\n<li>é•œåƒå®‰å…¨æ‰«æï¼ˆimage security scanningï¼‰  </li>\n<li>åŸºäºè§’è‰²çš„è®¿é—®ï¼ˆrole-based accessï¼‰  </li>\n<li>ç»„ç»‡ä¸å›¢é˜Ÿç®¡ç†ï¼ˆorganization and team managementï¼‰  </li>\n<li>é•œåƒè‡ªåŠ¨åŒ–æ„å»ºï¼ˆimage build automationï¼‰  </li>\n<li>å®¡è®¡ï¼ˆauditingï¼‰  </li>\n<li>å¼‚åœ°å¤åˆ¶ï¼ˆgeo-replicationï¼‰  </li>\n<li>é«˜å¯ç”¨ï¼ˆhigh availabilityï¼‰</li>\n</ul>\n</li>\n<li>è¯¥æ–‡æ¡£ä½¿ç”¨ <code>basic</code> æ–¹å¼å®¹å™¨éƒ¨ç½²ï¼Œé <strong><code>HA</code></strong> æ–¹å¼ã€‚</li>\n<li>Red Hat Quay v3 ç§æœ‰å®¹å™¨é•œåƒä»“åº“ç»„ä»¶ï¼š  <ul>\n<li><code>Database</code>ï¼šMySQL æˆ– PostgreSQL æ•°æ®åº“ï¼Œä¸»è¦å­˜å‚¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œè€Œéé•œåƒå­˜å‚¨ã€‚  </li>\n<li><code>Redis</code>ï¼šé”®å€¼å‹å­˜å‚¨ï¼Œå­˜å‚¨å®æ—¶æ„å»ºæ—¥å¿—ä¸ Quay çš„å‘å¯¼ã€‚  </li>\n<li><code>Quay</code>ï¼šå®¹å™¨é•œåƒä»“åº“ï¼Œä¸»è¦è¿è¡Œ quay å®¹å™¨æœåŠ¡ï¼Œè¯¥æœåŠ¡ç”±å¤šä¸ªç»„ä»¶ç»„æˆã€‚  </li>\n<li><strong><code>Clair</code></strong>ï¼šé™æ€å®¹å™¨é•œåƒæ‰«æå·¥å…·ï¼Œå¯è¯†åˆ«å®‰å…¨éšæ‚£ä¸ä¿®å¤é—®é¢˜ï¼ˆfixesï¼‰ã€‚</li>\n</ul>\n</li>\n<li>éƒ¨ç½²çš„å®¹å™¨é•œåƒä¸ç‰ˆæœ¬ï¼š  <ul>\n<li>MySQLï¼š<a href=\"http://registry.access.redhat.com/rhscl/mysql-57-rhel7:latest\" target=\"_blank\" rel=\"noopener\">registry.access.redhat.com/rhscl/mysql-57-rhel7:latest</a>  </li>\n<li>Redisï¼š<a href=\"http://registry.assess.redhat.com/rhscl/redis-32-rhel7:latest\" target=\"_blank\" rel=\"noopener\">registry.assess.redhat.com/rhscl/redis-32-rhel7:latest</a>  </li>\n<li>Quayï¼šquay.io/redhat/quay:v3.3.0<blockquote>\n<p><strong>æ³¨æ„</strong>ï¼šæ‹‰å–è¯¥å®¹å™¨é•œåƒå‰å¿…é¡»å…ˆä½¿ç”¨ç›¸åº”è´¦å·ç™»å½• Quayï¼Œå¦‚ä¸‹è„šæœ¬æ‰€ç¤ºã€‚</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>ä½¿ç”¨ <code>docker</code> è¿è¡Œå„ä¸ªå•å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· <a href=\"https://github.com/Alberthua-Perl/summary-scripts/blob/master/shell-examples/deploy-quay-registry.sh\" target=\"_blank\" rel=\"noopener\">å‚è€ƒæ­¤å¤„</a>ã€‚</li>\n<li>ğŸš€ æ¨èï¼š<br>ä½¿ç”¨ <code>podman</code> è¿è¡Œå• <code>pod</code> é›†æˆä»¥ä¸Šæ‰€æœ‰å®¹å™¨æ–¹å¼çš„éƒ¨ç½²è„šæœ¬è¯· <a href=\"https://github.com/Alberthua-Perl/scripts-confs/blob/master/shell-examples/quay-pod-manage.sh\" target=\"_blank\" rel=\"noopener\">å‚è€ƒæ­¤å¤„</a>ï¼ˆæœªé›†æˆ Clairï¼‰ã€‚<br>è¯¥æ–¹å¼ä¸­ quay-aio pod å°†æ‰€æœ‰å®¹å™¨é™åˆ¶åœ¨åŒä¸€ <code>network namespace</code> ä¸­ï¼ŒQuay çš„é…ç½®ã€éƒ¨ç½²ä¸è®¿é—®æ¶‰åŠä¼—å¤šç«¯å£ï¼Œä½¿ç”¨å•å®¹å™¨è¿è¡Œäºå®¿ä¸»æœºä¸Šå°†ç”Ÿæˆå¤šæ¡ iptables <code>filter</code> ä¸ <code>nat</code> è¡¨è§„åˆ™ï¼Œè€Œé›†æˆåœ¨å• pod ä¸­æ›´åŠ ä¾¿äºç®¡ç†ã€‚</li>\n<li>ä»¥ç¬¬äºŒç§æ–¹å¼ä¸ºä¾‹ï¼Œé¦–å…ˆæ‰§è¡Œ <code>quay-pod-manage config</code> å‘½ä»¤ï¼Œå†è¿›è¡Œä»¥ä¸‹é…ç½®ã€‚</li>\n<li>éƒ¨ç½²å‰é¦–æ¬¡é…ç½® Quay æ—¶ï¼Œéœ€é€šè¿‡ Web é¡µé¢å°† Quay ä¸ MySQL å¯¹æ¥ï¼ŒæŒ‡å®šä»“åº“ FQDN åŠå¯¹æ¥çš„ Redis æ•°æ®åº“åœ°å€ï¼Œè‹¥ä½¿ç”¨ pod æ–¹å¼éƒ¨ç½²ï¼Œå…¶åœ°å€å³ä¸º pod æ‰€åœ¨ <code>network namespace</code> çš„ ip åœ°å€ï¼Œå¹¶æœ€ç»ˆä¸‹è½½ quay çš„ <code>.tar.gz</code> é…ç½®æ–‡ä»¶ã€‚</li>\n<li>è¿è¡Œä»¥ä¸Šå‘½ä»¤å¯èƒ½å‡ºç°çš„æŠ¥é”™ï¼ˆç°å·²è§£å†³ï¼‰ï¼š  <ul>\n<li>æŠ¥é”™ 1ï¼šç”±äº <code>/mnt/quay/config/ssl.key</code> æƒé™é—®é¢˜å¯¼è‡´æ— æ³•å¯åŠ¨ quay-master å®¹å™¨ï¼Œæ›´æ”¹å…¶æƒé™ä¸º <code>0644</code> å³å¯ã€‚<img src=\"ssl-key-permission-run-quay-error.jpg\" alt=\"ssl-key-permission-run-quay-error.jpg\"></li>\n<li>æŠ¥é”™ 2ï¼šç”±äº <code>/mnt/quay/storage/</code> æ‰€æœ‰è€…é—®é¢˜å¯¼è‡´æ— æ³•ä»å®¢æˆ·ç«¯æ¨é€å®¹å™¨é•œåƒè‡³é•œåƒä»“åº“ä¸­ï¼Œæ›´æ”¹ç›®å½•çš„æ‰€æœ‰è€…ä¸º <code>1001</code> å³å¯ï¼Œè¯¥ç”¨æˆ·ä¸º quay-master å®¹å™¨ä¸­ä¸»è¿›ç¨‹çš„è¿è¡Œç”¨æˆ·ï¼Œå¿…é¡»å¯¹å®¿ä¸»æœºæ˜ å°„çš„ç›®å½•å…·æœ‰å†™æƒé™ã€‚<img src=\"podman-push-quay-permission-denied-1001-1.jpg\" alt=\"podman-push-quay-permission-denied-1001-1.jpg\"><img src=\"podman-push-quay-permission-denied-1001-2.jpg\" alt=\"podman-push-quay-permission-denied-1001-2.jpg\"></li>\n</ul>\n</li>\n<li><code>Web UI</code> ä¸­çš„é…ç½®è¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  <ul>\n<li>é…ç½®å¹¶ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š    <ul>\n<li>ç™»å½• Quay å¹¶å®Œæˆè®¤è¯ï¼š<img src=\"first-login-config-quay.png\" alt=\"first-login-config-quay.png\">    </li>\n<li>ç”Ÿæˆ Quay é…ç½®æ–‡ä»¶ï¼š<img src=\"config-quay-1.png\" alt=\"config-quay-1.png\"><img src=\"config-quay-2.png\" alt=\"config-quay-2.png\"><img src=\"config-quay-3.png\" alt=\"config-quay-3.png\"><img src=\"config-quay-4.png\" alt=\"config-quay-4.png\"><img src=\"config-quay-5.png\" alt=\"config-quay-5.png\"><img src=\"config-quay-6.png\" alt=\"config-quay-6.png\"><img src=\"config-quay-7.png\" alt=\"config-quay-7.png\"><img src=\"config-quay-8.png\" alt=\"config-quay-8.png\"></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>ä¸‹è½½ quay çš„é…ç½®å‹ç¼©æ–‡ä»¶åï¼Œå¯æ‰§è¡Œ <code>quay-pod-manage deploy</code> å‘½ä»¤å®Œæˆ Quay çš„éƒ¨ç½²ã€‚</li>\n<li>è‹¥éƒ¨ç½²å¤±è´¥å¯æ‰§è¡Œ <code>quay-pod-manage destroy</code> å‘½ä»¤é”€æ¯ podã€‚</li>\n<li>è‹¥è¿è¡Œ Quay çš„ quay-master å®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼Œå¯æ‰§è¡Œ <code>quay-pod-manage recover</code> å‘½ä»¤æ¢å¤æ•…éšœçš„å®¹å™¨ã€‚</li>\n<li>ç™»å½•ä¸éªŒè¯ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼š<br>ç”¨æˆ·åï¼š<code>admin</code> å¯†ç ï¼š<code>1qazZSE$</code><img src=\"normal-login-quay.png\" alt=\"normal-login-quay.png\"></li>\n<li><p>Podman å®¢æˆ·ç«¯ç™»å½• Quayï¼š<br>ä½¿ç”¨åŸºäº <code>Docker registry API</code> çš„ <code>OCI distribution API</code> ç™»å½•å¹¶è®¿é—® Quay å®¹å™¨é•œåƒä»“åº“ï¼ŒRed Hat æ¨èä½¿ç”¨åŸºäº RHEL çš„å®¹å™¨å·¥å…·ï¼Œå³ <code>Podman</code>ã€<code>Buildah</code> ä¸ <code>Skopeo</code> æ¥è®¿é—®è¯¥ APIã€‚  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sudo mkdir /etc/docker/certs.d/&lt;quay_registry_fqdn&gt;/</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»º Podman å®¢æˆ·ç«¯ Quay CA è¯ä¹¦å­˜å‚¨ç›®å½•</span></span><br><span class=\"line\">$ sudo scp root@&lt;quay_registry_fqdn&gt;:/mnt/quay/config/ssl.cert \\</span><br><span class=\"line\">  /etc/docker/certs.d/&lt;quay_registry_fqdn&gt;/ssl.crt</span><br><span class=\"line\"><span class=\"comment\"># åŒæ­¥ Quay CA è¯ä¹¦è‡³ Podman å®¢æˆ·ç«¯</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># su - contsvc</span></span><br><span class=\"line\">$ vim ~/.config/containers/registries.conf</span><br><span class=\"line\">  unqualified-search-registries = [<span class=\"string\">'&lt;quay_registry_fqdn&gt;'</span>]</span><br><span class=\"line\">  <span class=\"comment\"># è¯¥åœ°å€å½¢å¦‚ registry.lab.example.com</span></span><br><span class=\"line\">  [[registry]]</span><br><span class=\"line\">  location = <span class=\"string\">\"&lt;quay_registry_fqdn&gt;\"</span></span><br><span class=\"line\">  insecure = <span class=\"literal\">true</span></span><br><span class=\"line\">  blocked = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®æ™®é€šç”¨æˆ·çš„ Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“åœ°å€</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ podman login &lt;quay_registry_fqdn&gt; \\</span><br><span class=\"line\">  --username admin --password 1qazZSE$ \\</span><br><span class=\"line\">  --<span class=\"built_in\">log</span>-level=debug</span><br><span class=\"line\"><span class=\"comment\"># æˆåŠŸç™»å½• Quay ç§æœ‰å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶å¼€å¯ debug æ¨¡å¼ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Docker å®¢æˆ·ç«¯ç™»å½• Quayï¼ˆå¯é€‰ï¼‰ï¼š<img src=\"docker-client-login-quay-registry.jpg\" alt=\"docker-client-login-quay-registry.jpg\"></p>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://www.cnblogs.com/ericnie/p/12233269.html\" target=\"_blank\" rel=\"noopener\">Quay åŸºç¡€ç‰ˆå®‰è£…å’Œéƒ¨ç½²</a></li>\n<li><a href=\"https://docs.projectquay.io/deploy_quay.html\" target=\"_blank\" rel=\"noopener\">Deploy Project Quay for proof-of-concept (non-production) purposes</a></li>\n<li><a href=\"https://github.com/docker/docker.github.io/blob/master/registry/deploying.md#get-a-certificate\" target=\"_blank\" rel=\"noopener\">docker.github.io/registry/deploying.md</a></li>\n<li><a href=\"https://github.com/docker/docker.github.io/blob/master/registry/insecure.md\" target=\"_blank\" rel=\"noopener\">docker.github.io/registry/insecure.md</a></li>\n</ul>\n"},{"title":"Kubernetes ä¸­éƒ¨ç½² Rocket.Chat ä¸ MongoDB å®æ—¶äº¤æµå¹³å°","subtitle":"Deploy Rocket.Chat and MongoDB on Kubernetes","header-img":"mongodb-bg-2.png","date":"2022-12-19T06:07:28.000Z","_content":"\n### éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\n- Kubernetes ç‰ˆæœ¬ï¼š`v1.22.1`\n- Rocket.Chat å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š`docker.io/rocketchat/rocket.chat:3.18.7`\n- MongoDB å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š`docker.io/library/mongo:4.0`\n- Kubernetes NFS-Client Privisioner å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š\n  `quay.io/external_storage/nfs-client-provisioner:latest`\n- ğŸ‘‰ è‹¥æ‹‰å–å¤±è´¥ï¼Œä»¥ä¸Šé•œåƒå‡å¯ä» https://quay.io/user/alberthua ä¸­æ‹‰å–ä¸‹è½½ã€‚\n- ğŸ”— ç‚¹å‡» [é“¾æ¥](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/rocketchat-mongo-statefulset-app)ï¼Œä»¥è·å¾—éƒ¨ç½²ç”¨çš„ç›¸å…³æ–‡ä»¶ã€‚\n\n### éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\n- ğŸ’¥ è¯¥åº”ç”¨åç«¯çš„ MongoDB é›†ç¾¤ä½¿ç”¨ `NFS` ä½œä¸ºåŠ¨æ€ PV çš„æä¾›è€…ï¼Œéœ€æå‰é…ç½® NFS æœåŠ¡å™¨èŠ‚ç‚¹ç”¨äºæä¾› PVï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚\n- ç„¶è€Œï¼ŒKubernetes ä¸­æœªé›†æˆ NFS ç±»å‹çš„å†…éƒ¨è°ƒé…è€…ï¼ˆ`internal privisioner`ï¼‰ï¼Œå› æ­¤éœ€ä½¿ç”¨ `nfs-client-provisioner` å°†å¤–éƒ¨ NFS è°ƒé…è‡³é›†ç¾¤ä»¥æ”¯æŒ PV åŠ¨æ€åˆ†é…ã€‚\n- PV åŠ¨æ€åˆ†é…è¿˜éœ€ä½¿ç”¨ `StorageClass` èµ„æºå°† `privisioner` å¯¹æ¥å…¥ Kubernetes é›†ç¾¤ã€‚\n- ğŸš€ StorageClass è°ƒç”¨é“¾ï¼š\n  Pod **>** PVC **>** StorageClass **>** provisioner (PV åŠ¨æ€åˆ†é…) **>** NFS Server\n- MongoDB é›†ç¾¤ä½¿ç”¨ `StatefulSet` éƒ¨ç½²ï¼Œè€Œè¯¥èµ„æºéœ€ä½¿ç”¨ `StorageClass` å®ç°å·å£°æ˜æ¨¡æ¿ï¼ˆ`volumeClaimTemplates`ï¼‰ã€‚\n- nfs-client-provisioner åœ¨é›†ç¾¤ä¸­çš„éƒ¨ç½²å¯å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/nfs-provisioned-storageclass)ï¼Œä¹Ÿå¯å‚è€ƒå¦‚ä¸‹æ­¥éª¤å®ç°ï¼š \n  - ç™»å½• `NFS` æœåŠ¡å™¨èŠ‚ç‚¹åˆ›å»º NFS å…±äº«ç›®å½•ï¼š\n    ```bash\n    $ yum install -y nfs-utils\n    $ systemctl enable --now nfs-server.service\n    $ mkdir -p /data/k8s\n    $ chmod -R 0777 /data/k8s\n    $ echo \"/data/k8s  192.168.110.0/24(rw,sync,no_root_squash)\" > /etc/exports.d/kubecluster.exports\n    # å…±äº«ç›®å½•ä¸å­˜å‚¨ç½‘æ®µéœ€æ ¹æ®å®é™…æƒ…å†µè€Œå®š\n    # æ³¨æ„ï¼š\n    #   å…±äº«ç›®å½•çš„åç§°å¿…é¡»ä¸ nfs-client-provisioner Deployment ä¸­çš„ path å­—æ®µ\n    #   å®Œå…¨ç›¸åŒï¼\n    $ exportfs -a\n    $ showmount -e localhost\n      Export list for localhost:\n      /data/k8s 192.168.110.0/24\n    $ mkdir /data/k8s/rocketchat-mongodb-app\n    # ä»¥ä¸Šç›®å½•åç§°ä¸­çš„ rocketchat-mongodb-app ä¸ºå‘½åç©ºé—´çš„åç§°\n    $ chmod 0777 /data/k8s/rocketchat-mongodb-app\n    ```\n  - ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 1ï¼š    \n    ç¡®è®¤é›†ç¾¤å„èŠ‚ç‚¹å·²å®‰è£… `nfs-utils` è½¯ä»¶åŒ…ï¼Œè‹¥æœªå®‰è£…åœ¨éƒ¨ç½² `nfs-client-provisioner` pod æ—¶å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œpod çŠ¶æ€æŒç»­æ˜¾ç¤ºä¸º `ContainerCreating`ï¼š    \n    ```bash\n    $ kubectl describe pod nfs-client-provisioner-8b9f4fbcc-rrw8r -n rocketchat-mongodb-app\n    ...\n    Events:\n      Type     Reason       Age                From               Message\n      ----     ------       ----               ----               -------\n      Normal   Scheduled    77s                default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-rrw8r to kube-node2.lab.example.com\n      Warning  FailedMount  12s (x8 over 76s)  kubelet            MountVolume.SetUp failed for volume \"nfs-client-root\" : mount failed: exit status 32\n    Mounting command: mount\n    Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/393e67de-39ed-4d17-aeca-9f2ebe360199/volumes/kubernetes.io~nfs/nfs-client-root\n    Output: mount: wrong fs type, bad option, bad superblock on 192.168.110.162:/data/k8s/rocketchat-mongodb-app,\n           missing codepage or helper program, or other error\n           (for several filesystems (e.g. nfs, cifs) you might\n           need a /sbin/mount.<type> helper program)\n    \n           In some cases useful info is found in syslog - try\n           dmesg | tail or so.\n    ```\n  - ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 2ï¼š    \n    ä½¿ç”¨ nfs-client-provisioner pod å®ç°åŠ¨æ€ PV åˆ†é…æ—¶ï¼Œå¿…é¡»æå‰åœ¨ NFS Server ä¸Šåˆ›å»ºä¸è°ƒæ•´ä»¥å‘½åç©ºé—´åç§°ä¸º `basename` çš„å…±äº«ç›®å½•ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ï¼Œå¦åˆ™å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œæ˜¾ç¤ºæ— æ³•æ‰¾åˆ°ç›®å½•ï¼š\n    ```bash\n    ...\n    Events:\n      Type     Reason       Age                 From               Message\n      ----     ------       ----                ----               -------\n      Normal   Scheduled    18m                 default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-j9z24 to kube-node2.lab.example.com\n      Warning  FailedMount  14m (x2 over 16m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[kube-api-access-rhqq9 nfs-client-root]: timed out waiting for the condition\n      Warning  FailedMount  47s (x6 over 12m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[nfs-client-root kube-api-access-rhqq9]: timed out waiting for the condition\n      Warning  FailedMount  20s (x17 over 18m)  kubelet            MountVolume.SetUp failed for volume \"nfs-client-root\" : mount failed: exit status 32\n    Mounting command: mount\n    Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/7cad43c0-0e08-4e07-b0e8-5bba0a535c4d/volumes/kubernetes.io~nfs/nfs-client-root\n    Output: mount.nfs: mounting 192.168.110.162:/data/k8s/rocketchat-mongodb-app failed, reason given by server: No such file or directory\n    ```\n  > ğŸ’¥ nfs-client-provisioner pod ä¸åº”ç”¨ pod éƒ¨ç½²äºåŒä¸€å‘½åç©ºé—´ä¸­ã€‚\n\n- å› æ­¤ï¼Œè¯¥åº”ç”¨çš„éƒ¨ç½²æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  $ kubectl create namespace rocketchat-mongodb-app\n  $ kubectl apply -f \\\n    00-nfs-provisioned-rbac.yml \\\n    01-nfs-provisioned-deployment.yml \\\n    02-nfs-provisioned-class.yml \\\n    -n rocketchat-mongodb-app\n  $ kubectl apply -f 03-mongodb-internal-headless-svc.yml -n rocketchat-mongodb-app\n  $ kubectl apply -f 04-mongodb-statefulset.yml -n rocketchat-mongodb-app\n  # è¯¥èµ„æºåˆ›å»ºå®Œæˆåå¹¶æœªå®ç° MongoDB çš„ ReplicaSet æ¨¡å¼é›†ç¾¤ï¼Œéœ€ç™»å½•è‡³å…¶ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å®ç°é›†ç¾¤çš„åˆå§‹åŒ–åŠ mongo èŠ‚ç‚¹çš„æ·»åŠ ã€‚\n  ```\n\n  ```bash\n  $ kubectl exec -it rocketmongo-0 -n rocketchat-mongodb-app -- mongo\n    # è¿›å…¥ mongo èŠ‚ç‚¹è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ä¸é…ç½®\n    ...\n    > rs.initiate()  # åˆå§‹åŒ–é›†ç¾¤\n    {\n        \"info2\" : \"no configuration specified. Using a default configuration for the set\",\n        \"me\" : \"rocketmongo-0:27017\",\n        \"ok\" : 1\n    }\n    rs0:SECONDARY> var config = rs.conf()\n    rs0:PRIMARY> config.members[0].host=\"rocketmongo-0.mongodb-internal:27017\"\n    rocketmongo-0.mongodb-internal:27017  \n    # é€šè¿‡ headless service æŒ‡å‘ mongo èŠ‚ç‚¹ï¼Œå°†è¯¥èŠ‚ç‚¹é…ç½®ä¸º primary èŠ‚ç‚¹ã€‚\n    rs0:PRIMARY> rs.reconfig(config)  # åˆ·æ–°é›†ç¾¤é…ç½®\n    {\n        \"ok\" : 1,\n        \"operationTime\" : Timestamp(1671036342, 1),\n        \"$clusterTime\" : {\n            \"clusterTime\" : Timestamp(1671036342, 1),\n            \"signature\" : {\n                \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"),\n                \"keyId\" : NumberLong(0)\n            }\n        }\n    }\n    rs0:PRIMARY> rs.add(\"rocketmongo-1.mongodb-internal:27017\")\n    rs0:PRIMARY> rs.add(\"rocketmongo-2.mongodb-internal:27017\")  # æ·»åŠ é¢å¤–çš„ mongo èŠ‚ç‚¹\n    rs0:PRIMARY> rs.status()    # æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€\n    rs0:PRIMARY> rs.isMaster()  # ç¡®è®¤å½“å‰ mongo èŠ‚ç‚¹æ˜¯å¦ä¸º primary èŠ‚ç‚¹ \n    rs0:PRIMARY> exit           # é€€å‡º MongoDB Shell\n    ...\n  ```\n\n  ```bash\n  $ kubectl apply -f 05-rockerchat-deployment.yml -n rocketchat-mongodb-app\n  # éƒ¨ç½²å‰ç«¯ Rocket.Chat åº”ç”¨\n  ```\n  ğŸ¤˜ å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ·æ–° Rocket.Chat pod æ—¥å¿—å¯ç¡®è®¤å…¶ä¸ MongoDB é›†ç¾¤æˆåŠŸè¿æ¥ï¼š![rocketchat-mongo-connect-successfully.png](rocketchat-mongo-connect-successfully.png)\n\n### ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\n- è¯¥åº”ç”¨æ‰€æ¶‰åŠçš„èµ„æºå¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š![rocketchat-mongo-app-resources.png](rocketchat-mongo-app-resources.png)  \n  ```bash\n  $ kubectl get pv\n    NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                               STORAGECLASS          REASON   AGE\n    pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-0   managed-nfs-storage            21h\n    pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-1   managed-nfs-storage            21h\n    pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-2   managed-nfs-storage            21h\n  $ kubectl get pvc -n rocketchat-mongodb-app\n    NAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\n    mongo-volume-rocketmongo-0   Bound    pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            managed-nfs-storage   21h\n    mongo-volume-rocketmongo-1   Bound    pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            managed-nfs-storage   21h\n    mongo-volume-rocketmongo-2   Bound    pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            managed-nfs-storage   21h\n  # æŸ¥çœ‹ PV åŠ¨æ€åˆ†é…çš„èµ„æº\n  ```\n  ğŸ‘‰ NFS æœåŠ¡å™¨ä¸Š PV çš„å‘½åæ ¼å¼ï¼š`${namespace}-${pvcName}-${pvName}`\n  ğŸ‘‰ PV å›æ”¶æ—¶å€™çš„å‘½åæ ¼å¼ï¼š`archieved-${namespace}-${pvcName}-${pvName}`\n- å¯é€šè¿‡ Rocket.Chat pod æ—¥å¿—ä¸­çš„ URL é“¾æ¥ç™»å½•åº”ç”¨å¹¶æ³¨å†Œè´¦æˆ·ä½¿ç”¨ã€‚![rocketchat-login.png](rocketchat-login.png)\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [åˆ©ç”¨ NFS åŠ¨æ€æä¾› Kubernetes åç«¯å­˜å‚¨å·](https://www.kancloud.cn/huyipow/dr/766694)\n- [Running MongoDB on Kubernetes with StatefulSets](https://kubernetes.io/blog/2017/01/running-mongodb-on-kubernetes-with-statefulsets/)\n- [Running Rocket.Chat and MongoDB on Kubernetes with StatefulSets](https://dev.to/jmarhee/running-rocketchat-and-mongodb-on-kubernetes-with-statefulsets-431o)\n- [Deploy Rocket chat server using Kubernetes](https://ajorloo.medium.com/deploy-rocket-chat-server-using-kubernetes-2d6c4228853)","source":"_posts/rocketchat-mongodb-on-k8s.md","raw":"---\ntitle: Kubernetes ä¸­éƒ¨ç½² Rocket.Chat ä¸ MongoDB å®æ—¶äº¤æµå¹³å°\nsubtitle: Deploy Rocket.Chat and MongoDB on Kubernetes\nheader-img: mongodb-bg-2.png\ndate: 2022-12-19 14:07:28\ntags:\n  - Kubernetes\n  - æ•°æ®åº“\n---\n\n### éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\n- Kubernetes ç‰ˆæœ¬ï¼š`v1.22.1`\n- Rocket.Chat å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š`docker.io/rocketchat/rocket.chat:3.18.7`\n- MongoDB å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š`docker.io/library/mongo:4.0`\n- Kubernetes NFS-Client Privisioner å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š\n  `quay.io/external_storage/nfs-client-provisioner:latest`\n- ğŸ‘‰ è‹¥æ‹‰å–å¤±è´¥ï¼Œä»¥ä¸Šé•œåƒå‡å¯ä» https://quay.io/user/alberthua ä¸­æ‹‰å–ä¸‹è½½ã€‚\n- ğŸ”— ç‚¹å‡» [é“¾æ¥](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/rocketchat-mongo-statefulset-app)ï¼Œä»¥è·å¾—éƒ¨ç½²ç”¨çš„ç›¸å…³æ–‡ä»¶ã€‚\n\n### éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\n- ğŸ’¥ è¯¥åº”ç”¨åç«¯çš„ MongoDB é›†ç¾¤ä½¿ç”¨ `NFS` ä½œä¸ºåŠ¨æ€ PV çš„æä¾›è€…ï¼Œéœ€æå‰é…ç½® NFS æœåŠ¡å™¨èŠ‚ç‚¹ç”¨äºæä¾› PVï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚\n- ç„¶è€Œï¼ŒKubernetes ä¸­æœªé›†æˆ NFS ç±»å‹çš„å†…éƒ¨è°ƒé…è€…ï¼ˆ`internal privisioner`ï¼‰ï¼Œå› æ­¤éœ€ä½¿ç”¨ `nfs-client-provisioner` å°†å¤–éƒ¨ NFS è°ƒé…è‡³é›†ç¾¤ä»¥æ”¯æŒ PV åŠ¨æ€åˆ†é…ã€‚\n- PV åŠ¨æ€åˆ†é…è¿˜éœ€ä½¿ç”¨ `StorageClass` èµ„æºå°† `privisioner` å¯¹æ¥å…¥ Kubernetes é›†ç¾¤ã€‚\n- ğŸš€ StorageClass è°ƒç”¨é“¾ï¼š\n  Pod **>** PVC **>** StorageClass **>** provisioner (PV åŠ¨æ€åˆ†é…) **>** NFS Server\n- MongoDB é›†ç¾¤ä½¿ç”¨ `StatefulSet` éƒ¨ç½²ï¼Œè€Œè¯¥èµ„æºéœ€ä½¿ç”¨ `StorageClass` å®ç°å·å£°æ˜æ¨¡æ¿ï¼ˆ`volumeClaimTemplates`ï¼‰ã€‚\n- nfs-client-provisioner åœ¨é›†ç¾¤ä¸­çš„éƒ¨ç½²å¯å‚è€ƒè¯¥ [é“¾æ¥](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/nfs-provisioned-storageclass)ï¼Œä¹Ÿå¯å‚è€ƒå¦‚ä¸‹æ­¥éª¤å®ç°ï¼š \n  - ç™»å½• `NFS` æœåŠ¡å™¨èŠ‚ç‚¹åˆ›å»º NFS å…±äº«ç›®å½•ï¼š\n    ```bash\n    $ yum install -y nfs-utils\n    $ systemctl enable --now nfs-server.service\n    $ mkdir -p /data/k8s\n    $ chmod -R 0777 /data/k8s\n    $ echo \"/data/k8s  192.168.110.0/24(rw,sync,no_root_squash)\" > /etc/exports.d/kubecluster.exports\n    # å…±äº«ç›®å½•ä¸å­˜å‚¨ç½‘æ®µéœ€æ ¹æ®å®é™…æƒ…å†µè€Œå®š\n    # æ³¨æ„ï¼š\n    #   å…±äº«ç›®å½•çš„åç§°å¿…é¡»ä¸ nfs-client-provisioner Deployment ä¸­çš„ path å­—æ®µ\n    #   å®Œå…¨ç›¸åŒï¼\n    $ exportfs -a\n    $ showmount -e localhost\n      Export list for localhost:\n      /data/k8s 192.168.110.0/24\n    $ mkdir /data/k8s/rocketchat-mongodb-app\n    # ä»¥ä¸Šç›®å½•åç§°ä¸­çš„ rocketchat-mongodb-app ä¸ºå‘½åç©ºé—´çš„åç§°\n    $ chmod 0777 /data/k8s/rocketchat-mongodb-app\n    ```\n  - ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 1ï¼š    \n    ç¡®è®¤é›†ç¾¤å„èŠ‚ç‚¹å·²å®‰è£… `nfs-utils` è½¯ä»¶åŒ…ï¼Œè‹¥æœªå®‰è£…åœ¨éƒ¨ç½² `nfs-client-provisioner` pod æ—¶å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œpod çŠ¶æ€æŒç»­æ˜¾ç¤ºä¸º `ContainerCreating`ï¼š    \n    ```bash\n    $ kubectl describe pod nfs-client-provisioner-8b9f4fbcc-rrw8r -n rocketchat-mongodb-app\n    ...\n    Events:\n      Type     Reason       Age                From               Message\n      ----     ------       ----               ----               -------\n      Normal   Scheduled    77s                default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-rrw8r to kube-node2.lab.example.com\n      Warning  FailedMount  12s (x8 over 76s)  kubelet            MountVolume.SetUp failed for volume \"nfs-client-root\" : mount failed: exit status 32\n    Mounting command: mount\n    Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/393e67de-39ed-4d17-aeca-9f2ebe360199/volumes/kubernetes.io~nfs/nfs-client-root\n    Output: mount: wrong fs type, bad option, bad superblock on 192.168.110.162:/data/k8s/rocketchat-mongodb-app,\n           missing codepage or helper program, or other error\n           (for several filesystems (e.g. nfs, cifs) you might\n           need a /sbin/mount.<type> helper program)\n    \n           In some cases useful info is found in syslog - try\n           dmesg | tail or so.\n    ```\n  - ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 2ï¼š    \n    ä½¿ç”¨ nfs-client-provisioner pod å®ç°åŠ¨æ€ PV åˆ†é…æ—¶ï¼Œå¿…é¡»æå‰åœ¨ NFS Server ä¸Šåˆ›å»ºä¸è°ƒæ•´ä»¥å‘½åç©ºé—´åç§°ä¸º `basename` çš„å…±äº«ç›®å½•ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ï¼Œå¦åˆ™å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œæ˜¾ç¤ºæ— æ³•æ‰¾åˆ°ç›®å½•ï¼š\n    ```bash\n    ...\n    Events:\n      Type     Reason       Age                 From               Message\n      ----     ------       ----                ----               -------\n      Normal   Scheduled    18m                 default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-j9z24 to kube-node2.lab.example.com\n      Warning  FailedMount  14m (x2 over 16m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[kube-api-access-rhqq9 nfs-client-root]: timed out waiting for the condition\n      Warning  FailedMount  47s (x6 over 12m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[nfs-client-root kube-api-access-rhqq9]: timed out waiting for the condition\n      Warning  FailedMount  20s (x17 over 18m)  kubelet            MountVolume.SetUp failed for volume \"nfs-client-root\" : mount failed: exit status 32\n    Mounting command: mount\n    Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/7cad43c0-0e08-4e07-b0e8-5bba0a535c4d/volumes/kubernetes.io~nfs/nfs-client-root\n    Output: mount.nfs: mounting 192.168.110.162:/data/k8s/rocketchat-mongodb-app failed, reason given by server: No such file or directory\n    ```\n  > ğŸ’¥ nfs-client-provisioner pod ä¸åº”ç”¨ pod éƒ¨ç½²äºåŒä¸€å‘½åç©ºé—´ä¸­ã€‚\n\n- å› æ­¤ï¼Œè¯¥åº”ç”¨çš„éƒ¨ç½²æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  $ kubectl create namespace rocketchat-mongodb-app\n  $ kubectl apply -f \\\n    00-nfs-provisioned-rbac.yml \\\n    01-nfs-provisioned-deployment.yml \\\n    02-nfs-provisioned-class.yml \\\n    -n rocketchat-mongodb-app\n  $ kubectl apply -f 03-mongodb-internal-headless-svc.yml -n rocketchat-mongodb-app\n  $ kubectl apply -f 04-mongodb-statefulset.yml -n rocketchat-mongodb-app\n  # è¯¥èµ„æºåˆ›å»ºå®Œæˆåå¹¶æœªå®ç° MongoDB çš„ ReplicaSet æ¨¡å¼é›†ç¾¤ï¼Œéœ€ç™»å½•è‡³å…¶ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å®ç°é›†ç¾¤çš„åˆå§‹åŒ–åŠ mongo èŠ‚ç‚¹çš„æ·»åŠ ã€‚\n  ```\n\n  ```bash\n  $ kubectl exec -it rocketmongo-0 -n rocketchat-mongodb-app -- mongo\n    # è¿›å…¥ mongo èŠ‚ç‚¹è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ä¸é…ç½®\n    ...\n    > rs.initiate()  # åˆå§‹åŒ–é›†ç¾¤\n    {\n        \"info2\" : \"no configuration specified. Using a default configuration for the set\",\n        \"me\" : \"rocketmongo-0:27017\",\n        \"ok\" : 1\n    }\n    rs0:SECONDARY> var config = rs.conf()\n    rs0:PRIMARY> config.members[0].host=\"rocketmongo-0.mongodb-internal:27017\"\n    rocketmongo-0.mongodb-internal:27017  \n    # é€šè¿‡ headless service æŒ‡å‘ mongo èŠ‚ç‚¹ï¼Œå°†è¯¥èŠ‚ç‚¹é…ç½®ä¸º primary èŠ‚ç‚¹ã€‚\n    rs0:PRIMARY> rs.reconfig(config)  # åˆ·æ–°é›†ç¾¤é…ç½®\n    {\n        \"ok\" : 1,\n        \"operationTime\" : Timestamp(1671036342, 1),\n        \"$clusterTime\" : {\n            \"clusterTime\" : Timestamp(1671036342, 1),\n            \"signature\" : {\n                \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"),\n                \"keyId\" : NumberLong(0)\n            }\n        }\n    }\n    rs0:PRIMARY> rs.add(\"rocketmongo-1.mongodb-internal:27017\")\n    rs0:PRIMARY> rs.add(\"rocketmongo-2.mongodb-internal:27017\")  # æ·»åŠ é¢å¤–çš„ mongo èŠ‚ç‚¹\n    rs0:PRIMARY> rs.status()    # æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€\n    rs0:PRIMARY> rs.isMaster()  # ç¡®è®¤å½“å‰ mongo èŠ‚ç‚¹æ˜¯å¦ä¸º primary èŠ‚ç‚¹ \n    rs0:PRIMARY> exit           # é€€å‡º MongoDB Shell\n    ...\n  ```\n\n  ```bash\n  $ kubectl apply -f 05-rockerchat-deployment.yml -n rocketchat-mongodb-app\n  # éƒ¨ç½²å‰ç«¯ Rocket.Chat åº”ç”¨\n  ```\n  ğŸ¤˜ å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ·æ–° Rocket.Chat pod æ—¥å¿—å¯ç¡®è®¤å…¶ä¸ MongoDB é›†ç¾¤æˆåŠŸè¿æ¥ï¼š![rocketchat-mongo-connect-successfully.png](rocketchat-mongo-connect-successfully.png)\n\n### ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\n- è¯¥åº”ç”¨æ‰€æ¶‰åŠçš„èµ„æºå¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š![rocketchat-mongo-app-resources.png](rocketchat-mongo-app-resources.png)  \n  ```bash\n  $ kubectl get pv\n    NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                               STORAGECLASS          REASON   AGE\n    pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-0   managed-nfs-storage            21h\n    pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-1   managed-nfs-storage            21h\n    pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-2   managed-nfs-storage            21h\n  $ kubectl get pvc -n rocketchat-mongodb-app\n    NAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\n    mongo-volume-rocketmongo-0   Bound    pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            managed-nfs-storage   21h\n    mongo-volume-rocketmongo-1   Bound    pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            managed-nfs-storage   21h\n    mongo-volume-rocketmongo-2   Bound    pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            managed-nfs-storage   21h\n  # æŸ¥çœ‹ PV åŠ¨æ€åˆ†é…çš„èµ„æº\n  ```\n  ğŸ‘‰ NFS æœåŠ¡å™¨ä¸Š PV çš„å‘½åæ ¼å¼ï¼š`${namespace}-${pvcName}-${pvName}`\n  ğŸ‘‰ PV å›æ”¶æ—¶å€™çš„å‘½åæ ¼å¼ï¼š`archieved-${namespace}-${pvcName}-${pvName}`\n- å¯é€šè¿‡ Rocket.Chat pod æ—¥å¿—ä¸­çš„ URL é“¾æ¥ç™»å½•åº”ç”¨å¹¶æ³¨å†Œè´¦æˆ·ä½¿ç”¨ã€‚![rocketchat-login.png](rocketchat-login.png)\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [åˆ©ç”¨ NFS åŠ¨æ€æä¾› Kubernetes åç«¯å­˜å‚¨å·](https://www.kancloud.cn/huyipow/dr/766694)\n- [Running MongoDB on Kubernetes with StatefulSets](https://kubernetes.io/blog/2017/01/running-mongodb-on-kubernetes-with-statefulsets/)\n- [Running Rocket.Chat and MongoDB on Kubernetes with StatefulSets](https://dev.to/jmarhee/running-rocketchat-and-mongodb-on-kubernetes-with-statefulsets-431o)\n- [Deploy Rocket chat server using Kubernetes](https://ajorloo.medium.com/deploy-rocket-chat-server-using-kubernetes-2d6c4228853)","slug":"rocketchat-mongodb-on-k8s","published":1,"updated":"2022-12-23T08:10:16.791Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonoma000l16vdkg1vquml","content":"<h3 id=\"éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\"><a href=\"#éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\" class=\"headerlink\" title=\"éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\"></a>éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š</h3><ul>\n<li>Kubernetes ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n<li>Rocket.Chat å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š<code>docker.io/rocketchat/rocket.chat:3.18.7</code></li>\n<li>MongoDB å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š<code>docker.io/library/mongo:4.0</code></li>\n<li>Kubernetes NFS-Client Privisioner å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š<br><code>quay.io/external_storage/nfs-client-provisioner:latest</code></li>\n<li>ğŸ‘‰ è‹¥æ‹‰å–å¤±è´¥ï¼Œä»¥ä¸Šé•œåƒå‡å¯ä» <a href=\"https://quay.io/user/alberthua\" target=\"_blank\" rel=\"noopener\">https://quay.io/user/alberthua</a> ä¸­æ‹‰å–ä¸‹è½½ã€‚</li>\n<li>ğŸ”— ç‚¹å‡» <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/rocketchat-mongo-statefulset-app\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ï¼Œä»¥è·å¾—éƒ¨ç½²ç”¨çš„ç›¸å…³æ–‡ä»¶ã€‚</li>\n</ul>\n<h3 id=\"éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\"><a href=\"#éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\" class=\"headerlink\" title=\"éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\"></a>éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š</h3><ul>\n<li>ğŸ’¥ è¯¥åº”ç”¨åç«¯çš„ MongoDB é›†ç¾¤ä½¿ç”¨ <code>NFS</code> ä½œä¸ºåŠ¨æ€ PV çš„æä¾›è€…ï¼Œéœ€æå‰é…ç½® NFS æœåŠ¡å™¨èŠ‚ç‚¹ç”¨äºæä¾› PVï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</li>\n<li>ç„¶è€Œï¼ŒKubernetes ä¸­æœªé›†æˆ NFS ç±»å‹çš„å†…éƒ¨è°ƒé…è€…ï¼ˆ<code>internal privisioner</code>ï¼‰ï¼Œå› æ­¤éœ€ä½¿ç”¨ <code>nfs-client-provisioner</code> å°†å¤–éƒ¨ NFS è°ƒé…è‡³é›†ç¾¤ä»¥æ”¯æŒ PV åŠ¨æ€åˆ†é…ã€‚</li>\n<li>PV åŠ¨æ€åˆ†é…è¿˜éœ€ä½¿ç”¨ <code>StorageClass</code> èµ„æºå°† <code>privisioner</code> å¯¹æ¥å…¥ Kubernetes é›†ç¾¤ã€‚</li>\n<li>ğŸš€ StorageClass è°ƒç”¨é“¾ï¼š<br>Pod <strong>&gt;</strong> PVC <strong>&gt;</strong> StorageClass <strong>&gt;</strong> provisioner (PV åŠ¨æ€åˆ†é…) <strong>&gt;</strong> NFS Server</li>\n<li>MongoDB é›†ç¾¤ä½¿ç”¨ <code>StatefulSet</code> éƒ¨ç½²ï¼Œè€Œè¯¥èµ„æºéœ€ä½¿ç”¨ <code>StorageClass</code> å®ç°å·å£°æ˜æ¨¡æ¿ï¼ˆ<code>volumeClaimTemplates</code>ï¼‰ã€‚</li>\n<li><p>nfs-client-provisioner åœ¨é›†ç¾¤ä¸­çš„éƒ¨ç½²å¯å‚è€ƒè¯¥ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/nfs-provisioned-storageclass\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ï¼Œä¹Ÿå¯å‚è€ƒå¦‚ä¸‹æ­¥éª¤å®ç°ï¼š </p>\n<ul>\n<li><p>ç™»å½• <code>NFS</code> æœåŠ¡å™¨èŠ‚ç‚¹åˆ›å»º NFS å…±äº«ç›®å½•ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum install -y nfs-utils</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> --now nfs-server.service</span><br><span class=\"line\">$ mkdir -p /data/k8s</span><br><span class=\"line\">$ chmod -R 0777 /data/k8s</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"/data/k8s  192.168.110.0/24(rw,sync,no_root_squash)\"</span> &gt; /etc/exports.d/kubecluster.exports</span><br><span class=\"line\"><span class=\"comment\"># å…±äº«ç›®å½•ä¸å­˜å‚¨ç½‘æ®µéœ€æ ¹æ®å®é™…æƒ…å†µè€Œå®š</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   å…±äº«ç›®å½•çš„åç§°å¿…é¡»ä¸ nfs-client-provisioner Deployment ä¸­çš„ path å­—æ®µ</span></span><br><span class=\"line\"><span class=\"comment\">#   å®Œå…¨ç›¸åŒï¼</span></span><br><span class=\"line\">$ exportfs -a</span><br><span class=\"line\">$ showmount -e localhost</span><br><span class=\"line\">  Export list <span class=\"keyword\">for</span> localhost:</span><br><span class=\"line\">  /data/k8s 192.168.110.0/24</span><br><span class=\"line\">$ mkdir /data/k8s/rocketchat-mongodb-app</span><br><span class=\"line\"><span class=\"comment\"># ä»¥ä¸Šç›®å½•åç§°ä¸­çš„ rocketchat-mongodb-app ä¸ºå‘½åç©ºé—´çš„åç§°</span></span><br><span class=\"line\">$ chmod 0777 /data/k8s/rocketchat-mongodb-app</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 1ï¼š<br>ç¡®è®¤é›†ç¾¤å„èŠ‚ç‚¹å·²å®‰è£… <code>nfs-utils</code> è½¯ä»¶åŒ…ï¼Œè‹¥æœªå®‰è£…åœ¨éƒ¨ç½² <code>nfs-client-provisioner</code> pod æ—¶å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œpod çŠ¶æ€æŒç»­æ˜¾ç¤ºä¸º <code>ContainerCreating</code>ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl describe pod nfs-client-provisioner-8b9f4fbcc-rrw8r -n rocketchat-mongodb-app</span><br><span class=\"line\">...</span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type     Reason       Age                From               Message</span><br><span class=\"line\">  ----     ------       ----               ----               -------</span><br><span class=\"line\">  Normal   Scheduled    77s                default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-rrw8r to kube-node2.lab.example.com</span><br><span class=\"line\">  Warning  FailedMount  12s (x8 over 76s)  kubelet            MountVolume.SetUp failed <span class=\"keyword\">for</span> volume <span class=\"string\">\"nfs-client-root\"</span> : mount failed: <span class=\"built_in\">exit</span> status 32</span><br><span class=\"line\">Mounting <span class=\"built_in\">command</span>: mount</span><br><span class=\"line\">Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/393e67de-39ed-4d17-aeca-9f2ebe360199/volumes/kubernetes.io~nfs/nfs-client-root</span><br><span class=\"line\">Output: mount: wrong fs <span class=\"built_in\">type</span>, bad option, bad superblock on 192.168.110.162:/data/k8s/rocketchat-mongodb-app,</span><br><span class=\"line\">       missing codepage or helper program, or other error</span><br><span class=\"line\">       (<span class=\"keyword\">for</span> several filesystems (e.g. nfs, cifs) you might</span><br><span class=\"line\">       need a /sbin/mount.&lt;<span class=\"built_in\">type</span>&gt; helper program)</span><br><span class=\"line\"></span><br><span class=\"line\">       In some cases useful info is found <span class=\"keyword\">in</span> syslog - try</span><br><span class=\"line\">       dmesg | tail or so.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 2ï¼š<br>ä½¿ç”¨ nfs-client-provisioner pod å®ç°åŠ¨æ€ PV åˆ†é…æ—¶ï¼Œå¿…é¡»æå‰åœ¨ NFS Server ä¸Šåˆ›å»ºä¸è°ƒæ•´ä»¥å‘½åç©ºé—´åç§°ä¸º <code>basename</code> çš„å…±äº«ç›®å½•ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ï¼Œå¦åˆ™å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œæ˜¾ç¤ºæ— æ³•æ‰¾åˆ°ç›®å½•ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type     Reason       Age                 From               Message</span><br><span class=\"line\">  ----     ------       ----                ----               -------</span><br><span class=\"line\">  Normal   Scheduled    18m                 default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-j9z24 to kube-node2.lab.example.com</span><br><span class=\"line\">  Warning  FailedMount  14m (x2 over 16m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[kube-api-access-rhqq9 nfs-client-root]: timed out waiting <span class=\"keyword\">for</span> the condition</span><br><span class=\"line\">  Warning  FailedMount  47s (x6 over 12m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[nfs-client-root kube-api-access-rhqq9]: timed out waiting <span class=\"keyword\">for</span> the condition</span><br><span class=\"line\">  Warning  FailedMount  20s (x17 over 18m)  kubelet            MountVolume.SetUp failed <span class=\"keyword\">for</span> volume <span class=\"string\">\"nfs-client-root\"</span> : mount failed: <span class=\"built_in\">exit</span> status 32</span><br><span class=\"line\">Mounting <span class=\"built_in\">command</span>: mount</span><br><span class=\"line\">Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/7cad43c0-0e08-4e07-b0e8-5bba0a535c4d/volumes/kubernetes.io~nfs/nfs-client-root</span><br><span class=\"line\">Output: mount.nfs: mounting 192.168.110.162:/data/k8s/rocketchat-mongodb-app failed, reason given by server: No such file or directory</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>ğŸ’¥ nfs-client-provisioner pod ä¸åº”ç”¨ pod éƒ¨ç½²äºåŒä¸€å‘½åç©ºé—´ä¸­ã€‚</p>\n</blockquote>\n</li>\n<li><p>å› æ­¤ï¼Œè¯¥åº”ç”¨çš„éƒ¨ç½²æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create namespace rocketchat-mongodb-app</span><br><span class=\"line\">$ kubectl apply -f \\</span><br><span class=\"line\">  00-nfs-provisioned-rbac.yml \\</span><br><span class=\"line\">  01-nfs-provisioned-deployment.yml \\</span><br><span class=\"line\">  02-nfs-provisioned-class.yml \\</span><br><span class=\"line\">  -n rocketchat-mongodb-app</span><br><span class=\"line\">$ kubectl apply -f 03-mongodb-internal-headless-svc.yml -n rocketchat-mongodb-app</span><br><span class=\"line\">$ kubectl apply -f 04-mongodb-statefulset.yml -n rocketchat-mongodb-app</span><br><span class=\"line\"><span class=\"comment\"># è¯¥èµ„æºåˆ›å»ºå®Œæˆåå¹¶æœªå®ç° MongoDB çš„ ReplicaSet æ¨¡å¼é›†ç¾¤ï¼Œéœ€ç™»å½•è‡³å…¶ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å®ç°é›†ç¾¤çš„åˆå§‹åŒ–åŠ mongo èŠ‚ç‚¹çš„æ·»åŠ ã€‚</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl <span class=\"built_in\">exec</span> -it rocketmongo-0 -n rocketchat-mongodb-app -- mongo</span><br><span class=\"line\">  <span class=\"comment\"># è¿›å…¥ mongo èŠ‚ç‚¹è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ä¸é…ç½®</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  &gt; rs.initiate()  <span class=\"comment\"># åˆå§‹åŒ–é›†ç¾¤</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">      <span class=\"string\">\"info2\"</span> : <span class=\"string\">\"no configuration specified. Using a default configuration for the set\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"me\"</span> : <span class=\"string\">\"rocketmongo-0:27017\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ok\"</span> : 1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  rs0:SECONDARY&gt; var config = rs.conf()</span><br><span class=\"line\">  rs0:PRIMARY&gt; config.members[0].host=<span class=\"string\">\"rocketmongo-0.mongodb-internal:27017\"</span></span><br><span class=\"line\">  rocketmongo-0.mongodb-internal:27017  </span><br><span class=\"line\">  <span class=\"comment\"># é€šè¿‡ headless service æŒ‡å‘ mongo èŠ‚ç‚¹ï¼Œå°†è¯¥èŠ‚ç‚¹é…ç½®ä¸º primary èŠ‚ç‚¹ã€‚</span></span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.reconfig(config)  <span class=\"comment\"># åˆ·æ–°é›†ç¾¤é…ç½®</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">      <span class=\"string\">\"ok\"</span> : 1,</span><br><span class=\"line\">      <span class=\"string\">\"operationTime\"</span> : Timestamp(1671036342, 1),</span><br><span class=\"line\">      <span class=\"string\">\"<span class=\"variable\">$clusterTime</span>\"</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">\"clusterTime\"</span> : Timestamp(1671036342, 1),</span><br><span class=\"line\">          <span class=\"string\">\"signature\"</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">\"hash\"</span> : BinData(0,<span class=\"string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span>),</span><br><span class=\"line\">              <span class=\"string\">\"keyId\"</span> : NumberLong(0)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.add(<span class=\"string\">\"rocketmongo-1.mongodb-internal:27017\"</span>)</span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.add(<span class=\"string\">\"rocketmongo-2.mongodb-internal:27017\"</span>)  <span class=\"comment\"># æ·»åŠ é¢å¤–çš„ mongo èŠ‚ç‚¹</span></span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.status()    <span class=\"comment\"># æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€</span></span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.isMaster()  <span class=\"comment\"># ç¡®è®¤å½“å‰ mongo èŠ‚ç‚¹æ˜¯å¦ä¸º primary èŠ‚ç‚¹ </span></span><br><span class=\"line\">  rs0:PRIMARY&gt; <span class=\"built_in\">exit</span>           <span class=\"comment\"># é€€å‡º MongoDB Shell</span></span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f 05-rockerchat-deployment.yml -n rocketchat-mongodb-app</span><br><span class=\"line\"><span class=\"comment\"># éƒ¨ç½²å‰ç«¯ Rocket.Chat åº”ç”¨</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ¤˜ å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ·æ–° Rocket.Chat pod æ—¥å¿—å¯ç¡®è®¤å…¶ä¸ MongoDB é›†ç¾¤æˆåŠŸè¿æ¥ï¼š<img src=\"rocketchat-mongo-connect-successfully.png\" alt=\"rocketchat-mongo-connect-successfully.png\"></p>\n</li>\n</ul>\n<h3 id=\"ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\"><a href=\"#ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\" class=\"headerlink\" title=\"ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\"></a>ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š</h3><ul>\n<li><p>è¯¥åº”ç”¨æ‰€æ¶‰åŠçš„èµ„æºå¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"rocketchat-mongo-app-resources.png\" alt=\"rocketchat-mongo-app-resources.png\">  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pv</span><br><span class=\"line\">  NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                               STORAGECLASS          REASON   AGE</span><br><span class=\"line\">  pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-0   managed-nfs-storage            21h</span><br><span class=\"line\">  pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-1   managed-nfs-storage            21h</span><br><span class=\"line\">  pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-2   managed-nfs-storage            21h</span><br><span class=\"line\">$ kubectl get pvc -n rocketchat-mongodb-app</span><br><span class=\"line\">  NAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class=\"line\">  mongo-volume-rocketmongo-0   Bound    pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            managed-nfs-storage   21h</span><br><span class=\"line\">  mongo-volume-rocketmongo-1   Bound    pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            managed-nfs-storage   21h</span><br><span class=\"line\">  mongo-volume-rocketmongo-2   Bound    pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            managed-nfs-storage   21h</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ PV åŠ¨æ€åˆ†é…çš„èµ„æº</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ‘‰ NFS æœåŠ¡å™¨ä¸Š PV çš„å‘½åæ ¼å¼ï¼š<code>${namespace}-${pvcName}-${pvName}</code><br>ğŸ‘‰ PV å›æ”¶æ—¶å€™çš„å‘½åæ ¼å¼ï¼š<code>archieved-${namespace}-${pvcName}-${pvName}</code></p>\n</li>\n<li>å¯é€šè¿‡ Rocket.Chat pod æ—¥å¿—ä¸­çš„ URL é“¾æ¥ç™»å½•åº”ç”¨å¹¶æ³¨å†Œè´¦æˆ·ä½¿ç”¨ã€‚<img src=\"rocketchat-login.png\" alt=\"rocketchat-login.png\"></li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://www.kancloud.cn/huyipow/dr/766694\" target=\"_blank\" rel=\"noopener\">åˆ©ç”¨ NFS åŠ¨æ€æä¾› Kubernetes åç«¯å­˜å‚¨å·</a></li>\n<li><a href=\"https://kubernetes.io/blog/2017/01/running-mongodb-on-kubernetes-with-statefulsets/\" target=\"_blank\" rel=\"noopener\">Running MongoDB on Kubernetes with StatefulSets</a></li>\n<li><a href=\"https://dev.to/jmarhee/running-rocketchat-and-mongodb-on-kubernetes-with-statefulsets-431o\" target=\"_blank\" rel=\"noopener\">Running Rocket.Chat and MongoDB on Kubernetes with StatefulSets</a></li>\n<li><a href=\"https://ajorloo.medium.com/deploy-rocket-chat-server-using-kubernetes-2d6c4228853\" target=\"_blank\" rel=\"noopener\">Deploy Rocket chat server using Kubernetes</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\"><a href=\"#éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\" class=\"headerlink\" title=\"éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š\"></a>éƒ¨ç½²ç¯å¢ƒè¯´æ˜ï¼š</h3><ul>\n<li>Kubernetes ç‰ˆæœ¬ï¼š<code>v1.22.1</code></li>\n<li>Rocket.Chat å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š<code>docker.io/rocketchat/rocket.chat:3.18.7</code></li>\n<li>MongoDB å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š<code>docker.io/library/mongo:4.0</code></li>\n<li>Kubernetes NFS-Client Privisioner å®¹å™¨é•œåƒç‰ˆæœ¬ï¼š<br><code>quay.io/external_storage/nfs-client-provisioner:latest</code></li>\n<li>ğŸ‘‰ è‹¥æ‹‰å–å¤±è´¥ï¼Œä»¥ä¸Šé•œåƒå‡å¯ä» <a href=\"https://quay.io/user/alberthua\" target=\"_blank\" rel=\"noopener\">https://quay.io/user/alberthua</a> ä¸­æ‹‰å–ä¸‹è½½ã€‚</li>\n<li>ğŸ”— ç‚¹å‡» <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/rocketchat-mongo-statefulset-app\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ï¼Œä»¥è·å¾—éƒ¨ç½²ç”¨çš„ç›¸å…³æ–‡ä»¶ã€‚</li>\n</ul>\n<h3 id=\"éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\"><a href=\"#éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\" class=\"headerlink\" title=\"éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š\"></a>éƒ¨ç½²æ–¹å¼åŠæ­¥éª¤ï¼š</h3><ul>\n<li>ğŸ’¥ è¯¥åº”ç”¨åç«¯çš„ MongoDB é›†ç¾¤ä½¿ç”¨ <code>NFS</code> ä½œä¸ºåŠ¨æ€ PV çš„æä¾›è€…ï¼Œéœ€æå‰é…ç½® NFS æœåŠ¡å™¨èŠ‚ç‚¹ç”¨äºæä¾› PVï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚</li>\n<li>ç„¶è€Œï¼ŒKubernetes ä¸­æœªé›†æˆ NFS ç±»å‹çš„å†…éƒ¨è°ƒé…è€…ï¼ˆ<code>internal privisioner</code>ï¼‰ï¼Œå› æ­¤éœ€ä½¿ç”¨ <code>nfs-client-provisioner</code> å°†å¤–éƒ¨ NFS è°ƒé…è‡³é›†ç¾¤ä»¥æ”¯æŒ PV åŠ¨æ€åˆ†é…ã€‚</li>\n<li>PV åŠ¨æ€åˆ†é…è¿˜éœ€ä½¿ç”¨ <code>StorageClass</code> èµ„æºå°† <code>privisioner</code> å¯¹æ¥å…¥ Kubernetes é›†ç¾¤ã€‚</li>\n<li>ğŸš€ StorageClass è°ƒç”¨é“¾ï¼š<br>Pod <strong>&gt;</strong> PVC <strong>&gt;</strong> StorageClass <strong>&gt;</strong> provisioner (PV åŠ¨æ€åˆ†é…) <strong>&gt;</strong> NFS Server</li>\n<li>MongoDB é›†ç¾¤ä½¿ç”¨ <code>StatefulSet</code> éƒ¨ç½²ï¼Œè€Œè¯¥èµ„æºéœ€ä½¿ç”¨ <code>StorageClass</code> å®ç°å·å£°æ˜æ¨¡æ¿ï¼ˆ<code>volumeClaimTemplates</code>ï¼‰ã€‚</li>\n<li><p>nfs-client-provisioner åœ¨é›†ç¾¤ä¸­çš„éƒ¨ç½²å¯å‚è€ƒè¯¥ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/tree/hotfixes/nfs-provisioned-storageclass\" target=\"_blank\" rel=\"noopener\">é“¾æ¥</a>ï¼Œä¹Ÿå¯å‚è€ƒå¦‚ä¸‹æ­¥éª¤å®ç°ï¼š </p>\n<ul>\n<li><p>ç™»å½• <code>NFS</code> æœåŠ¡å™¨èŠ‚ç‚¹åˆ›å»º NFS å…±äº«ç›®å½•ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ yum install -y nfs-utils</span><br><span class=\"line\">$ systemctl <span class=\"built_in\">enable</span> --now nfs-server.service</span><br><span class=\"line\">$ mkdir -p /data/k8s</span><br><span class=\"line\">$ chmod -R 0777 /data/k8s</span><br><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">\"/data/k8s  192.168.110.0/24(rw,sync,no_root_squash)\"</span> &gt; /etc/exports.d/kubecluster.exports</span><br><span class=\"line\"><span class=\"comment\"># å…±äº«ç›®å½•ä¸å­˜å‚¨ç½‘æ®µéœ€æ ¹æ®å®é™…æƒ…å†µè€Œå®š</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼š</span></span><br><span class=\"line\"><span class=\"comment\">#   å…±äº«ç›®å½•çš„åç§°å¿…é¡»ä¸ nfs-client-provisioner Deployment ä¸­çš„ path å­—æ®µ</span></span><br><span class=\"line\"><span class=\"comment\">#   å®Œå…¨ç›¸åŒï¼</span></span><br><span class=\"line\">$ exportfs -a</span><br><span class=\"line\">$ showmount -e localhost</span><br><span class=\"line\">  Export list <span class=\"keyword\">for</span> localhost:</span><br><span class=\"line\">  /data/k8s 192.168.110.0/24</span><br><span class=\"line\">$ mkdir /data/k8s/rocketchat-mongodb-app</span><br><span class=\"line\"><span class=\"comment\"># ä»¥ä¸Šç›®å½•åç§°ä¸­çš„ rocketchat-mongodb-app ä¸ºå‘½åç©ºé—´çš„åç§°</span></span><br><span class=\"line\">$ chmod 0777 /data/k8s/rocketchat-mongodb-app</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 1ï¼š<br>ç¡®è®¤é›†ç¾¤å„èŠ‚ç‚¹å·²å®‰è£… <code>nfs-utils</code> è½¯ä»¶åŒ…ï¼Œè‹¥æœªå®‰è£…åœ¨éƒ¨ç½² <code>nfs-client-provisioner</code> pod æ—¶å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œpod çŠ¶æ€æŒç»­æ˜¾ç¤ºä¸º <code>ContainerCreating</code>ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl describe pod nfs-client-provisioner-8b9f4fbcc-rrw8r -n rocketchat-mongodb-app</span><br><span class=\"line\">...</span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type     Reason       Age                From               Message</span><br><span class=\"line\">  ----     ------       ----               ----               -------</span><br><span class=\"line\">  Normal   Scheduled    77s                default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-rrw8r to kube-node2.lab.example.com</span><br><span class=\"line\">  Warning  FailedMount  12s (x8 over 76s)  kubelet            MountVolume.SetUp failed <span class=\"keyword\">for</span> volume <span class=\"string\">\"nfs-client-root\"</span> : mount failed: <span class=\"built_in\">exit</span> status 32</span><br><span class=\"line\">Mounting <span class=\"built_in\">command</span>: mount</span><br><span class=\"line\">Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/393e67de-39ed-4d17-aeca-9f2ebe360199/volumes/kubernetes.io~nfs/nfs-client-root</span><br><span class=\"line\">Output: mount: wrong fs <span class=\"built_in\">type</span>, bad option, bad superblock on 192.168.110.162:/data/k8s/rocketchat-mongodb-app,</span><br><span class=\"line\">       missing codepage or helper program, or other error</span><br><span class=\"line\">       (<span class=\"keyword\">for</span> several filesystems (e.g. nfs, cifs) you might</span><br><span class=\"line\">       need a /sbin/mount.&lt;<span class=\"built_in\">type</span>&gt; helper program)</span><br><span class=\"line\"></span><br><span class=\"line\">       In some cases useful info is found <span class=\"keyword\">in</span> syslog - try</span><br><span class=\"line\">       dmesg | tail or so.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ“¢ æŠ¥é”™ç¤ºä¾‹ 2ï¼š<br>ä½¿ç”¨ nfs-client-provisioner pod å®ç°åŠ¨æ€ PV åˆ†é…æ—¶ï¼Œå¿…é¡»æå‰åœ¨ NFS Server ä¸Šåˆ›å»ºä¸è°ƒæ•´ä»¥å‘½åç©ºé—´åç§°ä¸º <code>basename</code> çš„å…±äº«ç›®å½•ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ï¼Œå¦åˆ™å°†è¿”å›å¦‚ä¸‹æŠ¥é”™ï¼Œæ˜¾ç¤ºæ— æ³•æ‰¾åˆ°ç›®å½•ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type     Reason       Age                 From               Message</span><br><span class=\"line\">  ----     ------       ----                ----               -------</span><br><span class=\"line\">  Normal   Scheduled    18m                 default-scheduler  Successfully assigned rocketchat-mongodb-app/nfs-client-provisioner-8b9f4fbcc-j9z24 to kube-node2.lab.example.com</span><br><span class=\"line\">  Warning  FailedMount  14m (x2 over 16m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[kube-api-access-rhqq9 nfs-client-root]: timed out waiting <span class=\"keyword\">for</span> the condition</span><br><span class=\"line\">  Warning  FailedMount  47s (x6 over 12m)   kubelet            Unable to attach or mount volumes: unmounted volumes=[nfs-client-root], unattached volumes=[nfs-client-root kube-api-access-rhqq9]: timed out waiting <span class=\"keyword\">for</span> the condition</span><br><span class=\"line\">  Warning  FailedMount  20s (x17 over 18m)  kubelet            MountVolume.SetUp failed <span class=\"keyword\">for</span> volume <span class=\"string\">\"nfs-client-root\"</span> : mount failed: <span class=\"built_in\">exit</span> status 32</span><br><span class=\"line\">Mounting <span class=\"built_in\">command</span>: mount</span><br><span class=\"line\">Mounting arguments: -t nfs 192.168.110.162:/data/k8s/rocketchat-mongodb-app /var/lib/kubelet/pods/7cad43c0-0e08-4e07-b0e8-5bba0a535c4d/volumes/kubernetes.io~nfs/nfs-client-root</span><br><span class=\"line\">Output: mount.nfs: mounting 192.168.110.162:/data/k8s/rocketchat-mongodb-app failed, reason given by server: No such file or directory</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>ğŸ’¥ nfs-client-provisioner pod ä¸åº”ç”¨ pod éƒ¨ç½²äºåŒä¸€å‘½åç©ºé—´ä¸­ã€‚</p>\n</blockquote>\n</li>\n<li><p>å› æ­¤ï¼Œè¯¥åº”ç”¨çš„éƒ¨ç½²æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl create namespace rocketchat-mongodb-app</span><br><span class=\"line\">$ kubectl apply -f \\</span><br><span class=\"line\">  00-nfs-provisioned-rbac.yml \\</span><br><span class=\"line\">  01-nfs-provisioned-deployment.yml \\</span><br><span class=\"line\">  02-nfs-provisioned-class.yml \\</span><br><span class=\"line\">  -n rocketchat-mongodb-app</span><br><span class=\"line\">$ kubectl apply -f 03-mongodb-internal-headless-svc.yml -n rocketchat-mongodb-app</span><br><span class=\"line\">$ kubectl apply -f 04-mongodb-statefulset.yml -n rocketchat-mongodb-app</span><br><span class=\"line\"><span class=\"comment\"># è¯¥èµ„æºåˆ›å»ºå®Œæˆåå¹¶æœªå®ç° MongoDB çš„ ReplicaSet æ¨¡å¼é›†ç¾¤ï¼Œéœ€ç™»å½•è‡³å…¶ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹å®ç°é›†ç¾¤çš„åˆå§‹åŒ–åŠ mongo èŠ‚ç‚¹çš„æ·»åŠ ã€‚</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl <span class=\"built_in\">exec</span> -it rocketmongo-0 -n rocketchat-mongodb-app -- mongo</span><br><span class=\"line\">  <span class=\"comment\"># è¿›å…¥ mongo èŠ‚ç‚¹è¿›è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ä¸é…ç½®</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  &gt; rs.initiate()  <span class=\"comment\"># åˆå§‹åŒ–é›†ç¾¤</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">      <span class=\"string\">\"info2\"</span> : <span class=\"string\">\"no configuration specified. Using a default configuration for the set\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"me\"</span> : <span class=\"string\">\"rocketmongo-0:27017\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"ok\"</span> : 1</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  rs0:SECONDARY&gt; var config = rs.conf()</span><br><span class=\"line\">  rs0:PRIMARY&gt; config.members[0].host=<span class=\"string\">\"rocketmongo-0.mongodb-internal:27017\"</span></span><br><span class=\"line\">  rocketmongo-0.mongodb-internal:27017  </span><br><span class=\"line\">  <span class=\"comment\"># é€šè¿‡ headless service æŒ‡å‘ mongo èŠ‚ç‚¹ï¼Œå°†è¯¥èŠ‚ç‚¹é…ç½®ä¸º primary èŠ‚ç‚¹ã€‚</span></span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.reconfig(config)  <span class=\"comment\"># åˆ·æ–°é›†ç¾¤é…ç½®</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">      <span class=\"string\">\"ok\"</span> : 1,</span><br><span class=\"line\">      <span class=\"string\">\"operationTime\"</span> : Timestamp(1671036342, 1),</span><br><span class=\"line\">      <span class=\"string\">\"<span class=\"variable\">$clusterTime</span>\"</span> : &#123;</span><br><span class=\"line\">          <span class=\"string\">\"clusterTime\"</span> : Timestamp(1671036342, 1),</span><br><span class=\"line\">          <span class=\"string\">\"signature\"</span> : &#123;</span><br><span class=\"line\">              <span class=\"string\">\"hash\"</span> : BinData(0,<span class=\"string\">\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"</span>),</span><br><span class=\"line\">              <span class=\"string\">\"keyId\"</span> : NumberLong(0)</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.add(<span class=\"string\">\"rocketmongo-1.mongodb-internal:27017\"</span>)</span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.add(<span class=\"string\">\"rocketmongo-2.mongodb-internal:27017\"</span>)  <span class=\"comment\"># æ·»åŠ é¢å¤–çš„ mongo èŠ‚ç‚¹</span></span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.status()    <span class=\"comment\"># æŸ¥çœ‹é›†ç¾¤çš„çŠ¶æ€</span></span><br><span class=\"line\">  rs0:PRIMARY&gt; rs.isMaster()  <span class=\"comment\"># ç¡®è®¤å½“å‰ mongo èŠ‚ç‚¹æ˜¯å¦ä¸º primary èŠ‚ç‚¹ </span></span><br><span class=\"line\">  rs0:PRIMARY&gt; <span class=\"built_in\">exit</span>           <span class=\"comment\"># é€€å‡º MongoDB Shell</span></span><br><span class=\"line\">  ...</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f 05-rockerchat-deployment.yml -n rocketchat-mongodb-app</span><br><span class=\"line\"><span class=\"comment\"># éƒ¨ç½²å‰ç«¯ Rocket.Chat åº”ç”¨</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ¤˜ å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ·æ–° Rocket.Chat pod æ—¥å¿—å¯ç¡®è®¤å…¶ä¸ MongoDB é›†ç¾¤æˆåŠŸè¿æ¥ï¼š<img src=\"rocketchat-mongo-connect-successfully.png\" alt=\"rocketchat-mongo-connect-successfully.png\"></p>\n</li>\n</ul>\n<h3 id=\"ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\"><a href=\"#ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\" class=\"headerlink\" title=\"ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š\"></a>ç¡®è®¤åº”ç”¨èµ„æºä¸ç™»å½•è®¤è¯ï¼š</h3><ul>\n<li><p>è¯¥åº”ç”¨æ‰€æ¶‰åŠçš„èµ„æºå¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"rocketchat-mongo-app-resources.png\" alt=\"rocketchat-mongo-app-resources.png\">  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl get pv</span><br><span class=\"line\">  NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                               STORAGECLASS          REASON   AGE</span><br><span class=\"line\">  pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-0   managed-nfs-storage            21h</span><br><span class=\"line\">  pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-1   managed-nfs-storage            21h</span><br><span class=\"line\">  pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            Delete           Bound    rocketchat-mongodb-app/mongo-volume-rocketmongo-2   managed-nfs-storage            21h</span><br><span class=\"line\">$ kubectl get pvc -n rocketchat-mongodb-app</span><br><span class=\"line\">  NAME                         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE</span><br><span class=\"line\">  mongo-volume-rocketmongo-0   Bound    pvc-1bc91589-312c-4878-af37-5e31a7dacc33   3Gi        RWO            managed-nfs-storage   21h</span><br><span class=\"line\">  mongo-volume-rocketmongo-1   Bound    pvc-aebc940f-f3f2-4389-8d8b-62695dd931b6   3Gi        RWO            managed-nfs-storage   21h</span><br><span class=\"line\">  mongo-volume-rocketmongo-2   Bound    pvc-cd42e48c-ab33-481c-a9dd-eae73c876516   3Gi        RWO            managed-nfs-storage   21h</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ PV åŠ¨æ€åˆ†é…çš„èµ„æº</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ‘‰ NFS æœåŠ¡å™¨ä¸Š PV çš„å‘½åæ ¼å¼ï¼š<code>${namespace}-${pvcName}-${pvName}</code><br>ğŸ‘‰ PV å›æ”¶æ—¶å€™çš„å‘½åæ ¼å¼ï¼š<code>archieved-${namespace}-${pvcName}-${pvName}</code></p>\n</li>\n<li>å¯é€šè¿‡ Rocket.Chat pod æ—¥å¿—ä¸­çš„ URL é“¾æ¥ç™»å½•åº”ç”¨å¹¶æ³¨å†Œè´¦æˆ·ä½¿ç”¨ã€‚<img src=\"rocketchat-login.png\" alt=\"rocketchat-login.png\"></li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://www.kancloud.cn/huyipow/dr/766694\" target=\"_blank\" rel=\"noopener\">åˆ©ç”¨ NFS åŠ¨æ€æä¾› Kubernetes åç«¯å­˜å‚¨å·</a></li>\n<li><a href=\"https://kubernetes.io/blog/2017/01/running-mongodb-on-kubernetes-with-statefulsets/\" target=\"_blank\" rel=\"noopener\">Running MongoDB on Kubernetes with StatefulSets</a></li>\n<li><a href=\"https://dev.to/jmarhee/running-rocketchat-and-mongodb-on-kubernetes-with-statefulsets-431o\" target=\"_blank\" rel=\"noopener\">Running Rocket.Chat and MongoDB on Kubernetes with StatefulSets</a></li>\n<li><a href=\"https://ajorloo.medium.com/deploy-rocket-chat-server-using-kubernetes-2d6c4228853\" target=\"_blank\" rel=\"noopener\">Deploy Rocket chat server using Kubernetes</a></li>\n</ul>\n"},{"title":"Skopeo é•œåƒå·¥å…·ä¸å®¹å™¨é•œåƒæ ¼å¼çš„åŸç†ä¸ä½¿ç”¨","subtitle":"Skopeo Basic Usage and Container Image Format","header-img":"skopeo-bg.jpg","date":"2022-12-06T03:56:03.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼šUbuntu 20.04.3 LTS (Focal Fossa)\n- skopeo ç‰ˆæœ¬ï¼š1.3.0-1\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Skopeo å·¥å…·æ¦‚è¦\n- ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“\n- Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼\n- ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒ\n- å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒ\n- å‚è€ƒé“¾æ¥\n\n### Skopeo å·¥å…·æ¦‚è¦ï¼š\n- å¸¸ç”¨çš„å®¹å™¨é•œåƒæ“ä½œå·¥å…·å¯ä½¿ç”¨ dockerã€podman å‘½ä»¤ï¼Œä½† docker å‘½ä»¤è¡Œå·¥å…·éœ€è¦ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸ root ç”¨æˆ·æƒé™ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å·¥å…·åŒæ­¥å®¹å™¨é•œåƒçš„æ•ˆç‡æ˜¯è¾ƒä½çš„ï¼Œè€Œ podman å‘½ä»¤è™½ç„¶ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼Œä½†æ˜¯å…¶åŒæ­¥é•œåƒæ•ˆç‡ä¾ç„¶ä¸é«˜ã€‚\n- skopeo ä¸ buildah å‘½ä»¤å¯ä¸“é—¨ç”¨äºå®¹å™¨é•œåƒçš„æ“ä½œï¼Œå…¶ä¸­ skopeo å‘½ä»¤æ›´åŠ çº¯ç²¹åœ°ç”¨äºå®¹å™¨é•œåƒçš„æ¬è¿ä¸å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼Œæ•ˆç‡è¾ƒå…¶ä»–å·¥å…·æ›´é«˜ï¼Œä½†æ˜¯ä¸å…·æœ‰å®¹å™¨é•œåƒæ„å»ºçš„èƒ½åŠ›ã€‚\n- Podman æ›´åŠ ä¾§é‡äºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶å…·å¤‡éƒ¨åˆ†å®¹å™¨é•œåƒç®¡ç†ä¸æ„å»ºåŠŸèƒ½ï¼Œè€Œ Buildah æ”¯æŒåˆ†åˆ«ä½¿ç”¨å‘½ä»¤è¡Œä»å¤´æ„å»ºå®¹å™¨é•œåƒä¸ `Dockerfile` æˆ– `Containerfile` çš„æ„å»ºæ–¹å¼ï¼ŒåŒæ—¶å…¼å®¹ Docker ä¸ OCI é•œåƒæ ¼å¼ã€‚\n> ğŸ‘‰ å…³äº Podman æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒä¹‹å‰å†™çš„ [Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ1ï¼‰](https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/)ä¸ [Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ2ï¼‰](https://alberthua-perl.github.io/2022/12/05/podman-usage-practice/)ã€‚\n- Skopeo å®‰è£…æ–¹æ³•å¯å‚è€ƒ [è¯¥ GitHub é“¾æ¥](https://github.com/containers/skopeo/blob/main/install.md)ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚\n- skopeo å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼š  \n  ```bash\n  $ skopeo --help\n  Various operations with container images and container image registries\n  \n  Usage:\n    skopeo [command]\n  \n  Available Commands:\n    copy                                          Copy an IMAGE-NAME from one location to another\n    delete                                        Delete image IMAGE-NAME\n    help                                          Help about any command\n    inspect                                       Inspect image IMAGE-NAME\n    list-tags                                     List tags in the transport/repository specified by the REPOSITORY-NAME\n    login                                         Login to a container registry\n    logout                                        Logout of a container registry\n    manifest-digest                               Compute a manifest digest of a file\n    standalone-sign                               Create a signature using local files\n    standalone-verify                             Verify a signature using local files\n    sync                                          Synchronize one or more images from one location to another\n  \n  Flags:\n        --command-timeout duration   timeout for the command execution\n        --debug                      enable debug output\n    -h, --help                       help for skopeo\n        --insecure-policy            run the tool without any policy check\n        --override-arch ARCH         use ARCH instead of the architecture of the machine for choosing images\n        --override-os OS             use OS instead of the running OS for choosing images\n        --override-variant VARIANT   use VARIANT instead of the running architecture variant for choosing images\n        --policy string              Path to a trust policy file\n        --registries.d DIR           use registry configuration files in DIR (e.g. for container signature storage)\n        --tmpdir string              directory used to store temporary files\n    -v, --version                    Version for Skopeo\n  \n  Use \"skopeo [command] --help\" for more information about a command.\n  ```\n\n### ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\n- Red Hat æ”¯æŒ `skopeo` å‘½ä»¤æ¥ç®¡ç†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒã€‚\n- Skopeo å¯åˆ†åˆ«ç”¨äºæ“ä½œå…¬å…±ï¼ˆpublicï¼‰ä¸ç§æœ‰ï¼ˆprivateï¼‰å®¹å™¨é•œåƒï¼Œå¯¹äºç§æœ‰å®¹å™¨é•œåƒéœ€è¦å¯¹å®¹å™¨é•œåƒä»“åº“è¿›è¡Œè®¤è¯ã€‚\n- Skopeo ä¸ Buildah å¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ `token`ï¼ˆä½äº `/run/user/<UID>/containers/auth.json`ï¼‰ï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ï¼Œå› æ­¤ï¼Œè‹¥åœ¨ skopeo å‘½ä»¤è¡Œä¸­æŒ‡å®šæ˜æ–‡ç™»å½•å¯†ç å¯åœ¨ history å‘½ä»¤å†å²è®°å½•ä¸­æŸ¥çœ‹åˆ°ï¼Œå­˜åœ¨ä¸€å®šçš„å®‰å…¨é£é™©ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹ä»¥å˜é‡å½¢å¼ä¼ é€’å¯†ç çš„æ–¹æ³•ä¼˜åŒ–ï¼š![skopeo-inspect-creds.jpg](skopeo-inspect-creds.jpg)\n> è‹¥æœªä½¿ç”¨ Podman ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä¾ç„¶ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„è¯ï¼Œå…¶è®¤è¯ token ä¾ç„¶å¯è¢« Skopeo ä½¿ç”¨ä¸è®¤è¯ï¼Œè¯¥è®¤è¯ token ä½äº `$HOME/.docker/config.json`ã€‚\n- Skopeo çš„ä¼—å¤šå­å‘½ä»¤æ”¯æŒå®¹å™¨é•œåƒä»“åº“çš„è®¤è¯ï¼Œå¯åˆ†åˆ«é€šè¿‡ç”¨æˆ·åä¸å¯†ç åŠè®¤è¯çš„ token æ–‡ä»¶å®ç°è®¤è¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  ### ç¤ºä¾‹ ###\n  $ skopeo copy --src-creds <username>:<password> \\\n    docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\\n    oci:postgresql-96-rhel7-latest\n  \n  $ skopeo copy --src-authfile /run/user/<UID>/containers/auth.json \\\n    docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\\n    oci:postgresql-96-rhel7-latest\n  ```\n\n### Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\n- Skopeo ä½¿ç”¨ `URI` æ¥è¡¨ç¤ºå®¹å™¨é•œåƒçš„ä½ç½®ï¼Œä½¿ç”¨ URI æ¨¡å¼ï¼ˆschemaï¼‰æ¥è¡¨ç¤ºå®¹å™¨é•œåƒæ ¼å¼å’Œregistry APIsã€‚\n- å¸¸è§çš„ URI æ¨¡å¼ï¼š  \n  - `oci`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨åœ¨æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ä¸­çš„å®¹å™¨é•œåƒ    \n    - è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒï¼ˆ`Open Container Image Layout Specification`ï¼‰  \n  - `oci-archive`ï¼š    \n    - è¡¨ç¤º OCI é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£    \n    - è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒ  \n  - `containers-storage`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ    \n    - åç«¯å®¹å™¨å¼•æ“å…¼å®¹ Podmanã€CRI-O ä¸ Buildah  \n  - `docker-daemon`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ° Docker å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ  \n  - `docker-archive`ï¼š    \n    - è¡¨ç¤º Docker é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£  \n  - `dir`ï¼š    \n    - æœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•ï¼Œå…¶ä¸­ä»¥å•ä¸ªæ–‡ä»¶çš„æ–¹å¼åŒ…å«é•œåƒçš„ `manifest`ã€é•œåƒå±‚ tar å½’æ¡£ä¸å„é•œåƒå±‚ç­¾åï¼ˆ`digest`ï¼‰ã€‚  \n  - `docker://`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨äºå®¹å™¨é•œåƒä»“åº“ä¸­çš„è¿œç¨‹å®¹å™¨é•œåƒ\n    - å¯é€šè¿‡ `Docker Registry HTTP API V2` æ“ä½œä»“åº“ä¸­çš„å®¹å™¨é•œåƒ\n- åŒä¸€å®¹å™¨é•œåƒå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯ä½¿ç”¨ä»¥ä¸Šä¸åŒçš„æ–¹å¼ä¿å­˜ã€‚\n> ğŸ‘‰ å…³äº Skopeo æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒ `man skopeo` æ‰‹å†Œã€‚\n\n### ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒï¼š\n- Skopeo ä¸ä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æ™®é€šç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ï¼Œæ¯” Podman ä½¿ç”¨ tagã€pull ä¸ push ç­‰å­å‘½ä»¤æ—¶æ›´åŠ çš„é«˜æ•ˆã€‚\n- ğŸ³ è‹¥ä½¿ç”¨ docker æˆ– podman å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒä¿å­˜äºæœ¬åœ°å­˜å‚¨ï¼Œéœ€åˆ†åˆ«ä½¿ç”¨ docker pull|save ä¸ podman pull|save å‘½ä»¤å°†æœ¬åœ°é•œåƒç¼“å­˜ä¸­çš„é•œåƒä¿å­˜äº tar å½’æ¡£ï¼Œæ— æ³•ä»å®¹å™¨é•œåƒä»“åº“ç›´æ¥ä¿å­˜äºæ–‡ä»¶æˆ–ç›®å½•ä¸­ï¼Œä¸‹æ–‡ä¸­æåŠçš„ `skopeo copy` æˆ– `sync` å­å‘½ä»¤å¯å®ç°è¯¥åŠŸèƒ½ï¼Œæ— éœ€å­˜åœ¨æœ¬åœ°é•œåƒç¼“å­˜ã€‚\n- ğŸš€ Skopeo æ“çºµé•œåƒå±‚çš„æ–¹å¼ï¼š  \n  - å‡ºäºæ•ˆç‡é—®é¢˜ï¼ŒSkopeo ä¸è¯»å–ä¸å‘é€å·²å­˜åœ¨äºç›®æ ‡ä»“åº“çš„é•œåƒå±‚ï¼Œå®ƒé¦–å…ˆè¯»å–æºé•œåƒçš„ manifestï¼Œå†ç¡®å®šå“ªäº›å±‚å·²å­˜åœ¨äºç›®æ ‡ä»“åº“ï¼Œç„¶åä»…ä»…æ‹·è´ç¼ºå¤±çš„é•œåƒå±‚ã€‚  \n  - è‹¥æ‹·è´æ¥è‡ªæ„å»ºäºåŒä¸€çˆ¶é•œåƒçš„é•œåƒï¼ŒSkopeo ä¸æ‹·è´å¤šä¸ªæ¥è‡ªäºçˆ¶é•œåƒçš„ç›¸åŒé•œåƒå±‚ã€‚  \n  - Skopeo å¯åœ¨å®¹å™¨é•œåƒä»“åº“ä¹‹é—´æ‹·è´é•œåƒè€Œä¸åœ¨æœ¬åœ°å®¹å™¨å­˜å‚¨ä¸­ä¿å­˜é•œåƒå±‚ç¼“å­˜ï¼Œè‹¥æºä»“åº“ä¸ç›®æ ‡ä»“åº“éœ€è¦è®¤è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ `--src-creds` ä¸ `--dest-creds` é€‰é¡¹æŒ‡å®šè®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶ä¸” Skopeo æ”¯æŒåœ¨ç›®æ ‡ä»“åº“å®ç°é•œåƒ `tag`ã€‚\n    ```bash\n    $ skopeo copy \\\n      --src-creds=<username>:<password> \\\n      --dest-creds=<username>:<password> \\\n      docker://<uri_for_src_registry>/<user_or_org>/<repository>:[tag] \\\n      docker://<uri_for_dest_registry>/<user_or_org>/<repository>:[tag]\n    # åˆ†åˆ«æŒ‡å®šæºä»“åº“ä¸ç›®æ ‡ä»“åº“çš„è®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶åœ¨ä»“åº“é—´æ‹·è´å®¹å™¨é•œåƒã€‚\n    ```\n    ![skopeo-copy-dest-creds.jpg](skopeo-copy-dest-creds.jpg)\n- `skopeo delete`ï¼šåˆ é™¤å®¹å™¨é•œåƒçš„é•œåƒ tag  \n  - è¯¥å‘½ä»¤å¯åˆ é™¤å®¹å™¨é•œåƒä»“åº“ä¸­æŒ‡å®šé•œåƒçš„ tag    \n    è‹¥åˆ é™¤å…¬å…±é•œåƒå¯ç›´æ¥æ‰§è¡Œæ— éœ€ç”¨æˆ·è®¤è¯ï¼Œè€Œåˆ é™¤ç§æœ‰å®¹å™¨é•œåƒéœ€ä½¿ç”¨ `--creds` é€‰é¡¹æˆ– `--authfile` é€‰é¡¹è¿›è¡Œè®¤è¯ååˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n    ```bash\n    $ skopeo delete --creds <username>:<password> \\\n      docker://<uri_for_registry>/<user_or_org>/<repository>:[tag]\n    ```\n  - ğŸ’¥ æŒ‡å®šé•œåƒ `tag` æ—¶å°†åˆ é™¤ç‰¹å®š tagï¼Œå³ä½¿å°†æœ€åä¸€ä¸ª tag åˆ é™¤åä¹Ÿä¸åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“ï¼Œè‹¥éœ€è¦åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“éœ€ç™»å½•æŒ‡å®šä»“åº“ã€‚æ­¤å¤„ä¸º Quay.io ä¸ºä¾‹ï¼Œåœ¨ `Web æ§åˆ¶å°` ä¸Šåˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-delete-1.jpg](skopeo-delete-1.jpg)![skopeo-delete-2.jpg](skopeo-delete-2.jpg) \n  - ğŸ’¥ è¯¥å‘½ä»¤ä¹Ÿå¯åˆ é™¤æœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„é•œåƒ tagï¼Œä½†éœ€æ³¨æ„ï¼Œè‹¥å…·æœ‰å¤šä¸ªä¸åŒ tag çš„å®¹å™¨é•œåƒï¼ˆå®é™…ä¸ºåŒä¸€å®¹å™¨é•œåƒï¼‰ï¼Œåªå…·æœ‰åŒä¸€ä¸ª image IDï¼ˆè¯¥å€¼æ¥è‡ªäºé•œåƒçš„ manifest ä¸­ `.config.digest`ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œåˆ é™¤æ—¶å³ä½¿æŒ‡å®šäº†é•œåƒçš„ tagï¼Œä¹Ÿä¼šå°†å…¶ä»–å…·æœ‰ç›¸åŒ image ID çš„é•œåƒä¸€å¹¶åˆ é™¤ï¼Œè¯¥è¡Œä¸ºä¸å®¹å™¨é•œåƒä»“åº“ä¸­ç›¸åŒºåˆ«ï¼\n- `skopeo copy`ï¼šdir æ¨¡å¼ç¤ºä¾‹\n  > ğŸ’¥ Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°é•œåƒç›®å½•ï¼ˆè¯¥ç›®å½•æ— éœ€æå‰åˆ›å»ºï¼‰ï¼Œè¯¥ç›®å½•ä¸­çš„é•œåƒå°è£…æ ¼å¼ä¿ç•™åŸå§‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒæ ¼å¼ã€‚\n\n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    dir:<dir_of_container_image>\n  ```\n  ![skopeo-copy-docker-format-image-dir.jpg](skopeo-copy-docker-format-image-dir.jpg)é™¤äº†ä½¿ç”¨ docker load æˆ– podman load ç›´æ¥å°†å®¹å™¨é•œåƒçš„ tar å½’æ¡£å¯¼å…¥æœ¬åœ°é•œåƒç¼“å­˜ä¸­ï¼Œä¹Ÿå¯ä½¿ç”¨å·²ç»ä¿å­˜è‡³æœ¬åœ°çš„ç›®å½•ä»¥ dir æˆ– oci æ¨¡å¼å­˜åœ¨çš„å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![podman-load-dir-from-skopeo-copy.jpg](podman-load-dir-from-skopeo-copy.jpg)\n  \n  ä¹Ÿå¯ä»¥ä½¿ç”¨ Skopeo å°†æœ¬åœ°é•œåƒç›®å½•æ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ï¼Œç”¨ä»¥æ›¿ä»£ docker push æˆ– podman push çš„åŠŸèƒ½ï¼š\n  ```bash\n  $ skopeo copy \\\n    dir:<dir_of_container_image> \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag]\n  ```\n  ![skopeo-copy-dir-2.jpg](skopeo-copy-dir-2.jpg)\n- `skopeo copy`ï¼šoci æ¨¡å¼ç¤ºä¾‹\n  Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ° `OCI` æ ¼å¼ç›®å½•ä¸­ä»¥å­˜å‚¨é•œåƒï¼š\n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    oci:<dir_of_container_image>\n  ```\n  ![skopeo-copy-oci-1.jpg](skopeo-copy-oci-1.jpg)å…¶ä¸­æ‹·è´è‡³æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…å«äº†å®¹å™¨é•œåƒçš„å„å±‚ï¼ˆlayerï¼‰ã€‚\n  ![skopeo-copy-oci-2.jpg](skopeo-copy-oci-2.jpg)ä¹Ÿå¯ä½¿ç”¨æœ¬åœ° OCI æ ¼å¼ç›®å½•å°†é•œåƒæ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚\n- `skopeo copy`ï¼šoci-archive æ¨¡å¼ç¤ºä¾‹  \n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    oci-archive:<oci_contaier_image_name>.tar\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ OCI é•œåƒæ ¼å¼çš„é•œåƒ\n  ```\n- `skopeo copy`ï¼šcontainers-storage æ¨¡å¼ç¤ºä¾‹  \n  \n  > ğŸ’¥ è¯¥æ¨¡å¼åªèƒ½åœ¨ä»¥ Podman æˆ– CRI-O ä¸ºå®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè‹¥ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶å°†æŠ¥é”™ï¼\n\n  ![skopeo-copy-docker-daemon.jpg](skopeo-copy-docker-daemon.jpg)  \n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    containers-storage:<uri_for_registry>/<user_or_org>/<repository>:[tag]\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜\n  ```\n- `skopeo copy`ï¼šdocker-archive æ¨¡å¼ç¤ºä¾‹  \n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    docker-archive:<docker_contaier_image_name>.tar\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ Docker é•œåƒæ ¼å¼çš„é•œåƒ\n  ```\n- `skopeo copy`ï¼šdocker-daemon æ¨¡å¼ç¤ºä¾‹\n\n  > ğŸ’¥ è¯¥æ¨¡å¼åœ¨ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚\n\n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    docker-daemon:<uri_for_registry>/<user_or_org>/<repository>:[tag]\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜\n  ```\n- ğŸš€ Skopeo å¯¹å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼š  \n  - ä½¿ç”¨ skopeo copy å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°ç›®å½•æˆ–æœ¬åœ° tar å½’æ¡£å­˜å‚¨æ—¶ï¼Œå¯åˆ†åˆ«ä»¥ Docker é•œåƒæ ¼å¼æˆ– OCI é•œåƒæ ¼å¼ä¿å­˜ã€‚  \n  - å› æ­¤ï¼Œskopeo copy å‘½ä»¤å¯åŒæ—¶å®Œæˆå®¹å™¨é•œåƒçš„ä¸‹è½½ä¸é•œåƒæ ¼å¼çš„è½¬æ¢ã€‚  \n  - å¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-copy-transform-image-format.jpg](skopeo-copy-transform-image-format.jpg)\n- `skopeo sync`ï¼š  \n  - sync å­å‘½ä»¤å°†å®¹å™¨é•œåƒä» src æºåŒæ­¥è‡³ dest ç›®çš„åœ°ï¼ŒåŠŸèƒ½ä¸ copy å­å‘½ä»¤ç±»ä¼¼ã€‚  \n  - skopeo sync å‘½ä»¤å¯æŒ‡å®šçš„ src ä¸ dest ç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-sync-help.jpg](skopeo-sync-help.jpg)\n  - ğŸ‘‰ ç¤ºä¾‹ 1ï¼š    \n    å°†è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåŒæ­¥è‡³æœ¬åœ°ç›®å½•ï¼Œæœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•æ— éœ€åˆ›å»ºã€‚![skopeo-sync-demo.jpg](skopeo-sync-demo.jpg)\n  - ğŸ‘‰ ç¤ºä¾‹ 2ï¼š    \n    skopeo å‘½ä»¤åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªå®¹å™¨é•œåƒä»“åº“çš„ token è®¤è¯æ–‡ä»¶å°†å®¹å™¨é•œåƒåŒæ­¥è‡³å¦ä¸€ä¸ªä»“åº“ä¸­ï¼Œå¹¶ä¸”ç›®æ ‡ä»“åº“åªéœ€æŒ‡å®šä»“åº“ `URI` å³å¯ï¼Œå°†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„é•œåƒåç§°ä¸æ ‡ç­¾ã€‚![skopeo-sync-between-registry.jpg](skopeo-sync-between-registry.jpg)\n  - ä¹Ÿå¯ä½¿ç”¨ skopeo sync å‘½ä»¤å°†æœ¬åœ° dir æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒåŒæ­¥è‡³è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚\n- `skopeo inspect` ä¸ `skopeo manifest-digest`ï¼š\n  - è¯¥å‘½ä»¤ç”¨äºæŸ¥çœ‹è¯¦ç»†çš„å®¹å™¨é•œåƒå±‚ä¿¡æ¯ï¼ˆimage manifestï¼‰æˆ–å®¹å™¨é•œåƒçš„é…ç½®ä¿¡æ¯ï¼ˆimage configï¼‰ã€‚  \n  - ğŸ³ image manifest åŒ…å«å„é•œåƒå±‚çš„ `mediaType`ã€`size`ã€`digest`ï¼Œè€Œ image config åŒ…å«é•œåƒçš„å…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚  \n  - ğŸ‘‰ ç¤ºä¾‹ 1ï¼šDocker é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•    \n    å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨ `dir` æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒä½äº nexus3-3.37.3 ç›®å½•ä¸­ï¼Œå¯ç›´æ¥ä½¿ç”¨ `jq` å‘½ä»¤æŸ¥çœ‹è¯¥é•œåƒçš„ image manifest ä¸ image configï¼š    \n    ```bash\n    ### ç¤ºä¾‹ï¼ˆä»¥ä¸‹å†…å®¹ä¸ºéƒ¨åˆ†è¾“å‡ºï¼‰ ###\n    $ jq '.' nexus3-3.37.3/manifest.json\n    {\n      \"schemaVersion\": 2,\n      \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n      \"config\": {\n        \"mediaType\": \"application/vnd.docker.container.image.v1+json\",\n        \"size\": 10193,\n        \"digest\": \"sha256:1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd\"\n      },\n      \"layers\": [\n        {\n          \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n          \"size\": 81522888,\n          \"digest\": \"sha256:8dfe9326f733b815c486432e93e0a97f03e90e7cc35def9511cd1efa7f917f56\"\n        },\n        ...\n      ]\n    }\n    # æ ¹æ® dir ç›®å½•ä¸­çš„ manifest æŸ¥çœ‹å®¹å™¨é•œåƒåŠå„é•œåƒå±‚ä¿¡æ¯\n    \n    $ jq '.' nexus3-3.37.3/1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd\n    {\n      \"architecture\": \"amd64\",\n      \"config\": {\n        \"Hostname\": \"bb4a731bd39e\",\n        \"Domainname\": \"\",\n        \"User\": \"nexus\",\n        ...\n        \"ExposedPorts\": {\n          \"8081/tcp\": {}\n        },\n        \"Tty\": false,\n        \"OpenStdin\": false,\n        \"StdinOnce\": false,\n        \"Env\": [\n          \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\",\n          \"container=oci\",\n          \"SONATYPE_DIR=/opt/sonatype\",\n          \"NEXUS_HOME=/opt/sonatype/nexus\",\n          \"NEXUS_DATA=/nexus-data\",\n          \"NEXUS_CONTEXT=\",\n          \"SONATYPE_WORK=/opt/sonatype/sonatype-work\",\n          \"DOCKER_TYPE=3x-docker\",\n          \"INSTALL4J_ADD_VM_PARAMS=-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=/nexus-data/javaprefs\"\n        ],\n        \"Cmd\": [\n          \"sh\",\n          \"-c\",\n          \"${SONATYPE_DIR}/start-nexus-repository-manager.sh\"\n        ],\n        \"Image\": \"sha256:bb968737b5d0d7420e5af7c5524cddc16bd2b43a47f8277e00b1461342d40ba5\",\n        \"Volumes\": {\n          \"/nexus-data\": {}\n        },\n      ...\n      },\n      \"created\": \"2022-03-02T23:52:49.682473465Z\",\n      \"docker_version\": \"20.10.9\",\n      \"history\": [\n        {\n          \"created\": \"2022-02-25T17:39:29.754401796Z\",\n          \"comment\": \"Imported from -\"\n        },\n        ...\n        {\n          \"created\": \"2022-03-02T23:52:49.682473465Z\",\n          \"created_by\": \"/bin/sh -c #(nop)  CMD [\\\"sh\\\" \\\"-c\\\" \\\"${SONATYPE_DIR}/start-nexus-repository-manager.sh\\\"]\",\n          \"empty_layer\": true\n        }\n      ],\n      \"os\": \"linux\",\n      \"rootfs\": {\n        \"type\": \"layers\",\n        \"diff_ids\": [\n          \"sha256:7699752e6ed63eef234d2736d4e37159a433e18e06cd617e254299f324f41797\",\n          \"sha256:c8013a2772b6673d9b750b6407d4ac4f525a47bb2a5b5bf09ba9bf8e10aea3fc\",\n          \"sha256:5a745ebef99f4893aac7c56a26e54f9c6cdc08b02748e0580b1a31d70be0a280\",\n          \"sha256:8d12fc82bf58bf5f7958577a148cc05899f0c19e4654376f5e01d3af46eb0c15\",\n          \"sha256:d17e45a4f748d13d0501b9e1bca5be387e13efa8ce98147a85c904a348764f3b\"\n        ]\n      }\n    }\n    # æ ¹æ®å®¹å™¨é•œåƒç›®å½•ä¸­çš„ config æ–‡ä»¶æŸ¥çœ‹å…·ä½“çš„ image config \n    ```\n    ```bash\n    $ skopeo inspect dir:nexus3-3.37.3\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„æ¦‚è¦ä¿¡æ¯\n    \n    $ skopeo inspect --raw dir:nexus3-3.37.3\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸é•œåƒçš„ manifest.json ä¸€è‡´ã€‚\n    \n    $ skopeo inspect --config dir:nexus3-3.37.3\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ config ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸ç›´æ¥æŸ¥çœ‹é•œåƒçš„é…ç½®ä¿¡æ¯ä¸€è‡´ã€‚\n    \n    $ skopeo manifest-digest nexus3-3.37.3/manifest.json\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest.json æ–‡ä»¶çš„ digest å€¼\n    ```\n    å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ `image manifest` ä¸å…¶ `digest` çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-docker-image-format-digest-1.jpg](skopeo-docker-image-format-digest-1.jpg)![skopeo-docker-image-format-digest-2.jpg](skopeo-docker-image-format-digest-2.jpg)\n  - ğŸ‘‰ ç¤ºä¾‹ 2ï¼šOCI é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•    \n    å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ `image manifest` ä¸å…¶ `digest` çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-oci-image-format-digest.jpg](skopeo-oci-image-format-digest.jpg)\n\n### ğŸ³ å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\n- å¯¹äºä¸åŒçš„å®¹å™¨é•œåƒæ ¼å¼ï¼Œå…¶ç›®å½•çš„ç»„ç»‡ç»“æ„å­˜åœ¨å·®å¼‚ï¼Œä½†å½¼æ­¤é—´åˆæœ‰è”ç³»ã€‚\n- ç›®å‰é‡‡ç”¨çš„å®¹å™¨é•œåƒæ ¼å¼ï¼š  \n  - `Docker image format`ï¼šDocker é•œåƒæ ¼å¼  \n  - `OCI image format`ï¼šOCI é•œåƒæ ¼å¼\n- OCI image format ç»§æ‰¿äº Docker image formatï¼Œå› æ­¤ï¼Œå¯è¿è¡Œ OCI image format é•œåƒçš„å®¹å™¨è¿è¡Œæ—¶ä¹Ÿå¯è¿è¡Œ Docker image format çš„é•œåƒã€‚\n- `OCI`ï¼ˆOpen Container Initiativeï¼Œå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰å‘å±•æ¦‚è¿°ï¼š\n  - ä¸ºäº†æ¨è¿›å®¹å™¨åŒ–æŠ€æœ¯çš„å·¥ä¸šæ ‡å‡†åŒ–ï¼Œ2015 å¹´ 6 æœˆåœ¨ `DockerCon` ä¸Š Linux åŸºé‡‘ä¼šä¸ Googleã€åä¸ºã€æƒ æ™®ã€IBMã€Dockerã€Red Hatã€VMware ç­‰å…¬å¸å…±åŒå®£å¸ƒæˆç«‹å¼€æ”¾å®¹å™¨é¡¹ç›®ï¼ˆOCPï¼‰ï¼Œåæ›´åä¸ºå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼ˆOCIï¼‰ã€‚  \n  - å®ƒçš„ä¸»è¦ç›®æ ‡æ˜¯å»ºç«‹å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶çš„å·¥ä¸šå¼€æ”¾é€šç”¨æ ‡å‡†ã€‚  \n  - ä¸ºäº†æ”¯æŒ OCI å®¹å™¨è¿è¡Œæ—¶æ ‡å‡†çš„æ¨è¿›ï¼ŒDocker å…¬å¸èµ·è‰äº†é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶è§„èŒƒçš„è‰æ¡ˆï¼Œå¹¶å°† Docker é¡¹ç›®çš„ç›¸å…³å®ç°æçŒ®ç»™äº†ç¤¾åŒºï¼ŒOCI ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„åŸºç¡€å®ç°ï¼Œç°åœ¨é¡¹ç›®åä¸º `runc`ã€‚\n- ğŸ¤˜ å‘å±•è‡³ä»Šï¼ŒOCI åˆ¶å®šçš„ä¸»è¦æ ‡å‡†ï¼š  \n  - `runtime-spec`ï¼šå®šä¹‰å®¹å™¨è¿è¡Œæ—¶è§„èŒƒ  \n  - `image-spec`ï¼šå®šä¹‰å®¹å™¨é•œåƒæ ¼å¼è§„èŒƒ  \n  - `distribution-spec`ï¼šå®šä¹‰å®¹å™¨é•œåƒçš„åˆ†å‘è§„èŒƒ\n- OCI image format ç›®å½•è¯´æ˜ï¼š  \n  - å¦‚ä¸‹æ‰€ç¤ºï¼Œä»¥ `debian` é•œåƒä¸ºä¾‹ï¼š    \n    ```bash\n    $ tree debian-bullseye-20211115-oci\n    debian-bullseye-20211115-oci\n    â”œâ”€â”€ blobs\n    â”‚   â””â”€â”€ sha256\n    â”‚       â”œâ”€â”€ 468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\n    â”‚       â”œâ”€â”€ 5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6\n    â”‚       â””â”€â”€ 61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad\n    â”œâ”€â”€ index.json\n    â””â”€â”€ oci-layout\n    ```\n  - oci-layoutï¼šOCI image çš„é•œåƒå¸ƒå±€è§„èŒƒï¼Œæ­¤å¤„ä½¿ç”¨ `OCI 1.0.0` ç‰ˆæœ¬ã€‚\n    ```bash\n    $ jq '.' debian-bullseye-20211115-oci/oci-layout\n    {\n      \"imageLayoutVersion\": \"1.0.0\"\n    }\n    ```\n  - index.jsonï¼š    \n    - `index.json`Â æ–‡ä»¶ä¸­çš„Â `manifests`Â å­—æ®µç±»ä¼¼äº Docker image ä¸­çš„Â `manifest.json` ä½œä¸º OCI image çš„é¡¶çº§é…ç½®, ä¹Ÿæ˜¯é•œåƒçš„ä¸€ä¸ªå…¥å£é…ç½®ã€‚  \n    - è¯¥æ–‡ä»¶å®é™…æŒ‡å‘ `blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b` ï¼Œå³çœŸæ­£çš„ OCI image manifest æ–‡ä»¶ã€‚\n      ```bash\n      $ jq '.' debian-bullseye-20211115-oci/index.json\n      {\n        \"schemaVersion\": 2,\n        \"manifests\": [\n          {\n            \"mediaType\": \"application/vnd.oci.image.manifest.v1+json\",\n            \"digest\": \"sha256:468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\",\n            \"size\": 349\n          }\n        ]\n      }\n      ```\n    - ä»è¯¥æ–‡ä»¶çš„ `mediaType` å¯ä»¥çœ‹å‡ºå®¹å™¨é•œåƒæ ¼å¼å·²å‘ç”Ÿçš„å˜åŒ–ï¼š\n      ```bash\n      $ jq '.mediaType' debian-bullseye-20211115-docker/manifest.json\n      \"application/vnd.docker.distribution.manifest.v2+json\"\n      # Docker image format å°è£…\n      \n      $ jq '.manifests[0].mediaType' debian-bullseye-20211115-oci/index.json\n      \"application/vnd.oci.image.manifest.v1+json\"\n      # OCI image format å°è£… \n      ```\n      ```bash\n      $ jq '.' debian-bullseye-20211115-oci/blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\n      {\n        \"schemaVersion\": 2,\n        \"config\": {\n          \"mediaType\": \"application/vnd.oci.image.config.v1+json\",\n          \"digest\": \"sha256:61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad\",\n          \"size\": 579\n        },\n        \"layers\": [\n          {\n            \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\",\n            \"digest\": \"sha256:5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6\",\n            \"size\": 56889206\n          }\n        ]\n      }\n      ```\n      ä»¥ä¸Šæ–‡ä»¶ä¸º OCI image manifest æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« image config çš„ä¿¡æ¯ä¸å„é•œåƒå±‚ Layers çš„ä¿¡æ¯ï¼Œæ¯å±‚ layer ä½¿ç”¨ `tar+gzip` çš„æ–¹å¼è¿›è¡Œå‹ç¼©ã€‚\n- Docker image format ä¸ OCI image format çš„è”ç³»ä¸åŒºåˆ«ï¼š  \n  - æœ€ä¸»è¦çš„åŒºåˆ«ï¼šç›®å½•ç»“æ„ä¸å®Œå…¨ç›¸åŒï¼Œé…ç½®ä¿¡æ¯å°¤å…¶æ˜¯Â `mediaType`Â çš„è§„èŒƒä¸åŒã€‚  \n  - è”ç³»ï¼šOCI image çš„è§„èŒƒæ˜¯ç”± Docker image çš„è§„èŒƒä¿®æ”¹è€Œæ¥ï¼Œæ‰€ä»¥ç±»ä¼¼å®ƒä»¬çš„ blob çš„ç»„ç»‡å½¢å¼å¤§è‡´ç›¸åŒï¼Œé…ç½®æ–‡ä»¶ä¸­å¾ˆå¤šçš„å‚æ•°ä¹Ÿç›¸ä¼¼ã€‚  \n  - å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ skopeo å·¥å…·å¾ˆæ–¹ä¾¿åœ°å°† Docker image è½¬æ¢ä¸º OCI imageã€‚\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [GitHub Doc - Skopeo](https://github.com/containers/skopeo)\n- [é•œåƒæ¬è¿å·¥å…· Skopeo ä½¿ç”¨](https://mp.weixin.qq.com/s/J2b-PQD5GkN5KEmGB2WAeA)\n- [OCI ä¸å®¹å™¨é•œåƒæ„å»º](https://mp.weixin.qq.com/s/8wAv87DkJjE6fVEEmoQ60Q)\n- [GitHub Doc - opencontainers/image-spec](https://github.com/opencontainers/image-spec)\n- [GitHub Doc - OCI Image Media Types](https://github.com/opencontainers/image-spec/blob/main/media-types.md)\n- [GitHub Doc - Open Container Initiative Runtime Specification](https://github.com/opencontainers/runtime-spec/blob/main/spec.md)","source":"_posts/skopeo-basic-usage.md","raw":"---\ntitle: Skopeo é•œåƒå·¥å…·ä¸å®¹å™¨é•œåƒæ ¼å¼çš„åŸç†ä¸ä½¿ç”¨\nsubtitle: Skopeo Basic Usage and Container Image Format\nheader-img: skopeo-bg.jpg\ndate: 2022-12-06 11:56:03\ntags:\n  - å®¹å™¨\n  - äº‘åŸç”Ÿ\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- OS ç‰ˆæœ¬ï¼šUbuntu 20.04.3 LTS (Focal Fossa)\n- skopeo ç‰ˆæœ¬ï¼š1.3.0-1\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- Skopeo å·¥å…·æ¦‚è¦\n- ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“\n- Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼\n- ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒ\n- å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒ\n- å‚è€ƒé“¾æ¥\n\n### Skopeo å·¥å…·æ¦‚è¦ï¼š\n- å¸¸ç”¨çš„å®¹å™¨é•œåƒæ“ä½œå·¥å…·å¯ä½¿ç”¨ dockerã€podman å‘½ä»¤ï¼Œä½† docker å‘½ä»¤è¡Œå·¥å…·éœ€è¦ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸ root ç”¨æˆ·æƒé™ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å·¥å…·åŒæ­¥å®¹å™¨é•œåƒçš„æ•ˆç‡æ˜¯è¾ƒä½çš„ï¼Œè€Œ podman å‘½ä»¤è™½ç„¶ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼Œä½†æ˜¯å…¶åŒæ­¥é•œåƒæ•ˆç‡ä¾ç„¶ä¸é«˜ã€‚\n- skopeo ä¸ buildah å‘½ä»¤å¯ä¸“é—¨ç”¨äºå®¹å™¨é•œåƒçš„æ“ä½œï¼Œå…¶ä¸­ skopeo å‘½ä»¤æ›´åŠ çº¯ç²¹åœ°ç”¨äºå®¹å™¨é•œåƒçš„æ¬è¿ä¸å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼Œæ•ˆç‡è¾ƒå…¶ä»–å·¥å…·æ›´é«˜ï¼Œä½†æ˜¯ä¸å…·æœ‰å®¹å™¨é•œåƒæ„å»ºçš„èƒ½åŠ›ã€‚\n- Podman æ›´åŠ ä¾§é‡äºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶å…·å¤‡éƒ¨åˆ†å®¹å™¨é•œåƒç®¡ç†ä¸æ„å»ºåŠŸèƒ½ï¼Œè€Œ Buildah æ”¯æŒåˆ†åˆ«ä½¿ç”¨å‘½ä»¤è¡Œä»å¤´æ„å»ºå®¹å™¨é•œåƒä¸ `Dockerfile` æˆ– `Containerfile` çš„æ„å»ºæ–¹å¼ï¼ŒåŒæ—¶å…¼å®¹ Docker ä¸ OCI é•œåƒæ ¼å¼ã€‚\n> ğŸ‘‰ å…³äº Podman æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒä¹‹å‰å†™çš„ [Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ1ï¼‰](https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/)ä¸ [Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ2ï¼‰](https://alberthua-perl.github.io/2022/12/05/podman-usage-practice/)ã€‚\n- Skopeo å®‰è£…æ–¹æ³•å¯å‚è€ƒ [è¯¥ GitHub é“¾æ¥](https://github.com/containers/skopeo/blob/main/install.md)ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚\n- skopeo å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼š  \n  ```bash\n  $ skopeo --help\n  Various operations with container images and container image registries\n  \n  Usage:\n    skopeo [command]\n  \n  Available Commands:\n    copy                                          Copy an IMAGE-NAME from one location to another\n    delete                                        Delete image IMAGE-NAME\n    help                                          Help about any command\n    inspect                                       Inspect image IMAGE-NAME\n    list-tags                                     List tags in the transport/repository specified by the REPOSITORY-NAME\n    login                                         Login to a container registry\n    logout                                        Logout of a container registry\n    manifest-digest                               Compute a manifest digest of a file\n    standalone-sign                               Create a signature using local files\n    standalone-verify                             Verify a signature using local files\n    sync                                          Synchronize one or more images from one location to another\n  \n  Flags:\n        --command-timeout duration   timeout for the command execution\n        --debug                      enable debug output\n    -h, --help                       help for skopeo\n        --insecure-policy            run the tool without any policy check\n        --override-arch ARCH         use ARCH instead of the architecture of the machine for choosing images\n        --override-os OS             use OS instead of the running OS for choosing images\n        --override-variant VARIANT   use VARIANT instead of the running architecture variant for choosing images\n        --policy string              Path to a trust policy file\n        --registries.d DIR           use registry configuration files in DIR (e.g. for container signature storage)\n        --tmpdir string              directory used to store temporary files\n    -v, --version                    Version for Skopeo\n  \n  Use \"skopeo [command] --help\" for more information about a command.\n  ```\n\n### ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\n- Red Hat æ”¯æŒ `skopeo` å‘½ä»¤æ¥ç®¡ç†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒã€‚\n- Skopeo å¯åˆ†åˆ«ç”¨äºæ“ä½œå…¬å…±ï¼ˆpublicï¼‰ä¸ç§æœ‰ï¼ˆprivateï¼‰å®¹å™¨é•œåƒï¼Œå¯¹äºç§æœ‰å®¹å™¨é•œåƒéœ€è¦å¯¹å®¹å™¨é•œåƒä»“åº“è¿›è¡Œè®¤è¯ã€‚\n- Skopeo ä¸ Buildah å¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ `token`ï¼ˆä½äº `/run/user/<UID>/containers/auth.json`ï¼‰ï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ï¼Œå› æ­¤ï¼Œè‹¥åœ¨ skopeo å‘½ä»¤è¡Œä¸­æŒ‡å®šæ˜æ–‡ç™»å½•å¯†ç å¯åœ¨ history å‘½ä»¤å†å²è®°å½•ä¸­æŸ¥çœ‹åˆ°ï¼Œå­˜åœ¨ä¸€å®šçš„å®‰å…¨é£é™©ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹ä»¥å˜é‡å½¢å¼ä¼ é€’å¯†ç çš„æ–¹æ³•ä¼˜åŒ–ï¼š![skopeo-inspect-creds.jpg](skopeo-inspect-creds.jpg)\n> è‹¥æœªä½¿ç”¨ Podman ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä¾ç„¶ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„è¯ï¼Œå…¶è®¤è¯ token ä¾ç„¶å¯è¢« Skopeo ä½¿ç”¨ä¸è®¤è¯ï¼Œè¯¥è®¤è¯ token ä½äº `$HOME/.docker/config.json`ã€‚\n- Skopeo çš„ä¼—å¤šå­å‘½ä»¤æ”¯æŒå®¹å™¨é•œåƒä»“åº“çš„è®¤è¯ï¼Œå¯åˆ†åˆ«é€šè¿‡ç”¨æˆ·åä¸å¯†ç åŠè®¤è¯çš„ token æ–‡ä»¶å®ç°è®¤è¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  \n  ```bash\n  ### ç¤ºä¾‹ ###\n  $ skopeo copy --src-creds <username>:<password> \\\n    docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\\n    oci:postgresql-96-rhel7-latest\n  \n  $ skopeo copy --src-authfile /run/user/<UID>/containers/auth.json \\\n    docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\\n    oci:postgresql-96-rhel7-latest\n  ```\n\n### Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\n- Skopeo ä½¿ç”¨ `URI` æ¥è¡¨ç¤ºå®¹å™¨é•œåƒçš„ä½ç½®ï¼Œä½¿ç”¨ URI æ¨¡å¼ï¼ˆschemaï¼‰æ¥è¡¨ç¤ºå®¹å™¨é•œåƒæ ¼å¼å’Œregistry APIsã€‚\n- å¸¸è§çš„ URI æ¨¡å¼ï¼š  \n  - `oci`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨åœ¨æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ä¸­çš„å®¹å™¨é•œåƒ    \n    - è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒï¼ˆ`Open Container Image Layout Specification`ï¼‰  \n  - `oci-archive`ï¼š    \n    - è¡¨ç¤º OCI é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£    \n    - è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒ  \n  - `containers-storage`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ    \n    - åç«¯å®¹å™¨å¼•æ“å…¼å®¹ Podmanã€CRI-O ä¸ Buildah  \n  - `docker-daemon`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ° Docker å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ  \n  - `docker-archive`ï¼š    \n    - è¡¨ç¤º Docker é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£  \n  - `dir`ï¼š    \n    - æœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•ï¼Œå…¶ä¸­ä»¥å•ä¸ªæ–‡ä»¶çš„æ–¹å¼åŒ…å«é•œåƒçš„ `manifest`ã€é•œåƒå±‚ tar å½’æ¡£ä¸å„é•œåƒå±‚ç­¾åï¼ˆ`digest`ï¼‰ã€‚  \n  - `docker://`ï¼š    \n    - è¡¨ç¤ºå­˜å‚¨äºå®¹å™¨é•œåƒä»“åº“ä¸­çš„è¿œç¨‹å®¹å™¨é•œåƒ\n    - å¯é€šè¿‡ `Docker Registry HTTP API V2` æ“ä½œä»“åº“ä¸­çš„å®¹å™¨é•œåƒ\n- åŒä¸€å®¹å™¨é•œåƒå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯ä½¿ç”¨ä»¥ä¸Šä¸åŒçš„æ–¹å¼ä¿å­˜ã€‚\n> ğŸ‘‰ å…³äº Skopeo æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒ `man skopeo` æ‰‹å†Œã€‚\n\n### ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒï¼š\n- Skopeo ä¸ä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æ™®é€šç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ï¼Œæ¯” Podman ä½¿ç”¨ tagã€pull ä¸ push ç­‰å­å‘½ä»¤æ—¶æ›´åŠ çš„é«˜æ•ˆã€‚\n- ğŸ³ è‹¥ä½¿ç”¨ docker æˆ– podman å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒä¿å­˜äºæœ¬åœ°å­˜å‚¨ï¼Œéœ€åˆ†åˆ«ä½¿ç”¨ docker pull|save ä¸ podman pull|save å‘½ä»¤å°†æœ¬åœ°é•œåƒç¼“å­˜ä¸­çš„é•œåƒä¿å­˜äº tar å½’æ¡£ï¼Œæ— æ³•ä»å®¹å™¨é•œåƒä»“åº“ç›´æ¥ä¿å­˜äºæ–‡ä»¶æˆ–ç›®å½•ä¸­ï¼Œä¸‹æ–‡ä¸­æåŠçš„ `skopeo copy` æˆ– `sync` å­å‘½ä»¤å¯å®ç°è¯¥åŠŸèƒ½ï¼Œæ— éœ€å­˜åœ¨æœ¬åœ°é•œåƒç¼“å­˜ã€‚\n- ğŸš€ Skopeo æ“çºµé•œåƒå±‚çš„æ–¹å¼ï¼š  \n  - å‡ºäºæ•ˆç‡é—®é¢˜ï¼ŒSkopeo ä¸è¯»å–ä¸å‘é€å·²å­˜åœ¨äºç›®æ ‡ä»“åº“çš„é•œåƒå±‚ï¼Œå®ƒé¦–å…ˆè¯»å–æºé•œåƒçš„ manifestï¼Œå†ç¡®å®šå“ªäº›å±‚å·²å­˜åœ¨äºç›®æ ‡ä»“åº“ï¼Œç„¶åä»…ä»…æ‹·è´ç¼ºå¤±çš„é•œåƒå±‚ã€‚  \n  - è‹¥æ‹·è´æ¥è‡ªæ„å»ºäºåŒä¸€çˆ¶é•œåƒçš„é•œåƒï¼ŒSkopeo ä¸æ‹·è´å¤šä¸ªæ¥è‡ªäºçˆ¶é•œåƒçš„ç›¸åŒé•œåƒå±‚ã€‚  \n  - Skopeo å¯åœ¨å®¹å™¨é•œåƒä»“åº“ä¹‹é—´æ‹·è´é•œåƒè€Œä¸åœ¨æœ¬åœ°å®¹å™¨å­˜å‚¨ä¸­ä¿å­˜é•œåƒå±‚ç¼“å­˜ï¼Œè‹¥æºä»“åº“ä¸ç›®æ ‡ä»“åº“éœ€è¦è®¤è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ `--src-creds` ä¸ `--dest-creds` é€‰é¡¹æŒ‡å®šè®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶ä¸” Skopeo æ”¯æŒåœ¨ç›®æ ‡ä»“åº“å®ç°é•œåƒ `tag`ã€‚\n    ```bash\n    $ skopeo copy \\\n      --src-creds=<username>:<password> \\\n      --dest-creds=<username>:<password> \\\n      docker://<uri_for_src_registry>/<user_or_org>/<repository>:[tag] \\\n      docker://<uri_for_dest_registry>/<user_or_org>/<repository>:[tag]\n    # åˆ†åˆ«æŒ‡å®šæºä»“åº“ä¸ç›®æ ‡ä»“åº“çš„è®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶åœ¨ä»“åº“é—´æ‹·è´å®¹å™¨é•œåƒã€‚\n    ```\n    ![skopeo-copy-dest-creds.jpg](skopeo-copy-dest-creds.jpg)\n- `skopeo delete`ï¼šåˆ é™¤å®¹å™¨é•œåƒçš„é•œåƒ tag  \n  - è¯¥å‘½ä»¤å¯åˆ é™¤å®¹å™¨é•œåƒä»“åº“ä¸­æŒ‡å®šé•œåƒçš„ tag    \n    è‹¥åˆ é™¤å…¬å…±é•œåƒå¯ç›´æ¥æ‰§è¡Œæ— éœ€ç”¨æˆ·è®¤è¯ï¼Œè€Œåˆ é™¤ç§æœ‰å®¹å™¨é•œåƒéœ€ä½¿ç”¨ `--creds` é€‰é¡¹æˆ– `--authfile` é€‰é¡¹è¿›è¡Œè®¤è¯ååˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n    ```bash\n    $ skopeo delete --creds <username>:<password> \\\n      docker://<uri_for_registry>/<user_or_org>/<repository>:[tag]\n    ```\n  - ğŸ’¥ æŒ‡å®šé•œåƒ `tag` æ—¶å°†åˆ é™¤ç‰¹å®š tagï¼Œå³ä½¿å°†æœ€åä¸€ä¸ª tag åˆ é™¤åä¹Ÿä¸åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“ï¼Œè‹¥éœ€è¦åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“éœ€ç™»å½•æŒ‡å®šä»“åº“ã€‚æ­¤å¤„ä¸º Quay.io ä¸ºä¾‹ï¼Œåœ¨ `Web æ§åˆ¶å°` ä¸Šåˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-delete-1.jpg](skopeo-delete-1.jpg)![skopeo-delete-2.jpg](skopeo-delete-2.jpg) \n  - ğŸ’¥ è¯¥å‘½ä»¤ä¹Ÿå¯åˆ é™¤æœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„é•œåƒ tagï¼Œä½†éœ€æ³¨æ„ï¼Œè‹¥å…·æœ‰å¤šä¸ªä¸åŒ tag çš„å®¹å™¨é•œåƒï¼ˆå®é™…ä¸ºåŒä¸€å®¹å™¨é•œåƒï¼‰ï¼Œåªå…·æœ‰åŒä¸€ä¸ª image IDï¼ˆè¯¥å€¼æ¥è‡ªäºé•œåƒçš„ manifest ä¸­ `.config.digest`ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œåˆ é™¤æ—¶å³ä½¿æŒ‡å®šäº†é•œåƒçš„ tagï¼Œä¹Ÿä¼šå°†å…¶ä»–å…·æœ‰ç›¸åŒ image ID çš„é•œåƒä¸€å¹¶åˆ é™¤ï¼Œè¯¥è¡Œä¸ºä¸å®¹å™¨é•œåƒä»“åº“ä¸­ç›¸åŒºåˆ«ï¼\n- `skopeo copy`ï¼šdir æ¨¡å¼ç¤ºä¾‹\n  > ğŸ’¥ Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°é•œåƒç›®å½•ï¼ˆè¯¥ç›®å½•æ— éœ€æå‰åˆ›å»ºï¼‰ï¼Œè¯¥ç›®å½•ä¸­çš„é•œåƒå°è£…æ ¼å¼ä¿ç•™åŸå§‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒæ ¼å¼ã€‚\n\n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    dir:<dir_of_container_image>\n  ```\n  ![skopeo-copy-docker-format-image-dir.jpg](skopeo-copy-docker-format-image-dir.jpg)é™¤äº†ä½¿ç”¨ docker load æˆ– podman load ç›´æ¥å°†å®¹å™¨é•œåƒçš„ tar å½’æ¡£å¯¼å…¥æœ¬åœ°é•œåƒç¼“å­˜ä¸­ï¼Œä¹Ÿå¯ä½¿ç”¨å·²ç»ä¿å­˜è‡³æœ¬åœ°çš„ç›®å½•ä»¥ dir æˆ– oci æ¨¡å¼å­˜åœ¨çš„å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![podman-load-dir-from-skopeo-copy.jpg](podman-load-dir-from-skopeo-copy.jpg)\n  \n  ä¹Ÿå¯ä»¥ä½¿ç”¨ Skopeo å°†æœ¬åœ°é•œåƒç›®å½•æ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ï¼Œç”¨ä»¥æ›¿ä»£ docker push æˆ– podman push çš„åŠŸèƒ½ï¼š\n  ```bash\n  $ skopeo copy \\\n    dir:<dir_of_container_image> \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag]\n  ```\n  ![skopeo-copy-dir-2.jpg](skopeo-copy-dir-2.jpg)\n- `skopeo copy`ï¼šoci æ¨¡å¼ç¤ºä¾‹\n  Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ° `OCI` æ ¼å¼ç›®å½•ä¸­ä»¥å­˜å‚¨é•œåƒï¼š\n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    oci:<dir_of_container_image>\n  ```\n  ![skopeo-copy-oci-1.jpg](skopeo-copy-oci-1.jpg)å…¶ä¸­æ‹·è´è‡³æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…å«äº†å®¹å™¨é•œåƒçš„å„å±‚ï¼ˆlayerï¼‰ã€‚\n  ![skopeo-copy-oci-2.jpg](skopeo-copy-oci-2.jpg)ä¹Ÿå¯ä½¿ç”¨æœ¬åœ° OCI æ ¼å¼ç›®å½•å°†é•œåƒæ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚\n- `skopeo copy`ï¼šoci-archive æ¨¡å¼ç¤ºä¾‹  \n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    oci-archive:<oci_contaier_image_name>.tar\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ OCI é•œåƒæ ¼å¼çš„é•œåƒ\n  ```\n- `skopeo copy`ï¼šcontainers-storage æ¨¡å¼ç¤ºä¾‹  \n  \n  > ğŸ’¥ è¯¥æ¨¡å¼åªèƒ½åœ¨ä»¥ Podman æˆ– CRI-O ä¸ºå®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè‹¥ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶å°†æŠ¥é”™ï¼\n\n  ![skopeo-copy-docker-daemon.jpg](skopeo-copy-docker-daemon.jpg)  \n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    containers-storage:<uri_for_registry>/<user_or_org>/<repository>:[tag]\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜\n  ```\n- `skopeo copy`ï¼šdocker-archive æ¨¡å¼ç¤ºä¾‹  \n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    docker-archive:<docker_contaier_image_name>.tar\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ Docker é•œåƒæ ¼å¼çš„é•œåƒ\n  ```\n- `skopeo copy`ï¼šdocker-daemon æ¨¡å¼ç¤ºä¾‹\n\n  > ğŸ’¥ è¯¥æ¨¡å¼åœ¨ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚\n\n  ```bash\n  $ skopeo copy \\\n    docker://<uri_for_registry>/<user_or_org>/<repository>:[tag] \\\n    docker-daemon:<uri_for_registry>/<user_or_org>/<repository>:[tag]\n  # å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜\n  ```\n- ğŸš€ Skopeo å¯¹å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼š  \n  - ä½¿ç”¨ skopeo copy å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°ç›®å½•æˆ–æœ¬åœ° tar å½’æ¡£å­˜å‚¨æ—¶ï¼Œå¯åˆ†åˆ«ä»¥ Docker é•œåƒæ ¼å¼æˆ– OCI é•œåƒæ ¼å¼ä¿å­˜ã€‚  \n  - å› æ­¤ï¼Œskopeo copy å‘½ä»¤å¯åŒæ—¶å®Œæˆå®¹å™¨é•œåƒçš„ä¸‹è½½ä¸é•œåƒæ ¼å¼çš„è½¬æ¢ã€‚  \n  - å¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-copy-transform-image-format.jpg](skopeo-copy-transform-image-format.jpg)\n- `skopeo sync`ï¼š  \n  - sync å­å‘½ä»¤å°†å®¹å™¨é•œåƒä» src æºåŒæ­¥è‡³ dest ç›®çš„åœ°ï¼ŒåŠŸèƒ½ä¸ copy å­å‘½ä»¤ç±»ä¼¼ã€‚  \n  - skopeo sync å‘½ä»¤å¯æŒ‡å®šçš„ src ä¸ dest ç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-sync-help.jpg](skopeo-sync-help.jpg)\n  - ğŸ‘‰ ç¤ºä¾‹ 1ï¼š    \n    å°†è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåŒæ­¥è‡³æœ¬åœ°ç›®å½•ï¼Œæœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•æ— éœ€åˆ›å»ºã€‚![skopeo-sync-demo.jpg](skopeo-sync-demo.jpg)\n  - ğŸ‘‰ ç¤ºä¾‹ 2ï¼š    \n    skopeo å‘½ä»¤åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªå®¹å™¨é•œåƒä»“åº“çš„ token è®¤è¯æ–‡ä»¶å°†å®¹å™¨é•œåƒåŒæ­¥è‡³å¦ä¸€ä¸ªä»“åº“ä¸­ï¼Œå¹¶ä¸”ç›®æ ‡ä»“åº“åªéœ€æŒ‡å®šä»“åº“ `URI` å³å¯ï¼Œå°†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„é•œåƒåç§°ä¸æ ‡ç­¾ã€‚![skopeo-sync-between-registry.jpg](skopeo-sync-between-registry.jpg)\n  - ä¹Ÿå¯ä½¿ç”¨ skopeo sync å‘½ä»¤å°†æœ¬åœ° dir æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒåŒæ­¥è‡³è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚\n- `skopeo inspect` ä¸ `skopeo manifest-digest`ï¼š\n  - è¯¥å‘½ä»¤ç”¨äºæŸ¥çœ‹è¯¦ç»†çš„å®¹å™¨é•œåƒå±‚ä¿¡æ¯ï¼ˆimage manifestï¼‰æˆ–å®¹å™¨é•œåƒçš„é…ç½®ä¿¡æ¯ï¼ˆimage configï¼‰ã€‚  \n  - ğŸ³ image manifest åŒ…å«å„é•œåƒå±‚çš„ `mediaType`ã€`size`ã€`digest`ï¼Œè€Œ image config åŒ…å«é•œåƒçš„å…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚  \n  - ğŸ‘‰ ç¤ºä¾‹ 1ï¼šDocker é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•    \n    å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨ `dir` æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒä½äº nexus3-3.37.3 ç›®å½•ä¸­ï¼Œå¯ç›´æ¥ä½¿ç”¨ `jq` å‘½ä»¤æŸ¥çœ‹è¯¥é•œåƒçš„ image manifest ä¸ image configï¼š    \n    ```bash\n    ### ç¤ºä¾‹ï¼ˆä»¥ä¸‹å†…å®¹ä¸ºéƒ¨åˆ†è¾“å‡ºï¼‰ ###\n    $ jq '.' nexus3-3.37.3/manifest.json\n    {\n      \"schemaVersion\": 2,\n      \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n      \"config\": {\n        \"mediaType\": \"application/vnd.docker.container.image.v1+json\",\n        \"size\": 10193,\n        \"digest\": \"sha256:1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd\"\n      },\n      \"layers\": [\n        {\n          \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n          \"size\": 81522888,\n          \"digest\": \"sha256:8dfe9326f733b815c486432e93e0a97f03e90e7cc35def9511cd1efa7f917f56\"\n        },\n        ...\n      ]\n    }\n    # æ ¹æ® dir ç›®å½•ä¸­çš„ manifest æŸ¥çœ‹å®¹å™¨é•œåƒåŠå„é•œåƒå±‚ä¿¡æ¯\n    \n    $ jq '.' nexus3-3.37.3/1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd\n    {\n      \"architecture\": \"amd64\",\n      \"config\": {\n        \"Hostname\": \"bb4a731bd39e\",\n        \"Domainname\": \"\",\n        \"User\": \"nexus\",\n        ...\n        \"ExposedPorts\": {\n          \"8081/tcp\": {}\n        },\n        \"Tty\": false,\n        \"OpenStdin\": false,\n        \"StdinOnce\": false,\n        \"Env\": [\n          \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\",\n          \"container=oci\",\n          \"SONATYPE_DIR=/opt/sonatype\",\n          \"NEXUS_HOME=/opt/sonatype/nexus\",\n          \"NEXUS_DATA=/nexus-data\",\n          \"NEXUS_CONTEXT=\",\n          \"SONATYPE_WORK=/opt/sonatype/sonatype-work\",\n          \"DOCKER_TYPE=3x-docker\",\n          \"INSTALL4J_ADD_VM_PARAMS=-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=/nexus-data/javaprefs\"\n        ],\n        \"Cmd\": [\n          \"sh\",\n          \"-c\",\n          \"${SONATYPE_DIR}/start-nexus-repository-manager.sh\"\n        ],\n        \"Image\": \"sha256:bb968737b5d0d7420e5af7c5524cddc16bd2b43a47f8277e00b1461342d40ba5\",\n        \"Volumes\": {\n          \"/nexus-data\": {}\n        },\n      ...\n      },\n      \"created\": \"2022-03-02T23:52:49.682473465Z\",\n      \"docker_version\": \"20.10.9\",\n      \"history\": [\n        {\n          \"created\": \"2022-02-25T17:39:29.754401796Z\",\n          \"comment\": \"Imported from -\"\n        },\n        ...\n        {\n          \"created\": \"2022-03-02T23:52:49.682473465Z\",\n          \"created_by\": \"/bin/sh -c #(nop)  CMD [\\\"sh\\\" \\\"-c\\\" \\\"${SONATYPE_DIR}/start-nexus-repository-manager.sh\\\"]\",\n          \"empty_layer\": true\n        }\n      ],\n      \"os\": \"linux\",\n      \"rootfs\": {\n        \"type\": \"layers\",\n        \"diff_ids\": [\n          \"sha256:7699752e6ed63eef234d2736d4e37159a433e18e06cd617e254299f324f41797\",\n          \"sha256:c8013a2772b6673d9b750b6407d4ac4f525a47bb2a5b5bf09ba9bf8e10aea3fc\",\n          \"sha256:5a745ebef99f4893aac7c56a26e54f9c6cdc08b02748e0580b1a31d70be0a280\",\n          \"sha256:8d12fc82bf58bf5f7958577a148cc05899f0c19e4654376f5e01d3af46eb0c15\",\n          \"sha256:d17e45a4f748d13d0501b9e1bca5be387e13efa8ce98147a85c904a348764f3b\"\n        ]\n      }\n    }\n    # æ ¹æ®å®¹å™¨é•œåƒç›®å½•ä¸­çš„ config æ–‡ä»¶æŸ¥çœ‹å…·ä½“çš„ image config \n    ```\n    ```bash\n    $ skopeo inspect dir:nexus3-3.37.3\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„æ¦‚è¦ä¿¡æ¯\n    \n    $ skopeo inspect --raw dir:nexus3-3.37.3\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸é•œåƒçš„ manifest.json ä¸€è‡´ã€‚\n    \n    $ skopeo inspect --config dir:nexus3-3.37.3\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ config ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸ç›´æ¥æŸ¥çœ‹é•œåƒçš„é…ç½®ä¿¡æ¯ä¸€è‡´ã€‚\n    \n    $ skopeo manifest-digest nexus3-3.37.3/manifest.json\n    # æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest.json æ–‡ä»¶çš„ digest å€¼\n    ```\n    å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ `image manifest` ä¸å…¶ `digest` çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-docker-image-format-digest-1.jpg](skopeo-docker-image-format-digest-1.jpg)![skopeo-docker-image-format-digest-2.jpg](skopeo-docker-image-format-digest-2.jpg)\n  - ğŸ‘‰ ç¤ºä¾‹ 2ï¼šOCI é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•    \n    å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ `image manifest` ä¸å…¶ `digest` çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![skopeo-oci-image-format-digest.jpg](skopeo-oci-image-format-digest.jpg)\n\n### ğŸ³ å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\n- å¯¹äºä¸åŒçš„å®¹å™¨é•œåƒæ ¼å¼ï¼Œå…¶ç›®å½•çš„ç»„ç»‡ç»“æ„å­˜åœ¨å·®å¼‚ï¼Œä½†å½¼æ­¤é—´åˆæœ‰è”ç³»ã€‚\n- ç›®å‰é‡‡ç”¨çš„å®¹å™¨é•œåƒæ ¼å¼ï¼š  \n  - `Docker image format`ï¼šDocker é•œåƒæ ¼å¼  \n  - `OCI image format`ï¼šOCI é•œåƒæ ¼å¼\n- OCI image format ç»§æ‰¿äº Docker image formatï¼Œå› æ­¤ï¼Œå¯è¿è¡Œ OCI image format é•œåƒçš„å®¹å™¨è¿è¡Œæ—¶ä¹Ÿå¯è¿è¡Œ Docker image format çš„é•œåƒã€‚\n- `OCI`ï¼ˆOpen Container Initiativeï¼Œå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰å‘å±•æ¦‚è¿°ï¼š\n  - ä¸ºäº†æ¨è¿›å®¹å™¨åŒ–æŠ€æœ¯çš„å·¥ä¸šæ ‡å‡†åŒ–ï¼Œ2015 å¹´ 6 æœˆåœ¨ `DockerCon` ä¸Š Linux åŸºé‡‘ä¼šä¸ Googleã€åä¸ºã€æƒ æ™®ã€IBMã€Dockerã€Red Hatã€VMware ç­‰å…¬å¸å…±åŒå®£å¸ƒæˆç«‹å¼€æ”¾å®¹å™¨é¡¹ç›®ï¼ˆOCPï¼‰ï¼Œåæ›´åä¸ºå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼ˆOCIï¼‰ã€‚  \n  - å®ƒçš„ä¸»è¦ç›®æ ‡æ˜¯å»ºç«‹å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶çš„å·¥ä¸šå¼€æ”¾é€šç”¨æ ‡å‡†ã€‚  \n  - ä¸ºäº†æ”¯æŒ OCI å®¹å™¨è¿è¡Œæ—¶æ ‡å‡†çš„æ¨è¿›ï¼ŒDocker å…¬å¸èµ·è‰äº†é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶è§„èŒƒçš„è‰æ¡ˆï¼Œå¹¶å°† Docker é¡¹ç›®çš„ç›¸å…³å®ç°æçŒ®ç»™äº†ç¤¾åŒºï¼ŒOCI ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„åŸºç¡€å®ç°ï¼Œç°åœ¨é¡¹ç›®åä¸º `runc`ã€‚\n- ğŸ¤˜ å‘å±•è‡³ä»Šï¼ŒOCI åˆ¶å®šçš„ä¸»è¦æ ‡å‡†ï¼š  \n  - `runtime-spec`ï¼šå®šä¹‰å®¹å™¨è¿è¡Œæ—¶è§„èŒƒ  \n  - `image-spec`ï¼šå®šä¹‰å®¹å™¨é•œåƒæ ¼å¼è§„èŒƒ  \n  - `distribution-spec`ï¼šå®šä¹‰å®¹å™¨é•œåƒçš„åˆ†å‘è§„èŒƒ\n- OCI image format ç›®å½•è¯´æ˜ï¼š  \n  - å¦‚ä¸‹æ‰€ç¤ºï¼Œä»¥ `debian` é•œåƒä¸ºä¾‹ï¼š    \n    ```bash\n    $ tree debian-bullseye-20211115-oci\n    debian-bullseye-20211115-oci\n    â”œâ”€â”€ blobs\n    â”‚   â””â”€â”€ sha256\n    â”‚       â”œâ”€â”€ 468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\n    â”‚       â”œâ”€â”€ 5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6\n    â”‚       â””â”€â”€ 61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad\n    â”œâ”€â”€ index.json\n    â””â”€â”€ oci-layout\n    ```\n  - oci-layoutï¼šOCI image çš„é•œåƒå¸ƒå±€è§„èŒƒï¼Œæ­¤å¤„ä½¿ç”¨ `OCI 1.0.0` ç‰ˆæœ¬ã€‚\n    ```bash\n    $ jq '.' debian-bullseye-20211115-oci/oci-layout\n    {\n      \"imageLayoutVersion\": \"1.0.0\"\n    }\n    ```\n  - index.jsonï¼š    \n    - `index.json`Â æ–‡ä»¶ä¸­çš„Â `manifests`Â å­—æ®µç±»ä¼¼äº Docker image ä¸­çš„Â `manifest.json` ä½œä¸º OCI image çš„é¡¶çº§é…ç½®, ä¹Ÿæ˜¯é•œåƒçš„ä¸€ä¸ªå…¥å£é…ç½®ã€‚  \n    - è¯¥æ–‡ä»¶å®é™…æŒ‡å‘ `blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b` ï¼Œå³çœŸæ­£çš„ OCI image manifest æ–‡ä»¶ã€‚\n      ```bash\n      $ jq '.' debian-bullseye-20211115-oci/index.json\n      {\n        \"schemaVersion\": 2,\n        \"manifests\": [\n          {\n            \"mediaType\": \"application/vnd.oci.image.manifest.v1+json\",\n            \"digest\": \"sha256:468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\",\n            \"size\": 349\n          }\n        ]\n      }\n      ```\n    - ä»è¯¥æ–‡ä»¶çš„ `mediaType` å¯ä»¥çœ‹å‡ºå®¹å™¨é•œåƒæ ¼å¼å·²å‘ç”Ÿçš„å˜åŒ–ï¼š\n      ```bash\n      $ jq '.mediaType' debian-bullseye-20211115-docker/manifest.json\n      \"application/vnd.docker.distribution.manifest.v2+json\"\n      # Docker image format å°è£…\n      \n      $ jq '.manifests[0].mediaType' debian-bullseye-20211115-oci/index.json\n      \"application/vnd.oci.image.manifest.v1+json\"\n      # OCI image format å°è£… \n      ```\n      ```bash\n      $ jq '.' debian-bullseye-20211115-oci/blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\n      {\n        \"schemaVersion\": 2,\n        \"config\": {\n          \"mediaType\": \"application/vnd.oci.image.config.v1+json\",\n          \"digest\": \"sha256:61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad\",\n          \"size\": 579\n        },\n        \"layers\": [\n          {\n            \"mediaType\": \"application/vnd.oci.image.layer.v1.tar+gzip\",\n            \"digest\": \"sha256:5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6\",\n            \"size\": 56889206\n          }\n        ]\n      }\n      ```\n      ä»¥ä¸Šæ–‡ä»¶ä¸º OCI image manifest æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« image config çš„ä¿¡æ¯ä¸å„é•œåƒå±‚ Layers çš„ä¿¡æ¯ï¼Œæ¯å±‚ layer ä½¿ç”¨ `tar+gzip` çš„æ–¹å¼è¿›è¡Œå‹ç¼©ã€‚\n- Docker image format ä¸ OCI image format çš„è”ç³»ä¸åŒºåˆ«ï¼š  \n  - æœ€ä¸»è¦çš„åŒºåˆ«ï¼šç›®å½•ç»“æ„ä¸å®Œå…¨ç›¸åŒï¼Œé…ç½®ä¿¡æ¯å°¤å…¶æ˜¯Â `mediaType`Â çš„è§„èŒƒä¸åŒã€‚  \n  - è”ç³»ï¼šOCI image çš„è§„èŒƒæ˜¯ç”± Docker image çš„è§„èŒƒä¿®æ”¹è€Œæ¥ï¼Œæ‰€ä»¥ç±»ä¼¼å®ƒä»¬çš„ blob çš„ç»„ç»‡å½¢å¼å¤§è‡´ç›¸åŒï¼Œé…ç½®æ–‡ä»¶ä¸­å¾ˆå¤šçš„å‚æ•°ä¹Ÿç›¸ä¼¼ã€‚  \n  - å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ skopeo å·¥å…·å¾ˆæ–¹ä¾¿åœ°å°† Docker image è½¬æ¢ä¸º OCI imageã€‚\n\n### å‚è€ƒé“¾æ¥ï¼š\n- [GitHub Doc - Skopeo](https://github.com/containers/skopeo)\n- [é•œåƒæ¬è¿å·¥å…· Skopeo ä½¿ç”¨](https://mp.weixin.qq.com/s/J2b-PQD5GkN5KEmGB2WAeA)\n- [OCI ä¸å®¹å™¨é•œåƒæ„å»º](https://mp.weixin.qq.com/s/8wAv87DkJjE6fVEEmoQ60Q)\n- [GitHub Doc - opencontainers/image-spec](https://github.com/opencontainers/image-spec)\n- [GitHub Doc - OCI Image Media Types](https://github.com/opencontainers/image-spec/blob/main/media-types.md)\n- [GitHub Doc - Open Container Initiative Runtime Specification](https://github.com/opencontainers/runtime-spec/blob/main/spec.md)","slug":"skopeo-basic-usage","published":1,"updated":"2022-12-06T05:33:17.881Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonoso001p16vdx2hmxdxp","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼šUbuntu 20.04.3 LTS (Focal Fossa)</li>\n<li>skopeo ç‰ˆæœ¬ï¼š1.3.0-1</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Skopeo å·¥å…·æ¦‚è¦</li>\n<li>ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“</li>\n<li>Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼</li>\n<li>ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒ</li>\n<li>å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒ</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"Skopeo-å·¥å…·æ¦‚è¦ï¼š\"><a href=\"#Skopeo-å·¥å…·æ¦‚è¦ï¼š\" class=\"headerlink\" title=\"Skopeo å·¥å…·æ¦‚è¦ï¼š\"></a>Skopeo å·¥å…·æ¦‚è¦ï¼š</h3><ul>\n<li>å¸¸ç”¨çš„å®¹å™¨é•œåƒæ“ä½œå·¥å…·å¯ä½¿ç”¨ dockerã€podman å‘½ä»¤ï¼Œä½† docker å‘½ä»¤è¡Œå·¥å…·éœ€è¦ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸ root ç”¨æˆ·æƒé™ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å·¥å…·åŒæ­¥å®¹å™¨é•œåƒçš„æ•ˆç‡æ˜¯è¾ƒä½çš„ï¼Œè€Œ podman å‘½ä»¤è™½ç„¶ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼Œä½†æ˜¯å…¶åŒæ­¥é•œåƒæ•ˆç‡ä¾ç„¶ä¸é«˜ã€‚</li>\n<li>skopeo ä¸ buildah å‘½ä»¤å¯ä¸“é—¨ç”¨äºå®¹å™¨é•œåƒçš„æ“ä½œï¼Œå…¶ä¸­ skopeo å‘½ä»¤æ›´åŠ çº¯ç²¹åœ°ç”¨äºå®¹å™¨é•œåƒçš„æ¬è¿ä¸å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼Œæ•ˆç‡è¾ƒå…¶ä»–å·¥å…·æ›´é«˜ï¼Œä½†æ˜¯ä¸å…·æœ‰å®¹å™¨é•œåƒæ„å»ºçš„èƒ½åŠ›ã€‚</li>\n<li>Podman æ›´åŠ ä¾§é‡äºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶å…·å¤‡éƒ¨åˆ†å®¹å™¨é•œåƒç®¡ç†ä¸æ„å»ºåŠŸèƒ½ï¼Œè€Œ Buildah æ”¯æŒåˆ†åˆ«ä½¿ç”¨å‘½ä»¤è¡Œä»å¤´æ„å»ºå®¹å™¨é•œåƒä¸ <code>Dockerfile</code> æˆ– <code>Containerfile</code> çš„æ„å»ºæ–¹å¼ï¼ŒåŒæ—¶å…¼å®¹ Docker ä¸ OCI é•œåƒæ ¼å¼ã€‚<blockquote>\n<p>ğŸ‘‰ å…³äº Podman æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒä¹‹å‰å†™çš„ <a href=\"https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/\">Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ1ï¼‰</a>ä¸ <a href=\"https://alberthua-perl.github.io/2022/12/05/podman-usage-practice/\">Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ2ï¼‰</a>ã€‚</p>\n</blockquote>\n</li>\n<li>Skopeo å®‰è£…æ–¹æ³•å¯å‚è€ƒ <a href=\"https://github.com/containers/skopeo/blob/main/install.md\" target=\"_blank\" rel=\"noopener\">è¯¥ GitHub é“¾æ¥</a>ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</li>\n<li>skopeo å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼š  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo --<span class=\"built_in\">help</span></span><br><span class=\"line\">Various operations with container images and container image registries</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">  skopeo [<span class=\"built_in\">command</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">Available Commands:</span><br><span class=\"line\">  copy                                          Copy an IMAGE-NAME from one location to another</span><br><span class=\"line\">  delete                                        Delete image IMAGE-NAME</span><br><span class=\"line\">  <span class=\"built_in\">help</span>                                          Help about any <span class=\"built_in\">command</span></span><br><span class=\"line\">  inspect                                       Inspect image IMAGE-NAME</span><br><span class=\"line\">  list-tags                                     List tags <span class=\"keyword\">in</span> the transport/repository specified by the REPOSITORY-NAME</span><br><span class=\"line\">  login                                         Login to a container registry</span><br><span class=\"line\">  <span class=\"built_in\">logout</span>                                        Logout of a container registry</span><br><span class=\"line\">  manifest-digest                               Compute a manifest digest of a file</span><br><span class=\"line\">  standalone-sign                               Create a signature using <span class=\"built_in\">local</span> files</span><br><span class=\"line\">  standalone-verify                             Verify a signature using <span class=\"built_in\">local</span> files</span><br><span class=\"line\">  sync                                          Synchronize one or more images from one location to another</span><br><span class=\"line\"></span><br><span class=\"line\">Flags:</span><br><span class=\"line\">      --<span class=\"built_in\">command</span>-timeout duration   timeout <span class=\"keyword\">for</span> the <span class=\"built_in\">command</span> execution</span><br><span class=\"line\">      --debug                      <span class=\"built_in\">enable</span> debug output</span><br><span class=\"line\">  -h, --<span class=\"built_in\">help</span>                       <span class=\"built_in\">help</span> <span class=\"keyword\">for</span> skopeo</span><br><span class=\"line\">      --insecure-policy            run the tool without any policy check</span><br><span class=\"line\">      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class=\"keyword\">for</span> choosing images</span><br><span class=\"line\">      --override-os OS             use OS instead of the running OS <span class=\"keyword\">for</span> choosing images</span><br><span class=\"line\">      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class=\"keyword\">for</span> choosing images</span><br><span class=\"line\">      --policy string              Path to a trust policy file</span><br><span class=\"line\">      --registries.d DIR           use registry configuration files <span class=\"keyword\">in</span> DIR (e.g. <span class=\"keyword\">for</span> container signature storage)</span><br><span class=\"line\">      --tmpdir string              directory used to store temporary files</span><br><span class=\"line\">  -v, --version                    Version <span class=\"keyword\">for</span> Skopeo</span><br><span class=\"line\"></span><br><span class=\"line\">Use <span class=\"string\">\"skopeo [command] --help\"</span> <span class=\"keyword\">for</span> more information about a <span class=\"built_in\">command</span>.</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"ä½¿ç”¨-Skopeo-è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\"><a href=\"#ä½¿ç”¨-Skopeo-è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\" class=\"headerlink\" title=\"ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\"></a>ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š</h3><ul>\n<li>Red Hat æ”¯æŒ <code>skopeo</code> å‘½ä»¤æ¥ç®¡ç†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒã€‚</li>\n<li>Skopeo å¯åˆ†åˆ«ç”¨äºæ“ä½œå…¬å…±ï¼ˆpublicï¼‰ä¸ç§æœ‰ï¼ˆprivateï¼‰å®¹å™¨é•œåƒï¼Œå¯¹äºç§æœ‰å®¹å™¨é•œåƒéœ€è¦å¯¹å®¹å™¨é•œåƒä»“åº“è¿›è¡Œè®¤è¯ã€‚</li>\n<li>Skopeo ä¸ Buildah å¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ <code>token</code>ï¼ˆä½äº <code>/run/user/&lt;UID&gt;/containers/auth.json</code>ï¼‰ï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ï¼Œå› æ­¤ï¼Œè‹¥åœ¨ skopeo å‘½ä»¤è¡Œä¸­æŒ‡å®šæ˜æ–‡ç™»å½•å¯†ç å¯åœ¨ history å‘½ä»¤å†å²è®°å½•ä¸­æŸ¥çœ‹åˆ°ï¼Œå­˜åœ¨ä¸€å®šçš„å®‰å…¨é£é™©ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹ä»¥å˜é‡å½¢å¼ä¼ é€’å¯†ç çš„æ–¹æ³•ä¼˜åŒ–ï¼š<img src=\"skopeo-inspect-creds.jpg\" alt=\"skopeo-inspect-creds.jpg\"><blockquote>\n<p>è‹¥æœªä½¿ç”¨ Podman ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä¾ç„¶ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„è¯ï¼Œå…¶è®¤è¯ token ä¾ç„¶å¯è¢« Skopeo ä½¿ç”¨ä¸è®¤è¯ï¼Œè¯¥è®¤è¯ token ä½äº <code>$HOME/.docker/config.json</code>ã€‚</p>\n</blockquote>\n</li>\n<li>Skopeo çš„ä¼—å¤šå­å‘½ä»¤æ”¯æŒå®¹å™¨é•œåƒä»“åº“çš„è®¤è¯ï¼Œå¯åˆ†åˆ«é€šè¿‡ç”¨æˆ·åä¸å¯†ç åŠè®¤è¯çš„ token æ–‡ä»¶å®ç°è®¤è¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ skopeo copy --src-creds &lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\</span><br><span class=\"line\">  oci:postgresql-96-rhel7-latest</span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo copy --src-authfile /run/user/&lt;UID&gt;/containers/auth.json \\</span><br><span class=\"line\">  docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\</span><br><span class=\"line\">  oci:postgresql-96-rhel7-latest</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"Skopeo-æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\"><a href=\"#Skopeo-æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\" class=\"headerlink\" title=\"Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\"></a>Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š</h3><ul>\n<li>Skopeo ä½¿ç”¨ <code>URI</code> æ¥è¡¨ç¤ºå®¹å™¨é•œåƒçš„ä½ç½®ï¼Œä½¿ç”¨ URI æ¨¡å¼ï¼ˆschemaï¼‰æ¥è¡¨ç¤ºå®¹å™¨é•œåƒæ ¼å¼å’Œregistry APIsã€‚</li>\n<li>å¸¸è§çš„ URI æ¨¡å¼ï¼š  <ul>\n<li><code>oci</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨åœ¨æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ä¸­çš„å®¹å™¨é•œåƒ    </li>\n<li>è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒï¼ˆ<code>Open Container Image Layout Specification</code>ï¼‰  </li>\n</ul>\n</li>\n<li><code>oci-archive</code>ï¼š    <ul>\n<li>è¡¨ç¤º OCI é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£    </li>\n<li>è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒ  </li>\n</ul>\n</li>\n<li><code>containers-storage</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ    </li>\n<li>åç«¯å®¹å™¨å¼•æ“å…¼å®¹ Podmanã€CRI-O ä¸ Buildah  </li>\n</ul>\n</li>\n<li><code>docker-daemon</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ° Docker å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ  </li>\n</ul>\n</li>\n<li><code>docker-archive</code>ï¼š    <ul>\n<li>è¡¨ç¤º Docker é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£  </li>\n</ul>\n</li>\n<li><code>dir</code>ï¼š    <ul>\n<li>æœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•ï¼Œå…¶ä¸­ä»¥å•ä¸ªæ–‡ä»¶çš„æ–¹å¼åŒ…å«é•œåƒçš„ <code>manifest</code>ã€é•œåƒå±‚ tar å½’æ¡£ä¸å„é•œåƒå±‚ç­¾åï¼ˆ<code>digest</code>ï¼‰ã€‚  </li>\n</ul>\n</li>\n<li><code>docker://</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨äºå®¹å™¨é•œåƒä»“åº“ä¸­çš„è¿œç¨‹å®¹å™¨é•œåƒ</li>\n<li>å¯é€šè¿‡ <code>Docker Registry HTTP API V2</code> æ“ä½œä»“åº“ä¸­çš„å®¹å™¨é•œåƒ</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>åŒä¸€å®¹å™¨é•œåƒå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯ä½¿ç”¨ä»¥ä¸Šä¸åŒçš„æ–¹å¼ä¿å­˜ã€‚<blockquote>\n<p>ğŸ‘‰ å…³äº Skopeo æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒ <code>man skopeo</code> æ‰‹å†Œã€‚</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"ä½¿ç”¨-Skopeo-æ“ä½œå®¹å™¨é•œåƒï¼š\"><a href=\"#ä½¿ç”¨-Skopeo-æ“ä½œå®¹å™¨é•œåƒï¼š\" class=\"headerlink\" title=\"ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒï¼š\"></a>ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒï¼š</h3><ul>\n<li>Skopeo ä¸ä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æ™®é€šç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ï¼Œæ¯” Podman ä½¿ç”¨ tagã€pull ä¸ push ç­‰å­å‘½ä»¤æ—¶æ›´åŠ çš„é«˜æ•ˆã€‚</li>\n<li>ğŸ³ è‹¥ä½¿ç”¨ docker æˆ– podman å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒä¿å­˜äºæœ¬åœ°å­˜å‚¨ï¼Œéœ€åˆ†åˆ«ä½¿ç”¨ docker pull|save ä¸ podman pull|save å‘½ä»¤å°†æœ¬åœ°é•œåƒç¼“å­˜ä¸­çš„é•œåƒä¿å­˜äº tar å½’æ¡£ï¼Œæ— æ³•ä»å®¹å™¨é•œåƒä»“åº“ç›´æ¥ä¿å­˜äºæ–‡ä»¶æˆ–ç›®å½•ä¸­ï¼Œä¸‹æ–‡ä¸­æåŠçš„ <code>skopeo copy</code> æˆ– <code>sync</code> å­å‘½ä»¤å¯å®ç°è¯¥åŠŸèƒ½ï¼Œæ— éœ€å­˜åœ¨æœ¬åœ°é•œåƒç¼“å­˜ã€‚</li>\n<li><p>ğŸš€ Skopeo æ“çºµé•œåƒå±‚çš„æ–¹å¼ï¼š  </p>\n<ul>\n<li>å‡ºäºæ•ˆç‡é—®é¢˜ï¼ŒSkopeo ä¸è¯»å–ä¸å‘é€å·²å­˜åœ¨äºç›®æ ‡ä»“åº“çš„é•œåƒå±‚ï¼Œå®ƒé¦–å…ˆè¯»å–æºé•œåƒçš„ manifestï¼Œå†ç¡®å®šå“ªäº›å±‚å·²å­˜åœ¨äºç›®æ ‡ä»“åº“ï¼Œç„¶åä»…ä»…æ‹·è´ç¼ºå¤±çš„é•œåƒå±‚ã€‚  </li>\n<li>è‹¥æ‹·è´æ¥è‡ªæ„å»ºäºåŒä¸€çˆ¶é•œåƒçš„é•œåƒï¼ŒSkopeo ä¸æ‹·è´å¤šä¸ªæ¥è‡ªäºçˆ¶é•œåƒçš„ç›¸åŒé•œåƒå±‚ã€‚  </li>\n<li><p>Skopeo å¯åœ¨å®¹å™¨é•œåƒä»“åº“ä¹‹é—´æ‹·è´é•œåƒè€Œä¸åœ¨æœ¬åœ°å®¹å™¨å­˜å‚¨ä¸­ä¿å­˜é•œåƒå±‚ç¼“å­˜ï¼Œè‹¥æºä»“åº“ä¸ç›®æ ‡ä»“åº“éœ€è¦è®¤è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>--src-creds</code> ä¸ <code>--dest-creds</code> é€‰é¡¹æŒ‡å®šè®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶ä¸” Skopeo æ”¯æŒåœ¨ç›®æ ‡ä»“åº“å®ç°é•œåƒ <code>tag</code>ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  --src-creds=&lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  --dest-creds=&lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  docker://&lt;uri_for_src_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  docker://&lt;uri_for_dest_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br><span class=\"line\"><span class=\"comment\"># åˆ†åˆ«æŒ‡å®šæºä»“åº“ä¸ç›®æ ‡ä»“åº“çš„è®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶åœ¨ä»“åº“é—´æ‹·è´å®¹å™¨é•œåƒã€‚</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-dest-creds.jpg\" alt=\"skopeo-copy-dest-creds.jpg\"></p>\n</li>\n</ul>\n</li>\n<li><p><code>skopeo delete</code>ï¼šåˆ é™¤å®¹å™¨é•œåƒçš„é•œåƒ tag  </p>\n<ul>\n<li><p>è¯¥å‘½ä»¤å¯åˆ é™¤å®¹å™¨é•œåƒä»“åº“ä¸­æŒ‡å®šé•œåƒçš„ tag<br>è‹¥åˆ é™¤å…¬å…±é•œåƒå¯ç›´æ¥æ‰§è¡Œæ— éœ€ç”¨æˆ·è®¤è¯ï¼Œè€Œåˆ é™¤ç§æœ‰å®¹å™¨é•œåƒéœ€ä½¿ç”¨ <code>--creds</code> é€‰é¡¹æˆ– <code>--authfile</code> é€‰é¡¹è¿›è¡Œè®¤è¯ååˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo delete --creds &lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ’¥ æŒ‡å®šé•œåƒ <code>tag</code> æ—¶å°†åˆ é™¤ç‰¹å®š tagï¼Œå³ä½¿å°†æœ€åä¸€ä¸ª tag åˆ é™¤åä¹Ÿä¸åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“ï¼Œè‹¥éœ€è¦åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“éœ€ç™»å½•æŒ‡å®šä»“åº“ã€‚æ­¤å¤„ä¸º Quay.io ä¸ºä¾‹ï¼Œåœ¨ <code>Web æ§åˆ¶å°</code> ä¸Šåˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-delete-1.jpg\" alt=\"skopeo-delete-1.jpg\"><img src=\"skopeo-delete-2.jpg\" alt=\"skopeo-delete-2.jpg\"> </p>\n</li>\n<li>ğŸ’¥ è¯¥å‘½ä»¤ä¹Ÿå¯åˆ é™¤æœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„é•œåƒ tagï¼Œä½†éœ€æ³¨æ„ï¼Œè‹¥å…·æœ‰å¤šä¸ªä¸åŒ tag çš„å®¹å™¨é•œåƒï¼ˆå®é™…ä¸ºåŒä¸€å®¹å™¨é•œåƒï¼‰ï¼Œåªå…·æœ‰åŒä¸€ä¸ª image IDï¼ˆè¯¥å€¼æ¥è‡ªäºé•œåƒçš„ manifest ä¸­ <code>.config.digest</code>ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œåˆ é™¤æ—¶å³ä½¿æŒ‡å®šäº†é•œåƒçš„ tagï¼Œä¹Ÿä¼šå°†å…¶ä»–å…·æœ‰ç›¸åŒ image ID çš„é•œåƒä¸€å¹¶åˆ é™¤ï¼Œè¯¥è¡Œä¸ºä¸å®¹å™¨é•œåƒä»“åº“ä¸­ç›¸åŒºåˆ«ï¼</li>\n</ul>\n</li>\n<li><p><code>skopeo copy</code>ï¼šdir æ¨¡å¼ç¤ºä¾‹</p>\n<blockquote>\n<p>ğŸ’¥ Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°é•œåƒç›®å½•ï¼ˆè¯¥ç›®å½•æ— éœ€æå‰åˆ›å»ºï¼‰ï¼Œè¯¥ç›®å½•ä¸­çš„é•œåƒå°è£…æ ¼å¼ä¿ç•™åŸå§‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒæ ¼å¼ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  dir:&lt;dir_of_container_image&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-docker-format-image-dir.jpg\" alt=\"skopeo-copy-docker-format-image-dir.jpg\">é™¤äº†ä½¿ç”¨ docker load æˆ– podman load ç›´æ¥å°†å®¹å™¨é•œåƒçš„ tar å½’æ¡£å¯¼å…¥æœ¬åœ°é•œåƒç¼“å­˜ä¸­ï¼Œä¹Ÿå¯ä½¿ç”¨å·²ç»ä¿å­˜è‡³æœ¬åœ°çš„ç›®å½•ä»¥ dir æˆ– oci æ¨¡å¼å­˜åœ¨çš„å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"podman-load-dir-from-skopeo-copy.jpg\" alt=\"podman-load-dir-from-skopeo-copy.jpg\"></p>\n<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Skopeo å°†æœ¬åœ°é•œåƒç›®å½•æ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ï¼Œç”¨ä»¥æ›¿ä»£ docker push æˆ– podman push çš„åŠŸèƒ½ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  dir:&lt;dir_of_container_image&gt; \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-dir-2.jpg\" alt=\"skopeo-copy-dir-2.jpg\"></p>\n</li>\n<li><p><code>skopeo copy</code>ï¼šoci æ¨¡å¼ç¤ºä¾‹<br>Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ° <code>OCI</code> æ ¼å¼ç›®å½•ä¸­ä»¥å­˜å‚¨é•œåƒï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  oci:&lt;dir_of_container_image&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-oci-1.jpg\" alt=\"skopeo-copy-oci-1.jpg\">å…¶ä¸­æ‹·è´è‡³æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…å«äº†å®¹å™¨é•œåƒçš„å„å±‚ï¼ˆlayerï¼‰ã€‚<br><img src=\"skopeo-copy-oci-2.jpg\" alt=\"skopeo-copy-oci-2.jpg\">ä¹Ÿå¯ä½¿ç”¨æœ¬åœ° OCI æ ¼å¼ç›®å½•å°†é•œåƒæ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚</p>\n</li>\n<li><p><code>skopeo copy</code>ï¼šoci-archive æ¨¡å¼ç¤ºä¾‹  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  oci-archive:&lt;oci_contaier_image_name&gt;.tar</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ OCI é•œåƒæ ¼å¼çš„é•œåƒ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>skopeo copy</code>ï¼šcontainers-storage æ¨¡å¼ç¤ºä¾‹  </p>\n<blockquote>\n<p>ğŸ’¥ è¯¥æ¨¡å¼åªèƒ½åœ¨ä»¥ Podman æˆ– CRI-O ä¸ºå®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè‹¥ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶å°†æŠ¥é”™ï¼</p>\n</blockquote>\n<p><img src=\"skopeo-copy-docker-daemon.jpg\" alt=\"skopeo-copy-docker-daemon.jpg\">  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  containers-storage:&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>skopeo copy</code>ï¼šdocker-archive æ¨¡å¼ç¤ºä¾‹  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  docker-archive:&lt;docker_contaier_image_name&gt;.tar</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ Docker é•œåƒæ ¼å¼çš„é•œåƒ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>skopeo copy</code>ï¼šdocker-daemon æ¨¡å¼ç¤ºä¾‹</p>\n<blockquote>\n<p>ğŸ’¥ è¯¥æ¨¡å¼åœ¨ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  docker-daemon:&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸš€ Skopeo å¯¹å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼š  </p>\n<ul>\n<li>ä½¿ç”¨ skopeo copy å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°ç›®å½•æˆ–æœ¬åœ° tar å½’æ¡£å­˜å‚¨æ—¶ï¼Œå¯åˆ†åˆ«ä»¥ Docker é•œåƒæ ¼å¼æˆ– OCI é•œåƒæ ¼å¼ä¿å­˜ã€‚  </li>\n<li>å› æ­¤ï¼Œskopeo copy å‘½ä»¤å¯åŒæ—¶å®Œæˆå®¹å™¨é•œåƒçš„ä¸‹è½½ä¸é•œåƒæ ¼å¼çš„è½¬æ¢ã€‚  </li>\n<li>å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-copy-transform-image-format.jpg\" alt=\"skopeo-copy-transform-image-format.jpg\"></li>\n</ul>\n</li>\n<li><code>skopeo sync</code>ï¼š  <ul>\n<li>sync å­å‘½ä»¤å°†å®¹å™¨é•œåƒä» src æºåŒæ­¥è‡³ dest ç›®çš„åœ°ï¼ŒåŠŸèƒ½ä¸ copy å­å‘½ä»¤ç±»ä¼¼ã€‚  </li>\n<li>skopeo sync å‘½ä»¤å¯æŒ‡å®šçš„ src ä¸ dest ç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-sync-help.jpg\" alt=\"skopeo-sync-help.jpg\"></li>\n<li>ğŸ‘‰ ç¤ºä¾‹ 1ï¼š<br>å°†è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåŒæ­¥è‡³æœ¬åœ°ç›®å½•ï¼Œæœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•æ— éœ€åˆ›å»ºã€‚<img src=\"skopeo-sync-demo.jpg\" alt=\"skopeo-sync-demo.jpg\"></li>\n<li>ğŸ‘‰ ç¤ºä¾‹ 2ï¼š<br>skopeo å‘½ä»¤åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªå®¹å™¨é•œåƒä»“åº“çš„ token è®¤è¯æ–‡ä»¶å°†å®¹å™¨é•œåƒåŒæ­¥è‡³å¦ä¸€ä¸ªä»“åº“ä¸­ï¼Œå¹¶ä¸”ç›®æ ‡ä»“åº“åªéœ€æŒ‡å®šä»“åº“ <code>URI</code> å³å¯ï¼Œå°†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„é•œåƒåç§°ä¸æ ‡ç­¾ã€‚<img src=\"skopeo-sync-between-registry.jpg\" alt=\"skopeo-sync-between-registry.jpg\"></li>\n<li>ä¹Ÿå¯ä½¿ç”¨ skopeo sync å‘½ä»¤å°†æœ¬åœ° dir æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒåŒæ­¥è‡³è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚</li>\n</ul>\n</li>\n<li><p><code>skopeo inspect</code> ä¸ <code>skopeo manifest-digest</code>ï¼š</p>\n<ul>\n<li>è¯¥å‘½ä»¤ç”¨äºæŸ¥çœ‹è¯¦ç»†çš„å®¹å™¨é•œåƒå±‚ä¿¡æ¯ï¼ˆimage manifestï¼‰æˆ–å®¹å™¨é•œåƒçš„é…ç½®ä¿¡æ¯ï¼ˆimage configï¼‰ã€‚  </li>\n<li>ğŸ³ image manifest åŒ…å«å„é•œåƒå±‚çš„ <code>mediaType</code>ã€<code>size</code>ã€<code>digest</code>ï¼Œè€Œ image config åŒ…å«é•œåƒçš„å…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚  </li>\n<li><p>ğŸ‘‰ ç¤ºä¾‹ 1ï¼šDocker é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•<br>å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨ <code>dir</code> æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒä½äº nexus3-3.37.3 ç›®å½•ä¸­ï¼Œå¯ç›´æ¥ä½¿ç”¨ <code>jq</code> å‘½ä»¤æŸ¥çœ‹è¯¥é•œåƒçš„ image manifest ä¸ image configï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ï¼ˆä»¥ä¸‹å†…å®¹ä¸ºéƒ¨åˆ†è¾“å‡ºï¼‰ ###</span></span><br><span class=\"line\">$ jq <span class=\"string\">'.'</span> nexus3-3.37.3/manifest.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.container.image.v1+json\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"size\"</span>: 10193,</span><br><span class=\"line\">    <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 81522888,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:8dfe9326f733b815c486432e93e0a97f03e90e7cc35def9511cd1efa7f917f56\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ® dir ç›®å½•ä¸­çš„ manifest æŸ¥çœ‹å®¹å™¨é•œåƒåŠå„é•œåƒå±‚ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ jq <span class=\"string\">'.'</span> nexus3-3.37.3/1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"architecture\"</span>: <span class=\"string\">\"amd64\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"bb4a731bd39e\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"User\"</span>: <span class=\"string\">\"nexus\"</span>,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    <span class=\"string\">\"ExposedPorts\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"8081/tcp\"</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Env\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"container=oci\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"SONATYPE_DIR=/opt/sonatype\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"NEXUS_HOME=/opt/sonatype/nexus\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"NEXUS_DATA=/nexus-data\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"NEXUS_CONTEXT=\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"SONATYPE_WORK=/opt/sonatype/sonatype-work\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"DOCKER_TYPE=3x-docker\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"INSTALL4J_ADD_VM_PARAMS=-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=/nexus-data/javaprefs\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"sh\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"-c\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"<span class=\"variable\">$&#123;SONATYPE_DIR&#125;</span>/start-nexus-repository-manager.sh\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:bb968737b5d0d7420e5af7c5524cddc16bd2b43a47f8277e00b1461342d40ba5\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Volumes\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"/nexus-data\"</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2022-03-02T23:52:49.682473465Z\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"docker_version\"</span>: <span class=\"string\">\"20.10.9\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"history\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2022-02-25T17:39:29.754401796Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"comment\"</span>: <span class=\"string\">\"Imported from -\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2022-03-02T23:52:49.682473465Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  CMD [\\\"sh\\\" \\\"-c\\\" \\\"<span class=\"variable\">$&#123;SONATYPE_DIR&#125;</span>/start-nexus-repository-manager.sh\\\"]\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"rootfs\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span>: <span class=\"string\">\"layers\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"diff_ids\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"sha256:7699752e6ed63eef234d2736d4e37159a433e18e06cd617e254299f324f41797\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:c8013a2772b6673d9b750b6407d4ac4f525a47bb2a5b5bf09ba9bf8e10aea3fc\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:5a745ebef99f4893aac7c56a26e54f9c6cdc08b02748e0580b1a31d70be0a280\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:8d12fc82bf58bf5f7958577a148cc05899f0c19e4654376f5e01d3af46eb0c15\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:d17e45a4f748d13d0501b9e1bca5be387e13efa8ce98147a85c904a348764f3b\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ®å®¹å™¨é•œåƒç›®å½•ä¸­çš„ config æ–‡ä»¶æŸ¥çœ‹å…·ä½“çš„ image config</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo inspect dir:nexus3-3.37.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„æ¦‚è¦ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo inspect --raw dir:nexus3-3.37.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸é•œåƒçš„ manifest.json ä¸€è‡´ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo inspect --config dir:nexus3-3.37.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ config ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸ç›´æ¥æŸ¥çœ‹é•œåƒçš„é…ç½®ä¿¡æ¯ä¸€è‡´ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo manifest-digest nexus3-3.37.3/manifest.json</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest.json æ–‡ä»¶çš„ digest å€¼</span></span><br></pre></td></tr></table></figure>\n<p>å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ <code>image manifest</code> ä¸å…¶ <code>digest</code> çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-docker-image-format-digest-1.jpg\" alt=\"skopeo-docker-image-format-digest-1.jpg\"><img src=\"skopeo-docker-image-format-digest-2.jpg\" alt=\"skopeo-docker-image-format-digest-2.jpg\"></p>\n</li>\n<li>ğŸ‘‰ ç¤ºä¾‹ 2ï¼šOCI é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•<br>å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ <code>image manifest</code> ä¸å…¶ <code>digest</code> çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-oci-image-format-digest.jpg\" alt=\"skopeo-oci-image-format-digest.jpg\"></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ğŸ³-å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\"><a href=\"#ğŸ³-å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\" class=\"headerlink\" title=\"ğŸ³ å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\"></a>ğŸ³ å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š</h3><ul>\n<li>å¯¹äºä¸åŒçš„å®¹å™¨é•œåƒæ ¼å¼ï¼Œå…¶ç›®å½•çš„ç»„ç»‡ç»“æ„å­˜åœ¨å·®å¼‚ï¼Œä½†å½¼æ­¤é—´åˆæœ‰è”ç³»ã€‚</li>\n<li>ç›®å‰é‡‡ç”¨çš„å®¹å™¨é•œåƒæ ¼å¼ï¼š  <ul>\n<li><code>Docker image format</code>ï¼šDocker é•œåƒæ ¼å¼  </li>\n<li><code>OCI image format</code>ï¼šOCI é•œåƒæ ¼å¼</li>\n</ul>\n</li>\n<li>OCI image format ç»§æ‰¿äº Docker image formatï¼Œå› æ­¤ï¼Œå¯è¿è¡Œ OCI image format é•œåƒçš„å®¹å™¨è¿è¡Œæ—¶ä¹Ÿå¯è¿è¡Œ Docker image format çš„é•œåƒã€‚</li>\n<li><code>OCI</code>ï¼ˆOpen Container Initiativeï¼Œå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰å‘å±•æ¦‚è¿°ï¼š<ul>\n<li>ä¸ºäº†æ¨è¿›å®¹å™¨åŒ–æŠ€æœ¯çš„å·¥ä¸šæ ‡å‡†åŒ–ï¼Œ2015 å¹´ 6 æœˆåœ¨ <code>DockerCon</code> ä¸Š Linux åŸºé‡‘ä¼šä¸ Googleã€åä¸ºã€æƒ æ™®ã€IBMã€Dockerã€Red Hatã€VMware ç­‰å…¬å¸å…±åŒå®£å¸ƒæˆç«‹å¼€æ”¾å®¹å™¨é¡¹ç›®ï¼ˆOCPï¼‰ï¼Œåæ›´åä¸ºå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼ˆOCIï¼‰ã€‚  </li>\n<li>å®ƒçš„ä¸»è¦ç›®æ ‡æ˜¯å»ºç«‹å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶çš„å·¥ä¸šå¼€æ”¾é€šç”¨æ ‡å‡†ã€‚  </li>\n<li>ä¸ºäº†æ”¯æŒ OCI å®¹å™¨è¿è¡Œæ—¶æ ‡å‡†çš„æ¨è¿›ï¼ŒDocker å…¬å¸èµ·è‰äº†é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶è§„èŒƒçš„è‰æ¡ˆï¼Œå¹¶å°† Docker é¡¹ç›®çš„ç›¸å…³å®ç°æçŒ®ç»™äº†ç¤¾åŒºï¼ŒOCI ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„åŸºç¡€å®ç°ï¼Œç°åœ¨é¡¹ç›®åä¸º <code>runc</code>ã€‚</li>\n</ul>\n</li>\n<li>ğŸ¤˜ å‘å±•è‡³ä»Šï¼ŒOCI åˆ¶å®šçš„ä¸»è¦æ ‡å‡†ï¼š  <ul>\n<li><code>runtime-spec</code>ï¼šå®šä¹‰å®¹å™¨è¿è¡Œæ—¶è§„èŒƒ  </li>\n<li><code>image-spec</code>ï¼šå®šä¹‰å®¹å™¨é•œåƒæ ¼å¼è§„èŒƒ  </li>\n<li><code>distribution-spec</code>ï¼šå®šä¹‰å®¹å™¨é•œåƒçš„åˆ†å‘è§„èŒƒ</li>\n</ul>\n</li>\n<li><p>OCI image format ç›®å½•è¯´æ˜ï¼š  </p>\n<ul>\n<li><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œä»¥ <code>debian</code> é•œåƒä¸ºä¾‹ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree debian-bullseye-20211115-oci</span><br><span class=\"line\">debian-bullseye-20211115-oci</span><br><span class=\"line\">â”œâ”€â”€ blobs</span><br><span class=\"line\">â”‚   â””â”€â”€ sha256</span><br><span class=\"line\">â”‚       â”œâ”€â”€ 468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b</span><br><span class=\"line\">â”‚       â”œâ”€â”€ 5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6</span><br><span class=\"line\">â”‚       â””â”€â”€ 61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad</span><br><span class=\"line\">â”œâ”€â”€ index.json</span><br><span class=\"line\">â””â”€â”€ oci-layout</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>oci-layoutï¼šOCI image çš„é•œåƒå¸ƒå±€è§„èŒƒï¼Œæ­¤å¤„ä½¿ç”¨ <code>OCI 1.0.0</code> ç‰ˆæœ¬ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.'</span> debian-bullseye-20211115-oci/oci-layout</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"imageLayoutVersion\"</span>: <span class=\"string\">\"1.0.0\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>index.jsonï¼š    </p>\n<ul>\n<li><code>index.json</code> æ–‡ä»¶ä¸­çš„ <code>manifests</code> å­—æ®µç±»ä¼¼äº Docker image ä¸­çš„ <code>manifest.json</code> ä½œä¸º OCI image çš„é¡¶çº§é…ç½®, ä¹Ÿæ˜¯é•œåƒçš„ä¸€ä¸ªå…¥å£é…ç½®ã€‚  </li>\n<li><p>è¯¥æ–‡ä»¶å®é™…æŒ‡å‘ <code>blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b</code> ï¼Œå³çœŸæ­£çš„ OCI image manifest æ–‡ä»¶ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.'</span> debian-bullseye-20211115-oci/index.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">\"manifests\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.manifest.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 349</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä»è¯¥æ–‡ä»¶çš„ <code>mediaType</code> å¯ä»¥çœ‹å‡ºå®¹å™¨é•œåƒæ ¼å¼å·²å‘ç”Ÿçš„å˜åŒ–ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.mediaType'</span> debian-bullseye-20211115-docker/manifest.json</span><br><span class=\"line\"><span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span></span><br><span class=\"line\"><span class=\"comment\"># Docker image format å°è£…</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ jq <span class=\"string\">'.manifests[0].mediaType'</span> debian-bullseye-20211115-oci/index.json</span><br><span class=\"line\"><span class=\"string\">\"application/vnd.oci.image.manifest.v1+json\"</span></span><br><span class=\"line\"><span class=\"comment\"># OCI image format å°è£…</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.'</span> debian-bullseye-20211115-oci/blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.config.v1+json\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"size\"</span>: 579</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.layer.v1.tar+gzip\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 56889206</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Šæ–‡ä»¶ä¸º OCI image manifest æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« image config çš„ä¿¡æ¯ä¸å„é•œåƒå±‚ Layers çš„ä¿¡æ¯ï¼Œæ¯å±‚ layer ä½¿ç”¨ <code>tar+gzip</code> çš„æ–¹å¼è¿›è¡Œå‹ç¼©ã€‚</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Docker image format ä¸ OCI image format çš„è”ç³»ä¸åŒºåˆ«ï¼š  <ul>\n<li>æœ€ä¸»è¦çš„åŒºåˆ«ï¼šç›®å½•ç»“æ„ä¸å®Œå…¨ç›¸åŒï¼Œé…ç½®ä¿¡æ¯å°¤å…¶æ˜¯ <code>mediaType</code> çš„è§„èŒƒä¸åŒã€‚  </li>\n<li>è”ç³»ï¼šOCI image çš„è§„èŒƒæ˜¯ç”± Docker image çš„è§„èŒƒä¿®æ”¹è€Œæ¥ï¼Œæ‰€ä»¥ç±»ä¼¼å®ƒä»¬çš„ blob çš„ç»„ç»‡å½¢å¼å¤§è‡´ç›¸åŒï¼Œé…ç½®æ–‡ä»¶ä¸­å¾ˆå¤šçš„å‚æ•°ä¹Ÿç›¸ä¼¼ã€‚  </li>\n<li>å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ skopeo å·¥å…·å¾ˆæ–¹ä¾¿åœ°å°† Docker image è½¬æ¢ä¸º OCI imageã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://github.com/containers/skopeo\" target=\"_blank\" rel=\"noopener\">GitHub Doc - Skopeo</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/J2b-PQD5GkN5KEmGB2WAeA\" target=\"_blank\" rel=\"noopener\">é•œåƒæ¬è¿å·¥å…· Skopeo ä½¿ç”¨</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/8wAv87DkJjE6fVEEmoQ60Q\" target=\"_blank\" rel=\"noopener\">OCI ä¸å®¹å™¨é•œåƒæ„å»º</a></li>\n<li><a href=\"https://github.com/opencontainers/image-spec\" target=\"_blank\" rel=\"noopener\">GitHub Doc - opencontainers/image-spec</a></li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/main/media-types.md\" target=\"_blank\" rel=\"noopener\">GitHub Doc - OCI Image Media Types</a></li>\n<li><a href=\"https://github.com/opencontainers/runtime-spec/blob/main/spec.md\" target=\"_blank\" rel=\"noopener\">GitHub Doc - Open Container Initiative Runtime Specification</a></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li>OS ç‰ˆæœ¬ï¼šUbuntu 20.04.3 LTS (Focal Fossa)</li>\n<li>skopeo ç‰ˆæœ¬ï¼š1.3.0-1</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>Skopeo å·¥å…·æ¦‚è¦</li>\n<li>ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“</li>\n<li>Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼</li>\n<li>ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒ</li>\n<li>å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒ</li>\n<li>å‚è€ƒé“¾æ¥</li>\n</ul>\n<h3 id=\"Skopeo-å·¥å…·æ¦‚è¦ï¼š\"><a href=\"#Skopeo-å·¥å…·æ¦‚è¦ï¼š\" class=\"headerlink\" title=\"Skopeo å·¥å…·æ¦‚è¦ï¼š\"></a>Skopeo å·¥å…·æ¦‚è¦ï¼š</h3><ul>\n<li>å¸¸ç”¨çš„å®¹å™¨é•œåƒæ“ä½œå·¥å…·å¯ä½¿ç”¨ dockerã€podman å‘½ä»¤ï¼Œä½† docker å‘½ä»¤è¡Œå·¥å…·éœ€è¦ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ä¸ root ç”¨æˆ·æƒé™ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ä½¿ç”¨è¯¥å·¥å…·åŒæ­¥å®¹å™¨é•œåƒçš„æ•ˆç‡æ˜¯è¾ƒä½çš„ï¼Œè€Œ podman å‘½ä»¤è™½ç„¶ä¸ä½¿ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼Œä½†æ˜¯å…¶åŒæ­¥é•œåƒæ•ˆç‡ä¾ç„¶ä¸é«˜ã€‚</li>\n<li>skopeo ä¸ buildah å‘½ä»¤å¯ä¸“é—¨ç”¨äºå®¹å™¨é•œåƒçš„æ“ä½œï¼Œå…¶ä¸­ skopeo å‘½ä»¤æ›´åŠ çº¯ç²¹åœ°ç”¨äºå®¹å™¨é•œåƒçš„æ¬è¿ä¸å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼Œæ•ˆç‡è¾ƒå…¶ä»–å·¥å…·æ›´é«˜ï¼Œä½†æ˜¯ä¸å…·æœ‰å®¹å™¨é•œåƒæ„å»ºçš„èƒ½åŠ›ã€‚</li>\n<li>Podman æ›´åŠ ä¾§é‡äºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒæ—¶å…·å¤‡éƒ¨åˆ†å®¹å™¨é•œåƒç®¡ç†ä¸æ„å»ºåŠŸèƒ½ï¼Œè€Œ Buildah æ”¯æŒåˆ†åˆ«ä½¿ç”¨å‘½ä»¤è¡Œä»å¤´æ„å»ºå®¹å™¨é•œåƒä¸ <code>Dockerfile</code> æˆ– <code>Containerfile</code> çš„æ„å»ºæ–¹å¼ï¼ŒåŒæ—¶å…¼å®¹ Docker ä¸ OCI é•œåƒæ ¼å¼ã€‚<blockquote>\n<p>ğŸ‘‰ å…³äº Podman æ›´åŠ è¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒä¹‹å‰å†™çš„ <a href=\"https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/\">Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ1ï¼‰</a>ä¸ <a href=\"https://alberthua-perl.github.io/2022/12/05/podman-usage-practice/\">Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ2ï¼‰</a>ã€‚</p>\n</blockquote>\n</li>\n<li>Skopeo å®‰è£…æ–¹æ³•å¯å‚è€ƒ <a href=\"https://github.com/containers/skopeo/blob/main/install.md\" target=\"_blank\" rel=\"noopener\">è¯¥ GitHub é“¾æ¥</a>ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</li>\n<li>skopeo å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼š  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo --<span class=\"built_in\">help</span></span><br><span class=\"line\">Various operations with container images and container image registries</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:</span><br><span class=\"line\">  skopeo [<span class=\"built_in\">command</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">Available Commands:</span><br><span class=\"line\">  copy                                          Copy an IMAGE-NAME from one location to another</span><br><span class=\"line\">  delete                                        Delete image IMAGE-NAME</span><br><span class=\"line\">  <span class=\"built_in\">help</span>                                          Help about any <span class=\"built_in\">command</span></span><br><span class=\"line\">  inspect                                       Inspect image IMAGE-NAME</span><br><span class=\"line\">  list-tags                                     List tags <span class=\"keyword\">in</span> the transport/repository specified by the REPOSITORY-NAME</span><br><span class=\"line\">  login                                         Login to a container registry</span><br><span class=\"line\">  <span class=\"built_in\">logout</span>                                        Logout of a container registry</span><br><span class=\"line\">  manifest-digest                               Compute a manifest digest of a file</span><br><span class=\"line\">  standalone-sign                               Create a signature using <span class=\"built_in\">local</span> files</span><br><span class=\"line\">  standalone-verify                             Verify a signature using <span class=\"built_in\">local</span> files</span><br><span class=\"line\">  sync                                          Synchronize one or more images from one location to another</span><br><span class=\"line\"></span><br><span class=\"line\">Flags:</span><br><span class=\"line\">      --<span class=\"built_in\">command</span>-timeout duration   timeout <span class=\"keyword\">for</span> the <span class=\"built_in\">command</span> execution</span><br><span class=\"line\">      --debug                      <span class=\"built_in\">enable</span> debug output</span><br><span class=\"line\">  -h, --<span class=\"built_in\">help</span>                       <span class=\"built_in\">help</span> <span class=\"keyword\">for</span> skopeo</span><br><span class=\"line\">      --insecure-policy            run the tool without any policy check</span><br><span class=\"line\">      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class=\"keyword\">for</span> choosing images</span><br><span class=\"line\">      --override-os OS             use OS instead of the running OS <span class=\"keyword\">for</span> choosing images</span><br><span class=\"line\">      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class=\"keyword\">for</span> choosing images</span><br><span class=\"line\">      --policy string              Path to a trust policy file</span><br><span class=\"line\">      --registries.d DIR           use registry configuration files <span class=\"keyword\">in</span> DIR (e.g. <span class=\"keyword\">for</span> container signature storage)</span><br><span class=\"line\">      --tmpdir string              directory used to store temporary files</span><br><span class=\"line\">  -v, --version                    Version <span class=\"keyword\">for</span> Skopeo</span><br><span class=\"line\"></span><br><span class=\"line\">Use <span class=\"string\">\"skopeo [command] --help\"</span> <span class=\"keyword\">for</span> more information about a <span class=\"built_in\">command</span>.</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"ä½¿ç”¨-Skopeo-è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\"><a href=\"#ä½¿ç”¨-Skopeo-è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\" class=\"headerlink\" title=\"ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š\"></a>ä½¿ç”¨ Skopeo è®¤è¯å®¹å™¨é•œåƒä»“åº“ï¼š</h3><ul>\n<li>Red Hat æ”¯æŒ <code>skopeo</code> å‘½ä»¤æ¥ç®¡ç†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒã€‚</li>\n<li>Skopeo å¯åˆ†åˆ«ç”¨äºæ“ä½œå…¬å…±ï¼ˆpublicï¼‰ä¸ç§æœ‰ï¼ˆprivateï¼‰å®¹å™¨é•œåƒï¼Œå¯¹äºç§æœ‰å®¹å™¨é•œåƒéœ€è¦å¯¹å®¹å™¨é•œåƒä»“åº“è¿›è¡Œè®¤è¯ã€‚</li>\n<li>Skopeo ä¸ Buildah å¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ <code>token</code>ï¼ˆä½äº <code>/run/user/&lt;UID&gt;/containers/auth.json</code>ï¼‰ï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ï¼Œå› æ­¤ï¼Œè‹¥åœ¨ skopeo å‘½ä»¤è¡Œä¸­æŒ‡å®šæ˜æ–‡ç™»å½•å¯†ç å¯åœ¨ history å‘½ä»¤å†å²è®°å½•ä¸­æŸ¥çœ‹åˆ°ï¼Œå­˜åœ¨ä¸€å®šçš„å®‰å…¨é£é™©ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹ä»¥å˜é‡å½¢å¼ä¼ é€’å¯†ç çš„æ–¹æ³•ä¼˜åŒ–ï¼š<img src=\"skopeo-inspect-creds.jpg\" alt=\"skopeo-inspect-creds.jpg\"><blockquote>\n<p>è‹¥æœªä½¿ç”¨ Podman ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä¾ç„¶ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„è¯ï¼Œå…¶è®¤è¯ token ä¾ç„¶å¯è¢« Skopeo ä½¿ç”¨ä¸è®¤è¯ï¼Œè¯¥è®¤è¯ token ä½äº <code>$HOME/.docker/config.json</code>ã€‚</p>\n</blockquote>\n</li>\n<li>Skopeo çš„ä¼—å¤šå­å‘½ä»¤æ”¯æŒå®¹å™¨é•œåƒä»“åº“çš„è®¤è¯ï¼Œå¯åˆ†åˆ«é€šè¿‡ç”¨æˆ·åä¸å¯†ç åŠè®¤è¯çš„ token æ–‡ä»¶å®ç°è®¤è¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  <figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ ###</span></span><br><span class=\"line\">$ skopeo copy --src-creds &lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\</span><br><span class=\"line\">  oci:postgresql-96-rhel7-latest</span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo copy --src-authfile /run/user/&lt;UID&gt;/containers/auth.json \\</span><br><span class=\"line\">  docker://registry.redhat.io/rhscl/postgresql-96-rhel7:latest \\</span><br><span class=\"line\">  oci:postgresql-96-rhel7-latest</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"Skopeo-æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\"><a href=\"#Skopeo-æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\" class=\"headerlink\" title=\"Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š\"></a>Skopeo æ”¯æŒçš„å®¹å™¨é•œåƒå­˜å‚¨æ–¹å¼ï¼š</h3><ul>\n<li>Skopeo ä½¿ç”¨ <code>URI</code> æ¥è¡¨ç¤ºå®¹å™¨é•œåƒçš„ä½ç½®ï¼Œä½¿ç”¨ URI æ¨¡å¼ï¼ˆschemaï¼‰æ¥è¡¨ç¤ºå®¹å™¨é•œåƒæ ¼å¼å’Œregistry APIsã€‚</li>\n<li>å¸¸è§çš„ URI æ¨¡å¼ï¼š  <ul>\n<li><code>oci</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨åœ¨æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ä¸­çš„å®¹å™¨é•œåƒ    </li>\n<li>è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒï¼ˆ<code>Open Container Image Layout Specification</code>ï¼‰  </li>\n</ul>\n</li>\n<li><code>oci-archive</code>ï¼š    <ul>\n<li>è¡¨ç¤º OCI é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£    </li>\n<li>è¯¥é•œåƒå…¼å®¹å¼€æ”¾å®¹å™¨é•œåƒå±‚è§„èŒƒ  </li>\n</ul>\n</li>\n<li><code>containers-storage</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ    </li>\n<li>åç«¯å®¹å™¨å¼•æ“å…¼å®¹ Podmanã€CRI-O ä¸ Buildah  </li>\n</ul>\n</li>\n<li><code>docker-daemon</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨äºæœ¬åœ° Docker å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„å®¹å™¨é•œåƒ  </li>\n</ul>\n</li>\n<li><code>docker-archive</code>ï¼š    <ul>\n<li>è¡¨ç¤º Docker é•œåƒæ ¼å¼å°è£…çš„å®¹å™¨é•œåƒçš„ tar å½’æ¡£  </li>\n</ul>\n</li>\n<li><code>dir</code>ï¼š    <ul>\n<li>æœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•ï¼Œå…¶ä¸­ä»¥å•ä¸ªæ–‡ä»¶çš„æ–¹å¼åŒ…å«é•œåƒçš„ <code>manifest</code>ã€é•œåƒå±‚ tar å½’æ¡£ä¸å„é•œåƒå±‚ç­¾åï¼ˆ<code>digest</code>ï¼‰ã€‚  </li>\n</ul>\n</li>\n<li><code>docker://</code>ï¼š    <ul>\n<li>è¡¨ç¤ºå­˜å‚¨äºå®¹å™¨é•œåƒä»“åº“ä¸­çš„è¿œç¨‹å®¹å™¨é•œåƒ</li>\n<li>å¯é€šè¿‡ <code>Docker Registry HTTP API V2</code> æ“ä½œä»“åº“ä¸­çš„å®¹å™¨é•œåƒ</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>åŒä¸€å®¹å™¨é•œåƒå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯ä½¿ç”¨ä»¥ä¸Šä¸åŒçš„æ–¹å¼ä¿å­˜ã€‚<blockquote>\n<p>ğŸ‘‰ å…³äº Skopeo æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯å¯å‚è€ƒ <code>man skopeo</code> æ‰‹å†Œã€‚</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"ä½¿ç”¨-Skopeo-æ“ä½œå®¹å™¨é•œåƒï¼š\"><a href=\"#ä½¿ç”¨-Skopeo-æ“ä½œå®¹å™¨é•œåƒï¼š\" class=\"headerlink\" title=\"ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒï¼š\"></a>ä½¿ç”¨ Skopeo æ“ä½œå®¹å™¨é•œåƒï¼š</h3><ul>\n<li>Skopeo ä¸ä½¿ç”¨å®¹å™¨è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æ™®é€šç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ï¼Œæ¯” Podman ä½¿ç”¨ tagã€pull ä¸ push ç­‰å­å‘½ä»¤æ—¶æ›´åŠ çš„é«˜æ•ˆã€‚</li>\n<li>ğŸ³ è‹¥ä½¿ç”¨ docker æˆ– podman å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒä¿å­˜äºæœ¬åœ°å­˜å‚¨ï¼Œéœ€åˆ†åˆ«ä½¿ç”¨ docker pull|save ä¸ podman pull|save å‘½ä»¤å°†æœ¬åœ°é•œåƒç¼“å­˜ä¸­çš„é•œåƒä¿å­˜äº tar å½’æ¡£ï¼Œæ— æ³•ä»å®¹å™¨é•œåƒä»“åº“ç›´æ¥ä¿å­˜äºæ–‡ä»¶æˆ–ç›®å½•ä¸­ï¼Œä¸‹æ–‡ä¸­æåŠçš„ <code>skopeo copy</code> æˆ– <code>sync</code> å­å‘½ä»¤å¯å®ç°è¯¥åŠŸèƒ½ï¼Œæ— éœ€å­˜åœ¨æœ¬åœ°é•œåƒç¼“å­˜ã€‚</li>\n<li><p>ğŸš€ Skopeo æ“çºµé•œåƒå±‚çš„æ–¹å¼ï¼š  </p>\n<ul>\n<li>å‡ºäºæ•ˆç‡é—®é¢˜ï¼ŒSkopeo ä¸è¯»å–ä¸å‘é€å·²å­˜åœ¨äºç›®æ ‡ä»“åº“çš„é•œåƒå±‚ï¼Œå®ƒé¦–å…ˆè¯»å–æºé•œåƒçš„ manifestï¼Œå†ç¡®å®šå“ªäº›å±‚å·²å­˜åœ¨äºç›®æ ‡ä»“åº“ï¼Œç„¶åä»…ä»…æ‹·è´ç¼ºå¤±çš„é•œåƒå±‚ã€‚  </li>\n<li>è‹¥æ‹·è´æ¥è‡ªæ„å»ºäºåŒä¸€çˆ¶é•œåƒçš„é•œåƒï¼ŒSkopeo ä¸æ‹·è´å¤šä¸ªæ¥è‡ªäºçˆ¶é•œåƒçš„ç›¸åŒé•œåƒå±‚ã€‚  </li>\n<li><p>Skopeo å¯åœ¨å®¹å™¨é•œåƒä»“åº“ä¹‹é—´æ‹·è´é•œåƒè€Œä¸åœ¨æœ¬åœ°å®¹å™¨å­˜å‚¨ä¸­ä¿å­˜é•œåƒå±‚ç¼“å­˜ï¼Œè‹¥æºä»“åº“ä¸ç›®æ ‡ä»“åº“éœ€è¦è®¤è¯ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>--src-creds</code> ä¸ <code>--dest-creds</code> é€‰é¡¹æŒ‡å®šè®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶ä¸” Skopeo æ”¯æŒåœ¨ç›®æ ‡ä»“åº“å®ç°é•œåƒ <code>tag</code>ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  --src-creds=&lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  --dest-creds=&lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  docker://&lt;uri_for_src_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  docker://&lt;uri_for_dest_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br><span class=\"line\"><span class=\"comment\"># åˆ†åˆ«æŒ‡å®šæºä»“åº“ä¸ç›®æ ‡ä»“åº“çš„è®¤è¯ç”¨æˆ·ä¸æ˜æ–‡å¯†ç ï¼Œå¹¶åœ¨ä»“åº“é—´æ‹·è´å®¹å™¨é•œåƒã€‚</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-dest-creds.jpg\" alt=\"skopeo-copy-dest-creds.jpg\"></p>\n</li>\n</ul>\n</li>\n<li><p><code>skopeo delete</code>ï¼šåˆ é™¤å®¹å™¨é•œåƒçš„é•œåƒ tag  </p>\n<ul>\n<li><p>è¯¥å‘½ä»¤å¯åˆ é™¤å®¹å™¨é•œåƒä»“åº“ä¸­æŒ‡å®šé•œåƒçš„ tag<br>è‹¥åˆ é™¤å…¬å…±é•œåƒå¯ç›´æ¥æ‰§è¡Œæ— éœ€ç”¨æˆ·è®¤è¯ï¼Œè€Œåˆ é™¤ç§æœ‰å®¹å™¨é•œåƒéœ€ä½¿ç”¨ <code>--creds</code> é€‰é¡¹æˆ– <code>--authfile</code> é€‰é¡¹è¿›è¡Œè®¤è¯ååˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo delete --creds &lt;username&gt;:&lt;password&gt; \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸ’¥ æŒ‡å®šé•œåƒ <code>tag</code> æ—¶å°†åˆ é™¤ç‰¹å®š tagï¼Œå³ä½¿å°†æœ€åä¸€ä¸ª tag åˆ é™¤åä¹Ÿä¸åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“ï¼Œè‹¥éœ€è¦åˆ é™¤æ•´ä¸ªé•œåƒä»“åº“éœ€ç™»å½•æŒ‡å®šä»“åº“ã€‚æ­¤å¤„ä¸º Quay.io ä¸ºä¾‹ï¼Œåœ¨ <code>Web æ§åˆ¶å°</code> ä¸Šåˆ é™¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-delete-1.jpg\" alt=\"skopeo-delete-1.jpg\"><img src=\"skopeo-delete-2.jpg\" alt=\"skopeo-delete-2.jpg\"> </p>\n</li>\n<li>ğŸ’¥ è¯¥å‘½ä»¤ä¹Ÿå¯åˆ é™¤æœ¬åœ°å®¹å™¨è¿è¡Œæ—¶ç¼“å­˜ä¸­çš„é•œåƒ tagï¼Œä½†éœ€æ³¨æ„ï¼Œè‹¥å…·æœ‰å¤šä¸ªä¸åŒ tag çš„å®¹å™¨é•œåƒï¼ˆå®é™…ä¸ºåŒä¸€å®¹å™¨é•œåƒï¼‰ï¼Œåªå…·æœ‰åŒä¸€ä¸ª image IDï¼ˆè¯¥å€¼æ¥è‡ªäºé•œåƒçš„ manifest ä¸­ <code>.config.digest</code>ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œåˆ é™¤æ—¶å³ä½¿æŒ‡å®šäº†é•œåƒçš„ tagï¼Œä¹Ÿä¼šå°†å…¶ä»–å…·æœ‰ç›¸åŒ image ID çš„é•œåƒä¸€å¹¶åˆ é™¤ï¼Œè¯¥è¡Œä¸ºä¸å®¹å™¨é•œåƒä»“åº“ä¸­ç›¸åŒºåˆ«ï¼</li>\n</ul>\n</li>\n<li><p><code>skopeo copy</code>ï¼šdir æ¨¡å¼ç¤ºä¾‹</p>\n<blockquote>\n<p>ğŸ’¥ Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°é•œåƒç›®å½•ï¼ˆè¯¥ç›®å½•æ— éœ€æå‰åˆ›å»ºï¼‰ï¼Œè¯¥ç›®å½•ä¸­çš„é•œåƒå°è£…æ ¼å¼ä¿ç•™åŸå§‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒæ ¼å¼ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  dir:&lt;dir_of_container_image&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-docker-format-image-dir.jpg\" alt=\"skopeo-copy-docker-format-image-dir.jpg\">é™¤äº†ä½¿ç”¨ docker load æˆ– podman load ç›´æ¥å°†å®¹å™¨é•œåƒçš„ tar å½’æ¡£å¯¼å…¥æœ¬åœ°é•œåƒç¼“å­˜ä¸­ï¼Œä¹Ÿå¯ä½¿ç”¨å·²ç»ä¿å­˜è‡³æœ¬åœ°çš„ç›®å½•ä»¥ dir æˆ– oci æ¨¡å¼å­˜åœ¨çš„å®¹å™¨é•œåƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"podman-load-dir-from-skopeo-copy.jpg\" alt=\"podman-load-dir-from-skopeo-copy.jpg\"></p>\n<p>ä¹Ÿå¯ä»¥ä½¿ç”¨ Skopeo å°†æœ¬åœ°é•œåƒç›®å½•æ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ï¼Œç”¨ä»¥æ›¿ä»£ docker push æˆ– podman push çš„åŠŸèƒ½ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  dir:&lt;dir_of_container_image&gt; \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-dir-2.jpg\" alt=\"skopeo-copy-dir-2.jpg\"></p>\n</li>\n<li><p><code>skopeo copy</code>ï¼šoci æ¨¡å¼ç¤ºä¾‹<br>Skopeo å¯å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ° <code>OCI</code> æ ¼å¼ç›®å½•ä¸­ä»¥å­˜å‚¨é•œåƒï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  oci:&lt;dir_of_container_image&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"skopeo-copy-oci-1.jpg\" alt=\"skopeo-copy-oci-1.jpg\">å…¶ä¸­æ‹·è´è‡³æœ¬åœ°çš„ OCI æ ¼å¼ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼ŒåŒ…å«äº†å®¹å™¨é•œåƒçš„å„å±‚ï¼ˆlayerï¼‰ã€‚<br><img src=\"skopeo-copy-oci-2.jpg\" alt=\"skopeo-copy-oci-2.jpg\">ä¹Ÿå¯ä½¿ç”¨æœ¬åœ° OCI æ ¼å¼ç›®å½•å°†é•œåƒæ‹·è´è‡³å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚</p>\n</li>\n<li><p><code>skopeo copy</code>ï¼šoci-archive æ¨¡å¼ç¤ºä¾‹  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  oci-archive:&lt;oci_contaier_image_name&gt;.tar</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ OCI é•œåƒæ ¼å¼çš„é•œåƒ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>skopeo copy</code>ï¼šcontainers-storage æ¨¡å¼ç¤ºä¾‹  </p>\n<blockquote>\n<p>ğŸ’¥ è¯¥æ¨¡å¼åªèƒ½åœ¨ä»¥ Podman æˆ– CRI-O ä¸ºå®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œè‹¥ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶å°†æŠ¥é”™ï¼</p>\n</blockquote>\n<p><img src=\"skopeo-copy-docker-daemon.jpg\" alt=\"skopeo-copy-docker-daemon.jpg\">  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  containers-storage:&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>skopeo copy</code>ï¼šdocker-archive æ¨¡å¼ç¤ºä¾‹  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  docker-archive:&lt;docker_contaier_image_name&gt;.tar</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒå°è£…ä¸º tar å½’æ¡£çš„ Docker é•œåƒæ ¼å¼çš„é•œåƒ</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><code>skopeo copy</code>ï¼šdocker-daemon æ¨¡å¼ç¤ºä¾‹</p>\n<blockquote>\n<p>ğŸ’¥ è¯¥æ¨¡å¼åœ¨ä½¿ç”¨ Docker å®¹å™¨è¿è¡Œæ—¶çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo copy \\</span><br><span class=\"line\">  docker://&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag] \\</span><br><span class=\"line\">  docker-daemon:&lt;uri_for_registry&gt;/&lt;user_or_org&gt;/&lt;repository&gt;:[tag]</span><br><span class=\"line\"><span class=\"comment\"># å°†å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒå­˜å‚¨äºæœ¬åœ°é•œåƒç¼“å­˜</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ğŸš€ Skopeo å¯¹å®¹å™¨é•œåƒæ ¼å¼çš„è½¬æ¢ï¼š  </p>\n<ul>\n<li>ä½¿ç”¨ skopeo copy å‘½ä»¤å°†å®¹å™¨é•œåƒä»“åº“ä¸­é•œåƒæ‹·è´è‡³æœ¬åœ°ç›®å½•æˆ–æœ¬åœ° tar å½’æ¡£å­˜å‚¨æ—¶ï¼Œå¯åˆ†åˆ«ä»¥ Docker é•œåƒæ ¼å¼æˆ– OCI é•œåƒæ ¼å¼ä¿å­˜ã€‚  </li>\n<li>å› æ­¤ï¼Œskopeo copy å‘½ä»¤å¯åŒæ—¶å®Œæˆå®¹å™¨é•œåƒçš„ä¸‹è½½ä¸é•œåƒæ ¼å¼çš„è½¬æ¢ã€‚  </li>\n<li>å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-copy-transform-image-format.jpg\" alt=\"skopeo-copy-transform-image-format.jpg\"></li>\n</ul>\n</li>\n<li><code>skopeo sync</code>ï¼š  <ul>\n<li>sync å­å‘½ä»¤å°†å®¹å™¨é•œåƒä» src æºåŒæ­¥è‡³ dest ç›®çš„åœ°ï¼ŒåŠŸèƒ½ä¸ copy å­å‘½ä»¤ç±»ä¼¼ã€‚  </li>\n<li>skopeo sync å‘½ä»¤å¯æŒ‡å®šçš„ src ä¸ dest ç±»å‹å¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-sync-help.jpg\" alt=\"skopeo-sync-help.jpg\"></li>\n<li>ğŸ‘‰ ç¤ºä¾‹ 1ï¼š<br>å°†è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåŒæ­¥è‡³æœ¬åœ°ç›®å½•ï¼Œæœ¬åœ°å­˜å‚¨å®¹å™¨é•œåƒçš„ç›®å½•æ— éœ€åˆ›å»ºã€‚<img src=\"skopeo-sync-demo.jpg\" alt=\"skopeo-sync-demo.jpg\"></li>\n<li>ğŸ‘‰ ç¤ºä¾‹ 2ï¼š<br>skopeo å‘½ä»¤åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªå®¹å™¨é•œåƒä»“åº“çš„ token è®¤è¯æ–‡ä»¶å°†å®¹å™¨é•œåƒåŒæ­¥è‡³å¦ä¸€ä¸ªä»“åº“ä¸­ï¼Œå¹¶ä¸”ç›®æ ‡ä»“åº“åªéœ€æŒ‡å®šä»“åº“ <code>URI</code> å³å¯ï¼Œå°†è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„é•œåƒåç§°ä¸æ ‡ç­¾ã€‚<img src=\"skopeo-sync-between-registry.jpg\" alt=\"skopeo-sync-between-registry.jpg\"></li>\n<li>ä¹Ÿå¯ä½¿ç”¨ skopeo sync å‘½ä»¤å°†æœ¬åœ° dir æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒåŒæ­¥è‡³è¿œç¨‹å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚</li>\n</ul>\n</li>\n<li><p><code>skopeo inspect</code> ä¸ <code>skopeo manifest-digest</code>ï¼š</p>\n<ul>\n<li>è¯¥å‘½ä»¤ç”¨äºæŸ¥çœ‹è¯¦ç»†çš„å®¹å™¨é•œåƒå±‚ä¿¡æ¯ï¼ˆimage manifestï¼‰æˆ–å®¹å™¨é•œåƒçš„é…ç½®ä¿¡æ¯ï¼ˆimage configï¼‰ã€‚  </li>\n<li>ğŸ³ image manifest åŒ…å«å„é•œåƒå±‚çš„ <code>mediaType</code>ã€<code>size</code>ã€<code>digest</code>ï¼Œè€Œ image config åŒ…å«é•œåƒçš„å…¶ä»–è¯¦ç»†ä¿¡æ¯ã€‚  </li>\n<li><p>ğŸ‘‰ ç¤ºä¾‹ 1ï¼šDocker é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•<br>å¦‚ä¸Šæ‰€è¿°ï¼Œä½¿ç”¨ <code>dir</code> æ¨¡å¼å­˜å‚¨çš„å®¹å™¨é•œåƒä½äº nexus3-3.37.3 ç›®å½•ä¸­ï¼Œå¯ç›´æ¥ä½¿ç”¨ <code>jq</code> å‘½ä»¤æŸ¥çœ‹è¯¥é•œåƒçš„ image manifest ä¸ image configï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">### ç¤ºä¾‹ï¼ˆä»¥ä¸‹å†…å®¹ä¸ºéƒ¨åˆ†è¾“å‡ºï¼‰ ###</span></span><br><span class=\"line\">$ jq <span class=\"string\">'.'</span> nexus3-3.37.3/manifest.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.container.image.v1+json\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"size\"</span>: 10193,</span><br><span class=\"line\">    <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd\"</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 81522888,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:8dfe9326f733b815c486432e93e0a97f03e90e7cc35def9511cd1efa7f917f56\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ® dir ç›®å½•ä¸­çš„ manifest æŸ¥çœ‹å®¹å™¨é•œåƒåŠå„é•œåƒå±‚ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ jq <span class=\"string\">'.'</span> nexus3-3.37.3/1e1d45f195b19d03ec1833561dca6f5c63f9453413247c323c24f2fbcc34bcdd</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"architecture\"</span>: <span class=\"string\">\"amd64\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"Hostname\"</span>: <span class=\"string\">\"bb4a731bd39e\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Domainname\"</span>: <span class=\"string\">\"\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"User\"</span>: <span class=\"string\">\"nexus\"</span>,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    <span class=\"string\">\"ExposedPorts\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"8081/tcp\"</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">\"Tty\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"OpenStdin\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"StdinOnce\"</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Env\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"container=oci\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"SONATYPE_DIR=/opt/sonatype\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"NEXUS_HOME=/opt/sonatype/nexus\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"NEXUS_DATA=/nexus-data\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"NEXUS_CONTEXT=\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"SONATYPE_WORK=/opt/sonatype/sonatype-work\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"DOCKER_TYPE=3x-docker\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"INSTALL4J_ADD_VM_PARAMS=-Xms2703m -Xmx2703m -XX:MaxDirectMemorySize=2703m -Djava.util.prefs.userRoot=/nexus-data/javaprefs\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Cmd\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"sh\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"-c\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"<span class=\"variable\">$&#123;SONATYPE_DIR&#125;</span>/start-nexus-repository-manager.sh\"</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">\"Image\"</span>: <span class=\"string\">\"sha256:bb968737b5d0d7420e5af7c5524cddc16bd2b43a47f8277e00b1461342d40ba5\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"Volumes\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"/nexus-data\"</span>: &#123;&#125;</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2022-03-02T23:52:49.682473465Z\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"docker_version\"</span>: <span class=\"string\">\"20.10.9\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"history\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2022-02-25T17:39:29.754401796Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"comment\"</span>: <span class=\"string\">\"Imported from -\"</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"created\"</span>: <span class=\"string\">\"2022-03-02T23:52:49.682473465Z\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"created_by\"</span>: <span class=\"string\">\"/bin/sh -c #(nop)  CMD [\\\"sh\\\" \\\"-c\\\" \\\"<span class=\"variable\">$&#123;SONATYPE_DIR&#125;</span>/start-nexus-repository-manager.sh\\\"]\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"empty_layer\"</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">\"os\"</span>: <span class=\"string\">\"linux\"</span>,</span><br><span class=\"line\">  <span class=\"string\">\"rootfs\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"type\"</span>: <span class=\"string\">\"layers\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"diff_ids\"</span>: [</span><br><span class=\"line\">      <span class=\"string\">\"sha256:7699752e6ed63eef234d2736d4e37159a433e18e06cd617e254299f324f41797\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:c8013a2772b6673d9b750b6407d4ac4f525a47bb2a5b5bf09ba9bf8e10aea3fc\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:5a745ebef99f4893aac7c56a26e54f9c6cdc08b02748e0580b1a31d70be0a280\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:8d12fc82bf58bf5f7958577a148cc05899f0c19e4654376f5e01d3af46eb0c15\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"sha256:d17e45a4f748d13d0501b9e1bca5be387e13efa8ce98147a85c904a348764f3b\"</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ ¹æ®å®¹å™¨é•œåƒç›®å½•ä¸­çš„ config æ–‡ä»¶æŸ¥çœ‹å…·ä½“çš„ image config</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ skopeo inspect dir:nexus3-3.37.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„æ¦‚è¦ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo inspect --raw dir:nexus3-3.37.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸é•œåƒçš„ manifest.json ä¸€è‡´ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo inspect --config dir:nexus3-3.37.3</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ config ä¿¡æ¯ï¼Œè¿”å›çš„å†…å®¹ä¸ç›´æ¥æŸ¥çœ‹é•œåƒçš„é…ç½®ä¿¡æ¯ä¸€è‡´ã€‚</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ skopeo manifest-digest nexus3-3.37.3/manifest.json</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ nexus3 å®¹å™¨é•œåƒçš„ manifest.json æ–‡ä»¶çš„ digest å€¼</span></span><br></pre></td></tr></table></figure>\n<p>å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ <code>image manifest</code> ä¸å…¶ <code>digest</code> çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-docker-image-format-digest-1.jpg\" alt=\"skopeo-docker-image-format-digest-1.jpg\"><img src=\"skopeo-docker-image-format-digest-2.jpg\" alt=\"skopeo-docker-image-format-digest-2.jpg\"></p>\n</li>\n<li>ğŸ‘‰ ç¤ºä¾‹ 2ï¼šOCI é•œåƒæ ¼å¼çš„å®¹å™¨é•œåƒç›®å½•<br>å…³äºå®¹å™¨é•œåƒç›®å½•ä¸­ <code>image manifest</code> ä¸å…¶ <code>digest</code> çš„å…³ç³»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"skopeo-oci-image-format-digest.jpg\" alt=\"skopeo-oci-image-format-digest.jpg\"></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"ğŸ³-å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\"><a href=\"#ğŸ³-å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\" class=\"headerlink\" title=\"ğŸ³ å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š\"></a>ğŸ³ å®¹å™¨é•œåƒæ ¼å¼æ¯”è¾ƒï¼š</h3><ul>\n<li>å¯¹äºä¸åŒçš„å®¹å™¨é•œåƒæ ¼å¼ï¼Œå…¶ç›®å½•çš„ç»„ç»‡ç»“æ„å­˜åœ¨å·®å¼‚ï¼Œä½†å½¼æ­¤é—´åˆæœ‰è”ç³»ã€‚</li>\n<li>ç›®å‰é‡‡ç”¨çš„å®¹å™¨é•œåƒæ ¼å¼ï¼š  <ul>\n<li><code>Docker image format</code>ï¼šDocker é•œåƒæ ¼å¼  </li>\n<li><code>OCI image format</code>ï¼šOCI é•œåƒæ ¼å¼</li>\n</ul>\n</li>\n<li>OCI image format ç»§æ‰¿äº Docker image formatï¼Œå› æ­¤ï¼Œå¯è¿è¡Œ OCI image format é•œåƒçš„å®¹å™¨è¿è¡Œæ—¶ä¹Ÿå¯è¿è¡Œ Docker image format çš„é•œåƒã€‚</li>\n<li><code>OCI</code>ï¼ˆOpen Container Initiativeï¼Œå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼‰å‘å±•æ¦‚è¿°ï¼š<ul>\n<li>ä¸ºäº†æ¨è¿›å®¹å™¨åŒ–æŠ€æœ¯çš„å·¥ä¸šæ ‡å‡†åŒ–ï¼Œ2015 å¹´ 6 æœˆåœ¨ <code>DockerCon</code> ä¸Š Linux åŸºé‡‘ä¼šä¸ Googleã€åä¸ºã€æƒ æ™®ã€IBMã€Dockerã€Red Hatã€VMware ç­‰å…¬å¸å…±åŒå®£å¸ƒæˆç«‹å¼€æ”¾å®¹å™¨é¡¹ç›®ï¼ˆOCPï¼‰ï¼Œåæ›´åä¸ºå¼€æ”¾å®¹å™¨æ ‡å‡†ï¼ˆOCIï¼‰ã€‚  </li>\n<li>å®ƒçš„ä¸»è¦ç›®æ ‡æ˜¯å»ºç«‹å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶çš„å·¥ä¸šå¼€æ”¾é€šç”¨æ ‡å‡†ã€‚  </li>\n<li>ä¸ºäº†æ”¯æŒ OCI å®¹å™¨è¿è¡Œæ—¶æ ‡å‡†çš„æ¨è¿›ï¼ŒDocker å…¬å¸èµ·è‰äº†é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶è§„èŒƒçš„è‰æ¡ˆï¼Œå¹¶å°† Docker é¡¹ç›®çš„ç›¸å…³å®ç°æçŒ®ç»™äº†ç¤¾åŒºï¼ŒOCI ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„åŸºç¡€å®ç°ï¼Œç°åœ¨é¡¹ç›®åä¸º <code>runc</code>ã€‚</li>\n</ul>\n</li>\n<li>ğŸ¤˜ å‘å±•è‡³ä»Šï¼ŒOCI åˆ¶å®šçš„ä¸»è¦æ ‡å‡†ï¼š  <ul>\n<li><code>runtime-spec</code>ï¼šå®šä¹‰å®¹å™¨è¿è¡Œæ—¶è§„èŒƒ  </li>\n<li><code>image-spec</code>ï¼šå®šä¹‰å®¹å™¨é•œåƒæ ¼å¼è§„èŒƒ  </li>\n<li><code>distribution-spec</code>ï¼šå®šä¹‰å®¹å™¨é•œåƒçš„åˆ†å‘è§„èŒƒ</li>\n</ul>\n</li>\n<li><p>OCI image format ç›®å½•è¯´æ˜ï¼š  </p>\n<ul>\n<li><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œä»¥ <code>debian</code> é•œåƒä¸ºä¾‹ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ tree debian-bullseye-20211115-oci</span><br><span class=\"line\">debian-bullseye-20211115-oci</span><br><span class=\"line\">â”œâ”€â”€ blobs</span><br><span class=\"line\">â”‚   â””â”€â”€ sha256</span><br><span class=\"line\">â”‚       â”œâ”€â”€ 468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b</span><br><span class=\"line\">â”‚       â”œâ”€â”€ 5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6</span><br><span class=\"line\">â”‚       â””â”€â”€ 61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad</span><br><span class=\"line\">â”œâ”€â”€ index.json</span><br><span class=\"line\">â””â”€â”€ oci-layout</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>oci-layoutï¼šOCI image çš„é•œåƒå¸ƒå±€è§„èŒƒï¼Œæ­¤å¤„ä½¿ç”¨ <code>OCI 1.0.0</code> ç‰ˆæœ¬ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.'</span> debian-bullseye-20211115-oci/oci-layout</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"imageLayoutVersion\"</span>: <span class=\"string\">\"1.0.0\"</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>index.jsonï¼š    </p>\n<ul>\n<li><code>index.json</code> æ–‡ä»¶ä¸­çš„ <code>manifests</code> å­—æ®µç±»ä¼¼äº Docker image ä¸­çš„ <code>manifest.json</code> ä½œä¸º OCI image çš„é¡¶çº§é…ç½®, ä¹Ÿæ˜¯é•œåƒçš„ä¸€ä¸ªå…¥å£é…ç½®ã€‚  </li>\n<li><p>è¯¥æ–‡ä»¶å®é™…æŒ‡å‘ <code>blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b</code> ï¼Œå³çœŸæ­£çš„ OCI image manifest æ–‡ä»¶ã€‚</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.'</span> debian-bullseye-20211115-oci/index.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">\"manifests\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.manifest.v1+json\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 349</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä»è¯¥æ–‡ä»¶çš„ <code>mediaType</code> å¯ä»¥çœ‹å‡ºå®¹å™¨é•œåƒæ ¼å¼å·²å‘ç”Ÿçš„å˜åŒ–ï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.mediaType'</span> debian-bullseye-20211115-docker/manifest.json</span><br><span class=\"line\"><span class=\"string\">\"application/vnd.docker.distribution.manifest.v2+json\"</span></span><br><span class=\"line\"><span class=\"comment\"># Docker image format å°è£…</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ jq <span class=\"string\">'.manifests[0].mediaType'</span> debian-bullseye-20211115-oci/index.json</span><br><span class=\"line\"><span class=\"string\">\"application/vnd.oci.image.manifest.v1+json\"</span></span><br><span class=\"line\"><span class=\"comment\"># OCI image format å°è£…</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ jq <span class=\"string\">'.'</span> debian-bullseye-20211115-oci/blobs/sha256/468a9be7b68d9b0baf252c3496a6db0a406ba558946d3cfee8f0d2a3be1ec42b</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">\"schemaVersion\"</span>: 2,</span><br><span class=\"line\">  <span class=\"string\">\"config\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.config.v1+json\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:61ccfad6b52ee974d14b8e3c998d862e7dedd59fa8e0023e6620b213ea6da1ad\"</span>,</span><br><span class=\"line\">    <span class=\"string\">\"size\"</span>: 579</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">\"layers\"</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">\"mediaType\"</span>: <span class=\"string\">\"application/vnd.oci.image.layer.v1.tar+gzip\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"digest\"</span>: <span class=\"string\">\"sha256:5f2f9939c1839f4fee492777a220cfe1e80cd25008df90af6c2b3b2c30e239c6\"</span>,</span><br><span class=\"line\">      <span class=\"string\">\"size\"</span>: 56889206</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä»¥ä¸Šæ–‡ä»¶ä¸º OCI image manifest æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« image config çš„ä¿¡æ¯ä¸å„é•œåƒå±‚ Layers çš„ä¿¡æ¯ï¼Œæ¯å±‚ layer ä½¿ç”¨ <code>tar+gzip</code> çš„æ–¹å¼è¿›è¡Œå‹ç¼©ã€‚</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>Docker image format ä¸ OCI image format çš„è”ç³»ä¸åŒºåˆ«ï¼š  <ul>\n<li>æœ€ä¸»è¦çš„åŒºåˆ«ï¼šç›®å½•ç»“æ„ä¸å®Œå…¨ç›¸åŒï¼Œé…ç½®ä¿¡æ¯å°¤å…¶æ˜¯ <code>mediaType</code> çš„è§„èŒƒä¸åŒã€‚  </li>\n<li>è”ç³»ï¼šOCI image çš„è§„èŒƒæ˜¯ç”± Docker image çš„è§„èŒƒä¿®æ”¹è€Œæ¥ï¼Œæ‰€ä»¥ç±»ä¼¼å®ƒä»¬çš„ blob çš„ç»„ç»‡å½¢å¼å¤§è‡´ç›¸åŒï¼Œé…ç½®æ–‡ä»¶ä¸­å¾ˆå¤šçš„å‚æ•°ä¹Ÿç›¸ä¼¼ã€‚  </li>\n<li>å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨ skopeo å·¥å…·å¾ˆæ–¹ä¾¿åœ°å°† Docker image è½¬æ¢ä¸º OCI imageã€‚</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"å‚è€ƒé“¾æ¥ï¼š\"><a href=\"#å‚è€ƒé“¾æ¥ï¼š\" class=\"headerlink\" title=\"å‚è€ƒé“¾æ¥ï¼š\"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul>\n<li><a href=\"https://github.com/containers/skopeo\" target=\"_blank\" rel=\"noopener\">GitHub Doc - Skopeo</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/J2b-PQD5GkN5KEmGB2WAeA\" target=\"_blank\" rel=\"noopener\">é•œåƒæ¬è¿å·¥å…· Skopeo ä½¿ç”¨</a></li>\n<li><a href=\"https://mp.weixin.qq.com/s/8wAv87DkJjE6fVEEmoQ60Q\" target=\"_blank\" rel=\"noopener\">OCI ä¸å®¹å™¨é•œåƒæ„å»º</a></li>\n<li><a href=\"https://github.com/opencontainers/image-spec\" target=\"_blank\" rel=\"noopener\">GitHub Doc - opencontainers/image-spec</a></li>\n<li><a href=\"https://github.com/opencontainers/image-spec/blob/main/media-types.md\" target=\"_blank\" rel=\"noopener\">GitHub Doc - OCI Image Media Types</a></li>\n<li><a href=\"https://github.com/opencontainers/runtime-spec/blob/main/spec.md\" target=\"_blank\" rel=\"noopener\">GitHub Doc - Open Container Initiative Runtime Specification</a></li>\n</ul>\n"},{"title":"Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ2ï¼‰","subtitle":"Podman Architecture and Usage (2)","header-img":"podman-bg.webp","date":"2022-12-05T07:12:51.000Z","_content":"\n### æ–‡æ¡£è¯´æ˜ï¼š\n- [ä¸Šä¸€ç¯‡](https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/) å·²è¯´æ˜ Podman åŸç†ä¸å®ç°ï¼Œè¯¥æ–‡æ¡£å°†ç»§ç»­è¯´æ˜ Podman å®¹å™¨çš„ä½¿ç”¨ä¸å®è·µã€‚\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹\n- ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“\n- podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹\n- ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²\n- Podman ä½¿ç”¨æŠ¥é”™ç¤ºä¾‹\n- Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½\n\n### podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\n- ç¤ºä¾‹ 1ï¼š  \n  ğŸ‘‰ ä½¿ç”¨ podman å‘½ä»¤ç™»å½• `Quay` å…¬å…±å®¹å™¨é•œåƒä»“åº“å¹¶æ¨é€é•œåƒï¼š![podman-push-quay.jpg](podman-push-quay.jpg)ğŸ‘‰ æœç´¢å¹¶æ‹‰å– Red Hat å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåˆ—è¡¨ï¼š![podman-pull-image.jpg](podman-pull-image.jpg)\n- ç¤ºä¾‹ 2ï¼š  \n  ğŸ¤˜ éƒ¨ç½²å¹¶ä½¿ç”¨äº‘åŸç”Ÿè½»é‡çº§å¯¹è±¡å­˜å‚¨ `MinIO Server`ï¼š  \n  ![minio-server-cloud-native-object-storage-demo-1.jpg](minio-server-cloud-native-object-storage-demo-1.jpg)![minio-server-cloud-native-object-storage-demo-2.jpg](minio-server-cloud-native-object-storage-demo-2.jpg)ä»¥ä¸Šç¤ºä¾‹å°† podman ä¸ systemd é›†æˆå®ç°æ™®é€šç”¨æˆ·çš„ rootless å®¹å™¨å¼€æœºè‡ªå¯åŠ¨ã€‚![minio-server-cloud-native-object-storage-demo-3.jpg](minio-server-cloud-native-object-storage-demo-3.jpg)å…³äº MinIO Server åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨çš„è¯¦ç»†å†…å®¹ï¼Œè¯· [å‚è€ƒå®˜ç½‘](https://min.io/)ã€‚\n- ç¤ºä¾‹ 3ï¼š  \n  ğŸ¤˜ è¯·å‚è€ƒè¯¥æ–‡æ¡£ [éƒ¨ç½² loganalyzer ç®¡ç†é›†ä¸­å¼æ—¥å¿—](https://alberthua-perl.github.io/2022/12/05/loganalyzer-rsyslog-mysql/) ä»¥ç†è§£å¤šä¸ª rootfull å®¹å™¨é—´çš„é€šä¿¡æ–¹å¼ï¼ˆé€šè¿‡ `cni-podman0` ç½‘æ¡¥ä¸ `iptables` äº’ç›¸é€šä¿¡ï¼‰ã€‚\n\n### ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š\n- ä½¿ç”¨ `podman-compose` é€šè¿‡ `link` é“¾æ¥è‡³æŒ‡å®šçš„å®¹å™¨å»ºç«‹é€šä¿¡ã€‚\n- å¦‚ä¸‹æ‰€ç¤ºï¼Œéƒ¨ç½² Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š`Gogs + PostgreSQL`  \n  - å…³äº podman-compose çš„å®‰è£…å¯å‚è€ƒ [GitHub é¡¹ç›®](https://github.com/containers/podman-compose)\n  \n  > ğŸ¤” å¯è€ƒè™‘ä½¿ç”¨ podman-compose éƒ¨ç½²è½»é‡çº§ `Gitea + Drone` CI æŒç»­é›†æˆå¹³å°\n  \n  - å…³äº Gogs é¡¹ç›®çš„è¯¦ç»†å†…å®¹å¯å‚è€ƒ [Gogs GitHub é¡¹ç›®](https://github.com/gogs/gogs)  \n  - Gogs ä»£ç ç‰ˆæœ¬æ§åˆ¶ä»“åº“ä½¿ç”¨ Golang è¯­è¨€å¼€å‘ï¼Œå¯ä¸åç«¯ MySQLã€PostgreSQLã€SQLite3ã€TiDB ç­‰é›†æˆã€‚  \n  - æ­¤å¤„ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½² Gogsï¼Œå¹¶ä¸ PostgreSQL é›†æˆã€‚  \n  - éƒ¨ç½²ç”¨ä¸»æœºä¸Šå¿…é¡»å…ˆå®‰è£… podman ä¸ podman-composeï¼Œå¹¶æ‹‰å–ç›¸åº”å®¹å™¨é•œåƒåŠ é€Ÿéƒ¨ç½²è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![podman-image-list.jps.JPG](podman-image-list.jps.JPG)\n    \n    > ğŸ“Œ**æ³¨æ„ï¼š**\n    > \n    > podman-compose ä½¿ç”¨åˆ›å»º `pod` å°†å¤šä¸ªå®¹å™¨ç»„å»ºæˆ pod çš„æ–¹å¼è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œå› æ­¤å¿…é¡»å…·æœ‰ `pause` å®¹å™¨é•œåƒæä¾› pod çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ä¸æŒ‚è½½å‘½åç©ºé—´ã€‚\n  \n  - ä½¿ç”¨æ™®é€šç”¨æˆ·éƒ¨ç½²ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  \n    ```bash\n    $ mkdir -p gogs-app/gogs-data/{gogs,gogs-logs,postgresql}\n    # åˆ›å»ºç”¨äºå­˜å‚¨ gogs ä¸ postgresql æ•°æ®æ˜ å°„çš„ç›®å½•\n    $ sudo chown -R 100999:100999 gogs-app/gogs-data/{gogs,gogs-logs}\n    # æ›´æ”¹æ˜ å°„ç›®å½•çš„å±ç»„ï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨æƒé™æŠ¥é”™ã€‚\n    $ getenforce\n      Enforcing\n    # ç¡®è®¤ç³»ç»Ÿå¤„äº enforcing SELinux çŠ¶æ€ï¼Œéœ€è®¾ç½®ç›®å½•æ˜ å°„æ—¶çš„æ ‡ç­¾ã€‚\n    # ä¹Ÿå¯ç¦ç”¨ SELinuxï¼Œè‹¥ç¦ç”¨ SELinuxï¼Œä»¥ä¸‹ä¸¤æ­¥å¯ä¸æ‰§è¡Œå¹¶ä¸”å»é™¤ podman-compose å®šä¹‰æ–‡ä»¶ä¸­çš„ \"Z\"ã€‚\n    $ sudo semanage port -a -t http_port_t -p tcp 10800\n    $ sudo semanage port -a -t ssh_port_t -p tcp 10022\n    # æ·»åŠ è‡ªå®šä¹‰ç«¯å£è‡³ SELinux æ•°æ®åº“ä¸­ï¼Œå¦åˆ™ç”±äºæƒé™é—®é¢˜æ— æ³•è®¿é—®å¹¶å®‰è£… Gogsã€‚\n    $ vim gogs-app/gogs-postgres-podman-compose.yaml\n    ```\n  - å¦‚ä¸‹æ‰€ç¤º `gogs-postgres-podman-compose.yaml` æ–‡ä»¶å¯å‚è€ƒ [æ­¤å¤„](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/gogs-postgres-compose/gogs-postgres-podman-compose.yaml)ï¼š\n    ```yaml\n    version: \"3\"\n    services:\n      postgresql:\n        image: docker.io/library/postgres:14.1-bullseye\n        container_name: \"gogs-postgresql\"\n        volumes:\n          - \"./gogs-data/postgresql:/var/lib/postgresql:Z\"\n        environment:\n          - \"POSTGRES_USER=gogs\"\n          - \"POSTGRES_PASSWORD=redhat\"\n          - \"POSTGRES_DB=gogs\"\n        ports:\n          - \"5432:5432\"\n    \n      gogs:\n        image: docker.io/gogs/gogs:0.12\n        container_name: \"gogs\"\n        volumes:\n          - \"./gogs-data/gogs:/data:Z\"\n          - \"./gogs-data/gogs-logs:/app/gogs/log:Z\"\n        ports:\n          - \"10022:22\"\n          - \"10800:3000\"\n        links:\n          - postgresql\n    ```\n  - ç¼–è¾‘å®Œæˆ yaml æ–‡ä»¶åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š  \n    ```bash\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app up\n    # å¯åŠ¨ Gogs ä¸ PostgreSQL å®¹å™¨ï¼Œå¹¶æŒ‡å®šé¡¹ç›®åç§°ã€‚\n    # è‹¥ä¸æŒ‡å®šé¡¹ç›®åç§°ï¼Œé¡¹ç›®é»˜è®¤ä¸º yaml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åç§°ã€‚\n    # é¦–æ¬¡å¯åŠ¨å®¹å™¨æ—¶ï¼Œæ‰€æœ‰çš„å¯åŠ¨ä¸è¿è¡Œæ—¥å¿—å°†æ‰“å°è‡³ç»ˆç«¯å±å¹•ä¸Šï¼Œè¯¥ç»ˆç«¯ä¸å¯å…³é—­ï¼Œç›´è‡³å…³é—­æ‰€æœ‰æœåŠ¡å®¹å™¨åå°†è‡ªåŠ¨é€€å‡ºã€‚\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app ps\n      using podman version: podman version 3.2.3\n      podman ps -a --filter label=io.podman.compose.project=gogs-app\n      CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES\n      2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs-postgresql\n      2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs\n      0\n    # æŸ¥çœ‹ podman-compose ç®¡ç†çš„å®¹å™¨æœåŠ¡\n    $ podman ps\n      CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES\n      b6df150a3a49  k8s.gcr.io/pause:3.5                                            6 hours ago  Up 6 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  c3a10da46f18-infra\n      2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs-postgresql\n      2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs\n    # æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŒ…å« infra å®¹å™¨ã€‚\n    ```\n  - æ‰€æœ‰å®¹å™¨æ­£å¸¸è¿è¡Œåï¼Œä½¿ç”¨ `http://<å®¹å™¨å®¿ä¸»æœº IP åœ°å€>:10800` è®¿é—® Gogs å®‰è£…ç•Œé¢ï¼Œéœ€å¡«å…¥çš„å€¼å‚è€ƒå¦‚ä¸‹ï¼š![gogs-settings.jpg](gogs-settings.jpg)    \n    - Run User å€¼ï¼šé»˜è®¤ `git`ã€‚\n    - Domain å€¼ï¼šè‹¥è¦ä»å…¶ä»–ä¸»æœºè¿æ¥è‡³ Gogs ä»“åº“ï¼ŒDomian å¿…é¡»é…ç½®ä¸ºå®¹å™¨å®¿ä¸»æœºçš„ IP åœ°å€æˆ–ä¸»æœºåã€‚\n    - SSH Port å€¼ï¼špodman-compose å®šä¹‰æ–‡ä»¶ä¸­å¯¹å¤–æš´éœ²çš„ SSH ç«¯å£å·ã€‚\n    - HTTP Port å€¼ï¼šé»˜è®¤ `3000` ç«¯å£ã€‚  \n  - Web é¡µé¢ä¸­æœ€åéœ€è®¾ç½® Gogs ç®¡ç†å‘˜è´¦å·ä»¥å®Œæˆå®‰è£…ã€‚  \n  - å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•æˆ–é‡æ–°æ³¨å†Œæ–°è´¦å·ç™»å½•ä¸ä½¿ç”¨ã€‚  \n  - å¦‚ä¸‹æ‰€ç¤ºï¼Œä½¿ç”¨ `devops` ç”¨æˆ·åˆ›å»ºæ–°ä»£ç åº“å¹¶å®Œæˆ commit æäº¤ï¼š![gogs-git-repository.jpg](gogs-git-repository.jpg)  \n  - å¦‚éœ€å…³é—­ Gogs ä»£ç ä»“åº“ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœæ­¢ gogs ä¸ postgresql å®¹å™¨æœåŠ¡å³å¯ï¼š    \n    ```bash\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app stop gogs postgresql\n      using podman version: podman version 3.2.3\n      podman stop -t 10 gogs\n      gogs\n      0\n      podman stop -t 10 gogs-postgresql\n      gogs-postgresql\n      0\n    $ podman ps\n      CONTAINER ID  IMAGE                 COMMAND     CREATED       STATUS             PORTS                                                                   NAMES\n      b6df150a3a49  k8s.gcr.io/pause:3.5              30 hours ago  Up 39 minutes ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  c3a10da46f18-infra  \n    ```\n\n    > ğŸ’¥**æ³¨æ„ï¼š**\n    > \n    > åˆ‡ä¸å¯ç›´æ¥ä½¿ç”¨ podman-compose å‘½ä»¤çš„ `down` å­å‘½ä»¤ï¼Œè¯¥å­å‘½ä»¤å°†æ‰€æœ‰ç›¸å…³çš„å®¹å™¨ä¸ pod å…¨éƒ¨åˆ é™¤ï¼Œpod åˆ é™¤åæ— æ³•å°†å…¶ä¸­çš„å„å®¹å™¨æ˜ å°„è‡³å®¿ä¸»æœºå¯¹åº”çš„ç›®å½•ä¸­ï¼Œå³ä½¿åŸå§‹æ•°æ®ä¾ç„¶ä¿ç•™äºç›®å½•ä¸­ã€‚\n\n  - é‡æ–°å¯åŠ¨ Gogs ä»£ç ä»“åº“çš„æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š \n    ```bash\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app start gogs postgresql\n      using podman version: podman version 3.2.3\n      podman start gogs\n      gogs\n      0\n      podman start gogs-postgresql\n      gogs-postgresql\n      0\n    ```\n\n### podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\n- `podman-compose` çš„ä½¿ç”¨ä¾èµ–äº `python` ç‰ˆæœ¬ä»¥åŠä¾èµ–åŒ…ï¼Œè‹¥åœ¨ä¸åŒå¹³å°ä¸­ä½¿ç”¨å¯èƒ½å­˜åœ¨æ— æ³•å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„ python åŠä¾èµ–åŒ…çš„æƒ…å†µï¼Œå› æ­¤ podman-compose å¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³å•æœºä¸Šçš„å¤šå®¹å™¨ç¼–æ’é—®é¢˜ã€‚\n- å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œpodman è‡ªå¸¦çš„ `podman pod` å­å‘½ä»¤å¯åŸç”Ÿæ”¯æŒå¤šå®¹å™¨ç¼–æ’ï¼Œè¯¥å‘½ä»¤å¯å°†å¤šå®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ä½¿ç”¨ç›¸åŒçš„ `network namespace` ä»¥æ›´æ–¹ä¾¿çš„è°ƒé…å®¹å™¨ã€‚\n- å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºï¼š  \n  ğŸ‘‰ ä»å¤´åˆ›å»º pod å¹¶é™„åŠ é¢å¤–çš„å®¹å™¨ï¼š  \n  ```bash\n  $ podman pod create --name <pod_name> [-p <host_port>:<pod_port>]\n  # ä½¿ç”¨ pause å®¹å™¨é•œåƒä»å¤´åˆ›å»º pod\n  # è‹¥ä¹‹åéœ€åœ¨ pod ä¸­åˆ›å»ºä½¿ç”¨ç«¯å£æ˜ å°„çš„å®¹å™¨ï¼Œéœ€è¦åœ¨åˆ›å»º pod ä¹‹åˆæŒ‡å®šç«¯å£æ˜ å°„å…³ç³»ï¼Œæ— æ³•åœ¨åˆ›å»ºå®¹å™¨æ—¶æŒ‡å®šï¼Œç”±äº pod\n  # æä¾›äº†å…¶ä¸­æ‰€æœ‰å®¹å™¨çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€‚\n  # æ³¨æ„ï¼šè‹¥éœ€æŒ‡å®šå¤šä¸ªç«¯å£ï¼Œå¯åŒæ—¶ä½¿ç”¨å¤šä¸ª -p é€‰é¡¹ã€‚\n  $ podman run -d --name <container_name> --pod <pod_name> <container_image>:<tag>\n  # åˆ›å»ºå®¹å™¨å°†å…¶é™„åŠ åˆ° pod ä¸­\n  $ podman pod [ps|list|ls]\n  # æŸ¥çœ‹å·²å­˜åœ¨çš„ pod\n  $ podman pod [stop|rm] <pod_name>\n  # åœæ­¢æˆ–åˆ é™¤ podï¼Œå°†ä¸€å¹¶åˆ é™¤ pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚\n  ```\n\n  > ğŸ“Œ**æ³¨æ„ï¼š**\n  > \n  > 1. `k8s.gcr.io/pause:3.5` é•œåƒæ‹‰å–éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚\n  > 2. è‹¥æ— æ³•æ‹‰å–ï¼Œå¯å…ˆæ‹‰å– `registry.aliyuncs.com/google_containers/pause:3.5` é•œåƒï¼Œå†æ›´æ”¹å…¶ `tag` å³å¯ã€‚\n\n  ğŸ‘‰ éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º podï¼š  \n  ```bash\n  $ podman run -d \\\n    --name <container_name> --pod new:<pod_name> \\\n    [-p <host_port>:<pod_port>] \\\n    <container_image>:<tag>\n  # éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º pod\n  $ podman run -d \\\n    --name <container_name> --pod <pod_name> \\\n    <container_image>:<tag>\n  # åœ¨ pod ä¸­åˆ›å»ºæ–°çš„å®¹å™¨\n  ```\n- ç¤ºä¾‹ 1ï¼š  \n  å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ›å»ºåä¸º `nginx-docs` çš„å®¹å™¨å¹¶åŒæ—¶åˆ›å»ºåä¸º `docker-docs` çš„ podï¼Œä¹Ÿå¯åˆ›å»ºå…¶ä»–å®¹å™¨æ·»åŠ è‡³ pod ä¸­ï¼Œpod ä¸­çš„å®¹å™¨å…±äº« `network namespace`ï¼š![podman-run-pod-create.jpg](podman-run-pod-create.jpg)\n- ğŸ¤˜ ç¤ºä¾‹ 2ï¼š\n  ä½¿ç”¨ podman åœ¨å•ä¸ª pod ä¸­é›†æˆå¤šå®¹å™¨çš„æ–¹æ³•ï¼Œå¯å‚è€ƒ [ä¹‹å‰å‘å¸ƒçš„æ–‡æ¡£](https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/)ï¼Œè¯¥æ–‡æ¡£ä¸­å°† Quayã€MySQL ä¸ Redis çš„å•å®¹å™¨é›†æˆåœ¨å•ä¸ª pod ä¸­ï¼Œä½¿ç”¨ pod çš„ `network namespace` æ–¹ä¾¿ Quay é•œåƒä»“åº“çš„ç®¡ç†ã€‚\n\n### ğŸš€ ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²ï¼š\n- é™¤ä¸Šè¿° podman pod å®¹å™¨ç¼–æ’çš„æ–¹å¼ä»¥å¤–ï¼Œpodman ä¹Ÿå·²æ”¯æŒç±»ä¼¼äºä½¿ç”¨ `Kubernetes` ç»“æ„åŒ– `yaml` æ–‡ä»¶çš„æ–¹å¼ï¼Œå³å¯ä½¿ç”¨ `podman kube play` åˆ›å»º `Pod`ã€`Deployment` ä¸ `PersistentVolumeClaim` ç­‰ã€‚\n- å¯å°†ç”± `podman pod create` åˆ›å»ºçš„ pod é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶ï¼š  \n  ```bash\n  $ podman generate kube <pod_name> > <application_name>.yml\n  # å¯¼å‡ºå·²å­˜åœ¨ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶\n  ```\n- è¯¥ç¤ºä¾‹ä¸­ç”Ÿæˆçš„ pod èµ„æºå®šä¹‰æ–‡ä»¶éœ€ç¨åŠ æ”¹åŠ¨ç”¨äºåº”ç”¨çš„éƒ¨ç½²ï¼Œå¯å‚è€ƒ [è¯¥é“¾æ¥](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/mywpblog-pod.yml)ï¼š  \n  ```yaml\n  apiVersion: v1\n  kind: Pod\n  metadata:\n    labels:\n      app: mywpblog\n    name: mywpblog\n  spec:\n    automountServiceAccountToken: false\n    containers:\n    - args:\n      - mysqld\n      env:\n      - name: MYSQL_USER\n        value: wp_user\n      - name: MYSQL_ROOT_PASSWORD\n        value: redhat\n      - name: MYSQL_PASSWORD\n        value: wp_pass\n      - name: MYSQL_DATABASE\n        value: wp_blog\n      image: docker.io/library/mysql:5.7.40-debian\n      name: wpdatabase\n      ports:\n      - containerPort: 3306\n        hostPort: 3306\n      resources: {}\n      securityContext:\n        capabilities:\n          drop:\n          - CAP_MKNOD\n          - CAP_NET_RAW\n          - CAP_AUDIT_WRITE\n      volumeMounts:\n      - mountPath: /var/lib/mysql\n        name: tmp-wpdbfiles-host-0\n    - args:\n      - apache2-foreground\n      env:\n      - name: WORDPRESS_DB_NAME\n        value: wp_blog\n      - name: WORDPRESS_DB_HOST\n        value: \"0.0.0.0\"\n        # WORDPRESS_DB_HOST definied as '0.0.0.0' because two containers \n        # use same network namespace\n        # WORDPRESS_DB_HOST is different from 'podman pod create' and \n        # 'podman kube play'.\n      - name: WORDPRESS_DB_USER\n        value: wp_user\n      - name: WORDPRESS_DB_PASSWORD\n        value: wp_pass\n      image: docker.io/library/wordpress:6.1.1-php7.4-apache\n      name: wpfrontend\n      ports:\n        - containerPort: 80\n          hostPort: 8080\n      resources: {}\n      securityContext:\n        capabilities:\n          drop:\n          - CAP_MKNOD\n          - CAP_NET_RAW\n          - CAP_AUDIT_WRITE\n      volumeMounts:\n      - mountPath: /var/www/html\n        name: tmp-wpfront-host-0\n    enableServiceLinks: false\n    hostname: mywpblog\n    restartPolicy: Never\n    volumes:\n    - hostPath:\n        path: /tmp/wpdbfiles\n        type: Directory\n      name: tmp-wpdbfiles-host-0\n    - hostPath:\n        path: /tmp/wpfront\n        type: Directory\n      name: tmp-wpfront-host-0\n  status: {}\n  ```\n- ä½¿ç”¨è¯¥ [è„šæœ¬](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/wpblog-pod-manage) å®ç° WordPress åº”ç”¨çš„ä¸€é”®éƒ¨ç½²ä¸ç®¡ç†ï¼ŒWordPress å®¹å™¨ä¸ MySQL å®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ï¼Œè¿è¡ŒæˆåŠŸåæ‰“å¼€æµè§ˆå™¨å³å¯è®¿é—®å®‰è£… WordPress åº”ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n  ```bash\n  $ ./wpblog-pod-manage --kube-deploy\n  ---> Start deploy blog pod...\n  ---> Use podman kube play to create and run pod...\n  Pod:\n  7e8d6586ed246380fdb9ee00e73361b16938d4f2d5b646041f5036d9b7e4e8ae\n  Containers:\n  5132590944a03adcdfc08ba27945c708ae23b19fdce24fbcda9df6c845b5bc4e\n  cc2e7cb2a3a5423a7f0d93d07590b5826657eeb59d0491c5578dde0a1d10de1e\n  ---> Pod and containers as followings...\n  POD ID        NAME        STATUS      CREATED         INFRA ID      # OF CONTAINERS\n  7e8d6586ed24  mywpblog    Running     34 seconds ago  ca2ea53dfcbb  3\n  \n  CONTAINER ID  IMAGE                                            COMMAND               CREATED         STATUS            PORTS                                         NAMES\n  ca2ea53dfcbb  localhost/podman-pause:4.3.0-1666339791                                35 seconds ago  Up 2 seconds ago  0.0.0.0:3306->3306/tcp, 0.0.0.0:8080->80/tcp  7e8d6586ed24-infra    \n  5132590944a0  docker.io/library/mysql:5.7.40-debian            mysqld                19 seconds ago  Up 2 seconds ago  0.0.0.0:3306->3306/tcp, 0.0.0.0:8080->80/tcp  mywpblog-wpdatabase   \n  cc2e7cb2a3a5  docker.io/library/wordpress:6.1.1-php7.4-apache  apache2-foregroun...  4 seconds ago   Up 2 seconds ago  0.0.0.0:3306->3306/tcp, 0.0.0.0:8080->80/tcp  mywpblog-wpfrontend   \n  # ä½¿ç”¨ podman kube play çš„æ–¹å¼éƒ¨ç½² WordPress åº”ç”¨\n  ```\n\n### Podman æŠ¥é”™ç¤ºä¾‹ï¼š\n- podman å®¹å™¨é•œåƒä»“åº“çš„é…ç½®æ–¹å¼ï¼š  \n  - å…¨å±€é…ç½®ï¼š`/etc/containers/registries.conf`\n  - å±€éƒ¨é…ç½®ï¼š`$HOME/.config/containers/registroes.conf`\n- è‹¥ podman å®‰è£…ååœ¨ä»¥ä¸Šé…ç½®ä¸­æœªå”¯ä¸€æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“ï¼Œé‚£ä¹ˆåœ¨æ‹‰å–å®¹å™¨é•œåƒæ—¶ï¼Œå°†äº¤äº’å¼æç¤ºç”¨æˆ·é€‰æ‹©å®¹å™¨é•œåƒä»“åº“ã€‚\n- Podman ç™»å½•å®¹å™¨é•œåƒä»“åº“çš„æ–¹å¼ï¼š  \n  - ä½¿ç”¨ `podman login` å­å‘½ä»¤ç™»å½•æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“æ—¶ï¼ŒPodman å°†è®¿é—® token é»˜è®¤å­˜å‚¨äº `/run/user/<UID>/containers/auth.json` æ–‡ä»¶ä¸­ï¼Œå½“ logout ä»“åº“æ—¶ï¼Œè¯¥ token å°†è¢«ç§»é™¤ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶ä¸­å¯å­˜å‚¨å¤šä¸ªç™»å½•çš„ä»“åº“ tokenã€‚![podman-login-token.jpg](podman-login-token.jpg)    \n    ```bash\n    $ podman logout --all\n    # ç™»å‡ºæ‰€æœ‰çš„å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶ä» auth.json æ–‡ä»¶ä¸­ç§»é™¤æ‰€æœ‰çš„ tokenã€‚\n    ```\n  - Podman é»˜è®¤æƒ…å†µä¸‹éœ€è¦ä¸å®¹å™¨é•œåƒä»“åº“ä½¿ç”¨ `TLS` è®¤è¯ï¼Œè‹¥å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLSã€ä½¿ç”¨è‡ªç­¾åçš„ TLS è¯ä¹¦æˆ–æœªçŸ¥çš„ CA ç­¾ç½²çš„è¯ä¹¦ï¼Œéœ€å¯¹ loginã€pull æˆ– push å­å‘½ä»¤æ·»åŠ  `--tls-verify=false` é€‰é¡¹ä»¥å®Œæˆè®¤è¯ã€‚  \n  - Skopeo ä¸ Buildah ä¹Ÿå¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ tokenï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ã€‚\n- ç¤ºä¾‹ 1ï¼š  \n  ğŸ‘‰ podman v3.2.3 ç™»å½• Harbor v1.8.1 èº«ä»½è®¤è¯æŠ¥é”™ï¼š  \n  ```bash\n  $ podman login harbor.domain12.example.com:8880\n    Username: admin\n    Password: redhat\n    Error: authenticating creds for \"harbor.domain12.example.com:8880\": error pinging docker registry \n    harbor.domain12.example.com:8880: Get \"https://harbor.domain12.example.com:8880/v2/\": \n    http: server gave HTTP response to HTTPS client\n  # Podman æœªåšä»»ä½•é…ç½®ç™»å½• Harbor æŠ¥é”™ï¼Œè¯¥ Harbor å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLS åŠ å¯†ä¼ è¾“ã€‚\n  # æŠ¥é”™æ˜¾ç¤º Harbor å“åº” HTTP è¯·æ±‚ï¼Œè€Œ Podman å‘é€ HTTPS è¯·æ±‚ç™»å½•ã€‚\n  # å› æ­¤ï¼Œå°† Podman é…ç½®ä¸ºå‘é€ HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚\n  ```\n  ğŸ¤” è§£å†³æ–¹å¼ä¸€ï¼š  \n  ```bash\n  $ podman login --tls-verify=false harbor.domain12.example.com:8880\n    Username: admin\n    Password: redhat\n    Login Succeeded!\n  # Podman æœªè¿›è¡Œä»»ä½•é…ç½®ï¼Œç›´æ¥ä½¿ç”¨ --tls-verify=false é€‰é¡¹å³å¯è®¤è¯ç™»å½•ã€‚\n  ```\n  ğŸ¤” è§£å†³æ–¹å¼äºŒï¼š  \n  ```bash\n  $ mkdir -p ~/.config/containers/ && cd ~/.config/containers/\n  # åˆ›å»ºæ™®é€šç”¨æˆ· rootless å®¹å™¨çš„ç›®å½•\n  $ vim ~/.config/containers/registries.conf\n    unqualified-search-registries = ['harbor.domain12.example.com:8880']\n  \n    [[registry]]\n    location = \"harbor.domain12.example.com:8880\"\n    insecure = true\n    # If true, unencrypted HTTP as well as TLS connections with untrusted\n    # certificates are allowed.\n    block = false\n  # é…ç½®æœªåŠ å¯†ä¼ è¾“çš„ Harbor å®¹å™¨é•œåƒä»“åº“çš„ä¸»æœºåä¸ç«¯å£\n  \n  $ podman login --log-level=debug harbor.domain12.example.com:8880\n    INFO[0000] podman filtering at log level debug\n    DEBU[0000] Called login.PersistentPreRunE(podman login --log-level=debug harbor.domain12.example.com:8880)\n    DEBU[0000] overlay storage already configured with a mount-program\n    DEBU[0000] Merged system config \"/usr/share/containers/containers.conf\"\n    DEBU[0000] overlay storage already configured with a mount-program\n    DEBU[0000] Using conmon: \"/usr/bin/conmon\"\n    ...\n    DEBU[0000] Using OCI runtime \"/usr/bin/runc\"\n    DEBU[0000] Default CNI network name podman is unchangeable\n    INFO[0000] Setting parallel job count to 13\n    DEBU[0000] Loading registries configuration \"/home/kiosk/.config/containers/registries.conf\"\n    DEBU[0000] Loading registries configuration \"/etc/containers/registries.conf.d/000-shortnames.conf\"\n    DEBU[0000] Loading registries configuration \"/etc/containers/registries.conf.d/001-rhel-shortnames.conf\"\n    DEBU[0000] Loading registries configuration \"/etc/containers/registries.conf.d/002-rhel-shortnames-overrides.conf\"\n    DEBU[0000] No credentials for harbor.domain12.example.com:8880 found\n    Username: admin\n    Password: # äº¤äº’å¼è¾“å…¥ç™»å½•å¯†ç \n    DEBU[0004] Looking for TLS certificates and private keys in /etc/docker/certs.d/harbor.domain12.example.com:8880\n    DEBU[0004] GET https://harbor.domain12.example.com:8880/v2/\n    DEBU[0004] Ping https://harbor.domain12.example.com:8880/v2/ err Get \"https://harbor.domain12.example.com:8880/v2/\": http: \n    server gave HTTP response to HTTPS client (&url.Error{Op:\"Get\", URL:\"https://harbor.domain12.example.com:8880/v2/\", \n    Err:(*errors.errorString)(0xc000590030)})\n    ...\n    DEBU[0004] GET http://harbor.domain12.example.com:8880/service/token?account=admin&service=harbor-registry\n    DEBU[0004] GET http://harbor.domain12.example.com:8880/v2/\n    DEBU[0004] Stored credentials for harbor.domain12.example.com:8880 in credential helper containers-auth.json\n    Login Succeeded!\n    DEBU[0004] Called login.PersistentPostRunE(podman login --log-level=debug harbor.domain12.example.com:8880)\n  # Podman é»˜è®¤ä½¿ç”¨ TLS åŠ å¯†ä¼ è¾“\n  # ä»¥ä¸Šé…ç½®æ–‡ä»¶å°†ä½¿ Podman ä»¥ HTTP æ–¹å¼è®¤è¯ç™»å½• Harborã€‚\n  ```\n- ç¤ºä¾‹ 2ï¼š \n  ğŸ‘‰ podman v3.2.3 æ¨é€å®¹å™¨é•œåƒè‡³ Harbor v1.8.1 ä¸­æ˜¾ç¤º \"ä¸å®Œæ•´\"ï¼š  \n  ```bash\n  $ podman push harbor.domain12.example.com:8880/library/apache-rhce8.2-alpine:1.0\n    Getting image source signatures\n    Copying blob 551db21ded82 skipped: already exists\n    Copying blob 8213d0880f11 skipped: already exists\n    Copying blob e2eb06d8af82 skipped: already exists\n    ...\n    Copying blob 05e56f8d5aae skipped: already exists\n    Copying blob 631e8a8040bb skipped: already exists\n    Copying blob dedba5c062fc skipped: already exists\n    Copying blob 0e609f35aa06 [--------------------------------------] 0.0b / 0.0b\n    Copying config 34f32c2e7a [======================================] 10.0KiB / 10.0KiB\n    Writing manifest to image destination\n    Storing signatures\n  ```\n  ä»æ¨é€çš„è¿”å›ç»“æœæ˜¾ç¤ºï¼Œå…·æœ‰ 2 å±‚å®¹å™¨é•œåƒå±‚ä¼¼ä¹æœªæ¨é€æˆåŠŸï¼Œä½†å°†è¯¥é•œåƒä» Harbor ä¸­æ‹‰å–å¹¶é‡æ–°è¿è¡Œå®¹å™¨åï¼Œå®¹å™¨èƒ½æ­£å¸¸æä¾›æœåŠ¡ï¼Œå› æ­¤æœ€å 2 å±‚é•œåƒå±‚å®é™…æ¨é€æˆåŠŸã€‚\n- ç¤ºä¾‹ 3ï¼š  \n  ğŸ‘‰ å®¹å™¨é•œåƒæ— ä»»ä½•è¿è¡Œæˆ–é€€å‡ºçŠ¶æ€å®¹å™¨å ç”¨ï¼Œä½†ä¾ç„¶æ— æ³•åˆ é™¤é•œåƒï¼Œå¯å°è¯•ä½¿ç”¨ `--force` é€‰é¡¹å°†å…¶å¼ºåˆ¶åˆ é™¤ã€‚![podman-rmi-error-no-container-use.jpg](podman-rmi-error-no-container-use.jpg)\n- ç¤ºä¾‹ 4ï¼š\n  ğŸ‘‰ ç”±äºä» `dockerbub` ä¸Šç›´æ¥æ‹‰å–çš„é•œåƒä¸º `docker image format`ï¼Œæ— æ³•ä½¿ç”¨ `podman commit` å‘½ä»¤æäº¤ä¸ºæ–°çš„å®¹å™¨é•œåƒï¼Œè¯¥å‘½ä»¤å¯¹äº `-m` é€‰é¡¹ä¸èƒ½å¯¹ docker image format é•œåƒç”Ÿæ•ˆï¼Œé»˜è®¤åªæ”¯æŒ `OCI image format`ï¼Œå› æ­¤ä½¿ç”¨ -m é€‰é¡¹å¯¹å®¹å™¨æ‰§è¡Œæäº¤æ—¶éœ€å¼ºåˆ¶æŒ‡å®š `-f docker` æ‰èƒ½ç”Ÿæ•ˆã€‚\n  \n  > ğŸ“Œ**æ³¨æ„ï¼š**\n  > \n  > å¯ä½¿ç”¨ `skopeo` å·¥å…·è½¬æ¢ docker image format ä¸ OCI image formatã€‚\n  \n  ![podman-commit-warning.jpg](podman-commit-warning.jpg)\n\n- ç¤ºä¾‹ 5ï¼š\n  ğŸ‘‰ podman è¿è¡Œ rootfull æˆ– rootless busybox å®¹å™¨åï¼Œ`ping` å¤–ç½‘æŠ¥é”™æƒé™é—®é¢˜æ— æ³• ping é€šå¤–ç½‘ï¼Œä½†ä½¿ç”¨å…¶ä»–å·¥å…·å¯ä¸å¤–ç½‘é€šä¿¡ï¼Œé€šè¿‡ [è¯¥æ–‡æ¡£](https://www.redhat.com/sysadmin/container-networking-podman) ä¸­å¯çŸ¥ï¼Œping å‘½ä»¤å¯¹ `capability` æ•æ„Ÿï¼Œå®¹å™¨å¯èƒ½ç¼ºå°‘ `CAP_NET_RAW `capability æ— æ³•é€šè¿‡å®¿ä¸»æœº ping é€šå¤–ç½‘ã€‚  \n  ğŸ‘‰ å½“ç„¶ï¼Œè¿è¡Œå®¹å™¨æ—¶æŒ‡å®š `--privileged` é€‰é¡¹å¯ä½¿å®¹å™¨è·å¾—ä¸å®¿ä¸»æœº root ç”¨æˆ·åŒæ ·çš„ä¸å®¿ä¸»æœºäº¤äº’çš„æƒé™èƒ½åŠ›ï¼Œä½†èµ‹äºˆçš„æƒé™è¿‡é«˜ï¼Œåº”å½“å‹åˆ¶è¯¥æƒé™ï¼Œæ›´å¥½çš„é€‰æ‹©æ˜¯å¯¹è¿è¡Œå®¹å™¨æ·»åŠ é€‚å½“çš„ `Linux capabilities`ã€‚![podman-busybox-capability.jpg](podman-busybox-capability.jpg)\n\n### Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\nPodman æ—¥å¿—é©±åŠ¨ç›®å‰åªæ”¯æŒ `k8s-file`ã€`journald` ä¸ `none`ï¼Œæš‚æ—¶ä¸æ”¯æŒå®¹å™¨æ—¥å¿—çš„ `JSON` æ ¼å¼è¾“å‡ºï¼Œå› æ­¤ä¸èƒ½ä¸æ—¥å¿—æ”¶é›†å¼•æ“ `fluentd` é›†æˆï¼Œç”±å…¶å®ç°å°†æ—¥å¿—ä¼ è¾“è‡³ ELK æˆ– EFK è¿›è¡Œé›†ä¸­å¼çš„å­˜å‚¨ä¸ç´¢å¼•ã€‚","source":"_posts/podman-usage-practice.md","raw":"---\ntitle: Podman å®¹å™¨åŸç†ä¸ä½¿ç”¨ï¼ˆ2ï¼‰\nsubtitle: Podman Architecture and Usage (2)\nheader-img: podman-bg.webp\ndate: 2022-12-05 15:12:51\ntags:\n  - å®¹å™¨\n  - äº‘åŸç”Ÿ\n---\n\n### æ–‡æ¡£è¯´æ˜ï¼š\n- [ä¸Šä¸€ç¯‡](https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/) å·²è¯´æ˜ Podman åŸç†ä¸å®ç°ï¼Œè¯¥æ–‡æ¡£å°†ç»§ç»­è¯´æ˜ Podman å®¹å™¨çš„ä½¿ç”¨ä¸å®è·µã€‚\n\n### æ–‡æ¡£ç›®å½•ï¼š\n- podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹\n- ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“\n- podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹\n- ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²\n- Podman ä½¿ç”¨æŠ¥é”™ç¤ºä¾‹\n- Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½\n\n### podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\n- ç¤ºä¾‹ 1ï¼š  \n  ğŸ‘‰ ä½¿ç”¨ podman å‘½ä»¤ç™»å½• `Quay` å…¬å…±å®¹å™¨é•œåƒä»“åº“å¹¶æ¨é€é•œåƒï¼š![podman-push-quay.jpg](podman-push-quay.jpg)ğŸ‘‰ æœç´¢å¹¶æ‹‰å– Red Hat å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåˆ—è¡¨ï¼š![podman-pull-image.jpg](podman-pull-image.jpg)\n- ç¤ºä¾‹ 2ï¼š  \n  ğŸ¤˜ éƒ¨ç½²å¹¶ä½¿ç”¨äº‘åŸç”Ÿè½»é‡çº§å¯¹è±¡å­˜å‚¨ `MinIO Server`ï¼š  \n  ![minio-server-cloud-native-object-storage-demo-1.jpg](minio-server-cloud-native-object-storage-demo-1.jpg)![minio-server-cloud-native-object-storage-demo-2.jpg](minio-server-cloud-native-object-storage-demo-2.jpg)ä»¥ä¸Šç¤ºä¾‹å°† podman ä¸ systemd é›†æˆå®ç°æ™®é€šç”¨æˆ·çš„ rootless å®¹å™¨å¼€æœºè‡ªå¯åŠ¨ã€‚![minio-server-cloud-native-object-storage-demo-3.jpg](minio-server-cloud-native-object-storage-demo-3.jpg)å…³äº MinIO Server åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨çš„è¯¦ç»†å†…å®¹ï¼Œè¯· [å‚è€ƒå®˜ç½‘](https://min.io/)ã€‚\n- ç¤ºä¾‹ 3ï¼š  \n  ğŸ¤˜ è¯·å‚è€ƒè¯¥æ–‡æ¡£ [éƒ¨ç½² loganalyzer ç®¡ç†é›†ä¸­å¼æ—¥å¿—](https://alberthua-perl.github.io/2022/12/05/loganalyzer-rsyslog-mysql/) ä»¥ç†è§£å¤šä¸ª rootfull å®¹å™¨é—´çš„é€šä¿¡æ–¹å¼ï¼ˆé€šè¿‡ `cni-podman0` ç½‘æ¡¥ä¸ `iptables` äº’ç›¸é€šä¿¡ï¼‰ã€‚\n\n### ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š\n- ä½¿ç”¨ `podman-compose` é€šè¿‡ `link` é“¾æ¥è‡³æŒ‡å®šçš„å®¹å™¨å»ºç«‹é€šä¿¡ã€‚\n- å¦‚ä¸‹æ‰€ç¤ºï¼Œéƒ¨ç½² Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š`Gogs + PostgreSQL`  \n  - å…³äº podman-compose çš„å®‰è£…å¯å‚è€ƒ [GitHub é¡¹ç›®](https://github.com/containers/podman-compose)\n  \n  > ğŸ¤” å¯è€ƒè™‘ä½¿ç”¨ podman-compose éƒ¨ç½²è½»é‡çº§ `Gitea + Drone` CI æŒç»­é›†æˆå¹³å°\n  \n  - å…³äº Gogs é¡¹ç›®çš„è¯¦ç»†å†…å®¹å¯å‚è€ƒ [Gogs GitHub é¡¹ç›®](https://github.com/gogs/gogs)  \n  - Gogs ä»£ç ç‰ˆæœ¬æ§åˆ¶ä»“åº“ä½¿ç”¨ Golang è¯­è¨€å¼€å‘ï¼Œå¯ä¸åç«¯ MySQLã€PostgreSQLã€SQLite3ã€TiDB ç­‰é›†æˆã€‚  \n  - æ­¤å¤„ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½² Gogsï¼Œå¹¶ä¸ PostgreSQL é›†æˆã€‚  \n  - éƒ¨ç½²ç”¨ä¸»æœºä¸Šå¿…é¡»å…ˆå®‰è£… podman ä¸ podman-composeï¼Œå¹¶æ‹‰å–ç›¸åº”å®¹å™¨é•œåƒåŠ é€Ÿéƒ¨ç½²è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š![podman-image-list.jps.JPG](podman-image-list.jps.JPG)\n    \n    > ğŸ“Œ**æ³¨æ„ï¼š**\n    > \n    > podman-compose ä½¿ç”¨åˆ›å»º `pod` å°†å¤šä¸ªå®¹å™¨ç»„å»ºæˆ pod çš„æ–¹å¼è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œå› æ­¤å¿…é¡»å…·æœ‰ `pause` å®¹å™¨é•œåƒæä¾› pod çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ä¸æŒ‚è½½å‘½åç©ºé—´ã€‚\n  \n  - ä½¿ç”¨æ™®é€šç”¨æˆ·éƒ¨ç½²ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  \n    ```bash\n    $ mkdir -p gogs-app/gogs-data/{gogs,gogs-logs,postgresql}\n    # åˆ›å»ºç”¨äºå­˜å‚¨ gogs ä¸ postgresql æ•°æ®æ˜ å°„çš„ç›®å½•\n    $ sudo chown -R 100999:100999 gogs-app/gogs-data/{gogs,gogs-logs}\n    # æ›´æ”¹æ˜ å°„ç›®å½•çš„å±ç»„ï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨æƒé™æŠ¥é”™ã€‚\n    $ getenforce\n      Enforcing\n    # ç¡®è®¤ç³»ç»Ÿå¤„äº enforcing SELinux çŠ¶æ€ï¼Œéœ€è®¾ç½®ç›®å½•æ˜ å°„æ—¶çš„æ ‡ç­¾ã€‚\n    # ä¹Ÿå¯ç¦ç”¨ SELinuxï¼Œè‹¥ç¦ç”¨ SELinuxï¼Œä»¥ä¸‹ä¸¤æ­¥å¯ä¸æ‰§è¡Œå¹¶ä¸”å»é™¤ podman-compose å®šä¹‰æ–‡ä»¶ä¸­çš„ \"Z\"ã€‚\n    $ sudo semanage port -a -t http_port_t -p tcp 10800\n    $ sudo semanage port -a -t ssh_port_t -p tcp 10022\n    # æ·»åŠ è‡ªå®šä¹‰ç«¯å£è‡³ SELinux æ•°æ®åº“ä¸­ï¼Œå¦åˆ™ç”±äºæƒé™é—®é¢˜æ— æ³•è®¿é—®å¹¶å®‰è£… Gogsã€‚\n    $ vim gogs-app/gogs-postgres-podman-compose.yaml\n    ```\n  - å¦‚ä¸‹æ‰€ç¤º `gogs-postgres-podman-compose.yaml` æ–‡ä»¶å¯å‚è€ƒ [æ­¤å¤„](https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/gogs-postgres-compose/gogs-postgres-podman-compose.yaml)ï¼š\n    ```yaml\n    version: \"3\"\n    services:\n      postgresql:\n        image: docker.io/library/postgres:14.1-bullseye\n        container_name: \"gogs-postgresql\"\n        volumes:\n          - \"./gogs-data/postgresql:/var/lib/postgresql:Z\"\n        environment:\n          - \"POSTGRES_USER=gogs\"\n          - \"POSTGRES_PASSWORD=redhat\"\n          - \"POSTGRES_DB=gogs\"\n        ports:\n          - \"5432:5432\"\n    \n      gogs:\n        image: docker.io/gogs/gogs:0.12\n        container_name: \"gogs\"\n        volumes:\n          - \"./gogs-data/gogs:/data:Z\"\n          - \"./gogs-data/gogs-logs:/app/gogs/log:Z\"\n        ports:\n          - \"10022:22\"\n          - \"10800:3000\"\n        links:\n          - postgresql\n    ```\n  - ç¼–è¾‘å®Œæˆ yaml æ–‡ä»¶åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š  \n    ```bash\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app up\n    # å¯åŠ¨ Gogs ä¸ PostgreSQL å®¹å™¨ï¼Œå¹¶æŒ‡å®šé¡¹ç›®åç§°ã€‚\n    # è‹¥ä¸æŒ‡å®šé¡¹ç›®åç§°ï¼Œé¡¹ç›®é»˜è®¤ä¸º yaml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åç§°ã€‚\n    # é¦–æ¬¡å¯åŠ¨å®¹å™¨æ—¶ï¼Œæ‰€æœ‰çš„å¯åŠ¨ä¸è¿è¡Œæ—¥å¿—å°†æ‰“å°è‡³ç»ˆç«¯å±å¹•ä¸Šï¼Œè¯¥ç»ˆç«¯ä¸å¯å…³é—­ï¼Œç›´è‡³å…³é—­æ‰€æœ‰æœåŠ¡å®¹å™¨åå°†è‡ªåŠ¨é€€å‡ºã€‚\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app ps\n      using podman version: podman version 3.2.3\n      podman ps -a --filter label=io.podman.compose.project=gogs-app\n      CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES\n      2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs-postgresql\n      2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs\n      0\n    # æŸ¥çœ‹ podman-compose ç®¡ç†çš„å®¹å™¨æœåŠ¡\n    $ podman ps\n      CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES\n      b6df150a3a49  k8s.gcr.io/pause:3.5                                            6 hours ago  Up 6 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  c3a10da46f18-infra\n      2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs-postgresql\n      2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  gogs\n    # æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŒ…å« infra å®¹å™¨ã€‚\n    ```\n  - æ‰€æœ‰å®¹å™¨æ­£å¸¸è¿è¡Œåï¼Œä½¿ç”¨ `http://<å®¹å™¨å®¿ä¸»æœº IP åœ°å€>:10800` è®¿é—® Gogs å®‰è£…ç•Œé¢ï¼Œéœ€å¡«å…¥çš„å€¼å‚è€ƒå¦‚ä¸‹ï¼š![gogs-settings.jpg](gogs-settings.jpg)    \n    - Run User å€¼ï¼šé»˜è®¤ `git`ã€‚\n    - Domain å€¼ï¼šè‹¥è¦ä»å…¶ä»–ä¸»æœºè¿æ¥è‡³ Gogs ä»“åº“ï¼ŒDomian å¿…é¡»é…ç½®ä¸ºå®¹å™¨å®¿ä¸»æœºçš„ IP åœ°å€æˆ–ä¸»æœºåã€‚\n    - SSH Port å€¼ï¼špodman-compose å®šä¹‰æ–‡ä»¶ä¸­å¯¹å¤–æš´éœ²çš„ SSH ç«¯å£å·ã€‚\n    - HTTP Port å€¼ï¼šé»˜è®¤ `3000` ç«¯å£ã€‚  \n  - Web é¡µé¢ä¸­æœ€åéœ€è®¾ç½® Gogs ç®¡ç†å‘˜è´¦å·ä»¥å®Œæˆå®‰è£…ã€‚  \n  - å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•æˆ–é‡æ–°æ³¨å†Œæ–°è´¦å·ç™»å½•ä¸ä½¿ç”¨ã€‚  \n  - å¦‚ä¸‹æ‰€ç¤ºï¼Œä½¿ç”¨ `devops` ç”¨æˆ·åˆ›å»ºæ–°ä»£ç åº“å¹¶å®Œæˆ commit æäº¤ï¼š![gogs-git-repository.jpg](gogs-git-repository.jpg)  \n  - å¦‚éœ€å…³é—­ Gogs ä»£ç ä»“åº“ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœæ­¢ gogs ä¸ postgresql å®¹å™¨æœåŠ¡å³å¯ï¼š    \n    ```bash\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app stop gogs postgresql\n      using podman version: podman version 3.2.3\n      podman stop -t 10 gogs\n      gogs\n      0\n      podman stop -t 10 gogs-postgresql\n      gogs-postgresql\n      0\n    $ podman ps\n      CONTAINER ID  IMAGE                 COMMAND     CREATED       STATUS             PORTS                                                                   NAMES\n      b6df150a3a49  k8s.gcr.io/pause:3.5              30 hours ago  Up 39 minutes ago  0.0.0.0:10022->22/tcp, 0.0.0.0:10800->3000/tcp, 0.0.0.0:5432->5432/tcp  c3a10da46f18-infra  \n    ```\n\n    > ğŸ’¥**æ³¨æ„ï¼š**\n    > \n    > åˆ‡ä¸å¯ç›´æ¥ä½¿ç”¨ podman-compose å‘½ä»¤çš„ `down` å­å‘½ä»¤ï¼Œè¯¥å­å‘½ä»¤å°†æ‰€æœ‰ç›¸å…³çš„å®¹å™¨ä¸ pod å…¨éƒ¨åˆ é™¤ï¼Œpod åˆ é™¤åæ— æ³•å°†å…¶ä¸­çš„å„å®¹å™¨æ˜ å°„è‡³å®¿ä¸»æœºå¯¹åº”çš„ç›®å½•ä¸­ï¼Œå³ä½¿åŸå§‹æ•°æ®ä¾ç„¶ä¿ç•™äºç›®å½•ä¸­ã€‚\n\n  - é‡æ–°å¯åŠ¨ Gogs ä»£ç ä»“åº“çš„æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š \n    ```bash\n    $ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app start gogs postgresql\n      using podman version: podman version 3.2.3\n      podman start gogs\n      gogs\n      0\n      podman start gogs-postgresql\n      gogs-postgresql\n      0\n    ```\n\n### podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\n- `podman-compose` çš„ä½¿ç”¨ä¾èµ–äº `python` ç‰ˆæœ¬ä»¥åŠä¾èµ–åŒ…ï¼Œè‹¥åœ¨ä¸åŒå¹³å°ä¸­ä½¿ç”¨å¯èƒ½å­˜åœ¨æ— æ³•å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„ python åŠä¾èµ–åŒ…çš„æƒ…å†µï¼Œå› æ­¤ podman-compose å¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³å•æœºä¸Šçš„å¤šå®¹å™¨ç¼–æ’é—®é¢˜ã€‚\n- å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œpodman è‡ªå¸¦çš„ `podman pod` å­å‘½ä»¤å¯åŸç”Ÿæ”¯æŒå¤šå®¹å™¨ç¼–æ’ï¼Œè¯¥å‘½ä»¤å¯å°†å¤šå®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ä½¿ç”¨ç›¸åŒçš„ `network namespace` ä»¥æ›´æ–¹ä¾¿çš„è°ƒé…å®¹å™¨ã€‚\n- å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºï¼š  \n  ğŸ‘‰ ä»å¤´åˆ›å»º pod å¹¶é™„åŠ é¢å¤–çš„å®¹å™¨ï¼š  \n  ```bash\n  $ podman pod create --name <pod_name> [-p <host_port>:<pod_port>]\n  # ä½¿ç”¨ pause å®¹å™¨é•œåƒä»å¤´åˆ›å»º pod\n  # è‹¥ä¹‹åéœ€åœ¨ pod ä¸­åˆ›å»ºä½¿ç”¨ç«¯å£æ˜ å°„çš„å®¹å™¨ï¼Œéœ€è¦åœ¨åˆ›å»º pod ä¹‹åˆæŒ‡å®šç«¯å£æ˜ å°„å…³ç³»ï¼Œæ— æ³•åœ¨åˆ›å»ºå®¹å™¨æ—¶æŒ‡å®šï¼Œç”±äº pod\n  # æä¾›äº†å…¶ä¸­æ‰€æœ‰å®¹å™¨çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€‚\n  # æ³¨æ„ï¼šè‹¥éœ€æŒ‡å®šå¤šä¸ªç«¯å£ï¼Œå¯åŒæ—¶ä½¿ç”¨å¤šä¸ª -p é€‰é¡¹ã€‚\n  $ podman run -d --name <container_name> --pod <pod_name> <container_image>:<tag>\n  # åˆ›å»ºå®¹å™¨å°†å…¶é™„åŠ åˆ° pod ä¸­\n  $ podman pod [ps|list|ls]\n  # æŸ¥çœ‹å·²å­˜åœ¨çš„ pod\n  $ podman pod [stop|rm] <pod_name>\n  # åœæ­¢æˆ–åˆ é™¤ podï¼Œå°†ä¸€å¹¶åˆ é™¤ pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚\n  ```\n\n  > ğŸ“Œ**æ³¨æ„ï¼š**\n  > \n  > 1. `k8s.gcr.io/pause:3.5` é•œåƒæ‹‰å–éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚\n  > 2. è‹¥æ— æ³•æ‹‰å–ï¼Œå¯å…ˆæ‹‰å– `registry.aliyuncs.com/google_containers/pause:3.5` é•œåƒï¼Œå†æ›´æ”¹å…¶ `tag` å³å¯ã€‚\n\n  ğŸ‘‰ éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º podï¼š  \n  ```bash\n  $ podman run -d \\\n    --name <container_name> --pod new:<pod_name> \\\n    [-p <host_port>:<pod_port>] \\\n    <container_image>:<tag>\n  # éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º pod\n  $ podman run -d \\\n    --name <container_name> --pod <pod_name> \\\n    <container_image>:<tag>\n  # åœ¨ pod ä¸­åˆ›å»ºæ–°çš„å®¹å™¨\n  ```\n- ç¤ºä¾‹ 1ï¼š  \n  å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ›å»ºåä¸º `nginx-docs` çš„å®¹å™¨å¹¶åŒæ—¶åˆ›å»ºåä¸º `docker-docs` çš„ podï¼Œä¹Ÿå¯åˆ›å»ºå…¶ä»–å®¹å™¨æ·»åŠ è‡³ pod ä¸­ï¼Œpod ä¸­çš„å®¹å™¨å…±äº« `network namespace`ï¼š![podman-run-pod-create.jpg](podman-run-pod-create.jpg)\n- ğŸ¤˜ ç¤ºä¾‹ 2ï¼š\n  ä½¿ç”¨ podman åœ¨å•ä¸ª pod ä¸­é›†æˆå¤šå®¹å™¨çš„æ–¹æ³•ï¼Œå¯å‚è€ƒ [ä¹‹å‰å‘å¸ƒçš„æ–‡æ¡£](https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/)ï¼Œè¯¥æ–‡æ¡£ä¸­å°† Quayã€MySQL ä¸ Redis çš„å•å®¹å™¨é›†æˆåœ¨å•ä¸ª pod ä¸­ï¼Œä½¿ç”¨ pod çš„ `network namespace` æ–¹ä¾¿ Quay é•œåƒä»“åº“çš„ç®¡ç†ã€‚\n\n### ğŸš€ ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²ï¼š\n- é™¤ä¸Šè¿° podman pod å®¹å™¨ç¼–æ’çš„æ–¹å¼ä»¥å¤–ï¼Œpodman ä¹Ÿå·²æ”¯æŒç±»ä¼¼äºä½¿ç”¨ `Kubernetes` ç»“æ„åŒ– `yaml` æ–‡ä»¶çš„æ–¹å¼ï¼Œå³å¯ä½¿ç”¨ `podman kube play` åˆ›å»º `Pod`ã€`Deployment` ä¸ `PersistentVolumeClaim` ç­‰ã€‚\n- å¯å°†ç”± `podman pod create` åˆ›å»ºçš„ pod é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶ï¼š  \n  ```bash\n  $ podman generate kube <pod_name> > <application_name>.yml\n  # å¯¼å‡ºå·²å­˜åœ¨ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶\n  ```\n- è¯¥ç¤ºä¾‹ä¸­ç”Ÿæˆçš„ pod èµ„æºå®šä¹‰æ–‡ä»¶éœ€ç¨åŠ æ”¹åŠ¨ç”¨äºåº”ç”¨çš„éƒ¨ç½²ï¼Œå¯å‚è€ƒ [è¯¥é“¾æ¥](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/mywpblog-pod.yml)ï¼š  \n  ```yaml\n  apiVersion: v1\n  kind: Pod\n  metadata:\n    labels:\n      app: mywpblog\n    name: mywpblog\n  spec:\n    automountServiceAccountToken: false\n    containers:\n    - args:\n      - mysqld\n      env:\n      - name: MYSQL_USER\n        value: wp_user\n      - name: MYSQL_ROOT_PASSWORD\n        value: redhat\n      - name: MYSQL_PASSWORD\n        value: wp_pass\n      - name: MYSQL_DATABASE\n        value: wp_blog\n      image: docker.io/library/mysql:5.7.40-debian\n      name: wpdatabase\n      ports:\n      - containerPort: 3306\n        hostPort: 3306\n      resources: {}\n      securityContext:\n        capabilities:\n          drop:\n          - CAP_MKNOD\n          - CAP_NET_RAW\n          - CAP_AUDIT_WRITE\n      volumeMounts:\n      - mountPath: /var/lib/mysql\n        name: tmp-wpdbfiles-host-0\n    - args:\n      - apache2-foreground\n      env:\n      - name: WORDPRESS_DB_NAME\n        value: wp_blog\n      - name: WORDPRESS_DB_HOST\n        value: \"0.0.0.0\"\n        # WORDPRESS_DB_HOST definied as '0.0.0.0' because two containers \n        # use same network namespace\n        # WORDPRESS_DB_HOST is different from 'podman pod create' and \n        # 'podman kube play'.\n      - name: WORDPRESS_DB_USER\n        value: wp_user\n      - name: WORDPRESS_DB_PASSWORD\n        value: wp_pass\n      image: docker.io/library/wordpress:6.1.1-php7.4-apache\n      name: wpfrontend\n      ports:\n        - containerPort: 80\n          hostPort: 8080\n      resources: {}\n      securityContext:\n        capabilities:\n          drop:\n          - CAP_MKNOD\n          - CAP_NET_RAW\n          - CAP_AUDIT_WRITE\n      volumeMounts:\n      - mountPath: /var/www/html\n        name: tmp-wpfront-host-0\n    enableServiceLinks: false\n    hostname: mywpblog\n    restartPolicy: Never\n    volumes:\n    - hostPath:\n        path: /tmp/wpdbfiles\n        type: Directory\n      name: tmp-wpdbfiles-host-0\n    - hostPath:\n        path: /tmp/wpfront\n        type: Directory\n      name: tmp-wpfront-host-0\n  status: {}\n  ```\n- ä½¿ç”¨è¯¥ [è„šæœ¬](https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/wpblog-pod-manage) å®ç° WordPress åº”ç”¨çš„ä¸€é”®éƒ¨ç½²ä¸ç®¡ç†ï¼ŒWordPress å®¹å™¨ä¸ MySQL å®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ï¼Œè¿è¡ŒæˆåŠŸåæ‰“å¼€æµè§ˆå™¨å³å¯è®¿é—®å®‰è£… WordPress åº”ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n  ```bash\n  $ ./wpblog-pod-manage --kube-deploy\n  ---> Start deploy blog pod...\n  ---> Use podman kube play to create and run pod...\n  Pod:\n  7e8d6586ed246380fdb9ee00e73361b16938d4f2d5b646041f5036d9b7e4e8ae\n  Containers:\n  5132590944a03adcdfc08ba27945c708ae23b19fdce24fbcda9df6c845b5bc4e\n  cc2e7cb2a3a5423a7f0d93d07590b5826657eeb59d0491c5578dde0a1d10de1e\n  ---> Pod and containers as followings...\n  POD ID        NAME        STATUS      CREATED         INFRA ID      # OF CONTAINERS\n  7e8d6586ed24  mywpblog    Running     34 seconds ago  ca2ea53dfcbb  3\n  \n  CONTAINER ID  IMAGE                                            COMMAND               CREATED         STATUS            PORTS                                         NAMES\n  ca2ea53dfcbb  localhost/podman-pause:4.3.0-1666339791                                35 seconds ago  Up 2 seconds ago  0.0.0.0:3306->3306/tcp, 0.0.0.0:8080->80/tcp  7e8d6586ed24-infra    \n  5132590944a0  docker.io/library/mysql:5.7.40-debian            mysqld                19 seconds ago  Up 2 seconds ago  0.0.0.0:3306->3306/tcp, 0.0.0.0:8080->80/tcp  mywpblog-wpdatabase   \n  cc2e7cb2a3a5  docker.io/library/wordpress:6.1.1-php7.4-apache  apache2-foregroun...  4 seconds ago   Up 2 seconds ago  0.0.0.0:3306->3306/tcp, 0.0.0.0:8080->80/tcp  mywpblog-wpfrontend   \n  # ä½¿ç”¨ podman kube play çš„æ–¹å¼éƒ¨ç½² WordPress åº”ç”¨\n  ```\n\n### Podman æŠ¥é”™ç¤ºä¾‹ï¼š\n- podman å®¹å™¨é•œåƒä»“åº“çš„é…ç½®æ–¹å¼ï¼š  \n  - å…¨å±€é…ç½®ï¼š`/etc/containers/registries.conf`\n  - å±€éƒ¨é…ç½®ï¼š`$HOME/.config/containers/registroes.conf`\n- è‹¥ podman å®‰è£…ååœ¨ä»¥ä¸Šé…ç½®ä¸­æœªå”¯ä¸€æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“ï¼Œé‚£ä¹ˆåœ¨æ‹‰å–å®¹å™¨é•œåƒæ—¶ï¼Œå°†äº¤äº’å¼æç¤ºç”¨æˆ·é€‰æ‹©å®¹å™¨é•œåƒä»“åº“ã€‚\n- Podman ç™»å½•å®¹å™¨é•œåƒä»“åº“çš„æ–¹å¼ï¼š  \n  - ä½¿ç”¨ `podman login` å­å‘½ä»¤ç™»å½•æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“æ—¶ï¼ŒPodman å°†è®¿é—® token é»˜è®¤å­˜å‚¨äº `/run/user/<UID>/containers/auth.json` æ–‡ä»¶ä¸­ï¼Œå½“ logout ä»“åº“æ—¶ï¼Œè¯¥ token å°†è¢«ç§»é™¤ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶ä¸­å¯å­˜å‚¨å¤šä¸ªç™»å½•çš„ä»“åº“ tokenã€‚![podman-login-token.jpg](podman-login-token.jpg)    \n    ```bash\n    $ podman logout --all\n    # ç™»å‡ºæ‰€æœ‰çš„å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶ä» auth.json æ–‡ä»¶ä¸­ç§»é™¤æ‰€æœ‰çš„ tokenã€‚\n    ```\n  - Podman é»˜è®¤æƒ…å†µä¸‹éœ€è¦ä¸å®¹å™¨é•œåƒä»“åº“ä½¿ç”¨ `TLS` è®¤è¯ï¼Œè‹¥å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLSã€ä½¿ç”¨è‡ªç­¾åçš„ TLS è¯ä¹¦æˆ–æœªçŸ¥çš„ CA ç­¾ç½²çš„è¯ä¹¦ï¼Œéœ€å¯¹ loginã€pull æˆ– push å­å‘½ä»¤æ·»åŠ  `--tls-verify=false` é€‰é¡¹ä»¥å®Œæˆè®¤è¯ã€‚  \n  - Skopeo ä¸ Buildah ä¹Ÿå¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ tokenï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ã€‚\n- ç¤ºä¾‹ 1ï¼š  \n  ğŸ‘‰ podman v3.2.3 ç™»å½• Harbor v1.8.1 èº«ä»½è®¤è¯æŠ¥é”™ï¼š  \n  ```bash\n  $ podman login harbor.domain12.example.com:8880\n    Username: admin\n    Password: redhat\n    Error: authenticating creds for \"harbor.domain12.example.com:8880\": error pinging docker registry \n    harbor.domain12.example.com:8880: Get \"https://harbor.domain12.example.com:8880/v2/\": \n    http: server gave HTTP response to HTTPS client\n  # Podman æœªåšä»»ä½•é…ç½®ç™»å½• Harbor æŠ¥é”™ï¼Œè¯¥ Harbor å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLS åŠ å¯†ä¼ è¾“ã€‚\n  # æŠ¥é”™æ˜¾ç¤º Harbor å“åº” HTTP è¯·æ±‚ï¼Œè€Œ Podman å‘é€ HTTPS è¯·æ±‚ç™»å½•ã€‚\n  # å› æ­¤ï¼Œå°† Podman é…ç½®ä¸ºå‘é€ HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚\n  ```\n  ğŸ¤” è§£å†³æ–¹å¼ä¸€ï¼š  \n  ```bash\n  $ podman login --tls-verify=false harbor.domain12.example.com:8880\n    Username: admin\n    Password: redhat\n    Login Succeeded!\n  # Podman æœªè¿›è¡Œä»»ä½•é…ç½®ï¼Œç›´æ¥ä½¿ç”¨ --tls-verify=false é€‰é¡¹å³å¯è®¤è¯ç™»å½•ã€‚\n  ```\n  ğŸ¤” è§£å†³æ–¹å¼äºŒï¼š  \n  ```bash\n  $ mkdir -p ~/.config/containers/ && cd ~/.config/containers/\n  # åˆ›å»ºæ™®é€šç”¨æˆ· rootless å®¹å™¨çš„ç›®å½•\n  $ vim ~/.config/containers/registries.conf\n    unqualified-search-registries = ['harbor.domain12.example.com:8880']\n  \n    [[registry]]\n    location = \"harbor.domain12.example.com:8880\"\n    insecure = true\n    # If true, unencrypted HTTP as well as TLS connections with untrusted\n    # certificates are allowed.\n    block = false\n  # é…ç½®æœªåŠ å¯†ä¼ è¾“çš„ Harbor å®¹å™¨é•œåƒä»“åº“çš„ä¸»æœºåä¸ç«¯å£\n  \n  $ podman login --log-level=debug harbor.domain12.example.com:8880\n    INFO[0000] podman filtering at log level debug\n    DEBU[0000] Called login.PersistentPreRunE(podman login --log-level=debug harbor.domain12.example.com:8880)\n    DEBU[0000] overlay storage already configured with a mount-program\n    DEBU[0000] Merged system config \"/usr/share/containers/containers.conf\"\n    DEBU[0000] overlay storage already configured with a mount-program\n    DEBU[0000] Using conmon: \"/usr/bin/conmon\"\n    ...\n    DEBU[0000] Using OCI runtime \"/usr/bin/runc\"\n    DEBU[0000] Default CNI network name podman is unchangeable\n    INFO[0000] Setting parallel job count to 13\n    DEBU[0000] Loading registries configuration \"/home/kiosk/.config/containers/registries.conf\"\n    DEBU[0000] Loading registries configuration \"/etc/containers/registries.conf.d/000-shortnames.conf\"\n    DEBU[0000] Loading registries configuration \"/etc/containers/registries.conf.d/001-rhel-shortnames.conf\"\n    DEBU[0000] Loading registries configuration \"/etc/containers/registries.conf.d/002-rhel-shortnames-overrides.conf\"\n    DEBU[0000] No credentials for harbor.domain12.example.com:8880 found\n    Username: admin\n    Password: # äº¤äº’å¼è¾“å…¥ç™»å½•å¯†ç \n    DEBU[0004] Looking for TLS certificates and private keys in /etc/docker/certs.d/harbor.domain12.example.com:8880\n    DEBU[0004] GET https://harbor.domain12.example.com:8880/v2/\n    DEBU[0004] Ping https://harbor.domain12.example.com:8880/v2/ err Get \"https://harbor.domain12.example.com:8880/v2/\": http: \n    server gave HTTP response to HTTPS client (&url.Error{Op:\"Get\", URL:\"https://harbor.domain12.example.com:8880/v2/\", \n    Err:(*errors.errorString)(0xc000590030)})\n    ...\n    DEBU[0004] GET http://harbor.domain12.example.com:8880/service/token?account=admin&service=harbor-registry\n    DEBU[0004] GET http://harbor.domain12.example.com:8880/v2/\n    DEBU[0004] Stored credentials for harbor.domain12.example.com:8880 in credential helper containers-auth.json\n    Login Succeeded!\n    DEBU[0004] Called login.PersistentPostRunE(podman login --log-level=debug harbor.domain12.example.com:8880)\n  # Podman é»˜è®¤ä½¿ç”¨ TLS åŠ å¯†ä¼ è¾“\n  # ä»¥ä¸Šé…ç½®æ–‡ä»¶å°†ä½¿ Podman ä»¥ HTTP æ–¹å¼è®¤è¯ç™»å½• Harborã€‚\n  ```\n- ç¤ºä¾‹ 2ï¼š \n  ğŸ‘‰ podman v3.2.3 æ¨é€å®¹å™¨é•œåƒè‡³ Harbor v1.8.1 ä¸­æ˜¾ç¤º \"ä¸å®Œæ•´\"ï¼š  \n  ```bash\n  $ podman push harbor.domain12.example.com:8880/library/apache-rhce8.2-alpine:1.0\n    Getting image source signatures\n    Copying blob 551db21ded82 skipped: already exists\n    Copying blob 8213d0880f11 skipped: already exists\n    Copying blob e2eb06d8af82 skipped: already exists\n    ...\n    Copying blob 05e56f8d5aae skipped: already exists\n    Copying blob 631e8a8040bb skipped: already exists\n    Copying blob dedba5c062fc skipped: already exists\n    Copying blob 0e609f35aa06 [--------------------------------------] 0.0b / 0.0b\n    Copying config 34f32c2e7a [======================================] 10.0KiB / 10.0KiB\n    Writing manifest to image destination\n    Storing signatures\n  ```\n  ä»æ¨é€çš„è¿”å›ç»“æœæ˜¾ç¤ºï¼Œå…·æœ‰ 2 å±‚å®¹å™¨é•œåƒå±‚ä¼¼ä¹æœªæ¨é€æˆåŠŸï¼Œä½†å°†è¯¥é•œåƒä» Harbor ä¸­æ‹‰å–å¹¶é‡æ–°è¿è¡Œå®¹å™¨åï¼Œå®¹å™¨èƒ½æ­£å¸¸æä¾›æœåŠ¡ï¼Œå› æ­¤æœ€å 2 å±‚é•œåƒå±‚å®é™…æ¨é€æˆåŠŸã€‚\n- ç¤ºä¾‹ 3ï¼š  \n  ğŸ‘‰ å®¹å™¨é•œåƒæ— ä»»ä½•è¿è¡Œæˆ–é€€å‡ºçŠ¶æ€å®¹å™¨å ç”¨ï¼Œä½†ä¾ç„¶æ— æ³•åˆ é™¤é•œåƒï¼Œå¯å°è¯•ä½¿ç”¨ `--force` é€‰é¡¹å°†å…¶å¼ºåˆ¶åˆ é™¤ã€‚![podman-rmi-error-no-container-use.jpg](podman-rmi-error-no-container-use.jpg)\n- ç¤ºä¾‹ 4ï¼š\n  ğŸ‘‰ ç”±äºä» `dockerbub` ä¸Šç›´æ¥æ‹‰å–çš„é•œåƒä¸º `docker image format`ï¼Œæ— æ³•ä½¿ç”¨ `podman commit` å‘½ä»¤æäº¤ä¸ºæ–°çš„å®¹å™¨é•œåƒï¼Œè¯¥å‘½ä»¤å¯¹äº `-m` é€‰é¡¹ä¸èƒ½å¯¹ docker image format é•œåƒç”Ÿæ•ˆï¼Œé»˜è®¤åªæ”¯æŒ `OCI image format`ï¼Œå› æ­¤ä½¿ç”¨ -m é€‰é¡¹å¯¹å®¹å™¨æ‰§è¡Œæäº¤æ—¶éœ€å¼ºåˆ¶æŒ‡å®š `-f docker` æ‰èƒ½ç”Ÿæ•ˆã€‚\n  \n  > ğŸ“Œ**æ³¨æ„ï¼š**\n  > \n  > å¯ä½¿ç”¨ `skopeo` å·¥å…·è½¬æ¢ docker image format ä¸ OCI image formatã€‚\n  \n  ![podman-commit-warning.jpg](podman-commit-warning.jpg)\n\n- ç¤ºä¾‹ 5ï¼š\n  ğŸ‘‰ podman è¿è¡Œ rootfull æˆ– rootless busybox å®¹å™¨åï¼Œ`ping` å¤–ç½‘æŠ¥é”™æƒé™é—®é¢˜æ— æ³• ping é€šå¤–ç½‘ï¼Œä½†ä½¿ç”¨å…¶ä»–å·¥å…·å¯ä¸å¤–ç½‘é€šä¿¡ï¼Œé€šè¿‡ [è¯¥æ–‡æ¡£](https://www.redhat.com/sysadmin/container-networking-podman) ä¸­å¯çŸ¥ï¼Œping å‘½ä»¤å¯¹ `capability` æ•æ„Ÿï¼Œå®¹å™¨å¯èƒ½ç¼ºå°‘ `CAP_NET_RAW `capability æ— æ³•é€šè¿‡å®¿ä¸»æœº ping é€šå¤–ç½‘ã€‚  \n  ğŸ‘‰ å½“ç„¶ï¼Œè¿è¡Œå®¹å™¨æ—¶æŒ‡å®š `--privileged` é€‰é¡¹å¯ä½¿å®¹å™¨è·å¾—ä¸å®¿ä¸»æœº root ç”¨æˆ·åŒæ ·çš„ä¸å®¿ä¸»æœºäº¤äº’çš„æƒé™èƒ½åŠ›ï¼Œä½†èµ‹äºˆçš„æƒé™è¿‡é«˜ï¼Œåº”å½“å‹åˆ¶è¯¥æƒé™ï¼Œæ›´å¥½çš„é€‰æ‹©æ˜¯å¯¹è¿è¡Œå®¹å™¨æ·»åŠ é€‚å½“çš„ `Linux capabilities`ã€‚![podman-busybox-capability.jpg](podman-busybox-capability.jpg)\n\n### Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\nPodman æ—¥å¿—é©±åŠ¨ç›®å‰åªæ”¯æŒ `k8s-file`ã€`journald` ä¸ `none`ï¼Œæš‚æ—¶ä¸æ”¯æŒå®¹å™¨æ—¥å¿—çš„ `JSON` æ ¼å¼è¾“å‡ºï¼Œå› æ­¤ä¸èƒ½ä¸æ—¥å¿—æ”¶é›†å¼•æ“ `fluentd` é›†æˆï¼Œç”±å…¶å®ç°å°†æ—¥å¿—ä¼ è¾“è‡³ ELK æˆ– EFK è¿›è¡Œé›†ä¸­å¼çš„å­˜å‚¨ä¸ç´¢å¼•ã€‚","slug":"podman-usage-practice","published":1,"updated":"2022-12-06T02:56:01.829Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cldfonot1001r16vdfvxbn1bd","content":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li><a href=\"https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/\">ä¸Šä¸€ç¯‡</a> å·²è¯´æ˜ Podman åŸç†ä¸å®ç°ï¼Œè¯¥æ–‡æ¡£å°†ç»§ç»­è¯´æ˜ Podman å®¹å™¨çš„ä½¿ç”¨ä¸å®è·µã€‚</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹</li>\n<li>ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“</li>\n<li>podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹</li>\n<li>ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²</li>\n<li>Podman ä½¿ç”¨æŠ¥é”™ç¤ºä¾‹</li>\n<li>Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½</li>\n</ul>\n<h3 id=\"podman-å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\"><a href=\"#podman-å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\"></a>podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š</h3><ul>\n<li>ç¤ºä¾‹ 1ï¼š<br>ğŸ‘‰ ä½¿ç”¨ podman å‘½ä»¤ç™»å½• <code>Quay</code> å…¬å…±å®¹å™¨é•œåƒä»“åº“å¹¶æ¨é€é•œåƒï¼š<img src=\"podman-push-quay.jpg\" alt=\"podman-push-quay.jpg\">ğŸ‘‰ æœç´¢å¹¶æ‹‰å– Red Hat å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåˆ—è¡¨ï¼š<img src=\"podman-pull-image.jpg\" alt=\"podman-pull-image.jpg\"></li>\n<li>ç¤ºä¾‹ 2ï¼š<br>ğŸ¤˜ éƒ¨ç½²å¹¶ä½¿ç”¨äº‘åŸç”Ÿè½»é‡çº§å¯¹è±¡å­˜å‚¨ <code>MinIO Server</code>ï¼š<br><img src=\"minio-server-cloud-native-object-storage-demo-1.jpg\" alt=\"minio-server-cloud-native-object-storage-demo-1.jpg\"><img src=\"minio-server-cloud-native-object-storage-demo-2.jpg\" alt=\"minio-server-cloud-native-object-storage-demo-2.jpg\">ä»¥ä¸Šç¤ºä¾‹å°† podman ä¸ systemd é›†æˆå®ç°æ™®é€šç”¨æˆ·çš„ rootless å®¹å™¨å¼€æœºè‡ªå¯åŠ¨ã€‚<img src=\"minio-server-cloud-native-object-storage-demo-3.jpg\" alt=\"minio-server-cloud-native-object-storage-demo-3.jpg\">å…³äº MinIO Server åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨çš„è¯¦ç»†å†…å®¹ï¼Œè¯· <a href=\"https://min.io/\" target=\"_blank\" rel=\"noopener\">å‚è€ƒå®˜ç½‘</a>ã€‚</li>\n<li>ç¤ºä¾‹ 3ï¼š<br>ğŸ¤˜ è¯·å‚è€ƒè¯¥æ–‡æ¡£ <a href=\"https://alberthua-perl.github.io/2022/12/05/loganalyzer-rsyslog-mysql/\">éƒ¨ç½² loganalyzer ç®¡ç†é›†ä¸­å¼æ—¥å¿—</a> ä»¥ç†è§£å¤šä¸ª rootfull å®¹å™¨é—´çš„é€šä¿¡æ–¹å¼ï¼ˆé€šè¿‡ <code>cni-podman0</code> ç½‘æ¡¥ä¸ <code>iptables</code> äº’ç›¸é€šä¿¡ï¼‰ã€‚</li>\n</ul>\n<h3 id=\"ä½¿ç”¨-podman-compose-å®ç°-Gogs-è½»é‡çº§ä»£ç ä»“åº“ï¼š\"><a href=\"#ä½¿ç”¨-podman-compose-å®ç°-Gogs-è½»é‡çº§ä»£ç ä»“åº“ï¼š\" class=\"headerlink\" title=\"ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š\"></a>ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š</h3><ul>\n<li>ä½¿ç”¨ <code>podman-compose</code> é€šè¿‡ <code>link</code> é“¾æ¥è‡³æŒ‡å®šçš„å®¹å™¨å»ºç«‹é€šä¿¡ã€‚</li>\n<li><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œéƒ¨ç½² Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š<code>Gogs + PostgreSQL</code>  </p>\n<ul>\n<li>å…³äº podman-compose çš„å®‰è£…å¯å‚è€ƒ <a href=\"https://github.com/containers/podman-compose\" target=\"_blank\" rel=\"noopener\">GitHub é¡¹ç›®</a></li>\n</ul>\n<blockquote>\n<p>ğŸ¤” å¯è€ƒè™‘ä½¿ç”¨ podman-compose éƒ¨ç½²è½»é‡çº§ <code>Gitea + Drone</code> CI æŒç»­é›†æˆå¹³å°</p>\n</blockquote>\n<ul>\n<li>å…³äº Gogs é¡¹ç›®çš„è¯¦ç»†å†…å®¹å¯å‚è€ƒ <a href=\"https://github.com/gogs/gogs\" target=\"_blank\" rel=\"noopener\">Gogs GitHub é¡¹ç›®</a>  </li>\n<li>Gogs ä»£ç ç‰ˆæœ¬æ§åˆ¶ä»“åº“ä½¿ç”¨ Golang è¯­è¨€å¼€å‘ï¼Œå¯ä¸åç«¯ MySQLã€PostgreSQLã€SQLite3ã€TiDB ç­‰é›†æˆã€‚  </li>\n<li>æ­¤å¤„ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½² Gogsï¼Œå¹¶ä¸ PostgreSQL é›†æˆã€‚  </li>\n<li><p>éƒ¨ç½²ç”¨ä¸»æœºä¸Šå¿…é¡»å…ˆå®‰è£… podman ä¸ podman-composeï¼Œå¹¶æ‹‰å–ç›¸åº”å®¹å™¨é•œåƒåŠ é€Ÿéƒ¨ç½²è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"podman-image-list.jps.JPG\" alt=\"podman-image-list.jps.JPG\"></p>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<p>podman-compose ä½¿ç”¨åˆ›å»º <code>pod</code> å°†å¤šä¸ªå®¹å™¨ç»„å»ºæˆ pod çš„æ–¹å¼è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œå› æ­¤å¿…é¡»å…·æœ‰ <code>pause</code> å®¹å™¨é•œåƒæä¾› pod çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ä¸æŒ‚è½½å‘½åç©ºé—´ã€‚</p>\n</blockquote>\n</li>\n<li><p>ä½¿ç”¨æ™®é€šç”¨æˆ·éƒ¨ç½²ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -p gogs-app/gogs-data/&#123;gogs,gogs-logs,postgresql&#125;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç”¨äºå­˜å‚¨ gogs ä¸ postgresql æ•°æ®æ˜ å°„çš„ç›®å½•</span></span><br><span class=\"line\">$ sudo chown -R 100999:100999 gogs-app/gogs-data/&#123;gogs,gogs-logs&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ”¹æ˜ å°„ç›®å½•çš„å±ç»„ï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨æƒé™æŠ¥é”™ã€‚</span></span><br><span class=\"line\">$ getenforce</span><br><span class=\"line\">  Enforcing</span><br><span class=\"line\"><span class=\"comment\"># ç¡®è®¤ç³»ç»Ÿå¤„äº enforcing SELinux çŠ¶æ€ï¼Œéœ€è®¾ç½®ç›®å½•æ˜ å°„æ—¶çš„æ ‡ç­¾ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯ç¦ç”¨ SELinuxï¼Œè‹¥ç¦ç”¨ SELinuxï¼Œä»¥ä¸‹ä¸¤æ­¥å¯ä¸æ‰§è¡Œå¹¶ä¸”å»é™¤ podman-compose å®šä¹‰æ–‡ä»¶ä¸­çš„ \"Z\"ã€‚</span></span><br><span class=\"line\">$ sudo semanage port -a -t http_port_t -p tcp 10800</span><br><span class=\"line\">$ sudo semanage port -a -t ssh_port_t -p tcp 10022</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ è‡ªå®šä¹‰ç«¯å£è‡³ SELinux æ•°æ®åº“ä¸­ï¼Œå¦åˆ™ç”±äºæƒé™é—®é¢˜æ— æ³•è®¿é—®å¹¶å®‰è£… Gogsã€‚</span></span><br><span class=\"line\">$ vim gogs-app/gogs-postgres-podman-compose.yaml</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å¦‚ä¸‹æ‰€ç¤º <code>gogs-postgres-podman-compose.yaml</code> æ–‡ä»¶å¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/gogs-postgres-compose/gogs-postgres-podman-compose.yaml\" target=\"_blank\" rel=\"noopener\">æ­¤å¤„</a>ï¼š</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">postgresql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/library/postgres:14.1-bullseye</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">\"gogs-postgresql\"</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"./gogs-data/postgresql:/var/lib/postgresql:Z\"</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"POSTGRES_USER=gogs\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"POSTGRES_PASSWORD=redhat\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"POSTGRES_DB=gogs\"</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"5432:5432\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">gogs:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/gogs/gogs:0.12</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">\"gogs\"</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"./gogs-data/gogs:/data:Z\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"./gogs-data/gogs-logs:/app/gogs/log:Z\"</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"10022:22\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"10800:3000\"</span></span><br><span class=\"line\">    <span class=\"attr\">links:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">postgresql</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç¼–è¾‘å®Œæˆ yaml æ–‡ä»¶åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app up</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ Gogs ä¸ PostgreSQL å®¹å™¨ï¼Œå¹¶æŒ‡å®šé¡¹ç›®åç§°ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># è‹¥ä¸æŒ‡å®šé¡¹ç›®åç§°ï¼Œé¡¹ç›®é»˜è®¤ä¸º yaml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åç§°ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># é¦–æ¬¡å¯åŠ¨å®¹å™¨æ—¶ï¼Œæ‰€æœ‰çš„å¯åŠ¨ä¸è¿è¡Œæ—¥å¿—å°†æ‰“å°è‡³ç»ˆç«¯å±å¹•ä¸Šï¼Œè¯¥ç»ˆç«¯ä¸å¯å…³é—­ï¼Œç›´è‡³å…³é—­æ‰€æœ‰æœåŠ¡å®¹å™¨åå°†è‡ªåŠ¨é€€å‡ºã€‚</span></span><br><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app ps</span><br><span class=\"line\">  using podman version: podman version 3.2.3</span><br><span class=\"line\">  podman ps -a --filter label=io.podman.compose.project=gogs-app</span><br><span class=\"line\">  CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES</span><br><span class=\"line\">  2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs-postgresql</span><br><span class=\"line\">  2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs</span><br><span class=\"line\">  0</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ podman-compose ç®¡ç†çš„å®¹å™¨æœåŠ¡</span></span><br><span class=\"line\">$ podman ps</span><br><span class=\"line\">  CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES</span><br><span class=\"line\">  b6df150a3a49  k8s.gcr.io/pause:3.5                                            6 hours ago  Up 6 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  c3a10da46f18-infra</span><br><span class=\"line\">  2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs-postgresql</span><br><span class=\"line\">  2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŒ…å« infra å®¹å™¨ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æ‰€æœ‰å®¹å™¨æ­£å¸¸è¿è¡Œåï¼Œä½¿ç”¨ <code>http://&lt;å®¹å™¨å®¿ä¸»æœº IP åœ°å€&gt;:10800</code> è®¿é—® Gogs å®‰è£…ç•Œé¢ï¼Œéœ€å¡«å…¥çš„å€¼å‚è€ƒå¦‚ä¸‹ï¼š<img src=\"gogs-settings.jpg\" alt=\"gogs-settings.jpg\">    </p>\n<ul>\n<li>Run User å€¼ï¼šé»˜è®¤ <code>git</code>ã€‚</li>\n<li>Domain å€¼ï¼šè‹¥è¦ä»å…¶ä»–ä¸»æœºè¿æ¥è‡³ Gogs ä»“åº“ï¼ŒDomian å¿…é¡»é…ç½®ä¸ºå®¹å™¨å®¿ä¸»æœºçš„ IP åœ°å€æˆ–ä¸»æœºåã€‚</li>\n<li>SSH Port å€¼ï¼špodman-compose å®šä¹‰æ–‡ä»¶ä¸­å¯¹å¤–æš´éœ²çš„ SSH ç«¯å£å·ã€‚</li>\n<li>HTTP Port å€¼ï¼šé»˜è®¤ <code>3000</code> ç«¯å£ã€‚  </li>\n</ul>\n</li>\n<li>Web é¡µé¢ä¸­æœ€åéœ€è®¾ç½® Gogs ç®¡ç†å‘˜è´¦å·ä»¥å®Œæˆå®‰è£…ã€‚  </li>\n<li>å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•æˆ–é‡æ–°æ³¨å†Œæ–°è´¦å·ç™»å½•ä¸ä½¿ç”¨ã€‚  </li>\n<li>å¦‚ä¸‹æ‰€ç¤ºï¼Œä½¿ç”¨ <code>devops</code> ç”¨æˆ·åˆ›å»ºæ–°ä»£ç åº“å¹¶å®Œæˆ commit æäº¤ï¼š<img src=\"gogs-git-repository.jpg\" alt=\"gogs-git-repository.jpg\">  </li>\n<li><p>å¦‚éœ€å…³é—­ Gogs ä»£ç ä»“åº“ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœæ­¢ gogs ä¸ postgresql å®¹å™¨æœåŠ¡å³å¯ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app stop gogs postgresql</span><br><span class=\"line\">  using podman version: podman version 3.2.3</span><br><span class=\"line\">  podman stop -t 10 gogs</span><br><span class=\"line\">  gogs</span><br><span class=\"line\">  0</span><br><span class=\"line\">  podman stop -t 10 gogs-postgresql</span><br><span class=\"line\">  gogs-postgresql</span><br><span class=\"line\">  0</span><br><span class=\"line\">$ podman ps</span><br><span class=\"line\">  CONTAINER ID  IMAGE                 COMMAND     CREATED       STATUS             PORTS                                                                   NAMES</span><br><span class=\"line\">  b6df150a3a49  k8s.gcr.io/pause:3.5              30 hours ago  Up 39 minutes ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  c3a10da46f18-infra</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ğŸ’¥<strong>æ³¨æ„ï¼š</strong></p>\n<p>åˆ‡ä¸å¯ç›´æ¥ä½¿ç”¨ podman-compose å‘½ä»¤çš„ <code>down</code> å­å‘½ä»¤ï¼Œè¯¥å­å‘½ä»¤å°†æ‰€æœ‰ç›¸å…³çš„å®¹å™¨ä¸ pod å…¨éƒ¨åˆ é™¤ï¼Œpod åˆ é™¤åæ— æ³•å°†å…¶ä¸­çš„å„å®¹å™¨æ˜ å°„è‡³å®¿ä¸»æœºå¯¹åº”çš„ç›®å½•ä¸­ï¼Œå³ä½¿åŸå§‹æ•°æ®ä¾ç„¶ä¿ç•™äºç›®å½•ä¸­ã€‚</p>\n</blockquote>\n</li>\n<li><p>é‡æ–°å¯åŠ¨ Gogs ä»£ç ä»“åº“çš„æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app start gogs postgresql</span><br><span class=\"line\">  using podman version: podman version 3.2.3</span><br><span class=\"line\">  podman start gogs</span><br><span class=\"line\">  gogs</span><br><span class=\"line\">  0</span><br><span class=\"line\">  podman start gogs-postgresql</span><br><span class=\"line\">  gogs-postgresql</span><br><span class=\"line\">  0</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"podman-pod-å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\"><a href=\"#podman-pod-å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\"></a>podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š</h3><ul>\n<li><code>podman-compose</code> çš„ä½¿ç”¨ä¾èµ–äº <code>python</code> ç‰ˆæœ¬ä»¥åŠä¾èµ–åŒ…ï¼Œè‹¥åœ¨ä¸åŒå¹³å°ä¸­ä½¿ç”¨å¯èƒ½å­˜åœ¨æ— æ³•å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„ python åŠä¾èµ–åŒ…çš„æƒ…å†µï¼Œå› æ­¤ podman-compose å¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³å•æœºä¸Šçš„å¤šå®¹å™¨ç¼–æ’é—®é¢˜ã€‚</li>\n<li>å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œpodman è‡ªå¸¦çš„ <code>podman pod</code> å­å‘½ä»¤å¯åŸç”Ÿæ”¯æŒå¤šå®¹å™¨ç¼–æ’ï¼Œè¯¥å‘½ä»¤å¯å°†å¤šå®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ä½¿ç”¨ç›¸åŒçš„ <code>network namespace</code> ä»¥æ›´æ–¹ä¾¿çš„è°ƒé…å®¹å™¨ã€‚</li>\n<li><p>å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºï¼š<br>ğŸ‘‰ ä»å¤´åˆ›å»º pod å¹¶é™„åŠ é¢å¤–çš„å®¹å™¨ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman pod create --name &lt;pod_name&gt; [-p &lt;host_port&gt;:&lt;pod_port&gt;]</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ pause å®¹å™¨é•œåƒä»å¤´åˆ›å»º pod</span></span><br><span class=\"line\"><span class=\"comment\"># è‹¥ä¹‹åéœ€åœ¨ pod ä¸­åˆ›å»ºä½¿ç”¨ç«¯å£æ˜ å°„çš„å®¹å™¨ï¼Œéœ€è¦åœ¨åˆ›å»º pod ä¹‹åˆæŒ‡å®šç«¯å£æ˜ å°„å…³ç³»ï¼Œæ— æ³•åœ¨åˆ›å»ºå®¹å™¨æ—¶æŒ‡å®šï¼Œç”±äº pod</span></span><br><span class=\"line\"><span class=\"comment\"># æä¾›äº†å…¶ä¸­æ‰€æœ‰å®¹å™¨çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼šè‹¥éœ€æŒ‡å®šå¤šä¸ªç«¯å£ï¼Œå¯åŒæ—¶ä½¿ç”¨å¤šä¸ª -p é€‰é¡¹ã€‚</span></span><br><span class=\"line\">$ podman run -d --name &lt;container_name&gt; --pod &lt;pod_name&gt; &lt;container_image&gt;:&lt;tag&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºå®¹å™¨å°†å…¶é™„åŠ åˆ° pod ä¸­</span></span><br><span class=\"line\">$ podman pod [ps|list|ls]</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å·²å­˜åœ¨çš„ pod</span></span><br><span class=\"line\">$ podman pod [stop|rm] &lt;pod_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢æˆ–åˆ é™¤ podï¼Œå°†ä¸€å¹¶åˆ é™¤ pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<ol>\n<li><code>k8s.gcr.io/pause:3.5</code> é•œåƒæ‹‰å–éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚</li>\n<li>è‹¥æ— æ³•æ‹‰å–ï¼Œå¯å…ˆæ‹‰å– <code>registry.aliyuncs.com/google_containers/pause:3.5</code> é•œåƒï¼Œå†æ›´æ”¹å…¶ <code>tag</code> å³å¯ã€‚</li>\n</ol>\n</blockquote>\n<p>ğŸ‘‰ éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º podï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman run -d \\</span><br><span class=\"line\">  --name &lt;container_name&gt; --pod new:&lt;pod_name&gt; \\</span><br><span class=\"line\">  [-p &lt;host_port&gt;:&lt;pod_port&gt;] \\</span><br><span class=\"line\">  &lt;container_image&gt;:&lt;tag&gt;</span><br><span class=\"line\"><span class=\"comment\"># éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º pod</span></span><br><span class=\"line\">$ podman run -d \\</span><br><span class=\"line\">  --name &lt;container_name&gt; --pod &lt;pod_name&gt; \\</span><br><span class=\"line\">  &lt;container_image&gt;:&lt;tag&gt;</span><br><span class=\"line\"><span class=\"comment\"># åœ¨ pod ä¸­åˆ›å»ºæ–°çš„å®¹å™¨</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç¤ºä¾‹ 1ï¼š<br>å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ›å»ºåä¸º <code>nginx-docs</code> çš„å®¹å™¨å¹¶åŒæ—¶åˆ›å»ºåä¸º <code>docker-docs</code> çš„ podï¼Œä¹Ÿå¯åˆ›å»ºå…¶ä»–å®¹å™¨æ·»åŠ è‡³ pod ä¸­ï¼Œpod ä¸­çš„å®¹å™¨å…±äº« <code>network namespace</code>ï¼š<img src=\"podman-run-pod-create.jpg\" alt=\"podman-run-pod-create.jpg\"></p>\n</li>\n<li>ğŸ¤˜ ç¤ºä¾‹ 2ï¼š<br>ä½¿ç”¨ podman åœ¨å•ä¸ª pod ä¸­é›†æˆå¤šå®¹å™¨çš„æ–¹æ³•ï¼Œå¯å‚è€ƒ <a href=\"https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/\">ä¹‹å‰å‘å¸ƒçš„æ–‡æ¡£</a>ï¼Œè¯¥æ–‡æ¡£ä¸­å°† Quayã€MySQL ä¸ Redis çš„å•å®¹å™¨é›†æˆåœ¨å•ä¸ª pod ä¸­ï¼Œä½¿ç”¨ pod çš„ <code>network namespace</code> æ–¹ä¾¿ Quay é•œåƒä»“åº“çš„ç®¡ç†ã€‚</li>\n</ul>\n<h3 id=\"ğŸš€-ä½¿ç”¨-podman-kube-play-å®ç°-WordPress-çš„ä¸€é”®éƒ¨ç½²ï¼š\"><a href=\"#ğŸš€-ä½¿ç”¨-podman-kube-play-å®ç°-WordPress-çš„ä¸€é”®éƒ¨ç½²ï¼š\" class=\"headerlink\" title=\"ğŸš€ ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²ï¼š\"></a>ğŸš€ ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²ï¼š</h3><ul>\n<li>é™¤ä¸Šè¿° podman pod å®¹å™¨ç¼–æ’çš„æ–¹å¼ä»¥å¤–ï¼Œpodman ä¹Ÿå·²æ”¯æŒç±»ä¼¼äºä½¿ç”¨ <code>Kubernetes</code> ç»“æ„åŒ– <code>yaml</code> æ–‡ä»¶çš„æ–¹å¼ï¼Œå³å¯ä½¿ç”¨ <code>podman kube play</code> åˆ›å»º <code>Pod</code>ã€<code>Deployment</code> ä¸ <code>PersistentVolumeClaim</code> ç­‰ã€‚</li>\n<li><p>å¯å°†ç”± <code>podman pod create</code> åˆ›å»ºçš„ pod é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman generate kube &lt;pod_name&gt; &gt; &lt;application_name&gt;.yml</span><br><span class=\"line\"><span class=\"comment\"># å¯¼å‡ºå·²å­˜åœ¨ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è¯¥ç¤ºä¾‹ä¸­ç”Ÿæˆçš„ pod èµ„æºå®šä¹‰æ–‡ä»¶éœ€ç¨åŠ æ”¹åŠ¨ç”¨äºåº”ç”¨çš„éƒ¨ç½²ï¼Œå¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/mywpblog-pod.yml\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>ï¼š  </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mywpblog</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mywpblog</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">automountServiceAccountToken:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">mysqld</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_USER</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_user</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">redhat</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_PASSWORD</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_pass</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_DATABASE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_blog</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/library/mysql:5.7.40-debian</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">wpdatabase</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">      <span class=\"attr\">hostPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">      <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">        <span class=\"attr\">drop:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_MKNOD</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_NET_RAW</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_AUDIT_WRITE</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpdbfiles-host-0</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">apache2-foreground</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_NAME</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_blog</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_HOST</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">\"0.0.0.0\"</span></span><br><span class=\"line\">      <span class=\"comment\"># WORDPRESS_DB_HOST definied as '0.0.0.0' because two containers </span></span><br><span class=\"line\">      <span class=\"comment\"># use same network namespace</span></span><br><span class=\"line\">      <span class=\"comment\"># WORDPRESS_DB_HOST is different from 'podman pod create' and </span></span><br><span class=\"line\">      <span class=\"comment\"># 'podman kube play'.</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_USER</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_user</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_PASSWORD</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_pass</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/library/wordpress:6.1.1-php7.4-apache</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">wpfrontend</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">hostPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">      <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">        <span class=\"attr\">drop:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_MKNOD</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_NET_RAW</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_AUDIT_WRITE</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/www/html</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpfront-host-0</span></span><br><span class=\"line\">  <span class=\"attr\">enableServiceLinks:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">hostname:</span> <span class=\"string\">mywpblog</span></span><br><span class=\"line\">  <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">      <span class=\"attr\">path:</span> <span class=\"string\">/tmp/wpdbfiles</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpdbfiles-host-0</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">      <span class=\"attr\">path:</span> <span class=\"string\">/tmp/wpfront</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpfront-host-0</span></span><br><span class=\"line\"><span class=\"attr\">status:</span> <span class=\"string\">&#123;&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä½¿ç”¨è¯¥ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/wpblog-pod-manage\" target=\"_blank\" rel=\"noopener\">è„šæœ¬</a> å®ç° WordPress åº”ç”¨çš„ä¸€é”®éƒ¨ç½²ä¸ç®¡ç†ï¼ŒWordPress å®¹å™¨ä¸ MySQL å®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ï¼Œè¿è¡ŒæˆåŠŸåæ‰“å¼€æµè§ˆå™¨å³å¯è®¿é—®å®‰è£… WordPress åº”ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./wpblog-pod-manage --kube-deploy</span><br><span class=\"line\">---&gt; Start deploy blog pod...</span><br><span class=\"line\">---&gt; Use podman kube play to create and run pod...</span><br><span class=\"line\">Pod:</span><br><span class=\"line\">7e8d6586ed246380fdb9ee00e73361b16938d4f2d5b646041f5036d9b7e4e8ae</span><br><span class=\"line\">Containers:</span><br><span class=\"line\">5132590944a03adcdfc08ba27945c708ae23b19fdce24fbcda9df6c845b5bc4e</span><br><span class=\"line\">cc2e7cb2a3a5423a7f0d93d07590b5826657eeb59d0491c5578dde0a1d10de1e</span><br><span class=\"line\">---&gt; Pod and containers as followings...</span><br><span class=\"line\">POD ID        NAME        STATUS      CREATED         INFRA ID      <span class=\"comment\"># OF CONTAINERS</span></span><br><span class=\"line\">7e8d6586ed24  mywpblog    Running     34 seconds ago  ca2ea53dfcbb  3</span><br><span class=\"line\"></span><br><span class=\"line\">CONTAINER ID  IMAGE                                            COMMAND               CREATED         STATUS            PORTS                                         NAMES</span><br><span class=\"line\">ca2ea53dfcbb  localhost/podman-pause:4.3.0-1666339791                                35 seconds ago  Up 2 seconds ago  0.0.0.0:3306-&gt;3306/tcp, 0.0.0.0:8080-&gt;80/tcp  7e8d6586ed24-infra    </span><br><span class=\"line\">5132590944a0  docker.io/library/mysql:5.7.40-debian            mysqld                19 seconds ago  Up 2 seconds ago  0.0.0.0:3306-&gt;3306/tcp, 0.0.0.0:8080-&gt;80/tcp  mywpblog-wpdatabase   </span><br><span class=\"line\">cc2e7cb2a3a5  docker.io/library/wordpress:6.1.1-php7.4-apache  apache2-foregroun...  4 seconds ago   Up 2 seconds ago  0.0.0.0:3306-&gt;3306/tcp, 0.0.0.0:8080-&gt;80/tcp  mywpblog-wpfrontend   </span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ podman kube play çš„æ–¹å¼éƒ¨ç½² WordPress åº”ç”¨</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"Podman-æŠ¥é”™ç¤ºä¾‹ï¼š\"><a href=\"#Podman-æŠ¥é”™ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"Podman æŠ¥é”™ç¤ºä¾‹ï¼š\"></a>Podman æŠ¥é”™ç¤ºä¾‹ï¼š</h3><ul>\n<li>podman å®¹å™¨é•œåƒä»“åº“çš„é…ç½®æ–¹å¼ï¼š  <ul>\n<li>å…¨å±€é…ç½®ï¼š<code>/etc/containers/registries.conf</code></li>\n<li>å±€éƒ¨é…ç½®ï¼š<code>$HOME/.config/containers/registroes.conf</code></li>\n</ul>\n</li>\n<li>è‹¥ podman å®‰è£…ååœ¨ä»¥ä¸Šé…ç½®ä¸­æœªå”¯ä¸€æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“ï¼Œé‚£ä¹ˆåœ¨æ‹‰å–å®¹å™¨é•œåƒæ—¶ï¼Œå°†äº¤äº’å¼æç¤ºç”¨æˆ·é€‰æ‹©å®¹å™¨é•œåƒä»“åº“ã€‚</li>\n<li><p>Podman ç™»å½•å®¹å™¨é•œåƒä»“åº“çš„æ–¹å¼ï¼š  </p>\n<ul>\n<li><p>ä½¿ç”¨ <code>podman login</code> å­å‘½ä»¤ç™»å½•æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“æ—¶ï¼ŒPodman å°†è®¿é—® token é»˜è®¤å­˜å‚¨äº <code>/run/user/&lt;UID&gt;/containers/auth.json</code> æ–‡ä»¶ä¸­ï¼Œå½“ logout ä»“åº“æ—¶ï¼Œè¯¥ token å°†è¢«ç§»é™¤ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶ä¸­å¯å­˜å‚¨å¤šä¸ªç™»å½•çš„ä»“åº“ tokenã€‚<img src=\"podman-login-token.jpg\" alt=\"podman-login-token.jpg\">    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman <span class=\"built_in\">logout</span> --all</span><br><span class=\"line\"><span class=\"comment\"># ç™»å‡ºæ‰€æœ‰çš„å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶ä» auth.json æ–‡ä»¶ä¸­ç§»é™¤æ‰€æœ‰çš„ tokenã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Podman é»˜è®¤æƒ…å†µä¸‹éœ€è¦ä¸å®¹å™¨é•œåƒä»“åº“ä½¿ç”¨ <code>TLS</code> è®¤è¯ï¼Œè‹¥å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLSã€ä½¿ç”¨è‡ªç­¾åçš„ TLS è¯ä¹¦æˆ–æœªçŸ¥çš„ CA ç­¾ç½²çš„è¯ä¹¦ï¼Œéœ€å¯¹ loginã€pull æˆ– push å­å‘½ä»¤æ·»åŠ  <code>--tls-verify=false</code> é€‰é¡¹ä»¥å®Œæˆè®¤è¯ã€‚  </p>\n</li>\n<li>Skopeo ä¸ Buildah ä¹Ÿå¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ tokenï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ã€‚</li>\n</ul>\n</li>\n<li><p>ç¤ºä¾‹ 1ï¼š<br>ğŸ‘‰ podman v3.2.3 ç™»å½• Harbor v1.8.1 èº«ä»½è®¤è¯æŠ¥é”™ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman login harbor.domain12.example.com:8880</span><br><span class=\"line\">  Username: admin</span><br><span class=\"line\">  Password: redhat</span><br><span class=\"line\">  Error: authenticating creds <span class=\"keyword\">for</span> <span class=\"string\">\"harbor.domain12.example.com:8880\"</span>: error pinging docker registry </span><br><span class=\"line\">  harbor.domain12.example.com:8880: Get <span class=\"string\">\"https://harbor.domain12.example.com:8880/v2/\"</span>: </span><br><span class=\"line\">  http: server gave HTTP response to HTTPS client</span><br><span class=\"line\"><span class=\"comment\"># Podman æœªåšä»»ä½•é…ç½®ç™»å½• Harbor æŠ¥é”™ï¼Œè¯¥ Harbor å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLS åŠ å¯†ä¼ è¾“ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># æŠ¥é”™æ˜¾ç¤º Harbor å“åº” HTTP è¯·æ±‚ï¼Œè€Œ Podman å‘é€ HTTPS è¯·æ±‚ç™»å½•ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># å› æ­¤ï¼Œå°† Podman é…ç½®ä¸ºå‘é€ HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ¤” è§£å†³æ–¹å¼ä¸€ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman login --tls-verify=<span class=\"literal\">false</span> harbor.domain12.example.com:8880</span><br><span class=\"line\">  Username: admin</span><br><span class=\"line\">  Password: redhat</span><br><span class=\"line\">  Login Succeeded!</span><br><span class=\"line\"><span class=\"comment\"># Podman æœªè¿›è¡Œä»»ä½•é…ç½®ï¼Œç›´æ¥ä½¿ç”¨ --tls-verify=false é€‰é¡¹å³å¯è®¤è¯ç™»å½•ã€‚</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ¤” è§£å†³æ–¹å¼äºŒï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -p ~/.config/containers/ &amp;&amp; <span class=\"built_in\">cd</span> ~/.config/containers/</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæ™®é€šç”¨æˆ· rootless å®¹å™¨çš„ç›®å½•</span></span><br><span class=\"line\">$ vim ~/.config/containers/registries.conf</span><br><span class=\"line\">  unqualified-search-registries = [<span class=\"string\">'harbor.domain12.example.com:8880'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  [[registry]]</span><br><span class=\"line\">  location = <span class=\"string\">\"harbor.domain12.example.com:8880\"</span></span><br><span class=\"line\">  insecure = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># If true, unencrypted HTTP as well as TLS connections with untrusted</span></span><br><span class=\"line\">  <span class=\"comment\"># certificates are allowed.</span></span><br><span class=\"line\">  block = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®æœªåŠ å¯†ä¼ è¾“çš„ Harbor å®¹å™¨é•œåƒä»“åº“çš„ä¸»æœºåä¸ç«¯å£</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ podman login --<span class=\"built_in\">log</span>-level=debug harbor.domain12.example.com:8880</span><br><span class=\"line\">  INFO[0000] podman filtering at <span class=\"built_in\">log</span> level debug</span><br><span class=\"line\">  DEBU[0000] Called login.PersistentPreRunE(podman login --<span class=\"built_in\">log</span>-level=debug harbor.domain12.example.com:8880)</span><br><span class=\"line\">  DEBU[0000] overlay storage already configured with a mount-program</span><br><span class=\"line\">  DEBU[0000] Merged system config <span class=\"string\">\"/usr/share/containers/containers.conf\"</span></span><br><span class=\"line\">  DEBU[0000] overlay storage already configured with a mount-program</span><br><span class=\"line\">  DEBU[0000] Using conmon: <span class=\"string\">\"/usr/bin/conmon\"</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  DEBU[0000] Using OCI runtime <span class=\"string\">\"/usr/bin/runc\"</span></span><br><span class=\"line\">  DEBU[0000] Default CNI network name podman is unchangeable</span><br><span class=\"line\">  INFO[0000] Setting parallel job count to 13</span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/home/kiosk/.config/containers/registries.conf\"</span></span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/etc/containers/registries.conf.d/000-shortnames.conf\"</span></span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/etc/containers/registries.conf.d/001-rhel-shortnames.conf\"</span></span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/etc/containers/registries.conf.d/002-rhel-shortnames-overrides.conf\"</span></span><br><span class=\"line\">  DEBU[0000] No credentials <span class=\"keyword\">for</span> harbor.domain12.example.com:8880 found</span><br><span class=\"line\">  Username: admin</span><br><span class=\"line\">  Password: <span class=\"comment\"># äº¤äº’å¼è¾“å…¥ç™»å½•å¯†ç </span></span><br><span class=\"line\">  DEBU[0004] Looking <span class=\"keyword\">for</span> TLS certificates and private keys <span class=\"keyword\">in</span> /etc/docker/certs.d/harbor.domain12.example.com:8880</span><br><span class=\"line\">  DEBU[0004] GET https://harbor.domain12.example.com:8880/v2/</span><br><span class=\"line\">  DEBU[0004] Ping https://harbor.domain12.example.com:8880/v2/ err Get <span class=\"string\">\"https://harbor.domain12.example.com:8880/v2/\"</span>: http: </span><br><span class=\"line\">  server gave HTTP response to HTTPS client (&amp;url.Error&#123;Op:<span class=\"string\">\"Get\"</span>, URL:<span class=\"string\">\"https://harbor.domain12.example.com:8880/v2/\"</span>, </span><br><span class=\"line\">  Err:(*errors.errorString)(0xc000590030)&#125;)</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  DEBU[0004] GET http://harbor.domain12.example.com:8880/service/token?account=admin&amp;service=harbor-registry</span><br><span class=\"line\">  DEBU[0004] GET http://harbor.domain12.example.com:8880/v2/</span><br><span class=\"line\">  DEBU[0004] Stored credentials <span class=\"keyword\">for</span> harbor.domain12.example.com:8880 <span class=\"keyword\">in</span> credential helper containers-auth.json</span><br><span class=\"line\">  Login Succeeded!</span><br><span class=\"line\">  DEBU[0004] Called login.PersistentPostRunE(podman login --<span class=\"built_in\">log</span>-level=debug harbor.domain12.example.com:8880)</span><br><span class=\"line\"><span class=\"comment\"># Podman é»˜è®¤ä½¿ç”¨ TLS åŠ å¯†ä¼ è¾“</span></span><br><span class=\"line\"><span class=\"comment\"># ä»¥ä¸Šé…ç½®æ–‡ä»¶å°†ä½¿ Podman ä»¥ HTTP æ–¹å¼è®¤è¯ç™»å½• Harborã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç¤ºä¾‹ 2ï¼š<br>ğŸ‘‰ podman v3.2.3 æ¨é€å®¹å™¨é•œåƒè‡³ Harbor v1.8.1 ä¸­æ˜¾ç¤º â€œä¸å®Œæ•´â€ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman push harbor.domain12.example.com:8880/library/apache-rhce8.2-alpine:1.0</span><br><span class=\"line\">  Getting image <span class=\"built_in\">source</span> signatures</span><br><span class=\"line\">  Copying blob 551db21ded82 skipped: already exists</span><br><span class=\"line\">  Copying blob 8213d0880f11 skipped: already exists</span><br><span class=\"line\">  Copying blob e2eb06d8af82 skipped: already exists</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  Copying blob 05e56f8d5aae skipped: already exists</span><br><span class=\"line\">  Copying blob 631e8a8040bb skipped: already exists</span><br><span class=\"line\">  Copying blob dedba5c062fc skipped: already exists</span><br><span class=\"line\">  Copying blob 0e609f35aa06 [--------------------------------------] 0.0b / 0.0b</span><br><span class=\"line\">  Copying config 34f32c2e7a [======================================] 10.0KiB / 10.0KiB</span><br><span class=\"line\">  Writing manifest to image destination</span><br><span class=\"line\">  Storing signatures</span><br></pre></td></tr></table></figure>\n<p>ä»æ¨é€çš„è¿”å›ç»“æœæ˜¾ç¤ºï¼Œå…·æœ‰ 2 å±‚å®¹å™¨é•œåƒå±‚ä¼¼ä¹æœªæ¨é€æˆåŠŸï¼Œä½†å°†è¯¥é•œåƒä» Harbor ä¸­æ‹‰å–å¹¶é‡æ–°è¿è¡Œå®¹å™¨åï¼Œå®¹å™¨èƒ½æ­£å¸¸æä¾›æœåŠ¡ï¼Œå› æ­¤æœ€å 2 å±‚é•œåƒå±‚å®é™…æ¨é€æˆåŠŸã€‚</p>\n</li>\n<li>ç¤ºä¾‹ 3ï¼š<br>ğŸ‘‰ å®¹å™¨é•œåƒæ— ä»»ä½•è¿è¡Œæˆ–é€€å‡ºçŠ¶æ€å®¹å™¨å ç”¨ï¼Œä½†ä¾ç„¶æ— æ³•åˆ é™¤é•œåƒï¼Œå¯å°è¯•ä½¿ç”¨ <code>--force</code> é€‰é¡¹å°†å…¶å¼ºåˆ¶åˆ é™¤ã€‚<img src=\"podman-rmi-error-no-container-use.jpg\" alt=\"podman-rmi-error-no-container-use.jpg\"></li>\n<li><p>ç¤ºä¾‹ 4ï¼š<br>ğŸ‘‰ ç”±äºä» <code>dockerbub</code> ä¸Šç›´æ¥æ‹‰å–çš„é•œåƒä¸º <code>docker image format</code>ï¼Œæ— æ³•ä½¿ç”¨ <code>podman commit</code> å‘½ä»¤æäº¤ä¸ºæ–°çš„å®¹å™¨é•œåƒï¼Œè¯¥å‘½ä»¤å¯¹äº <code>-m</code> é€‰é¡¹ä¸èƒ½å¯¹ docker image format é•œåƒç”Ÿæ•ˆï¼Œé»˜è®¤åªæ”¯æŒ <code>OCI image format</code>ï¼Œå› æ­¤ä½¿ç”¨ -m é€‰é¡¹å¯¹å®¹å™¨æ‰§è¡Œæäº¤æ—¶éœ€å¼ºåˆ¶æŒ‡å®š <code>-f docker</code> æ‰èƒ½ç”Ÿæ•ˆã€‚</p>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<p>å¯ä½¿ç”¨ <code>skopeo</code> å·¥å…·è½¬æ¢ docker image format ä¸ OCI image formatã€‚</p>\n</blockquote>\n<p><img src=\"podman-commit-warning.jpg\" alt=\"podman-commit-warning.jpg\"></p>\n</li>\n<li><p>ç¤ºä¾‹ 5ï¼š<br>ğŸ‘‰ podman è¿è¡Œ rootfull æˆ– rootless busybox å®¹å™¨åï¼Œ<code>ping</code> å¤–ç½‘æŠ¥é”™æƒé™é—®é¢˜æ— æ³• ping é€šå¤–ç½‘ï¼Œä½†ä½¿ç”¨å…¶ä»–å·¥å…·å¯ä¸å¤–ç½‘é€šä¿¡ï¼Œé€šè¿‡ <a href=\"https://www.redhat.com/sysadmin/container-networking-podman\" target=\"_blank\" rel=\"noopener\">è¯¥æ–‡æ¡£</a> ä¸­å¯çŸ¥ï¼Œping å‘½ä»¤å¯¹ <code>capability</code> æ•æ„Ÿï¼Œå®¹å™¨å¯èƒ½ç¼ºå°‘ <code>CAP_NET_RAW</code>capability æ— æ³•é€šè¿‡å®¿ä¸»æœº ping é€šå¤–ç½‘ã€‚<br>ğŸ‘‰ å½“ç„¶ï¼Œè¿è¡Œå®¹å™¨æ—¶æŒ‡å®š <code>--privileged</code> é€‰é¡¹å¯ä½¿å®¹å™¨è·å¾—ä¸å®¿ä¸»æœº root ç”¨æˆ·åŒæ ·çš„ä¸å®¿ä¸»æœºäº¤äº’çš„æƒé™èƒ½åŠ›ï¼Œä½†èµ‹äºˆçš„æƒé™è¿‡é«˜ï¼Œåº”å½“å‹åˆ¶è¯¥æƒé™ï¼Œæ›´å¥½çš„é€‰æ‹©æ˜¯å¯¹è¿è¡Œå®¹å™¨æ·»åŠ é€‚å½“çš„ <code>Linux capabilities</code>ã€‚<img src=\"podman-busybox-capability.jpg\" alt=\"podman-busybox-capability.jpg\"></p>\n</li>\n</ul>\n<h3 id=\"Podman-æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\"><a href=\"#Podman-æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\" class=\"headerlink\" title=\"Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\"></a>Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š</h3><p>Podman æ—¥å¿—é©±åŠ¨ç›®å‰åªæ”¯æŒ <code>k8s-file</code>ã€<code>journald</code> ä¸ <code>none</code>ï¼Œæš‚æ—¶ä¸æ”¯æŒå®¹å™¨æ—¥å¿—çš„ <code>JSON</code> æ ¼å¼è¾“å‡ºï¼Œå› æ­¤ä¸èƒ½ä¸æ—¥å¿—æ”¶é›†å¼•æ“ <code>fluentd</code> é›†æˆï¼Œç”±å…¶å®ç°å°†æ—¥å¿—ä¼ è¾“è‡³ ELK æˆ– EFK è¿›è¡Œé›†ä¸­å¼çš„å­˜å‚¨ä¸ç´¢å¼•ã€‚</p>\n","site":{"data":{}},"excerpt":"","more":"<h3 id=\"æ–‡æ¡£è¯´æ˜ï¼š\"><a href=\"#æ–‡æ¡£è¯´æ˜ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£è¯´æ˜ï¼š\"></a>æ–‡æ¡£è¯´æ˜ï¼š</h3><ul>\n<li><a href=\"https://alberthua-perl.github.io/2022/12/05/podman-arch-usage/\">ä¸Šä¸€ç¯‡</a> å·²è¯´æ˜ Podman åŸç†ä¸å®ç°ï¼Œè¯¥æ–‡æ¡£å°†ç»§ç»­è¯´æ˜ Podman å®¹å™¨çš„ä½¿ç”¨ä¸å®è·µã€‚</li>\n</ul>\n<h3 id=\"æ–‡æ¡£ç›®å½•ï¼š\"><a href=\"#æ–‡æ¡£ç›®å½•ï¼š\" class=\"headerlink\" title=\"æ–‡æ¡£ç›®å½•ï¼š\"></a>æ–‡æ¡£ç›®å½•ï¼š</h3><ul>\n<li>podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹</li>\n<li>ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“</li>\n<li>podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹</li>\n<li>ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²</li>\n<li>Podman ä½¿ç”¨æŠ¥é”™ç¤ºä¾‹</li>\n<li>Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½</li>\n</ul>\n<h3 id=\"podman-å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\"><a href=\"#podman-å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š\"></a>podman å•å®¹å™¨ä½¿ç”¨åŠé€šä¿¡æ–¹å¼ç¤ºä¾‹ï¼š</h3><ul>\n<li>ç¤ºä¾‹ 1ï¼š<br>ğŸ‘‰ ä½¿ç”¨ podman å‘½ä»¤ç™»å½• <code>Quay</code> å…¬å…±å®¹å™¨é•œåƒä»“åº“å¹¶æ¨é€é•œåƒï¼š<img src=\"podman-push-quay.jpg\" alt=\"podman-push-quay.jpg\">ğŸ‘‰ æœç´¢å¹¶æ‹‰å– Red Hat å®¹å™¨é•œåƒä»“åº“ä¸­çš„é•œåƒåˆ—è¡¨ï¼š<img src=\"podman-pull-image.jpg\" alt=\"podman-pull-image.jpg\"></li>\n<li>ç¤ºä¾‹ 2ï¼š<br>ğŸ¤˜ éƒ¨ç½²å¹¶ä½¿ç”¨äº‘åŸç”Ÿè½»é‡çº§å¯¹è±¡å­˜å‚¨ <code>MinIO Server</code>ï¼š<br><img src=\"minio-server-cloud-native-object-storage-demo-1.jpg\" alt=\"minio-server-cloud-native-object-storage-demo-1.jpg\"><img src=\"minio-server-cloud-native-object-storage-demo-2.jpg\" alt=\"minio-server-cloud-native-object-storage-demo-2.jpg\">ä»¥ä¸Šç¤ºä¾‹å°† podman ä¸ systemd é›†æˆå®ç°æ™®é€šç”¨æˆ·çš„ rootless å®¹å™¨å¼€æœºè‡ªå¯åŠ¨ã€‚<img src=\"minio-server-cloud-native-object-storage-demo-3.jpg\" alt=\"minio-server-cloud-native-object-storage-demo-3.jpg\">å…³äº MinIO Server åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨çš„è¯¦ç»†å†…å®¹ï¼Œè¯· <a href=\"https://min.io/\" target=\"_blank\" rel=\"noopener\">å‚è€ƒå®˜ç½‘</a>ã€‚</li>\n<li>ç¤ºä¾‹ 3ï¼š<br>ğŸ¤˜ è¯·å‚è€ƒè¯¥æ–‡æ¡£ <a href=\"https://alberthua-perl.github.io/2022/12/05/loganalyzer-rsyslog-mysql/\">éƒ¨ç½² loganalyzer ç®¡ç†é›†ä¸­å¼æ—¥å¿—</a> ä»¥ç†è§£å¤šä¸ª rootfull å®¹å™¨é—´çš„é€šä¿¡æ–¹å¼ï¼ˆé€šè¿‡ <code>cni-podman0</code> ç½‘æ¡¥ä¸ <code>iptables</code> äº’ç›¸é€šä¿¡ï¼‰ã€‚</li>\n</ul>\n<h3 id=\"ä½¿ç”¨-podman-compose-å®ç°-Gogs-è½»é‡çº§ä»£ç ä»“åº“ï¼š\"><a href=\"#ä½¿ç”¨-podman-compose-å®ç°-Gogs-è½»é‡çº§ä»£ç ä»“åº“ï¼š\" class=\"headerlink\" title=\"ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š\"></a>ä½¿ç”¨ podman-compose å®ç° Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š</h3><ul>\n<li>ä½¿ç”¨ <code>podman-compose</code> é€šè¿‡ <code>link</code> é“¾æ¥è‡³æŒ‡å®šçš„å®¹å™¨å»ºç«‹é€šä¿¡ã€‚</li>\n<li><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œéƒ¨ç½² Gogs è½»é‡çº§ä»£ç ä»“åº“ï¼š<code>Gogs + PostgreSQL</code>  </p>\n<ul>\n<li>å…³äº podman-compose çš„å®‰è£…å¯å‚è€ƒ <a href=\"https://github.com/containers/podman-compose\" target=\"_blank\" rel=\"noopener\">GitHub é¡¹ç›®</a></li>\n</ul>\n<blockquote>\n<p>ğŸ¤” å¯è€ƒè™‘ä½¿ç”¨ podman-compose éƒ¨ç½²è½»é‡çº§ <code>Gitea + Drone</code> CI æŒç»­é›†æˆå¹³å°</p>\n</blockquote>\n<ul>\n<li>å…³äº Gogs é¡¹ç›®çš„è¯¦ç»†å†…å®¹å¯å‚è€ƒ <a href=\"https://github.com/gogs/gogs\" target=\"_blank\" rel=\"noopener\">Gogs GitHub é¡¹ç›®</a>  </li>\n<li>Gogs ä»£ç ç‰ˆæœ¬æ§åˆ¶ä»“åº“ä½¿ç”¨ Golang è¯­è¨€å¼€å‘ï¼Œå¯ä¸åç«¯ MySQLã€PostgreSQLã€SQLite3ã€TiDB ç­‰é›†æˆã€‚  </li>\n<li>æ­¤å¤„ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½² Gogsï¼Œå¹¶ä¸ PostgreSQL é›†æˆã€‚  </li>\n<li><p>éƒ¨ç½²ç”¨ä¸»æœºä¸Šå¿…é¡»å…ˆå®‰è£… podman ä¸ podman-composeï¼Œå¹¶æ‹‰å–ç›¸åº”å®¹å™¨é•œåƒåŠ é€Ÿéƒ¨ç½²è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š<img src=\"podman-image-list.jps.JPG\" alt=\"podman-image-list.jps.JPG\"></p>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<p>podman-compose ä½¿ç”¨åˆ›å»º <code>pod</code> å°†å¤šä¸ªå®¹å™¨ç»„å»ºæˆ pod çš„æ–¹å¼è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œå› æ­¤å¿…é¡»å…·æœ‰ <code>pause</code> å®¹å™¨é•œåƒæä¾› pod çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ä¸æŒ‚è½½å‘½åç©ºé—´ã€‚</p>\n</blockquote>\n</li>\n<li><p>ä½¿ç”¨æ™®é€šç”¨æˆ·éƒ¨ç½²ï¼Œè¿‡ç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -p gogs-app/gogs-data/&#123;gogs,gogs-logs,postgresql&#125;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºç”¨äºå­˜å‚¨ gogs ä¸ postgresql æ•°æ®æ˜ å°„çš„ç›®å½•</span></span><br><span class=\"line\">$ sudo chown -R 100999:100999 gogs-app/gogs-data/&#123;gogs,gogs-logs&#125;</span><br><span class=\"line\"><span class=\"comment\"># æ›´æ”¹æ˜ å°„ç›®å½•çš„å±ç»„ï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨æƒé™æŠ¥é”™ã€‚</span></span><br><span class=\"line\">$ getenforce</span><br><span class=\"line\">  Enforcing</span><br><span class=\"line\"><span class=\"comment\"># ç¡®è®¤ç³»ç»Ÿå¤„äº enforcing SELinux çŠ¶æ€ï¼Œéœ€è®¾ç½®ç›®å½•æ˜ å°„æ—¶çš„æ ‡ç­¾ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># ä¹Ÿå¯ç¦ç”¨ SELinuxï¼Œè‹¥ç¦ç”¨ SELinuxï¼Œä»¥ä¸‹ä¸¤æ­¥å¯ä¸æ‰§è¡Œå¹¶ä¸”å»é™¤ podman-compose å®šä¹‰æ–‡ä»¶ä¸­çš„ \"Z\"ã€‚</span></span><br><span class=\"line\">$ sudo semanage port -a -t http_port_t -p tcp 10800</span><br><span class=\"line\">$ sudo semanage port -a -t ssh_port_t -p tcp 10022</span><br><span class=\"line\"><span class=\"comment\"># æ·»åŠ è‡ªå®šä¹‰ç«¯å£è‡³ SELinux æ•°æ®åº“ä¸­ï¼Œå¦åˆ™ç”±äºæƒé™é—®é¢˜æ— æ³•è®¿é—®å¹¶å®‰è£… Gogsã€‚</span></span><br><span class=\"line\">$ vim gogs-app/gogs-postgres-podman-compose.yaml</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>å¦‚ä¸‹æ‰€ç¤º <code>gogs-postgres-podman-compose.yaml</code> æ–‡ä»¶å¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/dockerfile-s2i-demo/blob/master/gogs-postgres-compose/gogs-postgres-podman-compose.yaml\" target=\"_blank\" rel=\"noopener\">æ­¤å¤„</a>ï¼š</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">\"3\"</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">postgresql:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/library/postgres:14.1-bullseye</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">\"gogs-postgresql\"</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"./gogs-data/postgresql:/var/lib/postgresql:Z\"</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"POSTGRES_USER=gogs\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"POSTGRES_PASSWORD=redhat\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"POSTGRES_DB=gogs\"</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"5432:5432\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">gogs:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/gogs/gogs:0.12</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">\"gogs\"</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"./gogs-data/gogs:/data:Z\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"./gogs-data/gogs-logs:/app/gogs/log:Z\"</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"10022:22\"</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">\"10800:3000\"</span></span><br><span class=\"line\">    <span class=\"attr\">links:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">postgresql</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç¼–è¾‘å®Œæˆ yaml æ–‡ä»¶åï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app up</span><br><span class=\"line\"><span class=\"comment\"># å¯åŠ¨ Gogs ä¸ PostgreSQL å®¹å™¨ï¼Œå¹¶æŒ‡å®šé¡¹ç›®åç§°ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># è‹¥ä¸æŒ‡å®šé¡¹ç›®åç§°ï¼Œé¡¹ç›®é»˜è®¤ä¸º yaml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åç§°ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># é¦–æ¬¡å¯åŠ¨å®¹å™¨æ—¶ï¼Œæ‰€æœ‰çš„å¯åŠ¨ä¸è¿è¡Œæ—¥å¿—å°†æ‰“å°è‡³ç»ˆç«¯å±å¹•ä¸Šï¼Œè¯¥ç»ˆç«¯ä¸å¯å…³é—­ï¼Œç›´è‡³å…³é—­æ‰€æœ‰æœåŠ¡å®¹å™¨åå°†è‡ªåŠ¨é€€å‡ºã€‚</span></span><br><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app ps</span><br><span class=\"line\">  using podman version: podman version 3.2.3</span><br><span class=\"line\">  podman ps -a --filter label=io.podman.compose.project=gogs-app</span><br><span class=\"line\">  CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES</span><br><span class=\"line\">  2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs-postgresql</span><br><span class=\"line\">  2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs</span><br><span class=\"line\">  0</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹ podman-compose ç®¡ç†çš„å®¹å™¨æœåŠ¡</span></span><br><span class=\"line\">$ podman ps</span><br><span class=\"line\">  CONTAINER ID  IMAGE                                     COMMAND               CREATED      STATUS          PORTS                                                                   NAMES</span><br><span class=\"line\">  b6df150a3a49  k8s.gcr.io/pause:3.5                                            6 hours ago  Up 6 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  c3a10da46f18-infra</span><br><span class=\"line\">  2bed211ffe60  docker.io/library/postgres:14.1-bullseye  postgres              6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs-postgresql</span><br><span class=\"line\">  2c7d0de4b0a0  docker.io/gogs/gogs:0.12                  /bin/s6-svscan /a...  6 hours ago  Up 3 hours ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  gogs</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼ŒåŒ…å« infra å®¹å™¨ã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>æ‰€æœ‰å®¹å™¨æ­£å¸¸è¿è¡Œåï¼Œä½¿ç”¨ <code>http://&lt;å®¹å™¨å®¿ä¸»æœº IP åœ°å€&gt;:10800</code> è®¿é—® Gogs å®‰è£…ç•Œé¢ï¼Œéœ€å¡«å…¥çš„å€¼å‚è€ƒå¦‚ä¸‹ï¼š<img src=\"gogs-settings.jpg\" alt=\"gogs-settings.jpg\">    </p>\n<ul>\n<li>Run User å€¼ï¼šé»˜è®¤ <code>git</code>ã€‚</li>\n<li>Domain å€¼ï¼šè‹¥è¦ä»å…¶ä»–ä¸»æœºè¿æ¥è‡³ Gogs ä»“åº“ï¼ŒDomian å¿…é¡»é…ç½®ä¸ºå®¹å™¨å®¿ä¸»æœºçš„ IP åœ°å€æˆ–ä¸»æœºåã€‚</li>\n<li>SSH Port å€¼ï¼špodman-compose å®šä¹‰æ–‡ä»¶ä¸­å¯¹å¤–æš´éœ²çš„ SSH ç«¯å£å·ã€‚</li>\n<li>HTTP Port å€¼ï¼šé»˜è®¤ <code>3000</code> ç«¯å£ã€‚  </li>\n</ul>\n</li>\n<li>Web é¡µé¢ä¸­æœ€åéœ€è®¾ç½® Gogs ç®¡ç†å‘˜è´¦å·ä»¥å®Œæˆå®‰è£…ã€‚  </li>\n<li>å®‰è£…å®Œæˆåï¼Œä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•æˆ–é‡æ–°æ³¨å†Œæ–°è´¦å·ç™»å½•ä¸ä½¿ç”¨ã€‚  </li>\n<li>å¦‚ä¸‹æ‰€ç¤ºï¼Œä½¿ç”¨ <code>devops</code> ç”¨æˆ·åˆ›å»ºæ–°ä»£ç åº“å¹¶å®Œæˆ commit æäº¤ï¼š<img src=\"gogs-git-repository.jpg\" alt=\"gogs-git-repository.jpg\">  </li>\n<li><p>å¦‚éœ€å…³é—­ Gogs ä»£ç ä»“åº“ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœæ­¢ gogs ä¸ postgresql å®¹å™¨æœåŠ¡å³å¯ï¼š    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app stop gogs postgresql</span><br><span class=\"line\">  using podman version: podman version 3.2.3</span><br><span class=\"line\">  podman stop -t 10 gogs</span><br><span class=\"line\">  gogs</span><br><span class=\"line\">  0</span><br><span class=\"line\">  podman stop -t 10 gogs-postgresql</span><br><span class=\"line\">  gogs-postgresql</span><br><span class=\"line\">  0</span><br><span class=\"line\">$ podman ps</span><br><span class=\"line\">  CONTAINER ID  IMAGE                 COMMAND     CREATED       STATUS             PORTS                                                                   NAMES</span><br><span class=\"line\">  b6df150a3a49  k8s.gcr.io/pause:3.5              30 hours ago  Up 39 minutes ago  0.0.0.0:10022-&gt;22/tcp, 0.0.0.0:10800-&gt;3000/tcp, 0.0.0.0:5432-&gt;5432/tcp  c3a10da46f18-infra</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ğŸ’¥<strong>æ³¨æ„ï¼š</strong></p>\n<p>åˆ‡ä¸å¯ç›´æ¥ä½¿ç”¨ podman-compose å‘½ä»¤çš„ <code>down</code> å­å‘½ä»¤ï¼Œè¯¥å­å‘½ä»¤å°†æ‰€æœ‰ç›¸å…³çš„å®¹å™¨ä¸ pod å…¨éƒ¨åˆ é™¤ï¼Œpod åˆ é™¤åæ— æ³•å°†å…¶ä¸­çš„å„å®¹å™¨æ˜ å°„è‡³å®¿ä¸»æœºå¯¹åº”çš„ç›®å½•ä¸­ï¼Œå³ä½¿åŸå§‹æ•°æ®ä¾ç„¶ä¿ç•™äºç›®å½•ä¸­ã€‚</p>\n</blockquote>\n</li>\n<li><p>é‡æ–°å¯åŠ¨ Gogs ä»£ç ä»“åº“çš„æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman-compose -f gogs-app/gogs-postgres-podman-compose.yaml --project gogs-app start gogs postgresql</span><br><span class=\"line\">  using podman version: podman version 3.2.3</span><br><span class=\"line\">  podman start gogs</span><br><span class=\"line\">  gogs</span><br><span class=\"line\">  0</span><br><span class=\"line\">  podman start gogs-postgresql</span><br><span class=\"line\">  gogs-postgresql</span><br><span class=\"line\">  0</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"podman-pod-å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\"><a href=\"#podman-pod-å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š\"></a>podman pod å¤šå®¹å™¨ç¼–æ’ä½¿ç”¨ç¤ºä¾‹ï¼š</h3><ul>\n<li><code>podman-compose</code> çš„ä½¿ç”¨ä¾èµ–äº <code>python</code> ç‰ˆæœ¬ä»¥åŠä¾èµ–åŒ…ï¼Œè‹¥åœ¨ä¸åŒå¹³å°ä¸­ä½¿ç”¨å¯èƒ½å­˜åœ¨æ— æ³•å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„ python åŠä¾èµ–åŒ…çš„æƒ…å†µï¼Œå› æ­¤ podman-compose å¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³å•æœºä¸Šçš„å¤šå®¹å™¨ç¼–æ’é—®é¢˜ã€‚</li>\n<li>å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œpodman è‡ªå¸¦çš„ <code>podman pod</code> å­å‘½ä»¤å¯åŸç”Ÿæ”¯æŒå¤šå®¹å™¨ç¼–æ’ï¼Œè¯¥å‘½ä»¤å¯å°†å¤šå®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ä½¿ç”¨ç›¸åŒçš„ <code>network namespace</code> ä»¥æ›´æ–¹ä¾¿çš„è°ƒé…å®¹å™¨ã€‚</li>\n<li><p>å¦‚ä¸‹å‘½ä»¤æ‰€ç¤ºï¼š<br>ğŸ‘‰ ä»å¤´åˆ›å»º pod å¹¶é™„åŠ é¢å¤–çš„å®¹å™¨ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman pod create --name &lt;pod_name&gt; [-p &lt;host_port&gt;:&lt;pod_port&gt;]</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ pause å®¹å™¨é•œåƒä»å¤´åˆ›å»º pod</span></span><br><span class=\"line\"><span class=\"comment\"># è‹¥ä¹‹åéœ€åœ¨ pod ä¸­åˆ›å»ºä½¿ç”¨ç«¯å£æ˜ å°„çš„å®¹å™¨ï¼Œéœ€è¦åœ¨åˆ›å»º pod ä¹‹åˆæŒ‡å®šç«¯å£æ˜ å°„å…³ç³»ï¼Œæ— æ³•åœ¨åˆ›å»ºå®¹å™¨æ—¶æŒ‡å®šï¼Œç”±äº pod</span></span><br><span class=\"line\"><span class=\"comment\"># æä¾›äº†å…¶ä¸­æ‰€æœ‰å®¹å™¨çš„å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># æ³¨æ„ï¼šè‹¥éœ€æŒ‡å®šå¤šä¸ªç«¯å£ï¼Œå¯åŒæ—¶ä½¿ç”¨å¤šä¸ª -p é€‰é¡¹ã€‚</span></span><br><span class=\"line\">$ podman run -d --name &lt;container_name&gt; --pod &lt;pod_name&gt; &lt;container_image&gt;:&lt;tag&gt;</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºå®¹å™¨å°†å…¶é™„åŠ åˆ° pod ä¸­</span></span><br><span class=\"line\">$ podman pod [ps|list|ls]</span><br><span class=\"line\"><span class=\"comment\"># æŸ¥çœ‹å·²å­˜åœ¨çš„ pod</span></span><br><span class=\"line\">$ podman pod [stop|rm] &lt;pod_name&gt;</span><br><span class=\"line\"><span class=\"comment\"># åœæ­¢æˆ–åˆ é™¤ podï¼Œå°†ä¸€å¹¶åˆ é™¤ pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<ol>\n<li><code>k8s.gcr.io/pause:3.5</code> é•œåƒæ‹‰å–éœ€è¦ç§‘å­¦ä¸Šç½‘ã€‚</li>\n<li>è‹¥æ— æ³•æ‹‰å–ï¼Œå¯å…ˆæ‹‰å– <code>registry.aliyuncs.com/google_containers/pause:3.5</code> é•œåƒï¼Œå†æ›´æ”¹å…¶ <code>tag</code> å³å¯ã€‚</li>\n</ol>\n</blockquote>\n<p>ğŸ‘‰ éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º podï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman run -d \\</span><br><span class=\"line\">  --name &lt;container_name&gt; --pod new:&lt;pod_name&gt; \\</span><br><span class=\"line\">  [-p &lt;host_port&gt;:&lt;pod_port&gt;] \\</span><br><span class=\"line\">  &lt;container_image&gt;:&lt;tag&gt;</span><br><span class=\"line\"><span class=\"comment\"># éšåˆ›å»ºå®¹å™¨æ—¶åŒæ—¶åˆ›å»º pod</span></span><br><span class=\"line\">$ podman run -d \\</span><br><span class=\"line\">  --name &lt;container_name&gt; --pod &lt;pod_name&gt; \\</span><br><span class=\"line\">  &lt;container_image&gt;:&lt;tag&gt;</span><br><span class=\"line\"><span class=\"comment\"># åœ¨ pod ä¸­åˆ›å»ºæ–°çš„å®¹å™¨</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç¤ºä¾‹ 1ï¼š<br>å¦‚ä¸‹æ‰€ç¤ºï¼Œåˆ›å»ºåä¸º <code>nginx-docs</code> çš„å®¹å™¨å¹¶åŒæ—¶åˆ›å»ºåä¸º <code>docker-docs</code> çš„ podï¼Œä¹Ÿå¯åˆ›å»ºå…¶ä»–å®¹å™¨æ·»åŠ è‡³ pod ä¸­ï¼Œpod ä¸­çš„å®¹å™¨å…±äº« <code>network namespace</code>ï¼š<img src=\"podman-run-pod-create.jpg\" alt=\"podman-run-pod-create.jpg\"></p>\n</li>\n<li>ğŸ¤˜ ç¤ºä¾‹ 2ï¼š<br>ä½¿ç”¨ podman åœ¨å•ä¸ª pod ä¸­é›†æˆå¤šå®¹å™¨çš„æ–¹æ³•ï¼Œå¯å‚è€ƒ <a href=\"https://alberthua-perl.github.io/2022/12/05/redhat-quay-v3-registry/\">ä¹‹å‰å‘å¸ƒçš„æ–‡æ¡£</a>ï¼Œè¯¥æ–‡æ¡£ä¸­å°† Quayã€MySQL ä¸ Redis çš„å•å®¹å™¨é›†æˆåœ¨å•ä¸ª pod ä¸­ï¼Œä½¿ç”¨ pod çš„ <code>network namespace</code> æ–¹ä¾¿ Quay é•œåƒä»“åº“çš„ç®¡ç†ã€‚</li>\n</ul>\n<h3 id=\"ğŸš€-ä½¿ç”¨-podman-kube-play-å®ç°-WordPress-çš„ä¸€é”®éƒ¨ç½²ï¼š\"><a href=\"#ğŸš€-ä½¿ç”¨-podman-kube-play-å®ç°-WordPress-çš„ä¸€é”®éƒ¨ç½²ï¼š\" class=\"headerlink\" title=\"ğŸš€ ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²ï¼š\"></a>ğŸš€ ä½¿ç”¨ podman kube play å®ç° WordPress çš„ä¸€é”®éƒ¨ç½²ï¼š</h3><ul>\n<li>é™¤ä¸Šè¿° podman pod å®¹å™¨ç¼–æ’çš„æ–¹å¼ä»¥å¤–ï¼Œpodman ä¹Ÿå·²æ”¯æŒç±»ä¼¼äºä½¿ç”¨ <code>Kubernetes</code> ç»“æ„åŒ– <code>yaml</code> æ–‡ä»¶çš„æ–¹å¼ï¼Œå³å¯ä½¿ç”¨ <code>podman kube play</code> åˆ›å»º <code>Pod</code>ã€<code>Deployment</code> ä¸ <code>PersistentVolumeClaim</code> ç­‰ã€‚</li>\n<li><p>å¯å°†ç”± <code>podman pod create</code> åˆ›å»ºçš„ pod é€šè¿‡å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman generate kube &lt;pod_name&gt; &gt; &lt;application_name&gt;.yml</span><br><span class=\"line\"><span class=\"comment\"># å¯¼å‡ºå·²å­˜åœ¨ pod çš„èµ„æºå®šä¹‰æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>è¯¥ç¤ºä¾‹ä¸­ç”Ÿæˆçš„ pod èµ„æºå®šä¹‰æ–‡ä»¶éœ€ç¨åŠ æ”¹åŠ¨ç”¨äºåº”ç”¨çš„éƒ¨ç½²ï¼Œå¯å‚è€ƒ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/mywpblog-pod.yml\" target=\"_blank\" rel=\"noopener\">è¯¥é“¾æ¥</a>ï¼š  </p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mywpblog</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mywpblog</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">automountServiceAccountToken:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">mysqld</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_USER</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_user</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">redhat</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_PASSWORD</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_pass</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_DATABASE</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_blog</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/library/mysql:5.7.40-debian</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">wpdatabase</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">      <span class=\"attr\">hostPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">      <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">        <span class=\"attr\">drop:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_MKNOD</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_NET_RAW</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_AUDIT_WRITE</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpdbfiles-host-0</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">apache2-foreground</span></span><br><span class=\"line\">    <span class=\"attr\">env:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_NAME</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_blog</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_HOST</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">\"0.0.0.0\"</span></span><br><span class=\"line\">      <span class=\"comment\"># WORDPRESS_DB_HOST definied as '0.0.0.0' because two containers </span></span><br><span class=\"line\">      <span class=\"comment\"># use same network namespace</span></span><br><span class=\"line\">      <span class=\"comment\"># WORDPRESS_DB_HOST is different from 'podman pod create' and </span></span><br><span class=\"line\">      <span class=\"comment\"># 'podman kube play'.</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_USER</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_user</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">WORDPRESS_DB_PASSWORD</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">wp_pass</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">docker.io/library/wordpress:6.1.1-php7.4-apache</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">wpfrontend</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">hostPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span> <span class=\"string\">&#123;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">      <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">        <span class=\"attr\">drop:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_MKNOD</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_NET_RAW</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">CAP_AUDIT_WRITE</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/www/html</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpfront-host-0</span></span><br><span class=\"line\">  <span class=\"attr\">enableServiceLinks:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">hostname:</span> <span class=\"string\">mywpblog</span></span><br><span class=\"line\">  <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">      <span class=\"attr\">path:</span> <span class=\"string\">/tmp/wpdbfiles</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpdbfiles-host-0</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">      <span class=\"attr\">path:</span> <span class=\"string\">/tmp/wpfront</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">tmp-wpfront-host-0</span></span><br><span class=\"line\"><span class=\"attr\">status:</span> <span class=\"string\">&#123;&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ä½¿ç”¨è¯¥ <a href=\"https://github.com/Alberthua-Perl/go-kubernetes-learn-path/blob/hotfixes/wpblog-pod-manage\" target=\"_blank\" rel=\"noopener\">è„šæœ¬</a> å®ç° WordPress åº”ç”¨çš„ä¸€é”®éƒ¨ç½²ä¸ç®¡ç†ï¼ŒWordPress å®¹å™¨ä¸ MySQL å®¹å™¨è¿è¡ŒäºåŒä¸€ pod ä¸­ï¼Œè¿è¡ŒæˆåŠŸåæ‰“å¼€æµè§ˆå™¨å³å¯è®¿é—®å®‰è£… WordPress åº”ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ./wpblog-pod-manage --kube-deploy</span><br><span class=\"line\">---&gt; Start deploy blog pod...</span><br><span class=\"line\">---&gt; Use podman kube play to create and run pod...</span><br><span class=\"line\">Pod:</span><br><span class=\"line\">7e8d6586ed246380fdb9ee00e73361b16938d4f2d5b646041f5036d9b7e4e8ae</span><br><span class=\"line\">Containers:</span><br><span class=\"line\">5132590944a03adcdfc08ba27945c708ae23b19fdce24fbcda9df6c845b5bc4e</span><br><span class=\"line\">cc2e7cb2a3a5423a7f0d93d07590b5826657eeb59d0491c5578dde0a1d10de1e</span><br><span class=\"line\">---&gt; Pod and containers as followings...</span><br><span class=\"line\">POD ID        NAME        STATUS      CREATED         INFRA ID      <span class=\"comment\"># OF CONTAINERS</span></span><br><span class=\"line\">7e8d6586ed24  mywpblog    Running     34 seconds ago  ca2ea53dfcbb  3</span><br><span class=\"line\"></span><br><span class=\"line\">CONTAINER ID  IMAGE                                            COMMAND               CREATED         STATUS            PORTS                                         NAMES</span><br><span class=\"line\">ca2ea53dfcbb  localhost/podman-pause:4.3.0-1666339791                                35 seconds ago  Up 2 seconds ago  0.0.0.0:3306-&gt;3306/tcp, 0.0.0.0:8080-&gt;80/tcp  7e8d6586ed24-infra    </span><br><span class=\"line\">5132590944a0  docker.io/library/mysql:5.7.40-debian            mysqld                19 seconds ago  Up 2 seconds ago  0.0.0.0:3306-&gt;3306/tcp, 0.0.0.0:8080-&gt;80/tcp  mywpblog-wpdatabase   </span><br><span class=\"line\">cc2e7cb2a3a5  docker.io/library/wordpress:6.1.1-php7.4-apache  apache2-foregroun...  4 seconds ago   Up 2 seconds ago  0.0.0.0:3306-&gt;3306/tcp, 0.0.0.0:8080-&gt;80/tcp  mywpblog-wpfrontend   </span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨ podman kube play çš„æ–¹å¼éƒ¨ç½² WordPress åº”ç”¨</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h3 id=\"Podman-æŠ¥é”™ç¤ºä¾‹ï¼š\"><a href=\"#Podman-æŠ¥é”™ç¤ºä¾‹ï¼š\" class=\"headerlink\" title=\"Podman æŠ¥é”™ç¤ºä¾‹ï¼š\"></a>Podman æŠ¥é”™ç¤ºä¾‹ï¼š</h3><ul>\n<li>podman å®¹å™¨é•œåƒä»“åº“çš„é…ç½®æ–¹å¼ï¼š  <ul>\n<li>å…¨å±€é…ç½®ï¼š<code>/etc/containers/registries.conf</code></li>\n<li>å±€éƒ¨é…ç½®ï¼š<code>$HOME/.config/containers/registroes.conf</code></li>\n</ul>\n</li>\n<li>è‹¥ podman å®‰è£…ååœ¨ä»¥ä¸Šé…ç½®ä¸­æœªå”¯ä¸€æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“ï¼Œé‚£ä¹ˆåœ¨æ‹‰å–å®¹å™¨é•œåƒæ—¶ï¼Œå°†äº¤äº’å¼æç¤ºç”¨æˆ·é€‰æ‹©å®¹å™¨é•œåƒä»“åº“ã€‚</li>\n<li><p>Podman ç™»å½•å®¹å™¨é•œåƒä»“åº“çš„æ–¹å¼ï¼š  </p>\n<ul>\n<li><p>ä½¿ç”¨ <code>podman login</code> å­å‘½ä»¤ç™»å½•æŒ‡å®šçš„å®¹å™¨é•œåƒä»“åº“æ—¶ï¼ŒPodman å°†è®¿é—® token é»˜è®¤å­˜å‚¨äº <code>/run/user/&lt;UID&gt;/containers/auth.json</code> æ–‡ä»¶ä¸­ï¼Œå½“ logout ä»“åº“æ—¶ï¼Œè¯¥ token å°†è¢«ç§»é™¤ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶ä¸­å¯å­˜å‚¨å¤šä¸ªç™»å½•çš„ä»“åº“ tokenã€‚<img src=\"podman-login-token.jpg\" alt=\"podman-login-token.jpg\">    </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman <span class=\"built_in\">logout</span> --all</span><br><span class=\"line\"><span class=\"comment\"># ç™»å‡ºæ‰€æœ‰çš„å®¹å™¨é•œåƒä»“åº“ï¼Œå¹¶ä» auth.json æ–‡ä»¶ä¸­ç§»é™¤æ‰€æœ‰çš„ tokenã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Podman é»˜è®¤æƒ…å†µä¸‹éœ€è¦ä¸å®¹å™¨é•œåƒä»“åº“ä½¿ç”¨ <code>TLS</code> è®¤è¯ï¼Œè‹¥å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLSã€ä½¿ç”¨è‡ªç­¾åçš„ TLS è¯ä¹¦æˆ–æœªçŸ¥çš„ CA ç­¾ç½²çš„è¯ä¹¦ï¼Œéœ€å¯¹ loginã€pull æˆ– push å­å‘½ä»¤æ·»åŠ  <code>--tls-verify=false</code> é€‰é¡¹ä»¥å®Œæˆè®¤è¯ã€‚  </p>\n</li>\n<li>Skopeo ä¸ Buildah ä¹Ÿå¯ä½¿ç”¨ Podman ä¿å­˜çš„è®¤è¯ tokenï¼Œä½†æ˜¯æ— æ³•æ‰§è¡Œäº¤äº’å¼çš„ç™»å½•å¯†ç è¾“å…¥ã€‚</li>\n</ul>\n</li>\n<li><p>ç¤ºä¾‹ 1ï¼š<br>ğŸ‘‰ podman v3.2.3 ç™»å½• Harbor v1.8.1 èº«ä»½è®¤è¯æŠ¥é”™ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman login harbor.domain12.example.com:8880</span><br><span class=\"line\">  Username: admin</span><br><span class=\"line\">  Password: redhat</span><br><span class=\"line\">  Error: authenticating creds <span class=\"keyword\">for</span> <span class=\"string\">\"harbor.domain12.example.com:8880\"</span>: error pinging docker registry </span><br><span class=\"line\">  harbor.domain12.example.com:8880: Get <span class=\"string\">\"https://harbor.domain12.example.com:8880/v2/\"</span>: </span><br><span class=\"line\">  http: server gave HTTP response to HTTPS client</span><br><span class=\"line\"><span class=\"comment\"># Podman æœªåšä»»ä½•é…ç½®ç™»å½• Harbor æŠ¥é”™ï¼Œè¯¥ Harbor å®¹å™¨é•œåƒä»“åº“æœªé…ç½® TLS åŠ å¯†ä¼ è¾“ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># æŠ¥é”™æ˜¾ç¤º Harbor å“åº” HTTP è¯·æ±‚ï¼Œè€Œ Podman å‘é€ HTTPS è¯·æ±‚ç™»å½•ã€‚</span></span><br><span class=\"line\"><span class=\"comment\"># å› æ­¤ï¼Œå°† Podman é…ç½®ä¸ºå‘é€ HTTP è¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ¤” è§£å†³æ–¹å¼ä¸€ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman login --tls-verify=<span class=\"literal\">false</span> harbor.domain12.example.com:8880</span><br><span class=\"line\">  Username: admin</span><br><span class=\"line\">  Password: redhat</span><br><span class=\"line\">  Login Succeeded!</span><br><span class=\"line\"><span class=\"comment\"># Podman æœªè¿›è¡Œä»»ä½•é…ç½®ï¼Œç›´æ¥ä½¿ç”¨ --tls-verify=false é€‰é¡¹å³å¯è®¤è¯ç™»å½•ã€‚</span></span><br></pre></td></tr></table></figure>\n<p>ğŸ¤” è§£å†³æ–¹å¼äºŒï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mkdir -p ~/.config/containers/ &amp;&amp; <span class=\"built_in\">cd</span> ~/.config/containers/</span><br><span class=\"line\"><span class=\"comment\"># åˆ›å»ºæ™®é€šç”¨æˆ· rootless å®¹å™¨çš„ç›®å½•</span></span><br><span class=\"line\">$ vim ~/.config/containers/registries.conf</span><br><span class=\"line\">  unqualified-search-registries = [<span class=\"string\">'harbor.domain12.example.com:8880'</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  [[registry]]</span><br><span class=\"line\">  location = <span class=\"string\">\"harbor.domain12.example.com:8880\"</span></span><br><span class=\"line\">  insecure = <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># If true, unencrypted HTTP as well as TLS connections with untrusted</span></span><br><span class=\"line\">  <span class=\"comment\"># certificates are allowed.</span></span><br><span class=\"line\">  block = <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®æœªåŠ å¯†ä¼ è¾“çš„ Harbor å®¹å™¨é•œåƒä»“åº“çš„ä¸»æœºåä¸ç«¯å£</span></span><br><span class=\"line\"></span><br><span class=\"line\">$ podman login --<span class=\"built_in\">log</span>-level=debug harbor.domain12.example.com:8880</span><br><span class=\"line\">  INFO[0000] podman filtering at <span class=\"built_in\">log</span> level debug</span><br><span class=\"line\">  DEBU[0000] Called login.PersistentPreRunE(podman login --<span class=\"built_in\">log</span>-level=debug harbor.domain12.example.com:8880)</span><br><span class=\"line\">  DEBU[0000] overlay storage already configured with a mount-program</span><br><span class=\"line\">  DEBU[0000] Merged system config <span class=\"string\">\"/usr/share/containers/containers.conf\"</span></span><br><span class=\"line\">  DEBU[0000] overlay storage already configured with a mount-program</span><br><span class=\"line\">  DEBU[0000] Using conmon: <span class=\"string\">\"/usr/bin/conmon\"</span></span><br><span class=\"line\">  ...</span><br><span class=\"line\">  DEBU[0000] Using OCI runtime <span class=\"string\">\"/usr/bin/runc\"</span></span><br><span class=\"line\">  DEBU[0000] Default CNI network name podman is unchangeable</span><br><span class=\"line\">  INFO[0000] Setting parallel job count to 13</span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/home/kiosk/.config/containers/registries.conf\"</span></span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/etc/containers/registries.conf.d/000-shortnames.conf\"</span></span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/etc/containers/registries.conf.d/001-rhel-shortnames.conf\"</span></span><br><span class=\"line\">  DEBU[0000] Loading registries configuration <span class=\"string\">\"/etc/containers/registries.conf.d/002-rhel-shortnames-overrides.conf\"</span></span><br><span class=\"line\">  DEBU[0000] No credentials <span class=\"keyword\">for</span> harbor.domain12.example.com:8880 found</span><br><span class=\"line\">  Username: admin</span><br><span class=\"line\">  Password: <span class=\"comment\"># äº¤äº’å¼è¾“å…¥ç™»å½•å¯†ç </span></span><br><span class=\"line\">  DEBU[0004] Looking <span class=\"keyword\">for</span> TLS certificates and private keys <span class=\"keyword\">in</span> /etc/docker/certs.d/harbor.domain12.example.com:8880</span><br><span class=\"line\">  DEBU[0004] GET https://harbor.domain12.example.com:8880/v2/</span><br><span class=\"line\">  DEBU[0004] Ping https://harbor.domain12.example.com:8880/v2/ err Get <span class=\"string\">\"https://harbor.domain12.example.com:8880/v2/\"</span>: http: </span><br><span class=\"line\">  server gave HTTP response to HTTPS client (&amp;url.Error&#123;Op:<span class=\"string\">\"Get\"</span>, URL:<span class=\"string\">\"https://harbor.domain12.example.com:8880/v2/\"</span>, </span><br><span class=\"line\">  Err:(*errors.errorString)(0xc000590030)&#125;)</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  DEBU[0004] GET http://harbor.domain12.example.com:8880/service/token?account=admin&amp;service=harbor-registry</span><br><span class=\"line\">  DEBU[0004] GET http://harbor.domain12.example.com:8880/v2/</span><br><span class=\"line\">  DEBU[0004] Stored credentials <span class=\"keyword\">for</span> harbor.domain12.example.com:8880 <span class=\"keyword\">in</span> credential helper containers-auth.json</span><br><span class=\"line\">  Login Succeeded!</span><br><span class=\"line\">  DEBU[0004] Called login.PersistentPostRunE(podman login --<span class=\"built_in\">log</span>-level=debug harbor.domain12.example.com:8880)</span><br><span class=\"line\"><span class=\"comment\"># Podman é»˜è®¤ä½¿ç”¨ TLS åŠ å¯†ä¼ è¾“</span></span><br><span class=\"line\"><span class=\"comment\"># ä»¥ä¸Šé…ç½®æ–‡ä»¶å°†ä½¿ Podman ä»¥ HTTP æ–¹å¼è®¤è¯ç™»å½• Harborã€‚</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ç¤ºä¾‹ 2ï¼š<br>ğŸ‘‰ podman v3.2.3 æ¨é€å®¹å™¨é•œåƒè‡³ Harbor v1.8.1 ä¸­æ˜¾ç¤º â€œä¸å®Œæ•´â€ï¼š  </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ podman push harbor.domain12.example.com:8880/library/apache-rhce8.2-alpine:1.0</span><br><span class=\"line\">  Getting image <span class=\"built_in\">source</span> signatures</span><br><span class=\"line\">  Copying blob 551db21ded82 skipped: already exists</span><br><span class=\"line\">  Copying blob 8213d0880f11 skipped: already exists</span><br><span class=\"line\">  Copying blob e2eb06d8af82 skipped: already exists</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  Copying blob 05e56f8d5aae skipped: already exists</span><br><span class=\"line\">  Copying blob 631e8a8040bb skipped: already exists</span><br><span class=\"line\">  Copying blob dedba5c062fc skipped: already exists</span><br><span class=\"line\">  Copying blob 0e609f35aa06 [--------------------------------------] 0.0b / 0.0b</span><br><span class=\"line\">  Copying config 34f32c2e7a [======================================] 10.0KiB / 10.0KiB</span><br><span class=\"line\">  Writing manifest to image destination</span><br><span class=\"line\">  Storing signatures</span><br></pre></td></tr></table></figure>\n<p>ä»æ¨é€çš„è¿”å›ç»“æœæ˜¾ç¤ºï¼Œå…·æœ‰ 2 å±‚å®¹å™¨é•œåƒå±‚ä¼¼ä¹æœªæ¨é€æˆåŠŸï¼Œä½†å°†è¯¥é•œåƒä» Harbor ä¸­æ‹‰å–å¹¶é‡æ–°è¿è¡Œå®¹å™¨åï¼Œå®¹å™¨èƒ½æ­£å¸¸æä¾›æœåŠ¡ï¼Œå› æ­¤æœ€å 2 å±‚é•œåƒå±‚å®é™…æ¨é€æˆåŠŸã€‚</p>\n</li>\n<li>ç¤ºä¾‹ 3ï¼š<br>ğŸ‘‰ å®¹å™¨é•œåƒæ— ä»»ä½•è¿è¡Œæˆ–é€€å‡ºçŠ¶æ€å®¹å™¨å ç”¨ï¼Œä½†ä¾ç„¶æ— æ³•åˆ é™¤é•œåƒï¼Œå¯å°è¯•ä½¿ç”¨ <code>--force</code> é€‰é¡¹å°†å…¶å¼ºåˆ¶åˆ é™¤ã€‚<img src=\"podman-rmi-error-no-container-use.jpg\" alt=\"podman-rmi-error-no-container-use.jpg\"></li>\n<li><p>ç¤ºä¾‹ 4ï¼š<br>ğŸ‘‰ ç”±äºä» <code>dockerbub</code> ä¸Šç›´æ¥æ‹‰å–çš„é•œåƒä¸º <code>docker image format</code>ï¼Œæ— æ³•ä½¿ç”¨ <code>podman commit</code> å‘½ä»¤æäº¤ä¸ºæ–°çš„å®¹å™¨é•œåƒï¼Œè¯¥å‘½ä»¤å¯¹äº <code>-m</code> é€‰é¡¹ä¸èƒ½å¯¹ docker image format é•œåƒç”Ÿæ•ˆï¼Œé»˜è®¤åªæ”¯æŒ <code>OCI image format</code>ï¼Œå› æ­¤ä½¿ç”¨ -m é€‰é¡¹å¯¹å®¹å™¨æ‰§è¡Œæäº¤æ—¶éœ€å¼ºåˆ¶æŒ‡å®š <code>-f docker</code> æ‰èƒ½ç”Ÿæ•ˆã€‚</p>\n<blockquote>\n<p>ğŸ“Œ<strong>æ³¨æ„ï¼š</strong></p>\n<p>å¯ä½¿ç”¨ <code>skopeo</code> å·¥å…·è½¬æ¢ docker image format ä¸ OCI image formatã€‚</p>\n</blockquote>\n<p><img src=\"podman-commit-warning.jpg\" alt=\"podman-commit-warning.jpg\"></p>\n</li>\n<li><p>ç¤ºä¾‹ 5ï¼š<br>ğŸ‘‰ podman è¿è¡Œ rootfull æˆ– rootless busybox å®¹å™¨åï¼Œ<code>ping</code> å¤–ç½‘æŠ¥é”™æƒé™é—®é¢˜æ— æ³• ping é€šå¤–ç½‘ï¼Œä½†ä½¿ç”¨å…¶ä»–å·¥å…·å¯ä¸å¤–ç½‘é€šä¿¡ï¼Œé€šè¿‡ <a href=\"https://www.redhat.com/sysadmin/container-networking-podman\" target=\"_blank\" rel=\"noopener\">è¯¥æ–‡æ¡£</a> ä¸­å¯çŸ¥ï¼Œping å‘½ä»¤å¯¹ <code>capability</code> æ•æ„Ÿï¼Œå®¹å™¨å¯èƒ½ç¼ºå°‘ <code>CAP_NET_RAW</code>capability æ— æ³•é€šè¿‡å®¿ä¸»æœº ping é€šå¤–ç½‘ã€‚<br>ğŸ‘‰ å½“ç„¶ï¼Œè¿è¡Œå®¹å™¨æ—¶æŒ‡å®š <code>--privileged</code> é€‰é¡¹å¯ä½¿å®¹å™¨è·å¾—ä¸å®¿ä¸»æœº root ç”¨æˆ·åŒæ ·çš„ä¸å®¿ä¸»æœºäº¤äº’çš„æƒé™èƒ½åŠ›ï¼Œä½†èµ‹äºˆçš„æƒé™è¿‡é«˜ï¼Œåº”å½“å‹åˆ¶è¯¥æƒé™ï¼Œæ›´å¥½çš„é€‰æ‹©æ˜¯å¯¹è¿è¡Œå®¹å™¨æ·»åŠ é€‚å½“çš„ <code>Linux capabilities</code>ã€‚<img src=\"podman-busybox-capability.jpg\" alt=\"podman-busybox-capability.jpg\"></p>\n</li>\n</ul>\n<h3 id=\"Podman-æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\"><a href=\"#Podman-æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\" class=\"headerlink\" title=\"Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š\"></a>Podman æœ‰å¾…æµ‹è¯•åŠŸèƒ½ï¼š</h3><p>Podman æ—¥å¿—é©±åŠ¨ç›®å‰åªæ”¯æŒ <code>k8s-file</code>ã€<code>journald</code> ä¸ <code>none</code>ï¼Œæš‚æ—¶ä¸æ”¯æŒå®¹å™¨æ—¥å¿—çš„ <code>JSON</code> æ ¼å¼è¾“å‡ºï¼Œå› æ­¤ä¸èƒ½ä¸æ—¥å¿—æ”¶é›†å¼•æ“ <code>fluentd</code> é›†æˆï¼Œç”±å…¶å®ç°å°†æ—¥å¿—ä¼ è¾“è‡³ ELK æˆ– EFK è¿›è¡Œé›†ä¸­å¼çš„å­˜å‚¨ä¸ç´¢å¼•ã€‚</p>\n"}],"PostAsset":[{"_id":"source/_posts/fcos-rhcos-basic-usage/quay-coreos-butane-release.png","slug":"quay-coreos-butane-release.png","post":"cldfonoia000116vdetjs0rfb","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/server-ca-signed-certification.png","slug":"server-ca-signed-certification.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/crictl-ssl-ca-request-quay-error.jpg","slug":"crictl-ssl-ca-request-quay-error.jpg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/kubernetes-cluster-status.jpg","slug":"kubernetes-cluster-status.jpg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/register-var-used-between-two-plays-error.jpg","slug":"register-var-used-between-two-plays-error.jpg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-6.jpg","slug":"loganalyzer-web-6.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-7.jpg","slug":"loganalyzer-web-7.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-5.jpg","slug":"loganalyzer-web-5.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/cockpit-podman-1.jpg","slug":"cockpit-podman-1.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/cockpit-podman-2.jpg","slug":"cockpit-podman-2.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/gogs-settings.jpg","slug":"gogs-settings.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/podman-network-mode.jpg","slug":"podman-network-mode.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/podman-image-list.jps.JPG","slug":"podman-image-list.jps.JPG","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/rootless-slirp4netns-networking.jpg","slug":"rootless-slirp4netns-networking.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/redhat-quay-v3-registry/podman-push-quay-permission-denied-1001-2.jpg","slug":"podman-push-quay-permission-denied-1001-2.jpg","post":"cldfonoly000i16vdoy45as4e","modified":1,"renderable":0},{"_id":"source/_posts/skopeo-basic-usage/skopeo-inspect-creds.jpg","slug":"skopeo-inspect-creds.jpg","post":"cldfonoso001p16vdx2hmxdxp","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/client-hello-body-1.png","slug":"client-hello-body-1.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/https-bg.png","slug":"https-bg.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/https-mutual-no-client-cert-error-2.png","slug":"https-mutual-no-client-cert-error-2.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/https-single-auth-chrome-error-2.png","slug":"https-single-auth-chrome-error-2.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-interface-1.jpg","slug":"kubernetes-interface-1.jpg","post":"cldfonoko000816vdmg3j0qwb","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-single-authentication-progress.png","slug":"ssl-tls-single-authentication-progress.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/kani-ansible-k8s.jpg","slug":"kani-ansible-k8s.jpg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-4.jpg","slug":"loganalyzer-web-4.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/quay-push-error-1.jpg","slug":"quay-push-error-1.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/external-access-container-web-service-iptables.jpg","slug":"external-access-container-web-service-iptables.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/minio-server-cloud-native-object-storage-demo-2.jpg","slug":"minio-server-cloud-native-object-storage-demo-2.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/hualf-rootless-container.jpg","slug":"hualf-rootless-container.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/cockpit-podman-2.jpg","slug":"cockpit-podman-2.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-1.jpg","slug":"user-namespace-subuid-mapping-1.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/external-access-container-web-service-iptables.jpg","slug":"external-access-container-web-service-iptables.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/minio-server-cloud-native-object-storage-demo-2.jpg","slug":"minio-server-cloud-native-object-storage-demo-2.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/kani-ansible-k8s.svg","slug":"kani-ansible-k8s.svg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-docker-format-image-dir.jpg","slug":"skopeo-copy-docker-format-image-dir.jpg","post":"cldfonoso001p16vdx2hmxdxp","modified":1,"renderable":0},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-oci-2.jpg","slug":"skopeo-copy-oci-2.jpg","post":"cldfonoso001p16vdx2hmxdxp","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/ssl-four-handshakes-https-single-and-mutual-authentication.png","slug":"ssl-four-handshakes-https-single-and-mutual-authentication.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/wireshark-https-mutual-progress.png","slug":"wireshark-https-mutual-progress.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-apiserver-manifest.jpg","slug":"kubernetes-apiserver-manifest.jpg","post":"cldfonoko000816vdmg3j0qwb","modified":1,"renderable":0},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-single-master-arch.jpg","slug":"kubernetes-single-master-arch.jpg","post":"cldfonoko000816vdmg3j0qwb","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-8.jpg","slug":"loganalyzer-web-8.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/centos79-kernel-not-support-podman-rootless.jpg","slug":"centos79-kernel-not-support-podman-rootless.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/rootless-container-to-container-bandwidth.jpg","slug":"rootless-container-to-container-bandwidth.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-1.jpg","slug":"user-namespace-subuid-mapping-1.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/kubeadm-init-master-error-2.jpg","slug":"kubeadm-init-master-error-2.jpg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/kani-deploy-k8s/kubeadm-init-master-error-1.jpg","slug":"kubeadm-init-master-error-1.jpg","post":"cldfonola000d16vdd44th76p","modified":1,"renderable":0},{"_id":"source/_posts/redhat-quay-v3-registry/ssl-key-permission-run-quay-error.jpg","slug":"ssl-key-permission-run-quay-error.jpg","post":"cldfonoly000i16vdoy45as4e","modified":1,"renderable":0},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/mongodb-bg-2.png","slug":"mongodb-bg-2.png","post":"cldfonoma000l16vdkg1vquml","modified":1,"renderable":0},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-docker-daemon.jpg","slug":"skopeo-copy-docker-daemon.jpg","post":"cldfonoso001p16vdx2hmxdxp","modified":1,"renderable":0},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-oci-1.jpg","slug":"skopeo-copy-oci-1.jpg","post":"cldfonoso001p16vdx2hmxdxp","modified":1,"renderable":0},{"_id":"source/_posts/golang-code-server/code-server-bg.png","post":"cldfonojo000316vdbsql1wkd","slug":"code-server-bg.png","modified":1,"renderable":1},{"_id":"source/_posts/kubeadm-update-k8s-certs/kubeadm-certs-bg.jpg","post":"cldfonokl000716vde5os9l41","slug":"kubeadm-certs-bg.jpg","modified":1,"renderable":1},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-login.png","post":"cldfonoma000l16vdkg1vquml","slug":"rocketchat-login.png","modified":1,"renderable":1},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-mongo-app-resources.png","slug":"rocketchat-mongo-app-resources.png","post":"cldfonoma000l16vdkg1vquml","modified":1,"renderable":0},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-mongo-connect-successfully.png","slug":"rocketchat-mongo-connect-successfully.png","post":"cldfonoma000l16vdkg1vquml","modified":1,"renderable":0},{"_id":"source/_posts/rocketchat-mongodb-on-k8s/rocketchat-with-mismatch-version-mongo-error.png","slug":"rocketchat-with-mismatch-version-mongo-error.png","post":"cldfonoma000l16vdkg1vquml","modified":1,"renderable":0},{"_id":"source/_posts/fcos-rhcos-basic-usage/coreos-installer-customized-install.png","post":"cldfonoia000116vdetjs0rfb","slug":"coreos-installer-customized-install.png","modified":1,"renderable":1},{"_id":"source/_posts/fcos-rhcos-basic-usage/fedora-coreos-bg.jpg","slug":"fedora-coreos-bg.jpg","post":"cldfonoia000116vdetjs0rfb","modified":1,"renderable":0},{"_id":"source/_posts/fcos-rhcos-basic-usage/fedora-coreos-release-version.png","post":"cldfonoia000116vdetjs0rfb","slug":"fedora-coreos-release-version.png","modified":1,"renderable":1},{"_id":"source/_posts/fcos-rhcos-basic-usage/login-fedora-coreos-live.png","post":"cldfonoia000116vdetjs0rfb","slug":"login-fedora-coreos-live.png","modified":1,"renderable":1},{"_id":"source/_posts/fcos-rhcos-basic-usage/use-fedora-coreos-live-to-install.png","post":"cldfonoia000116vdetjs0rfb","slug":"use-fedora-coreos-live-to-install.png","modified":1,"renderable":1},{"_id":"source/_posts/k8s-cluster-resource-basic/k8s-resource-basic.png","post":"cldfonoko000816vdmg3j0qwb","slug":"k8s-resource-basic.png","modified":1,"renderable":1},{"_id":"source/_posts/k8s-cluster-resource-basic/k8s-resource-basic.svg","post":"cldfonoko000816vdmg3j0qwb","slug":"k8s-resource-basic.svg","modified":1,"renderable":1},{"_id":"source/_posts/k8s-cluster-resource-basic/kubectl-get-raw-json.jpg","post":"cldfonoko000816vdmg3j0qwb","slug":"kubectl-get-raw-json.jpg","modified":1,"renderable":1},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-ha-arch-demo.jpg","slug":"kubernetes-ha-arch-demo.jpg","post":"cldfonoko000816vdmg3j0qwb","modified":1,"renderable":0},{"_id":"source/_posts/k8s-cluster-resource-basic/kubernetes-interface-2.jpg","post":"cldfonoko000816vdmg3j0qwb","slug":"kubernetes-interface-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/k8s-cluster-resource-basic/pod-name.jpg","post":"cldfonoko000816vdmg3j0qwb","slug":"pod-name.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-oci-image-format-digest.jpg","slug":"skopeo-oci-image-format-digest.jpg","post":"cldfonoso001p16vdx2hmxdxp","modified":1,"renderable":0},{"_id":"source/_posts/golang-environment-deploy/golang-develop-bg.png","post":"cldfonokg000616vdxjsn08as","slug":"golang-develop-bg.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/golang-develop-bg.svg","post":"cldfonokg000616vdxjsn08as","slug":"golang-develop-bg.svg","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-1.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-1.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-2.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-2.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-3.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-3.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-4.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-4.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-5.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-5.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-6.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-6.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-7.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-7.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/sublime-text-golang-8.png","post":"cldfonokg000616vdxjsn08as","slug":"sublime-text-golang-8.png","modified":1,"renderable":1},{"_id":"source/_posts/golang-environment-deploy/vim-error.jpg","post":"cldfonokg000616vdxjsn08as","slug":"vim-error.jpg","modified":1,"renderable":1},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/hello-world-dark-bg.jpg","slug":"hello-world-dark-bg.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-mysql-rsyslogserver.jpg","post":"cldfonoll000e16vdvqcp5vmt","slug":"loganalyzer-mysql-rsyslogserver.jpg","modified":1,"renderable":1},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-1.jpg","post":"cldfonoll000e16vdvqcp5vmt","slug":"loganalyzer-web-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-10.jpg","slug":"loganalyzer-web-10.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-2.jpg","post":"cldfonoll000e16vdvqcp5vmt","slug":"loganalyzer-web-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-3.jpg","slug":"loganalyzer-web-3.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/loganalyzer-web-9.jpg","post":"cldfonoll000e16vdvqcp5vmt","slug":"loganalyzer-web-9.jpg","modified":1,"renderable":1},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/mysql-container-run-error.jpg","slug":"mysql-container-run-error.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/quay-push-error-2.jpg","post":"cldfonoll000e16vdvqcp5vmt","slug":"quay-push-error-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/loganalyzer-rsyslog-mysql/selinux-php-mysql-connection.jpg","slug":"selinux-php-mysql-connection.jpg","post":"cldfonoll000e16vdvqcp5vmt","modified":1,"renderable":0},{"_id":"source/_posts/redhat-quay-v3-registry/catalog-health-index.jpg","post":"cldfonoly000i16vdoy45as4e","slug":"catalog-health-index.jpg","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-1.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-1.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-2.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-2.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-3.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-3.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-4.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-4.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-5.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-5.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-6.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-6.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-7.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-7.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/config-quay-8.png","post":"cldfonoly000i16vdoy45as4e","slug":"config-quay-8.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/docker-client-login-quay-registry.jpg","post":"cldfonoly000i16vdoy45as4e","slug":"docker-client-login-quay-registry.jpg","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/first-login-config-quay.png","post":"cldfonoly000i16vdoy45as4e","slug":"first-login-config-quay.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/go-toolset-catalog.jpg","post":"cldfonoly000i16vdoy45as4e","slug":"go-toolset-catalog.jpg","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/normal-login-quay.png","post":"cldfonoly000i16vdoy45as4e","slug":"normal-login-quay.png","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/podman-push-quay-permission-denied-1001-1.jpg","post":"cldfonoly000i16vdoy45as4e","slug":"podman-push-quay-permission-denied-1001-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/redhat-quay-v3-registry/redhat-quay-bg.jpg","slug":"redhat-quay-bg.jpg","post":"cldfonoly000i16vdoy45as4e","modified":1,"renderable":0},{"_id":"source/_posts/https-handshake-authentication/client-server-tcp-ssl-socket.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"client-server-tcp-ssl-socket.png","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/rootless-container-to-container-bandwidth.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"rootless-container-to-container-bandwidth.jpg","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/ca-signed-certification-verify.jpg","post":"cldfonol2000b16vdp2mvhc7i","slug":"ca-signed-certification-verify.jpg","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/client-hello-body-2.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"client-hello-body-2.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/client-response-to-server-ssl.jpg","post":"cldfonol2000b16vdp2mvhc7i","slug":"client-response-to-server-ssl.jpg","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-1.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"firefox-import-pc12-certs-1.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-2.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"firefox-import-pc12-certs-2.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-3.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"firefox-import-pc12-certs-3.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-4.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"firefox-import-pc12-certs-4.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/firefox-import-pc12-certs-5.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"firefox-import-pc12-certs-5.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/https-mutual-no-client-cert-error-1.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"https-mutual-no-client-cert-error-1.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/https-single-auth-chrome-error-1.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"https-single-auth-chrome-error-1.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/server-hello-done.jpg","post":"cldfonol2000b16vdp2mvhc7i","slug":"server-hello-done.jpg","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/server-key-exchange.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"server-key-exchange.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/server-response-to-client-4-phase.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"server-response-to-client-4-phase.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/server-response-to-client-ssl.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"server-response-to-client-ssl.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-authentication.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"ssl-tls-authentication.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-handshake-end.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"ssl-tls-handshake-end.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/ssl-tls-in-network-stack.png","post":"cldfonol2000b16vdp2mvhc7i","slug":"ssl-tls-in-network-stack.png","modified":1,"renderable":1},{"_id":"source/_posts/https-handshake-authentication/wireshark-https-single-progress.png","slug":"wireshark-https-single-progress.png","post":"cldfonol2000b16vdp2mvhc7i","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-2-edited.png","post":"cldfonols000g16vdrnw9xusi","slug":"user-namespace-subuid-mapping-2-edited.png","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/container-access-external-iptables.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"container-access-external-iptables.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/godev-rootless-container.jpg","slug":"godev-rootless-container.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/gogs-git-repository.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"gogs-git-repository.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/minio-server-cloud-native-object-storage-demo-1.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"minio-server-cloud-native-object-storage-demo-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/minio-server-cloud-native-object-storage-demo-3.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"minio-server-cloud-native-object-storage-demo-3.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-bg.png","slug":"podman-bg.png","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/podman-bg.webp","post":"cldfonols000g16vdrnw9xusi","slug":"podman-bg.webp","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-busybox-capability.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"podman-busybox-capability.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-commit-warning.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"podman-commit-warning.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-login-token.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"podman-login-token.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-macvlan-network.png","slug":"podman-macvlan-network.png","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/podman-pull-image.jpg","slug":"podman-pull-image.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/podman-push-quay.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"podman-push-quay.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-rmi-error-no-container-use.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"podman-rmi-error-no-container-use.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-run-pod-create.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"podman-run-pod-create.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/podman-version-compare.png","post":"cldfonols000g16vdrnw9xusi","slug":"podman-version-compare.png","modified":1,"renderable":1},{"_id":"source/_posts/podman-arch-usage/rootfull-container-to-container-bandwidth.jpg","slug":"rootfull-container-to-container-bandwidth.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/rootless-user-namespace-mapping.jpg","slug":"rootless-user-namespace-mapping.jpg","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-1-edited.png","slug":"user-namespace-subuid-mapping-1-edited.png","post":"cldfonols000g16vdrnw9xusi","modified":1,"renderable":0},{"_id":"source/_posts/podman-arch-usage/user-namespace-subuid-mapping-2.jpg","post":"cldfonols000g16vdrnw9xusi","slug":"user-namespace-subuid-mapping-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/centos79-kernel-not-support-podman-rootless.jpg","slug":"centos79-kernel-not-support-podman-rootless.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-2-edited.png","slug":"user-namespace-subuid-mapping-2-edited.png","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/skopeo-basic-usage/podman-load-dir-from-skopeo-copy.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"podman-load-dir-from-skopeo-copy.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-bg.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-bg.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-dest-creds.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-copy-dest-creds.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-dir-2.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-copy-dir-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-copy-transform-image-format.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-copy-transform-image-format.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-delete-1.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-delete-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-delete-2.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-delete-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-docker-image-format-digest-1.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-docker-image-format-digest-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-docker-image-format-digest-2.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-docker-image-format-digest-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-sync-between-registry.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-sync-between-registry.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-sync-demo.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-sync-demo.jpg","modified":1,"renderable":1},{"_id":"source/_posts/skopeo-basic-usage/skopeo-sync-help.jpg","post":"cldfonoso001p16vdx2hmxdxp","slug":"skopeo-sync-help.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/cockpit-podman-1.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"cockpit-podman-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/container-access-external-iptables.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"container-access-external-iptables.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/godev-rootless-container.jpg","slug":"godev-rootless-container.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/gogs-git-repository.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"gogs-git-repository.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/gogs-settings.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"gogs-settings.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/hualf-rootless-container.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"hualf-rootless-container.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/minio-server-cloud-native-object-storage-demo-1.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"minio-server-cloud-native-object-storage-demo-1.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/minio-server-cloud-native-object-storage-demo-3.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"minio-server-cloud-native-object-storage-demo-3.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-bg.webp","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-bg.webp","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-busybox-capability.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-busybox-capability.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-commit-warning.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-commit-warning.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-image-list.jps.JPG","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-image-list.jps.JPG","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-login-token.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-login-token.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-macvlan-network.png","slug":"podman-macvlan-network.png","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/podman-network-mode.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-network-mode.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-pull-image.jpg","slug":"podman-pull-image.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/podman-push-quay.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-push-quay.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-rmi-error-no-container-use.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-rmi-error-no-container-use.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/podman-run-pod-create.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"podman-run-pod-create.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/rootfull-container-to-container-bandwidth.jpg","slug":"rootfull-container-to-container-bandwidth.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/rootless-slirp4netns-networking.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"rootless-slirp4netns-networking.jpg","modified":1,"renderable":1},{"_id":"source/_posts/podman-usage-practice/rootless-user-namespace-mapping.jpg","slug":"rootless-user-namespace-mapping.jpg","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-1-edited.png","slug":"user-namespace-subuid-mapping-1-edited.png","post":"cldfonot1001r16vdfvxbn1bd","modified":1,"renderable":0},{"_id":"source/_posts/podman-usage-practice/user-namespace-subuid-mapping-2.jpg","post":"cldfonot1001r16vdfvxbn1bd","slug":"user-namespace-subuid-mapping-2.jpg","modified":1,"renderable":1},{"_id":"source/_posts/linux-process-uid/linux-ruid-euid-test.png","slug":"linux-ruid-euid-test.png","post":"cldfonoky000a16vd2mlvz048","modified":1,"renderable":0},{"_id":"source/_posts/linux-process-uid/linux-process-uid-table.png","slug":"linux-process-uid-table.png","post":"cldfonoky000a16vd2mlvz048","modified":1,"renderable":0},{"_id":"source/_posts/linux-process-uid/linux-process-uid-mapping.png","slug":"linux-process-uid-mapping.png","post":"cldfonoky000a16vd2mlvz048","modified":1,"renderable":0},{"_id":"source/_posts/linux-process-uid/linux-process_bg.jpg","slug":"linux-process_bg.jpg","post":"cldfonoky000a16vd2mlvz048","modified":1,"renderable":0}],"PostCategory":[],"PostTag":[{"post_id":"cldfonoia000116vdetjs0rfb","tag_id":"cldfonok9000516vdt952szzj","_id":"cldfonolu000h16vdjn9in2do"},{"post_id":"cldfonoia000116vdetjs0rfb","tag_id":"cldfonokq000916vd8vn29wp5","_id":"cldfonom1000j16vdsnbho0fq"},{"post_id":"cldfonoia000116vdetjs0rfb","tag_id":"cldfonol4000c16vdxhope1b2","_id":"cldfonomf000m16vd174flat7"},{"post_id":"cldfonojo000316vdbsql1wkd","tag_id":"cldfonolq000f16vdsugl6dn1","_id":"cldfonomm000n16vdcxerup1z"},{"post_id":"cldfonokg000616vdxjsn08as","tag_id":"cldfonolq000f16vdsugl6dn1","_id":"cldfononj000q16vdw1t9e21f"},{"post_id":"cldfonokg000616vdxjsn08as","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonont000r16vdhx4ji5r0"},{"post_id":"cldfonokl000716vde5os9l41","tag_id":"cldfonond000p16vd10ybfqt3","_id":"cldfonoog000u16vdwp4kgy9v"},{"post_id":"cldfonokl000716vde5os9l41","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonoos000v16vd3w0bt4ov"},{"post_id":"cldfonoko000816vdmg3j0qwb","tag_id":"cldfonond000p16vd10ybfqt3","_id":"cldfonoph000y16vdra41kkf4"},{"post_id":"cldfonoko000816vdmg3j0qwb","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonopr000z16vdqgeb0tdd"},{"post_id":"cldfonol2000b16vdp2mvhc7i","tag_id":"cldfonopv001016vdd4sbmanl","_id":"cldfonoqa001416vdtcbskmza"},{"post_id":"cldfonola000d16vdd44th76p","tag_id":"cldfonond000p16vd10ybfqt3","_id":"cldfonoqt001816vds0seovtr"},{"post_id":"cldfonola000d16vdd44th76p","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonoqt001916vdlzoxkzmv"},{"post_id":"cldfonola000d16vdd44th76p","tag_id":"cldfonoqr001616vdap14g8zr","_id":"cldfonoqu001b16vdpv92xaej"},{"post_id":"cldfonoll000e16vdvqcp5vmt","tag_id":"cldfonok9000516vdt952szzj","_id":"cldfonoqu001c16vdlg54ro4n"},{"post_id":"cldfonoll000e16vdvqcp5vmt","tag_id":"cldfonoqs001716vdm3evp9do","_id":"cldfonoqv001e16vdu6upo0es"},{"post_id":"cldfonols000g16vdrnw9xusi","tag_id":"cldfonoqs001716vdm3evp9do","_id":"cldfonoqx001g16vdujrg53oi"},{"post_id":"cldfonols000g16vdrnw9xusi","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonoqx001h16vd3exse8p2"},{"post_id":"cldfonoly000i16vdoy45as4e","tag_id":"cldfonoqs001716vdm3evp9do","_id":"cldfonor0001k16vdhgqe4yvp"},{"post_id":"cldfonoly000i16vdoy45as4e","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonor1001l16vdzs3x4r0x"},{"post_id":"cldfonoma000l16vdkg1vquml","tag_id":"cldfonond000p16vd10ybfqt3","_id":"cldfonor1001n16vdk675fitk"},{"post_id":"cldfonoma000l16vdkg1vquml","tag_id":"cldfonor1001m16vd6uo1cil6","_id":"cldfonor1001o16vdden0uxz0"},{"post_id":"cldfonoso001p16vdx2hmxdxp","tag_id":"cldfonoqs001716vdm3evp9do","_id":"cldfonot6001s16vd9cxds17v"},{"post_id":"cldfonoso001p16vdx2hmxdxp","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonotb001t16vd9nddp4m7"},{"post_id":"cldfonot1001r16vdfvxbn1bd","tag_id":"cldfonoqs001716vdm3evp9do","_id":"cldfonotk001u16vdvky1iu1t"},{"post_id":"cldfonot1001r16vdfvxbn1bd","tag_id":"cldfonomv000o16vdqlhjv902","_id":"cldfonotq001v16vd16l3vv73"},{"post_id":"cldfonoky000a16vd2mlvz048","tag_id":"cldfonok9000516vdt952szzj","_id":"cldfoxspr001y16vd8nav8k4y"},{"post_id":"cldfonoky000a16vd2mlvz048","tag_id":"cldfonop9000x16vdeeupddex","_id":"cldfoxsps001z16vdi3et0sdf"}],"Tag":[{"name":"Linux","_id":"cldfonok9000516vdt952szzj"},{"name":"coreos","_id":"cldfonokq000916vd8vn29wp5"},{"name":"OpenShift","_id":"cldfonol4000c16vdxhope1b2"},{"name":"Golang","_id":"cldfonolq000f16vdsugl6dn1"},{"name":"äº‘åŸç”Ÿ","_id":"cldfonomv000o16vdqlhjv902"},{"name":"Kubernetes","_id":"cldfonond000p16vd10ybfqt3"},{"name":"è¿›ç¨‹","_id":"cldfonop9000x16vdeeupddex"},{"name":"HTTPS","_id":"cldfonopv001016vdd4sbmanl"},{"name":"Ansible","_id":"cldfonoqr001616vdap14g8zr"},{"name":"å®¹å™¨","_id":"cldfonoqs001716vdm3evp9do"},{"name":"æ•°æ®åº“","_id":"cldfonor1001m16vd6uo1cil6"}]}}